<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>没写好 | 壹拾陆</title><meta name="keywords" content="Linux"><meta name="author" content="壹拾陆"><meta name="copyright" content="壹拾陆"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="第一章·MySQL介绍及安装 一.DBA工作内容及课程体系 二.MySQL课程体系介绍 三.DBA的职业素养 四.MySQL简介及安装 01 什么是数据? 02 什么是数据库管理系统 03 数据库管理系统种类 04 MySQL发展史 05 MySQL正在推动世界 06 MySQL简介及产品线 06 MySQL安装    一.DBA工作内容及课程体系￼ 二.MySQL课程体系介绍￼ 三.DBA的职业">
<meta property="og:type" content="article">
<meta property="og:title" content="没写好">
<meta property="og:url" content="https://mo-li001.github.io/posts/abc41134.html">
<meta property="og:site_name" content="壹拾陆">
<meta property="og:description" content="第一章·MySQL介绍及安装 一.DBA工作内容及课程体系 二.MySQL课程体系介绍 三.DBA的职业素养 四.MySQL简介及安装 01 什么是数据? 02 什么是数据库管理系统 03 数据库管理系统种类 04 MySQL发展史 05 MySQL正在推动世界 06 MySQL简介及产品线 06 MySQL安装    一.DBA工作内容及课程体系￼ 二.MySQL课程体系介绍￼ 三.DBA的职业">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-08-31T12:41:14.000Z">
<meta property="article:modified_time" content="2022-12-01T15:37:40.850Z">
<meta property="article:author" content="壹拾陆">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://mo-li001.github.io/posts/abc41134"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '没写好',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-12-01 23:37:40'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202209182232723.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">96</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">壹拾陆</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">没写好</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-31T12:41:14.000Z" title="发表于 2022-08-31 20:41:14">2022-08-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-12-01T15:37:40.850Z" title="更新于 2022-12-01 23:37:40">2022-12-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="没写好"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="第一章·MySQL介绍及安装"><a href="#第一章·MySQL介绍及安装" class="headerlink" title="第一章·MySQL介绍及安装"></a>第一章·MySQL介绍及安装</h1><ul>
<li><a href="#toc_0">一.DBA工作内容及课程体系</a></li>
<li><a href="#toc_1">二.MySQL课程体系介绍</a></li>
<li><a href="#toc_2">三.DBA的职业素养</a></li>
<li><a href="#toc_3">四.MySQL简介及安装</a><ul>
<li><a href="#toc_4">01 什么是数据?</a></li>
<li><a href="#toc_5">02 什么是数据库管理系统</a></li>
<li><a href="#toc_6">03 数据库管理系统种类</a></li>
<li><a href="#toc_7">04 MySQL发展史</a></li>
<li><a href="#toc_8">05 MySQL正在推动世界</a></li>
<li><a href="#toc_9">06 MySQL简介及产品线</a></li>
<li><a href="#toc_10">06 MySQL安装</a></li>
</ul>
</li>
</ul>
<h2 id="一-DBA工作内容及课程体系"><a href="#一-DBA工作内容及课程体系" class="headerlink" title="一.DBA工作内容及课程体系"></a>一.DBA工作内容及课程体系</h2><p><img src="/assets/1652868573-02feed66f9393dcdfec87d759861ac6b.jpg">￼</p>
<h2 id="二-MySQL课程体系介绍"><a href="#二-MySQL课程体系介绍" class="headerlink" title="二.MySQL课程体系介绍"></a>二.MySQL课程体系介绍</h2><p><img src="/assets/1652868573-73b859d0abb57267dd26523786440319.jpg">￼</p>
<h2 id="三-DBA的职业素养"><a href="#三-DBA的职业素养" class="headerlink" title="三.DBA的职业素养"></a>三.DBA的职业素养</h2><p><img src="/assets/1652868573-776a5299df1cca515976b760585b443e.jpg">￼</p>
<h2 id="四-MySQL简介及安装"><a href="#四-MySQL简介及安装" class="headerlink" title="四.MySQL简介及安装"></a>四.MySQL简介及安装</h2><h3 id="01-什么是数据"><a href="#01-什么是数据" class="headerlink" title="01 什么是数据?"></a>01 什么是数据?</h3><p>数据(data)是事实或观察的结果，是对客观事物的逻辑归纳，是用于表示客观事物的未经加工的的原始素材。<br>数据可以是连续的值，比如声音、图像，称为模拟数据。也可以是离散的，如符号、文字，称为数字数据。<br>在计算机系统中，数据以二进制信息单元0,1的形式表示。</p>
<p><strong><em>数据的定义:</em></strong> 数据是指对客观事件进行记录并可以鉴别的符号，是对客观事物的性质、状态以及相互关系等进行记载的物理符号或这些物理符号的组合。它是可识别的、抽象的符号。*</p>
<h3 id="02-什么是数据库管理系统"><a href="#02-什么是数据库管理系统" class="headerlink" title="02 什么是数据库管理系统"></a>02 什么是数据库管理系统</h3><p><strong><em>DBMS（database management system）</em></strong><br><img src="/assets/1652868573-a8296a11dbf638c1d222bb18836b5e40.jpg">￼</p>
<h3 id="03-数据库管理系统种类"><a href="#03-数据库管理系统种类" class="headerlink" title="03 数据库管理系统种类"></a>03 数据库管理系统种类</h3><p><strong><em>RDBMS</em></strong></p>
<p>以多张二维表的方式来存储，又给多张表建立了一定的关系（关系型数据库）</p>
<p><img src="/assets/1652868573-e5828fd23f3ab4b80946078603dd726b.jpg">￼</p>
<p><strong><em>NoSQL</em></strong></p>
<p>左边rdbms右边nosql 很多以json格式进行存储数据的（mogodb）</p>
<p><img src="/assets/1652868573-160405f8b64afb4e51013a74675bfac5.jpg">￼</p>
<p><strong><em>RDMS与NoSQL对比</em></strong></p>
<hr>
<ul>
<li><strong><em>功能性能对比:</em></strong></li>
</ul>
<p><img src="/assets/1652868573-1ee74e1a56a367c1257b1a8d9c893e72.jpg">￼</p>
<hr>
<ul>
<li><strong><em>特点对比:</em></strong></li>
</ul>
<p><em>关系型数据库（RDBMS）的特点：</em></p>
<ul>
<li>1.二维表</li>
<li>2.典型产品Oracle传统企业，MySQL互联网企业</li>
<li>3.数据存取是通过SQL（Structured Query Language结构化查询语言）</li>
<li>4.最大特点数据安全性方面强（ACID）</li>
</ul>
<p><em>非关系型数据库（NoSQL：Not only SQL）的特点：</em></p>
<ul>
<li>1.不是否定关系型数据库，而是做关系型数据库的补充。</li>
<li>2.想做老大，先学会做老二。</li>
</ul>
<hr>
<ul>
<li><p><strong><em>时代特点对比:</em></strong></p>
</li>
<li><p>1. web1.0时代</p>
<ul>
<li>  1.1 企业提供内容，用户浏览，所以关系型数据库够用，并发并不高，所以不需要nosql。</li>
</ul>
</li>
<li><p>2. web2.0时代</p>
<ul>
<li>  2.1 核心是企业提供平台，用户参与提供内容，这个时代关系型数据库无法满足需求了。</li>
</ul>
</li>
<li><p>3. 2003NoSQL出现</p>
<ul>
<li>  3.1 memcache的诞生，关注的点是性能，但是针对安全性能关注比较低，随着安全性能需求不断提升，所以有了redis。</li>
</ul>
</li>
<li><p>4. redis的特点</p>
<ul>
<li>  4.1 依然高性能高并发</li>
<li>  4.2 数据持久化功能</li>
<li>  4.3 支持多数据类型，主从复制和集群</li>
<li>  4.4 管理不再使用SQL了</li>
</ul>
</li>
</ul>
<hr>
<p><strong><em>NoSQL特性总览</em></strong></p>
<ul>
<li>1. 不是否定关系型数据库，而是做关系型数据库的补充，现在也有部分替代的趋势mongodb。</li>
<li>2. 关注高性能，高并发，灵活性，忽略和上述无关的功能。</li>
<li>3. 现在也在提升安全性和使用功能。</li>
<li>4. 典型产品：redis（持久化缓存，两个半天）、MongoDB（最接近关系型数据库的NoSQL）、memcached。</li>
<li>5. 管理不适用SQL管理，而是用一些特殊的API或数据接口。</li>
</ul>
<p><strong><em>NoSQL的分类、特点、典型产品</em></strong></p>
<ul>
<li>1.键值（KV）存储：memcached、redis</li>
<li>2.列存储（column-oriented）：HBASE（新浪、360）Cassandra（200台服务器集群）</li>
<li>3.文档数据库（document-oriented）：MongoDB（最接近关系型数据库的NoSQL）</li>
<li>4.图形存储（Graph）：Neo4j</li>
</ul>
<hr>
<ul>
<li><a href="httpss://db-engines.com/en/ranking">数据库排行</a> 【 <strong><em>点击查看排行网站</em></strong> 】</li>
</ul>
<hr>
<p><strong><em>数据库产品介绍</em></strong></p>
<p><em>Oracle公司产品介绍</em></p>
<table>
<thead>
<tr>
<th>大版本</th>
<th>经典版本号</th>
</tr>
</thead>
<tbody><tr>
<td>7</td>
<td>7.3.4</td>
</tr>
<tr>
<td>8i（internet）</td>
<td>8.1.7</td>
</tr>
<tr>
<td>9i</td>
<td>9.2.0.8</td>
</tr>
<tr>
<td>10g（grid）</td>
<td>10.2.0.4</td>
</tr>
<tr>
<td>11g</td>
<td>11.2.0.3、11.2.0.4</td>
</tr>
<tr>
<td>12c（cloud）</td>
<td>None</td>
</tr>
<tr>
<td>18c</td>
<td>None</td>
</tr>
</tbody></table>
<p><strong><em>Oracle的市场应用</em></strong></p>
<ul>
<li>1.市场份额第一，趋势递减</li>
<li>2.市场空间传统企业</li>
<li>3.传统企业也在互联网化</li>
</ul>
<p><strong><em>MySQL数据库版本介绍</em></strong></p>
<ul>
<li>- 1.0</li>
<li>- 5.1</li>
<li>- 5.5</li>
<li>- 5.6</li>
<li>- 5.7</li>
<li>- 8.0</li>
</ul>
<p><strong><em>MySQL的市场应用</em></strong></p>
<ul>
<li>1.中、大型互联网公司</li>
<li>2.市场空间：互联网领域第一</li>
<li>3.趋势明显</li>
<li>4.同源产品：MariaDB、PerconaDB</li>
</ul>
<p><strong><em>其他公司产品介绍</em></strong></p>
<ul>
<li>1. 微软：SQLserver<ul>
<li>  1.1 微软和sysbase合作开发的产品，后来自己开发，windows平台</li>
<li>  1.2 三、四线小公司，传统行业在用</li>
</ul>
</li>
<li>2. IBM：DB2<ul>
<li>  2.1 市场占有量小</li>
<li>  2.2 目前只有：国有银行（人行，中国银行，工商银行等）、中国移动应用</li>
</ul>
</li>
<li>3. PostgreSQL</li>
<li>4. MongoDB</li>
<li>5. Redis</li>
</ul>
<p><em>企业使用数据库情况</em></p>
<ul>
<li>1. 中国银行</li>
<li>2. 中国工商银行</li>
<li>3. 江苏银行</li>
<li>4. 浦发银行</li>
<li>5. 中国光大银行</li>
</ul>
<p><img src="/assets/1652868573-f21207ccae655085224a3bbe5d7b30e6.jpg">￼</p>
<p><strong><em>谁说金融公司不能用MySQL？？？？？？？</em></strong></p>
<h3 id="04-MySQL发展史"><a href="#04-MySQL发展史" class="headerlink" title="04 MySQL发展史"></a>04 MySQL发展史</h3><ul>
<li>a. 1979年，报表工具Unireg出现。</li>
<li>b. 1985年，以瑞典David Axmark为首，成立了一家公司（AB前身），ISAM引擎出现。</li>
<li>c. 1990年，提供SQL支持。</li>
<li>d. 1999年-2000年，MySQL AB公司成立，并公布源码，开源化。</li>
<li>e. 2000年4月BDB引擎出现，支持事物。</li>
<li>f. 2008年1月16日 MySQL被Sun公司收购。</li>
<li>g. 2009年4月20日Oracle收购Sun公司，MySQL转入Oracle门下。</li>
</ul>
<h3 id="05-MySQL正在推动世界"><a href="#05-MySQL正在推动世界" class="headerlink" title="05 MySQL正在推动世界"></a>05 MySQL正在推动世界</h3><p><img src="/assets/1652868573-69ec614d26baf464b0f43a1a3b138579.jpg">￼</p>
<h3 id="06-MySQL简介及产品线"><a href="#06-MySQL简介及产品线" class="headerlink" title="06 MySQL简介及产品线"></a>06 MySQL简介及产品线</h3><p><strong><em>MySQL简介（特点）</em></strong></p>
<ul>
<li>1. 开源</li>
<li>2. 社区版免费</li>
<li>3. 简单、使用方便、可靠</li>
<li>4. 稳定、安全</li>
<li>5. 社区活跃</li>
</ul>
<p><strong><em>MySQL产品线</em></strong></p>
<ul>
<li><p><strong><em>产品线1:</em></strong></p>
</li>
<li><ol>
<li>3.26版本 — 5.2版本</li>
</ol>
<ul>
<li>  a. 正宗后代</li>
<li>  b. CentOS5、6中默认都是5.1版本</li>
<li>  c. CentOS7中默认是MariaDB</li>
</ul>
</li>
<li><ol start="2">
<li>5.5 — 5.7 — 8.0版本</li>
</ol>
<ul>
<li>  a. 借鉴社区好的贡献，进一步开发的版本</li>
<li>  b. 主流版本：5.5 5.6 5.7</li>
<li>  c. 讲课版本：5.6</li>
</ul>
</li>
<li><ol start="3">
<li>MySQL Cluster 6.0版本 &amp; 更高</li>
</ol>
<ul>
<li>  a. 类似于Oracle RAC（双主），硬件要求高</li>
<li>  b. 一般各大网站没有人用</li>
</ul>
</li>
<li><p><strong><em>产品线2:</em></strong></p>
</li>
<li><ol>
<li>MariaDB</li>
</ol>
</li>
<li><ol start="2">
<li>PerconaDB 第三方 Xtrabackup PerconaDB</li>
</ol>
</li>
</ul>
<h3 id="06-MySQL安装"><a href="#06-MySQL安装" class="headerlink" title="06 MySQL安装"></a>06 MySQL安装</h3><p><strong><em>MySQL安装方式</em></strong></p>
<ul>
<li><p>1. rpm、yum安装</p>
<ul>
<li>安装方便、安装速度快，无法定制</li>
</ul>
</li>
<li><p>2. 二进制</p>
<ul>
<li>不需要安装，解压即可使用，不能定制功能</li>
</ul>
</li>
<li><p>3. 编译安装</p>
<ul>
<li>  3.1 可定制，安装慢</li>
<li>  3.2 四个步骤：<ul>
<li>    3.2.1 解压（tar）</li>
<li>    3.2.2 生成（.&#x2F;configure）cmake</li>
<li>    3.2.3 编译（make）</li>
<li>    3.2.4 安装（make install）</li>
</ul>
</li>
<li>  3.3  5.5版本之前：tar .&#x2F;configure make make install</li>
<li>  3.4  5.5版本之后：cmake gmake</li>
</ul>
</li>
<li><p>4. 先编译，然后定制rpm包，制作yum仓库，然后yum安装</p>
<ul>
<li>  4.1 简单，速度快，可定制，比较复杂，制作时间极长</li>
</ul>
</li>
<li><p>5. 企业中选择的安装方式</p>
<ul>
<li>  5.1 中小型企业：以上方式都可以，运维偏向编译，dba偏向二进制 运维也偏向二进制</li>
<li>  5.2 大型企业：可以选择: <strong><em>先编译然后定制rpm包，制作yum仓库，然后yum安装</em></strong></li>
</ul>
</li>
</ul>
<p><strong><em>安装MySQL</em></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cmake</span></span><br><span class="line"><span class="comment">#定制功能：存储引擎、字符集、压缩</span></span><br><span class="line"><span class="comment">#定制安装位置、数据存放位置、文件位置（socket）</span></span><br><span class="line"><span class="comment">#克隆一个模板机（使用CentOS6），克隆完做快照</span></span><br><span class="line"><span class="comment">#IP 10.0.0.52 主机名db02</span></span><br><span class="line"><span class="comment">#下载5.6.36包</span></span><br><span class="line">[root@db02 ~]<span class="comment"># wget -q https://mirrors.sohu.com/mysql/MySQL-5.6/mysql-5.6.36.tar.gz</span></span><br><span class="line"><span class="comment">#安装epel源</span></span><br><span class="line">[root@db02 ~]<span class="comment"># wget -O /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-6.repo</span></span><br><span class="line"><span class="comment">#安装依赖包</span></span><br><span class="line">[root@db02 ~]<span class="comment"># yum install -y ncurses-devel libaio-devel</span></span><br><span class="line"><span class="comment">#安装cmake</span></span><br><span class="line">[root@db02 ~]<span class="comment"># yum install -y cmake</span></span><br><span class="line"><span class="comment">#创建用户</span></span><br><span class="line">[root@db02 ~]<span class="comment"># useradd mysql -s /sbin/nologin -M</span></span><br><span class="line"><span class="comment">#修改hosts</span></span><br><span class="line">[root@db02 ~]<span class="comment"># vim /etc/hosts</span></span><br><span class="line">127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1 localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">172.16.1.52 db02</span><br><span class="line"><span class="comment">#解压MySQL源码包</span></span><br><span class="line">[root@db02 tools]<span class="comment"># tar xf mysql-5.6.36.tar.gz</span></span><br><span class="line"><span class="comment">#进入MySQL目录</span></span><br><span class="line">[root@db02 tools]<span class="comment"># cd mysql-5.6.36</span></span><br><span class="line"><span class="comment">#生成</span></span><br><span class="line">[root@db02 mysql-5.6.36]<span class="comment">#</span></span><br><span class="line"><span class="comment">#程序存放位置</span></span><br><span class="line">cmake . -DCMAKE_INSTALL_PREFIX=/application/mysql-5.6.38 \</span><br><span class="line"><span class="comment">#数据存放位置</span></span><br><span class="line">-DMYSQL_DATADIR=/application/mysql-5.6.38/data \</span><br><span class="line"><span class="comment">#socket文件存放位置</span></span><br><span class="line">-DMYSQL_UNIX_ADDR=/application/mysql-5.6.38/tmp/mysql.sock \</span><br><span class="line"><span class="comment">#使用utf8字符集</span></span><br><span class="line">-DDEFAULT_CHARSET=utf8 \</span><br><span class="line"><span class="comment">#校验规则</span></span><br><span class="line">-DDEFAULT_COLLATION=utf8_general_ci \</span><br><span class="line"><span class="comment">#使用其他额外的字符集</span></span><br><span class="line">-DWITH_EXTRA_CHARSETS=all \</span><br><span class="line"><span class="comment">#支持的存储引擎</span></span><br><span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_FEDERATED_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</span><br><span class="line"><span class="comment">#禁用的存储引擎</span></span><br><span class="line">-DWITHOUT_EXAMPLE_STORAGE_ENGINE=1 \</span><br><span class="line"><span class="comment">#启用zlib库支持（zib、gzib相关）</span></span><br><span class="line">-DWITH_ZLIB=bundled \</span><br><span class="line"><span class="comment">#启用SSL库支持（安全套接层）</span></span><br><span class="line">-DWITH_SSL=bundled \</span><br><span class="line"><span class="comment">#启用本地数据导入支持</span></span><br><span class="line">-DENABLED_LOCAL_INFILE=1 \</span><br><span class="line"><span class="comment">#编译嵌入式服务器支持</span></span><br><span class="line">-DWITH_EMBEDDED_SERVER=1 \</span><br><span class="line"><span class="comment"># mysql5.6支持了google的c++mock框架了，允许下载，否则会安装报错。</span></span><br><span class="line">-DENABLE_DOWNLOADS=1 \</span><br><span class="line"><span class="comment">#禁用debug（默认为禁用）</span></span><br><span class="line">-DWITH_DEBUG=0</span><br><span class="line"><span class="comment">#编译</span></span><br><span class="line">[root@db02 mysql-5.6.36]<span class="comment"># make</span></span><br><span class="line"><span class="comment">#安装</span></span><br><span class="line">[root@db02 mysql-5.6.36]<span class="comment"># make install</span></span><br><span class="line"><span class="comment">#做软链接</span></span><br><span class="line">[root@db02 mysql-5.6.36]<span class="comment"># ln -s /application/mysql-5.6.38/ /application/mysql</span></span><br><span class="line"><span class="comment">#拷贝配置文件</span></span><br><span class="line">[root@db02 mysql-5.6.36]<span class="comment"># cp support-files/my*.cnf /etc/my.cnf</span></span><br><span class="line"><span class="comment">#拷贝mysql启动脚本</span></span><br><span class="line">[root@db02 mysql-5.6.36]<span class="comment"># cp support-files/mysql.server /etc/init.d/mysqld</span></span><br><span class="line"><span class="comment">#进入MySQL初始化脚本目录</span></span><br><span class="line">[root@db02 mysql-5.6.36]<span class="comment"># cd /application/mysql/scripts/</span></span><br><span class="line"><span class="comment">#初始化MySQL</span></span><br><span class="line">[root@db02 mysql-5.6.36]<span class="comment"># ./mysql_install_db --basedir=/application/mysql/ --datadir=/application/mysql/data --user=mysql</span></span><br><span class="line"><span class="comment">#授权</span></span><br><span class="line">[root@db02 mysql-5.6.36]<span class="comment"># chown -R mysql.mysql /application/mysql/</span></span><br><span class="line"><span class="comment">#给启动脚本授权700</span></span><br><span class="line">[root@db02 mysql-5.6.36]<span class="comment"># chmod 700 /etc/init.d/mysqld</span></span><br><span class="line"><span class="comment">#systemd管理mysql启动</span></span><br><span class="line">[root@db02 mysql-5.6.36]<span class="comment"># vim /usr/lib/systemd/system/mysqld.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=MySQL Server</span><br><span class="line">Documentation=man:mysqld(8)</span><br><span class="line">Documentation=https://dev.mysql.com/doc/refman/en/using-systemd.html</span><br><span class="line">After=network.target</span><br><span class="line">After=syslog.target</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">[Service]</span><br><span class="line">User=mysql</span><br><span class="line">Group=mysql</span><br><span class="line">ExecStart=/usr/local/mysql/bin/mysqld --defaults-file=/etc/my.cnf</span><br><span class="line">LimitNOFILE = 5000</span><br><span class="line"><span class="comment">#设置开机自启动C6</span></span><br><span class="line">[root@db02 mysql-5.6.36]<span class="comment"># chkconfig mysqld on</span></span><br><span class="line"><span class="comment">#设置开机自启动C7</span></span><br><span class="line">[root@db02 mysql-5.6.36]<span class="comment"># systemctl enable mysqld</span></span><br><span class="line"><span class="comment">#启动MySQLC6</span></span><br><span class="line">[root@db02 mysql-5.6.36]<span class="comment"># /etc/init.d/mysqld start</span></span><br><span class="line"><span class="comment">#启动MySQLC7</span></span><br><span class="line">[root@db02 mysql-5.6.36]<span class="comment"># systemctl start mysqld</span></span><br><span class="line"><span class="comment">#创建tmp目录（5.6.36版本不会自动创建tmp目录）</span></span><br><span class="line">[root@db02 mysql-5.6.36]<span class="comment"># mkdir /application/mysql-5.6.36/tmp</span></span><br><span class="line"><span class="comment">#添加环境变量</span></span><br><span class="line">[root@db02 ~]<span class="comment"># echo &#x27;PATH=/application/mysql/bin/:$PATH&#x27; &gt;&gt;/etc/profile</span></span><br><span class="line"><span class="comment">#个人推荐</span></span><br><span class="line">[root@db02 ~]<span class="comment"># echo &#x27;PATH=/application/mysql/bin/:$PATH&#x27; &gt;/etc/profile.d/mysql.sh</span></span><br><span class="line">[root@db02 ~]<span class="comment"># source /etc/profile.d/mysql.sh</span></span><br><span class="line"><span class="comment">#设置MySQL密码</span></span><br><span class="line">[root@db02 ~]<span class="comment"># mysqladmin -uroot password &#x27;oldboy123&#x27;</span></span><br><span class="line"><span class="comment">#MySQL登陆</span></span><br><span class="line">[root@db02 ~]<span class="comment"># mysql -uuser -ppassword -Ssocket -hhost</span></span><br><span class="line"><span class="comment">#MySQL基本操作及基本优化</span></span><br><span class="line"><span class="comment">#查看库</span></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line"><span class="comment">#删库</span></span><br><span class="line">mysql&gt; drop database <span class="built_in">test</span>;</span><br><span class="line"><span class="comment">#使用库</span></span><br><span class="line">mysql&gt; use mysql</span><br><span class="line"><span class="comment">#查看表</span></span><br><span class="line">mysql&gt; show tables;</span><br><span class="line"><span class="comment">#查看当前所在库</span></span><br><span class="line">mysql&gt; select database();</span><br><span class="line"><span class="comment">#查看mysql用户</span></span><br><span class="line">mysql&gt; select user,host from user;</span><br><span class="line">mysql&gt; select user,host,password from user;</span><br><span class="line"><span class="comment">#删除用户</span></span><br><span class="line">mysql&gt; select user,host from user;</span><br><span class="line">mysql&gt; drop user <span class="string">&#x27;&#x27;</span>@<span class="string">&#x27;db02&#x27;</span>;</span><br><span class="line">mysql&gt; drop user root@db02;</span><br><span class="line">mysql&gt; drop user root@<span class="string">&#x27;::1&#x27;</span>;</span><br><span class="line">mysql&gt; drop user root@<span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br></pre></td></tr></table></figure>


<h1 id="第二章·-MySQL体系结构管理"><a href="#第二章·-MySQL体系结构管理" class="headerlink" title="第二章· MySQL体系结构管理"></a>第二章· MySQL体系结构管理</h1><ul>
<li><a href="#toc_0">一.客户端与服务器模型</a></li>
<li><a href="#toc_1">二.MySQL服务器构成</a></li>
<li><a href="#toc_2">三.MySQL的结构</a></li>
</ul>
<h2 id="一-客户端与服务器模型"><a href="#一-客户端与服务器模型" class="headerlink" title="一.客户端与服务器模型"></a>一.客户端与服务器模型</h2><p><img src="/assets/1652868854-832c18ac7c553c8777f706191ec7002d.jpg">￼</p>
<ul>
<li><p><strong><em>1.mysql是一个典型的C&#x2F;S服务结构</em></strong></p>
<ul>
<li>  <strong><em>1.1 mysql自带的客户端程序（&#x2F;application&#x2F;mysql&#x2F;bin）</em></strong><ul>
<li>    <strong><em>mysql</em></strong></li>
<li>    <strong><em>mysqladmin</em></strong></li>
<li>    <strong><em>mysqldump</em></strong></li>
</ul>
</li>
</ul>
</li>
<li><p><strong><em>1.2 mysqld一个二进制程序，后台的守护进程</em></strong></p>
<ul>
<li>  <strong><em>单进程</em></strong></li>
<li>  <strong><em>多线程</em></strong></li>
</ul>
</li>
<li><p><strong>_2.应用程连接MySQL方式<br>_</strong></p>
<ul>
<li>  <strong><em>TCP&#x2F;IP的连接方式</em></strong></li>
</ul>
<p><img src="/assets/1652868854-e287997415d60e98cb5dbb5c59dba731.jpg">￼</p>
<ul>
<li><strong><em>套接字连接方式</em></strong></li>
</ul>
</li>
</ul>
<p><img src="/assets/1652868854-105fb26c0c4ce5e4859acf4a0b365a97.jpg">￼</p>
<p><strong><em>思考：mysql -uroot -poldboy123是使用了哪个连接方式？？？</em></strong></p>
<h2 id="二-MySQL服务器构成"><a href="#二-MySQL服务器构成" class="headerlink" title="二.MySQL服务器构成"></a>二.MySQL服务器构成</h2><p><strong><em>什么是实例</em></strong></p>
<ul>
<li>1.MySQL的后台进程+线程+预分配的内存结构。</li>
<li>2.MySQL在启动的过程中会启动后台守护进程，并生成工作线程，预分配内存结构供MySQL处理数据使用。</li>
</ul>
<p><img src="/assets/1652868854-29d65cf192257c4f6f7393f3a3ba6202.jpg">￼</p>
<p>图1.1-word的打开方式</p>
<p><img src="/assets/1652868854-93e3eda1c8770285880323f25b39cf7b.jpg">￼</p>
<p>图1.2-mysqld的打开方式</p>
<p><strong><em>MySQLD服务器程序构成</em></strong></p>
<p><img src="/assets/1652868854-6cf1307380f6d7e6d9df0b32a7b3fb23.jpg">￼</p>
<p><strong><em>mysqld是一个守护进程但是本身不能自主启动：</em></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]<span class="comment"># mysql -uroot -poldboy123</span></span><br><span class="line">[root@db01 ~]<span class="comment"># select user,host,password from mysql.user;</span></span><br></pre></td></tr></table></figure>

<p><strong><em>连接层</em></strong></p>
<ul>
<li>1、提供连接协议（socket、tcp&#x2F;ip）</li>
<li>2、验证用户的合法性（用户名、密码、白名单）</li>
<li>3、提供一个专用连接线程（接收SQL、返回结果），将SQL语句交给SQL层继续处理</li>
</ul>
<p><img src="/assets/1652868854-8094eab26a19ab32b6342fa91ef725e2.jpg">￼</p>
<p><strong><em>SQL层</em></strong></p>
<ul>
<li>1、接收到SQL语句，语法判断。</li>
<li>2、判断语义（判断语句类型：DML、DDL、DCL、DQL）</li>
<li>3、解析SQL语句，生成多种执行计划</li>
<li>4、优化器，选择他认为成本最低的执行计划。</li>
<li>5、执行器根据优化器的选择，按照优化器建议执行SQL语句，得到去哪儿找SQL语句需要访问的数据<ul>
<li>5.1 具体：在哪个数据文件上的哪个数据页中？</li>
<li>5.2 将以上结果充送给下层继续处理</li>
</ul>
</li>
<li>6、接收存储引擎层的数据，结构化成表的形式，通过连接层提供的专用线程，将表数据返回给用户。</li>
<li>7、提供查询缓存<ul>
<li>7.1 query_cache, 使用memcache 或者redis 替代</li>
</ul>
</li>
<li>8、日志记录（binlog）</li>
</ul>
<p><strong><em>存储引擎层</em></strong></p>
<ul>
<li>1、接收上层的执行结果</li>
<li>2、取出磁盘文件和相应数据</li>
<li>3、返回给SQL层，结构化之后生成表格，由专用线程返回给客户端</li>
</ul>
<h2 id="三-MySQL的结构"><a href="#三-MySQL的结构" class="headerlink" title="三.MySQL的结构"></a>三.MySQL的结构</h2><p><strong><em>MySQL的逻辑结构（熟悉）</em></strong></p>
<p><em>MySQL的逻辑对象：做为管理人员或者开发人员操作的对象</em></p>
<ul>
<li>1、库</li>
<li>2、表：元数据+真实数据行</li>
<li>3、元数据：列+其它属性（行数+占用空间大小+权限）</li>
<li>4、列：列名字+数据类型+其他约束（非空、唯一、主键、非负数、自增长、默认值）</li>
</ul>
<p><em>最直观的数据：二维表，必须用库来存放</em><br><img src="/assets/1652868854-4ae3e14d96355720857a344ffbad716d.jpg"></p>
<p>￼</p>
<p><em>MySQL逻辑结构与Linux系统对比</em></p>
<table>
<thead>
<tr>
<th>MySQL</th>
<th>Linux</th>
</tr>
</thead>
<tbody><tr>
<td>库</td>
<td>目录</td>
</tr>
<tr>
<td>show databases;</td>
<td>ls-l &#x2F;</td>
</tr>
<tr>
<td>use mysql</td>
<td>cd &#x2F;mysql</td>
</tr>
<tr>
<td>表</td>
<td>文件</td>
</tr>
<tr>
<td>show tables;</td>
<td>ls</td>
</tr>
<tr>
<td>二维表&#x3D;元数据+真实数据行</td>
<td>文件&#x3D;文件名+文件属性</td>
</tr>
</tbody></table>
<p><strong><em>MySQL的物理结构（了解）</em></strong></p>
<p>1）MySQL的最底层的物理结构是数据文件，也就是说，存储引擎层，打交道的文件，是数据文件。</p>
<p>2）存储引擎分为很多种类（Linux中的FS）</p>
<p>3）不同存储引擎的区别：存储方式、安全性、性能</p>
<p>myisam：<br><img src="/assets/1652868854-2fe490fc420d6f40e845f93fb1e6aa40.jpg">￼</p>
<p>innodb：<br><img src="/assets/1652868854-3d31b44e9dd430d6ed566b827cc40897.jpg">￼</p>
<p><strong><em>段、区、页（块）</em></strong></p>
<ul>
<li>1、段：理论上一个表就是一个段，由多个区构成，（分区表是一个分区一个段）</li>
<li>2、区：连续的多个页构成</li>
<li>3、页：最小的数据存储单元，默认是16k</li>
</ul>
<h1 id="第三章·MySQL版本区别及管理"><a href="#第三章·MySQL版本区别及管理" class="headerlink" title="第三章·MySQL版本区别及管理"></a>第三章·MySQL版本区别及管理</h1><ul>
<li><a href="#toc_0">一.MySQL5.6与MySQL5.7安装的区别</a></li>
<li><a href="#toc_1">二.MySQL用户权限管理</a></li>
<li><a href="#toc_2">三.MySQL连接管理</a></li>
<li><a href="#toc_3">四.MySQL启动关闭流程</a></li>
<li><a href="#toc_4">五.MySQL实例初始化配置</a></li>
<li><a href="#toc_5">六.MySQL多实例配置</a></li>
</ul>
<h2 id="一-MySQL5-6与MySQL5-7安装的区别"><a href="#一-MySQL5-6与MySQL5-7安装的区别" class="headerlink" title="一.MySQL5.6与MySQL5.7安装的区别"></a>一.MySQL5.6与MySQL5.7安装的区别</h2><ul>
<li>1、cmake的时候加入了bostorg</li>
<li>2、初始化时 使用mysqld –initialize 替代mysql_install_db，其它参数没有变化：–user&#x3D; –basedir&#x3D; –datadir&#x3D;</li>
<li>3、–initialize会生成一个临时密码</li>
<li>4、还可以用另外一个参数–initialize-insecure</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@db02 mysql-5.7.20]# yum install -y gcc gcc-c++ automake autoconf</span><br><span class="line">[root@db02 mysql-5.7.20]# yum install make cmake bison-devel ncurses-devel libaio-devel</span><br><span class="line">[root@db02 mysql-5.7.20]#</span><br><span class="line">wget httpss://dl.bintray.com/boostorg/release/1.65.1/source/boost_1_59_0.tar.gz</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">登录boost.org下载也可以</span></span><br><span class="line">[root@db02 mysql-5.7.20]# tar xf boost_1_59_0.tar.gz -C /usr/local/</span><br><span class="line">[root@db02 mysql-5.7.20]#</span><br><span class="line">cmake . -DCMAKE_INSTALL_PREFIX=/application/mysql-5.7.20 \</span><br><span class="line">-DMYSQL_DATADIR=/application/mysql-5.7.20/data \</span><br><span class="line">-DMYSQL_UNIX_ADDR=/application/mysql-5.7.20/tmp/mysql.sock \</span><br><span class="line">-DDOWNLOAD_BOOST=1 \</span><br><span class="line">-DWITH_BOOST=/usr/local/boost_1_59_0 \</span><br><span class="line">-DDEFAULT_CHARSET=utf8 \</span><br><span class="line">-DDEFAULT_COLLATION=utf8_general_ci \</span><br><span class="line">-DWITH_EXTRA_CHARSETS=all \</span><br><span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_FEDERATED_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITHOUT_EXAMPLE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_ZLIB=bundled \</span><br><span class="line">-DWITH_SSL=bundled \</span><br><span class="line">-DENABLED_LOCAL_INFILE=1 \</span><br><span class="line">-DWITH_EMBEDDED_SERVER=1 \</span><br><span class="line">-DENABLE_DOWNLOADS=1 \</span><br><span class="line">-DWITH_DEBUG=0 </span><br></pre></td></tr></table></figure>

<p><img src="/assets/1652868921-63966707c2ed63167ecf3164d8a0b334.jpg">￼</p>
<p><img src="/assets/1652868921-fe1d2844dc81fcc4a2f59c6b009c68ad.jpg">￼</p>
<p><img src="/assets/1652868921-45d516e4800527b7e41a8621cb02ffc7.jpg">￼</p>
<h2 id="二-MySQL用户权限管理"><a href="#二-MySQL用户权限管理" class="headerlink" title="二.MySQL用户权限管理"></a>二.MySQL用户权限管理</h2><ul>
<li><strong><em>1.MySQL用户基础操作</em></strong></li>
</ul>
<p><strong><em>Linux用户的作用:</em></strong></p>
<ul>
<li>1）登陆系统</li>
<li>2）管理系统文件</li>
</ul>
<p><strong><em>Linux用户管理：</em></strong></p>
<ul>
<li>1）创建用户：useradd adduser</li>
<li>2）删除用户：userdel</li>
<li>3）修改用户：usermod</li>
</ul>
<p><strong><em>MySQL用户的作用:</em></strong></p>
<ul>
<li>1）登陆MySQL数据库</li>
<li>2）管理数据库对象</li>
</ul>
<p><strong><em>MySQL用户管理：</em></strong></p>
<ul>
<li>1）创建用户：create user</li>
<li>2）删除用户：delete user drop user</li>
<li>3）修改用户：update</li>
</ul>
<p><strong><em>用户的定义：</em></strong></p>
<ul>
<li><ol>
<li>username@’主机域’</li>
</ol>
</li>
<li>2）主机域：可以理解为是MySQL登陆的白名单</li>
<li>3）主机域格式：<ul>
<li>’10.0.0.51’</li>
<li>‘10.0.0.5%’,</li>
<li>’10.0.0.%’</li>
<li>’10.0.%.%’</li>
<li>’10.%.%.%’</li>
<li>‘%’</li>
<li>‘db01’</li>
<li>’10.0.0.51&#x2F;255.255.255.0’</li>
</ul>
</li>
</ul>
<p><strong><em>用户管理实战</em></strong></p>
<p><em>刚装完MySQL数据库该做的事情</em></p>
<ul>
<li>1、设定初始密码（root@localhost）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db02 mysql-5.7.20]# mysqladmin -uroot -p password ‘oldboy123’</span><br></pre></td></tr></table></figure>

<ul>
<li>2、修改密码</li>
<li>3、使用密码登陆</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db02 mysql-5.7.20]# mysql -uroot -p123</span><br></pre></td></tr></table></figure>

<ul>
<li>4、清理无用的用户</li>
</ul>
<p><strong><em>误删除了所有用户</em></strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">关闭数据库</span></span><br><span class="line">[root@db02 mysql-5.7.20]# /etc/init.d/mysqld stop</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动数据库</span></span><br><span class="line">[root@db02 mysql-5.7.20]# mysqld_safe --skip-grant-tables --skip-networking</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用mysql库</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">use mysql</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">错误方法1、创建root用户</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">create user root@’localhost’;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">错误方法2、创建root用户</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">insert into user(user,host,password) values(<span class="string">&#x27;root&#x27;</span>,<span class="string">&#x27;10.0.0.55&#x27;</span>,PASSWORD(<span class="string">&#x27;123&#x27;</span>));</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">正确方法创建root用户</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">insert into mysql.user values (‘localhost’,’root’,PASSWORD(<span class="string">&#x27;123&#x27;</span>),</span></span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;Y&#x27;,</span><br><span class="line">&#x27;&#x27;,</span><br><span class="line">&#x27;&#x27;,</span><br><span class="line">&#x27;&#x27;,</span><br><span class="line">&#x27;&#x27;,0,0,0,0,&#x27;mysql_native_password&#x27;,&#x27;&#x27;,&#x27;N&#x27;);</span><br></pre></td></tr></table></figure>

<p><strong><em>忘记root密码</em></strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">关闭数据库</span></span><br><span class="line">[root@db02 mysql-5.7.20]# /etc/init.d/mysqld stop</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动数据库</span></span><br><span class="line">[root@db02 mysql-5.7.20]# mysqld_safe --skip-grant-tables --skip-networking</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改root用户密码</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">update user <span class="built_in">set</span> password=PASSWORD(<span class="string">&#x27;oldboy123&#x27;</span>) <span class="built_in">where</span> user=<span class="string">&#x27;root&#x27;</span> and host=<span class="string">&#x27;localhost&#x27;</span>;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong><em>2.用户管理及权限管理</em></strong>_</li>
</ul>
<p>1）创建用户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">create user oldboy@<span class="string">&#x27;10.0.0.%&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span>;</span></span><br></pre></td></tr></table></figure>

<p>2）查看用户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"> select user,host from mysql.user;</span></span><br></pre></td></tr></table></figure>

<p>3）删除用户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"> drop user oldboy@<span class="string">&#x27;10.0.0.%&#x27;</span>；</span></span><br></pre></td></tr></table></figure>

<p>4）修改密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="built_in">set</span> password</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">update user <span class="built_in">set</span> password=PASSWORD(<span class="string">&#x27;oldboy123&#x27;</span>) <span class="built_in">where</span> user=<span class="string">&#x27;root&#x27;</span> and host=<span class="string">&#x27;localhost&#x27;</span>;</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">grant all privileges on *.* to oldboy@<span class="string">&#x27;10.0.0.%&#x27;</span> identified by <span class="string">&#x27;123&#x27;</span>;</span></span><br></pre></td></tr></table></figure>

<p>5）用户权限介绍</p>
<p>MySQL的权限定义：<br><strong><em>作用对象：库、表</em></strong><br><strong><em>权限</em></strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span>,<span class="keyword">SELECT</span>, <span class="keyword">UPDATE</span>, <span class="keyword">DELETE</span>, <span class="keyword">CREATE</span>, <span class="keyword">DROP</span>, RELOAD, SHUTDOWN,  PROCESS, FILE, <span class="keyword">REFERENCES</span>, INDEX, <span class="keyword">ALTER</span>, <span class="keyword">SHOW</span> DATABASES, SUPER, <span class="keyword">CREATE</span> TEMPORARY TABLES, LOCK TABLES, <span class="keyword">EXECUTE</span>, REPLICATION SLAVE, REPLICATION CLIENT, <span class="keyword">CREATE</span> <span class="keyword">VIEW</span>, <span class="keyword">SHOW</span> <span class="keyword">VIEW</span>, <span class="keyword">CREATE</span> ROUTINE, <span class="keyword">ALTER</span> ROUTINE, <span class="keyword">CREATE</span> <span class="keyword">USER</span>, EVENT, <span class="keyword">TRIGGER</span>, <span class="keyword">CREATE</span> <span class="keyword">TABLE</span>SPACE</span><br></pre></td></tr></table></figure>

<p><strong><em>归属</em></strong><br>每次设定只能有一个属主，没有属组或其他用户的概念</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span>     <span class="keyword">all</span> privileges    <span class="keyword">on</span>     <span class="operator">*</span>.<span class="operator">*</span>    <span class="keyword">to</span>   oldboy@<span class="string">&#x27;10.0.0.%&#x27;</span>  identified <span class="keyword">by</span>    <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line">                权限               作用对象          归属               密码</span><br></pre></td></tr></table></figure>

<p><strong><em>作用对象分解</em></strong></p>
<p>*.* [当前MySQL实例中所有库下的所有表]<br>wordpress.* [当前MySQL实例中wordpress库中所有表（单库级别）]<br>wordpress.user [当前MySQL实例中wordpress库中的user表（单表级别）]</p>
<p><strong><em>3.企业中权限的设定</em></strong></p>
<p>开发人员说：请给我开一个用户<br>沟通：</p>
<ul>
<li>1、你需要对哪些库、表进行操作</li>
<li>2、你从哪里连接过来</li>
<li>3、用户名有没有要求</li>
<li>4、密码要求</li>
<li>5、发邮件</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#一般给开发创建用户权限</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">select</span>,<span class="keyword">update</span>,<span class="keyword">delete</span>,<span class="keyword">insert</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> oldboy@<span class="string">&#x27;10.0.0.%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span>;</span><br></pre></td></tr></table></figure>

<hr>
<p>思考下面场景：<br>开发：你把root用户给我呗？</p>
<p>你：emmmmm…….. SO?<br><img src="/assets/1652868921-ad5709981ae86d0dcd4149cbfb427914.jpg">￼</p>
<hr>
<p><strong><em>实验思考问题：</em></strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#创建wordpress数据库</span><br><span class="line"><span class="keyword">create</span> database wordpress;</span><br><span class="line">#使用wordpress库</span><br><span class="line">use wordpress;</span><br><span class="line">#创建t1、t2表</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t1 (id <span class="type">int</span>);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t2 (id <span class="type">int</span>);</span><br><span class="line">#创建blog库</span><br><span class="line"><span class="keyword">create</span> database blog;</span><br><span class="line">#使用blog库</span><br><span class="line">use blog;</span><br><span class="line">#创建t1表</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tb1 (id <span class="type">int</span>);</span><br></pre></td></tr></table></figure>

<p><em>授权：</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、<span class="keyword">grant</span> <span class="keyword">select</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> wordpress@<span class="string">&#x27;10.0.0.5%&#x27;</span>, identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"><span class="number">2</span>、<span class="keyword">grant</span> <span class="keyword">insert</span>,<span class="keyword">delete</span>,<span class="keyword">update</span> <span class="keyword">on</span> wordpress.<span class="operator">*</span> <span class="keyword">to</span> wordpress@<span class="string">&#x27;10.0.0.5%&#x27;</span>, identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"><span class="number">3</span>、<span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> wordpress.t1 <span class="keyword">to</span> wordpress@<span class="string">&#x27;10.0.0.5%&#x27;</span>, identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><em>问：</em><br>一个客户端程序使用wordpress用户登陆到10.0.0.51的MySQL后，</p>
<ul>
<li>1、对t1表的管理能力？</li>
<li>2、对t2表的管理能力？</li>
<li>3、对tb1表的管理能力？</li>
</ul>
<p><em>解：</em></p>
<ul>
<li>1、同时满足1，2，3，最终权限是1+2+3</li>
<li>2、同时满足了1和2两个授权，最终权限是1+2</li>
<li>3、只满足1授权，所以只能select</li>
</ul>
<p><em>结论：</em></p>
<ul>
<li>1、如果在不同级别都包含某个表的管理能力时，权限是相加关系。</li>
<li>2、但是我们不推荐在多级别定义重复权限。</li>
<li>3、最常用的权限设定方式是单库级别授权，即：wordpress.*</li>
</ul>
<h2 id="三-MySQL连接管理"><a href="#三-MySQL连接管理" class="headerlink" title="三.MySQL连接管理"></a>三.MySQL连接管理</h2><p><strong><em>1.连接工具</em></strong></p>
<ul>
<li>1)MySQL自带的连接工具</li>
</ul>
<p>mysql</p>
<p>常见的特定于客户机的连接选项：<br>-u：指定用户<br>-p：指定密码<br>-h：指定主机<br>-P：指定端口<br>-S：指定sock<br>-e：指定SQL<br>--protocol&#x3D;name：指定连接方式</p>
<ul>
<li>2)第三方的连接工具</li>
</ul>
<p>sqlyog、navicat<br>应用程序连接MySQL<br>注意：需要加载对应语言程序的API</p>
<p><strong><em>2.连接方式</em></strong></p>
<ul>
<li><ol>
<li>socket连接</li>
</ol>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>poldboy123 <span class="operator">-</span>S<span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>poldboy123</span><br></pre></td></tr></table></figure>

<ul>
<li><ol start="2">
<li>TCP&#x2F;IP</li>
</ol>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>poldboy123 <span class="operator">-</span>h10<span class="number">.0</span><span class="number">.0</span><span class="number">.51</span> <span class="operator">-</span>P3306</span><br></pre></td></tr></table></figure>

<ul>
<li><strong><em>问题：你怎么判断你的MySQL数据库可以对外提供服务？</em></strong></li>
</ul>
<h2 id="四-MySQL启动关闭流程"><a href="#四-MySQL启动关闭流程" class="headerlink" title="四.MySQL启动关闭流程"></a>四.MySQL启动关闭流程</h2><p><img src="/assets/1652868921-2dd76817a78523ab794c492d5a01ab5c.jpg">￼</p>
<p><strong><em>启动</em></strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld <span class="keyword">start</span> <span class="comment">------&gt; mysqld_safe ------&gt; mysqld</span></span><br></pre></td></tr></table></figure>

<p><strong><em>关闭</em></strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld stop </span><br><span class="line">mysqladmin <span class="operator">-</span>uroot <span class="operator">-</span>poldboy123 shutdown</span><br><span class="line">kill <span class="number">-9</span> pid ?</span><br><span class="line">killall mysqld ?</span><br><span class="line">pkill mysqld ?</span><br></pre></td></tr></table></figure>

<p><strong><em>出现问题：</em></strong><br>- 1、如果在业务繁忙的情况下，数据库不会释放pid和sock文件<br>- 2、号称可以达到和Oracle一样的安全性，但是并不能100%达到<br>- 3、在业务繁忙的情况下，丢数据（补救措施，高可用）</p>
<p>可通过如下地址查看，生产高并发环境野蛮粗鲁杀死数据库进程导致故障企业案例：<br><a target="_blank" rel="noopener" href="https://blog.51cto.com/oldboy/1431161">625某电商网站数据库宕机故障解决实录（上）</a><br><a target="_blank" rel="noopener" href="https://blog.51cto.com/oldboy/1431172">625某电商网站数据库宕机故障解决实录（下）</a></p>
<h2 id="五-MySQL实例初始化配置"><a href="#五-MySQL实例初始化配置" class="headerlink" title="五.MySQL实例初始化配置"></a>五.MySQL实例初始化配置</h2><p><strong><em>1.初始化配置文件的作用</em></strong></p>
<p>场景：我要启动实例</p>
<p>问题：<br>1）我不知道我的程序在哪？<br>2）我也不知道我将来启动后去哪找数据库？<br>3）将来我启动的时候启动信息和错误信息放在哪？<br>4）我启动的时候sock文件pid文件放在哪？<br>5）我启动，你们给了我多少内存？<br>…<br>N）我还有很多问题需要在我启动之前告诉我，emmmmm….</p>
<p><img src="/assets/1652868921-0768f34cf2ec647c081bb16d9e1f6b3f.jpg">￼</p>
<ul>
<li>1）预编译：cmake去指定，硬编码到程序当中去</li>
<li>2）在命令行设定启动初始化配置</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">--skip-grant-tables </span><br><span class="line">--skip-networking</span><br><span class="line">--datadir=/application/mysql/data</span><br><span class="line">--basedir=/application/mysql</span><br><span class="line">--defaults-file=/etc/my,cnf</span><br><span class="line">--pid-file=/application/mysql/data/db01.pid</span><br><span class="line">--socket=/application/mysql/data/mysql.sock</span><br><span class="line">--user=mysql</span><br><span class="line">--port=3306</span><br><span class="line">--log-error=/application/mysql/data/db01.err</span><br></pre></td></tr></table></figure>

<ul>
<li>3）初始化配置文件（&#x2F;etc&#x2F;my.cnf）</li>
</ul>
<p>配置文件读取顺序：</p>
<p>&#x2F;etc&#x2F;my.cnf<br>&#x2F;etc&#x2F;mysql&#x2F;my.cnf<br>$MYSQL_HOME&#x2F;my.cnf（前提是在环境变量中定义了MYSQL_HOME变量）<br>defaults-extra-file （类似include）<br>~&#x2F;my.cnf</p>
<p><img src="/assets/1652868921-942368be47a312d876a95fedd85fb75f.jpg">￼</p>
<hr>
<p>--defaults-file：默认配置文件<br><strong><em>如果使用.&#x2F;bin&#x2F;mysqld_safe 守护进程启动mysql数据库时，使用了 –defaults-file&#x3D;&lt;配置文件的绝对路径&gt;参数，这时只会使用这个参数指定的配置文件。</em></strong></p>
<hr>
<p><strong><em>思考：</em></strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">cmake：</span></span><br><span class="line">socket=/application/mysql/tmp/mysql.sock</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">命令行：</span></span><br><span class="line">--socket=/tmp/mysql.sock</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置文件：</span></span><br><span class="line">/etc/my.cnf中[mysqld]标签下：socket=/opt/mysql.sock</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">default参数：</span></span><br><span class="line">--defaults-file=/tmp/a.txt配置文件中[mysqld]标签下：socket=/tmp/test.sock</span><br></pre></td></tr></table></figure>

<p><strong><em>socket文件会生成在哪？？？文件名叫什么？？？</em></strong></p>
<p><img src="/assets/1652868921-89ddd66efad2753904cf27d1ee4c4cd6.jpg">￼</p>
<p><strong><em>优先级结论：</em></strong></p>
<ul>
<li>1、命令行</li>
<li>2、defaults-file</li>
<li>3、配置文件</li>
<li>4、预编译</li>
</ul>
<p><strong><em>2.初始化配置文件的使用</em></strong></p>
<p><em>初始化配置文件功能</em></p>
<p>1）影响实例的启动（mysqld）<br>2）影响到客户端</p>
<ul>
<li>mysql</li>
<li>mysqldump</li>
<li>mysqladmin</li>
</ul>
<p><em>如何配置初始化配置文件</em></p>
<p>1）配置标签分类<br>[client]所有客户端程序<br>mysql<br>mysqldump<br>…</p>
<p>[server]所有服务器程序<br>mysqld<br>mysqld_safe<br>…</p>
<h2 id="六-MySQL多实例配置"><a href="#六-MySQL多实例配置" class="headerlink" title="六.MySQL多实例配置"></a>六.MySQL多实例配置</h2><ul>
<li>1.什么是多实例</li>
</ul>
<p>1）多套后台进程+线程+内存结构</p>
<p>2）多个配置文件<br>a.多个端口<br>b.多个socket文件<br>c.多个日志文件<br>d.多个server_id</p>
<p>3）多套数据</p>
<ul>
<li>2.多实例实战</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建数据目录</span></span><br><span class="line">[root@db01 ~]# mkdir -p /data/330&#123;7..9&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建配置文件</span></span><br><span class="line">[root@db01 ~]# touch /data/330&#123;7..9&#125;/my.cnf</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">编辑3307配置文件</span></span><br><span class="line">[root@db01 ~]# vim /data/3307/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/application/mysql</span><br><span class="line">datadir=/data/3307/data</span><br><span class="line">socket=/data/3307/mysql.sock</span><br><span class="line">log_error=/data/3307/mysql.log</span><br><span class="line">log-bin=/data/3307/mysql-bin</span><br><span class="line">server_id=7</span><br><span class="line">port=3307</span><br><span class="line">[client]</span><br><span class="line">socket=/data/3307/mysql.sock</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">编辑3308配置文件</span></span><br><span class="line">[root@db01 ~]# vim /data/3308/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/application/mysql</span><br><span class="line">datadir=/data/3308/data</span><br><span class="line">socket=/data/3308/mysql.sock</span><br><span class="line">log_error=/data/3308/mysql.log</span><br><span class="line">log-bin=/data/3308/mysql-bin</span><br><span class="line">server_id=8</span><br><span class="line">port=3308</span><br><span class="line">[client]</span><br><span class="line">socket=/data/3308/mysql.sock</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">编辑3309配置文件</span></span><br><span class="line">[root@db01 ~]# vim /data/3309/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/application/mysql</span><br><span class="line">datadir=/data/3309/data</span><br><span class="line">socket=/data/3309/mysql.sock</span><br><span class="line">log_error=/data/3309/mysql.log</span><br><span class="line">log-bin=/data/3309/mysql-bin</span><br><span class="line">server_id=9</span><br><span class="line">port=3309</span><br><span class="line">[client]</span><br><span class="line">socket=/data/3309/mysql.sock</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">初始化3307数据</span></span><br><span class="line">[root@db01 ~]#/application/mysql/scripts/mysql_install_db \</span><br><span class="line">--user=mysql \</span><br><span class="line">--defaults-file=/data/3307/my.cnf \</span><br><span class="line">--basedir=/application/mysql --datadir=/data/3307/data</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">初始化3308数据</span></span><br><span class="line">[root@db01 ~]#/application/mysql/scripts/mysql_install_db \</span><br><span class="line">--user=mysql \</span><br><span class="line">--defaults-file=/data/3308/my.cnf \</span><br><span class="line">--basedir=/application/mysql --datadir=/data/3308/data</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">初始化3309数据</span></span><br><span class="line">[root@db01 ~]#/application/mysql/scripts/mysql_install_db \</span><br><span class="line">--user=mysql \</span><br><span class="line">--defaults-file=/data/3309/my.cnf \</span><br><span class="line">--basedir=/application/mysql --datadir=/data/3309/data</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改目录权限</span></span><br><span class="line"><span class="meta prompt_">[root@db01]# </span><span class="language-bash"><span class="built_in">chown</span> -R mysql.mysql /data/330*</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动多实例</span></span><br><span class="line"><span class="meta prompt_">[root@db01]# </span><span class="language-bash">mysqld_safe --defaults-file=/data/3307/my.cnf &amp;</span></span><br><span class="line"><span class="meta prompt_">[root@db01]# </span><span class="language-bash">mysqld_safe --defaults-file=/data/3308/my.cnf &amp;</span></span><br><span class="line"><span class="meta prompt_">[root@db01]# </span><span class="language-bash">mysqld_safe --defaults-file=/data/3309/my.cnf &amp;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看server_id</span></span><br><span class="line"><span class="meta prompt_">[root@db01]# </span><span class="language-bash">mysql -S /data/3307/mysql.sock -e <span class="string">&quot;show variables like &#x27;server_id&#x27;&quot;</span></span></span><br><span class="line"><span class="meta prompt_">[root@db01]# </span><span class="language-bash">mysql -S /data/3308/mysql.sock -e <span class="string">&quot;show variables like &#x27;server_id&#x27;&quot;</span></span></span><br><span class="line"><span class="meta prompt_">[root@db01]# </span><span class="language-bash">mysql -S /data/3309/mysql.sock -e <span class="string">&quot;show variables like &#x27;server_id&#x27;&quot;</span></span></span><br></pre></td></tr></table></figure>

<h1 id="第四章·-MySQL客户端工具及SQL讲解"><a href="#第四章·-MySQL客户端工具及SQL讲解" class="headerlink" title="第四章· MySQL客户端工具及SQL讲解"></a>第四章· MySQL客户端工具及SQL讲解</h1><ul>
<li><a href="#toc_0">一.客户端命令介绍</a></li>
<li><a href="#toc_1">二.接收用户的SQL语句</a></li>
<li><a href="#toc_2">三.字符集定义</a></li>
<li><a href="#toc_3">四.字符集设置</a></li>
<li><a href="#toc_4">五.select的高级用法（扩展）</a></li>
</ul>
<p><em><strong>本章节内容需要用到一个SQL文件：world.sql评论后即可下载：</strong></em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://blog.driverzeng.com/world.sql</span><br></pre></td></tr></table></figure>





<h2 id="一-客户端命令介绍"><a href="#一-客户端命令介绍" class="headerlink" title="一.客户端命令介绍"></a>一.客户端命令介绍</h2><p><strong><em>mysql</em></strong></p>
<ul>
<li>1、用于数据库的连接管理</li>
</ul>
<blockquote>
<p>1） 连接（略）<br>2） 管理：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#MySQL接口自带的命令</span><br><span class="line">\h 或 help 或？      查看帮助</span><br><span class="line">\G                  格式化查看数据（key：value）</span><br><span class="line">\T 或 tee            记录日志</span><br><span class="line">\c（5.7可以ctrl+c）   结束命令</span><br><span class="line">\s 或 status         查看状态信息</span><br><span class="line">\. 或 source         导入SQL数据</span><br><span class="line">\u或 use             使用数据库</span><br><span class="line">\q 或 exit 或 quit   退出</span><br></pre></td></tr></table></figure>

<blockquote>
<p>3）接收用户的SQL语句</p>
</blockquote>
<ul>
<li>2、将用户的SQL语句发送到服务器</li>
</ul>
<p><strong><em>mysqladmin</em></strong></p>
<ul>
<li>1、命令行管理工具</li>
</ul>
<p><strong><em>mysqldump</em></strong></p>
<ul>
<li>1、备份数据库和表的内容</li>
</ul>
<p><strong><em>help命令的使用</em></strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> help</span><br><span class="line">mysql<span class="operator">&gt;</span> help contents</span><br><span class="line">mysql<span class="operator">&gt;</span> help <span class="keyword">select</span></span><br><span class="line">mysql<span class="operator">&gt;</span> help <span class="keyword">create</span></span><br><span class="line">mysql<span class="operator">&gt;</span> help <span class="keyword">create</span> <span class="keyword">user</span></span><br><span class="line">mysql<span class="operator">&gt;</span> help status</span><br><span class="line">mysql<span class="operator">&gt;</span> help <span class="keyword">show</span></span><br></pre></td></tr></table></figure>

<p><strong><em>source命令的使用</em></strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#在MySQL中处理输入文件：</span><br><span class="line">#如果这些文件包含<span class="keyword">SQL</span>语句则称为：</span><br><span class="line">#<span class="number">1.</span>脚本文件</span><br><span class="line">#<span class="number">2.</span>批处理文件</span><br><span class="line">mysql<span class="operator">&gt;</span> SOURCE <span class="operator">/</span>data<span class="operator">/</span>mysql<span class="operator">/</span>world.sql</span><br><span class="line">#或者使用非交互式</span><br><span class="line">mysql<span class="operator">&lt;</span><span class="operator">/</span>data<span class="operator">/</span>mysql<span class="operator">/</span>world.sql</span><br></pre></td></tr></table></figure>

<p><strong><em>mysqladmin命令的使用</em></strong></p>
<blockquote>
<p>01）“强制回应 (Ping)”服务器。<br>02）关闭服务器。<br>03）创建和删除数据库。<br>04）显示服务器和版本信息。<br>05）显示或重置服务器状态变量。<br>06）设置口令。<br>07）重新刷新授权表。<br>08）刷新日志文件和高速缓存。<br>09）启动和停止复制。<br>10）显示客户机信息。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看MySQL存活状态</span></span><br><span class="line">[root@db01 ~]# mysqladmin -uroot -p123 ping</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看MySQL状态信息</span></span><br><span class="line">[root@db01 ~]# mysqladmin -uroot -p123 status</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">关闭MySQL进程</span></span><br><span class="line">[root@db01 ~]# mysqladmin -uroot -p123 shutdown</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看MySQL参数</span></span><br><span class="line">[root@db01 ~]# mysqladmin -uroot -p123 variables</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">删除数据库</span></span><br><span class="line">[root@db01 ~]# mysqladmin -uroot -p123 drop DATABASE</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建数据库</span></span><br><span class="line">[root@db01 ~]# mysqladmin -uroot -p123 create DATABASE</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重载授权表</span></span><br><span class="line">[root@db01 ~]# mysqladmin -uroot -p123 reload</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">刷新日志</span></span><br><span class="line">[root@db01 ~]# mysqladmin -uroot -p123 flush-log</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">刷新缓存主机</span></span><br><span class="line">[root@db01 ~]# mysqladmin -uroot -p123 reload</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改口令</span></span><br><span class="line">[root@db01 ~]# mysqladmin -uroot -p123 password</span><br></pre></td></tr></table></figure>

<h2 id="二-接收用户的SQL语句"><a href="#二-接收用户的SQL语句" class="headerlink" title="二.接收用户的SQL语句"></a>二.接收用户的SQL语句</h2><ul>
<li>1.什么是SQL</li>
</ul>
<p>结构化的查询语句</p>
<ul>
<li>2.SQL的种类</li>
</ul>
<p><strong><em>DDL：数据定义语言</em></strong></p>
<p><strong>库对象：库名字、库属性</strong><br>开发规范：库名小写</p>
<p><em>创建库：create database|schema</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#创建oldboy数据库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database oldboy;</span><br><span class="line">#创建OLDBOY数据库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database OLDBOY;</span><br><span class="line">#查看数据库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line">#查看oldboy的创建语句（DQL）</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> database oldboy;</span><br><span class="line">#查看创建数据库语句帮助</span><br><span class="line">mysql<span class="operator">&gt;</span> help <span class="keyword">create</span> database</span><br><span class="line">#创建oldboy数据库添加属性</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database testa charset utf8;</span><br></pre></td></tr></table></figure>

<p><em>删库：drop database</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#删除oldboy数据库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database oldboy;</span><br></pre></td></tr></table></figure>

<p><em>修改定义库：alter database</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#修改oldboy数据库属性</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> database oldboy charset gbk;</span><br><span class="line">#查看oldboy的创建语句（DQL）</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> database oldboy;</span><br></pre></td></tr></table></figure>

<p><strong>表对象:列名、列属性、约束</strong></p>
<p><em>创建表：create table （开发做）</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#查看创建表语句帮助</span><br><span class="line">mysql<span class="operator">&gt;</span> help <span class="keyword">create</span> <span class="keyword">table</span></span><br><span class="line">#创建表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> student(</span><br><span class="line">sid <span class="type">INT</span>,</span><br><span class="line">sname <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">sage TINYINT,</span><br><span class="line">sgender ENUM(<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;f&#x27;</span>),</span><br><span class="line">cometime DATETIME);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>数据类型<br>int： 整数 -231 ~ 231 -1<br>varchar：字符类型 （变长）<br>char： 字符类型 （定长）<br>tinyint： 整数 -128 ~ 128<br>enum： 枚举类型<br>datetime： 时间类型 年月日时分秒</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#创建表加其他属性</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> student(</span><br><span class="line">sid <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT COMMENT ‘学号’,</span><br><span class="line">sname <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT ‘学生姓名’,</span><br><span class="line">sage TINYINT UNSIGNED COMMENT ‘学生年龄’,</span><br><span class="line">sgender ENUM(<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;f&#x27;</span>)  <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> ‘m’ COMMENT ‘学生性别’,</span><br><span class="line">cometime DATETIME <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT ‘入学时间’)chatset utf8 engine innodb;</span><br><span class="line">#查看建表语句</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> student;</span><br><span class="line">#查看表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line">#查看表中列的定义信息</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> student;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>数据属性<br>not null： 非空<br>primary key： 主键（唯一且非空的）<br>auto_increment： 自增（此列必须是：primary key或者unique key）<br>unique key： 单独的唯一的<br>default： 默认值<br>unsigned： 非负数<br>comment： 注释</p>
</blockquote>
<p><em>删除表</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#删除表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">table</span> student;</span><br></pre></td></tr></table></figure>

<p><em>修改表定义：alter table （开发做）</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#修改表名</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student rename stu;</span><br><span class="line">#添加列和列定义</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> stu <span class="keyword">add</span> age <span class="type">int</span>;</span><br><span class="line">#添加多个列</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> stu <span class="keyword">add</span> test <span class="type">varchar</span>(<span class="number">20</span>),<span class="keyword">add</span> qq <span class="type">int</span>;</span><br><span class="line">#指定位置进行添加列（表首）</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> stu <span class="keyword">add</span> classid <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">first</span>;</span><br><span class="line">#指定位置进行添加列（指定列）</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> stu <span class="keyword">add</span> phone <span class="type">int</span> after age;</span><br><span class="line">#删除指定的列及定义</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> stu <span class="keyword">drop</span> qq;</span><br><span class="line">#修改列及定义（列属性）</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> stu modify sid <span class="type">varchar</span>(<span class="number">20</span>);</span><br><span class="line">#修改列及定义（列名及属性）</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> stu change phone telphone <span class="type">char</span>(<span class="number">20</span>);</span><br></pre></td></tr></table></figure>

<p><strong><em>DCL：数据控制语言</em></strong></p>
<p><strong>针对权限进行控制</strong></p>
<p><em>grant</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#授权root<span class="variable">@10</span><span class="number">.0</span><span class="number">.0</span><span class="number">.51</span>用户所有权限（非炒鸡管理员）</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> root@<span class="string">&#x27;10.0.0.51&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;oldboy123&#x27;</span>;</span><br><span class="line">#怎么去授权一个炒鸡管理员呢？</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> root@<span class="string">&#x27;10.0.0.51&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;oldboy123&#x27;</span> <span class="keyword">with</span> <span class="keyword">grant</span> option;</span><br><span class="line">#其他参数（扩展）</span><br><span class="line">max_queries_per_hour：一个用户每小时可发出的查询数量</span><br><span class="line">max_updates_per_hour：一个用户每小时可发出的更新数量</span><br><span class="line">max_connections_per_hour：一个用户每小时可连接到服务器的次数</span><br><span class="line">max_user_connections：允许同时连接数量</span><br></pre></td></tr></table></figure>

<p><em>revoke</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#收回<span class="keyword">select</span>权限</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">revoke</span> <span class="keyword">select</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">from</span> root@<span class="string">&#x27;10.0.0.51&#x27;</span>;</span><br><span class="line">#查看权限</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> grants <span class="keyword">for</span> root@<span class="string">&#x27;10.0.0.51&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong><em>DML：数据操作语言</em></strong></p>
<p><strong>操作表的数据行信息</strong></p>
<p><em>insert</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#基础用法，插入数据</span><br><span class="line">mysql&gt; insert into stu values(&#x27;linux01&#x27;,1,NOW(),&#x27;zhangsan&#x27;,20,&#x27;m&#x27;,NOW(),110,123456);</span><br><span class="line">#规范用法，插入数据</span><br><span class="line">mysql&gt; insert into stu(classid,birth.sname,sage,sgender,comtime,telnum,qq) values(&#x27;linux01&#x27;,1,NOW(),&#x27;zhangsan&#x27;,20,&#x27;m&#x27;,NOW(),110,123456);</span><br><span class="line">#插入多条数据</span><br><span class="line">mysql&gt; insert into stu(classid,birth.sname,sage,sgender,comtime,telnum,qq) values(&#x27;linux01&#x27;,1,NOW(),&#x27;zhangsan&#x27;,20,&#x27;m&#x27;,NOW(),110,123456),</span><br><span class="line">(&#x27;linux02&#x27;,2,NOW(),&#x27;zhangsi&#x27;,21,&#x27;f&#x27;,NOW(),111,1234567);</span><br></pre></td></tr></table></figure>

<p><em>update</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#不规范</span><br><span class="line">mysql&gt; update student set sgender=&#x27;f&#x27;;</span><br><span class="line">#规范update修改</span><br><span class="line">mysql&gt; update student set sgender=&#x27;f&#x27; where sid=1;</span><br><span class="line">#如果非要全表修改</span><br><span class="line">mysql&gt; update student set sgender=&#x27;f&#x27; where 1=1;</span><br></pre></td></tr></table></figure>

<p><em>delete</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#不规范</span><br><span class="line">mysql&gt; delete from student;</span><br><span class="line">#规范删除（危险）</span><br><span class="line">mysql&gt; delete from student where sid=3;</span><br><span class="line">#DDL删除表</span><br><span class="line">mysql&gt; truncate table student;</span><br></pre></td></tr></table></figure>

<ul>
<li>1、使用伪删除</li>
</ul>
<p><strong>使用update代替delete</strong></p>
<p>1）额外添加一个状态列</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter table student add status enum(1,0) default 1;</span><br></pre></td></tr></table></figure>

<p>2）使用update</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update student set status=&#x27;0&#x27; where sid=1;</span><br></pre></td></tr></table></figure>

<p>3）应用查询存在的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from student where status=1;</span><br></pre></td></tr></table></figure>

<ul>
<li>2、使用触发器（了解）</li>
</ul>
<blockquote>
<p>trigger</p>
</blockquote>
<p><strong><em>DQL：数据查询语言</em></strong></p>
<p><em>select：基础用法</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#常用用法</span><br><span class="line">mysql&gt; select countrycode,district from city;</span><br><span class="line">#查询单列</span><br><span class="line">mysql&gt; select countrycode from city;</span><br><span class="line">#行级查询</span><br><span class="line">mysql&gt; select countrycode,district from city limit 2;</span><br><span class="line">mysql&gt; select id,countrycode,district from city limit 2,2;</span><br><span class="line">#条件查询</span><br><span class="line">mysql&gt; select name,population from city where countrycode=&#x27;CHN&#x27;;</span><br><span class="line">#多条件查询</span><br><span class="line">mysql&gt; select name,population from city where countrycode=&#x27;CHN&#x27; and district=&#x27;heilongjiang&#x27;;</span><br><span class="line">#模糊查询</span><br><span class="line">mysql&gt; select name,population,countrycode from city where countrycode like &#x27;%H%&#x27; limit 10;</span><br><span class="line">#排序查询（顺序）</span><br><span class="line">mysql&gt; select id,name,population,countrycode from city order by countrycode limit 10;</span><br><span class="line">#排序查询（倒叙）</span><br><span class="line">mysql&gt; select id,name,population,countrycode from city order by countrycode desc limit 10;</span><br><span class="line">#范围查询(&gt;,&lt;,&gt;=,&lt;=,&lt;&gt;)</span><br><span class="line">mysql&gt; select * from city where population&gt;=1410000;</span><br><span class="line">#范围查询OR语句</span><br><span class="line">mysql&gt; select * from city where countrycode=&#x27;CHN&#x27; or countrycode=&#x27;USA&#x27;;</span><br><span class="line">#范围查询IN语句</span><br><span class="line">mysql&gt; select * from city where countrycode in (&#x27;CHN&#x27;,&#x27;USA&#x27;);</span><br></pre></td></tr></table></figure>

<h2 id="三-字符集定义"><a href="#三-字符集定义" class="headerlink" title="三.字符集定义"></a>三.字符集定义</h2><ul>
<li>1.什么是字符集（Charset）</li>
</ul>
<p>字符集：是一个系统支持的所有抽象字符的集合。字符是各种文字和符号的总称，包括各国家文字、标点符号、图形符号、数字等。</p>
<p><img src="/assets/1652869672-53274b972c5f9bb29b9b84ed8bc4e711.jpg">￼</p>
<ul>
<li>2.MySQL数据库的字符集</li>
</ul>
<blockquote>
<p>1）字符集（CHARACTER）<br>2）校对规则（COLLATION）</p>
</blockquote>
<ul>
<li>3.MySQL中常见的字符集</li>
</ul>
<blockquote>
<p>1）UTF8<br>2）LATIN1<br>3）GBK</p>
</blockquote>
<ul>
<li>4.常见校对规则</li>
</ul>
<blockquote>
<p>1）ci：大小写不敏感<br>2）cs或bin：大小写敏感</p>
</blockquote>
<ul>
<li>5.我们可以使用以下命令查看</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show charset;</span><br><span class="line">mysql&gt; show collation；</span><br></pre></td></tr></table></figure>

<h2 id="四-字符集设置"><a href="#四-字符集设置" class="headerlink" title="四.字符集设置"></a>四.字符集设置</h2><ul>
<li>1.操作系统级别</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# source /etc/sysconfig/i18n</span><br><span class="line">[root@db01 ~]# echo $LANG</span><br><span class="line">zh_CN.UTF-8</span><br></pre></td></tr></table></figure>

<ul>
<li>2.操作系统客户端级别（SSH）</li>
<li>3.MySQL实例级别</li>
</ul>
<p><em>方法1：在编译安装时候就指定如下服务器端字符集。</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cmake . </span><br><span class="line">-DDEFAULT_CHARSET=utf8 \</span><br><span class="line">-DDEFAULT_COLLATION=utf8_general_ci \</span><br><span class="line">-DWITH_EXTRA_CHARSETS=all \</span><br></pre></td></tr></table></figure>

<p><em>方法2：在配置文件中设置字符集</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">character-set-server=utf8</span><br></pre></td></tr></table></figure>

<ul>
<li>4.建库级别</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database oldboy charset utf8 default collate = utf8_general_ci;</span><br></pre></td></tr></table></figure>

<ul>
<li>5.建表级别</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  CREATE TABLE `test` (</span><br><span class="line">`id` int(4) NOT NULL AUTO_INCREMENT,</span><br><span class="line">`name` char(20) NOT NULL,</span><br><span class="line">PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=13 DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong><em>思考问题：如果在生产环境中，字符集不够用或者字符集不合适该怎么处理？</em></strong></p>
<p><img src="/assets/1652869672-7c3f73d8d5f45800f6b1d1305857dc6d.jpg">￼<br><img src="/assets/1652869672-4168e18c83d50d9738b558a6b8f00abd.jpg">￼</p>
<hr>
<p><strong>生产环境更改数据库（含数据）字符集的方法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter database oldboy CHARACTER SET utf8 collate utf8_general_ci;</span><br><span class="line">mysql&gt; alter table t1 CHARACTER SET utf8;</span><br></pre></td></tr></table></figure>

<h2 id="五-select的高级用法（扩展）"><a href="#五-select的高级用法（扩展）" class="headerlink" title="五.select的高级用法（扩展）"></a>五.select的高级用法（扩展）</h2><ul>
<li>1.多表连接查询（连表查询）<br><img src="./assets/1652869672-102aa7924b928c7ba54a828506cabece.jpg" alt="15396104670598" style="zoom:50%;" />￼</li>
</ul>
<p>集合：<br>[zhang3,li4,wang5]</p>
<p>[50,70,80]</p>
<p>t1:<br>sid 1 2 3<br>sname zhang3 li4 wang5</p>
<p>t2:<br>sid 1 2 3<br>mark 50 70 80</p>
<p><em>范式：</em> 减少数据冗余，防止产生一致性问题，把一个表作为一个原子，把一张表拆到不能再拆为止。（开发阶段设计规范）</p>
<p><strong>例：根据两张表的内容查出张三的成绩</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> t1.sname,t2.mark <span class="keyword">from</span> t1,t2 <span class="keyword">where</span> t1.sid<span class="operator">=</span>t2.sid <span class="keyword">and</span> t1.sname<span class="operator">=</span>’zhang3’;</span><br></pre></td></tr></table></figure>

<p><strong>1.1传统连接（只能内连接，只能取交集）</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#世界上小于<span class="number">100</span>人的人口城市是哪个国家的？</span><br><span class="line"><span class="keyword">select</span> city.name,city.countrycode,country.name </span><br><span class="line"><span class="keyword">from</span> city,country </span><br><span class="line"><span class="keyword">where</span> city.countrycode<span class="operator">=</span>country.code </span><br><span class="line"><span class="keyword">and</span> city.population<span class="operator">&lt;</span><span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<p><strong>1.2 NATURAL　JOIN（自连接的表要有共同的列名字）</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> city.name,city.countrycode ,countrylanguage.language ,city.population</span><br><span class="line"><span class="keyword">FROM</span>  city <span class="keyword">NATURAL</span>  <span class="keyword">JOIN</span>  countrylanguage </span><br><span class="line"><span class="keyword">WHERE</span> population <span class="operator">&gt;</span> <span class="number">1000000</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> population;</span><br></pre></td></tr></table></figure>

<p><strong>1.3企业中多表连接查询（内连接）</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> city.name,city.countrycode,country.name </span><br><span class="line"><span class="keyword">from</span> city <span class="keyword">join</span> country <span class="keyword">on</span> city.countrycode<span class="operator">=</span>country.code </span><br><span class="line"><span class="keyword">where</span> city.population<span class="operator">&lt;</span><span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<p><strong>建议：使用join语句时，小表在前，大表在后。</strong></p>
<p><strong>1.4外连接</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> city.name,city.countrycode,country.name </span><br><span class="line"><span class="keyword">from</span> city <span class="keyword">left</span> <span class="keyword">join</span> country </span><br><span class="line"><span class="keyword">on</span> city.countrycode<span class="operator">=</span>country.code </span><br><span class="line"><span class="keyword">and</span> city.population<span class="operator">&lt;</span><span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<p><strong>1.5 UNION（合并查询）</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#范围查询<span class="keyword">OR</span>语句</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span> <span class="keyword">or</span> countrycode<span class="operator">=</span><span class="string">&#x27;USA&#x27;</span>;</span><br><span class="line">#范围查询<span class="keyword">IN</span>语句</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode <span class="keyword">in</span> (<span class="string">&#x27;CHN&#x27;</span>,<span class="string">&#x27;USA&#x27;</span>);</span><br><span class="line">替换为：</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span> </span><br><span class="line"><span class="keyword">union</span>  <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;USA&#x27;</span> limit <span class="number">10</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>union：去重复合并<br>union all ：不去重复<br>使用情况：union&lt;union all</p>
</blockquote>
<hr>
<h2 id="title-第五章·-MySQL数据类型url-https-blog-driverzeng-com-zenglaoshi-659-htmlclipped-at-2022-05-18-18-28-14category-defaulttags-无"><a href="#title-第五章·-MySQL数据类型url-https-blog-driverzeng-com-zenglaoshi-659-htmlclipped-at-2022-05-18-18-28-14category-defaulttags-无" class="headerlink" title="title: 第五章· MySQL数据类型url: https://blog.driverzeng.com/zenglaoshi/659.htmlclipped_at: 2022-05-18 18:28:14category: defaulttags: - 无"></a>title: 第五章· MySQL数据类型<br>url: <a target="_blank" rel="noopener" href="https://blog.driverzeng.com/zenglaoshi/659.html">https://blog.driverzeng.com/zenglaoshi/659.html</a><br>clipped_at: 2022-05-18 18:28:14<br>category: default<br>tags:<br> - 无</h2><h1 id="第五章·-MySQL数据类型"><a href="#第五章·-MySQL数据类型" class="headerlink" title="第五章· MySQL数据类型"></a>第五章· MySQL数据类型</h1><ul>
<li><a href="#toc_0">一.数据类型介绍</a></li>
<li><a href="#toc_1">二.列属性介绍</a></li>
</ul>
<blockquote>
<p>曾志高翔, 江湖人称曾老大。多年互联网运维工作经验，曾负责过大规模集群架构自动化运维管理工作。擅长Web集群架构与自动化运维，曾负责国内某大型金融公司运维工作。<br>个人博客:”DBA老司机带你删库跑路”<br>笔者QQ:133411023、253097001<br>笔者交流群：198571640<br>笔者微信：z133411023</p>
</blockquote>
<h2 id="一-数据类型介绍"><a href="#一-数据类型介绍" class="headerlink" title="一.数据类型介绍"></a>一.数据类型介绍</h2><ul>
<li><strong>1.四种主要类别</strong></li>
</ul>
<p><img src="/assets/1652869694-863eb4e107e46e210fcdc67ec80d8405.jpg">￼</p>
<blockquote>
<p>1）数值类型<br>2）字符类型<br>3）时间类型<br>4）二进制类型</p>
</blockquote>
<ul>
<li><strong>2.数据类型的 ABC 要素</strong></li>
</ul>
<blockquote>
<p>1）Appropriate（适当）<br>2）Brief（简洁）<br>3）Complete（完整）</p>
</blockquote>
<ul>
<li><strong>3.数值数据类型</strong></li>
</ul>
<p>3.1使用数值数据类型时的注意事项：</p>
<blockquote>
<p>1）数据类型所表示的值的范围<br>2）列值所需的空间量<br>3）列精度和范围（浮点数和定点数）</p>
</blockquote>
<p>3.2数值数据类型的类</p>
<blockquote>
<p>1）整数：整数<br>2）浮点数：小数<br>3）定点数：精确值数值<br>4）BIT：位字段值</p>
</blockquote>
<p><img src="/assets/1652869694-3eb652ee6e554f7573cd5fff813a6728.jpg">￼</p>
<ul>
<li>4.字符串数据类型</li>
</ul>
<blockquote>
<p>1）表示给定字符集中的一个字母数字字符序列<br>2）用于存储文本或二进制数据<br>3）几乎在每种编程语言中都有实现<br>4）支持字符集和整理<br>5）属于以下其中一类</p>
</blockquote>
<p><strong>文本：真实的非结构化字符串数据类型</strong><br><strong>整数：结构化字符串类型</strong></p>
<p><img src="/assets/1652869694-18cfb44671d43e7950be85f061409688.jpg">￼</p>
<ul>
<li>5.二进制字符串数据类型</li>
</ul>
<p>5.1字节序列</p>
<blockquote>
<p>1）二进制位按八位分组<br>2）存储二进制值<br>3）编译的计算机程序和应用程序<br>4）图像和声音文件</p>
</blockquote>
<p>5.2字符二进制数据类型的类</p>
<blockquote>
<p>1）二进制：固定长度和可变长度的二进制字符串<br>2）BLOB：二进制数据的可变长度非结构化集合</p>
</blockquote>
<p><img src="/assets/1652869694-8fd32c826dc1dc15ec51229659563347.jpg">￼</p>
<ul>
<li>6.时间数据类型</li>
</ul>
<h2 id="二-列属性介绍"><a href="#二-列属性介绍" class="headerlink" title="二.列属性介绍"></a>二.列属性介绍</h2><ul>
<li>1.列属性的类别</li>
</ul>
<blockquote>
<p>1）数值：适用于数值数据类型（BIT 除外）<br>2）字符串：适用于非二进制字符串数据类型<br>3）常规：适用于所有数据类型</p>
</blockquote>
<p><img src="/assets/1652869694-01cf01ca0a47d13312d62d4af84c3eb0.jpg">￼</p>
<p>赏</p>
<p><a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.driverzeng.com/zenglaoshi/tag/driverzeng/">driverzeng</a> <a target="_blank" rel="noopener" href="https://blog.driverzeng.com/zenglaoshi/tag/mysql/">MySQL</a></p>
<p><a href="javascript:">0</a></p>
<p>[</p>
<p>Previous Post</p>
<h3 id="第四章·-MySQL客户端工具及SQL讲解-1"><a href="#第四章·-MySQL客户端工具及SQL讲解-1" class="headerlink" title="第四章· MySQL客户端工具及SQL讲解"></a>第四章· MySQL客户端工具及SQL讲解</h3><hr>
<p>](<a target="_blank" rel="noopener" href="https://blog.driverzeng.com/zenglaoshi/651.html">https://blog.driverzeng.com/zenglaoshi/651.html</a>)</p>
<p>[</p>
<p>Next Post</p>
<h3 id="第六章·-MySQL索引管理及执行计划"><a href="#第六章·-MySQL索引管理及执行计划" class="headerlink" title="第六章· MySQL索引管理及执行计划"></a>第六章· MySQL索引管理及执行计划</h3><hr>
<p>](<a target="_blank" rel="noopener" href="https://blog.driverzeng.com/zenglaoshi/668.html">https://blog.driverzeng.com/zenglaoshi/668.html</a>)</p>
<ul>
<li></li>
</ul>
<h1 id="第六章·-MySQL索引管理及执行计划-1"><a href="#第六章·-MySQL索引管理及执行计划-1" class="headerlink" title="第六章· MySQL索引管理及执行计划"></a>第六章· MySQL索引管理及执行计划</h1><ul>
<li><a href="#toc_0">一.索引介绍</a></li>
<li><a href="#toc_1">二.explain详解</a></li>
<li><a href="#toc_2">三.建立索引的原则（规范）</a></li>
</ul>
<h2 id="一-索引介绍"><a href="#一-索引介绍" class="headerlink" title="一.索引介绍"></a>一.索引介绍</h2><p><strong>1.什么是索引</strong></p>
<p><img src="/assets/1652631963-9376d598e3b0517a4e2b95cfa4c08b0b.jpg"></p>
<blockquote>
<p>1）索引就好比一本书的目录，它能让你更快的找到自己想要的内容。<br>2）让获取的数据更有目的性，从而提高数据库检索数据的性能。</p>
</blockquote>
<p><strong>2.索引类型介绍</strong></p>
<blockquote>
<p>1)BTREE:B+树索引<br>2)HASH：HASH索引<br>3)FULLTEXT：全文索引<br>4)RTREE：R树索引</p>
</blockquote>
<p><img src="/assets/1652631963-27f7aad8730c6d50559d94ba150c143a.jpg"></p>
<p>图1·B+tree索引</p>
<p><img src="/assets/1652631963-f720362369a4a42c98b6bac27e26a49b.jpg"></p>
<p>图2·B*tree索引</p>
<p><strong>3.索引管理</strong></p>
<blockquote>
<p>索引建立在表的列上(字段)的。<br>在where后面的列建立索引才会加快查询速度。<br>pages&lt;—索引（属性）&lt;—-查数据。</p>
</blockquote>
<ul>
<li>1、索引分类：</li>
</ul>
<blockquote>
<p>主键索引<br>普通索引*****<br>唯一索引</p>
</blockquote>
<ul>
<li>2、添加索引：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#创建索引</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> test <span class="keyword">add</span> index index_name(name);</span><br><span class="line">#创建索引</span><br><span class="line"><span class="keyword">create</span> index index_name <span class="keyword">on</span> test(name);</span><br><span class="line">#查看索引</span><br><span class="line"><span class="keyword">desc</span> <span class="keyword">table</span>;</span><br><span class="line">#查看索引</span><br><span class="line"><span class="keyword">show</span> index <span class="keyword">from</span> <span class="keyword">table</span>;</span><br><span class="line">#删除索引</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> test <span class="keyword">drop</span> key index_name;</span><br><span class="line">#添加主键索引（略）</span><br><span class="line">#添加唯一性索引</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> student <span class="keyword">add</span> <span class="keyword">unique</span> key uni_xxx(xxx);</span><br><span class="line">#查看表中数据行数</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> city;</span><br><span class="line">#查看去重数据行数</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> name) <span class="keyword">from</span> city;</span><br></pre></td></tr></table></figure>

<ul>
<li>3、前缀索引和联合索引</li>
</ul>
<p><strong>前缀索引</strong></p>
<p><em>根据字段的前N个字符建立索引</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> test <span class="keyword">add</span> index idx_name(name(<span class="number">10</span>));</span><br></pre></td></tr></table></figure>

<blockquote>
<p>避免对大列建索引<br>如果有，就使用前缀索引</p>
</blockquote>
<p><strong>联合索引</strong></p>
<p><em>多个字段建立一个索引</em></p>
<blockquote>
<p>例：<br>where a.女生 and b.身高 and c.体重 and d.身材好<br>index(a,b,c)<br>特点：前缀生效特性<br>a,ab,ac,abc,abcd 可以走索引或部分走索引<br>b bc bcd cd c d ba … 不走索引</p>
</blockquote>
<p><strong>原则：把最常用来做为条件查询的列放在最前面</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#创建people表</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> people (id <span class="type">int</span>,name <span class="type">varchar</span>(<span class="number">20</span>),age tinyint,money <span class="type">int</span> ,gender enum(<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;f&#x27;</span>));</span><br><span class="line">#创建联合索引</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> people <span class="keyword">add</span> index  idx_gam(gender,age,money);</span><br></pre></td></tr></table></figure>

<h2 id="二-explain详解"><a href="#二-explain详解" class="headerlink" title="二.explain详解"></a>二.explain详解</h2><p><strong>explain命令使用方法</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> name,countrycode <span class="keyword">from</span> city <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><strong>explain命令应用</strong></p>
<p><em>查询数据的方式</em></p>
<ul>
<li><p>1.全表扫描1）在explain语句结果中type为ALL<br>2）什么时候出现全表扫描?</p>
<ul>
<li>  2.1 业务确实要获取所有数据</li>
<li>  2.2 不走索引导致的全表扫描<ul>
<li>    2.2.1 没索引</li>
<li>    2.2.2 索引创建有问题</li>
<li>    2.2.3 语句有问题</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>生产中,mysql在使用全表扫描时的性能是极其差的，所以MySQL尽量避免出现全表扫描</strong></p>
<ul>
<li>2.索引扫描</li>
</ul>
<blockquote>
<p>2.1 常见的索引扫描类型:<br>1）index<br>2）range<br>3）ref<br>4）eq_ref<br>5）const<br>6）system<br>7）null</p>
</blockquote>
<p><strong>从上到下，性能从最差到最好，我们认为至少要达到range级别</strong></p>
<p><strong>index</strong>：Full Index Scan，index与ALL区别为index类型只遍历索引树。<br><strong>range</strong>：索引范围扫描，对索引的扫描开始于某一点，返回匹配值域的行。显而易见的索引范围扫描是带有between或者where子句里带有&lt;,&gt;查询。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> city <span class="keyword">add</span> index idx_city(population);</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> population<span class="operator">&gt;</span><span class="number">30000000</span>;</span><br></pre></td></tr></table></figure>

<p><strong>ref</strong>：使用非唯一索引扫描或者唯一索引的前缀扫描，返回匹配某个单独值的记录行。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> city <span class="keyword">drop</span> key idx_code;</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;chn&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode <span class="keyword">in</span> (<span class="string">&#x27;CHN&#x27;</span>,<span class="string">&#x27;USA&#x27;</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span> <span class="keyword">union</span> <span class="keyword">all</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;USA&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>eq_ref</strong>：类似ref，区别就在使用的索引是唯一索引，对于每个索引键值，表中只有一条记录匹配，简单来说，就是多表连接中使用primary key或者 unique key作为关联条件A</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">join</span> B </span><br><span class="line"><span class="keyword">on</span> A.sid<span class="operator">=</span>B.sid</span><br></pre></td></tr></table></figure>

<p><strong>const、system</strong>：当MySQL对查询某部分进行优化，并转换为一个常量时，使用这些类型访问。</p>
<p><em>如将主键置于where列表中，MySQL就能将该查询转换为一个常量</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1000</span>;</span><br></pre></td></tr></table></figure>

<p><strong>NULL</strong>：MySQL在优化过程中分解语句，执行时甚至不用访问表或索引，例如从一个索引列里选取最小值可以通过单独索引查找完成。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1000000000000000000000000000</span>;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>Extra（扩展）</strong><br>Using temporary<br>Using filesort 使用了默认的文件排序（如果使用了索引，会避免这类排序）<br>Using join buffer</p>
<p><strong>如果出现Using filesort请检查order by ,group by ,distinct,join 条件列上没有索引</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> population;</span><br></pre></td></tr></table></figure>

<p><strong>当order by语句中出现Using filesort，那就尽量让排序值在where条件中出现</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> population<span class="operator">&gt;</span><span class="number">30000000</span> <span class="keyword">order</span> <span class="keyword">by</span> population;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> population<span class="operator">=</span><span class="number">2870300</span> <span class="keyword">order</span> <span class="keyword">by</span> population;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>key_len</strong>: 越小越好</p>
</blockquote>
<ul>
<li>前缀索引去控制</li>
</ul>
<blockquote>
<p><strong>rows</strong>: 越小越好</p>
</blockquote>
<hr>
<h2 id="三-建立索引的原则（规范）"><a href="#三-建立索引的原则（规范）" class="headerlink" title="三.建立索引的原则（规范）"></a>三.建立索引的原则（规范）</h2><p><strong>为了使索引的使用效率更高，在创建索引时，必须考虑在哪些字段上创建索引和创建什么类型的索引。</strong></p>
<p><em>那么索引设计原则又是怎样的?</em></p>
<ul>
<li>1、选择唯一性索引</li>
</ul>
<p><strong>唯一性索引的值是唯一的，可以更快速的通过该索引来确定某条记录。</strong></p>
<blockquote>
<p>例如:<br>学生表中学号是具有唯一性的字段。为该字段建立唯一性索引可以很快的确定某个学生的信息。<br>如果使用姓名的话，可能存在同名现象，从而降低查询速度。<br>主键索引和唯一键索引，在查询中使用是效率最高的。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> world.city;</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> countrycode) <span class="keyword">from</span> world.city;</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> countrycode,population ) <span class="keyword">from</span> world.city;</span><br></pre></td></tr></table></figure>

<p><strong>注意：如果重复值较多，可以考虑采用联合索引</strong></p>
<ul>
<li>2．为经常需要排序、分组和联合操作的字段建立索引</li>
</ul>
<blockquote>
<p>例如:<br>经常需要ORDER BY、GROUP BY、DISTINCT和UNION等操作的字段，排序操作会浪费很多时间。<br>如果为其建立索引，可以有效地避免排序操作</p>
</blockquote>
<ul>
<li><p>3．为常作为查询条件的字段建立索引<br>如果某个字段经常用来做查询条件，那么该字段的查询速度会影响整个表的查询速度。<br>因此，为这样的字段建立索引，可以提高整个表的查询速度。</p>
<ul>
<li>  3.1 经常查询</li>
<li>  3.2 列值的重复值少</li>
</ul>
</li>
</ul>
<p><strong>注：如果经常作为条件的列，重复值特别多，可以建立联合索引</strong></p>
<ul>
<li>4．尽量使用前缀来索引</li>
</ul>
<p>如果索引字段的值很长，最好使用值的前缀来索引。例如，TEXT和BLOG类型的字段，进行全文检索<br>会很浪费时间。如果只检索字段的前面的若干个字符，这样可以提高检索速度。</p>
<p><strong>-—————————————————————————- 我是华丽的分割线 —————————————————————————</strong></p>
<ul>
<li>5．限制索引的数目<br>索引的数目不是越多越好。每个索引都需要占用磁盘空间，索引越多，需要的磁盘空间就越大。<br>修改表时，对索引的重构和更新很麻烦。越多的索引，会使更新表变得很浪费时间。</li>
<li>6．删除不再使用或者很少使用的索引<br>表中的数据被大量更新，或者数据的使用方式被改变后，原有的一些索引可能不再需要。数据库管理<br>员应当定期找出这些索引，将它们删除，从而减少索引对更新操作的影响。</li>
</ul>
<p><strong>-————————————————————————— 是的，没错，又是我 ————————————————————————-</strong></p>
<p><strong>重点关注：</strong></p>
<ul>
<li>1.没有查询条件，或者查询条件没有建立索引</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#全表扫描</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">table</span>;</span><br><span class="line"><span class="keyword">select</span>  <span class="operator">*</span> <span class="keyword">from</span> tab <span class="keyword">where</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在业务数据库中，特别是数据量比较大的表,是没有全表扫描这种需求。<br>1）对用户查看是非常痛苦的。<br>2）对服务器来讲毁灭性的。<br>3）SQL改写成以下语句：</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#情况<span class="number">1</span></span><br><span class="line">#全表扫描</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">table</span>;</span><br><span class="line">#需要在price列上建立索引</span><br><span class="line">selec  <span class="operator">*</span> <span class="keyword">from</span> tab  <span class="keyword">order</span> <span class="keyword">by</span>  price  limit <span class="number">10</span>;</span><br><span class="line">#情况<span class="number">2</span></span><br><span class="line">#name列没有索引</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zhangsan&#x27;</span>; </span><br><span class="line"><span class="number">1</span>、换成有索引的列作为查询条件</span><br><span class="line"><span class="number">2</span>、将name列建立索引</span><br></pre></td></tr></table></figure>

<ul>
<li>2.查询结果集是原表中的大部分数据，应该是25％以上</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> population<span class="operator">&gt;</span><span class="number">3000</span> <span class="keyword">order</span> <span class="keyword">by</span> population;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>1）如果业务允许，可以使用limit控制。<br>2）结合业务判断，有没有更好的方式。如果没有更好的改写方案就尽量不要在mysql存放这个数据了，放到redis里面。</p>
</blockquote>
<ul>
<li><p>3.索引本身失效，统计数据不真实  </p>
<blockquote>
<p>索引有自我维护的能力。<br>对于表内容变化比较频繁的情况下，有可能会出现索引失效。<br>重建索引就可以解决</p>
</blockquote>
</li>
<li><p>4.查询条件使用函数在索引列上或者对索引列进行运算，运算包括(+，-，*等)</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#例子</span><br><span class="line">错误的例子：<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test <span class="keyword">where</span> id<span class="number">-1</span><span class="operator">=</span><span class="number">9</span>; </span><br><span class="line">正确的例子：<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test <span class="keyword">where</span> id<span class="operator">=</span><span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>5.隐式转换导致索引失效.这一点应当引起重视.也是开发中经常会犯的错误</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> test (id <span class="type">int</span> ,name <span class="type">varchar</span>(<span class="number">20</span>),telnum <span class="type">varchar</span>(<span class="number">10</span>));</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> test <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;zs&#x27;</span>,<span class="string">&#x27;110&#x27;</span>),(<span class="number">2</span>,<span class="string">&#x27;l4&#x27;</span>,<span class="number">120</span>),(<span class="number">3</span>,<span class="string">&#x27;w5&#x27;</span>,<span class="number">119</span>),(<span class="number">4</span>,<span class="string">&#x27;z4&#x27;</span>,<span class="number">112</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test <span class="keyword">where</span> telnum<span class="operator">=</span><span class="number">120</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> test <span class="keyword">add</span> index idx_tel(telnum);</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test <span class="keyword">where</span> telnum<span class="operator">=</span><span class="number">120</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test <span class="keyword">where</span> telnum<span class="operator">=</span><span class="number">120</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test <span class="keyword">where</span> telnum<span class="operator">=</span><span class="string">&#x27;120&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>6． &lt;&gt; ，not in 不走索引</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tab <span class="keyword">where</span> telnum <span class="operator">&lt;&gt;</span> <span class="string">&#x27;1555555&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tab <span class="keyword">where</span> telnum <span class="operator">&lt;&gt;</span> <span class="string">&#x27;1555555&#x27;</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>单独的&gt;,&lt;,in 有可能走，也有可能不走，和结果集有关，尽量结合业务添加limit<br>or或in尽量改成union</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN  <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> teltab <span class="keyword">WHERE</span> telnum <span class="keyword">IN</span> (<span class="string">&#x27;110&#x27;</span>,<span class="string">&#x27;119&#x27;</span>);</span><br><span class="line">#改写成</span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> teltab <span class="keyword">WHERE</span> telnum<span class="operator">=</span><span class="string">&#x27;110&#x27;</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> teltab <span class="keyword">WHERE</span> telnum<span class="operator">=</span><span class="string">&#x27;119&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>7．like “%_“ 百分号在最前面不走</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#走<span class="keyword">range</span>索引扫描</span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> teltab <span class="keyword">WHERE</span> telnum <span class="keyword">LIKE</span> <span class="string">&#x27;31%&#x27;</span>;</span><br><span class="line">#不走索引</span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> teltab <span class="keyword">WHERE</span> telnum <span class="keyword">LIKE</span> <span class="string">&#x27;%110&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>%linux%类的搜索需求，可以使用Elasticsearch ——-&gt; ELK</strong></p>
<ul>
<li>8.单独引用联合索引里非第一位置的索引列</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1 (id <span class="type">INT</span>,NAME <span class="type">VARCHAR</span>(<span class="number">20</span>),age <span class="type">INT</span> ,sex ENUM(<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;f&#x27;</span>),money <span class="type">INT</span>);</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> t1 <span class="keyword">ADD</span> INDEX t1_idx(money,age,sex);</span><br><span class="line"><span class="keyword">DESC</span> t1</span><br><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> t1</span><br><span class="line">#走索引的情况测试</span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> NAME,age,sex,money <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> money<span class="operator">=</span><span class="number">30</span> <span class="keyword">AND</span> age<span class="operator">=</span><span class="number">30</span>  <span class="keyword">AND</span> sex<span class="operator">=</span><span class="string">&#x27;m&#x27;</span>;</span><br><span class="line">#部分走索引</span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> NAME,age,sex,money <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> money<span class="operator">=</span><span class="number">30</span> <span class="keyword">AND</span> age<span class="operator">=</span><span class="number">30</span>;</span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> NAME,age,sex,money <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> money<span class="operator">=</span><span class="number">30</span>  <span class="keyword">AND</span> sex<span class="operator">=</span><span class="string">&#x27;m&#x27;</span>; </span><br><span class="line">#不走索引</span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span>  NAME,age,sex,money <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> age<span class="operator">=</span><span class="number">20</span></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> NAME,age,sex,money <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> age<span class="operator">=</span><span class="number">30</span> <span class="keyword">AND</span> sex<span class="operator">=</span><span class="string">&#x27;m&#x27;</span>;</span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> NAME,age,sex,money <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> sex<span class="operator">=</span><span class="string">&#x27;m&#x27;</span>;</span><br></pre></td></tr></table></figure>


<hr>
<h2 id="title-第七章·-MySQL的存储引擎url-https-blog-driverzeng-com-zenglaoshi-689-htmlclipped-at-2022-05-19-21-53-32category-defaulttags-无"><a href="#title-第七章·-MySQL的存储引擎url-https-blog-driverzeng-com-zenglaoshi-689-htmlclipped-at-2022-05-19-21-53-32category-defaulttags-无" class="headerlink" title="title: 第七章· MySQL的存储引擎url: https://blog.driverzeng.com/zenglaoshi/689.htmlclipped_at: 2022-05-19 21:53:32category: defaulttags: - 无"></a>title: 第七章· MySQL的存储引擎<br>url: <a target="_blank" rel="noopener" href="https://blog.driverzeng.com/zenglaoshi/689.html">https://blog.driverzeng.com/zenglaoshi/689.html</a><br>clipped_at: 2022-05-19 21:53:32<br>category: default<br>tags:<br> - 无</h2><h1 id="第七章·-MySQL的存储引擎"><a href="#第七章·-MySQL的存储引擎" class="headerlink" title="第七章· MySQL的存储引擎"></a>第七章· MySQL的存储引擎</h1><ul>
<li><a href="#toc_0">一.存储引擎简介</a></li>
<li><a href="#toc_1">二.MySQL自带的存储引擎类型</a></li>
<li><a href="#toc_2">三.真实企业案例</a></li>
<li><a href="#toc_3">四.Innodb存储引擎——表空间介绍</a></li>
<li><a href="#toc_4">五.Innodb核心特性——事务</a></li>
</ul>
<blockquote>
<p>曾志高翔, 江湖人称曾老大。多年互联网运维工作经验，曾负责过大规模集群架构自动化运维管理工作。擅长Web集群架构与自动化运维，曾负责国内某大型金融公司运维工作。<br>个人博客:”DBA老司机带你删库跑路”<br>笔者QQ:133411023、253097001<br>笔者交流群：198571640<br>笔者微信：z133411023</p>
</blockquote>
<h2 id="一-存储引擎简介"><a href="#一-存储引擎简介" class="headerlink" title="一.存储引擎简介"></a>一.存储引擎简介</h2><p><img src="/assets/1652968412-dc37116b8d093e2d07debcbed1322a88.jpg">￼</p>
<ul>
<li>1、文件系统：<ul>
<li>1.1 操作系统组织和存取数据的一种机制。</li>
<li>1.2 文件系统是一种软件。</li>
</ul>
</li>
<li>2、文件系统类型：ext2 3 4 ，xfs 数据<ul>
<li>2.1 不管使用什么文件系统，数据内容不会变化</li>
<li>2.2 不同的是，存储空间、大小、速度。</li>
</ul>
</li>
<li>3、MySQL引擎：<ul>
<li>3.1 可以理解为，MySQL的“文件系统”，只不过功能更加强大。</li>
</ul>
</li>
<li>4、MySQL引擎功能：<ul>
<li>4.1 除了可以提供基本的存取功能，还有更多功能事务功能、锁定、备份和恢复、优化以及特殊功能</li>
</ul>
</li>
</ul>
<p><strong>总之，存储引擎的各项特性就是为了保障数据库的安全和性能设计结构。</strong></p>
<h2 id="二-MySQL自带的存储引擎类型"><a href="#二-MySQL自带的存储引擎类型" class="headerlink" title="二.MySQL自带的存储引擎类型"></a>二.MySQL自带的存储引擎类型</h2><blockquote>
<p><strong>MySQL 提供以下存储引擎:</strong><br><strong>01）InnoDB<br>02）MyISAM</strong><br>03）MEMORY<br>04）ARCHIVE<br>05）FEDERATED<br>06）EXAMPLE<br>07）BLACKHOLE<br>08）MERGE<br>09）NDBCLUSTER<br>10）CSV</p>
</blockquote>
<hr>
<blockquote>
<p><strong>还可以使用第三方存储引擎:</strong><br>01）MySQL当中插件式的存储引擎类型<br>02）MySQL的两个分支<br>03）perconaDB<br>04）mariaDB</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#查看当前MySQL支持的存储引擎类型  </span><br><span class="line">mysql&gt; show engines  </span><br><span class="line">#查看innodb的表有哪些  </span><br><span class="line">mysql&gt; select table_schema,table_name,engine from information_schema.tables where engine=&#x27;innodb&#x27;;  </span><br><span class="line">#查看myisam的表有哪些  </span><br><span class="line">mysql&gt; select table_schema,table_name,engine from information_schema.tables where engine=&#x27;myisam&#x27;;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>1、innodb和myisam的区别</strong></li>
</ul>
<p><em>物理上的区别：</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#进入mysql目录  </span><br><span class="line">[root<span class="variable">@db01</span><span class="operator">~</span>l]# cd <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>mysql  </span><br><span class="line">#查看所有<span class="keyword">user</span>的文件  </span><br><span class="line">[root<span class="variable">@db01</span> mysql]# ll user.<span class="operator">*</span>  </span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">---- 1 mysql mysql 10684 Mar 6 2017 user.frm  </span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">---- 1 mysql mysql 960 Aug 14 01:15 user.MYD  </span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">---- 1 mysql mysql 2048 Aug 14 01:15 user.MYI  </span></span><br><span class="line">#进入word目录  </span><br><span class="line">[root<span class="variable">@db01</span> world]# cd <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>world<span class="operator">/</span>  </span><br><span class="line">#查看所有city的文件  </span><br><span class="line">[root<span class="variable">@db01</span> world]# ll city.<span class="operator">*</span>  </span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">---- 1 mysql mysql 8710 Aug 14 16:23 city.frm  </span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">---- 1 mysql mysql 688128 Aug 14 16:23 city.ibd</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>2.innodb存储引擎的简介</strong></li>
</ul>
<p><strong>在MySQL5.5版本之后，默认的存储引擎，提供高可靠性和高性能。</strong></p>
<blockquote>
<p>优点:<br>01）事务安全（遵从 ACID）<br>02）MVCC（Multi-Versioning Concurrency Control，多版本并发控制）<br>03）InnoDB 行级别锁定<br>04）Oracle 样式一致非锁定读取<br>05）表数据进行整理来优化基于主键的查询<br>06）支持外键引用完整性约束<br>07）大型数据卷上的最大性能<br>08）将对表的查询与不同存储引擎混合<br>09）出现故障后快速自动恢复<br>10）用于在内存中缓存数据和索引的缓冲区池</p>
</blockquote>
<p><img src="/assets/1652968412-61ccafb603b9913d22c6fcbf1249fccf.jpg">￼</p>
<p><strong>innodb核心特性</strong></p>
<blockquote>
<p>重点:<br>MVCC<br>事务<br>行级锁<br>热备份<br>Crash Safe Recovery（自动故障恢复）</p>
</blockquote>
<ul>
<li><strong>3.查看存储引擎</strong></li>
</ul>
<p>1）使用 SELECT 确认会话存储引擎</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#查询默认存储引擎  </span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@default</span>_storage_engine;</span><br></pre></td></tr></table></figure>

<p>2）使用 SHOW 确认每个表的存储引擎</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#查看表的存储引擎  </span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> City\G  </span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">TABLE</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;CountryLanguage&#x27;</span>\G</span><br></pre></td></tr></table></figure>

<p>3）使用 INFORMATION_SCHEMA 确认每个表的存储引擎</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#查看表的存储引擎  </span><br><span class="line"><span class="keyword">SELECT</span> TABLE_NAME, ENGINE <span class="keyword">FROM</span> INFORMATION_SCHEMA.TABLES <span class="keyword">WHERE</span> TABLE_NAME <span class="operator">=</span> <span class="string">&#x27;City&#x27;</span> <span class="keyword">AND</span> TABLE_SCHEMA <span class="operator">=</span> <span class="string">&#x27;world&#x27;</span>\G</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>4.存储引擎的设置</strong></li>
</ul>
<p>1）在启动配置文件中设置服务器存储引擎</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#在配置文件的[mysqld]标签下添加  </span><br><span class="line">[mysqld]  </span><br><span class="line"><span class="keyword">default</span><span class="operator">-</span>storage<span class="operator">-</span>engine<span class="operator">=</span></span><br></pre></td></tr></table></figure>

<p>2）使用 SET 命令为当前客户机会话设置</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#在MySQL命令行中临时设置  </span><br><span class="line"><span class="keyword">SET</span> @<span class="variable">@storage</span>_engine<span class="operator">=</span></span><br></pre></td></tr></table></figure>

<p>（3）在 CREATE TABLE 语句指定</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#建表的时候指定存储引擎  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t (i <span class="type">INT</span>) ENGINE <span class="operator">=</span> ;</span><br></pre></td></tr></table></figure>

<p><img src="/assets/1652968412-8a6cffff078686890190a72e7938eece.jpg">￼</p>
<h2 id="三-真实企业案例"><a href="#三-真实企业案例" class="headerlink" title="三.真实企业案例"></a>三.真实企业案例</h2><p><strong>项目背景：</strong></p>
<p>公司原有的架构：一个展示型的网站，LAMT，MySQL5.1.77版本（MYISAM），50M数据量。</p>
<p><strong>小问题不断：</strong></p>
<ul>
<li>1、表级锁：对表中任意一行数据修改类操作时，整个表都会锁定，对其他行的操作都不能同时进行。</li>
<li>2、不支持故障自动恢复（CSR）：当断电时有可能会出现数据损坏或丢失的问题。</li>
</ul>
<p><strong>如何解决：</strong></p>
<ul>
<li>1、提建议将现有的MYISAM引擎替换为Innodb，将版本替换为5.6.38<ul>
<li>1）如果使用MYISAM会产生”小问题”，性能安全不能得到保证，使用innodb可以解决这个问题。</li>
<li>2）5.1.77版本对于innodb引擎支持不够完善，5.6.38版本对innodb支持非常完善了。</li>
</ul>
</li>
<li>2、实施过程和注意要素</li>
</ul>
<p>1）备份生产库数据（mysqldump）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p123 <span class="operator">-</span>A <span class="comment">--triggers -R --master-data=2 &gt;/tmp/full.sql</span></span><br></pre></td></tr></table></figure>

<p>2）准备一个5.6.38版本的新数据库<br>3）对备份数据进行处理（将engine字段替换）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# sed <span class="operator">-</span>i <span class="string">&#x27;s#ENGINE=MYISAM#ENGINE=INNODB#g&#x27;</span> <span class="operator">/</span>tmp<span class="operator">/</span>full.sql</span><br></pre></td></tr></table></figure>

<p>4）将修改后的备份恢复到新库<br>5）应用测试环境连接新库，测试所有功能<br>6）停应用，将备份之后的生产库发生的新变化，补偿到新库<br>7）应用割接到新数据库</p>
<p><strong>项目结果：</strong></p>
<p>*解决了”小问题” *</p>
<h2 id="四-Innodb存储引擎——表空间介绍"><a href="#四-Innodb存储引擎——表空间介绍" class="headerlink" title="四.Innodb存储引擎——表空间介绍"></a>四.Innodb存储引擎——表空间介绍</h2><p><img src="/assets/1652968412-f0478dc24dd9b0b24703c5e329b20fef.jpg">￼</p>
<p><strong>5.5版本以后出现共享表空间概念</strong></p>
<p>表空间的管理模式的出现是为了数据库的存储更容易扩展</p>
<p><strong>5.6版本中默认的是独立表空间</strong></p>
<ul>
<li><strong>1、共享表空间</strong></li>
</ul>
<p>1）查看共享表空间</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#物理查看  </span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# ll <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>  </span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">---- 1 mysql mysql 79691776 Aug 14 16:23 ibdata1  </span></span><br><span class="line">#命令行查看  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%path%&#x27;</span>;  </span><br><span class="line">innodb_data_file_path <span class="operator">=</span>bdata1:<span class="number">12</span>M:autoextend</span><br></pre></td></tr></table></figure>

<blockquote>
<p>5.6版本中默认存储:<br>1.系统数据<br>2.undo<br>3.临时表</p>
</blockquote>
<p><strong>5.7版本中默认会将undo和临时表独立出来，5.6版本也可以独立，只不过需要在初始化的时候进行配置</strong></p>
<p>2）设置方法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#编辑配置文件  </span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf  </span><br><span class="line">[mysqld]  </span><br><span class="line">innodb_data_file_path<span class="operator">=</span>ibdata1:<span class="number">50</span>M;ibdata2:<span class="number">50</span>M:autoextend</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>2、独立表空间</strong></li>
</ul>
<p>对于用户自主创建的表，会采用此种模式，每个表由一个独立的表空间进行管理</p>
<p>1）查看独立表空间</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#物理查看  </span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# ll <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>world<span class="operator">/</span>  </span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">---- 1 mysql mysql 688128 Aug 14 16:23 city.ibd  </span></span><br><span class="line">#命令行查看  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%per_table%&#x27;</span>;  </span><br><span class="line">innodb_file_per_table<span class="operator">=</span><span class="keyword">ON</span></span><br></pre></td></tr></table></figure>

<hr>
<p><strong>企业案例</strong></p>
<p>在没有备份数据的情况下，突然断电导致表损坏，打不开数据库。</p>
<p>1）拷贝库目录到新库中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# cp -r /application/mysql/data/world/ /data/3307/data/</span><br></pre></td></tr></table></figure>

<p>2）启动新数据库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# mysqld_safe --defaults-file=/data/3307/my.cnf &amp;</span><br></pre></td></tr></table></figure>

<p>3）登陆数据库查看</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br></pre></td></tr></table></figure>

<p>4）查询表中数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city;  </span><br><span class="line">ERROR <span class="number">1146</span> (<span class="number">42</span>S02): <span class="keyword">Table</span> <span class="string">&#x27;world.city&#x27;</span> doesn<span class="string">&#x27;t exist</span></span><br></pre></td></tr></table></figure>

<p>5）找到以前的表结构在新库中创建表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> world.city;  </span><br><span class="line">#删掉外键创建语句  </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `city` (  </span><br><span class="line">`ID` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,  </span><br><span class="line">`Name` <span class="type">char</span>(<span class="number">35</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,  </span><br><span class="line">`CountryCode` <span class="type">char</span>(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,  </span><br><span class="line">`District` <span class="type">char</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,  </span><br><span class="line">`Population` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,  </span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`ID`),  </span><br><span class="line">KEY `CountryCode` (`CountryCode`),  </span><br><span class="line">KEY `idx_city` (`Population`,`CountryCode`),  </span><br><span class="line"><span class="keyword">CONSTRAINT</span> `city_ibfk_1` <span class="keyword">FOREIGN</span> KEY (`CountryCode`) <span class="keyword">REFERENCES</span> `country` (`Code`)  </span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4080</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>latin1;</span><br></pre></td></tr></table></figure>

<p>6）删除表空间文件</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> city_new discard tablespaces;</span><br></pre></td></tr></table></figure>

<p>7）拷贝旧表空间文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 world]# cp /data/3307/data/world/city.ibd /data/3307/data/world/city_new.ibd</span><br></pre></td></tr></table></figure>

<p>8）授权</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 world]# chown -R mysql.mysql *</span><br></pre></td></tr></table></figure>

<p>9）导入表空间</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> city_new import tablespace;</span><br></pre></td></tr></table></figure>

<h2 id="五-Innodb核心特性——事务"><a href="#五-Innodb核心特性——事务" class="headerlink" title="五.Innodb核心特性——事务"></a>五.Innodb核心特性——事务</h2><ul>
<li><strong>1.什么是事务</strong></li>
</ul>
<p><em>主要针对DML语句（update，delete，insert）</em></p>
<blockquote>
<p>一组数据操作执行步骤，这些步骤被视为一个工作单元:<br>1）用于对多个语句进行分组<br>2）可以在多个客户机并发访问同一个表中的数据时使用</p>
</blockquote>
<hr>
<blockquote>
<p>所有步骤都成功或都失败<br>1）如果所有步骤正常，则执行<br>2）如果步骤出现错误或不完整，则取消</p>
</blockquote>
<ul>
<li><strong>2.事务的通俗理解</strong></li>
</ul>
<p><em>伴随着“交易”出现的数据库概念。</em></p>
<blockquote>
<p>我们理解的“交易”是什么？<br>1）物与物的交换（古代）<br>2）货币现金与实物的交换（现代1）<br>3）虚拟货币与实物的交换（现代2）<br>4）虚拟货币与虚拟实物交换（现代3）</p>
</blockquote>
<hr>
<blockquote>
<p>数据库中的“交易”是什么？<br>1）事务又是如何保证“交易”的“和谐”？<br>2）ACID</p>
</blockquote>
<ul>
<li><strong>3.事务ACID特性</strong></li>
</ul>
<hr>
<p>Atomic（原子性）<br>所有语句作为一个单元全部成功执行或全部取消。</p>
<p>Consistent（一致性）<br>如果数据库在事务开始时处于一致状态，则在执行该。 事务期间将保留一致状态。</p>
<p>Isolated（隔离性）<br>事务之间不相互影响。</p>
<p>Durable（持久性）<br>事务成功完成后，所做的所有更改都会准确地记录在 数据库中。所做的更改不会丢失。</p>
<hr>
<ul>
<li><strong>4.事务流程举例</strong><br><img src="/assets/1652968412-fbb57bf3ec19b669f7e0aa0c71342f38.jpg">￼</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database jiaoyi;</span><br><span class="line">mysql<span class="operator">&gt;</span> use jiaoyi;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> py(id <span class="type">int</span>,name <span class="type">varchar</span>(<span class="number">10</span>),money <span class="type">int</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> py <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;shenlei&#x27;</span>,<span class="number">2000</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> py <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">&#x27;bgx&#x27;</span>,<span class="number">3000</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> py;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> name    <span class="operator">|</span> money <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> shenlei <span class="operator">|</span>  <span class="number">2000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> bgx     <span class="operator">|</span>  <span class="number">3000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"></span><br><span class="line">#开启一个事务</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> py <span class="keyword">set</span> money<span class="operator">=</span><span class="number">1000</span> <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;shenlei&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> py;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> name    <span class="operator">|</span> money <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> shenlei <span class="operator">|</span>  <span class="number">1000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> bgx     <span class="operator">|</span>  <span class="number">3000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> py <span class="keyword">set</span> money<span class="operator">=</span><span class="number">-1000</span> <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;shenlei&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> py;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> name    <span class="operator">|</span> money <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> shenlei <span class="operator">|</span> <span class="number">-1000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> bgx     <span class="operator">|</span>  <span class="number">3000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line">#回滚</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">rollback</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> py;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> name    <span class="operator">|</span> money <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> shenlei <span class="operator">|</span>  <span class="number">2000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> bgx     <span class="operator">|</span>  <span class="number">3000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#开启事务</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> py <span class="keyword">set</span> money<span class="operator">=</span><span class="number">1000</span> <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;shenlei&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> py;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> name    <span class="operator">|</span> money <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> shenlei <span class="operator">|</span>  <span class="number">1000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> bgx     <span class="operator">|</span>  <span class="number">3000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> py <span class="keyword">set</span> money<span class="operator">=</span><span class="number">4000</span> <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;bgx&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> py;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> name    <span class="operator">|</span> money <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> shenlei <span class="operator">|</span>  <span class="number">1000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> bgx     <span class="operator">|</span>  <span class="number">4000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> \q</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> use jiaoyi;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> py;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> name    <span class="operator">|</span> money <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> shenlei <span class="operator">|</span>  <span class="number">2000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> bgx     <span class="operator">|</span>  <span class="number">3000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> py <span class="keyword">set</span> money<span class="operator">=</span><span class="number">1000</span> <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;shenlei&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> py <span class="keyword">set</span> money<span class="operator">=</span><span class="number">4000</span> <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;bgx&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> py;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> name    <span class="operator">|</span> money <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> shenlei <span class="operator">|</span>  <span class="number">1000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> bgx     <span class="operator">|</span>  <span class="number">4000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line">#提交事务</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> py;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> name    <span class="operator">|</span> money <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> shenlei <span class="operator">|</span>  <span class="number">1000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> bgx     <span class="operator">|</span>  <span class="number">4000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> \q</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@master</span> world]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> use jiaoyi;</span><br><span class="line">#<span class="keyword">commit</span>提交事务后没有退出mysql没有回滚</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> py;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> name    <span class="operator">|</span> money <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> shenlei <span class="operator">|</span>  <span class="number">1000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> bgx     <span class="operator">|</span>  <span class="number">4000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#执行DML是自动开启一个事务的</span><br><span class="line">#查看自动提交是开启的（实际生产中不需要关闭）</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;autocommit&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> autocommit    <span class="operator">|</span> <span class="keyword">ON</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line">#关闭事务的自动提交</span><br><span class="line">[root<span class="variable">@master</span> world]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">autocommit<span class="operator">=</span><span class="number">0</span>  #添加</span><br><span class="line">[root<span class="variable">@master</span> world]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld restart</span><br><span class="line">[root<span class="variable">@master</span> world]# mysql</span><br><span class="line">#查看自动提交是关闭的</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;autocommit&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> autocommit    <span class="operator">|</span> OFF   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> py <span class="keyword">set</span> money<span class="operator">=</span><span class="number">1000</span> <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;bgx&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> py <span class="keyword">set</span> money <span class="operator">=</span><span class="number">4000</span> <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;shenlei&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> py;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> name    <span class="operator">|</span> money <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> shenlei <span class="operator">|</span>  <span class="number">4000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> bgx     <span class="operator">|</span>  <span class="number">1000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> py;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> name    <span class="operator">|</span> money <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> shenlei <span class="operator">|</span>  <span class="number">4000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> bgx     <span class="operator">|</span>  <span class="number">1000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+---------+-------+</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>5.事务的控制语句</strong></li>
</ul>
<blockquote>
<p>如下:<br>START TRANSACTION（或 BEGIN）：显式开始一个新事务<br>SAVEPOINT：分配事务过程中的一个位置，以供将来引用<br>COMMIT：永久记录当前事务所做的更改<br>ROLLBACK：取消当前事务所做的更改<br>ROLLBACK TO SAVEPOINT：取消在 savepoint 之后执行的更改<br>RELEASE SAVEPOINT：删除 savepoint 标识符<br>SET AUTOCOMMIT：为当前连接禁用或启用默认 autocommit 模式</p>
</blockquote>
<p><strong>一个成功事务的生命周期</strong><br>begin;<br>sql1<br>sql2<br>sql3<br>…<br>commit;</p>
<p><strong>一个失败事务的生命周期</strong><br>begin;<br>sql1<br>sql2<br>sql3<br>…<br>rollback;</p>
<ul>
<li><strong>3.自动提交</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#查看自动提交  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;autocommit&#x27;</span>;  </span><br><span class="line">#临时关闭  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> autocommit<span class="operator">=</span><span class="number">0</span>;  </span><br><span class="line">#永久关闭  </span><br><span class="line">[root<span class="variable">@db01</span> world]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf  </span><br><span class="line">[mysqld]  </span><br><span class="line">autocommit<span class="operator">=</span><span class="number">0</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>4.事务演示</strong></li>
</ul>
<p>1）成功事务</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> stu(id <span class="type">int</span>,name <span class="type">varchar</span>(<span class="number">10</span>),sex enum(<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;m&#x27;</span>),money <span class="type">int</span>);  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> stu(id,name,sex,money) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;zhang3&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="number">100</span>), (<span class="number">2</span>,<span class="string">&#x27;zhang4&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="number">110</span>);  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure>

<p>2）事务回滚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> stu <span class="keyword">set</span> name<span class="operator">=</span><span class="string">&#x27;zhang3&#x27;</span>;  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> stu;  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">rollback</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>6.事务隐式提交情况</strong></li>
</ul>
<p>1）现在版本在开启事务时，不需要手工begin，只要你输入的是DML语句，就会自动开启事务。<br>2）有些情况下事务会被隐式提交</p>
<blockquote>
<p>例如:<br>在事务运行期间，手工执行begin的时候会自动提交上个事务<br>在事务运行期间，加入DDL、DCL操作会自动提交上个事务<br>在事务运行期间，执行锁定语句（lock tables、unlock tables）<br>load data infile<br>select for update<br>在autocommit&#x3D;1的时候</p>
</blockquote>
<ul>
<li><strong>7.事务日志redo基本功能</strong></li>
</ul>
<p><strong>1）Redo是什么？</strong></p>
<p>redo,顾名思义“重做日志”，是事务日志的一种。</p>
<p><strong>2）作用是什么？</strong></p>
<p>在事务ACID过程中，实现的是“D”持久化的作用。<br><img src="/assets/1652968412-42d50b8e93ba4361858ebe54ad41c786.jpg">￼</p>
<p><strong>特性:WAL(Write Ahead Log)日志优先写</strong><br><strong>REDO：记录的是，内存数据页的变化过程</strong></p>
<p><strong>3）REDO工作过程</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#执行步骤  </span><br><span class="line"><span class="keyword">update</span> t1 <span class="keyword">set</span> num<span class="operator">=</span><span class="number">2</span> <span class="keyword">where</span> num<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>1）首先将t1表中num&#x3D;1的行所在数据页加载到内存中buffer page<br>2）MySQL实例在内存中将num&#x3D;1的数据页改成num&#x3D;2<br>3）num&#x3D;1变成num&#x3D;2的变化过程会记录到，redo内存区域，也就是redo buffer page中</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#提交事务执行步骤</span><br><span class="line"><span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure>

<p>1）当敲下commit命令的瞬间，MySQL会将redo buffer page写入磁盘区域redo log<br>2）当写入成功之后，commit返回ok</p>
<ul>
<li><strong>8.redo数据实例恢复过程</strong></li>
</ul>
<p>图解</p>
<ul>
<li><strong>9.事务日志undo</strong></li>
</ul>
<p><strong>1）undo是什么？</strong></p>
<p>undo,顾名思义“回滚日志”，是事务日志的一种。</p>
<p>_<strong>2）作用是什么？</strong></p>
<p>在事务ACID过程中，实现的是“A”原子性的作用。当然CI的特性也和undo有关</p>
<p><img src="/assets/1652968412-93f1237b3e261faeb10d537e3d2c39a4.jpg">￼</p>
<ul>
<li><strong>10.redo和undo的存储位置</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">redo位置</span>  </span><br><span class="line">[root@db01 data]# ll /application/mysql/data/  </span><br><span class="line">-rw-rw---- 1 mysql mysql 50331648 Aug 15 06:34 ib_logfile0  </span><br><span class="line">-rw-rw---- 1 mysql mysql 50331648 Mar 6 2017 ib_logfile1  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">undo位置</span>  </span><br><span class="line">[root@db01 data]# ll /application/mysql/data/  </span><br><span class="line">-rw-rw---- 1 mysql mysql 79691776 Aug 15 06:34 ibdata1  </span><br><span class="line">-rw-rw---- 1 mysql mysql 79691776 Aug 15 06:34 ibdata2</span><br></pre></td></tr></table></figure>

<p><strong>在MySQL5.6版本中undo是在ibdata文件中，在MySQL5.7版本会独立出来。</strong></p>
<ul>
<li><strong>11.事务中的锁</strong></li>
</ul>
<p><strong>1）什么是“锁”？</strong></p>
<p>“锁”顾名思义就是锁定的意思。</p>
<p><strong>2）“锁”的作用是什么？</strong></p>
<p>在事务ACID特性过程中，“锁”和“隔离级别”一起来实现“I”隔离性的作用。</p>
<p><img src="/assets/1652968412-8c1a5d26498501a0d7db98ce48be52a8.jpg">￼</p>
<p>排他锁：保证在多事务操作时，数据的一致性。<br>共享锁：保证在多事务工作期间，数据查询时不会被阻塞。</p>
<ul>
<li><strong>12.多版本并发控制（MVCC）</strong></li>
</ul>
<p>1）只阻塞修改类操作，不阻塞查询类操作<br>2）乐观锁的机制（谁先提交谁为准）</p>
<ul>
<li><strong>13.锁的粒度</strong><br>MyIsam：低并发锁（表级锁）<br>Innodb：高并发锁（行级锁）</li>
<li><strong>14.事务的隔离级别</strong></li>
</ul>
<p><em>四种隔离级别：</em></p>
<p>READ UNCOMMITTED（独立提交）<br>允许事务查看其他事务所进行的未提交更改</p>
<p>READ COMMITTED<br>允许事务查看其他事务所进行的已提交更改</p>
<p>REPEATABLE READ******<br>确保每个事务的 SELECT 输出一致<br>InnoDB 的默认级别</p>
<p>SERIALIZABLE<br>将一个事务的结果与其他事务完全隔离</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#查看隔离级别  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%iso%&#x27;</span>;  </span><br><span class="line">#修改隔离级别为RU  </span><br><span class="line">[mysqld]  </span><br><span class="line">transaction_isolation<span class="operator">=</span>read<span class="operator">-</span>uncommit  </span><br><span class="line">mysql<span class="operator">&gt;</span> use oldboy  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu;  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> stu(id,name,sex,money) <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">&#x27;li4&#x27;</span>,<span class="string">&#x27;f&#x27;</span>,<span class="number">123</span>);  </span><br><span class="line">#修改隔离级别为RC  </span><br><span class="line">[mysqld]  </span><br><span class="line">transaction_isolation<span class="operator">=</span>read<span class="operator">-</span><span class="keyword">commit</span></span><br></pre></td></tr></table></figure>


<hr>
<h2 id="title-第八章·-MySQL日志管理url-https-blog-driverzeng-com-zenglaoshi-695-htmlclipped-at-2022-05-19-21-52-38category-defaulttags-无"><a href="#title-第八章·-MySQL日志管理url-https-blog-driverzeng-com-zenglaoshi-695-htmlclipped-at-2022-05-19-21-52-38category-defaulttags-无" class="headerlink" title="title: 第八章· MySQL日志管理url: https://blog.driverzeng.com/zenglaoshi/695.htmlclipped_at: 2022-05-19 21:52:38category: defaulttags: - 无"></a>title: 第八章· MySQL日志管理<br>url: <a target="_blank" rel="noopener" href="https://blog.driverzeng.com/zenglaoshi/695.html">https://blog.driverzeng.com/zenglaoshi/695.html</a><br>clipped_at: 2022-05-19 21:52:38<br>category: default<br>tags:<br> - 无</h2><h1 id="第八章·-MySQL日志管理"><a href="#第八章·-MySQL日志管理" class="headerlink" title="第八章· MySQL日志管理"></a>第八章· MySQL日志管理</h1><ul>
<li><a href="#toc_0">一.MySQL日志简介</a></li>
<li><a href="#toc_1">二.错误日志</a></li>
<li><a href="#toc_2">三.一般查询日志</a></li>
<li><a href="#toc_3">四.二进制日志</a></li>
<li><a href="#toc_4">五.慢查询日志</a></li>
</ul>
<blockquote>
<p>曾志高翔, 江湖人称曾老大。多年互联网运维工作经验，曾负责过大规模集群架构自动化运维管理工作。擅长Web集群架构与自动化运维，曾负责国内某大型金融公司运维工作。<br>个人博客:”DBA老司机带你删库跑路”<br>笔者QQ:133411023、253097001<br>笔者交流群：198571640<br>笔者微信：z133411023</p>
</blockquote>
<h2 id="一-MySQL日志简介"><a href="#一-MySQL日志简介" class="headerlink" title="一.MySQL日志简介"></a>一.MySQL日志简介</h2><p><img src="/assets/1652968358-b265171f6d7096776e2f0eef9b7d12b1.jpg">￼</p>
<h2 id="二-错误日志"><a href="#二-错误日志" class="headerlink" title="二.错误日志"></a>二.错误日志</h2><p><em>作用：</em><br>记录mysql数据库的一般状态信息及报错信息，是我们对于数据库常规报错处理的常用日志。</p>
<p><em>默认位置：</em><br>$MYSQL_HOME&#x2F;data&#x2F;</p>
<p>_开启方式:_（MySQL安装完后默认开启)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#编辑配置文件  </span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf  </span><br><span class="line">[mysqld]  </span><br><span class="line">log_error<span class="operator">=</span><span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>$hostname.err  </span><br><span class="line">#查看方式  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;log_error&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="三-一般查询日志"><a href="#三-一般查询日志" class="headerlink" title="三.一般查询日志"></a>三.一般查询日志</h2><p><em>作用：</em><br>记录mysql所有执行成功的SQL语句信息，可以做审计用，但是我们很少开启。</p>
<p><em>默认位置：</em><br>$MYSQL_HOME&#x2F;data&#x2F;</p>
<p>_开启方式:_（MySQL安装完之后默认不开启）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#编辑配置文件  </span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf  </span><br><span class="line">[mysqld]  </span><br><span class="line">general_log<span class="operator">=</span><span class="keyword">on</span>  </span><br><span class="line">general_log_file<span class="operator">=</span><span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>$hostnamel.log  </span><br><span class="line">#查看方式  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%gen%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="四-二进制日志"><a href="#四-二进制日志" class="headerlink" title="四.二进制日志"></a>四.二进制日志</h2><p><img src="/assets/1652968358-df8370fb4eb525823f2c36fd97e2562c.jpg">￼</p>
<p><em>作用：</em><br>记录已提交的DML事务语句，并拆分为多个事件（event）来进行记录<br>记录所有DDL、DCL等语句<br>总之，二进制日志会记录所有对数据库发生修改的操作</p>
<p><em>二进制日志模式:</em><br>statement：语句模式，上图中将update语句进行记录（默认模式）。<br>row：行模式，即数据行的变化过程，上图中Age&#x3D;19修改成Age&#x3D;20的过程事件。<br>mixed：以上两者的混合模式。<br>企业推荐使用row模式</p>
<p><strong><em>优缺点:</em></strong></p>
<p><strong>statement模式：</strong></p>
<p>优点：简单明了，容易被看懂，就是sql语句，记录时不需要太多的磁盘空间。<br>缺点：记录不够严谨。</p>
<p><strong>row模式：</strong></p>
<p>优点：记录更加严谨。<br>缺点：有可能会需要更多的磁盘空间，不太容易被读懂。</p>
<blockquote>
<p>binlog的作用:<br>1）如果我拥有数据库搭建开始所有的二进制日志，那么我可以把数据恢复到任意时刻<br>2）数据的备份恢复<br>3）数据的复制</p>
</blockquote>
<p><strong>二进制日志的管理操作实战</strong></p>
<p><strong>开启方式</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db01</span> data]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf  </span><br><span class="line">[mysqld]  </span><br><span class="line">log<span class="operator">-</span>bin<span class="operator">=</span>mysql<span class="operator">-</span>bin  </span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span></span><br></pre></td></tr></table></figure>

<p><strong>注意:在mysql5.7中开启binlog必须要加上server-id。</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db01</span> data]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf  </span><br><span class="line">[mysqld]  </span><br><span class="line">log<span class="operator">-</span>bin<span class="operator">=</span>mysql<span class="operator">-</span>bin  </span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span>  </span><br><span class="line">server_id<span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><strong>二进制日志的操作</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#物理查看  </span><br><span class="line">[root<span class="variable">@db01</span> data]# ll <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>  </span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">---- 1 mysql mysql 285 Mar 6 2017 mysql-bin.000001  </span></span><br><span class="line">#命令行查看  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="type">binary</span> logs;  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;  </span><br><span class="line">#查看binlog事件  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000007&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>事件介绍</strong></p>
<p>1）在binlog中最小的记录单元为event<br>2）一个事务会被拆分成多个事件（event）</p>
<p><strong>事件（event）特性</strong></p>
<p>1）每个event都有一个开始位置（start position）和结束位置（stop position）。<br>2）所谓的位置就是event对整个二进制的文件的相对位置。<br>3）对于一个二进制日志中，前120个position是文件格式信息预留空间。<br>4）MySQL第一个记录的事件，都是从120开始的。</p>
<p><strong>row模式下二进制日志分析及数据恢复</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#查看binlog信息  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;  </span><br><span class="line">#创建一个binlog库  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database binlog;  </span><br><span class="line">#使用binlog库  </span><br><span class="line">mysql<span class="operator">&gt;</span> use binlog  </span><br><span class="line">#创建binglog_table表  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> binlog_table(id <span class="type">int</span>);  </span><br><span class="line">#查看binlog信息  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;  </span><br><span class="line">#插入数据<span class="number">1</span>  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> binlog_table <span class="keyword">values</span>(<span class="number">1</span>);  </span><br><span class="line">#查看binlog信息  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;  </span><br><span class="line">#提交  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;  </span><br><span class="line">#查看binlog信息  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;  </span><br><span class="line">#插入数据<span class="number">2</span>  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> binlog_table <span class="keyword">values</span>(<span class="number">2</span>);  </span><br><span class="line">#插入数据<span class="number">3</span>  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> binlog_table <span class="keyword">values</span>(<span class="number">3</span>);  </span><br><span class="line">#查看binlog信息  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;  </span><br><span class="line">#提交  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;  </span><br><span class="line">#删除数据<span class="number">1</span>  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> binlog_table <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;  </span><br><span class="line">#查看binlog信息  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;  </span><br><span class="line">#提交  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;  </span><br><span class="line">#更改数据<span class="number">2</span>为<span class="number">22</span>  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> binlog_table <span class="keyword">set</span> id<span class="operator">=</span><span class="number">22</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">2</span>;  </span><br><span class="line">#查看binlog  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;  </span><br><span class="line">#提交  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;  </span><br><span class="line">#查看binlog信息  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;  </span><br><span class="line">#查看数据  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> binlog_table;  </span><br><span class="line">#删表  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">table</span> binlog_table;  </span><br><span class="line">#删库  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database binlog;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>工作中做完以上操作，接下来，该怎么做呢？给大家推荐一个网站，专业解决删库问题:</strong></p>
<p><a target="_blank" rel="noopener" href="https://flights.ctrip.com/">单机此处，打开专业网站</a></p>
<hr>
<p><strong>恢复数据到delete之前</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#查看binlog事件  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000013&#x27;</span>;  </span><br><span class="line">#使用mysqlbinlog来查看  </span><br><span class="line">[root<span class="variable">@db01</span> data]# mysqlbinlog <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>mysql<span class="operator">-</span>bin<span class="number">.000013</span>  </span><br><span class="line">[root<span class="variable">@db01</span> data]# mysqlbinlog <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>mysql<span class="operator">-</span>bin<span class="number">.000013</span><span class="operator">|</span>grep <span class="operator">-</span>v <span class="keyword">SET</span>  </span><br><span class="line">[root<span class="variable">@db01</span> data]# mysqlbinlog <span class="comment">--base64-output=decode-rows -vvv mysql-bin.000013  </span></span><br><span class="line">### <span class="keyword">UPDATE</span> `binlog`.`binlog_table`  </span><br><span class="line">### <span class="keyword">WHERE</span>  </span><br><span class="line">### <span class="variable">@1</span><span class="operator">=</span><span class="number">2</span> <span class="comment">/* INT meta=0 nullable=1 is_null=0 */</span>  </span><br><span class="line">### <span class="keyword">SET</span>  </span><br><span class="line">### <span class="variable">@1</span><span class="operator">=</span><span class="number">22</span> <span class="comment">/* INT meta=0 nullable=1 is_null=0 */</span>  </span><br><span class="line">#分析  </span><br><span class="line"><span class="keyword">update</span> binlog.binlog_table  </span><br><span class="line"><span class="keyword">set</span>  </span><br><span class="line"><span class="variable">@1</span><span class="operator">=</span><span class="number">22</span> <span class="comment">---------&gt;@1表示binlog_table中的第一列,集合表结构就是id=22  </span></span><br><span class="line"><span class="keyword">where</span>  </span><br><span class="line"><span class="variable">@1</span><span class="operator">=</span><span class="number">2</span> <span class="comment">---------&gt;@1表示binlog_table中的第一列,集合表结构就是id=2  </span></span><br><span class="line">#结果  </span><br><span class="line"><span class="keyword">update</span> binlog.binlog_table <span class="keyword">set</span> id<span class="operator">=</span><span class="number">22</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">2</span>;  </span><br><span class="line">#截取二进制日志  </span><br><span class="line">查看二进制日志后，发现<span class="keyword">delete</span>语句开始位置是<span class="number">858</span>  </span><br><span class="line">[root<span class="variable">@db01</span> data]# mysqlbinlog <span class="comment">--start-position=120 --stop-position=858 /application/mysql/data/mysql-bin.000013  </span></span><br><span class="line">#临时关闭binlog  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">0</span>;  </span><br><span class="line">#执行<span class="keyword">sql</span>文件  </span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>tmp<span class="operator">/</span>binlog.sql  </span><br><span class="line">#查看删除的库  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;  </span><br><span class="line">#进binlog库  </span><br><span class="line">mysql<span class="operator">&gt;</span> use binlog  </span><br><span class="line">#查看删除的表  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;  </span><br><span class="line">#查看表中内容  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> binlog_table;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>思考，存在问题：</strong></p>
<blockquote>
<p>数据库或表被误删除的是很久之前创建的（一年前）<br><strong>如果基于binlog全量恢复，成本很高</strong><br>1）可以用备份恢复+短时间内二进制日志，恢复到故障之前<br>2）非官方方法，binlog2sql，binlog取反，类似于Oracle的flushback<br>3）延时从库</p>
<p>如果同一时间内和故障库无关的数据库都有操作，在截取binlog时都会被截取到<br><strong>想一个办法过滤出来？</strong><br>1）grep？<br><strong>其他过滤方案？</strong><br>1）-d 参数接库名</p>
</blockquote>
<p><strong>模拟数据</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#为了让大家更清晰看到新的操作  </span><br><span class="line">#刷新一个新的binlog  </span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;  </span><br><span class="line">#创建db1、db2两个库  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database db1;  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database db2;  </span><br><span class="line">#库db1操作  </span><br><span class="line">mysql<span class="operator">&gt;</span> use db1  </span><br><span class="line">#创建t1表  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> t1(id <span class="type">int</span>);  </span><br><span class="line">#插入<span class="number">5</span>条数据  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>),(<span class="number">3</span>),(<span class="number">4</span>),(<span class="number">5</span>);  </span><br><span class="line">#提交  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;  </span><br><span class="line">#库db2操作  </span><br><span class="line">mysql<span class="operator">&gt;</span> use db2  </span><br><span class="line">#创建t2表  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> t2(id <span class="type">int</span>);  </span><br><span class="line">#插入<span class="number">3</span>条数据  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> t2 <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>),(<span class="number">3</span>);  </span><br><span class="line">#提交  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;  </span><br><span class="line">#查看binlog事件  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000014&#x27;</span>;  </span><br><span class="line">#查看db1的操作  </span><br><span class="line">[root<span class="variable">@db01</span> data]# mysqlbinlog <span class="operator">-</span>d db1 <span class="comment">--base64-output=decode-rows -vvv /application/mysql/data/mysql-bin.000014</span></span><br></pre></td></tr></table></figure>

<p><strong>删除、刷新binlog</strong></p>
<blockquote>
<p>刷新binlog日志<br>1）flush logs;<br>2）重启数据库时会刷新<br>3）二进制日志上限（max_binlog_size）</p>
</blockquote>
<hr>
<blockquote>
<p>删除二进制日志<br>1）原则<br>在存储能力范围内，能多保留则多保留<br>基于上一次全备前的可以选择删除</p>
</blockquote>
<hr>
<p><strong>删除方式</strong></p>
<ul>
<li>1.根据存在时间删除日志</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#临时生效  </span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> expire_logs_days <span class="operator">=</span> <span class="number">7</span>;  </span><br><span class="line">#永久生效  </span><br><span class="line">[root<span class="variable">@db01</span> data]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf  </span><br><span class="line">[mysqld]  </span><br><span class="line">expire_logs_days <span class="operator">=</span> <span class="number">7</span></span><br></pre></td></tr></table></figure>

<ul>
<li>2.使用purge命令删除</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PURGE <span class="type">BINARY</span> LOGS BEFORE now() <span class="operator">-</span> <span class="type">INTERVAL</span> <span class="number">3</span> <span class="keyword">day</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>3.根据文件名删除</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PURGE <span class="type">BINARY</span> LOGS <span class="keyword">TO</span> <span class="string">&#x27;mysql-bin.000010&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>4.使用reset master</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> reset master; </span><br></pre></td></tr></table></figure>

<h2 id="五-慢查询日志"><a href="#五-慢查询日志" class="headerlink" title="五.慢查询日志"></a>五.慢查询日志</h2><p><strong>作用：</strong><br>1）是将mysql服务器中影响数据库性能的相关SQL语句记录到日志文件<br>2）通过对这些特殊的SQL语句分析，改进以达到提高数据库性能的目的</p>
<p><strong>默认位置：</strong><br>$MYSQL_HOME&#x2F;data&#x2F;$hostname-slow.log</p>
<p><strong>开启方式（默认没有开启）：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf  </span><br><span class="line">[mysqld]  </span><br><span class="line">#指定是否开启慢查询日志  </span><br><span class="line">slow_query_log <span class="operator">=</span> <span class="number">1</span>  </span><br><span class="line">#指定慢日志文件存放位置（默认在data）  </span><br><span class="line">slow_query_log_file<span class="operator">=</span><span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>slow.log  </span><br><span class="line">#设定慢查询的阀值(默认<span class="number">10</span>s)  </span><br><span class="line">long_query_time<span class="operator">=</span><span class="number">0.05</span>  </span><br><span class="line">#不使用索引的慢查询日志是否记录到日志  </span><br><span class="line">log_queries_not_using_indexes  </span><br><span class="line">#查询检查返回少于该参数指定行的<span class="keyword">SQL</span>不被记录到慢查询日志  </span><br><span class="line">min_examined_row_limit<span class="operator">=</span><span class="number">100</span>（鸡肋）</span><br></pre></td></tr></table></figure>

<p><strong>模拟慢查询语句</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#进入world库  </span><br><span class="line">mysql<span class="operator">&gt;</span> use world  </span><br><span class="line">#查看表  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables  </span><br><span class="line">#将city表中所有内容加到t1表中  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> t1 <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city;  </span><br><span class="line">#查看t1的表结构  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> t1;  </span><br><span class="line">#将t1表所有内容插入到t1表中（多插入几次）  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1;  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1;  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1;  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1;  </span><br><span class="line">#提交  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;  </span><br><span class="line">#删除t1表中id<span class="operator">&gt;</span><span class="number">2000</span>的数据  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> t1 <span class="keyword">where</span> id<span class="operator">&gt;</span><span class="number">2000</span>;  </span><br><span class="line">#查看慢日志  </span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# cat <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>mysql<span class="operator">-</span>db01</span><br></pre></td></tr></table></figure>

<p><strong>使用mysqldumpslow命令来分析慢查询日志</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#输出记录次数最多的<span class="number">10</span>条<span class="keyword">SQL</span>语句 $PATH<span class="operator">/</span>mysqldumpslow <span class="operator">-</span>s c <span class="operator">-</span>t <span class="number">10</span> <span class="operator">/</span>database<span class="operator">/</span>mysql<span class="operator">/</span>slow<span class="operator">-</span>log</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参数说明:<br>-s:<br>是表示按照何种方式排序，c、t、l、r分别是按照记录次数、时间、查询时间、返回的记录数来排序，ac、at、al、ar，表示相应的倒叙；<br>-t:<br>是top n的意思，即为返回前面多少条的数据；<br>-g:<br>后边可以写一个正则匹配模式，大小写不敏感的；</p>
</blockquote>
<p>例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#得到返回记录集最多的<span class="number">10</span>个查询  </span><br><span class="line">$PATH<span class="operator">/</span>mysqldumpslow <span class="operator">-</span>s r <span class="operator">-</span>t <span class="number">10</span> <span class="operator">/</span>database<span class="operator">/</span>mysql<span class="operator">/</span>slow<span class="operator">-</span>log #得到按照时间排序的前<span class="number">10</span>条里面含有左连接的查询语句 $PATH<span class="operator">/</span>mysqldumpslow <span class="operator">-</span>s t <span class="operator">-</span>t <span class="number">10</span> <span class="operator">-</span>g “<span class="keyword">left</span> <span class="keyword">join</span>”<span class="operator">/</span>database<span class="operator">/</span>mysql<span class="operator">/</span>slow<span class="operator">-</span>log</span><br></pre></td></tr></table></figure>

<p><strong>第三方推荐（扩展）：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y percona-toolkit-3.0.11-1.el6.x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>使用percona公司提供的pt-query-digest工具分析慢查询日志</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# pt<span class="operator">-</span>query<span class="operator">-</span>digest <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>mysql<span class="operator">-</span>db01<span class="operator">-</span>slow.log</span><br></pre></td></tr></table></figure>

<p>有能力的可以做成可视化界面：<br>Anemometer基于pt-query-digest将MySQL慢查询可视化<br><a target="_blank" rel="noopener" href="https://www.percona.com/downloads/percona-toolkit/LATEST/">https://www.percona.com/downloads/percona-toolkit/LATEST/</a> 慢日志分析工具下载<br><a target="_blank" rel="noopener" href="https://github.com/box/Anemometer">https://github.com/box/Anemometer</a> 可视化代码下载<br><img src="/assets/1652968358-1a5fc77ecf239e3ee8472947e15d4603.jpg"></p>
<hr>
<h2 id="title-第九章·-MySQL的备份和恢复url-https-blog-driverzeng-com-zenglaoshi-699-htmlclipped-at-2022-05-19-21-52-59category-defaulttags-无"><a href="#title-第九章·-MySQL的备份和恢复url-https-blog-driverzeng-com-zenglaoshi-699-htmlclipped-at-2022-05-19-21-52-59category-defaulttags-无" class="headerlink" title="title: 第九章· MySQL的备份和恢复url: https://blog.driverzeng.com/zenglaoshi/699.htmlclipped_at: 2022-05-19 21:52:59category: defaulttags: - 无"></a>title: 第九章· MySQL的备份和恢复<br>url: <a target="_blank" rel="noopener" href="https://blog.driverzeng.com/zenglaoshi/699.html">https://blog.driverzeng.com/zenglaoshi/699.html</a><br>clipped_at: 2022-05-19 21:52:59<br>category: default<br>tags:<br> - 无</h2><h1 id="第九章·-MySQL的备份和恢复"><a href="#第九章·-MySQL的备份和恢复" class="headerlink" title="第九章· MySQL的备份和恢复"></a>第九章· MySQL的备份和恢复</h1><ul>
<li><a href="#toc_0">一.备份的原因</a></li>
<li><a href="#toc_1">二.备份的类型</a></li>
<li><a href="#toc_2">三.备份的方式</a></li>
<li><a href="#toc_3">四.备份策略</a></li>
<li><a href="#toc_4">五.备份工具</a></li>
</ul>
<blockquote>
<p>曾志高翔, 江湖人称曾老大。多年互联网运维工作经验，曾负责过大规模集群架构自动化运维管理工作。擅长Web集群架构与自动化运维，曾负责国内某大型金融公司运维工作。<br>个人博客:”DBA老司机带你删库跑路”<br>笔者QQ:133411023、253097001<br>笔者交流群：198571640<br>笔者微信：z133411023</p>
</blockquote>
<h2 id="一-备份的原因"><a href="#一-备份的原因" class="headerlink" title="一.备份的原因"></a>一.备份的原因</h2><blockquote>
<p>运维工作的核心简单概括就两件事:<br>1）第一个是保护公司的数据.<br>2）第二个是让网站能7*24小时提供服务(用户体验)。</p>
</blockquote>
<p><img src="/assets/1652968379-760ca2b23711785688de92182e7ecd4e.jpg">￼</p>
<p>1）备份就是为了恢复。<br>2）尽量减少数据的丢失（公司的损失）</p>
<h2 id="二-备份的类型"><a href="#二-备份的类型" class="headerlink" title="二.备份的类型"></a>二.备份的类型</h2><p><strong>冷备份:</strong><br>这些备份在用户不能访问数据时进行，因此无法读取或修改数据。这些脱机备份会阻止执行任何使用数据的活动。这些类型的备份不会干扰正常运行的系统的性能。但是，对于某些应用程序，会无法接受必须在一段较长的时间里锁定或完全阻止用户访问数据。</p>
<p><strong>温备份:</strong><br>这些备份在读取数据时进行，但在多数情况下，在进行备份时不能修改数据本身。这种中途备份类型的优点是不必完全锁定最终用户。但是，其不足之处在于无法在进行备份时修改数据集，这可能使这种类型的备份不适用于某些应用程序。在备份过程中无法修改数据可能产生性能问题。</p>
<p><strong>热备份:</strong><br>这些动态备份在读取或修改数据的过程中进行，很少中断或者不中断传输或处理数据的功能。使用热备份时，系统仍可供读取和修改数据的操作访问。</p>
<h2 id="三-备份的方式"><a href="#三-备份的方式" class="headerlink" title="三.备份的方式"></a>三.备份的方式</h2><p><strong>逻辑备份:</strong></p>
<p><strong>基于SQL语句的备份</strong></p>
<p>1）binlog<br>2）into outfile</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> world.city <span class="keyword">into</span> outfile <span class="string">&#x27;/tmp/world_city.data&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>3）mysqldump<br>4）replication</p>
<p><strong>物理备份:</strong></p>
<p><strong>基于数据文件的备份</strong></p>
<p>1）Xtrabackup（percona公司）</p>
<h2 id="四-备份策略"><a href="#四-备份策略" class="headerlink" title="四.备份策略"></a>四.备份策略</h2><p>1）全量备份 full<br>2）增量备份 increamental</p>
<h2 id="五-备份工具"><a href="#五-备份工具" class="headerlink" title="五.备份工具"></a>五.备份工具</h2><p>1）mysqldump（逻辑）<br>mysql原生自带很好用的逻辑备份工具</p>
<p>2）mysqlbinlog（逻辑）<br>实现binlog备份的原生态命令</p>
<p>3）xtrabackup（物理）<br>precona公司开发的性能很高的物理备份工具</p>
<p><strong>备份工具使用</strong></p>
<p><strong>mysqldump的备份</strong></p>
<p><em>mysqldump常用参数</em></p>
<p>1）连接服务端参数(基本参数)：-u -p -h -P -S</p>
<p>2）-A, –all-databases：全库备份</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# mysqldump -uroot -poldboy123 -A &gt; /backup/full.sql</span><br></pre></td></tr></table></figure>

<p>3）不加参数：单库、单表多表备份</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# mysqldump -uroot -poldboy123 db1 &gt; /backup/db1.sql  </span><br><span class="line">[root@mysql-db01 backup]# mysqldump -uroot -poldboy123 world city &gt; /backup/city.sql</span><br></pre></td></tr></table></figure>

<p>4）-B：指定库备份</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# mysqldump -uroot -p123 -B db1 &gt; /backup/db1.sql  </span><br><span class="line">[root@db01 ~]# mysqldump -uroot -p123 -B db1 db2 &gt; /backup/db1_db2.sql</span><br></pre></td></tr></table></figure>

<p>5）-F：flush logs在备份时自动刷新binlog（不怎么常用）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 backup]# mysqldump -uroot -p123 -A -R –triggers -F &gt; /backup/full_2.sql</span><br></pre></td></tr></table></figure>

<p>6）–master-data&#x3D;2：备份时加入change master语句0没有1不注释2注释</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 backup]# mysqldump -uroot -p123 --master-data=2 &gt;/backup/full.sql</span><br></pre></td></tr></table></figure>

<p>7）-d：仅表结构<br>8）-t：仅数据</p>
<p><strong>备份额外扩展项</strong></p>
<p>1）-R, –routines：备份存储过程和函数数据<br>2）–triggers：备份触发器数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 backup]# mysqldump -uroot -p123 -A -R --triggers &gt; /backup/full_2.sql</span><br></pre></td></tr></table></figure>

<p><strong>mysqldump特殊参数</strong></p>
<p>1）-x：锁表备份（myisam温备份）<br>2）–single-transaction：快照备份</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 backup]# mysqldump -uroot -p123 -A -R --triggers --master-data=2 –single-transaction&gt;/backup/full.sql</span><br></pre></td></tr></table></figure>

<p>3)gzip:压缩备份</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# mysqldump -uroot -p123 -A -R --triggers --master-data=2 –single-transaction|gzip&gt;/backup/full.sql.gz</span><br></pre></td></tr></table></figure>

<p><strong>mysqldump的恢复</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#先不记录二进制日志  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">0</span>;  </span><br><span class="line">#库内恢复操作  </span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>backup<span class="operator">/</span>full.sql  </span><br><span class="line">#库外恢复操作  </span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123 <span class="operator">&lt;</span> <span class="operator">/</span>backup<span class="operator">/</span>full.sql</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<p>1）mysqldump在备份和恢复时都需要MySQL实例启动为前提<br>2）一般数据量级100G以内，大约15-30分钟可以恢复（PB、EB就需要考虑别的方式）<br>3）mysqldump是以覆盖的形式恢复数据的</p>
<p><strong>企业故障恢复案例</strong></p>
<p><em>背景：</em><br>正在运行的网站系统，MySQL数据库，数据量25G，日业务增量10-15M。</p>
<p><em>备份策略：</em><br>每天23：00，计划任务调用mysqldump执行全备脚本</p>
<p><em>故障时间点：</em><br>上午10点开发人员误删除一个核心业务表，如何恢复？</p>
<p><em>思路：</em></p>
<p>1）停业务避免数据的二次伤害<br>2）找一个临时的库，恢复前一天的全备<br>3）截取前一天23：00到第二天10点误删除之间的binlog，恢复到临时库<br>4）测试可用性和完整性<br>5）开启业务前的两种方式</p>
<blockquote>
<p>a.直接使用临时库顶替原生产库，前端应用割接到新库<br>b.将误删除的表单独导出，然后导入到原生产环境</p>
</blockquote>
<p>6）开启业务</p>
<p><strong>故障模拟演练：</strong></p>
<p><em>准备数据：</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#刷新binlog使内容更清晰</span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;</span><br><span class="line">#查看当前使用的binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line">#创建backup库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database backup;</span><br><span class="line">#进入backup库</span><br><span class="line">mysql<span class="operator">&gt;</span> use backup</span><br><span class="line">#创建<span class="keyword">full</span>表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">full</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> world.city;</span><br><span class="line">#创建full_1表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> full_1 <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> world.city;</span><br><span class="line">#查看表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br></pre></td></tr></table></figure>

<p><em>全备：</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# mysqldump -uroot -p123 -A -R --triggers --master-data=2 --single-transaction|gzip &gt; /backup/full_$(date +%F).sql.gz</span><br></pre></td></tr></table></figure>

<p><em>模拟数据变化：</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#进入backup库</span><br><span class="line">mysql<span class="operator">&gt;</span> use backup</span><br><span class="line">#创建<span class="keyword">new</span>表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">new</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mysql.user;</span><br><span class="line">#创建new_1表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> new_1 <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> world.country;</span><br><span class="line">#查看表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line">#查看<span class="keyword">full</span>表中所有数据</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">full</span>;</span><br><span class="line">#把<span class="keyword">full</span>表中所有的countrycode都改成CHN</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> <span class="keyword">full</span> <span class="keyword">set</span> countrycode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span> <span class="keyword">where</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">#提交</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line">#删除id大于<span class="number">200</span>的数据</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> <span class="keyword">full</span> <span class="keyword">where</span> id<span class="operator">&gt;</span><span class="number">200</span>;</span><br><span class="line">#提交</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure>

<p><em>模拟故障：</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#删除<span class="keyword">new</span>表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">new</span>;</span><br><span class="line">#查看表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br></pre></td></tr></table></figure>

<p><em>恢复过程：</em></p>
<p>1）准备临时数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db02 ~]# mysqld_safe --defaults-file=/data/3307/my.cnf &amp;</span><br></pre></td></tr></table></figure>

<p>2）拷贝数据到新库上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db02 ~]# scp /backup/full_2018-08-16.sql.gz root@10.0.0.52:/tmp</span><br></pre></td></tr></table></figure>

<p>3）解压全备数据文件</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#进入tmp目录  </span><br><span class="line">[root<span class="variable">@db02</span> <span class="operator">~</span>]# cd <span class="operator">/</span>tmp<span class="operator">/</span>  </span><br><span class="line">#解压全备数据文件  </span><br><span class="line">[root<span class="variable">@db02</span> tmp]# gzip <span class="operator">-</span>d full_2018<span class="number">-08</span><span class="number">-16.</span>sql.gz  </span><br><span class="line">截取二进制  </span><br><span class="line">#查看全备的位置点（起始位置点）  </span><br><span class="line">[root<span class="variable">@db02</span> tmp]# head <span class="number">-50</span> full_2018<span class="number">-08</span><span class="number">-16.</span><span class="keyword">sql</span> <span class="operator">|</span>grep <span class="operator">-</span>i <span class="string">&#x27;change master to&#x27;</span>  </span><br><span class="line">#找到<span class="keyword">drop</span>语句执行的位置点（结束位置点）  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000017&#x27;</span>;  </span><br><span class="line">#截取二进制  </span><br><span class="line">[root<span class="variable">@db01</span> tmp]#mysqlbinlog <span class="operator">-</span>uroot <span class="operator">-</span>p123 <span class="comment">--start-position=268002 --stop-position=671148 /application/mysql/data/mysql-bin.000017 &gt; /tmp/inc.sql  </span></span><br><span class="line">#发送增量数据到新库  </span><br><span class="line">[root<span class="variable">@db01</span> tmp]# scp <span class="operator">/</span>tmp<span class="operator">/</span>inc.sql root<span class="variable">@10</span><span class="number">.0</span><span class="number">.0</span><span class="number">.52</span>:<span class="operator">/</span>tmp  </span><br><span class="line">在新库内恢复数据  </span><br><span class="line">#不记录二进制日志  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">0</span>;  </span><br><span class="line">#恢复全备数据  </span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>tmp<span class="operator">/</span>full_2018<span class="number">-08</span><span class="number">-16.</span><span class="keyword">sql</span>  </span><br><span class="line">#进入backup库  </span><br><span class="line">mysql<span class="operator">&gt;</span> use backup  </span><br><span class="line"># 查看表  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;  </span><br><span class="line">#恢复增量数据  </span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>tmp<span class="operator">/</span>inc.sql  </span><br><span class="line">#查看表  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br></pre></td></tr></table></figure>

<p>4）将故障表导出并恢复到生产</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">导出new表</span></span><br><span class="line">[root@db02 ~]# mysqldump -uroot -p123 -S /data/3307/mysql.sock backup new &gt; /tmp/new.sql</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">发送到生产库</span></span><br><span class="line">[root@db02 ~]# scp /tmp/new.sql root@10.0.0.51:/tmp/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">进入backup库</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">use backup</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在生产库恢复数据</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="built_in">source</span> /tmp/new.sql</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看表</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show tables;</span></span><br></pre></td></tr></table></figure>

<p><strong>物理备份（Xtrabackup）</strong></p>
<p><em>Xtrabackup安装</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下载epel源</span></span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo  https://mirrors.aliyun.com/repo/epel-6.repo</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装依赖</span></span><br><span class="line">yum -y install perl perl-devel libaio libaio-devel perl-Time-HiRes perl-DBD-MySQL</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下载Xtrabackup</span></span><br><span class="line">wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.4/binary/redhat/6/x86_64/percona-xtrabackup-24-2.4.4-1.el6.x86_64.rpm</span><br></pre></td></tr></table></figure>

<p><strong>备份方式（物理备份）</strong></p>
<p>1）对于非innodb表（比如myisam）是直接锁表cp数据文件，属于一种温备。<br>2）对于innodb的表（支持事务），不锁表，cp数据页最终以数据文件方式保存下来，并且把redo和undo一并备走，属于热备方式。<br>3）备份时读取配置文件&#x2F;etc&#x2F;my.cnf</p>
<p><strong>全量备份</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">全备</span>  </span><br><span class="line">[root@db01 data]# innobackupex --user=root --password=123 /backup  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">避免时间戳，自定义路径名</span>  </span><br><span class="line">[root@db01 ~]# innobackupex --user=root --password=123 --no-timestamp /backup/full  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看备份路径中的内容</span>  </span><br><span class="line">[root@db01 backup]# ll /backup/full  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">记录binlog文件名和binlog的位置点</span>  </span><br><span class="line">-rw-r----- 1 root root 21 Aug 16 06:23 xtrabackup_binlog_info  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">备份时刻，立即将已经commit过的内存中的数据页刷新到磁盘</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">备份时刻有可能会有其他数据写入，已备走的数据文件就不会再发生变化了</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在备份过程中，备份软件会一直监控着redo和undo，一旦有变化会将日志一并备走</span>  </span><br><span class="line">-rw-r----- 1 root root 117 Aug 16 06:23 xtrabackup_checkpoints  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">备份汇总信息</span>  </span><br><span class="line">-rw-r----- 1 root root 485 Aug 16 06:23 xtrabackup_info  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">备份的redo文件</span>  </span><br><span class="line">-rw-r----- 1 root root 2560 Aug 16 06:23 xtrabackup_logfile</span><br></pre></td></tr></table></figure>

<p><strong>全备的恢复</strong></p>
<p><em>准备备份</em></p>
<p>将redo进行重做，已提交的写到数据文件，未提交的使用undo回滚，模拟CSR的过程</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 full]# innobackupex --user=root --password=123 --apply-log /backup/full</span><br></pre></td></tr></table></figure>

<p><em>恢复备份</em></p>
<p>前提1：被恢复的目录是空的<br>前提2：被恢复的数据库的实例是关闭的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">停库</span>  </span><br><span class="line">[root@db01 full]# /etc/init.d/mysqld stop  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">进入mysql目录</span>  </span><br><span class="line">[root@db01 full]# cd /application/mysql  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">删除data目录（在生产中可以备份一下）</span>  </span><br><span class="line">[root@db01 mysql]# rm -fr data/  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">拷贝数据</span>  </span><br><span class="line">[root@db01 mysql]# innobackupex --copy-back /backup/full  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">授权</span>  </span><br><span class="line">[root@db01 mysql]# chown -R mysql.mysql /application/mysql/data/  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动MySQL</span>  </span><br><span class="line">[root@db01 mysql]# /etc/init.d/mysqld start</span><br></pre></td></tr></table></figure>

<p><strong>增量备份及恢复</strong></p>
<p><em>备份方式</em></p>
<p>1）基于上一次备份进行增量<br>2）增量备份无法单独恢复，必须基于全备进行恢复<br>3）所有增量必须要按顺序合并到全备当中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">不使用之前的全备，执行一次全备</span>  </span><br><span class="line">[root@mysql-db01 ~]# innobackupex --user=root --password=123 --no-timestamp /backup/full</span><br></pre></td></tr></table></figure>

<p><em>模拟数据变化</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database inc1;  </span><br><span class="line">mysql<span class="operator">&gt;</span> use inc1  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> inc1_tab(id <span class="type">int</span>);  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> inc1_tab <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>),(<span class="number">3</span>);  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> inc1_tab;</span><br></pre></td></tr></table></figure>

<p><strong>第一次增量备份</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# innobackupex --user=root --password=123 --no-timestamp --incremental --incremental-basedir=/backup/full/ /backup/inc1  </span><br><span class="line">参数说明:  </span><br><span class="line">--incremental：开启增量备份功能  </span><br><span class="line">--incremental-basedir：上一次备份的路径</span><br></pre></td></tr></table></figure>

<p><strong>再次模拟数据变化</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database inc2;  </span><br><span class="line">mysql<span class="operator">&gt;</span> use inc2  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> inc2_tab(id <span class="type">int</span>);  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> inc2_tab <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>),(<span class="number">3</span>);  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure>

<p><strong>第二次增量备份</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# innobackupex --user=root --password=123 --no-timestamp --incremental --incremental-basedir=/backup/inc1/ /backup/inc2</span><br></pre></td></tr></table></figure>

<p><strong>增量恢复</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">破坏数据</span>  </span><br><span class="line">[root@db01 ~]# rm -fr /application/mysql/data/</span><br></pre></td></tr></table></figure>

<p><strong>准备备份</strong></p>
<p>1）full+inc1+inc2<br>2）需要将inc1和inc2按顺序合并到full中<br>3）分步骤进行–apply-log</p>
<p><em>第一步：在全备中apply-log时，只应用redo，不应用undo</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# innobackupex --apply-log --redo-only /backup/full/</span><br></pre></td></tr></table></figure>

<p><em>第二步：合并inc1合并到full中，并且apply-log，只应用redo，不应用undo</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# innobackupex --apply-log --redo-only --incremental-dir=/backup/inc1/ /backup/full/</span><br></pre></td></tr></table></figure>

<p><em>第三步：合并inc2合并到full中，redo和undo都应用</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# innobackupex --apply-log --incremental-dir=/backup/inc2/ /backup/full/</span><br></pre></td></tr></table></figure>

<p><em>第四步：整体full执行apply-log，redo和undo都应用</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 mysql]# innobackupex --apply-log /backup/full/  </span><br><span class="line">copy-back  </span><br><span class="line">[root@db01 ~]# innobackupex --copy-back /backup/full/  </span><br><span class="line">[root@db01 ~]# chown -R mysql.mysql /application/mysql/data/  </span><br><span class="line">[root@db01 ~]# /etc/init.d/mysqld start</span><br></pre></td></tr></table></figure>

<p><strong>思考:</strong></p>
<p>企业级增量恢复实战</p>
<p><strong>背景：</strong><br>某大型网站，mysql数据库，数据量500G，每日更新量100M-200M</p>
<p><strong>备份策略：</strong><br>xtrabackup，每周六0:00进行全备，周一到周五及周日00:00进行增量备份。</p>
<p><strong>故障场景：</strong><br>周三下午2点出现数据库意外删除表操作。</p>
<p><strong>如何恢复？？？</strong></p>
<p>赏</p>
<p><a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.driverzeng.com/zenglaoshi/tag/mysql/">MySQL</a></p>
<p><a href="javascript:">0</a></p>
<p>[</p>
<p>Previous Post</p>
<h3 id="第八章·-MySQL日志管理-1"><a href="#第八章·-MySQL日志管理-1" class="headerlink" title="第八章· MySQL日志管理"></a>第八章· MySQL日志管理</h3><hr>
<p>](<a target="_blank" rel="noopener" href="https://blog.driverzeng.com/zenglaoshi/695.html">https://blog.driverzeng.com/zenglaoshi/695.html</a>)</p>
<p>[</p>
<p>Next Post</p>
<h3 id="第十章·-MySQL的主从复制"><a href="#第十章·-MySQL的主从复制" class="headerlink" title="第十章· MySQL的主从复制"></a>第十章· MySQL的主从复制</h3><hr>
<p>](<a target="_blank" rel="noopener" href="https://blog.driverzeng.com/zenglaoshi/703.html">https://blog.driverzeng.com/zenglaoshi/703.html</a>)</p>
<hr>
<h2 id="title-第十章·-MySQL的主从复制url-https-blog-driverzeng-com-zenglaoshi-703-htmlclipped-at-2022-05-19-21-53-50category-defaulttags-无"><a href="#title-第十章·-MySQL的主从复制url-https-blog-driverzeng-com-zenglaoshi-703-htmlclipped-at-2022-05-19-21-53-50category-defaulttags-无" class="headerlink" title="title: 第十章· MySQL的主从复制url: https://blog.driverzeng.com/zenglaoshi/703.htmlclipped_at: 2022-05-19 21:53:50category: defaulttags: - 无"></a>title: 第十章· MySQL的主从复制<br>url: <a target="_blank" rel="noopener" href="https://blog.driverzeng.com/zenglaoshi/703.html">https://blog.driverzeng.com/zenglaoshi/703.html</a><br>clipped_at: 2022-05-19 21:53:50<br>category: default<br>tags:<br> - 无</h2><h1 id="第十章·-MySQL的主从复制-1"><a href="#第十章·-MySQL的主从复制-1" class="headerlink" title="第十章· MySQL的主从复制"></a>第十章· MySQL的主从复制</h1><ul>
<li><a href="#toc_0">一.主从复制简介</a></li>
<li><a href="#toc_1">二.主从复制原理</a></li>
<li><a href="#toc_2">四.主从复制基本故障处理</a></li>
<li><a href="#toc_3">五.延时从库</a></li>
<li><a href="#toc_4">六.半同步复制</a></li>
<li><a href="#toc_5">七.过滤复制</a></li>
</ul>
<blockquote>
<p>曾志高翔, 江湖人称曾老大。多年互联网运维工作经验，曾负责过大规模集群架构自动化运维管理工作。擅长Web集群架构与自动化运维，曾负责国内某大型金融公司运维工作。<br>个人博客:”DBA老司机带你删库跑路”<br>笔者QQ:133411023、253097001<br>笔者交流群：198571640<br>笔者微信：z133411023</p>
</blockquote>
<h2 id="一-主从复制简介"><a href="#一-主从复制简介" class="headerlink" title="一.主从复制简介"></a>一.主从复制简介</h2><p><img src="/assets/1652968430-0c3d7c4119dc75c113f3042b9d6174e3.jpg">￼</p>
<p>2015年5月28日11时，<strong>12小时</strong>后恢复，损失：平均<strong>每小时106.48W$</strong></p>
<p>1）高可用<br>2）辅助备份<br>3）分担负载</p>
<p>复制是 MySQL 的一项功能，允许服务器将更改从一个实例复制到另一个实例。</p>
<p>1）主服务器将所有数据和结构更改记录到二进制日志中。<br>2）从属服务器从主服务器请求该二进制日志并在本地应用其内容。<br>3）IO：请求主库，获取上一次执行过的新的事件，并存放到relaylog<br>4）SQL：从relaylog中将sql语句翻译给从库执行</p>
<h2 id="二-主从复制原理"><a href="#二-主从复制原理" class="headerlink" title="二.主从复制原理"></a>二.主从复制原理</h2><p><strong>主从复制的前提</strong></p>
<p>1）两台或两台以上的数据库实例<br>2）主库要开启二进制日志<br>3）主库要有复制用户<br>4）主库的server_id和从库不同<br>5）从库需要在开启复制功能前，要获取到主库之前的数据（主库备份，并且记录binlog当时位置）<br>6）从库在第一次开启主从复制时，时必须获知主库：ip，port，user，password，logfile，pos</p>
<hr>
<p>IP：10.0.0.51<br>Port：3306<br>User：rep<br>Password：oldboy123<br>logFile：mysql-bin.000002<br>Pos：120</p>
<hr>
<p>7）从库要开启相关线程：IO、SQL<br>8）从库需要记录复制相关用户信息，还应该记录到上次已经从主库请求到哪个二进制日志<br>9）从库请求过来的binlog，首先要存下来，并且执行binlog，执行过的信息保存下来</p>
<p><strong>主从复制涉及到的文件和线程</strong></p>
<p><em>主库：</em></p>
<p>1）主库binlog：记录主库发生过的修改事件<br>2）dump thread：给从库传送（TP）二进制日志线程</p>
<p><em>从库：</em></p>
<p>1）relay-log（中继日志）：存储所有主库TP过来的binlog事件<br>2）master.info：存储复制用户信息，上次请求到的主库binlog位置点<br>3）IO thread：接收主库发来的binlog日志，也是从库请求主库的线程<br>4）SQL thread：执行主库TP过来的日志</p>
<p><em>原理</em></p>
<p>1）通过change master to语句告诉从库主库的ip，port，user，password，file，pos<br>2）从库通过start slave命令开启复制必要的IO线程和SQL线程<br>3）从库通过IO线程拿着change master to用户密码相关信息，连接主库，验证合法性<br>4）从库连接成功后，会根据binlog的pos问主库，有没有比这个更新的<br>5）主库接收到从库请求后，比较一下binlog信息，如果有就将最新数据通过dump线程给从库IO线程<br>6）从库通过IO线程接收到主库发来的binlog事件，存储到TCP&#x2F;IP缓存中，并返回ACK更新master.info<br>7）将TCP&#x2F;IP缓存中的内容存到relay-log中<br>8）SQL线程读取relay-log.info，读取到上次已经执行过的relay-log位置点，继续执行后续的relay-log日志，执行完成后，更新relay-log.info</p>
<p><strong>主从复制搭建实战</strong></p>
<p><em>主库操作:</em></p>
<p>1）修改配置文件</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#编辑mysql配置文件  </span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf  </span><br><span class="line">#在mysqld标签下配置  </span><br><span class="line">[mysqld]  </span><br><span class="line">#主库server<span class="operator">-</span>id为<span class="number">1</span>，从库不等于<span class="number">1</span>  </span><br><span class="line">server_id <span class="operator">=</span><span class="number">1</span>  </span><br><span class="line">#开启binlog日志  </span><br><span class="line">log_bin<span class="operator">=</span>mysql<span class="operator">-</span>bin</span><br></pre></td></tr></table></figure>

<p>2）创建主从复制用户</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#登录数据库  </span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>poldboy123  </span><br><span class="line">#创建rep用户  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> replication slave <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> rep@<span class="string">&#x27;10.0.0.%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;oldboy123&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><em>从库操作:</em></p>
<p>1）修改配置文件</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#修改db02配置文件  </span><br><span class="line">[root<span class="variable">@db02</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf  </span><br><span class="line">#在mysqld标签下配置  </span><br><span class="line">[mysqld]  </span><br><span class="line">#主库server<span class="operator">-</span>id为<span class="number">1</span>，从库不等于<span class="number">1</span>  </span><br><span class="line">server_id <span class="operator">=</span><span class="number">5</span>  </span><br><span class="line">#重启mysql  </span><br><span class="line">[root<span class="variable">@db02</span> <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld restart  </span><br><span class="line">#记录主库binlog及位置点  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;  </span><br><span class="line">#登陆数据库  </span><br><span class="line">[root<span class="variable">@db02</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>poldboy123  </span><br><span class="line">#执行change master <span class="keyword">to</span> 语句  </span><br><span class="line">mysql<span class="operator">&gt;</span> change master <span class="keyword">to</span>  </span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> master_host<span class="operator">=</span><span class="string">&#x27;10.0.0.51&#x27;</span>,  </span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> master_user<span class="operator">=</span><span class="string">&#x27;rep&#x27;</span>,  </span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> master_password<span class="operator">=</span><span class="string">&#x27;oldboy123&#x27;</span>,  </span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> master_auto_position<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h2 id="四-主从复制基本故障处理"><a href="#四-主从复制基本故障处理" class="headerlink" title="四.主从复制基本故障处理"></a>四.主从复制基本故障处理</h2><p><strong>IO线程</strong></p>
<p><em>连接主库</em></p>
<p>1）user password ip port<br>2）网络：不通，延时高，防火墙</p>
<p><em>请求binlog</em></p>
<p>1）binlog不存在或者损坏</p>
<p><em>更新relay-log和master.info</em></p>
<blockquote>
<p>SQL线程<br>1）relay-log出现问题<br>2）从库做写入了</p>
</blockquote>
<ul>
<li>操作对象已存在（create）</li>
<li>操作对象不存在（insert update delete drop truncate alter）</li>
<li>约束问题、数据类型、列属性</li>
</ul>
<p><strong>处理方法一：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#临时停止同步  </span><br><span class="line">mysql<span class="operator">&gt;</span> stop slave;  </span><br><span class="line">#将同步指针向下移动一个（可重复操作）  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> sql_slave_skip_counter<span class="operator">=</span><span class="number">1</span>;  </span><br><span class="line">#开启同步  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> slave;</span><br></pre></td></tr></table></figure>

<p><strong>处理方法二：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#编辑配置文件  </span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf  </span><br><span class="line">#在[mysqld]标签下添加以下参数  </span><br><span class="line">slave<span class="operator">-</span><span class="keyword">skip</span><span class="operator">-</span>errors<span class="operator">=</span><span class="number">1032</span>,<span class="number">1062</span>,<span class="number">1007</span></span><br></pre></td></tr></table></figure>

<p><strong>但是以上操作都是有风险存在的</strong></p>
<p><strong>处理方法三：</strong></p>
<p>1）重新备份数据库，恢复到从库<br>2）给从库设置为只读</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#在命令行临时设置  </span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> read_only<span class="operator">=</span><span class="number">1</span>;  </span><br><span class="line">#在配置文件中永久生效  </span><br><span class="line">read_only<span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="五-延时从库"><a href="#五-延时从库" class="headerlink" title="五.延时从库"></a>五.延时从库</h2><p><strong>普通的主从复制可能存在不足</strong></p>
<p>1）逻辑损坏怎么办？<br>2）不能保证主库的操作，从库一定能做<br>3）高可用？自动failover？<br>4）过滤复制</p>
<p><strong>企业中一般会延时3-6小时</strong></p>
<p><strong>延时从库配置方法</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#停止主从  </span><br><span class="line">mysql<span class="operator">&gt;</span>stop slave;  </span><br><span class="line">#设置延时为<span class="number">180</span>秒  </span><br><span class="line">mysql<span class="operator">&gt;</span>CHANGE MASTER <span class="keyword">TO</span> MASTER_DELAY <span class="operator">=</span> <span class="number">180</span>;  </span><br><span class="line">#开启主从  </span><br><span class="line">mysql<span class="operator">&gt;</span><span class="keyword">start</span> slave;  </span><br><span class="line">#查看状态  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status \G  </span><br><span class="line">SQL_Delay: <span class="number">60</span>  </span><br><span class="line"><span class="number">3.</span>延时从库停止方法  </span><br><span class="line">#停止主从  </span><br><span class="line">mysql<span class="operator">&gt;</span> stop slave;  </span><br><span class="line">#设置延时为<span class="number">0</span>  </span><br><span class="line">mysql<span class="operator">&gt;</span> CHANGE MASTER <span class="keyword">TO</span> MASTER_DELAY <span class="operator">=</span> <span class="number">0</span>;  </span><br><span class="line">#开启主从  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> slave;</span><br></pre></td></tr></table></figure>

<p><strong>思考问题：</strong></p>
<p><em>总数据量级500G，正常备份去恢复需要1.5-2小时</em><br>1）配置延时3600秒</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span>CHANGE MASTER <span class="keyword">TO</span> MASTER_DELAY <span class="operator">=</span> <span class="number">3600</span>;</span><br></pre></td></tr></table></figure>

<p>2）主库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> database db;</span><br></pre></td></tr></table></figure>

<p>3）怎么利用延时从库，恢复数据？</p>
<p>提示：<br>1、从库relaylog存放在datadir目录下<br>2、mysqlbinlog 可以截取relaylog内容<br>3、show relay log events in ‘db01-relay-bin.000001’;</p>
<p><strong>处理的思路：</strong></p>
<p>1）停止SQL线程</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> stop slave sql_thread;</span><br></pre></td></tr></table></figure>

<p>2）截取relaylog到误删除之前点</p>
<ul>
<li>relay-log.info 获取到上次运行到的位置点，作为恢复起点</li>
<li>分析relay-log的文件内容，获取到误删除之前position</li>
</ul>
<p><strong>模拟故障处：</strong></p>
<p>1）关闭延时</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>S <span class="operator">/</span>data<span class="operator">/</span><span class="number">3308</span><span class="operator">/</span>mysql.sock  </span><br><span class="line">mysql<span class="operator">&gt;</span> stop slave;  </span><br><span class="line">mysql<span class="operator">&gt;</span> CHANGE MASTER <span class="keyword">TO</span> MASTER_DELAY <span class="operator">=</span> <span class="number">0</span>;  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> slave;</span><br></pre></td></tr></table></figure>

<p>2）模拟数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>S <span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span>mysql.sock  </span><br><span class="line">source <span class="operator">/</span>root<span class="operator">/</span>world.sql  </span><br><span class="line">use world;  </span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> c1 <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city;  </span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> c2 <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city;</span><br></pre></td></tr></table></figure>

<p>3）开启从库延时5分钟</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>S <span class="operator">/</span>data<span class="operator">/</span><span class="number">3308</span><span class="operator">/</span>mysql.sock  </span><br><span class="line"><span class="keyword">show</span> slave status \G  </span><br><span class="line">mysql<span class="operator">&gt;</span>stop slave;  </span><br><span class="line">mysql<span class="operator">&gt;</span>CHANGE MASTER <span class="keyword">TO</span> MASTER_DELAY <span class="operator">=</span> <span class="number">300</span>;  </span><br><span class="line">mysql<span class="operator">&gt;</span><span class="keyword">start</span> slave;  </span><br><span class="line">  </span><br><span class="line">mysql <span class="operator">-</span>S <span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span>mysql.sock  </span><br><span class="line">use world;  </span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> c3 <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city;  </span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> c4 <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city;</span><br></pre></td></tr></table></figure>

<p>4）破坏，模拟删库故障。(以下步骤在5分钟内操作完成。)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>S <span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span>mysql.sock  </span><br><span class="line"><span class="keyword">drop</span> database world;</span><br></pre></td></tr></table></figure>

<p>5）从库，关闭SQL线程</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>S <span class="operator">/</span>data<span class="operator">/</span><span class="number">3308</span><span class="operator">/</span>mysql.sock  </span><br><span class="line">stop slave sql_thread;</span><br></pre></td></tr></table></figure>

<p>6）截取relay-log</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">起点：  </span><br><span class="line">cd <span class="operator">/</span>data<span class="operator">/</span><span class="number">3308</span><span class="operator">/</span>data<span class="operator">/</span>  </span><br><span class="line">cat relay<span class="operator">-</span>log.info  </span><br><span class="line">.<span class="operator">/</span>db01<span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000002</span>  </span><br><span class="line"><span class="number">283</span>  </span><br><span class="line">终点：  </span><br><span class="line">mysql <span class="operator">-</span>S <span class="operator">/</span>data<span class="operator">/</span><span class="number">3308</span><span class="operator">/</span>mysql.sock  </span><br><span class="line"><span class="keyword">show</span> relaylog events <span class="keyword">in</span> <span class="string">&#x27;db01-relay-bin.000002&#x27;</span>  </span><br><span class="line">db01<span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span> <span class="number">268047</span>  </span><br><span class="line">mysqlbinlog <span class="comment">--start-position=283 --stop-position=268047 /data/3308/data/db01-relay-bin.000002 &gt;/tmp/relay.sql</span></span><br></pre></td></tr></table></figure>

<p><strong>恢复relay.sql</strong></p>
<p>1）取消从库身份</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> stop slave;  </span><br><span class="line">mysql<span class="operator">&gt;</span> reset slave <span class="keyword">all</span>;</span><br></pre></td></tr></table></figure>

<p>2）恢复数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">0</span>;  </span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>tmp<span class="operator">/</span>relay.sql  </span><br><span class="line">mysql<span class="operator">&gt;</span> use world  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br></pre></td></tr></table></figure>

<h2 id="六-半同步复制"><a href="#六-半同步复制" class="headerlink" title="六.半同步复制"></a>六.半同步复制</h2><p>从MYSQL5.5开始，支持半自动复制。之前版本的MySQL Replication都是异步（asynchronous）的，主库在执行完一些事务后，是不会管备库的进度的。如果备库不幸落后，而更不幸的是主库此时又出现Crash（例如宕机），这时备库中的数据就是不完整的。简而言之，在主库发生故障的时候，我们无法使用备库来继续提供数据一致的服务了。</p>
<p>半同步复制（Semi synchronous Replication）则一定程度上保证提交的事务已经传给了至少一个备库。<br>出发点是保证主从数据一致性问题，安全的考虑。</p>
<hr>
<p>5.5 出现概念，但是不建议使用，性能太差<br>5.6出现group commit 组提交功能，来提升开启半同步复制的性能<br>5.7更加完善了，在group commit基础上出现了MGR<br>5.7的增强半同步复制的新特性：after commit； after sync；</p>
<hr>
<p><strong>半同步复制开启方法</strong></p>
<p>1）安装（主库）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#登录数据库  </span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>poldboy123  </span><br><span class="line">#查看是否有动态支持  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> variables <span class="keyword">like</span> <span class="string">&#x27;have_dynamic_loading&#x27;</span>;  </span><br><span class="line">#安装自带插件  </span><br><span class="line">mysql<span class="operator">&gt;</span> INSTALL PLUGIN rpl_semi_sync_master SONAME<span class="string">&#x27;semisync_master.so&#x27;</span>;  </span><br><span class="line">#启动插件  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> <span class="keyword">GLOBAL</span> rpl_semi_sync_master_enabled <span class="operator">=</span> <span class="number">1</span>;  </span><br><span class="line">#设置超时  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> <span class="keyword">GLOBAL</span> rpl_semi_sync_master_timeout <span class="operator">=</span> <span class="number">1000</span>;  </span><br><span class="line">#修改配置文件  </span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf  </span><br><span class="line">#在[mysqld]标签下添加如下内容（不用重启库）  </span><br><span class="line">[mysqld]  </span><br><span class="line">rpl_semi_sync_master_enabled<span class="operator">=</span><span class="number">1</span>  </span><br><span class="line">rpl_semi_sync_master_timeout<span class="operator">=</span><span class="number">1000</span>  </span><br><span class="line">检查安装：  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span><span class="string">&#x27;rpl%&#x27;</span>;  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;rpl_semi%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>2）安装（从库）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#登录数据库  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db02 <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>poldboy123  </span><br><span class="line">#安装slave半同步插件  </span><br><span class="line">mysql<span class="operator">&gt;</span> INSTALL PLUGIN rpl_semi_sync_slave SONAME<span class="string">&#x27;semisync_slave.so&#x27;</span>;  </span><br><span class="line">#启动插件  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> <span class="keyword">GLOBAL</span> rpl_semi_sync_slave_enabled <span class="operator">=</span> <span class="number">1</span>;  </span><br><span class="line">#重启io线程使其生效  </span><br><span class="line">mysql<span class="operator">&gt;</span> stop slave io_thread;  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> slave io_thread;  </span><br><span class="line">#编辑配置文件（不需要重启数据库）  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db02 <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf  </span><br><span class="line">#在[mysqld]标签下添加如下内容  </span><br><span class="line">[mysqld]  </span><br><span class="line">rpl_semi_sync_slave_enabled <span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure>

<hr>
<p>注：相关参数说明<br>rpl_semi_sync_master_timeout&#x3D;milliseconds<br>设置此参数值（ms）,为了防止半同步复制在没有收到确认的情况下发生堵塞，如果Master在超时之前没有收到任何确认，将恢复到正常的异步复制，并继续执行没有半同步的复制操作。</p>
<p>rpl_semi_sync_master_wait_no_slave&#x3D;{ON|OFF}<br>如果一个事务被提交,但Master没有任何Slave的连接，这时不可能将事务发送到其它地方保护起来。默认情况下，Master会在时间限制范围内继续等待Slave的连接，并确认该事务已经被正确的写到磁盘上。<br>可以使用此参数选项关闭这种行为，在这种情况下，如果没有Slave连接，Master就会恢复到异步复制。</p>
<hr>
<p><strong>测试半同步</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">#创建两个数据库，test1和test2  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database test1;  </span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.04</span> sec)  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database test2;  </span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)  </span><br><span class="line">#查看复制状态  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;rpl_semi%&#x27;</span>;  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+  </span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+  </span></span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_clients <span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_net_avg_wait_time <span class="operator">|</span> <span class="number">768</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_net_wait_time <span class="operator">|</span> <span class="number">1497</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_net_waits <span class="operator">|</span> <span class="number">2</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_no_times <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_no_tx <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_status <span class="operator">|</span> <span class="keyword">ON</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_timefunc_failures <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_tx_avg_wait_time <span class="operator">|</span> <span class="number">884</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_tx_wait_time <span class="operator">|</span> <span class="number">1769</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_tx_waits <span class="operator">|</span> <span class="number">2</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_wait_pos_backtraverse <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_wait_sessions <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line">#此行显示<span class="number">2</span>，表示刚才创建的两个库执行了半同步  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_yes_tx <span class="operator">|</span> <span class="number">2</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+  </span></span><br><span class="line"><span class="number">14</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.06</span> sec)  </span><br><span class="line">#从库查看  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+  </span></span><br><span class="line"><span class="operator">|</span> Database <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+  </span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> mysql <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> test <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> test1 <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> test2 <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+  </span></span><br><span class="line">#关闭半同步（<span class="number">1</span>:开启 <span class="number">0</span>:关闭）  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> <span class="keyword">GLOBAL</span> rpl_semi_sync_master_enabled <span class="operator">=</span> <span class="number">0</span>;  </span><br><span class="line">#查看半同步状态  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;rpl_semi%&#x27;</span>;  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+  </span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+  </span></span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_clients <span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_net_avg_wait_time <span class="operator">|</span> <span class="number">768</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_net_wait_time <span class="operator">|</span> <span class="number">1497</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_net_waits <span class="operator">|</span> <span class="number">2</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_no_times <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_no_tx <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_status <span class="operator">|</span> OFF <span class="operator">|</span> #状态为关闭  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_timefunc_failures <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_tx_avg_wait_time <span class="operator">|</span> <span class="number">884</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_tx_wait_time <span class="operator">|</span> <span class="number">1769</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_tx_waits <span class="operator">|</span> <span class="number">2</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_wait_pos_backtraverse <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_wait_sessions <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_yes_tx <span class="operator">|</span> <span class="number">2</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+  </span></span><br><span class="line"><span class="number">14</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)  </span><br><span class="line">  </span><br><span class="line">#再一次创建两个库  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database test3;  </span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database test4;  </span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)  </span><br><span class="line">  </span><br><span class="line">#再一次查看半同步状态  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;rpl_semi%&#x27;</span>;  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+  </span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+  </span></span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_clients <span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_net_avg_wait_time <span class="operator">|</span> <span class="number">768</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_net_wait_time <span class="operator">|</span> <span class="number">1497</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_net_waits <span class="operator">|</span> <span class="number">2</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_no_times <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_no_tx <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_status <span class="operator">|</span> OFF <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_timefunc_failures <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_tx_avg_wait_time <span class="operator">|</span> <span class="number">884</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_tx_wait_time <span class="operator">|</span> <span class="number">1769</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_tx_waits <span class="operator">|</span> <span class="number">2</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_wait_pos_backtraverse <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_wait_sessions <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line">#此行还是显示<span class="number">2</span>，则证明，刚才的那两条并没有执行半同步否则应该是<span class="number">4</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_yes_tx <span class="operator">|</span> <span class="number">2</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+  </span></span><br><span class="line"><span class="number">14</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)  </span><br><span class="line">注:不难发现，在查询半同步状态是，开启半同步，查询会有延迟时间，关闭之后则没有  </span><br><span class="line">&#123;<span class="number">1</span>&#125;</span><br></pre></td></tr></table></figure>

<h2 id="七-过滤复制"><a href="#七-过滤复制" class="headerlink" title="七.过滤复制"></a>七.过滤复制</h2><p><strong>主库：</strong></p>
<p><em>白名单:只记录白名单中列出的库的二进制日志</em></p>
<ul>
<li>binlog-do-db</li>
</ul>
<p><em>黑名单：不记录黑名单列出的库的二进制日志</em></p>
<ul>
<li>binlog-ignore-db</li>
</ul>
<p><strong>从库：</strong></p>
<p><em>白名单：只执行白名单中列出的库或者表的中继日志</em></p>
<ul>
<li>--replicate-do-db&#x3D;test</li>
<li>--replicate-do-table&#x3D;test.t1</li>
<li>--replicate-wild-do-table&#x3D;test.t2</li>
</ul>
<p><em>黑名单：不执行黑名单中列出的库或者表的中继日志</em></p>
<ul>
<li>--replicate-ignore-db</li>
<li>--replicate-ignore-table</li>
<li>--replicate-wild-ignore-table</li>
</ul>
<p><strong>复制过滤配置：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db01</span> data]# vim <span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span>my.cnf  </span><br><span class="line">#在[mysqld]标签下添加  </span><br><span class="line">replicate<span class="operator">-</span>do<span class="operator">-</span>db<span class="operator">=</span>world  </span><br><span class="line">#关闭MySQL  </span><br><span class="line">mysqladmin <span class="operator">-</span>S <span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span>mysql.sock shutdown  </span><br><span class="line">#启动MySQL  </span><br><span class="line">mysqld_safe <span class="comment">--defaults-file=/data/3307/my.cnf &amp;</span></span><br></pre></td></tr></table></figure>

<p><strong>测试复制过滤：</strong></p>
<p><em>第一次测试：</em></p>
<p>1）主库：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db02</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123 <span class="operator">-</span>S <span class="operator">/</span>data<span class="operator">/</span><span class="number">3308</span><span class="operator">/</span>mysql.sock  </span><br><span class="line">mysql<span class="operator">&gt;</span> use world  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> t1(id <span class="type">int</span>);</span><br></pre></td></tr></table></figure>

<p>2）从库查看结果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db02</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123 <span class="operator">-</span>S <span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span>mysql.sock  </span><br><span class="line">mysql<span class="operator">&gt;</span> use world  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br></pre></td></tr></table></figure>

<p><em>第二次测试：</em></p>
<p>1）主库：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db02</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123 <span class="operator">-</span>S <span class="operator">/</span>data<span class="operator">/</span><span class="number">3308</span><span class="operator">/</span>mysql.sock  </span><br><span class="line">mysql<span class="operator">&gt;</span> use test  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> tb1(id <span class="type">int</span>);</span><br></pre></td></tr></table></figure>

<p>2）从库查看结果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@db02</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123 <span class="operator">-</span>S <span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span>mysql.sock  </span><br><span class="line">mysql<span class="operator">&gt;</span> use test  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="title-第十一章·-MHA高可用及读写分离url-https-blog-driverzeng-com-zenglaoshi-709-htmlclipped-at-2022-05-19-21-54-05category-defaulttags-无"><a href="#title-第十一章·-MHA高可用及读写分离url-https-blog-driverzeng-com-zenglaoshi-709-htmlclipped-at-2022-05-19-21-54-05category-defaulttags-无" class="headerlink" title="title: 第十一章· MHA高可用及读写分离url: https://blog.driverzeng.com/zenglaoshi/709.htmlclipped_at: 2022-05-19 21:54:05category: defaulttags: - 无"></a>title: 第十一章· MHA高可用及读写分离<br>url: <a target="_blank" rel="noopener" href="https://blog.driverzeng.com/zenglaoshi/709.html">https://blog.driverzeng.com/zenglaoshi/709.html</a><br>clipped_at: 2022-05-19 21:54:05<br>category: default<br>tags:<br> - 无</h2><h1 id="第十一章·-MHA高可用及读写分离"><a href="#第十一章·-MHA高可用及读写分离" class="headerlink" title="第十一章· MHA高可用及读写分离"></a>第十一章· MHA高可用及读写分离</h1><ul>
<li><a href="#toc_0">一.MHA简介</a></li>
<li><a href="#toc_1">二.工作流程</a></li>
<li><a href="#toc_2">三.MHA架构图</a></li>
<li><a href="#toc_3">四.MHA工具介绍</a></li>
<li><a href="#toc_4">五.基于GTID的主从复制</a></li>
<li><a href="#toc_5">六.部署MHA</a></li>
<li><a href="#toc_6">七.配置VIP漂移</a></li>
<li><a href="#toc_7">八.配置binlog-server</a></li>
<li><a href="#toc_8">九.MySQL中间件Atlas</a></li>
</ul>
<blockquote>
<p>曾志高翔, 江湖人称曾老大。多年互联网运维工作经验，曾负责过大规模集群架构自动化运维管理工作。擅长Web集群架构与自动化运维，曾负责国内某大型金融公司运维工作。<br>个人博客:”DBA老司机带你删库跑路”<br>笔者QQ:133411023、253097001<br>笔者交流群：198571640<br>笔者微信：z133411023</p>
</blockquote>
<h2 id="一-MHA简介"><a href="#一-MHA简介" class="headerlink" title="一.MHA简介"></a>一.MHA简介</h2><p><img src="/assets/1652968445-4de4cd252df102deddadefb3d242e21e.jpg">￼</p>
<p><strong>作者简介</strong></p>
<hr>
<p><strong>松信嘉範：</strong><br>MySQL&#x2F;Linux专家<br>2001年索尼公司入职<br>2001年开始使用oracle<br>2004年开始使用MySQL<br>2006年9月-2010年8月MySQL从事顾问<br>2010年-2012年 DeNA<br>2012年~至今 Facebook</p>
<hr>
<p><strong>软件简介</strong></p>
<p>MHA能够在较短的时间内实现自动故障检测和故障转移，通常在10-30秒以内;在复制框架中，MHA能够很好地解决复制过程中的数据一致性问题，由于不需要在现有的replication中添加额外的服务器，仅需要一个manager节点，而一个Manager能管理多套复制，所以能大大地节约服务器的数量;另外，安装简单，无性能损耗，以及不需要修改现有的复制部署也是它的优势之处。</p>
<p>MHA还提供在线主库切换的功能，能够安全地切换当前运行的主库到一个新的主库中(通过将从库提升为主库),大概0.5-2秒内即可完成。</p>
<p>MHA由两部分组成：MHA Manager（管理节点）和MHA Node（数据节点）。MHA Manager可以独立部署在一台独立的机器上管理多个Master-Slave集群，也可以部署在一台Slave上。<strong>当Master出现故障时，它可以自动将最新数据的Slave提升为新的Master,然后将所有其他的Slave重新指向新的Master。</strong>整个故障转移过程对应用程序是完全透明的。</p>
<h2 id="二-工作流程"><a href="#二-工作流程" class="headerlink" title="二.工作流程"></a>二.工作流程</h2><p>1)把宕机的master二进制日志保存下来。<br>2)找到binlog位置点最新的slave。<br>3)在binlog位置点最新的slave上用relay log（差异日志）修复其它slave。<br>4)将宕机的master上保存下来的二进制日志恢复到含有最新位置点的slave上。<br>5)将含有最新位置点binlog所在的slave提升为master。<br>6)将其它slave重新指向新提升的master，并开启主从复制。</p>
<h2 id="三-MHA架构图"><a href="#三-MHA架构图" class="headerlink" title="三.MHA架构图"></a>三.MHA架构图</h2><p><img src="/assets/1652968445-2dc5285c91fe9e98537ce1dc462b0486.jpg">￼</p>
<h2 id="四-MHA工具介绍"><a href="#四-MHA工具介绍" class="headerlink" title="四.MHA工具介绍"></a>四.MHA工具介绍</h2><p>MHA软件由两部分组成，Manager工具包和Node工具包，具体的说明如下：</p>
<p>Manager工具包主要包括以下几个工具：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">masterha_check_ssh #检查MHA的ssh<span class="operator">-</span>key  </span><br><span class="line">masterha_check_repl #检查主从复制情况  </span><br><span class="line">masterha_manger #启动MHA  </span><br><span class="line">masterha_check_status #检测MHA的运行状态  </span><br><span class="line">masterha_master_monitor #检测master是否宕机  </span><br><span class="line">masterha_master_switch #手动故障转移  </span><br><span class="line">masterha_conf_host #手动添加server信息  </span><br><span class="line">masterha_secondary_check #建立TCP连接从远程服务器  </span><br><span class="line">masterha_stop #停止MHA</span><br></pre></td></tr></table></figure>

<p>Node工具包主要包括以下几个工具：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">save_binary_logs #保存宕机的master的binlog  </span><br><span class="line">apply_diff_relay_logs #识别relay log的差异  </span><br><span class="line">filter_mysqlbinlog #防止回滚事件  </span><br><span class="line">purge_relay_logs #清除中继日志</span><br></pre></td></tr></table></figure>

<p><strong>MHA优点总结</strong></p>
<p>1）Masterfailover and slave promotion can be done very quickly<br>自动故障转移快</p>
<p>2）Mastercrash does not result in data inconsistency<br>主库崩溃不存在数据一致性问题</p>
<p>3）Noneed to modify current MySQL settings (MHA works with regular MySQL)<br>不需要对当前mysql环境做重大修改</p>
<p>4）Noneed to increase lots of servers<br>不需要添加额外的服务器(仅一台manager就可管理上百个replication)</p>
<p>5）Noperformance penalty<br>性能优秀，可工作在半同步复制和异步复制，当监控mysql状态时，仅需要每隔N秒向master发送ping包(默认3秒)，所以对性能无影响。你可以理解为MHA的性能和简单的主从复制框架性能一样。</p>
<p>6）Works with any storage engine<br>只要replication支持的存储引擎，MHA都支持，不会局限于innodb</p>
<p><strong>MySQL环境准备</strong></p>
<p>1）环境检查</p>
<p><em>mysql-db01</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">系统版本</span>  </span><br><span class="line">[root@mysql-db01 ~]# cat /etc/redhat-release  </span><br><span class="line">CentOS release 6.7 (Final)  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">内核版本</span>  </span><br><span class="line">[root@mysql-db01 ~]# uname -r  </span><br><span class="line">2.6.32-573.el6.x86_64  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">IP地址</span>  </span><br><span class="line">[root@mysql-db01 ~]# hostname -I  </span><br><span class="line">10.0.0.51</span><br></pre></td></tr></table></figure>

<p><em>mysql-db02</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">系统版本</span>  </span><br><span class="line">[root@mysql-db02 ~]# cat /etc/redhat-release  </span><br><span class="line">CentOS release 6.7 (Final)  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">内核版本</span>  </span><br><span class="line">[root@mysql-db02 ~]# uname -r  </span><br><span class="line">2.6.32-573.el6.x86_64  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">IP地址</span>  </span><br><span class="line">[root@mysql-db02 ~]# hostname -I  </span><br><span class="line">10.0.0.52</span><br></pre></td></tr></table></figure>

<p><em>mysql-db03</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#系统版本  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 <span class="operator">~</span>]# cat <span class="operator">/</span>etc<span class="operator">/</span>redhat<span class="operator">-</span><span class="keyword">release</span>  </span><br><span class="line">CentOS <span class="keyword">release</span> <span class="number">6.7</span> (<span class="keyword">Final</span>)  </span><br><span class="line">#内核版本  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 <span class="operator">~</span>]# uname <span class="operator">-</span>r  </span><br><span class="line"><span class="number">2.6</span><span class="number">.32</span><span class="number">-573.</span>el6.x86_64  </span><br><span class="line">#IP地址  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 <span class="operator">~</span>]# hostname <span class="operator">-</span>I  </span><br><span class="line"><span class="number">10.0</span><span class="number">.0</span><span class="number">.53</span></span><br></pre></td></tr></table></figure>

<p><strong>安装MySQL</strong></p>
<p>1）安装包准备</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#创建安装包存放目录  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# mkdir <span class="operator">/</span>home<span class="operator">/</span>oldboy<span class="operator">/</span>tools <span class="operator">-</span>p  </span><br><span class="line">#进入目录  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# cd <span class="operator">/</span>home<span class="operator">/</span>oldboy<span class="operator">/</span>tools<span class="operator">/</span>  </span><br><span class="line">#上传mysql安装包（mysql<span class="number">-5.6</span><span class="number">.16</span><span class="operator">-</span>linux<span class="operator">-</span>glibc2<span class="number">.5</span><span class="operator">-</span>x86_64.tar.gz）  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 tools]# rz <span class="operator">-</span>be</span><br></pre></td></tr></table></figure>

<p>2）安装</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#创建安装目录  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 tools]# mkdir <span class="operator">/</span>application  </span><br><span class="line">#解压mysql二进制包  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 tools]# tar xf mysql<span class="number">-5.6</span><span class="number">.16</span><span class="operator">-</span>linux<span class="operator">-</span>glibc2<span class="number">.5</span><span class="operator">-</span>x86_64.tar.gz  </span><br><span class="line">#移动安装包  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 tools]# mv mysql<span class="number">-5.6</span><span class="number">.16</span><span class="operator">-</span>linux<span class="operator">-</span>glibc2<span class="number">.5</span><span class="operator">-</span>x86_64 <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="number">-5.6</span><span class="number">.16</span>  </span><br><span class="line">#做软链接  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 tools]# ln <span class="operator">-</span>s <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="number">-5.6</span><span class="number">.16</span><span class="operator">/</span> <span class="operator">/</span>application<span class="operator">/</span>mysql  </span><br><span class="line">#创建mysql用户  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 tools]# useradd mysql <span class="operator">-</span>s <span class="operator">/</span>sbin<span class="operator">/</span>nologin <span class="operator">-</span>M  </span><br><span class="line">#进入mysql初始化目录  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 tools]# cd <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>scripts<span class="operator">/</span>  </span><br><span class="line">#初始化mysql  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 scripts]# .<span class="operator">/</span>mysql_install_db \  </span><br><span class="line"><span class="comment">--user=mysql \  </span></span><br><span class="line"><span class="comment">--datadir=/application/mysql/data/ \  </span></span><br><span class="line"><span class="comment">--basedir=/application/mysql/  </span></span><br><span class="line">#注解  </span><br><span class="line"><span class="comment">--user： 指定mysql用户  </span></span><br><span class="line"><span class="comment">--datadir：指定mysql数据存放目录  </span></span><br><span class="line"><span class="comment">--basedir：指定mysql base目录  </span></span><br><span class="line">#拷贝mysql配置文件  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# \cp <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>support<span class="operator">-</span>files<span class="operator">/</span>my<span class="operator">-</span>default.cnf <span class="operator">/</span>etc<span class="operator">/</span>my.cnf  </span><br><span class="line">#拷贝mysql启动脚本  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# cp <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>support<span class="operator">-</span>files<span class="operator">/</span>mysql.server <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld  </span><br><span class="line">#修改mysql默认安装目录（否则无法启动）  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# sed <span class="operator">-</span>i <span class="string">&#x27;s#/usr/local#/application#g&#x27;</span> <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# sed <span class="operator">-</span>i <span class="string">&#x27;s#/usr/local#/application#g&#x27;</span> <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysqld_safe  </span><br><span class="line">#配置mysql环境变量  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# echo <span class="string">&#x27;export PATH=&quot;/application/mysql/bin:$PATH&quot;&#x27;</span> <span class="operator">&gt;&gt;</span> <span class="operator">/</span>etc<span class="operator">/</span>profile.d<span class="operator">/</span>mysql.sh  </span><br><span class="line">#刷新环境变量  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# source <span class="operator">/</span>etc<span class="operator">/</span>profile  </span><br><span class="line"><span class="number">2.2</span><span class="number">.3</span>启动  </span><br><span class="line">#加入开机自启  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# chkconfig mysqld <span class="keyword">on</span>  </span><br><span class="line">#启动mysql  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld <span class="keyword">start</span>  </span><br><span class="line">Starting MySQL........... SUCCESS<span class="operator">!</span> #启动成功  </span><br><span class="line"><span class="number">2.2</span><span class="number">.4</span>配置密码  </span><br><span class="line">#配置mysql密码为oldboy123  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# mysqladmin <span class="operator">-</span>uroot password oldboy123</span><br></pre></td></tr></table></figure>

<h2 id="五-基于GTID的主从复制"><a href="#五-基于GTID的主从复制" class="headerlink" title="五.基于GTID的主从复制"></a>五.基于GTID的主从复制</h2><blockquote>
<p>先决条件<br>1）主库和从库都要开启binlog<br>2）主库和从库server-id不同<br>3）要有主从复制用户</p>
</blockquote>
<p><strong>主库操作</strong></p>
<p><em>修改配置文件</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#编辑mysql配置文件  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf  </span><br><span class="line">#在mysqld标签下配置  </span><br><span class="line">[mysqld]  </span><br><span class="line">#主库server<span class="operator">-</span>id为<span class="number">1</span>，从库不等于<span class="number">1</span>  </span><br><span class="line">server_id <span class="operator">=</span><span class="number">1</span>  </span><br><span class="line">#开启binlog日志  </span><br><span class="line">log_bin<span class="operator">=</span>mysql<span class="operator">-</span>bin</span><br></pre></td></tr></table></figure>

<p><em>创建主从复制用户</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#登录数据库  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>poldboy123  </span><br><span class="line">#创建rep用户  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> replication slave <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> rep@<span class="string">&#x27;10.0.0.%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;oldboy123&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>从库操作</strong></p>
<p><em>修改配置文件</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#修改mysql<span class="operator">-</span>db02配置文件  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db02 <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf  </span><br><span class="line">#在mysqld标签下配置  </span><br><span class="line">[mysqld]  </span><br><span class="line">#主库server<span class="operator">-</span>id为<span class="number">1</span>，从库必须大于<span class="number">1</span>  </span><br><span class="line">server_id <span class="operator">=</span><span class="number">5</span>  </span><br><span class="line">#开启binlog日志  </span><br><span class="line">log_bin<span class="operator">=</span>mysql<span class="operator">-</span>bin  </span><br><span class="line">#重启mysql  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db02 <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld restart  </span><br><span class="line">#修改mysql<span class="operator">-</span>db03配置文件  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf  </span><br><span class="line">#在mysqld标签下配置  </span><br><span class="line">[mysqld]  </span><br><span class="line">#主库server<span class="operator">-</span>id为<span class="number">1</span>，从库必须大于<span class="number">1</span>  </span><br><span class="line">server_id <span class="operator">=</span><span class="number">10</span>  </span><br><span class="line">#开启binlog日志  </span><br><span class="line">log_bin<span class="operator">=</span>mysql<span class="operator">-</span>bin  </span><br><span class="line">#重启mysql  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld restart</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>注：在以往如果是基于binlog日志的主从复制，则必须要记住主库的master状态信息。</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;  </span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+  </span></span><br><span class="line"><span class="operator">|</span> File <span class="operator">|</span> Position <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+  </span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span> <span class="number">120</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br></pre></td></tr></table></figure>

<hr>
<p><em>开启GTID</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#没开启之前先看一下GTID的状态  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> variables <span class="keyword">like</span> <span class="string">&#x27;%gtid%&#x27;</span>;  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-------+  </span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-------+  </span></span><br><span class="line"><span class="operator">|</span> enforce_gtid_consistency <span class="operator">|</span> OFF <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> gtid_executed <span class="operator">|</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> gtid_mode <span class="operator">|</span> OFF <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> gtid_owned <span class="operator">|</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> gtid_purged <span class="operator">|</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-------+  </span></span><br><span class="line">#编辑mysql配置文件（主库从库都需要修改）  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf  </span><br><span class="line">#在[mysqld]标签下添加  </span><br><span class="line">[mysqld]  </span><br><span class="line">gtid_mode<span class="operator">=</span><span class="keyword">ON</span>  </span><br><span class="line">log_slave_updates  </span><br><span class="line">enforce_gtid_consistency  </span><br><span class="line">#重启数据库  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld restart  </span><br><span class="line">#检查GTID状态  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> variables <span class="keyword">like</span> <span class="string">&#x27;%gtid%&#x27;</span>;  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-------+  </span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-------+  </span></span><br><span class="line"><span class="operator">|</span> enforce_gtid_consistency <span class="operator">|</span> <span class="keyword">ON</span> <span class="operator">|</span> #执行GTID一致  </span><br><span class="line"><span class="operator">|</span> gtid_executed <span class="operator">|</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> gtid_mode <span class="operator">|</span> <span class="keyword">ON</span> <span class="operator">|</span> #开启GTID模块  </span><br><span class="line"><span class="operator">|</span> gtid_owned <span class="operator">|</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> gtid_purged <span class="operator">|</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-------+</span></span><br></pre></td></tr></table></figure>

<p><strong>注：主库从库都需要开启GTID否则在做主从复制的时候就会报错：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db02 <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>poldboy123  </span><br><span class="line">mysql<span class="operator">&gt;</span> change master <span class="keyword">to</span>  </span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> master_host<span class="operator">=</span><span class="string">&#x27;10.0.0.51&#x27;</span>,  </span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> master_user<span class="operator">=</span><span class="string">&#x27;rep&#x27;</span>,  </span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> master_password<span class="operator">=</span><span class="string">&#x27;oldboy123&#x27;</span>,  </span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> master_auto_position<span class="operator">=</span><span class="number">1</span>;  </span><br><span class="line">ERROR <span class="number">1777</span> (HY000): CHANGE MASTER <span class="keyword">TO</span> MASTER_AUTO_POSITION <span class="operator">=</span> <span class="number">1</span> can <span class="keyword">only</span> be executed <span class="keyword">when</span> @<span class="variable">@GLOBAL</span>.GTID_MODE <span class="operator">=</span> ON.</span><br></pre></td></tr></table></figure>

<p><em>配置主从复制</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#登录数据库  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db02 <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>poldboy123  </span><br><span class="line">#配置复制主机信息  </span><br><span class="line">mysql<span class="operator">&gt;</span> change master <span class="keyword">to</span>  </span><br><span class="line">#主库IP  </span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> master_host<span class="operator">=</span><span class="string">&#x27;10.0.0.51&#x27;</span>,  </span><br><span class="line">#主库复制用户  </span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> master_user<span class="operator">=</span><span class="string">&#x27;rep&#x27;</span>,  </span><br><span class="line">#主库复制用户的密码  </span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> master_password<span class="operator">=</span><span class="string">&#x27;oldboy123&#x27;</span>,  </span><br><span class="line">#GTID位置点  </span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> master_auto_position<span class="operator">=</span><span class="number">1</span>;  </span><br><span class="line">#开启slave  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> slave;  </span><br><span class="line">#查看slave状态  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G  </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span>  </span><br><span class="line">Slave_IO_State: Waiting <span class="keyword">for</span> master <span class="keyword">to</span> send event  </span><br><span class="line">Master_Host: <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>  </span><br><span class="line">Master_User: rep  </span><br><span class="line">Master_Port: <span class="number">3306</span>  </span><br><span class="line">Connect_Retry: <span class="number">60</span>  </span><br><span class="line">Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000003</span>  </span><br><span class="line">Read_Master_Log_Pos: <span class="number">403</span>  </span><br><span class="line">Relay_Log_File: mysql<span class="operator">-</span>db02<span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000002</span>  </span><br><span class="line">Relay_Log_Pos: <span class="number">613</span>  </span><br><span class="line">Relay_Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000003</span>  </span><br><span class="line">Slave_IO_Running: Yes  </span><br><span class="line">Slave_SQL_Running: Yes  </span><br><span class="line">Replicate_Do_DB:  </span><br><span class="line">Replicate_Ignore_DB:  </span><br><span class="line">Replicate_Do_Table:  </span><br><span class="line">Replicate_Ignore_Table:  </span><br><span class="line">Replicate_Wild_Do_Table:  </span><br><span class="line">Replicate_Wild_Ignore_Table:  </span><br><span class="line">Last_Errno: <span class="number">0</span>  </span><br><span class="line">Last_Error:  </span><br><span class="line">Skip_Counter: <span class="number">0</span>  </span><br><span class="line">Exec_Master_Log_Pos: <span class="number">403</span>  </span><br><span class="line">Relay_Log_Space: <span class="number">822</span>  </span><br><span class="line">Until_Condition: <span class="keyword">None</span></span><br></pre></td></tr></table></figure>

<p><em>从库设置</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#登录从库  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db02 <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>poldboy123  </span><br><span class="line">#禁用自动删除relay log 功能  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> relay_log_purge <span class="operator">=</span> <span class="number">0</span>;  </span><br><span class="line">#设置只读  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> read_only<span class="operator">=</span><span class="number">1</span>;  </span><br><span class="line">#编辑配置文件  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db02 <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf  </span><br><span class="line">#在mysqld标签下添加  </span><br><span class="line">[mysqld]  </span><br><span class="line">#禁用自动删除relay log 永久生效  </span><br><span class="line">relay_log_purge <span class="operator">=</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h2 id="六-部署MHA"><a href="#六-部署MHA" class="headerlink" title="六.部署MHA"></a>六.部署MHA</h2><p>1）环境准备（所有节点）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#安装依赖包  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# yum install perl<span class="operator">-</span>DBD<span class="operator">-</span>MySQL <span class="operator">-</span>y  </span><br><span class="line">#进入安装包存放目录  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# cd <span class="operator">/</span>home<span class="operator">/</span>oldboy<span class="operator">/</span>tools<span class="operator">/</span>  </span><br><span class="line">#上传mha安装包  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 tools]# rz <span class="operator">-</span>be  </span><br><span class="line">mha4mysql<span class="operator">-</span>manager<span class="number">-0.56</span><span class="number">-0.</span>el6.noarch.rpm  </span><br><span class="line">mha4mysql<span class="operator">-</span>manager<span class="number">-0.56</span>.tar.gz  </span><br><span class="line">mha4mysql<span class="operator">-</span>node<span class="number">-0.56</span><span class="number">-0.</span>el6.noarch.rpm  </span><br><span class="line">mha4mysql<span class="operator">-</span>node<span class="number">-0.56</span>.tar.gz  </span><br><span class="line">#安装node包  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 tools]# rpm <span class="operator">-</span>ivh mha4mysql<span class="operator">-</span>node<span class="number">-0.56</span><span class="number">-0.</span>el6.noarch.rpm  </span><br><span class="line">Preparing... ########################################### [<span class="number">100</span><span class="operator">%</span>]  </span><br><span class="line"><span class="number">1</span>:mha4mysql<span class="operator">-</span>node ########################################### [<span class="number">100</span><span class="operator">%</span>]  </span><br><span class="line">#登录数据库  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 tools]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>poldboy123  </span><br><span class="line">#添加mha管理账号  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> <span class="keyword">all</span> privileges <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> mha@<span class="string">&#x27;10.0.0.%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;mha&#x27;</span>;  </span><br><span class="line">#查看是否添加成功  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">user</span>,host <span class="keyword">from</span> mysql.user;  </span><br><span class="line">#主库上创建，从库会自动复制（在从库上查看）  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">user</span>,host <span class="keyword">from</span> mysql.user;</span><br></pre></td></tr></table></figure>

<p><em>命令软连接（所有节点）</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#如果不创建命令软连接，检测mha复制情况的时候会报错  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# ln <span class="operator">-</span>s <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# ln <span class="operator">-</span>s <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysql <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysql</span><br></pre></td></tr></table></figure>

<p><em>部署管理节点（mha-manager:mysql-db03）</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#使用epel源  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 <span class="operator">~</span>]# wget <span class="operator">-</span>O <span class="operator">/</span>etc<span class="operator">/</span>yum.repos.d<span class="operator">/</span>epel.repo https:<span class="operator">/</span><span class="operator">/</span>mirrors.aliyun.com<span class="operator">/</span>repo<span class="operator">/</span>epel<span class="number">-6.</span>repo  </span><br><span class="line">#安装manager依赖包  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 <span class="operator">~</span>]# yum install <span class="operator">-</span>y perl<span class="operator">-</span>Config<span class="operator">-</span>Tiny epel<span class="operator">-</span><span class="keyword">release</span> perl<span class="operator">-</span>Log<span class="operator">-</span>Dispatch perl<span class="operator">-</span>Parallel<span class="operator">-</span>ForkManager perl<span class="operator">-</span><span class="type">Time</span><span class="operator">-</span>HiRes  </span><br><span class="line">#安装manager包  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 tools]# rpm <span class="operator">-</span>ivh mha4mysql<span class="operator">-</span>manager<span class="number">-0.56</span><span class="number">-0.</span>el6.noarch.rpm  </span><br><span class="line">Preparing... ########################################### [<span class="number">100</span><span class="operator">%</span>]  </span><br><span class="line"><span class="number">1</span>:mha4mysql<span class="operator">-</span>manager ########################################### [<span class="number">100</span><span class="operator">%</span>]</span><br></pre></td></tr></table></figure>

<p><em>编辑配置文件</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#创建配置文件目录  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 <span class="operator">~</span>]# mkdir <span class="operator">-</span>p <span class="operator">/</span>etc<span class="operator">/</span>mha  </span><br><span class="line">#创建日志目录  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 <span class="operator">~</span>]# mkdir <span class="operator">-</span>p <span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>mha<span class="operator">/</span>app1  </span><br><span class="line">#编辑mha配置文件  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>app1.cnf  </span><br><span class="line">[server <span class="keyword">default</span>]  </span><br><span class="line">manager_log<span class="operator">=</span><span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>mha<span class="operator">/</span>app1<span class="operator">/</span>manager  </span><br><span class="line">manager_workdir<span class="operator">=</span><span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>mha<span class="operator">/</span>app1  </span><br><span class="line">master_binlog_dir<span class="operator">=</span><span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data  </span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mha  </span><br><span class="line">password<span class="operator">=</span>mha  </span><br><span class="line">ping_interval<span class="operator">=</span><span class="number">2</span>  </span><br><span class="line">repl_password<span class="operator">=</span>oldboy123  </span><br><span class="line">repl_user<span class="operator">=</span>rep  </span><br><span class="line">ssh_user<span class="operator">=</span>root  </span><br><span class="line">[server1]  </span><br><span class="line">hostname<span class="operator">=</span><span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>  </span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span>  </span><br><span class="line">[server2]  </span><br><span class="line">candidate_master<span class="operator">=</span><span class="number">1</span>  </span><br><span class="line">check_repl_delay<span class="operator">=</span><span class="number">0</span>  </span><br><span class="line">hostname<span class="operator">=</span><span class="number">10.0</span><span class="number">.0</span><span class="number">.52</span>  </span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span>  </span><br><span class="line">[server3]  </span><br><span class="line">hostname<span class="operator">=</span><span class="number">10.0</span><span class="number">.0</span><span class="number">.53</span>  </span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br></pre></td></tr></table></figure>

<p><strong>配置文件详解</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[server <span class="keyword">default</span>]  </span><br><span class="line">#设置manager的工作目录  </span><br><span class="line">manager_workdir<span class="operator">=</span><span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>masterha<span class="operator">/</span>app1  </span><br><span class="line">#设置manager的日志  </span><br><span class="line">manager_log<span class="operator">=</span><span class="operator">/</span>var<span class="operator">/</span>log<span class="operator">/</span>masterha<span class="operator">/</span>app1<span class="operator">/</span>manager.log  </span><br><span class="line">#设置master 保存binlog的位置，以便MHA可以找到master的日志，我这里的也就是mysql的数据目录  </span><br><span class="line">master_binlog_dir<span class="operator">=</span><span class="operator">/</span>data<span class="operator">/</span>mysql  </span><br><span class="line">#设置自动failover时候的切换脚本  </span><br><span class="line">master_ip_failover_script<span class="operator">=</span> <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>bin<span class="operator">/</span>master_ip_failover  </span><br><span class="line">#设置手动切换时候的切换脚本  </span><br><span class="line">master_ip_online_change_script<span class="operator">=</span> <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>bin<span class="operator">/</span>master_ip_online_change  </span><br><span class="line">#设置mysql中root用户的密码，这个密码是前文中创建监控用户的那个密码  </span><br><span class="line">password<span class="operator">=</span><span class="number">123456</span>  </span><br><span class="line">#设置监控用户root  </span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>root  </span><br><span class="line">#设置监控主库，发送ping包的时间间隔，尝试三次没有回应的时候自动进行failover  </span><br><span class="line">ping_interval<span class="operator">=</span><span class="number">1</span>  </span><br><span class="line">#设置远端mysql在发生切换时binlog的保存位置  </span><br><span class="line">remote_workdir<span class="operator">=</span><span class="operator">/</span>tmp  </span><br><span class="line">#设置复制用户的密码  </span><br><span class="line">repl_password<span class="operator">=</span><span class="number">123456</span>  </span><br><span class="line">#设置复制环境中的复制用户名  </span><br><span class="line">repl_user<span class="operator">=</span>rep  </span><br><span class="line">#设置发生切换后发送的报警的脚本  </span><br><span class="line">report_script<span class="operator">=</span><span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>send_report  </span><br><span class="line">#一旦MHA到server02的监控之间出现问题，MHA Manager将会尝试从server03登录到server02  </span><br><span class="line">secondary_check_script<span class="operator">=</span> <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>bin<span class="operator">/</span>masterha_secondary_check <span class="operator">-</span>s server03 <span class="operator">-</span>s server02 <span class="comment">--user=root --master_host=server02 --master_ip=192.168.0.50 --master_port=3306  </span></span><br><span class="line">#设置故障发生后关闭故障主机脚本（该脚本的主要作用是关闭主机放在发生脑裂,这里没有使用）  </span><br><span class="line">shutdown_script<span class="operator">=</span>&quot;&quot;  </span><br><span class="line">#设置ssh的登录用户名  </span><br><span class="line">ssh_user<span class="operator">=</span>root  </span><br><span class="line">[server1]  </span><br><span class="line">hostname<span class="operator">=</span><span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>  </span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span>  </span><br><span class="line">[server2]  </span><br><span class="line">hostname<span class="operator">=</span><span class="number">10.0</span><span class="number">.0</span><span class="number">.52</span>  </span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span>  </span><br><span class="line">#设置为候选master，如果设置该参数以后，发生主从切换以后将会将此从库提升为主库，即使这个主库不是集群中事件最新的slave。  </span><br><span class="line">candidate_master<span class="operator">=</span><span class="number">1</span>  </span><br><span class="line">#默认情况下如果一个slave落后master <span class="number">100</span>M的relay logs的话，MHA将不会选择该slave作为一个新的master，因为对于这个slave的恢复需要花费很长时间，通过设置check_repl_delay<span class="operator">=</span><span class="number">0</span>,MHA触发切换在选择一个新的master的时候将会忽略复制延时，这个参数对于设置了candidate_master<span class="operator">=</span><span class="number">1</span>的主机非常有用，因为这个候选主在切换的过程中一定是新的master  </span><br><span class="line">check_repl_delay<span class="operator">=</span><span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><em>配置ssh信任（所有节点）</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#创建秘钥对  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# ssh<span class="operator">-</span>keygen <span class="operator">-</span>t dsa <span class="operator">-</span>P <span class="string">&#x27;&#x27;</span> <span class="operator">-</span>f <span class="operator">~</span><span class="operator">/</span>.ssh<span class="operator">/</span>id_dsa <span class="operator">&gt;</span><span class="operator">/</span>dev<span class="operator">/</span><span class="keyword">null</span> <span class="number">2</span><span class="operator">&gt;</span><span class="operator">&amp;</span><span class="number">1</span>  </span><br><span class="line">#发送公钥，包括自己  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="operator">-</span>i <span class="operator">/</span>root<span class="operator">/</span>.ssh<span class="operator">/</span>id_dsa.pub root<span class="variable">@10</span><span class="number">.0</span><span class="number">.0</span><span class="number">.51</span>  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="operator">-</span>i <span class="operator">/</span>root<span class="operator">/</span>.ssh<span class="operator">/</span>id_dsa.pub root<span class="variable">@10</span><span class="number">.0</span><span class="number">.0</span><span class="number">.52</span>  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="operator">-</span>i <span class="operator">/</span>root<span class="operator">/</span>.ssh<span class="operator">/</span>id_dsa.pub root<span class="variable">@10</span><span class="number">.0</span><span class="number">.0</span><span class="number">.53</span></span><br></pre></td></tr></table></figure>

<p><em>启动测试</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#测试ssh  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 <span class="operator">~</span>]# masterha_check_ssh <span class="comment">--conf=/etc/mha/app1.cnf  </span></span><br><span class="line">#看到如下字样，则测试成功  </span><br><span class="line">Tue Mar <span class="number">7</span> <span class="number">01</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2017</span> <span class="operator">-</span> [info] <span class="keyword">All</span> SSH connection tests passed successfully.  </span><br><span class="line">#测试复制  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 <span class="operator">~</span>]# masterha_check_repl <span class="comment">--conf=/etc/mha/app1.cnf  </span></span><br><span class="line">#看到如下字样，则测试成功  </span><br><span class="line">MySQL Replication Health <span class="keyword">is</span> OK.</span><br></pre></td></tr></table></figure>

<p><em>启动MHA</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#启动  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 <span class="operator">~</span>]# nohup masterha_manager <span class="comment">--conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt; /dev/null &gt; /var/log/mha/app1/manager.log 2&gt;&amp;1 &amp;</span></span><br></pre></td></tr></table></figure>

<p><em>切换master测试</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">#登录数据库（db02）  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db02 <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>poldboy123  </span><br><span class="line">#检查复制情况  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G  </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span>  </span><br><span class="line">Slave_IO_State: Waiting <span class="keyword">for</span> master <span class="keyword">to</span> send event  </span><br><span class="line">Master_Host: <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>  </span><br><span class="line">Master_User: rep  </span><br><span class="line">Master_Port: <span class="number">3306</span>  </span><br><span class="line">Connect_Retry: <span class="number">60</span>  </span><br><span class="line">Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000006</span>  </span><br><span class="line">Read_Master_Log_Pos: <span class="number">191</span>  </span><br><span class="line">Relay_Log_File: mysql<span class="operator">-</span>db02<span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000002</span>  </span><br><span class="line">Relay_Log_Pos: <span class="number">361</span>  </span><br><span class="line">Relay_Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000006</span>  </span><br><span class="line">Slave_IO_Running: Yes  </span><br><span class="line">Slave_SQL_Running: Yes  </span><br><span class="line">#登录数据库（db03）  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>poldboy123  </span><br><span class="line">#检查复制情况  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G  </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span>  </span><br><span class="line">Slave_IO_State: Waiting <span class="keyword">for</span> master <span class="keyword">to</span> send event  </span><br><span class="line">Master_Host: <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>  </span><br><span class="line">Master_User: rep  </span><br><span class="line">Master_Port: <span class="number">3306</span>  </span><br><span class="line">Connect_Retry: <span class="number">60</span>  </span><br><span class="line">Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000006</span>  </span><br><span class="line">Read_Master_Log_Pos: <span class="number">191</span>  </span><br><span class="line">Relay_Log_File: mysql<span class="operator">-</span>db03<span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000002</span>  </span><br><span class="line">Relay_Log_Pos: <span class="number">361</span>  </span><br><span class="line">Relay_Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000006</span>  </span><br><span class="line">Slave_IO_Running: Yes  </span><br><span class="line">Slave_SQL_Running: Yes  </span><br><span class="line">  </span><br><span class="line">#停掉主库  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld stop  </span><br><span class="line">Shutting down MySQL..... SUCCESS<span class="operator">!</span>  </span><br><span class="line">#登录数据库（db02）  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db02 <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>poldboy123  </span><br><span class="line">#查看slave状态  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G  </span><br><span class="line">#db02的slave已经为空  </span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)  </span><br><span class="line">#登录数据库（db03）  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>poldboy123  </span><br><span class="line">#查看slave状态  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G  </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span>  </span><br><span class="line">Slave_IO_State: Waiting <span class="keyword">for</span> master <span class="keyword">to</span> send event  </span><br><span class="line">Master_Host: <span class="number">10.0</span><span class="number">.0</span><span class="number">.52</span>  </span><br><span class="line">Master_User: rep  </span><br><span class="line">Master_Port: <span class="number">3306</span>  </span><br><span class="line">Connect_Retry: <span class="number">60</span>  </span><br><span class="line">Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000006</span>  </span><br><span class="line">Read_Master_Log_Pos: <span class="number">191</span>  </span><br><span class="line">Relay_Log_File: mysql<span class="operator">-</span>db03<span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000002</span>  </span><br><span class="line">Relay_Log_Pos: <span class="number">361</span>  </span><br><span class="line">Relay_Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000006</span>  </span><br><span class="line">Slave_IO_Running: Yes  </span><br><span class="line">Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>

<h2 id="七-配置VIP漂移"><a href="#七-配置VIP漂移" class="headerlink" title="七.配置VIP漂移"></a>七.配置VIP漂移</h2><blockquote>
<p>VIP漂移的两种方式<br>1）通过keepalived的方式，管理虚拟IP的漂移<br>2）通过MHA自带脚本方式，管理虚拟IP的漂移</p>
</blockquote>
<p><strong>MHA脚本方式</strong></p>
<p><em>修改配置文件</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#编辑配置文件  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>app1.cnf  </span><br><span class="line">#在[server <span class="keyword">default</span>]标签下添加  </span><br><span class="line">[server <span class="keyword">default</span>]  </span><br><span class="line">#使用MHA自带脚本  </span><br><span class="line">master_ip_failover_script<span class="operator">=</span><span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>bin<span class="operator">/</span>master_ip_failover</span><br></pre></td></tr></table></figure>

<p><em>编辑脚本</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#根据配置文件中脚本路径编辑  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>master_ip_failover  </span><br><span class="line">#修改以下几行内容  </span><br><span class="line">my $vip <span class="operator">=</span> <span class="string">&#x27;10.0.0.55/24&#x27;</span>;  </span><br><span class="line">my $key <span class="operator">=</span> <span class="string">&#x27;0&#x27;</span>;  </span><br><span class="line">my $ssh_start_vip <span class="operator">=</span> &quot;/sbin/ifconfig eth0:$key $vip&quot;;  </span><br><span class="line">my $ssh_stop_vip <span class="operator">=</span> &quot;/sbin/ifconfig eth0:$key down&quot;;  </span><br><span class="line">#添加执行权限，否则mha无法启动  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 <span class="operator">~</span>]# chmod <span class="operator">+</span>x <span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>master_ip_failover</span><br></pre></td></tr></table></figure>

<p><em>手动绑定VIP</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#绑定vip  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# ifconfig eth0:<span class="number">0</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.55</span><span class="operator">/</span><span class="number">24</span>  </span><br><span class="line">#查看vip  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# ip a <span class="operator">|</span>grep eth0  </span><br><span class="line"><span class="number">2</span>: eth0: mtu <span class="number">1500</span> qdisc pfifo_fast state UP qlen <span class="number">1000</span>  </span><br><span class="line">inet <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span><span class="operator">/</span><span class="number">24</span> brd <span class="number">10.0</span><span class="number">.0</span><span class="number">.255</span> <span class="keyword">scope</span> <span class="keyword">global</span> eth0  </span><br><span class="line">inet <span class="number">10.0</span><span class="number">.0</span><span class="number">.55</span><span class="operator">/</span><span class="number">24</span> brd <span class="number">10.0</span><span class="number">.0</span><span class="number">.255</span> <span class="keyword">scope</span> <span class="keyword">global</span> secondary eth0:<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><em>测试ip漂移</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#登录db02  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db02 <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>poldboy123  </span><br><span class="line">#查看slave信息  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G  </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span>  </span><br><span class="line">Slave_IO_State: Waiting <span class="keyword">for</span> master <span class="keyword">to</span> send event  </span><br><span class="line">Master_Host: <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>  </span><br><span class="line">Master_User: rep  </span><br><span class="line">Master_Port: <span class="number">3306</span>  </span><br><span class="line">Connect_Retry: <span class="number">60</span>  </span><br><span class="line">Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000007</span>  </span><br><span class="line">Read_Master_Log_Pos: <span class="number">191</span>  </span><br><span class="line">Relay_Log_File: mysql<span class="operator">-</span>db02<span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000002</span>  </span><br><span class="line">Relay_Log_Pos: <span class="number">361</span>  </span><br><span class="line">Relay_Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000007</span>  </span><br><span class="line">Slave_IO_Running: Yes  </span><br><span class="line">Slave_SQL_Running: Yes  </span><br><span class="line">#停掉主库  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld stop  </span><br><span class="line">Shutting down MySQL..... SUCCESS<span class="operator">!</span>  </span><br><span class="line">#在db03上查看从库slave信息  </span><br><span class="line">  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G  </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span>  </span><br><span class="line">Slave_IO_State: Waiting <span class="keyword">for</span> master <span class="keyword">to</span> send event  </span><br><span class="line">Master_Host: <span class="number">10.0</span><span class="number">.0</span><span class="number">.52</span>  </span><br><span class="line">Master_User: rep  </span><br><span class="line">Master_Port: <span class="number">3306</span>  </span><br><span class="line">Connect_Retry: <span class="number">60</span>  </span><br><span class="line">Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000006</span>  </span><br><span class="line">Read_Master_Log_Pos: <span class="number">191</span>  </span><br><span class="line">Relay_Log_File: mysql<span class="operator">-</span>db03<span class="operator">-</span>relay<span class="operator">-</span>bin<span class="number">.000002</span>  </span><br><span class="line">Relay_Log_Pos: <span class="number">361</span>  </span><br><span class="line">Relay_Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.000006</span>  </span><br><span class="line">Slave_IO_Running: Yes  </span><br><span class="line">Slave_SQL_Running: Yes  </span><br><span class="line">#在db01上查看vip信息  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# ip a <span class="operator">|</span>grep eth0  </span><br><span class="line"><span class="number">2</span>: eth0: mtu <span class="number">1500</span> qdisc pfifo_fast state UP qlen <span class="number">1000</span>  </span><br><span class="line">inet <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span><span class="operator">/</span><span class="number">24</span> brd <span class="number">10.0</span><span class="number">.0</span><span class="number">.255</span> <span class="keyword">scope</span> <span class="keyword">global</span> eth0  </span><br><span class="line">#在db02上查看vip信息  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db02 <span class="operator">~</span>]# ip a <span class="operator">|</span>grep eth0  </span><br><span class="line"><span class="number">2</span>: eth0: mtu <span class="number">1500</span> qdisc pfifo_fast state UP qlen <span class="number">1000</span>  </span><br><span class="line">inet <span class="number">10.0</span><span class="number">.0</span><span class="number">.52</span><span class="operator">/</span><span class="number">24</span> brd <span class="number">10.0</span><span class="number">.0</span><span class="number">.255</span> <span class="keyword">scope</span> <span class="keyword">global</span> eth0  </span><br><span class="line">inet <span class="number">10.0</span><span class="number">.0</span><span class="number">.55</span><span class="operator">/</span><span class="number">24</span> brd <span class="number">10.0</span><span class="number">.0</span><span class="number">.255</span> <span class="keyword">scope</span> <span class="keyword">global</span> secondary eth0:<span class="number">0</span></span><br></pre></td></tr></table></figure>

<h2 id="八-配置binlog-server"><a href="#八-配置binlog-server" class="headerlink" title="八.配置binlog-server"></a>八.配置binlog-server</h2><p><em>修改mha配置文件</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>app1.cnf  </span><br><span class="line">[binlog1]  </span><br><span class="line">no_master<span class="operator">=</span><span class="number">1</span>  </span><br><span class="line">hostname<span class="operator">=</span><span class="number">10.0</span><span class="number">.0</span><span class="number">.53</span>  </span><br><span class="line">master_binlog_dir<span class="operator">=</span><span class="operator">/</span>data<span class="operator">/</span>mysql<span class="operator">/</span>binlog<span class="operator">/</span></span><br></pre></td></tr></table></figure>

<p><em>备份binlog</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#创建备份binlog目录  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 <span class="operator">~</span>]# mkdir <span class="operator">-</span>p <span class="operator">/</span>data<span class="operator">/</span>mysql<span class="operator">/</span>binlog<span class="operator">/</span>  </span><br><span class="line">#进入该目录  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 <span class="operator">~</span>]# cd <span class="operator">/</span>data<span class="operator">/</span>mysql<span class="operator">/</span>binlog<span class="operator">/</span>  </span><br><span class="line">#备份binlog  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 binlog]# mysqlbinlog <span class="operator">-</span>R <span class="comment">--host=10.0.0.51 --user=mha --password=mha --raw --stop-never mysql-bin.000001 &amp;  </span></span><br><span class="line">#启动mha  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 binlog]# nohup masterha_manager <span class="comment">--conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt; /dev/null &gt; /var/log/mha/app1/manager.log 2&gt;&amp;1 &amp;</span></span><br></pre></td></tr></table></figure>

<p><em>测试binlog备份</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#查看binlog目录中的binlog  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 binlog]# ll  </span><br><span class="line">total <span class="number">44</span>  </span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r-- 1 root root 285 Mar 8 03:11 mysql-bin.000001  </span></span><br><span class="line">#登录主库  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>poldboy123  </span><br><span class="line">#刷新binlog  </span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;  </span><br><span class="line">#再次查看binlog目录  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 binlog]# ll  </span><br><span class="line">total <span class="number">48</span>  </span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r-- 1 root root 285 Mar 8 03:11 mysql-bin.000001  </span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r-- 1 root root 143 Mar 8 04:00 mysql-bin.000002</span></span><br></pre></td></tr></table></figure>

<h2 id="九-MySQL中间件Atlas"><a href="#九-MySQL中间件Atlas" class="headerlink" title="九.MySQL中间件Atlas"></a>九.MySQL中间件Atlas</h2><p><strong>Atlas简介</strong></p>
<p>Atlas是由 Qihoo 360公司Web平台部基础架构团队开发维护的一个基于MySQL协议的数据中间层项目。它在MySQL官方推出的MySQL-Proxy 0.8.2版本的基础上，修改了大量bug，添加了很多功能特性。它在MySQL官方推出的MySQL-Proxy 0.8.2版本的基础上，修改了大量bug，添加了很多功能特性。</p>
<p><strong>Atlas主要功能</strong></p>
<hr>
<ul>
<li>1.读写分离</li>
<li>2.从库负载均衡</li>
<li>3.IP过滤</li>
<li>4.自动分表</li>
<li>5.DBA可平滑上下线DB</li>
<li>6.自动摘除宕机的DB</li>
</ul>
<hr>
<p><strong>Atlas相对于官方MySQL-Proxy的优势</strong></p>
<hr>
<ul>
<li>1.将主流程中所有Lua代码用C重写，Lua仅用于管理接口</li>
<li>2.重写网络模型、线程模型</li>
<li>3.实现了真正意义上的连接池</li>
<li>4.优化了锁机制，性能提高数十倍</li>
</ul>
<hr>
<p><strong>安装Atlas</strong></p>
<p>同学们有福了，安装Atlas真的是炒鸡简单，官方提供的Atlas有两种：</p>
<p>1）Atlas (普通) : Atlas-2.2.1.el6.x86_64.rpm<br>2）Atlas (分表) : Atlas-sharding_1.0.1-el6.x86_64.rpm</p>
<p>这里我们只需要下载普通的即可。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#在主库安装，进入安装包目录  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# cd <span class="operator">/</span>home<span class="operator">/</span>oldboy<span class="operator">/</span>tools<span class="operator">/</span>  </span><br><span class="line">#下载Atlas  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 tools]#  </span><br><span class="line">wget httpss:<span class="operator">/</span><span class="operator">/</span>github.com<span class="operator">/</span>Qihoo360<span class="operator">/</span>Atlas<span class="operator">/</span>releases<span class="operator">/</span>download<span class="operator">/</span><span class="number">2.2</span><span class="number">.1</span><span class="operator">/</span>Atlas<span class="number">-2.2</span><span class="number">.1</span>.el6.x86_64.rpm  </span><br><span class="line">#安装  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 tools]# rpm <span class="operator">-</span>ivh Atlas<span class="number">-2.2</span><span class="number">.1</span>.el6.x86_64.rpm  </span><br><span class="line">Preparing... ########################################### [<span class="number">100</span><span class="operator">%</span>]  </span><br><span class="line"><span class="number">1</span>:Atlas ########################################### [<span class="number">100</span><span class="operator">%</span>]</span><br></pre></td></tr></table></figure>

<p><strong>编辑配置文件</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#进入Atlas工具目录  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# cd <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>mysql<span class="operator">-</span>proxy<span class="operator">/</span>bin<span class="operator">/</span>  </span><br><span class="line">#生成密码  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 bin]# .<span class="operator">/</span>encrypt oldboy123  </span><br><span class="line">#修改Atlas配置文件  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# vim <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>mysql<span class="operator">-</span>proxy<span class="operator">/</span>conf<span class="operator">/</span>test.cnf  </span><br><span class="line">#Atlas后端连接的MySQL主库的IP和端口，可设置多项，用逗号分隔  </span><br><span class="line">proxy<span class="operator">-</span>backend<span class="operator">-</span>addresses <span class="operator">=</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>:<span class="number">3306</span>  </span><br><span class="line">#Atlas后端连接的MySQL从库的IP和端口  </span><br><span class="line">proxy<span class="operator">-</span>read<span class="operator">-</span><span class="keyword">only</span><span class="operator">-</span>backend<span class="operator">-</span>addresses <span class="operator">=</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.52</span>:<span class="number">3306</span>,<span class="number">10.0</span><span class="number">.0</span><span class="number">.53</span>:<span class="number">3306</span>  </span><br><span class="line">#用户名与其对应的加密过的MySQL密码  </span><br><span class="line">pwds <span class="operator">=</span> root:<span class="number">1</span>N<span class="operator">/</span>CNLSgqXuTZ6zxvGQr9A<span class="operator">=</span><span class="operator">=</span>  </span><br><span class="line">#<span class="keyword">SQL</span>日志的开关  </span><br><span class="line"><span class="keyword">sql</span><span class="operator">-</span>log <span class="operator">=</span> <span class="keyword">ON</span>  </span><br><span class="line">#Atlas监听的工作接口IP和端口  </span><br><span class="line">proxy<span class="operator">-</span>address <span class="operator">=</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">3307</span>  </span><br><span class="line">#默认字符集，设置该项后客户端不再需要执行<span class="keyword">SET</span> NAMES语句  </span><br><span class="line">charset <span class="operator">=</span> utf8</span><br></pre></td></tr></table></figure>

<p><strong>启动Atlas</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>mysql<span class="operator">-</span>proxy<span class="operator">/</span>bin<span class="operator">/</span>mysql<span class="operator">-</span>proxyd test <span class="keyword">start</span>  </span><br><span class="line">OK: MySQL<span class="operator">-</span>Proxy <span class="keyword">of</span> test <span class="keyword">is</span> started</span><br></pre></td></tr></table></figure>

<p><strong>Atlas管理操作</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#用atlas管理用户登录  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# mysql <span class="operator">-</span>uuser <span class="operator">-</span>ppwd <span class="operator">-</span>h127<span class="number">.0</span><span class="number">.0</span><span class="number">.1</span> <span class="operator">-</span>P2345  </span><br><span class="line">#查看可用命令帮助  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> help;  </span><br><span class="line">#查看后端代理的库  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> backends;  </span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------------+-------+------+  </span></span><br><span class="line"><span class="operator">|</span> backend_ndx <span class="operator">|</span> address <span class="operator">|</span> state <span class="operator">|</span> type <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------------+-------+------+  </span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>:<span class="number">3307</span> <span class="operator">|</span> up <span class="operator">|</span> rw <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> <span class="number">2</span> <span class="operator">|</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.53</span>:<span class="number">3307</span> <span class="operator">|</span> up <span class="operator">|</span> ro <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> <span class="number">3</span> <span class="operator">|</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.52</span>:<span class="number">3307</span> <span class="operator">|</span> up <span class="operator">|</span> ro <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------------+-------+------+  </span></span><br><span class="line">#平滑摘除mysql  </span><br><span class="line">mysql<span class="operator">&gt;</span> REMOVE BACKEND <span class="number">2</span>;  </span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)  </span><br><span class="line">#检查是否摘除成功  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> backends;  </span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------------+-------+------+  </span></span><br><span class="line"><span class="operator">|</span> backend_ndx <span class="operator">|</span> address <span class="operator">|</span> state <span class="operator">|</span> type <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------------+-------+------+  </span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>:<span class="number">3307</span> <span class="operator">|</span> up <span class="operator">|</span> rw <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> <span class="number">2</span> <span class="operator">|</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.52</span>:<span class="number">3307</span> <span class="operator">|</span> up <span class="operator">|</span> ro <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------------+-------+------+  </span></span><br><span class="line">#保存到配置文件中  </span><br><span class="line">mysql<span class="operator">&gt;</span> SAVE CONFIG;  </span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.06</span> sec)  </span><br><span class="line">&#123;<span class="number">1</span>&#125;</span><br></pre></td></tr></table></figure>


<hr>
<h2 id="title-最终章·MySQL从入门到高可用架构报错解决url-https-blog-driverzeng-com-zenglaoshi-539-htmlclipped-at-2022-05-19-21-54-18category-defaulttags-无"><a href="#title-最终章·MySQL从入门到高可用架构报错解决url-https-blog-driverzeng-com-zenglaoshi-539-htmlclipped-at-2022-05-19-21-54-18category-defaulttags-无" class="headerlink" title="title: 最终章·MySQL从入门到高可用架构报错解决url: https://blog.driverzeng.com/zenglaoshi/539.htmlclipped_at: 2022-05-19 21:54:18category: defaulttags: - 无"></a>title: 最终章·MySQL从入门到高可用架构报错解决<br>url: <a target="_blank" rel="noopener" href="https://blog.driverzeng.com/zenglaoshi/539.html">https://blog.driverzeng.com/zenglaoshi/539.html</a><br>clipped_at: 2022-05-19 21:54:18<br>category: default<br>tags:<br> - 无</h2><h1 id="最终章·MySQL从入门到高可用架构报错解决"><a href="#最终章·MySQL从入门到高可用架构报错解决" class="headerlink" title="最终章·MySQL从入门到高可用架构报错解决"></a>最终章·MySQL从入门到高可用架构报错解决</h1><blockquote>
<p>曾志高翔, 江湖人称曾老大。多年互联网运维工作经验，曾负责过大规模集群架构自动化运维管理工作。擅长Web集群架构与自动化运维，曾负责国内某大型金融公司运维工作。<br>个人博客:”DBA老司机带你删库跑路”<br>笔者QQ:133411023、253097001<br>笔者交流群：198571640<br>笔者微信：z133411023</p>
</blockquote>
<ol>
<li></li>
</ol>
<p><img src="/assets/1652968458-e4846403346fadd67d8f174454482ab1.png"></p>
<p>报错原因：MySQL的socket文件目录不存在。</p>
<p>解决方法：创建MySQL的socket文件目录</p>
<p>mkdir &#x2F;application&#x2F;mysql-5.6.38&#x2F;tmp</p>
<ol start="2">
<li></li>
</ol>
<p><img src="/assets/1652968458-2f2ee7f29c0daa79d5b6f4a8a71e1364.png"></p>
<p>报错原因：socket文件目录没有权限</p>
<p>解决方法：给socket文件目录授权mysql用户的权限</p>
<p>chown -R mysql.mysql &#x2F;application&#x2F;mysql-5.6.38&#x2F;</p>
<ol start="3">
<li></li>
</ol>
<p><img src="/assets/1652968458-bca0bdc6144f89598a3b806d249b1f2a.png"></p>
<p><img src="/assets/1652968458-21823ffa2d62f8d38d583b8d51939aa6.png"></p>
<p>报错原因：没有做初始化</p>
<p>解决方法：做初始化</p>
<p>.&#x2F;mysql_install_db –user&#x3D;mysql –basedir&#x3D;&#x2F;application&#x2F;mysql –datadir&#x3D;&#x2F;application&#x2F;mysql&#x2F;data</p>
<ol start="4">
<li></li>
</ol>
<p><img src="/assets/1652968458-dac904439773a098fa21c6c29d5601cb.png"></p>
<p>报错原因：找不到socket文件</p>
<p>解决方法：1. mysql -uroot -poldboy123 -S &#x2F;tmp&#x2F;mysql.sock 指定socket文件路径</p>
<p>2.把socket文件放到默认路径下 mv &#x2F;tmp&#x2F;mysql.sock &#x2F;application&#x2F;mysql&#x2F;tmp&#x2F;</p>
<p>5. <img src="/assets/1652968458-8c121b46bf4e08d246e18b8abfaaf8d6.png"></p>
<p>报错原因：跳过授权表安全启动导致无法使用权限的设置</p>
<p>解决方法：使用insert，update语句对表进行修改添加用户权限</p>
<ol start="6">
<li></li>
</ol>
<p><img src="/assets/1652968458-9938020ebfc41b9126a557be0841e99c.png"></p>
<p>报错原因：插入数据时，表内有字段含有默认值，必须填写</p>
<p>解决方法：在insert语句中加上对应字段的默认值</p>
<ol start="7">
<li></li>
</ol>
<p><img src="/assets/1652968458-27d45c42a4a5c640d44668fccde2511a.png"></p>
<p>报错原因：SQL语句中含有中文字符所以不识别’localhost’</p>
<p>解决方法：将中文的标点符号改成英文的</p>
<ol start="8">
<li></li>
</ol>
<p><img src="/assets/1652968458-e94188fd1f565e79ee7791972123cb60.png"></p>
<p>报错原因：设置的共享表空间小于当前共享表空间的大小</p>
<p>#当前共享表空间大小：76M  </p>
<p>[root@oldboy data]# du -sh ibdata1</p>
<p>76M    ibdata1</p>
<p>#配置文件中共享表空间大小：50M  </p>
<p>innodb_data_file_path&#x3D;ibdata1:50M;ibdata2:50M:autoextend</p>
<p>解决方法：将配置文件中的50M修改为76M即可，然后重启MySQL</p>
<ol start="9">
<li></li>
</ol>
<p><img src="/assets/1652968458-ccc80c32c9958a7d03b4a0038b46fd5e.png"></p>
<p>报错原因：修改事务的隔离级别RC、RU的时候需要将binlog格式改成row</p>
<p>解决方法：在配置文件的[mysqld]标签下添加一行 binlog_format&#x3D;row，重启MySQL</p>
<ol start="10">
<li></li>
</ol>
<p><img src="/assets/1652968458-1843a3922813b3ec9ee9c9b2d09dbd80.png"></p>
<p>报错原因：MySQL配置文件中参数有问题。</p>
<p>解决方法：修改MySQL配置文件中的对应参数。</p>
<ol start="11">
<li></li>
</ol>
<p><img src="/assets/1652968458-a7a15c3aab1d97f0fc77ae1d12c5c614.png"></p>
<p>报错原因：使用操作不当的方式删除了binlog日志</p>
<p>解决方法：重新初始化数据库</p>
<ol start="12">
<li></li>
</ol>
<p><img src="/assets/1652968458-e189fe5875074a74dd79e37e707502d4.png"></p>
<p>报错原因：主从复制过程中master和slave的uuid相同</p>
<p>解决方法：修改uuid文件或者删除uuid文件并重启</p>
<p>vim &#x2F;application&#x2F;mysql&#x2F;data&#x2F;auto.cnf</p>
<p>[auto]</p>
<p>server-uuid&#x3D;3ba9b12e-b4e8-11e8-b930-000c29a508b5</p>
<p>或者：</p>
<p>rm -f &#x2F;application&#x2F;mysql&#x2F;data&#x2F;auto.cnf</p>
<p>重启：</p>
<p>&#x2F;etc&#x2F;init.d&#x2F;mysqld restart</p>
<ol start="13">
<li></li>
</ol>
<p><img src="/assets/1652968458-b5645598b2a5a9ec32f0eb31a5636ae0.png"></p>
<p>报错原因：从库没有执行change master to 语句，直接start slave;</p>
<p>解决方法：执行change master to语句</p>
<ol start="14">
<li></li>
</ol>
<p><img src="/assets/1652968458-c45df9ed3180710922fcf5af510e7e9b.png"></p>
<p>报错原因：不认识innodb</p>
<p>解决方法：初始化</p>
<ol start="15">
<li></li>
</ol>
<p><img src="/assets/1652968458-f7702082d2f1646b81b79f14218ef24f.png"></p>
<p>报错原因：IO线程连接超时</p>
<p>解决方法：1.网络              ping</p>
<p>2.端口              telnet    tcping</p>
<p><img src="/assets/1652968458-ddf73657dfdbb3c5221e2235b069ea5a.png">         3.用户名、密码         mysql –urep –poldboy123 –h10.0.0.51 –P3309</p>
<ol start="16">
<li></li>
</ol>
<p><img src="/assets/1652968458-b7c2ea5fd2cac4429e7acbc71d766001.png"></p>
<p>报错原因：因为做了hosts解析，将ip反向解析成了主机名</p>
<p>解决方法：1.在所有主机上都相互做解析，grant rep@’oldboy’</p>
<p>2.在配置文件中[mysqld]标签下添加一行：skip_name_resolv（跳过反向解析）</p>
<p>赏</p>
<p><a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a></p>
<p><a href="javascript:">0</a></p>
<p>[</p>
<p>Previous Post</p>
<h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h3><hr>
<p>](<a target="_blank" rel="noopener" href="https://blog.driverzeng.com/zenglaoshi/6915.html">https://blog.driverzeng.com/zenglaoshi/6915.html</a>)</p>
<p>[</p>
<p>Next Post</p>
<h3 id="MySQL连表查询练习题"><a href="#MySQL连表查询练习题" class="headerlink" title="MySQL连表查询练习题"></a>MySQL连表查询练习题</h3><hr>
<p>](<a target="_blank" rel="noopener" href="https://blog.driverzeng.com/zenglaoshi/840.html">https://blog.driverzeng.com/zenglaoshi/840.html</a>)</p>
<hr>
<h2 id="title-MySQL连表查询练习题url-https-blog-driverzeng-com-zenglaoshi-840-htmlclipped-at-2022-05-19-21-55-24category-defaulttags-无"><a href="#title-MySQL连表查询练习题url-https-blog-driverzeng-com-zenglaoshi-840-htmlclipped-at-2022-05-19-21-55-24category-defaulttags-无" class="headerlink" title="title: MySQL连表查询练习题url: https://blog.driverzeng.com/zenglaoshi/840.htmlclipped_at: 2022-05-19 21:55:24category: defaulttags: - 无"></a>title: MySQL连表查询练习题<br>url: <a target="_blank" rel="noopener" href="https://blog.driverzeng.com/zenglaoshi/840.html">https://blog.driverzeng.com/zenglaoshi/840.html</a><br>clipped_at: 2022-05-19 21:55:24<br>category: default<br>tags:<br> - 无</h2><h1 id="MySQL连表查询练习题-1"><a href="#MySQL连表查询练习题-1" class="headerlink" title="MySQL连表查询练习题"></a>MySQL连表查询练习题</h1><blockquote>
<p>曾志高翔, 江湖人称曾老大。多年互联网运维工作经验，曾负责过大规模集群架构自动化运维管理工作。擅长Web集群架构与自动化运维，曾负责国内某大型金融公司运维工作。<br>个人博客:”DBA老司机带你删库跑路”<br>笔者QQ:133411023、253097001<br>笔者交流群：198571640<br>笔者微信：z133411023</p>
</blockquote>
<h2 id="建库"><a href="#建库" class="headerlink" title="建库"></a>建库</h2><p>库名：linux50 字符集：utf8 校验规则：utf8_general_ci<br><img src="/assets/1652968524-144f4eab3befcc94aeccb31ccbbe59a6.jpg">￼</p>
<h2 id="建表"><a href="#建表" class="headerlink" title="建表"></a>建表</h2><hr>
<table><tbody><tr><td bgcolor="#000000"><span style="color: white;">表一</span></td></tr></tbody></table>

<p>表名：student（学生表）</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>数据类型要求</th>
<th>是否为空</th>
<th>注释</th>
</tr>
</thead>
<tbody><tr>
<td>sno</td>
<td>最多20位</td>
<td>否</td>
<td>学号（主键）</td>
</tr>
<tr>
<td>sname</td>
<td>可变长</td>
<td>否</td>
<td>学生姓名</td>
</tr>
<tr>
<td>sage</td>
<td>最小整数，非负数</td>
<td>否</td>
<td>学生年龄</td>
</tr>
<tr>
<td>ssex</td>
<td>0，1</td>
<td>否</td>
<td>学生性别（1是男，0是女）默认为男）</td>
</tr>
<tr>
<td>sbirthday</td>
<td>时间类型</td>
<td>默认为空</td>
<td>学生生日</td>
</tr>
<tr>
<td>class</td>
<td>可变长</td>
<td>否</td>
<td>学生班级</td>
</tr>
</tbody></table>
<p><img src="/assets/1652968524-5a712b05e7ee947646fdcb50a3a19083.jpg">￼</p>
<hr>
<table><tbody><tr><td bgcolor="#000000"><span style="color: white;">表二</span></td></tr></tbody></table>

<p>表名：course（课程表）</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>数据类型要求</th>
<th>是否为空</th>
<th>注释</th>
</tr>
</thead>
<tbody><tr>
<td>cno</td>
<td>最多20位</td>
<td>否</td>
<td>课程号（主键）</td>
</tr>
<tr>
<td>cname</td>
<td>可变长</td>
<td>否</td>
<td>课程名称</td>
</tr>
<tr>
<td>tno</td>
<td>可变长</td>
<td>否</td>
<td>教师编号</td>
</tr>
</tbody></table>
<p><img src="/assets/1652968524-af1dcf2371b40920f5a4e0081e16296a.jpg">￼</p>
<hr>
<table><tbody><tr><td bgcolor="#000000"><span style="color: white;">表三</span></td></tr></tbody></table>

<p>表名：score（成绩表）</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>数据类型要求</th>
<th>是否为空</th>
<th>注释</th>
</tr>
</thead>
<tbody><tr>
<td>sno</td>
<td>最多20位</td>
<td>否</td>
<td>学号（主键）</td>
</tr>
<tr>
<td>cno</td>
<td>最多20位</td>
<td>否</td>
<td>课程号（主键）</td>
</tr>
<tr>
<td>mark</td>
<td>浮点数(4,1)</td>
<td>否</td>
<td>成绩</td>
</tr>
</tbody></table>
<p><strong>注意：</strong>sno和cno在另外两个表中是主键，在这里应该是外键，不过咱们不需要创建，了解即可</p>
<p><img src="/assets/1652968524-f0d2d85ab7fe936561d0eb3b1ad3436d.jpg">￼</p>
<hr>
<table><tbody><tr><td bgcolor="#000000"><span style="color: white;">表四</span></td></tr></tbody></table>

<p>表名：teacher（教师表）</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>数据类型要求</th>
<th>是否为空</th>
<th>注释</th>
</tr>
</thead>
<tbody><tr>
<td>tno</td>
<td>最多20位</td>
<td>否</td>
<td>教师编号（主键）</td>
</tr>
<tr>
<td>tname</td>
<td>可变长</td>
<td>否</td>
<td>教师姓名</td>
</tr>
<tr>
<td>tage</td>
<td>最小整数，非负数</td>
<td>否</td>
<td>教师年龄</td>
</tr>
<tr>
<td>tsex</td>
<td>0，1</td>
<td>否</td>
<td>教师性别（1是男，0是女）默认为男）</td>
</tr>
<tr>
<td>prof</td>
<td>可变长</td>
<td>是</td>
<td>教师职称</td>
</tr>
<tr>
<td>depart</td>
<td>可变长</td>
<td>否</td>
<td>教师部门</td>
</tr>
</tbody></table>
<p><img src="/assets/1652968524-edc275fafda8a775cbb4ec13464a5fe9.jpg">￼</p>
<h2 id="练习题"><a href="#练习题" class="headerlink" title="练习题"></a>练习题</h2><p>插入数据练习：</p>
<p>1.将自己班级小组所有人员信息插入到student表中（数据自定义）</p>
<p>2.将曾导、徐导、李导信息插入教师表中（数据自定义）</p>
<p>3.将数学、语文、英语学科插入到课程表中（数据自定义）</p>
<p>4.将分数插入到成绩表中（数据自定义）</p>
<p>查询练习：</p>
<p>1.查询student表中的所有记录的sname、ssex和class列。</p>
<p>2.查询教师所有的单位即不重复的depart列。</p>
<p>3.查询student表的所有记录。</p>
<p>4.查询score表中成绩在60到80之间的所有记录。</p>
<p>5.查询score表中成绩为85，86或88的记录。</p>
<p>6.查询student表中1班或性别为“女”的同学记录。</p>
<p>7.以class降序查询Student表的所有记录。</p>
<p>8.以cno升序、mark降序查询Score表的所有记录</p>
<p>9.查询2班的学生人数。</p>
<p>10.查询”曾志高翔“教师任课的学生成绩。</p>
<p>11.查询语文课程所有男生的成绩并且查出对应课程的教师名，职称，及所在部门。</p>
<p>12.把11题查出的成绩按照降序排序。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://mo-li001.github.io">壹拾陆</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://mo-li001.github.io/posts/abc41134.html">https://mo-li001.github.io/posts/abc41134.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mo-li001.github.io" target="_blank">壹拾陆</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/161f0509.html"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Nginx快速入门</div></div></a></div><div class="next-post pull-right"><a href="/posts/64202.html"><img class="next-cover" src="https://tuchuangs.com/imgs/2022/09/18/074f3836d4f471b8.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">linux</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/9f353bc9.html" title="Devops"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Devops</div></div></a></div><div><a href="/posts/f5f9fa9b.html" title="Docker"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Docker</div></div></a></div><div><a href="/posts/34d20e28.html" title="ELK"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">ELK</div></div></a></div><div><a href="/posts/8005.html" title="ELK快速部署"><img class="cover" src="https://tuchuangs.com/imgs/2022/09/18/074f3836d4f471b8.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">ELK快速部署</div></div></a></div><div><a href="/posts/9bdc030a.html" title="HAproxy"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">HAproxy</div></div></a></div><div><a href="/posts/a71433d.html" title="Ansible"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Ansible</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202209182232723.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">壹拾陆</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">96</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mo-li001/"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">个人笔记</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0%C2%B7MySQL%E4%BB%8B%E7%BB%8D%E5%8F%8A%E5%AE%89%E8%A3%85"><span class="toc-text">第一章·MySQL介绍及安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-DBA%E5%B7%A5%E4%BD%9C%E5%86%85%E5%AE%B9%E5%8F%8A%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB"><span class="toc-text">一.DBA工作内容及课程体系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-MySQL%E8%AF%BE%E7%A8%8B%E4%BD%93%E7%B3%BB%E4%BB%8B%E7%BB%8D"><span class="toc-text">二.MySQL课程体系介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-DBA%E7%9A%84%E8%81%8C%E4%B8%9A%E7%B4%A0%E5%85%BB"><span class="toc-text">三.DBA的职业素养</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-MySQL%E7%AE%80%E4%BB%8B%E5%8F%8A%E5%AE%89%E8%A3%85"><span class="toc-text">四.MySQL简介及安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#01-%E4%BB%80%E4%B9%88%E6%98%AF%E6%95%B0%E6%8D%AE"><span class="toc-text">01 什么是数据?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#02-%E4%BB%80%E4%B9%88%E6%98%AF%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F"><span class="toc-text">02 什么是数据库管理系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#03-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E7%A7%8D%E7%B1%BB"><span class="toc-text">03 数据库管理系统种类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#04-MySQL%E5%8F%91%E5%B1%95%E5%8F%B2"><span class="toc-text">04 MySQL发展史</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#05-MySQL%E6%AD%A3%E5%9C%A8%E6%8E%A8%E5%8A%A8%E4%B8%96%E7%95%8C"><span class="toc-text">05 MySQL正在推动世界</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#06-MySQL%E7%AE%80%E4%BB%8B%E5%8F%8A%E4%BA%A7%E5%93%81%E7%BA%BF"><span class="toc-text">06 MySQL简介及产品线</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#06-MySQL%E5%AE%89%E8%A3%85"><span class="toc-text">06 MySQL安装</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0%C2%B7-MySQL%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%E7%AE%A1%E7%90%86"><span class="toc-text">第二章· MySQL体系结构管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A8%A1%E5%9E%8B"><span class="toc-text">一.客户端与服务器模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-MySQL%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9E%84%E6%88%90"><span class="toc-text">二.MySQL服务器构成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-MySQL%E7%9A%84%E7%BB%93%E6%9E%84"><span class="toc-text">三.MySQL的结构</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%AB%A0%C2%B7MySQL%E7%89%88%E6%9C%AC%E5%8C%BA%E5%88%AB%E5%8F%8A%E7%AE%A1%E7%90%86"><span class="toc-text">第三章·MySQL版本区别及管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-MySQL5-6%E4%B8%8EMySQL5-7%E5%AE%89%E8%A3%85%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">一.MySQL5.6与MySQL5.7安装的区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-MySQL%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="toc-text">二.MySQL用户权限管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-MySQL%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86"><span class="toc-text">三.MySQL连接管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-MySQL%E5%90%AF%E5%8A%A8%E5%85%B3%E9%97%AD%E6%B5%81%E7%A8%8B"><span class="toc-text">四.MySQL启动关闭流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-MySQL%E5%AE%9E%E4%BE%8B%E5%88%9D%E5%A7%8B%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="toc-text">五.MySQL实例初始化配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-MySQL%E5%A4%9A%E5%AE%9E%E4%BE%8B%E9%85%8D%E7%BD%AE"><span class="toc-text">六.MySQL多实例配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0%C2%B7-MySQL%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B7%A5%E5%85%B7%E5%8F%8ASQL%E8%AE%B2%E8%A7%A3"><span class="toc-text">第四章· MySQL客户端工具及SQL讲解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4%E4%BB%8B%E7%BB%8D"><span class="toc-text">一.客户端命令介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E6%8E%A5%E6%94%B6%E7%94%A8%E6%88%B7%E7%9A%84SQL%E8%AF%AD%E5%8F%A5"><span class="toc-text">二.接收用户的SQL语句</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E5%AD%97%E7%AC%A6%E9%9B%86%E5%AE%9A%E4%B9%89"><span class="toc-text">三.字符集定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E5%AD%97%E7%AC%A6%E9%9B%86%E8%AE%BE%E7%BD%AE"><span class="toc-text">四.字符集设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-select%E7%9A%84%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95%EF%BC%88%E6%89%A9%E5%B1%95%EF%BC%89"><span class="toc-text">五.select的高级用法（扩展）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#title-%E7%AC%AC%E4%BA%94%E7%AB%A0%C2%B7-MySQL%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8Burl-https-blog-driverzeng-com-zenglaoshi-659-htmlclipped-at-2022-05-18-18-28-14category-defaulttags-%E6%97%A0"><span class="toc-text">title: 第五章· MySQL数据类型url: https:&#x2F;&#x2F;blog.driverzeng.com&#x2F;zenglaoshi&#x2F;659.htmlclipped_at: 2022-05-18 18:28:14category: defaulttags: - 无</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E7%AB%A0%C2%B7-MySQL%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-text">第五章· MySQL数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%BB%8B%E7%BB%8D"><span class="toc-text">一.数据类型介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E5%88%97%E5%B1%9E%E6%80%A7%E4%BB%8B%E7%BB%8D"><span class="toc-text">二.列属性介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0%C2%B7-MySQL%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B7%A5%E5%85%B7%E5%8F%8ASQL%E8%AE%B2%E8%A7%A3-1"><span class="toc-text">第四章· MySQL客户端工具及SQL讲解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E7%AB%A0%C2%B7-MySQL%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86%E5%8F%8A%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92"><span class="toc-text">第六章· MySQL索引管理及执行计划</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E7%AB%A0%C2%B7-MySQL%E7%B4%A2%E5%BC%95%E7%AE%A1%E7%90%86%E5%8F%8A%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92-1"><span class="toc-text">第六章· MySQL索引管理及执行计划</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E7%B4%A2%E5%BC%95%E4%BB%8B%E7%BB%8D"><span class="toc-text">一.索引介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-explain%E8%AF%A6%E8%A7%A3"><span class="toc-text">二.explain详解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E5%BB%BA%E7%AB%8B%E7%B4%A2%E5%BC%95%E7%9A%84%E5%8E%9F%E5%88%99%EF%BC%88%E8%A7%84%E8%8C%83%EF%BC%89"><span class="toc-text">三.建立索引的原则（规范）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#title-%E7%AC%AC%E4%B8%83%E7%AB%A0%C2%B7-MySQL%E7%9A%84%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8Eurl-https-blog-driverzeng-com-zenglaoshi-689-htmlclipped-at-2022-05-19-21-53-32category-defaulttags-%E6%97%A0"><span class="toc-text">title: 第七章· MySQL的存储引擎url: https:&#x2F;&#x2F;blog.driverzeng.com&#x2F;zenglaoshi&#x2F;689.htmlclipped_at: 2022-05-19 21:53:32category: defaulttags: - 无</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E7%AB%A0%C2%B7-MySQL%E7%9A%84%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="toc-text">第七章· MySQL的存储引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E7%AE%80%E4%BB%8B"><span class="toc-text">一.存储引擎简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-MySQL%E8%87%AA%E5%B8%A6%E7%9A%84%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E7%B1%BB%E5%9E%8B"><span class="toc-text">二.MySQL自带的存储引擎类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E7%9C%9F%E5%AE%9E%E4%BC%81%E4%B8%9A%E6%A1%88%E4%BE%8B"><span class="toc-text">三.真实企业案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-Innodb%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E2%80%94%E2%80%94%E8%A1%A8%E7%A9%BA%E9%97%B4%E4%BB%8B%E7%BB%8D"><span class="toc-text">四.Innodb存储引擎——表空间介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-Innodb%E6%A0%B8%E5%BF%83%E7%89%B9%E6%80%A7%E2%80%94%E2%80%94%E4%BA%8B%E5%8A%A1"><span class="toc-text">五.Innodb核心特性——事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#title-%E7%AC%AC%E5%85%AB%E7%AB%A0%C2%B7-MySQL%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86url-https-blog-driverzeng-com-zenglaoshi-695-htmlclipped-at-2022-05-19-21-52-38category-defaulttags-%E6%97%A0"><span class="toc-text">title: 第八章· MySQL日志管理url: https:&#x2F;&#x2F;blog.driverzeng.com&#x2F;zenglaoshi&#x2F;695.htmlclipped_at: 2022-05-19 21:52:38category: defaulttags: - 无</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E7%AB%A0%C2%B7-MySQL%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86"><span class="toc-text">第八章· MySQL日志管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-MySQL%E6%97%A5%E5%BF%97%E7%AE%80%E4%BB%8B"><span class="toc-text">一.MySQL日志简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97"><span class="toc-text">二.错误日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E4%B8%80%E8%88%AC%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="toc-text">三.一般查询日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%97%A5%E5%BF%97"><span class="toc-text">四.二进制日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="toc-text">五.慢查询日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#title-%E7%AC%AC%E4%B9%9D%E7%AB%A0%C2%B7-MySQL%E7%9A%84%E5%A4%87%E4%BB%BD%E5%92%8C%E6%81%A2%E5%A4%8Durl-https-blog-driverzeng-com-zenglaoshi-699-htmlclipped-at-2022-05-19-21-52-59category-defaulttags-%E6%97%A0"><span class="toc-text">title: 第九章· MySQL的备份和恢复url: https:&#x2F;&#x2F;blog.driverzeng.com&#x2F;zenglaoshi&#x2F;699.htmlclipped_at: 2022-05-19 21:52:59category: defaulttags: - 无</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B9%9D%E7%AB%A0%C2%B7-MySQL%E7%9A%84%E5%A4%87%E4%BB%BD%E5%92%8C%E6%81%A2%E5%A4%8D"><span class="toc-text">第九章· MySQL的备份和恢复</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E5%A4%87%E4%BB%BD%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="toc-text">一.备份的原因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E5%A4%87%E4%BB%BD%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-text">二.备份的类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E5%A4%87%E4%BB%BD%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="toc-text">三.备份的方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E5%A4%87%E4%BB%BD%E7%AD%96%E7%95%A5"><span class="toc-text">四.备份策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-%E5%A4%87%E4%BB%BD%E5%B7%A5%E5%85%B7"><span class="toc-text">五.备份工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E7%AB%A0%C2%B7-MySQL%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-1"><span class="toc-text">第八章· MySQL日志管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E7%AB%A0%C2%B7-MySQL%E7%9A%84%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-text">第十章· MySQL的主从复制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#title-%E7%AC%AC%E5%8D%81%E7%AB%A0%C2%B7-MySQL%E7%9A%84%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6url-https-blog-driverzeng-com-zenglaoshi-703-htmlclipped-at-2022-05-19-21-53-50category-defaulttags-%E6%97%A0"><span class="toc-text">title: 第十章· MySQL的主从复制url: https:&#x2F;&#x2F;blog.driverzeng.com&#x2F;zenglaoshi&#x2F;703.htmlclipped_at: 2022-05-19 21:53:50category: defaulttags: - 无</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E7%AB%A0%C2%B7-MySQL%E7%9A%84%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6-1"><span class="toc-text">第十章· MySQL的主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%AE%80%E4%BB%8B"><span class="toc-text">一.主从复制简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86"><span class="toc-text">二.主从复制原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%9F%BA%E6%9C%AC%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86"><span class="toc-text">四.主从复制基本故障处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-%E5%BB%B6%E6%97%B6%E4%BB%8E%E5%BA%93"><span class="toc-text">五.延时从库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6"><span class="toc-text">六.半同步复制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83-%E8%BF%87%E6%BB%A4%E5%A4%8D%E5%88%B6"><span class="toc-text">七.过滤复制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#title-%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0%C2%B7-MHA%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BBurl-https-blog-driverzeng-com-zenglaoshi-709-htmlclipped-at-2022-05-19-21-54-05category-defaulttags-%E6%97%A0"><span class="toc-text">title: 第十一章· MHA高可用及读写分离url: https:&#x2F;&#x2F;blog.driverzeng.com&#x2F;zenglaoshi&#x2F;709.htmlclipped_at: 2022-05-19 21:54:05category: defaulttags: - 无</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0%C2%B7-MHA%E9%AB%98%E5%8F%AF%E7%94%A8%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-text">第十一章· MHA高可用及读写分离</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-MHA%E7%AE%80%E4%BB%8B"><span class="toc-text">一.MHA简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-text">二.工作流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-MHA%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-text">三.MHA架构图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-MHA%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D"><span class="toc-text">四.MHA工具介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-%E5%9F%BA%E4%BA%8EGTID%E7%9A%84%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-text">五.基于GTID的主从复制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-%E9%83%A8%E7%BD%B2MHA"><span class="toc-text">六.部署MHA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83-%E9%85%8D%E7%BD%AEVIP%E6%BC%82%E7%A7%BB"><span class="toc-text">七.配置VIP漂移</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB-%E9%85%8D%E7%BD%AEbinlog-server"><span class="toc-text">八.配置binlog-server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D-MySQL%E4%B8%AD%E9%97%B4%E4%BB%B6Atlas"><span class="toc-text">九.MySQL中间件Atlas</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#title-%E6%9C%80%E7%BB%88%E7%AB%A0%C2%B7MySQL%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84%E6%8A%A5%E9%94%99%E8%A7%A3%E5%86%B3url-https-blog-driverzeng-com-zenglaoshi-539-htmlclipped-at-2022-05-19-21-54-18category-defaulttags-%E6%97%A0"><span class="toc-text">title: 最终章·MySQL从入门到高可用架构报错解决url: https:&#x2F;&#x2F;blog.driverzeng.com&#x2F;zenglaoshi&#x2F;539.htmlclipped_at: 2022-05-19 21:54:18category: defaulttags: - 无</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E7%AB%A0%C2%B7MySQL%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84%E6%8A%A5%E9%94%99%E8%A7%A3%E5%86%B3"><span class="toc-text">最终章·MySQL从入门到高可用架构报错解决</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-text">正则表达式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL%E8%BF%9E%E8%A1%A8%E6%9F%A5%E8%AF%A2%E7%BB%83%E4%B9%A0%E9%A2%98"><span class="toc-text">MySQL连表查询练习题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#title-MySQL%E8%BF%9E%E8%A1%A8%E6%9F%A5%E8%AF%A2%E7%BB%83%E4%B9%A0%E9%A2%98url-https-blog-driverzeng-com-zenglaoshi-840-htmlclipped-at-2022-05-19-21-55-24category-defaulttags-%E6%97%A0"><span class="toc-text">title: MySQL连表查询练习题url: https:&#x2F;&#x2F;blog.driverzeng.com&#x2F;zenglaoshi&#x2F;840.htmlclipped_at: 2022-05-19 21:55:24category: defaulttags: - 无</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MySQL%E8%BF%9E%E8%A1%A8%E6%9F%A5%E8%AF%A2%E7%BB%83%E4%B9%A0%E9%A2%98-1"><span class="toc-text">MySQL连表查询练习题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BB%BA%E5%BA%93"><span class="toc-text">建库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BB%BA%E8%A1%A8"><span class="toc-text">建表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0%E9%A2%98"><span class="toc-text">练习题</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/99081826.html" title="很强，3万字把华为HCIA知识点全部总结了！">很强，3万字把华为HCIA知识点全部总结了！</a><time datetime="2022-12-05T05:17:54.876Z" title="发表于 2022-12-05 13:17:54">2022-12-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/b0318225.html" title="浪潮服务器通过DHCP获取地址进入IPMI，BMC管理后台的方法，可实现远程安装系统、温度运行状态监测、风扇转速调整、远程开关机、KVM控制台显示器等功能">浪潮服务器通过DHCP获取地址进入IPMI，BMC管理后台的方法，可实现远程安装系统、温度运行状态监测、风扇转速调整、远程开关机、KVM控制台显示器等功能</a><time datetime="2022-12-05T05:17:54.860Z" title="发表于 2022-12-05 13:17:54">2022-12-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/f962716d.html" title="使用system-config-kickstart生成kickstart文件">使用system-config-kickstart生成kickstart文件</a><time datetime="2022-12-05T05:17:54.860Z" title="发表于 2022-12-05 13:17:54">2022-12-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/12ac960a.html" title="Linux高级篇--使用system-config-kickstart工具制作kickstart应答文件">Linux高级篇--使用system-config-kickstart工具制作kickstart应答文件</a><time datetime="2022-12-05T05:17:54.845Z" title="发表于 2022-12-05 13:17:54">2022-12-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/cefcf133.html" title="zabbix5.0 percona_mysql_template模板文件">zabbix5.0 percona_mysql_template模板文件</a><time datetime="2022-12-05T05:17:54.845Z" title="发表于 2022-12-05 13:17:54">2022-12-05</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By 壹拾陆</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>