<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Mongo数据库 | 壹拾陆</title><meta name="keywords" content="Linux"><meta name="author" content="壹拾陆"><meta name="copyright" content="壹拾陆"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="MongoDB第1章NoSQL介绍1.1 NoSQL简介NoSQL(NoSQL&#x3D;Not Only SQL),意即”不仅仅是SQL。在现代的计算系统上每太网络上都会产生庞大的数据量。 这些数据有很大一部分是由关系数据库管理系统（RDMBSs）来处理。1970年E.F.Cadd’提出的关系模型的论文“Arelational model of data for large shared dat">
<meta property="og:type" content="article">
<meta property="og:title" content="Mongo数据库">
<meta property="og:url" content="https://mo-li001.github.io/posts/64f8eb0f.html">
<meta property="og:site_name" content="壹拾陆">
<meta property="og:description" content="MongoDB第1章NoSQL介绍1.1 NoSQL简介NoSQL(NoSQL&#x3D;Not Only SQL),意即”不仅仅是SQL。在现代的计算系统上每太网络上都会产生庞大的数据量。 这些数据有很大一部分是由关系数据库管理系统（RDMBSs）来处理。1970年E.F.Cadd’提出的关系模型的论文“Arelational model of data for large shared dat">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-08-31T12:41:14.000Z">
<meta property="article:modified_time" content="2022-10-23T15:27:21.000Z">
<meta property="article:author" content="壹拾陆">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://mo-li001.github.io/posts/64f8eb0f"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Mongo数据库',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-23 23:27:21'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202209182232723.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">69</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">壹拾陆</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Mongo数据库</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-31T12:41:14.000Z" title="发表于 2022-08-31 20:41:14">2022-08-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-10-23T15:27:21.000Z" title="更新于 2022-10-23 23:27:21">2022-10-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Mongo数据库"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="MongoDB"><a href="#MongoDB" class="headerlink" title="MongoDB"></a><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1f54y1p7Rk?p=511&vd_source=629395ac7befa1625191c3f496068941">MongoDB</a></h1><h1 id="第1章NoSQL介绍"><a href="#第1章NoSQL介绍" class="headerlink" title="第1章NoSQL介绍"></a>第1章NoSQL介绍</h1><h2 id="1-1-NoSQL简介"><a href="#1-1-NoSQL简介" class="headerlink" title="1.1 NoSQL简介"></a>1.1 NoSQL简介</h2><p>NoSQL(NoSQL&#x3D;Not Only SQL),意即”不仅仅是SQL。<br>在现代的计算系统上每太网络上都会产生庞大的数据量。</p>
<p>这些数据有很大一部分是由关系数据库管理系统（RDMBSs）来处理。1970年E.F.Cadd’提出的关系模型的论文“Arelational model of data for large shared data banks”，这使得数据建模和应用程序编程更加简单。</p>
<p>通过应用实践证明，关系模型是非常适合于客户服务器编程，远远超出预期的利益，今天它是结构化数据存储在网络和商务应用的主导技术。</p>
<p>NoSQL是一项全新的数据库革命性运动，早期就有人提出，发展至2009年趋势越发高涨。NoSQL的拥护者们提倡运用非关系型的数据存储，相对于铺天盖地的关系型数据库运用，这一概念无疑是一种全新的思维的注入。</p>
<h2 id="1-2什么是NoSQL"><a href="#1-2什么是NoSQL" class="headerlink" title="1.2什么是NoSQL"></a>1.2什么是NoSQL</h2><p>NoSQL，指的是非关系型的数据库。NoSQL有时也称作Not Only SQL的缩写，是对不同于传统的关系型数据库的数据库管理系统的统称。</p>
<p>对NoSQL最普遍的解释是”非关联型的”，强调Key-Value Stores和文档数据库的优点，而不是单纯的反对RDBMS。</p>
<p>NoSQL用于超大规模数据的存储。（例如谷歌或Facebook每天为他们的用户收集万亿比特的数据）。这些类型的数据存储不需要固定的模式，无需多余操作就可以横向扩展。</p>
<h2 id="1-3为什么使用NoSQL？"><a href="#1-3为什么使用NoSQL？" class="headerlink" title="1.3为什么使用NoSQL？"></a>1.3为什么使用NoSQL？</h2><p>今天我们可以通过第三方平台（如：Google，Facebook等）可以很容易的访问和抓取数据。用户的个人信息，社交网络，地理位置，用户生成的数据和用户操作日志已经成倍的增加。我们如果要对这些用户数据进行挖掘，那SQL数据库已经不适合这些应用了，NoSQL数据库的发展也却能很好的处理这些大的数据。</p>
<h1 id="第2章MongoDB简介"><a href="#第2章MongoDB简介" class="headerlink" title="第2章MongoDB简介"></a>第2章MongoDB简介</h1><p>Mongodb由C++语言编写的，是一个基于分布式文件存储的开源数据库系统。，是专为可扩展性，高性能和高可用性而设计的数据库，是非关系型数据库中功能最丰富，最像关系型数据库的，它支持的数据结构非常散，是类似json 的 bjson 格式，因此可以存储比较复杂的数据类型。</p>
<p>MongoDB的(来自于英文单词“了Humongous”，中文含义为“庞大”）是可以应用于各种规模的企业，各个行业以及各类应用程序的开源数据库。作为一个适用于敏捷开发的数据库，MongoDB的的数据模式可以随着应用程序的发展而灵活地更新。</p>
<p>MongoDB以一种叫做BSON（二进制JSON）的存储形式将数据作为文档存储。具有相似结构的文档通常被整理成集合。可以把这些集合看成类似于关系数据库中的表：文档和行相似，字段和列相似。</p>
<h2 id="2-1-MongoDB数据格式"><a href="#2-1-MongoDB数据格式" class="headerlink" title="2.1 MongoDB数据格式"></a>2.1 MongoDB数据格式</h2><h3 id="2-1-1-JSON"><a href="#2-1-1-JSON" class="headerlink" title="2.1.1 JSON"></a>2.1.1 JSON</h3><p>JSON(JavaScript Object Notation)是一种轻量级的数据交换格式。JSON采用完全独立于语言的文本格式，但是也使用了类似于C语言家族的习惯（包括C、C+、C#、Java、JavaScript、Perl、Python等）。这些特性使JSON成为理想的数据交换语言.易于人阅读和编写，同时也易于机器解析和生成（一般用于提升网络传输速率）。JSON的官方MIME类型是 applicationfjson,文件扩展名是.json。</p>
<p>MongoDB 使用JSON(JavaScript ObjectNotation)文档存储记录。</p>
<p>JSON 简单说就是JavaScript中的对象和数组，通过对象和数组可以表示各种复杂的结构。</p>
<p>对象：</p>
<p>对象在js中表示为“}”括起来的内容，数据结构为{key:value.key： value…}的键值对的结构，在面向对象的语言中，key为对象的属性，value为对应的属性值，所以很容易理解，取值方法为对象.key获取属性值，这个属性值的类型可以是数字、字符串、数组、对象几种。</p>
<p>例如： {“FirstName”:”ke”,”LastName”:”me”,”email”:”hikeme(@aa”}</p>
<p>取值方式和所有语言中一样，使用key获取，字段值的类型可以是数字、字符串、数组、对象几种。</p>
<h3 id="2-1-2-BSON"><a href="#2-1-2-BSON" class="headerlink" title="2.1.2 BSON"></a>2.1.2 BSON</h3><p>BSON是一种类JSON的一种二进制形式的存储格式，简称Binary JSON，它和JSON一样，支持内嵌的文档对象和数组对象，但是BSON有JSON没有的一些数据类型，如Date和BinData类型。</p>
<p>它的优点是灵活性高，但它的缺点是空间利用率不是很理想。</p>
<p>BSON有三个特点：轻量性、可遍历性、高效性。</p>
<p>对JSON来说，数据存储是无类型的，比如你要修改基本一个值，从9到10，由于从一个字符变成了两个，所以可能其后面的所有内容都需要往后移一位才可以。而使用BSON，你可以指定这个列为数字列，那么无论数字从9长到10还是100，我们都只是在存储数字的那一位上进行修改，不会导致数据总长变大。当然，在MongoDB中，如果数字从整形增大到长整型，还是会导致数据总长变大的。</p>
<p>有时BSON相对JSON来说也并没有空间上的优势，比如对{“sex”：1}，在JSON的存储上1只使用了一个字节，而如果用BSON，那就是至少4个字节</p>
<h2 id="2-2-MangoDB-特点"><a href="#2-2-MangoDB-特点" class="headerlink" title="2.2 MangoDB 特点"></a>2.2 MangoDB 特点</h2><p>高性能：Mongodb提供高性能的数据持久性，尤其是支持嵌入式数据模型减少数据库系统上的I&#x2F;0操作，索引支持能快的查询，并且可以包括来嵌入式文档和数组中的键丰富的语言查询：Mongodb支持丰富的查询语言来支持读写操作（CRUD)以及数据汇总，文本搜索和地理空间索引</p>
<p>高可用性：Mongodb的复制工具，成为副本集，提供自动故障转移和数据冗余，</p>
<p>水平可扩展性：Mongodb提供了可扩展性，作为其核心功能的一部分，分片是将数据分，在一组计算机上。</p>
<p>支持多种存储引擎：WiredTiger存储引擎和、MMAPv1存储引擎和 InMemory存储引擎</p>
<h2 id="2-3-MongoDB包含的程序"><a href="#2-3-MongoDB包含的程序" class="headerlink" title="2.3 MongoDB包含的程序"></a>2.3 MongoDB包含的程序</h2><p>MongoDB Drivers</p>
<p>官方MongoDB客户端库提供C,C++,C#,Java,Node.JS,Perl,PHP,Python,Ruby 和Scala驱动程序的参考指南。</p>
<p>MongoDB Stitch</p>
<p>为开发人员提供了一个API到MongoDB和其他后端服务。保持MongoDB的全部功能和灵性，同时受益于强大的系统来配置细粒度的数据访问控制。</p>
<p>MongoDB Atlas</p>
<p>MongoDB在云中部署，操作和扩展的最佳方式。适用于AWS,Azure和Google Cloud Platform。轻松将数据迁移到MongoDB Atlas,零停机</p>
<p>MongoDB Clound Manager</p>
<p>是一个用于管理MongoDB部署的软件包。Ops Manager提供Ops Manager监控和Ops Manager备份，可帮助用户优化群集并降低操作风险</p>
<p>MongoDB Charts</p>
<p>可以最快速最简单的创建Mongodb可视化图表</p>
<p>MongoDB Connector for BI</p>
<p>MongoDB商业智能连接器（BI）允许用户使用SQL创建查询，并使用现有的关系商业智能工具（如Tableau,MicroStrategy和Qlik）对其MongoDB Enterprise数据进行可视化，图形化和报告。</p>
<p>MongoDB Compass</p>
<p>通过从集合中随机抽样一个文档子集，为用户提供其MongoDB模式的图形视图。采样文件可最大程度地降低对数据库的影响，并能快速产生结果。有关抽样的更多信息</p>
<p>MongoDB Spark Connector</p>
<p>使用连接器，您可以访问所有使用MongoDB数据集的Spark库：用SQL进行分析的数据集（受益于自动模式推理），流式传输，机器学习和图形API。您也可以使用连接器与Spark Shell。</p>
<h1 id="第3章应用场景"><a href="#第3章应用场景" class="headerlink" title="第3章应用场景"></a>第3章应用场景</h1><p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/32071167">https://www.zhihu.com/question/32071167</a></p>
<h1 id="第4章安装部署"><a href="#第4章安装部署" class="headerlink" title="第4章安装部署"></a>第4章安装部署</h1><h2 id="4-1官方文档"><a href="#4-1官方文档" class="headerlink" title="4.1官方文档"></a>4.1官方文档</h2><p><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/?_ga=2.57024426.1834178963.1557492386-816165234.1557492386">https://docs.mongodb.com/manual/?_ga=2.57024426.1834178963.1557492386-816165234.1557492386</a></p>
<h2 id="4-2安装方式"><a href="#4-2安装方式" class="headerlink" title="4.2安装方式"></a>4.2安装方式</h2><p>官方下载地址：</p>
<p><a target="_blank" rel="noopener" href="https://www.mongodb.com/download-center/community">https://www.mongodb.com/download-center/community</a></p>
<p>这里选用 tar 包的安装方式<br><a target="_blank" rel="noopener" href="https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-3.6.13.tgz">https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-3.6.13.tgz</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line">安装服务套路</span><br><span class="line">1.规划目录</span><br><span class="line">2.下载软件包</span><br><span class="line">3.解压到指定目录</span><br><span class="line">4.创建数据目录</span><br><span class="line">5.创建用户</span><br><span class="line">6.更改目录授权</span><br><span class="line">7.修改配置文件</span><br><span class="line">8.启动</span><br><span class="line">9.测试</span><br><span class="line">10.编写启动关停脚本</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">安装部署</span><br><span class="line">yum install libcurl openssl -y</span><br><span class="line">mkdir /opt/mongo_cluster/ -p</span><br><span class="line">mkdir /data/soft -p</span><br><span class="line">cd /data/soft/</span><br><span class="line">wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-3.6.13.tgz</span><br><span class="line">tar zxvf mongodb-linux-x86_64-3.6.13.tgz -C /opt/mongo_cluster/</span><br><span class="line">cd /opt/mongo_cluster/ &amp;&amp; ln -s mongodb-linux-x86_64-3.6.13 mongodb</span><br><span class="line">mkdir /opt/mongo_cluster/mongo_27017/&#123;conf,logs,pid&#125; -p</span><br><span class="line">mkdir /data/mongo_cluster/mongo_27017 -p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">YML</span><br><span class="line">1.对缩进要求非常严格</span><br><span class="line"></span><br><span class="line">配置启动：</span><br><span class="line">2.修改配置文件</span><br><span class="line">cat &gt; /opt/mongo_cluster/mongo_27017/conf/monogdb.conf &lt;&lt; EOF</span><br><span class="line">systemLog:</span><br><span class="line">  destination: file  # Mongodb日志输出的目的地,指定一个file或者syslog,如果指定file,必须指定</span><br><span class="line">  logAppend: true  #当实例重启时，不创建新的日志文件，在老的日志文件末尾继续添加</span><br><span class="line">  path: /opt/mongo_cluster/mongo_27017/logs/mongodb.log  #日志路径</span><br><span class="line">  </span><br><span class="line">storage:</span><br><span class="line">  journal:  #回滚日志</span><br><span class="line">    enabled: true</span><br><span class="line">  dbPath: /data/mongo_cluster/mongo_27017  #数据存储目录</span><br><span class="line">  directoryPerDB: true  #默认false,不适用inmemory engine</span><br><span class="line">  wiredTiger:</span><br><span class="line">    engineConfig:</span><br><span class="line">      cacheSizeGB: 1  #将用于所有数据缓存的最大小</span><br><span class="line">      directoryForIndexes: true  #默认false 索引集合storage.dbPath存储在数据单独子目录</span><br><span class="line">    collectionConfig:</span><br><span class="line">      blockCompressor: zlib</span><br><span class="line">    indexConfig:</span><br><span class="line">      prefixCompression: true</span><br><span class="line"></span><br><span class="line">processManagement:    #使用处理系统守护进程的控制处理</span><br><span class="line">  fork: true    #后台运行</span><br><span class="line">  pidFilePath: /opt/mongo_cluster/mongo_27017/pid/mongod.pid  #创建 pid 文件</span><br><span class="line"></span><br><span class="line">net:</span><br><span class="line">  port: 27017  #监听端囗</span><br><span class="line">  bindIp: 127.0.0.1,10.0.0.51  #绑定 ip</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">2.启动命令</span><br><span class="line">cd /opt/mongo_cluster/</span><br><span class="line">mongodb/bin/mongod -f mongo_27017/conf/monogdb.conf</span><br><span class="line"></span><br><span class="line">3.检查</span><br><span class="line">ps -ef|grep mongo</span><br><span class="line">netstat -lntup|grep 27017</span><br><span class="line"></span><br><span class="line">4.登录</span><br><span class="line">mongodb/bin/mongo db01:27017</span><br><span class="line"></span><br><span class="line">5.关闭</span><br><span class="line">mongodb/bin/mongod -f mongo_27017/conf/monogdb.conf --shutdown</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">启动告警</span><br><span class="line">** WARNING: Access control is not enabled for the database.</span><br><span class="line">**          Read and write access to data and configuration is unrestricted.</span><br><span class="line">** WARNING: You are running this process as the root user, which is not recommended.</span><br><span class="line"></span><br><span class="line">** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is &#x27;always&#x27;.</span><br><span class="line">**        We suggest setting it to &#x27;never&#x27;</span><br><span class="line"></span><br><span class="line">** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is &#x27;always&#x27;.</span><br><span class="line">**        We suggest setting it to &#x27;never&#x27;</span><br><span class="line"></span><br><span class="line">** WARNING: soft rlimits too low. rlimits set to 15643 processes, 65535 files. Number of processes</span><br><span class="line">should be at least 32767.5 : 0.5 times number of files.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">告警</span><br><span class="line">** WARNING: You are running this process as the root user, which is not recommended.</span><br><span class="line"></span><br><span class="line">告警处理</span><br><span class="line">#普通用户启动</span><br><span class="line">useradd mongo</span><br><span class="line">echo &#x27;123456&#x27;|passwd --stdin mongo</span><br><span class="line">chown -R mongo:mongo /opt/mongo_cluster</span><br><span class="line">chown -R mongo:mongo /data/mongo_cluster</span><br><span class="line">[root@mongodb mongo_cluster]# su - mongo</span><br><span class="line">[mongo@mongodb ~]$ vim .bashrc </span><br><span class="line">export PATH=/opt/mongo_cluster/mongodb/bin:$PATH</span><br><span class="line">[mongo@mongodb ~]$ source .bashrc</span><br><span class="line">[mongo@mongodb ~]$ exit</span><br><span class="line">[root@mongodb mongo_cluster]# /opt/mongo_cluster/mongodb/bin/mongod -f /opt/mongo_cluster/mongo_27017/conf/monogdb.conf --shutdown</span><br><span class="line">killing process with pid: 8271</span><br><span class="line">[root@mongodb mongo_cluster]# chown -R mongo:mongo /data/mongo_cluster/mongo_27017/</span><br><span class="line">[root@mongodb mongo_cluster]# su - mongo</span><br><span class="line">[mongo@mongodb ~]$ mongod -f /opt/mongo_cluster/mongo_27017/conf/monogdb.conf</span><br><span class="line">[mongo@mongodb ~]$ mongo</span><br><span class="line"></span><br><span class="line">告警</span><br><span class="line">** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is &#x27;always&#x27;.</span><br><span class="line">**        We suggest setting it to &#x27;never&#x27;</span><br><span class="line"></span><br><span class="line">** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is &#x27;always&#x27;.</span><br><span class="line">**        We suggest setting it to &#x27;never&#x27;</span><br><span class="line"></span><br><span class="line">告警处理</span><br><span class="line"># 解决大内存页警告</span><br><span class="line">echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br><span class="line"></span><br><span class="line">vim /etc/init.d/disable-transparent-hugepages</span><br><span class="line">#!/bin/bash</span><br><span class="line">### BEGIN INIT INFO</span><br><span class="line"># Provides:    disable-transparent-hugepages</span><br><span class="line"># Required-Start:    $local_fs</span><br><span class="line"># Required-Stop:</span><br><span class="line"># X-Start-Before:    mongod mongodb-mms-automation-agent</span><br><span class="line"># Default-Start:    2 3 4 5</span><br><span class="line"># Default-Stop:    0 1 6</span><br><span class="line"># Short-Description:  Disable Linux transparent huge pages</span><br><span class="line"># Description:    Disable Linux transparent huge pages,to improve</span><br><span class="line">#    database performance.</span><br><span class="line">### END INIT INFO</span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">  start)</span><br><span class="line">    if [ -d /sys/kernel/mm/transparent_hugepage ];then</span><br><span class="line">      thp_path=/sys/kernel/mm/transparent_hugepage</span><br><span class="line">    elif [-d /sys/kernel/mm/redhat_transparent_hugepage ];then</span><br><span class="line">      thp_path=/sys/kernel/mm/redhat_transparent_hugepage</span><br><span class="line">    else</span><br><span class="line">      return 0</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    echo &#x27;never&#x27; &gt; $&#123;thp_path&#125;/enabled</span><br><span class="line">    echo &#x27;never&#x27; &gt; $&#123;thp_path&#125;/defrag</span><br><span class="line"></span><br><span class="line">    re=&#x27;^[0-1]+$&#x27;</span><br><span class="line">    if [[ $(cat $&#123;thp_path&#125;/khugepaged/defrag) =~ $re ]]</span><br><span class="line">    then</span><br><span class="line">      # RHEL 7</span><br><span class="line">      echo 0 &gt; $&#123;thp_path&#125;/khugepaged/defrag</span><br><span class="line">    else</span><br><span class="line">      # RHEL 6</span><br><span class="line">      echo &#x27;no&#x27; &gt; $&#123;thp_path&#125;/khugepaged/defrag</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    unset re</span><br><span class="line">    unset thp_path</span><br><span class="line">    ;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">chmod 755 /etc/init.d/disable-transparent-hugepages</span><br><span class="line">chkconfig --add disable-transparent-hugepages</span><br><span class="line">chkconfig --list|grep disable</span><br><span class="line">source /etc/init.d/disable-transparent-hugepages</span><br><span class="line"></span><br><span class="line">/opt/mongo_cluster/mongodb/bin/mongod -f /opt/mongo_cluster/mongo_27017/conf/monogdb.conf --shutdown</span><br><span class="line">/opt/mongo_cluster/mongodb/bin/mongod -f /opt/mongo_cluster/mongo_27017/conf/monogdb.conf</span><br><span class="line">/opt/mongo_cluster/mongodb/bin/mongo db01:27017</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">** WARNING: soft rlimits too low. rlimits set to 15643 processes, 65535 files. Number of processes</span><br><span class="line">should be at least 32767.5 : 0.5 times number of files.</span><br><span class="line"></span><br><span class="line"># rlimits警告</span><br><span class="line">vim /etc/profile</span><br><span class="line">ulimit -u 64000</span><br><span class="line">source /etc/profile</span><br><span class="line">重启mongo服务</span><br></pre></td></tr></table></figure>





<h2 id="4-3目录规划"><a href="#4-3目录规划" class="headerlink" title="4.3目录规划"></a>4.3目录规划</h2><p>以软连接形式放在&#x2F;opt 目录下</p>
<h2 id="4-4软件安装"><a href="#4-4软件安装" class="headerlink" title="4.4软件安装"></a>4.4软件安装</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# yum install libcurl openssl -y</span><br><span class="line">[root@db01 ~]# mkdir /opt/mongo_cluster/-p</span><br><span class="line">[root@db01 ~]# mkdir /data/soft -p</span><br><span class="line">[root@db01 ~]# cd /data/soft/</span><br><span class="line">[root@db01 /data/soft]# wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-3.6.13.tgz</span><br><span class="line">[root@db01 /data/soft]# tar zxvf mongodb-linux-x86_64-3.6.13.tgz -C /opt/mongo_cluster/</span><br><span class="line">[root@db01 /data/soft]# cd /opt/mongo_cluster/</span><br><span class="line">[root@db01 /opt/mongo_cluster]# ln -s mongodb-linux-x86_64-3.6.13 mongodb</span><br><span class="line">[root@db01 /opt/mongodb_cluster]# mkdir /opt/mongo_cluster/mongo_27017/&#123;conf,logs,pid&#125; -p</span><br><span class="line">[root@db01 /opt/mongodb_cluster]# mkdir /data/mongo_cluster/mongo_27017 -p</span><br></pre></td></tr></table></figure>



<h2 id="4-5配置文件"><a href="#4-5配置文件" class="headerlink" title="4.5配置文件"></a>4.5配置文件</h2><p>参考博客</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://blog.csdn.net/MatrixGod/article/details/82585778</span><br></pre></td></tr></table></figure>

<p>配置文解释：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">systemLog:</span><br><span class="line">  destination: file  # Mongodb日志输出的目的地,指定一个file或者syslog,如果指定file,必须指定</span><br><span class="line">  logAppend: true  #当实例重启时，不创建新的日志文件，在老的日志文件末尾继续添加</span><br><span class="line">  path: /opt/mongo_cluster/mongo_27017/logs/mongodb.log  #日志路径</span><br><span class="line">  </span><br><span class="line">storage:</span><br><span class="line">  journal:  #回滚日志</span><br><span class="line">    enabled: true</span><br><span class="line">  dbPath: /data/mongo_cluster/mongo_27017  #数据存储目录</span><br><span class="line">  directoryPerDB: true  #默认false,不适用inmemory engine</span><br><span class="line">  wiredTiger:</span><br><span class="line">    engineConfig:</span><br><span class="line">      cacheSizeGB: 1  #将用于所有数据缓存的最大小</span><br><span class="line">      directoryForIndexes: true  #默认false 索引集合storage.dbPath存储在数据单独子目录</span><br><span class="line">    collectionConfig:</span><br><span class="line">      blockCompressor: zlib</span><br><span class="line">    indexConfig:</span><br><span class="line">      prefixCompression: true</span><br><span class="line"></span><br><span class="line">processManagement:    #使用处理系统守护进程的控制处理</span><br><span class="line">  fork: true    #后台运行</span><br><span class="line">  pidFilePath: /opt/mongo_cluster/mongo_27017/pid/mongod.pid  #创建 pid 文件</span><br><span class="line"></span><br><span class="line">net:</span><br><span class="line">  port: 27017  #监听端囗</span><br><span class="line">  bindIp: 127.0.0.1,10.0.0.51  #绑定 ip</span><br></pre></td></tr></table></figure>

<p>写入配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# cat &gt; /opt/mongo_cluster/mongo_27017/conf/monogdb.conf &lt;&lt; EOF</span><br><span class="line">systemLog:</span><br><span class="line">  derination: file</span><br><span class="line">  logAppend: true</span><br><span class="line">  path: /opt/mongo_cluster/mongo_27017/logs/mongodb.log</span><br><span class="line"></span><br><span class="line">storage:</span><br><span class="line">  journal:</span><br><span class="line">    enabled: true</span><br><span class="line">  dbPath: /data/mongo_cluster/mongo_27017</span><br><span class="line">  directoryPerDB: true</span><br><span class="line">  wiredTiger:</span><br><span class="line">    engineConfig:</span><br><span class="line">      cacheSizeGB: 1</span><br><span class="line">      directoryForIndexes: true</span><br><span class="line">    collectionConfig:</span><br><span class="line">      blockCompressor: zlib</span><br><span class="line">    indexConfig:</span><br><span class="line">      prefixCompression: true</span><br><span class="line"></span><br><span class="line">processManagement:</span><br><span class="line">  fork: true</span><br><span class="line">  pidFilePath: /opt/mongo_cluster/mongo_27017/pid/mongod.pid</span><br><span class="line"></span><br><span class="line">net:</span><br><span class="line">  port: 27017</span><br><span class="line">  bindIp: 127.0.0.1,10.0.0.51</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h2 id="4-6-启动关闭"><a href="#4-6-启动关闭" class="headerlink" title="4.6 启动关闭"></a>4.6 启动关闭</h2><h3 id="4-6-1启动命令"><a href="#4-6-1启动命令" class="headerlink" title="4.6.1启动命令"></a>4.6.1启动命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# /opt/mongodb/bin/mongod -f /opt/mongodb/conf/monogdb.conf</span><br><span class="line">about to fork child process, waiting until server is ready for connections.</span><br><span class="line">forked process: 3024</span><br><span class="line">child process started successfully, parent exiting</span><br></pre></td></tr></table></figure>



<h3 id="4-6-2检查命令"><a href="#4-6-2检查命令" class="headerlink" title="4.6.2检查命令"></a>4.6.2检查命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# ps -ef|grep mongo</span><br><span class="line">root    3024    1 3 10:26?    00:00:00 /opt/mongodb/bin/mongod -f /opt/mongodb/conf/monogdb.conf</span><br></pre></td></tr></table></figure>



<h3 id="4-6-3-写入环境变量"><a href="#4-6-3-写入环境变量" class="headerlink" title="4.6.3 写入环境变量"></a>4.6.3 写入环境变量</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# vim /etc/profile.d/mongodb.sh</span><br><span class="line">export PATH=/opt/mongo_cluster/mongodb/bin:$PATH</span><br><span class="line">[root@db01 ~]# source /etc/profile</span><br><span class="line">或</span><br><span class="line">[mongo@mongodb ~]$ vim .bashrc </span><br><span class="line">export PATH=/opt/mongo_cluster/mongodb/bin:$PATH</span><br><span class="line">[mongo@mongodb ~]$ source .bashrc</span><br></pre></td></tr></table></figure>



<h3 id="4-6-4创建hosts解析"><a href="#4-6-4创建hosts解析" class="headerlink" title="4.6.4创建hosts解析"></a>4.6.4创建hosts解析</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@mongodb ~]# vim /etc/hosts</span><br><span class="line">10.0.0.111 db01</span><br></pre></td></tr></table></figure>



<h3 id="4-6-5-连接命令"><a href="#4-6-5-连接命令" class="headerlink" title="4.6.5 连接命令"></a>4.6.5 连接命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongodb/bin/mongo db01:27017</span><br></pre></td></tr></table></figure>



<h3 id="4-6-6-关闭命令"><a href="#4-6-6-关闭命令" class="headerlink" title="4.6.6 关闭命令"></a>4.6.6 关闭命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongodb/bin/mongod -f mongo_27017/conf/monogdb.conf --shutdown</span><br></pre></td></tr></table></figure>





<h1 id="第5章-告警优化"><a href="#第5章-告警优化" class="headerlink" title="第5章 告警优化"></a>第5章 告警优化</h1><h2 id="5-1普通用户登陆"><a href="#5-1普通用户登陆" class="headerlink" title="5.1普通用户登陆"></a>5.1普通用户登陆</h2><p>告警内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2019-07-06T10:26:37.751+0800 I CONTROL [initandlisten] ** WARNING: You are running this process as the root user, which is not recommended.</span><br></pre></td></tr></table></figure>

<p>解决方案：</p>
<p>1.创建普通用户</p>
<p>2.更改目录权限</p>
<p>3.切换到普通用户后再启动 mongo</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# useradd mongo</span><br><span class="line">[root@db01 ~]# echo &#x27;123456&#x27;|passwd --stdin mongo</span><br><span class="line">[root@db01 ~]# chown -R mongo:mongo /opt/mongo_cluster</span><br><span class="line">[root@db01 ~]# chown –R mongo:mongo /data/mongo_cluster</span><br></pre></td></tr></table></figure>



<h2 id="5-2-关闭大内存页-hugepage"><a href="#5-2-关闭大内存页-hugepage" class="headerlink" title="5.2 关闭大内存页 hugepage"></a>5.2 关闭大内存页 hugepage</h2><p>官方网站：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://docs.mongodb.com/manual/tutorial/transparent-huge-pages/</span><br><span class="line">https://www.mongodb.com/docs/manual/tutorial/transparent-huge-pages/</span><br></pre></td></tr></table></figure>

<p>查看状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# cat /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">[always] madvise never</span><br><span class="line">[root@db01 ~]# cat /sys/kernel/mm/transparent_hugepage/defrag</span><br><span class="line">[always] madvise never</span><br></pre></td></tr></table></figure>

<p>临时关闭命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">[root@db01 ~]# echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br></pre></td></tr></table></figure>

<p>永久关闭命令，用官方的脚本写入开机自启动</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# cat /etc/init.d/disable-transparent-hugepages</span><br><span class="line">#!/bin/bash</span><br><span class="line">### BEGIN INIT INFO</span><br><span class="line"># Provides:    disable-transparent-hugepages</span><br><span class="line"># Required-Start:    $local_fs</span><br><span class="line"># Required-Stop:</span><br><span class="line"># X-Start-Before:    mongod mongodb-mms-automation-agent</span><br><span class="line"># Default-Start:    2 3 4 5</span><br><span class="line"># Default-Stop:    0 1 6</span><br><span class="line"># Short-Description:  Disable Linux transparent huge pages</span><br><span class="line"># Description:    Disable Linux transparent huge pages,to improve</span><br><span class="line">#    database performance.</span><br><span class="line">### END INIT INFO</span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">  start)</span><br><span class="line">    if [ -d /sys/kernel/mm/transparent_hugepage ];then</span><br><span class="line">      thp_path=/sys/kernel/mm/transparent_hugepage</span><br><span class="line">    elif [-d /sys/kernel/mm/redhat_transparent_hugepage ];then</span><br><span class="line">      thp_path=/sys/kernel/mm/redhat_transparent_hugepage</span><br><span class="line">    else</span><br><span class="line">      return 0</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    echo &#x27;never&#x27; &gt; $&#123;thp_path&#125;/enabled</span><br><span class="line">    echo &#x27;never&#x27; &gt; $&#123;thp_path&#125;/defrag</span><br><span class="line"></span><br><span class="line">    re=&#x27;^[0-1]+$&#x27;</span><br><span class="line">    if [[ $(cat $&#123;thp_path&#125;/khugepaged/defrag) = ~ $re ]]</span><br><span class="line">    then</span><br><span class="line">      # RHEL 7</span><br><span class="line">      echo 0 &gt; $&#123;thp_path&#125;/khugepaged/defrag</span><br><span class="line">    else</span><br><span class="line">      # RHEL 6</span><br><span class="line">      echo &#x27;no&#x27; &gt; $&#123;thp_path&#125;/khugepaged/defrag</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    unset re</span><br><span class="line">    unset thp_path</span><br><span class="line">    ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<p>赋予脚本权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# chmod 755 /etc/init.d/disable-transparent-hugepages</span><br></pre></td></tr></table></figure>

<p>加入开机自启动</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# chkconfig --add disable-transparent-hugepages</span><br><span class="line">[root@db01 ~]# chkconfig --list|grep disable</span><br></pre></td></tr></table></figure>



<h2 id="5-3内存占用超过80"><a href="#5-3内存占用超过80" class="headerlink" title="5.3内存占用超过80%"></a>5.3内存占用超过80%</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2019-07-06T11:23:16.801+0800 I STORAGE [initandlisten] ** WARNING: The configured WiredTiger cache size is more than 80% of available RAM.</span><br><span class="line">2019-07-06T11:23:16.801+0800 I STORAGE [initandlisten] **    See</span><br><span class="line">http://dochub.mongodb.org/core/faq-memory-diagnostics-wt</span><br></pre></td></tr></table></figure>

<p>解决方法：</p>
<p>增加内存或者在配置文件里把cash调小</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ grep &quot;cacheSizeGB&quot; /opt/mongo_cluster/mongo_27017/conf/mongodb.conf</span><br><span class="line">        cacheSizeGB:1</span><br></pre></td></tr></table></figure>



<h2 id="5-4用户访问控制"><a href="#5-4用户访问控制" class="headerlink" title="5.4用户访问控制"></a>5.4用户访问控制</h2><p>配置文件增加用户认证的配置参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">security:</span><br><span class="line">  authorization: enabled</span><br></pre></td></tr></table></figure>



<h2 id="5-5-relimit警告"><a href="#5-5-relimit警告" class="headerlink" title="5.5 relimit警告"></a>5.5 relimit警告</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># rlimits警告</span><br><span class="line">vim /etc/profile</span><br><span class="line">ulimit -u 64000</span><br><span class="line">source /etc/profile</span><br><span class="line">重启mongo服务</span><br></pre></td></tr></table></figure>





<h1 id="第6章-mongodb默认存在的库"><a href="#第6章-mongodb默认存在的库" class="headerlink" title="第6章 mongodb默认存在的库"></a>第6章 mongodb默认存在的库</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">test：登录时默认存在的库</span><br><span class="line">admin库：系统预留库，MongoDB 系统管理库</span><br><span class="line">1oca1库：本地预留库，存储关键日志</span><br><span class="line">config库：MongoDB配置信息库</span><br></pre></td></tr></table></figure>

<p>操作命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">show databases/show dbs</span><br><span class="line">show tables/show collections</span><br><span class="line">use admin</span><br><span class="line">db/select database()</span><br></pre></td></tr></table></figure>



<p>视频操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mongo基本操作</span><br><span class="line">&gt; show databases</span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line">local   0.000GB</span><br><span class="line">&gt; show dbs</span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line">local   0.000GB</span><br><span class="line">&gt; db</span><br><span class="line">test</span><br><span class="line">&gt; use local</span><br><span class="line">switched to db local</span><br><span class="line">&gt; db</span><br><span class="line">local</span><br><span class="line">&gt; show tables</span><br><span class="line">startup_log</span><br></pre></td></tr></table></figure>





<h1 id="第7章基本操作"><a href="#第7章基本操作" class="headerlink" title="第7章基本操作"></a>第7章基本操作</h1><h2 id="7-1介绍"><a href="#7-1介绍" class="headerlink" title="7.1介绍"></a>7.1介绍</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CRUD操作是create(创建),read(读取),update(更新)和delete(删除)文档。</span><br><span class="line">MongoDB不支持多文档事务（mongodb4.0开始支持ACID）。但是MongoDB确实在一个文档上提供了原子操作。尽管集合中的文档通常都是相同的，但是MongoDB 中的集合不需要指定schema。</span><br><span class="line">MongoDB不支持SQL但是支持自己的丰富的查询语言。</span><br><span class="line">在MongoDB中，存储在集合中的每个文档都需要一个唯一的_id字段，作为主键。如果插入的文档省略了该_id字段，则MongoDB驱动程序将自动为该字段生成一个ObjectId_id。也用于通过更新操作插入的文档upsert:true.如果文档包含一个_id字段，该_id值在集合中必须是唯一的，以避免重复键错误。</span><br><span class="line">在MongoDB中，插入操作针对单个集合。MongoDB中的所有写操作都是在单个文档的级别上进行的</span><br></pre></td></tr></table></figure>



<h2 id="7-2显示命令"><a href="#7-2显示命令" class="headerlink" title="7.2显示命令"></a>7.2显示命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Help: 显示帮助。</span><br><span class="line">db.help() 显示数据库方法的帮助。</span><br><span class="line">db.&lt;collection&gt;.help() 显示收集方法的帮助，&lt;collection&gt;可以是现有的集合或不存在的集合的名称。</span><br><span class="line">show dbs 打印服务器上所有数据库的列表。</span><br><span class="line">use&lt;db&gt; 将当前数据库切换到&lt;db&gt;。该mongoshell变量db被设置为当前数据库。</span><br><span class="line">show collections 打印当前数据库的所有集合的列表</span><br><span class="line">show users  打印当前数据库的用户列表。</span><br><span class="line">show roles 打印用于当前数据库的用户定义和内置的所有角色的列表。</span><br><span class="line">show profile 打印需要1毫秒或更多的五个最近的操作。有关详细信息，请参阅数据库分析器上的文档。</span><br><span class="line">show databases 打印所有可用数据库的列表。</span><br><span class="line">load() 执行一个JavaScript文件。</span><br></pre></td></tr></table></figure>



<h2 id="7-3创建索引"><a href="#7-3创建索引" class="headerlink" title="7.3创建索引"></a>7.3创建索引</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">默认情况下，创建索引将阻止数据库上的所有其他操作。在集合上构建索引时，保存集合的数据库对于读取或写入操作是不可用的，直到索引构建完成。任何需要对所有数据库(例如listDatabases)进行读或写锁定的操作将等待前台索引构建完成。</span><br><span class="line">对于可能需要长时间运行的索引创建操作，可以考虑background选项，这样MongoDB数据库在索引创建期间仍然是可用的。例如，在people集合的zipcode键上创建一个索引，这个过程在后台运行，可以使用如下</span><br><span class="line">方式：</span><br><span class="line">db.people.createIndex(&#123;zipcode: 1&#125;, &#123;background: true&#125;)</span><br><span class="line">默认MongoDB索引创建的background是 false。</span><br><span class="line">索引优化： db.test.find(&#123;&quot;id&quot;:100&#125;).explain()</span><br></pre></td></tr></table></figure>

<p>db.people.createIndex({ zipcode: 1}, {background: true})</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.find(&#123;qty: &#123;$lt: 30&#125;&#125;)</span><br></pre></td></tr></table></figure>

<p>查看执行信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&gt;db.test.find(&#123;&quot;age&quot;:&#123; $lt: 30 &#125;&#125;)</span><br><span class="line">&#123;&quot;_id&quot;:Objectld(&quot;5cd60b69082200657d67d78a&quot;),&quot;name&quot;:&quot;zhangya&quot;,&quot;age&quot;:27,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;</span><br><span class="line">&#123;&quot;_id&quot;:ObjectId(&quot;5cd60b69082200657d67d78b&quot;),&quot;name&quot;:&quot;zhangya&quot;,&quot;age&quot;:27,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;</span><br><span class="line">&#123;&quot;_id&quot;:ObjectId(&quot;5cd60b69082200657d67d78c&quot;),&quot;name&quot;:&quot;yazhang&quot;,&quot;age&quot;:28,&quot;ad&quot;:“北京市朝阳区&quot;&#125;</span><br><span class="line">&#123;&quot;_id&quot;:ObjectId(&quot;5cd60b69082200657d67d78d&quot;),&quot;name&quot;:&quot;xiaozhang&quot;,&quot;age&quot;:28,&quot;ad&quot;:&quot;北京市朝阳区</span><br><span class="line">&quot;&#125;</span><br><span class="line">&#123;&quot;_id&quot;:ObjectId(&quot;5cd60b69082200657d67d78e&quot;),&quot;name&quot;:&quot;xiaozhang&quot;,&quot;age&quot;:28,&quot;ad&quot;:&quot;北京市朝阳区&quot;,&quot;sex&quot;:&quot;boy&quot;&#125;</span><br><span class="line">&gt; db.test.find(&#123;&quot;age&quot;:&#123; $lt: 30 &#125;&#125;).explain()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;queryPlanner&quot;: &#123;</span><br><span class="line">        &quot;plannerVersion&quot;: 1,</span><br><span class="line">        &quot;namespace&quot;: &quot;test.test&quot;,</span><br><span class="line">        &quot;indexFilterSet&quot;: false,</span><br><span class="line">        &quot;parsedQuery&quot;: &#123;</span><br><span class="line">            &quot;age&quot;: &#123;</span><br><span class="line">                &quot;$lt&quot;: 30</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;winningPlan&quot;: &#123;</span><br><span class="line">            &quot;stage&quot;: &quot;COLLSCAN&quot;,</span><br><span class="line">            &quot;filter&quot;: &#123;</span><br><span class="line">                    &quot;age&quot;: &#123;</span><br><span class="line">                            &quot;$lt&quot;: 30</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;direction&quot;: &quot;forward&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;rejectedPlans&quot;: []</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;serverInfo&quot;: &#123;</span><br><span class="line">            &quot;host&quot;: &quot;mongo01&quot;,</span><br><span class="line">            &quot;port&quot;: 27017,</span><br><span class="line">            &quot;version&quot;: &quot;3.4.20&quot;,</span><br><span class="line">            &quot;gitVersion&quot;: &quot;447847d93d6e0a21b018d5df45528e815c7c13d8&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;ok&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.test.createIndex( &#123; age: 1 &#125;)</span><br><span class="line">&#123;</span><br><span class="line">        &quot;createdCollectionAutomatically&quot;: false,</span><br><span class="line">        &quot;numIndexesBefore&quot;: 2,</span><br><span class="line">        &quot;numIndexesAfter&quot;: 3,</span><br><span class="line">        &quot;ok&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.test.getIndexes0</span><br><span class="line">[</span><br><span class="line">        &#123;</span><br><span class="line">                &quot;v&quot;: 2,</span><br><span class="line">                &quot;key&quot;:&#123;</span><br><span class="line">                        &quot;_id&quot;: 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;name&quot;: &quot;_id_&quot;,</span><br><span class="line">                &quot;ns&quot;: &quot;test.test&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">                &quot;V&quot;: 2,</span><br><span class="line">                &quot;key&quot;: &#123;</span><br><span class="line">                        &quot;age&quot;: 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;name&quot;: &quot;age_1&quot;,</span><br><span class="line">                &quot;ns&quot;: &quot;test.test&quot;</span><br><span class="line">        &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>再次查看执行计划</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.test.find(&#123;&quot;age&quot;:&#123; $lt: 30 &#125;&#125;).explain()</span><br><span class="line">&#123;</span><br><span class="line">        &quot;queryPlanner&quot;:&#123;</span><br><span class="line">                &quot;plannerVersion&quot;: 1,</span><br><span class="line">                &quot;namespace&quot;: &quot;test.test&quot;,</span><br><span class="line">                &quot;indexFilterSet&quot;: false,</span><br><span class="line">                &quot;parsedQuery&quot;: &#123;</span><br><span class="line">                        &quot;age&quot;: &#123;</span><br><span class="line">                                &quot;$lt&quot;: 30</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">        &quot;winningPlan&quot;: &#123;</span><br><span class="line">                &quot;stage&quot;:&quot;FETCH&quot;,</span><br><span class="line">                &quot;inputStage&quot;: &#123;</span><br><span class="line">                        &quot;stage&quot;: &quot;IXSCAN&quot;,</span><br><span class="line">                        &quot;keyPattern&quot;: &#123;</span><br><span class="line">                                &quot;age&quot; :1</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;indexName&quot;: &quot;age_1&quot;,</span><br><span class="line">                        &quot;isMultiKey&quot;: false,</span><br><span class="line">                        &quot;multiKeyPaths&quot;: &#123;</span><br><span class="line">                                &quot;age&quot;:[]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &quot;isUnique&quot;: false,</span><br><span class="line">                        &quot;isSparse&quot;: false,</span><br><span class="line">                        &quot;isPartial&quot;: false,</span><br><span class="line">                        &quot;indexVersion&quot;: 2,</span><br><span class="line">                        &quot;direction&quot;: &quot;forward&quot;,</span><br><span class="line">                        &quot;indexBounds&quot;: &#123;</span><br><span class="line">                                &quot;age&quot;: [</span><br><span class="line">                                        &quot;[-inf.0, 30.0)&quot;</span><br><span class="line">                                ]</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;，</span><br><span class="line">        &quot;rejectedPlans&quot;: []</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;serverInfo&quot;: &#123;</span><br><span class="line">            &quot;host&quot;: &quot;mongo01&quot;,</span><br><span class="line">            &quot;port&quot;: 27017,</span><br><span class="line">            &quot;version&quot;: &quot;3.4.20&quot;,</span><br><span class="line">            &quot;gitVersion&quot;: &quot;447847d93d6e0a21b018d5df45528e815c7c13d8&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;ok&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>删除索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.test.dropIndex(&#123; name: 1 &#125;)</span><br><span class="line">&#123;&quot;nIndexesWas&quot;: 3, &quot;ok&quot;: 1&#125;</span><br></pre></td></tr></table></figure>



<p>视频操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">帮助命令</span><br><span class="line">help</span><br><span class="line">db.help()</span><br><span class="line">db.stats()</span><br><span class="line"></span><br><span class="line"># 插入数据</span><br><span class="line">db.test.insert(&#123;&quot;name&quot;:&quot;zhangya&quot;,&quot;age&quot;:27,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;)</span><br><span class="line">db.test.insert(&#123;&quot;name&quot;:&quot;zhangya&quot;,&quot;age&quot;:27,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;)</span><br><span class="line">db.test.insert(&quot;name&quot;:&quot;yazhang&quot;,&quot;age&quot;:28,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;)</span><br><span class="line">db.test.insert(&#123;&quot;name&quot;:&quot;xiaozhang&quot;,&quot;age&quot;:28,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;)</span><br><span class="line">db.test.insert(&#123;&quot;name&quot;:&quot;xiaozhang&quot;,&quot;age&quot;:28,&quot;ad&quot;:&quot;北京市朝阳区&quot;,&quot;sex&quot;:&quot;boy&quot;&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#批量插入多条数据</span><br><span class="line">db.inventory.insertMany([</span><br><span class="line">     &#123;&quot;item&quot;: &quot;journal&quot;, &quot;qty&quot;: 25, &quot;size&quot;: &#123;&quot;h&quot;: 14, &quot;w&quot;: 21,&quot;uom&quot;: &quot;cm&quot;&#125;, &quot;status&quot;: &quot;A&quot;&#125;,</span><br><span class="line">     &#123;&quot;item&quot;: &quot;notebook&quot;, &quot;qty&quot;: 50, &quot;size&quot;: &#123;&quot;h&quot;: 8.5, &quot;w&quot;: 11,&quot;uom&quot;:&quot;in&quot;&#125;,&quot;status&quot;: &quot;A&quot;&#125;,</span><br><span class="line">     &#123;&quot;item&quot;: &quot;paper&quot;, &quot;qty&quot;: 100, &quot;size&quot;: &#123;&quot;h&quot;: 8.5, &quot;w&quot;: 11, &quot;uom&quot;: &quot;in&quot;&#125;, &quot;status&quot;: &quot;D&quot;&#125;,</span><br><span class="line">     &#123;&quot;item&quot;: &quot;planner&quot;, &quot;qty&quot;:75, &quot;size&quot;: &#123;&quot;h&quot;: 22.85, &quot;w&quot;: 30,&quot;uom&quot;: &quot;cm&quot;&#125;, &quot;status&quot;: &quot;D&quot;&#125;,</span><br><span class="line">     &#123;&quot;item&quot;: &quot;postcard&quot;, &quot;qty&quot;: 45, &quot;size&quot;: &#123;&quot;h&quot;: 10,&quot;w&quot;:15.25,&quot;uom&quot;:&quot;cm&quot;&#125;,&quot;status&quot;: &quot;A&quot;&#125;</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">#查询数据</span><br><span class="line">db.test.find()</span><br><span class="line">db.test.findOne()</span><br><span class="line">db.inventory.find()</span><br><span class="line">db.inventory.findOne()</span><br><span class="line"></span><br><span class="line">#条件查询</span><br><span class="line">db.inventory.find(&#123;&quot;status&quot;:&quot;D&quot;&#125;)</span><br><span class="line">db.inventory.find(&#123;&quot;size.uom&quot;:&quot;cm&quot;&#125;)</span><br><span class="line">db.inventory.find(&#123;&quot;size.uom&quot;:&quot;cm&quot;,&quot;qty&quot;:&#123;$lt:50&#125;&#125;)</span><br><span class="line">db.inventory.find(&#123;&quot;size.uom&quot;:&quot;cm&quot;,&quot;qty&quot;:&#123;$eq:75&#125;&#125;)</span><br><span class="line">myCursor = db.inventory.find(&#123; $or: [&#123; status:&quot;A&quot;&#125;,&#123; qty: &#123; $lt: 30&#125;&#125;]&#125;)</span><br><span class="line">myCursor = db.inventory.find( &#123;status: &quot;A&quot;,$or: [&#123;qty: &#123;$lt: 30 &#125;&#125;, &#123;item: /^p/&#125;]&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">db.inventory.find(</span><br><span class="line">    &#123;</span><br><span class="line">    &quot;size.uom&quot;:&quot;cm&quot;,</span><br><span class="line">    &quot;qty&quot;:</span><br><span class="line">        &#123;</span><br><span class="line">            $lt:50</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">db.inventory.find(&#123;</span><br><span class="line">    $and:[</span><br><span class="line">        &#123; $or:[&#123;&quot;status&quot;:&quot;D&quot;&#125;,&#123;&quot;qty&quot;:&#123;$lt:50&#125;&#125;]&#125;,</span><br><span class="line">        &#123; $or:[&#123;&quot;status&quot;:&quot;A&quot;&#125;,&#123;&quot;qty&quot;:&#123;$lt:50&#125;&#125;]&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">myCursor = db.inventory.find( &#123;</span><br><span class="line">    status: &quot;A&quot;,</span><br><span class="line">    $or: [&#123;qty: &#123;$lt: 30 &#125;&#125;, &#123;item: /^p/&#125;]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">db.inventory.find(&#123;&quot;size.h&quot;:&#123;$gt:10&#125;&#125;)</span><br><span class="line">db.inventory.find(&#123;&quot;size.h&quot;:&#123;$gt:10&#125;&#125;,&#123;&quot;qty&quot;:100&#125;)</span><br><span class="line"></span><br><span class="line">上午回顾</span><br><span class="line">1.sql和nosql关系</span><br><span class="line">2.mongo介绍</span><br><span class="line">3.mongo的应用场景</span><br><span class="line">4.安装部署</span><br><span class="line">5.修改配置文件，启动关闭</span><br><span class="line">6.优化警告</span><br><span class="line">7.插入</span><br><span class="line">- 单条插入</span><br><span class="line">- 多条插入</span><br><span class="line">8.查询</span><br><span class="line">- 查询所有</span><br><span class="line">- 按条件查询</span><br><span class="line">- 按条件和正则查询</span><br><span class="line">9.改</span><br><span class="line">10.删</span><br><span class="line">11.主从复制</span><br><span class="line">12.工具使用</span><br><span class="line">13.备份恢复</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">db.inventory.find(</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;size.h&quot;:&#123;$gt:10&#125;,</span><br><span class="line">        &quot;qty&quot;:100</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">db.inventory.updateOne(</span><br><span class="line">    &#123;&quot;item&quot;:&quot;paper&quot; &#125;, // specifies the document to update</span><br><span class="line">    &#123;</span><br><span class="line">        $set:&#123; &quot;size.uom&quot;:&quot;cm&quot;, &quot;status:&quot;P&quot;&#125;,</span><br><span class="line">        $currentDate: &#123; &quot;lastModified&quot;: true &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">更新前的内容</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;632045b71f696e4961d858ee&quot;), &quot;item&quot; : &quot;paper&quot;, &quot;qty&quot; : 100, &quot;size&quot; : &#123; &quot;h&quot; : 8.5, &quot;w&quot; : 11, &quot;uom&quot; : &quot;in&quot; &#125;, &quot;status&quot; : &quot;D&quot; &#125;</span><br><span class="line"></span><br><span class="line">更新语句</span><br><span class="line">db.inventory.updateOne(</span><br><span class="line">    &#123; &quot;item&quot; : &quot;paper&quot; &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      $set: &#123; &quot;size.uom&quot;:&quot;cm&quot;,&quot;status&quot;:&quot;P&quot;&#125;,</span><br><span class="line">      $currentDate:&#123;&quot;lastModified&quot;:true&#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">更新后的内容</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;632045b71f696e4961d858ee&quot;), &quot;item&quot; : &quot;paper&quot;, &quot;qty&quot; : 100, &quot;size&quot; : &#123; &quot;h&quot; : 8.5, &quot;w&quot; : 11, &quot;uom&quot; : &quot;cm&quot; &#125;, &quot;status&quot; : &quot;P&quot;, &quot;lastModified&quot; : ISODate(&quot;2022-09-13T09:47:36.954Z&quot;) &#125;</span><br><span class="line"></span><br><span class="line">更新多条</span><br><span class="line">db.inventory.updateMany(</span><br><span class="line">    &#123; &quot;qty&quot; : &#123;$lt: 50 &#125;&#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        $set:&#123;&quot;size.uom&quot;:&quot;cm&quot;, &quot;status&quot;: &quot;P&quot;&#125;,</span><br><span class="line">        $currentDate : &#123; &quot;lastModified&quot;: true &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">删除内容</span><br><span class="line">db.inventory.find( &#123;&quot;status&quot;:&quot;D&quot;&#125;)</span><br><span class="line">db.inventory.deleteOne(</span><br><span class="line">    &#123;&quot;status&quot;:&quot;D&quot;&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">db.inventory.find(&#123;&quot;status&quot;: &quot;P&quot;&#125;)</span><br><span class="line">db.inventory.deleteMany(</span><br><span class="line">  &#123;&quot;status&quot;: &quot;P&quot;&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>







<h2 id="7-4-插入数据"><a href="#7-4-插入数据" class="headerlink" title="7.4 插入数据"></a>7.4 插入数据</h2><h3 id="7-4-1-官方文档"><a href="#7-4-1-官方文档" class="headerlink" title="7.4.1 官方文档"></a>7.4.1 官方文档</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://docs.mongodb.com/guides/server/read_queries/</span><br></pre></td></tr></table></figure>

<h3 id="7-4-2单行插入"><a href="#7-4-2单行插入" class="headerlink" title="7.4.2单行插入"></a>7.4.2单行插入</h3><p>命令集合</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.test.insert(&#123;&quot;name&quot;:&quot;zhangya&quot;,&quot;age&quot;:27,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;)</span><br><span class="line">db.test.insert(&#123;&quot;name&quot;:&quot;zhangya&quot;,&quot;age&quot;:27,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;)</span><br><span class="line">db.test.insert(&#123;&quot;name&quot;:&quot;yazhang&quot;,&quot;age&quot;:28,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;)</span><br><span class="line">db.test.insert(&#123;&quot;name&quot;:&quot;xiaozhang&quot;,&quot;age&quot;:28,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;)</span><br><span class="line">db.test.insert(&#123;&quot;name&quot;:&quot;xiaozhang&quot;,&quot;age&quot;:28,&quot;ad&quot;:&quot;北京市朝阳区&quot;,&quot;sex&quot;:&quot;boy&quot;&#125;)</span><br></pre></td></tr></table></figure>

<p>执行结果；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.test.insert(&#123;&quot;name&quot;:&quot;zhangya&quot;,&quot;age&quot;:27,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;)</span><br><span class="line">WriteResult(&#123; &quot;nInserted&quot;: 1 &#125;)</span><br><span class="line">&gt; db.test.insert(&#123;&quot;name&quot;:&quot;zhangya&quot;,&quot;age&quot;:27,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;)</span><br><span class="line">WriteResult(&#123; &quot;nInserted&quot;: 1 &#125;)</span><br><span class="line">&gt; db.test.insert(&#123;&quot;name&quot;:&quot;yazhang&quot;,&quot;age&quot;:28,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;)</span><br><span class="line">WriteResult(&#123; &quot;nInserted&quot;: 1 &#125;)</span><br><span class="line">&gt; db.test.insert(&#123;&quot;name&quot;:&quot;xiaozhang&quot;，&quot;age&quot;:28,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;)</span><br><span class="line">WriteResult(&#123; &quot;nInserted&quot;: 1 &#125;)</span><br><span class="line">&gt; db.test.insert(&#123;&quot;name&quot;:&quot;xiaozhang&quot;,&quot;age&quot;:28,&quot;ad&quot;:&quot;北京市朝阳区&quot;,&quot;sex&quot;:&quot;boy&quot;&#125;)</span><br><span class="line">WriteResult(&#123; &quot;nInserted&quot;: 1 &#125;)</span><br></pre></td></tr></table></figure>



<h3 id="7-4-3多行插入"><a href="#7-4-3多行插入" class="headerlink" title="7.4.3多行插入"></a>7.4.3多行插入</h3><p>官网举例命令集合：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.insertMany([</span><br><span class="line">     &#123;&quot;item&quot;: &quot;journal&quot;, &quot;qty&quot;: 25, &quot;size&quot;: &#123;&quot;h&quot;: 14, &quot;w&quot;: 21,&quot;uom&quot;: &quot;cm&quot;&#125;, &quot;status&quot;: &quot;A&quot;&#125;,</span><br><span class="line">     &#123;&quot;item&quot;: &quot;notebook&quot;, &quot;qty&quot;: 50, &quot;size&quot;: &#123;&quot;h&quot;: 8.5, &quot;w&quot;: 11,&quot;uom&quot;:&quot;in&quot;&#125;,&quot;status&quot;: &quot;A&quot;&#125;,</span><br><span class="line">     &#123;&quot;item&quot;: &quot;paper&quot;, &quot;qty&quot;: 100, &quot;size&quot;: &#123;&quot;h&quot;: 8.5, &quot;w&quot;: 11, &quot;uom&quot;: &quot;in&quot;&#125;, &quot;status&quot;: &quot;D&quot;&#125;,</span><br><span class="line">     &#123;&quot;item&quot;: &quot;planner&quot;, &quot;qty&quot;:75, &quot;size&quot;: &#123;&quot;h&quot;: 22.85, &quot;w&quot;: 30,&quot;uom&quot;: &quot;cm&quot;&#125;, &quot;status&quot;: &quot;D&quot;&#125;,</span><br><span class="line">     &#123;&quot;item&quot;: &quot;postcard&quot;, &quot;qty&quot;: 45, &quot;size&quot;: &#123;&quot;h&quot;: 10,&quot;w&quot;:15.25,&quot;uom&quot;:&quot;cm&quot;&#125;,&quot;status&quot;: &quot;A&quot;&#125;</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<p>执行过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.inventory.insertMany([</span><br><span class="line">... &#123;&quot;item&quot;:&quot;journal&quot;, &quot;qty&quot;: 25, &quot;size&quot;:&#123;&quot;h&quot;:14,&quot;w&quot;:21,&quot;uom&quot;:&quot;cm&quot;&#125;, &quot;status&quot;:&quot;A&quot;&#125;,</span><br><span class="line">... &#123;&quot;item&quot;:&quot;notebook&quot;,&quot;qty&quot;: 50,&quot;size&quot;:&#123;&quot;h&quot;:8.5,&quot;w&quot;:11,&quot;uom&quot;:&quot;in&quot;&#125;,&quot;status&quot;:&quot;A&quot;&#125;,</span><br><span class="line">... &#123;&quot;item&quot;:&quot;paper&quot;, &quot;qty&quot;: 100, &quot;size&quot;:&#123;&quot;h&quot;: 8.5, &quot;w&quot;: 11, &quot;uom&quot;: &quot;in&quot; &#125;, &quot;status&quot;: &quot;D&quot;&#125;,</span><br><span class="line">... &#123;&quot;item: &quot;planner&quot;,&quot;qty&quot;:75, &quot;size&quot;:&#123;&quot;h&quot;:22.85,&quot;w&quot;:30,&quot;uom&quot;:&quot;cm&quot;&#125;,&quot;status&quot;:&quot;D&#125;,</span><br><span class="line">... &#123;&quot;item&quot;:&quot;postcard&quot;, &quot;qty&quot;: 45, &quot;size&quot;:&#123;&quot;h&quot;: 10, &quot;w&quot;: 15.25,&quot;uom&quot;:&quot;cm&quot;&#125;,&quot;status&quot;:&quot;A&quot;&#125;</span><br><span class="line">... ]);</span><br><span class="line">&#123;</span><br><span class="line">        &quot;acknowledged&quot;: true,</span><br><span class="line">        &quot;insertedIds&quot;: [</span><br><span class="line">                ObjectId(&quot;5cd60d2c082200657d67d78f&quot;),</span><br><span class="line">                ObjectId(&quot;5cd60d2c082200657d67d790&quot;),</span><br><span class="line">                ObjectId(&quot;5cd60d2c082200657d67d791&quot;),</span><br><span class="line">                ObjectId(&quot;5cd60d2c082200657d67d792&quot;),</span><br><span class="line">                ObjectId(&quot;5cd60d2c082200657d67d793&quot;)</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="7-5查询数据"><a href="#7-5查询数据" class="headerlink" title="7.5查询数据"></a>7.5查询数据</h2><h3 id="7-5-1查询所有"><a href="#7-5-1查询所有" class="headerlink" title="7.5.1查询所有"></a>7.5.1查询所有</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.test.find()</span><br><span class="line">&#123;&quot;_id&quot;:ObjectId(&quot;5cd60b69082200657d67d78a&quot;),&quot;name&quot;:“zhangya&quot;,&quot;age&quot;:27,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;</span><br><span class="line">&#123;&quot;_id&quot;:ObjectId(&quot;5cd60b69082200657d67d78b&quot;),&quot;name&quot;:&quot;zhangya&quot;,&quot;age&quot;:27,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;</span><br><span class="line">&#123;&quot;_id&quot;:ObjectId(&quot;5cd60b69082200657d67d78c&quot;),&quot;name&quot;:&quot;yazhang&quot;,&quot;age&quot;:28,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;</span><br><span class="line">&#123;&quot;_id&quot;:ObjectId(&quot;5cd60b69082200657d67d78d&quot;),&quot;name&quot;:&quot;xiaozhang&quot;,&quot;age&quot;:28,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;</span><br><span class="line">&#123;&quot;_id&quot;:ObjectId(&quot;5cd60b69082200657d67d78e&quot;),&quot;name&quot;:&quot;xiaozhang&quot;,&quot;age&quot;:28,&quot;ad&quot;:&quot;北京市朝阳区&quot;,&quot;sex&quot;:&quot;boy&quot;&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-5-2查询单条"><a href="#7-5-2查询单条" class="headerlink" title="7.5.2查询单条"></a>7.5.2查询单条</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.test.findOne()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;_id&quot; : ObjectId(&quot;5cd60b69082200657d67d78a&quot;),</span><br><span class="line">    &quot;name&quot;:&quot;zhangya&quot;,</span><br><span class="line">    &quot;age&quot;: 27,</span><br><span class="line">    “ad”: &quot;北京市朝阳区”</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="7-5-3条件查询"><a href="#7-5-3条件查询" class="headerlink" title="7.5.3条件查询"></a>7.5.3条件查询</h3><p>官网举例1：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; myCursor = db.inventory.find( &#123; status: &quot;D&quot;&#125;)</span><br><span class="line">&#123;&quot;_id&quot;:ObjectId(&quot;5cd60d2c082200657d67d791&quot;),&quot;item&quot;:&quot;paper&quot;, &quot;qty&quot;:100,&quot;size&quot;:&#123;&quot;h&quot;:8.5,&quot;w&quot;:11,&quot;uom&quot;:&quot;in&quot;&#125;,&quot;status&quot;:&quot;D&quot;&#125;</span><br><span class="line">&#123;&quot;_id&quot;:ObjectId(&quot;5cd60d2c082200657d67d792&quot;),&quot;item&quot;:&quot;planner&quot;,&quot;qty&quot;:75, &quot;size&quot;:&#123;&quot;h&quot;: 22.85,&quot;w&quot;:30, &quot;uom&quot;:&quot;cm&quot;&#125;, &quot;status&quot;:&quot;D&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>官网举例2：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; myCursor = db.inventory.find(&#123;&quot;size.uom&quot;: &quot;in&quot; &#125;)</span><br><span class="line">&#123;&quot;_id&quot;:Objectld(&quot;5cd60d2c082200657d67d790&quot;), &quot;item&quot;:&quot;notebook&quot;,&quot;qty&quot;:50,&quot;size&quot;:&#123;&quot;h&quot;:8.5,&quot;w&quot;:11,&quot;uom&quot;: &quot;in&quot;&#125;,&quot;status&quot;:&quot;A&quot;&#125;</span><br><span class="line">&#123;&quot;_id&quot;:Objectld(&quot;5cd60d2c082200657d67d791&quot;),&quot;item&quot;:&quot;paper&quot;,&quot;qty&quot;:100,&quot;size&quot;:&#123;&quot;h&quot;:8.5,&quot;w&quot;:11,&quot;uom&quot;:&quot;in&quot;&#125;,&quot;status&quot;:&quot;D&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>官网举例3:and</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; myCursor = db.inventory.find(&#123; status: &quot;A&quot;, qty: &#123; $It: 30 &#125;&#125;)</span><br><span class="line">&#123;&quot;_id: Objectld(&quot;5cd60d2c082200657d67d78f&quot;), &quot;item&quot;:&quot;journal&quot;,&quot;qty&quot;:25,&quot;size&quot;:&#123;&quot;h&quot;:14,&quot;w&quot;:21,&quot;uom&quot;:&quot;cm&quot;&#125;,&quot;status&quot;:&quot;A&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>官网举例4:or</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; myCursor = db.inventory.find(&#123; $or: [&#123; status:&quot;A&quot;&#125;,&#123; qty: &#123; $lt: 30&#125;&#125;]&#125;)</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;632045b71f696e4961d858ec&quot;), &quot;item&quot; : &quot;journal&quot;, &quot;qty&quot; : 25, &quot;size&quot; : &#123; &quot;h&quot; : 14, &quot;w&quot; : 21, &quot;uom&quot; : &quot;cm&quot; &#125;, &quot;status&quot; : &quot;A&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;632045b71f696e4961d858ed&quot;), &quot;item&quot; : &quot;notebook&quot;, &quot;qty&quot; : 50, &quot;size&quot; : &#123; &quot;h&quot; : 8.5, &quot;w&quot; : 11, &quot;uom&quot; : &quot;in&quot; &#125;, &quot;status&quot; : &quot;A&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;632045b71f696e4961d858f0&quot;), &quot;item&quot; : &quot;postcard&quot;, &quot;qty&quot; : 45, &quot;size&quot; : &#123; &quot;h&quot; : 10, &quot;w&quot; : 15.25, &quot;uom&quot; : &quot;cm&quot; &#125;, &quot;status&quot; : &quot;A&quot; &#125;</span><br></pre></td></tr></table></figure>

<p>官网举例5：正则</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">myCursor = db.inventory.find( &#123;status: &quot;A&quot;,$or: [&#123;qty: &#123;$lt: 30 &#125;&#125;, &#123;item: /^p/&#125;]&#125;)</span><br><span class="line">或者：</span><br><span class="line">myCursor = db.inventory.find( &#123;</span><br><span class="line">    status: &quot;A&quot;,</span><br><span class="line">    $or: [&#123;qty: &#123;$lt: 30 &#125;&#125;, &#123;item: /^p/&#125;]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>返回结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; myCursor = db.inventory.find(&#123;</span><br><span class="line">...     status: &quot;A&quot;,</span><br><span class="line">...     $or: [&#123; qty:&#123;$lt: 30&#125;&#125;,&#123;item:/^p/&#125;]</span><br><span class="line">...&#125;)</span><br><span class="line">&#123;&quot;_id&quot;:ObjectId(&quot;5cd60d2c082200657d67d78f&quot;), &quot;item&quot;: &quot;journal&quot;, &quot;qty&quot;: 25, &quot;size&quot;:&#123;&quot;h&quot;:14, &quot;w&quot;:21,</span><br><span class="line">&quot;uom&quot;:&quot;cm&quot;&#125;,&quot;status&quot;:&quot;A&quot;&#125;</span><br><span class="line">&#123;&quot;_id&quot;:Objectld(&quot;5cd60d2c082200657d67d793&quot;), &quot;item&quot;:&quot;postcard&quot;, &quot;qty&quot;:45, &quot;size&quot;:&#123;&quot;h&quot;:10,&quot;w&quot;:</span><br><span class="line">15.25,&quot;uom&quot;:&quot;cm&quot;&#125;,&quot;status&quot;:&quot;A&quot;&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<h3 id="7-5-4查看数据库命令"><a href="#7-5-4查看数据库命令" class="headerlink" title="7.5.4查看数据库命令"></a>7.5.4查看数据库命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; show dbs</span><br><span class="line">admin 0.000GB</span><br><span class="line">local 0.000GB</span><br><span class="line">test 0.000GB</span><br><span class="line">test2 0.000GB</span><br><span class="line">&gt; use test</span><br><span class="line">switched to db test</span><br><span class="line">&gt; db</span><br><span class="line">test</span><br><span class="line">&gt; show collections</span><br><span class="line">inventory</span><br><span class="line">test</span><br></pre></td></tr></table></figure>





<h2 id="7-6更新数据"><a href="#7-6更新数据" class="headerlink" title="7.6更新数据"></a>7.6更新数据</h2><h3 id="7-6-1跟新单个文档"><a href="#7-6-1跟新单个文档" class="headerlink" title="7.6.1跟新单个文档"></a>7.6.1跟新单个文档</h3><p>命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.updateOne(</span><br><span class="line">    &#123;&quot;item&quot;:&quot;paper&quot; &#125;, // specifies the document to update</span><br><span class="line">    &#123;</span><br><span class="line">        $set:&#123; &quot;size.uom&quot;:&quot;cm&quot;, &quot;status:&quot;P&quot;&#125;,</span><br><span class="line">        $currentDate: &#123; &quot;lastModified&quot;: true &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>执行结果；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.inventory.updateOne(</span><br><span class="line">...     &#123; &quot;item&quot; : &quot;paper&quot; &#125;,  // specifies the document to update</span><br><span class="line">...     &#123;</span><br><span class="line">...       $set: &#123; &quot;size.uom&quot;:&quot;cm&quot;,&quot;status&quot;:&quot;P&quot;&#125;,</span><br><span class="line">...       $currentDate:&#123;&quot;lastModified&quot;:true&#125;</span><br><span class="line">...     &#125;</span><br><span class="line">... )</span><br><span class="line">&#123; &quot;acknowledged&quot; : true, &quot;matchedCount&quot; : 1, &quot;modifiedCount&quot; : 1 &#125;</span><br></pre></td></tr></table></figure>

<p>查看数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.inventory.find(&#123;&quot;item&quot; : &quot;paper&quot;&#125;)</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;632045b71f696e4961d858ee&quot;), &quot;item&quot; : &quot;paper&quot;, &quot;qty&quot; : 100, &quot;size&quot; : &#123; &quot;h&quot; : 8.5, &quot;w&quot; : 11, &quot;uom&quot; : &quot;cm&quot; &#125;, &quot;status&quot; : &quot;P&quot;, &quot;lastModified&quot; : ISODate(&quot;2022-09-13T09:47:36.954Z&quot;) &#125;</span><br></pre></td></tr></table></figure>





<h3 id="7-6-2-更新多条数据"><a href="#7-6-2-更新多条数据" class="headerlink" title="7.6.2 更新多条数据"></a>7.6.2 更新多条数据</h3><p>执行命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.updateMany(</span><br><span class="line">    &#123; &quot;qty&quot; : &#123;$lt: 50 &#125;&#125;,    // specifies the documents to update</span><br><span class="line">    &#123;</span><br><span class="line">        $set:&#123;&quot;size.uom&quot;:&quot;cm&quot;, &quot;status&quot;: &quot;P&quot;&#125;,</span><br><span class="line">        $currentDate : &#123; &quot;lastModified&quot;: true &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.inventory.updateMany(</span><br><span class="line">...     &#123; &quot;qty&quot; : &#123;$lt: 50 &#125;&#125;,</span><br><span class="line">...     &#123;</span><br><span class="line">...         $set:&#123;&quot;size.uom&quot;:&quot;cm&quot;, &quot;status&quot;: &quot;P&quot;&#125;,</span><br><span class="line">...         $currentDate : &#123; &quot;lastModified&quot;: true &#125;</span><br><span class="line">...     &#125;</span><br><span class="line">... )</span><br></pre></td></tr></table></figure>

<p>查看数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.inventory.find(&#123;&quot;qty&quot; : &#123;$lt: 50&#125;&#125;)</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;632045b71f696e4961d858ec&quot;), &quot;item&quot; : &quot;journal&quot;, &quot;qty&quot; : 25, &quot;size&quot; : &#123; &quot;h&quot; : 14, &quot;w&quot; : 21, &quot;uom&quot; : &quot;cm&quot; &#125;, &quot;status&quot; : &quot;P&quot;, &quot;lastModified&quot; : ISODate(&quot;2022-09-13T09:53:28.287Z&quot;) &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;632045b71f696e4961d858f0&quot;), &quot;item&quot; : &quot;postcard&quot;, &quot;qty&quot; : 45, &quot;size&quot; : &#123; &quot;h&quot; : 10, &quot;w&quot; : 15.25, &quot;uom&quot; : &quot;cm&quot; &#125;, &quot;status&quot; : &quot;P&quot;, &quot;lastModified&quot; : ISODate(&quot;2022-09-13T09:53:28.287Z&quot;) &#125;</span><br></pre></td></tr></table></figure>





<h1 id="7-7-删除数据"><a href="#7-7-删除数据" class="headerlink" title="7.7 删除数据"></a>7.7 删除数据</h1><h3 id="7-7-1删除单条文档"><a href="#7-7-1删除单条文档" class="headerlink" title="7.7.1删除单条文档"></a>7.7.1删除单条文档</h3><p>官方文档</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://docs.mongodb.com/guides/server/delete/</span><br></pre></td></tr></table></figure>

<p>查询结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; myCursor = db.inventory.find(&#123;&quot;status&quot;:&quot;D&quot; &#125;)</span><br><span class="line">&#123;&quot;_id&quot;:ObjectId(&quot;5cd60d2c082200657d67d792&quot;),&quot;item&quot;:&quot;planner&quot;,&quot;qty&quot;:75, &quot;size&quot;:&#123;&quot;h&quot;:22.85, &quot;w&quot;:30, &quot;uom&quot;:&quot;cm&quot;&#125;, &quot;status&quot;: &quot;D&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>操作命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use test</span><br><span class="line">db.inventory.deleteOne(</span><br><span class="line">    &#123;&quot;status&quot;: &quot;D&quot; &#125;// specifies the document to delete</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>返回结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.inventory.deleteOne(</span><br><span class="line">...     &#123;&quot;status&quot;: &quot;D&quot; &#125;    // specifies the document to delete</span><br><span class="line">... )</span><br><span class="line">&#123; &quot;acknowledged&quot; : true, &quot;deletedCount&quot; : 1 &#125;</span><br></pre></td></tr></table></figure>

<p>再次查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; myCursor = db.inventory.find( &#123;&quot;status&quot;: &quot;D&quot; &#125;)</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>





<h3 id="7-7-2-删除多条文档"><a href="#7-7-2-删除多条文档" class="headerlink" title="7.7.2 删除多条文档"></a>7.7.2 删除多条文档</h3><p>查询数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; myCursor = db.inventory.find(&#123;&quot;status&quot;: &quot;P&quot;&#125;)</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;632045b71f696e4961d858ec&quot;), &quot;item&quot; : &quot;journal&quot;, &quot;qty&quot; : 25, &quot;size&quot; : &#123; &quot;h&quot; : 14, &quot;w&quot; : 21, &quot;uom&quot; : &quot;cm&quot; &#125;, &quot;status&quot; : &quot;P&quot;, &quot;lastModified&quot; : ISODate(&quot;2022-09-13T09:53:28.287Z&quot;) &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;632045b71f696e4961d858ee&quot;), &quot;item&quot; : &quot;paper&quot;, &quot;qty&quot; : 100, &quot;size&quot; : &#123; &quot;h&quot; : 8.5, &quot;w&quot; : 11, &quot;uom&quot; : &quot;cm&quot; &#125;, &quot;status&quot; : &quot;P&quot;, &quot;lastModified&quot; : ISODate(&quot;2022-09-13T09:47:36.954Z&quot;) &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;632045b71f696e4961d858f0&quot;), &quot;item&quot; : &quot;postcard&quot;, &quot;qty&quot; : 45, &quot;size&quot; : &#123; &quot;h&quot; : 10, &quot;w&quot; : 15.25, &quot;uom&quot; : &quot;cm&quot; &#125;, &quot;status&quot; : &quot;P&quot;, &quot;lastModified&quot; : ISODate(&quot;2022-09-13T09:53:28.287Z&quot;) &#125;</span><br></pre></td></tr></table></figure>

<p>操作命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.deleteMany(</span><br><span class="line">  &#123;&quot;status&quot;: &quot;P&quot;&#125;   // specifies the documents to delete</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>返回结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.inventory.deleteMany(</span><br><span class="line">...   &#123;&quot;status&quot;: &quot;P&quot;&#125;   // specifies the documents to delete</span><br><span class="line">... )</span><br><span class="line">&#123; &quot;acknowledged&quot; : true, &quot;deletedCount&quot; : 3 &#125;</span><br></pre></td></tr></table></figure>

<p>再次查看数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; myCursor = db.inventory.find(&#123;&quot;status&quot;: &quot;P&quot;&#125;)</span><br><span class="line">&gt; </span><br></pre></td></tr></table></figure>





<h1 id="第8章工具介绍"><a href="#第8章工具介绍" class="headerlink" title="第8章工具介绍"></a>第8章工具介绍</h1><h2 id="8-1官网地址"><a href="#8-1官网地址" class="headerlink" title="8.1官网地址"></a>8.1官网地址</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://docs.mongodb.com/manual/reference/program/</span><br></pre></td></tr></table></figure>



<h2 id="8-2-mongod"><a href="#8-2-mongod" class="headerlink" title="8.2 mongod"></a>8.2 mongod</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mongod是Mongodb系统的主要守护进程，它处理数据请求，管理数据访问，并执行后台管理操作。启动进程指定配置文件，控制数据库的行为</span><br></pre></td></tr></table></figure>



<h2 id="8-3-mongos"><a href="#8-3-mongos" class="headerlink" title="8.3 mongos"></a>8.3 mongos</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongos 对于&quot;MongoDB Shard&quot;，是用于处理来自应用层的查询的 MongoDB 分片配置的路由服务，并确定此数据在分片集群中的位置，以完成这些操作。从应用程序的角度来看，一个mongos实例与任何其他 MongoDB 实例的行为相同。</span><br></pre></td></tr></table></figure>



<h2 id="8-4-Mongostat"><a href="#8-4-Mongostat" class="headerlink" title="8.4 Mongostat"></a>8.4 Mongostat</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mongostat实用程序可以快速概览当前正在运行的mongod或mongos实例的状态。mongostat在功能上类似于UNIX/Linux文件系统实用程序vmstat,但提供有关的数据 mongod和mongos实例</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#mongo分析工具</span><br><span class="line">mongostat</span><br><span class="line">mongotop</span><br><span class="line"></span><br><span class="line">for(i=0;i&lt;100000;i++)&#123;db.log.insert(&#123;&quot;uid&quot;:i,&quot;name&quot;:&quot;mongodb&quot;,&quot;age&quot;:6&#125;)&#125;</span><br></pre></td></tr></table></figure>



<h2 id="8-5-Mongotop"><a href="#8-5-Mongotop" class="headerlink" title="8.5 Mongotop"></a>8.5 Mongotop</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mongotop 提供了一种跟踪MongoDB实例读取和写入数据的时间量的方法。mongotop提供每个收集级别的统计信息。默认情况下，mongotop 每秒返回一次值的统计信息。默认情况下，mongotop 每秒返回一次值</span><br></pre></td></tr></table></figure>



<h2 id="8-6-Mongooplog"><a href="#8-6-Mongooplog" class="headerlink" title="8.6 Mongooplog"></a>8.6 Mongooplog</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Mongooplog 是一个简单的工具，可以从远程服务器的复制 oplog 轮询操作，并将其应用于本地服务器。此功能支持某些类型的实时迁移，这些迁移要求源服务器保持联机并在整个迁移过程中运行。通常，此命令将采用以下形式：</span><br><span class="line">mongooplog - from mongodb().example.net --host mongodb1.example.net</span><br></pre></td></tr></table></figure>



<h2 id="8-7-Mongoperf"><a href="#8-7-Mongoperf" class="headerlink" title="8.7 Mongoperf"></a>8.7 Mongoperf</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Mongoperf 是一种独立于 MongoDB 检查磁盘 I/O 性能的实用程序。它是随机磁盘 I/O 的测试并呈现结果。</span><br><span class="line">例如：</span><br><span class="line">echo &quot;&#123;nThreads:16, fileSizeMB:10000, r:true, w:true&#125;&quot;| mongoperf</span><br><span class="line">在这个操作中：</span><br><span class="line">mongoperf 测试直接物理随机读写 io 的，使用16个并发阅读器线程。</span><br><span class="line">mongoperf 使用 10 GB 的测试文件。</span><br><span class="line">或者参数写入文件里 mongoperf &lt; config</span><br></pre></td></tr></table></figure>





<h1 id="第9章-授权认证"><a href="#第9章-授权认证" class="headerlink" title="第9章 授权认证"></a>第9章 授权认证</h1><h2 id="9-1-官方网址"><a href="#9-1-官方网址" class="headerlink" title="9.1 官方网址"></a>9.1 官方网址</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://docs.mongodb.com/manual/tutorial/enable-authentication/</span><br></pre></td></tr></table></figure>



<h2 id="9-2-授权介绍"><a href="#9-2-授权介绍" class="headerlink" title="9.2 授权介绍"></a>9.2 授权介绍</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">用户管理界面</span><br><span class="line">要添加用户，MongoDB提供了该db.createUser()方法。添加用户时，您可以为用户分配色以授予权限。</span><br><span class="line">注意：</span><br><span class="line">在数据库中创建的第一个用户应该是具有管理其他用户的权限的用户管理员。</span><br><span class="line">您还可以更新现有用户，例如更改密码并授予或撤销角色。</span><br></pre></td></tr></table></figure>

<p>操作命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.auth()  将用户验证到数据库。</span><br><span class="line">db.changeUserPassword()  更改现有用户的密码。</span><br><span class="line">db.createUser()  创建一个新用户。</span><br><span class="line">db.dropUser()  删除单个用户。</span><br><span class="line">db.dropAllUsers()  删除与数据库关联的所有用户。</span><br><span class="line">db.getUser()  返回有关指定用户的信息。</span><br><span class="line">db.getUsers()  返回有关与数据库关联的所有用户的信息。</span><br><span class="line">db.grantRolesToUser()  授予用户角色及其特权。</span><br><span class="line">db.removeUser()  已过时。从数据库中删除用户。</span><br><span class="line">db.revokeRolesFromUser()  从用户中删除角色。</span><br><span class="line">db.updateUser()  更新用户数据。</span><br></pre></td></tr></table></figure>



<h2 id="9-3-创建用户和角色"><a href="#9-3-创建用户和角色" class="headerlink" title="9.3 创建用户和角色"></a>9.3 创建用户和角色</h2><p>创建命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ mongo db01:27017</span><br><span class="line">&gt; db.createUser(&#123;user:&quot;admin&quot;,pwd:&quot;123456&quot;,roles:[&#123;role:&quot;root&quot;,db:&quot;admin&quot;&#125;]&#125;)</span><br><span class="line">Successfully added user: &#123;</span><br><span class="line">	&quot;user&quot; : &quot;admin&quot;,</span><br><span class="line">	&quot;roles&quot; : [</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;role&quot; : &quot;root&quot;,</span><br><span class="line">			&quot;db&quot; : &quot;admin&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.getUsers()</span><br><span class="line">[</span><br><span class="line">	&#123;</span><br><span class="line">		&quot;_id&quot; : &quot;admin.admin&quot;,</span><br><span class="line">		&quot;userId&quot; : UUID(&quot;52fe7f34-78e3-474f-b11d-c6e20c8cde49&quot;),</span><br><span class="line">		&quot;user&quot; : &quot;admin&quot;,</span><br><span class="line">		&quot;db&quot; : &quot;admin&quot;,</span><br><span class="line">		&quot;roles&quot; : [</span><br><span class="line">			&#123;</span><br><span class="line">				&quot;role&quot; : &quot;root&quot;,</span><br><span class="line">				&quot;db&quot; : &quot;admin&quot;</span><br><span class="line">			&#125;</span><br><span class="line">		]</span><br><span class="line">	&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>查看命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.getUsers()</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;_id&quot;: &quot;test.admin&quot;,</span><br><span class="line">        &quot;user&quot;: &quot;admin&quot;,</span><br><span class="line">        &quot;db&quot;: &quot;test&quot;,</span><br><span class="line">        &quot;roles&quot;: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        &quot;role&quot;: &quot;root&quot;,</span><br><span class="line">                        &quot;db&quot;: &quot;admin&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>





<h2 id="9-4-配置文件"><a href="#9-4-配置文件" class="headerlink" title="9.4 配置文件"></a>9.4 配置文件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">security:    #认证</span><br><span class="line">    authorization: enabled  #启用或者禁用基于角色的访问控制来管理每个用户对数据库资源和操作的访问</span><br><span class="line">enabled 或者 disables</span><br></pre></td></tr></table></figure>

<p>视频操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">用户授权认证</span><br><span class="line">use admin</span><br><span class="line">db.createUser(</span><br><span class="line">    &#123;</span><br><span class="line">        user: &quot;admin&quot;,</span><br><span class="line">        pwd: &quot;123456&quot;,</span><br><span class="line">        roles:[ &#123; role:&quot;root&quot;,db:&quot;admin&quot;&#125;]&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">修改配置文件</span><br><span class="line">vim /opt/mongo_cluster/mongo_27017/conf/monogdb.conf</span><br><span class="line">security:</span><br><span class="line">    authorization: enabled</span><br><span class="line"></span><br><span class="line">重启服务</span><br><span class="line">[mongo@mongodb ~]$ mongod -f /opt/mongo_cluster/mongo_27017/conf/monogdb.conf --shutdown</span><br><span class="line">[mongo@mongodb ~]$ mongod -f /opt/mongo_cluster/mongo_27017/conf/monogdb.conf</span><br><span class="line"></span><br><span class="line">登录</span><br><span class="line">mongo</span><br><span class="line">show dbs</span><br><span class="line"></span><br><span class="line">[mongo@mongodb ~]$ mongo -u admin -p 123456</span><br><span class="line">[mongo@mongodb ~]$ show dbs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">use test</span><br><span class="line">db.createUser(</span><br><span class="line">  &#123;</span><br><span class="line">    user: &quot;myTester&quot;,</span><br><span class="line">    pwd: &quot;xyz123&quot;,</span><br><span class="line">    roles: [&#123; role: &quot;readWrite&quot;, db: &quot;test&quot; &#125;,</span><br><span class="line">                &#123; role: &quot;read&quot;, db: &quot;test2&quot;&#125;]</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">[mongo@mongodb ~]$ mongo -umyTester -pxyz123 db01:27017/test</span><br><span class="line"></span><br><span class="line">3.在test库下插入测试数据</span><br><span class="line">db.test.insert（&#123;&quot;name&quot;：&quot;zhangya&quot;,&quot;age&quot;：27,&quot;ad&quot;: &quot;北京市朝阳区&quot;&#125;)</span><br><span class="line">db.test.insert(&#123;&quot;name&quot;：&quot;zhangya&quot;,&quot;age&quot;：27,&quot;ad&quot;: &quot;北京市朝阳区&quot;&#125;)</span><br><span class="line">db.test.insert(&#123;&quot;name&quot;：&quot;yazhang&quot;,&quot;age&quot;：28,&quot;ad&quot;: &quot;北京市朝阳区&quot;&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4.在test2库下插入测试数据</span><br><span class="line">use test2</span><br><span class="line">db.test2.insert(&#123;&quot;name&quot;：&quot;zhangya&quot;,&quot;age&quot;:27,&quot;ad&quot;: &quot;北京市昌平区&quot;&#125;)</span><br><span class="line">db.test2.insert(&#123;&quot;name&quot;:&quot;zhangya&quot;,&quot;age&quot;:27,&quot;ad&quot;: &quot;北京市昌平区&quot;&#125;)</span><br><span class="line">db.test2.insert(&#123;&quot;name&quot;：&quot;yazhang&quot;,&quot;age&quot;:28,&quot;ad&quot;: &quot;北京市昌平区&quot;&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5.使用myTester用户登录到test验证库</span><br><span class="line">mongo -umyTester -pxyz123 db01:27017/test</span><br><span class="line">show dbs</span><br><span class="line">db</span><br><span class="line"></span><br><span class="line">6.切换到test库，测试能否读写</span><br><span class="line">use test</span><br><span class="line">db.test.insert(&#123;&quot;name&quot;:&quot;58NB&quot;,&quot;age&quot;:27,&quot;ad&quot;: &quot;北京市朝阳区&quot;&#125;</span><br><span class="line">db.test.find()</span><br><span class="line"></span><br><span class="line">7.切换到test2库，测试能否读写</span><br><span class="line">use test2</span><br><span class="line">db.test2.insert(&#123;&quot;name&quot;：&quot;58NB&quot;,&quot;age&quot;：27,&quot;ad&quot;: &quot;北京市昌平区&quot;&#125;)</span><br><span class="line">db.test2.find()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">报错记录</span><br><span class="line">&gt; db.test.insert(&#123;&quot;name&quot; : &quot;yazhang&quot;, &quot;age&quot; : 28, &quot;ad&quot; : &quot;北京市朝阳区&quot; &#125;)</span><br><span class="line">WriteResult(&#123;</span><br><span class="line">	&quot;writeError&quot; : &#123;</span><br><span class="line">		&quot;code&quot; : 13,</span><br><span class="line">		&quot;errmsg&quot; : &quot;not authorized on test2 to execute command &#123; insert: \&quot;test\&quot;, ordered: true, lsid: &#123; id: UUID(\&quot;e8dc8f58-de7f-4010-87b3-31036dfae821\&quot;) &#125;, $db: \&quot;test2\&quot; &#125;&quot;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">问题原因：</span><br><span class="line">当前登录的用户对这个库没有写入权限</span><br></pre></td></tr></table></figure>



<h2 id="9-5-使用账号密码连接"><a href="#9-5-使用账号密码连接" class="headerlink" title="9.5 使用账号密码连接"></a>9.5 使用账号密码连接</h2><p>配置问权限认证后需要重启节点，再次登陆如果不使用账号密码就查看不了数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ mongo db01:27017</span><br><span class="line">&gt; show dbs</span><br><span class="line">2019-07-06T11:43:14.047+0800 E QUERY    [thread1] Error: listDatabases failed:&#123;</span><br><span class="line">    &quot;ok&quot;: 0,</span><br><span class="line">    &quot;errmsg&quot;: &quot;there are no users authenticated&quot;,</span><br><span class="line">    &quot;code&quot;: 13,</span><br><span class="line">    &quot;codeName&quot;: &quot;Unauthorized&quot;</span><br><span class="line">&#125;;</span><br><span class="line">_getErrorWithCode@src/mongo/shell/utils.js:25:13</span><br><span class="line">Mongo.prototype.getDBs@src/mongo/shell/mongo.js:67:1</span><br><span class="line">shellHelper.show@src/mongo/shell/utils.js:860:19</span><br><span class="line">shellHelper@src/mongo/shell/utils.js:750:15</span><br><span class="line">@(shellhelp2):1:1</span><br></pre></td></tr></table></figure>

<p>使用账号密码登陆：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ mongo db01:27017 -u admin -p</span><br><span class="line">MongoDB shell version v3.6.13</span><br><span class="line">MongoDB shell version v3.6.13</span><br><span class="line">Enter password:</span><br><span class="line">&gt; show dbs</span><br><span class="line">admin  0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line">local  0.000GB</span><br><span class="line">test  0.000GB</span><br><span class="line">[mongo@db01 ~]$ mongo db01:27017 -u admin -p</span><br><span class="line">Enter password:</span><br><span class="line">&gt; show dbs</span><br><span class="line">admin  0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line">local  0.000GB</span><br><span class="line">test  0.000GB</span><br><span class="line">&gt; db.test.findO</span><br><span class="line">&#123;&quot;_id&quot;:Objectld(&quot;5d2016396e91339718e18f95&quot;),&quot;name&quot;:&quot;zhangya&quot;,&quot;age&quot;:27,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;</span><br><span class="line">&#123;&quot;_id&quot;:Objectld(&quot;5d2016396e91339718e18f96&quot;),“name&quot;:&quot;zhangya&quot;,&quot;age&quot;:27,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;</span><br><span class="line">&#123;&quot;_id&quot;：Objectld(&quot;5d2016396e91339718e18f97&quot;),&quot;name&quot;：&quot;yazhang&quot;,&quot;age&quot;：28,&quot;ad&quot;：&quot;北京市朝阳区&quot;&#125;</span><br><span class="line">&#123;&quot;_id&quot;:Objectld(&quot;5d2016396e91339718e18f98&quot;),&quot;name&quot;:&quot;xiaozhang&quot;,&quot;age&quot;:28,&quot;ad&quot;:&quot;北京市朝阳区&quot;</span><br><span class="line">&#123;&quot;_id&quot;:ObjectId(&quot;5d2016396e91339718e18f99&quot;),&quot;name&quot;:&quot;xiaozhang&quot;,&quot;age&quot;:28,&quot;ad&quot;:&quot;北京市朝阳区&quot;,&quot;sex&quot;:&quot;boy&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>设置不同账号权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">use test</span><br><span class="line">db.createUser(</span><br><span class="line">  &#123;</span><br><span class="line">    user: &quot;myTester&quot;,</span><br><span class="line">    pwd: &quot;xyz123&quot;,</span><br><span class="line">    roles: [&#123; role: &quot;readWrite&quot;, db: &quot;test&quot; &#125;,</span><br><span class="line">                &#123; role: &quot;read&quot;, db: &quot;test2&quot;&#125;]</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.createUser(</span><br><span class="line">...   &#123;</span><br><span class="line">...     user: &quot;myTester&quot;,</span><br><span class="line">...     pwd: &quot;xyz123&quot;,</span><br><span class="line">...     roles: [&#123; role: &quot;readWrite&quot;, db: &quot;test&quot; &#125;,</span><br><span class="line">...                 &#123; role: &quot;read&quot;, db: &quot;test2&quot;&#125;]</span><br><span class="line">...   &#125;</span><br><span class="line">... )</span><br><span class="line">Successfully added user: &#123;</span><br><span class="line">	&quot;user&quot; : &quot;myTester&quot;,</span><br><span class="line">	&quot;roles&quot; : [</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;role&quot; : &quot;readWrite&quot;,</span><br><span class="line">			&quot;db&quot; : &quot;test&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;role&quot; : &quot;read&quot;,</span><br><span class="line">			&quot;db&quot; : &quot;test2&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>登陆查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[mongo@mongodb ~]$ mongo -umyTester -pxyz123 db01:27017/test</span><br><span class="line">&gt; use test</span><br><span class="line">switched to db test</span><br><span class="line">&gt; db.auth(&quot;myTester&quot;,&quot;xyz123&quot;)</span><br><span class="line">1</span><br><span class="line">&gt; show collections</span><br><span class="line">inventory</span><br><span class="line">test</span><br></pre></td></tr></table></figure>

<p>验证可读</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.test.findOne()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;_id&quot;: ObjectId(&quot;5cd60b69082200657d67d78a&quot;),</span><br><span class="line">    &quot;name&quot;: &quot;zhangya&quot;,</span><br><span class="line">    &quot;age&quot;: 27,</span><br><span class="line">    “ad”: &quot;北京市朝阳区”</span><br><span class="line">&#125;</span><br><span class="line">&gt; db.inventory.findOne()</span><br><span class="line">&#123;</span><br><span class="line">   &quot;_id&quot; : Objectld(&quot;5cd638a71a9c2b8c9274568b&quot;),</span><br><span class="line">   &quot;item&quot;:&quot;journal&quot;,</span><br><span class="line">   &quot;qty&quot;:25,</span><br><span class="line">   &quot;size&quot;:&#123;</span><br><span class="line">            &quot;h&quot;: 14,</span><br><span class="line">            &quot;w&quot;: 21,</span><br><span class="line">            &quot;uom&quot;: &quot;cm&quot;</span><br><span class="line">   &#125;,</span><br><span class="line">   &quot;status&quot;: &quot;A&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>验证可写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.test.insertOne(&#123;&quot;name&quot;:&quot;xiaozhang&quot;,&quot;age&quot;:30,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;)</span><br><span class="line">(</span><br><span class="line">    &quot;acknowledged&quot;: true,</span><br><span class="line">    &quot;inscrtedId&quot; : ObjectId(&quot;5cd63c5d5f928a68501b0bf0&quot;)</span><br><span class="line">    </span><br><span class="line">db.inventory.insertOne(</span><br><span class="line">  &#123;item: &quot;canvas&quot;, qty: 100, tags: [&quot;cotton&quot;], size:&#123;h: 28, w: 35.5, uom:&quot;cm&quot;&#125;&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>切换到test2库，发现可读不可写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; use test2</span><br><span class="line">&gt; db.inventory.findOne()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;_id&quot;: ObjectId(&quot;5cd6392cla9c2b8c92745690&quot;),</span><br><span class="line">    &quot;item&quot;: &quot;journal&quot;,</span><br><span class="line">    &quot;qty&quot;: 25,</span><br><span class="line">    &quot;size&quot;: &#123;</span><br><span class="line">                &quot;h&quot;: 14,</span><br><span class="line">                &quot;w&quot;: 21,</span><br><span class="line">                &quot;uom&quot;: &quot;cm&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;status&quot;: &quot;A&quot;</span><br><span class="line">&#125;</span><br><span class="line">&gt; db.inventory.insertOne( &#123; item: &quot;canvas&quot;, qty: 100, tags: [&quot;cotton&quot;], size: &#123; h: 28, w: 35.5, uom: &quot;cm&quot;, &quot;status&quot; : &quot;A&quot; &#125;</span><br></pre></td></tr></table></figure>







<h1 id="第10章-副本集配置"><a href="#第10章-副本集配置" class="headerlink" title="第10章 副本集配置"></a>第10章 副本集配置</h1><h2 id="10-1官方网站"><a href="#10-1官方网站" class="headerlink" title="10.1官方网站"></a>10.1官方网站</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://docs.mongodb.com/manual/tutorial/deploy-replica-set/</span><br></pre></td></tr></table></figure>



<h2 id="10-2副本集介绍"><a href="#10-2副本集介绍" class="headerlink" title="10.2副本集介绍"></a>10.2副本集介绍</h2><h2 id="10-3目录规划"><a href="#10-3目录规划" class="headerlink" title="10.3目录规划"></a>10.3目录规划</h2><p>以&#x2F;opt&#x2F;mongo+端口号为单机多实例存放目录</p>
<p>视频操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line">副本集配置</span><br><span class="line">1.创建配置文件目录</span><br><span class="line">mkdir -p /opt/mongo_cluster/mongo_2801&#123;7,8,9&#125;/&#123;conf,logs,pid&#125;</span><br><span class="line">tree /opt/ -L 3</span><br><span class="line">/opt/</span><br><span class="line">└── mongo_cluster</span><br><span class="line">    ├── mongodb -&gt; mongodb-linux-x86_64-3.6.13</span><br><span class="line">    ├── mongo_27017</span><br><span class="line">    │   ├── conf</span><br><span class="line">    │   ├── logs</span><br><span class="line">    │   └── pid</span><br><span class="line">    ├── mongo_28017</span><br><span class="line">    │   ├── conf</span><br><span class="line">    │   ├── logs</span><br><span class="line">    │   └── pid</span><br><span class="line">    ├── mongo_28018</span><br><span class="line">    │   ├── conf</span><br><span class="line">    │   ├── logs</span><br><span class="line">    │   └── pid</span><br><span class="line">    ├── mongo_28019</span><br><span class="line">    </span><br><span class="line">2.修改副本集配置文件</span><br><span class="line">cat &gt;/opt/mongo_cluster/mongo_28017/conf/mongo_28017.conf &lt;&lt;EOF</span><br><span class="line">systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: true</span><br><span class="line">  path: /opt/mongo_cluster/mongo_28017/logs/mongodb.log</span><br><span class="line">  </span><br><span class="line">storage:</span><br><span class="line">  journal:</span><br><span class="line">    enabled: true</span><br><span class="line">  dbPath: /data/mongo_cluster/mongo_28017</span><br><span class="line">  directoryPerDB: true</span><br><span class="line">  wiredTiger:</span><br><span class="line">    engineConfig:</span><br><span class="line">      cacheSizeGB: 0.5</span><br><span class="line">      directoryForIndexes: true</span><br><span class="line">    collectionConfig:</span><br><span class="line">      blockCompressor: zlib</span><br><span class="line">    indexConfig:</span><br><span class="line">      prefixCompression: true</span><br><span class="line"></span><br><span class="line">processManagement:</span><br><span class="line">  fork: true</span><br><span class="line">  pidFilePath: /opt/mongo_cluster/mongo_28017/pid/mongod.pid</span><br><span class="line"></span><br><span class="line">net:</span><br><span class="line">  port: 28017</span><br><span class="line">  bindIp: 127.0.0.1,10.0.0.51</span><br><span class="line"></span><br><span class="line">replication:</span><br><span class="line">  oplogSizeMB: 1024</span><br><span class="line">  replSetName: dba58</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">3.复制配置文件到其他目录</span><br><span class="line">cp /opt/mongo_cluster/mongo_28017/conf/mongo_28017.conf /opt/mongo_cluster/mongo_28018/conf/mongo_28018.conf</span><br><span class="line">cp /opt/mongo_cluster/mongo_28017/conf/mongo_28017.conf /opt/mongo_cluster/mongo_28019/conf/mongo_28019.conf</span><br><span class="line"></span><br><span class="line">4.修改配置文件里的端口</span><br><span class="line">sed -i &#x27;s#28017#28018#g&#x27; /opt/mongo_cluster/mongo_28018/conf/mongo_28018.conf</span><br><span class="line">sed -i &#x27;s#28017#28019#g&#x27; /opt/mongo_cluster/mongo_28019/conf/mongo_28019.conf</span><br><span class="line"></span><br><span class="line">5.创建数据目录</span><br><span class="line">mkdir /data/mongo_cluster/mongo_2801&#123;7,8,9&#125;</span><br><span class="line">chown -R mongo:mongo /data/mongo_cluster</span><br><span class="line">chown -R mongo:mongo /opt/mongo_cluster</span><br><span class="line"></span><br><span class="line">6.启动多实例</span><br><span class="line">mongod -f /opt/mongo_cluster/mongo_28017/conf/mongo_28017.conf</span><br><span class="line">mongod -f /opt/mongo_cluster/mongo_28018/conf/mongo_28018.conf</span><br><span class="line">mongod -f /opt/mongo_cluster/mongo_28019/conf/mongo_28019.conf</span><br><span class="line"></span><br><span class="line">mongo db01:28017</span><br><span class="line">mongo db01:28018</span><br><span class="line">mongo db01:28019</span><br><span class="line"></span><br><span class="line">7.初始化副本集</span><br><span class="line">mongo db01:28017</span><br><span class="line">config = &#123;</span><br><span class="line">_id: &quot;dba58&quot;,</span><br><span class="line">members :[</span><br><span class="line">&#123;_id: 0, host: &quot;db01:28017&quot;&#125;,</span><br><span class="line">&#123;_id: 1, host: &quot;db01:28018&quot;&#125;,</span><br><span class="line">&#123;_id: 2, host: &quot;db01:28019&quot;&#125;,</span><br><span class="line">]&#125;</span><br><span class="line">rs.initiate(config)</span><br><span class="line"></span><br><span class="line">8.查看副本集状态</span><br><span class="line">rs.status()</span><br><span class="line"></span><br><span class="line">9.插入数据</span><br><span class="line">db.inventory.insertMany([</span><br><span class="line">    &#123;&quot;item&quot;: &quot;journal&quot;,&quot;qty&quot;:25, &quot;size&quot;:&#123;&quot;h&quot;:14, &quot;w&quot;: 21,&quot;uom&quot;:&quot;cm&quot;&#125;,&quot;status&quot;:&quot;A&quot;&#125;,</span><br><span class="line">    &#123;&quot;item&quot;: &quot;notebook&quot;,&quot;qty&quot;: 50, &quot;size&quot;:&#123;&quot;h&quot;: 8.5, &quot;w&quot;: 11,&quot;uom&quot;:&quot;in&quot;&#125;, &quot;status&quot;:&quot;A&quot;&#125;,</span><br><span class="line">    &#123;&quot;item&quot;:&quot;paper&quot;,&quot;qty&quot;: 100,&quot;size&quot;:&#123;&quot;h&quot;:8.5,&quot;w&quot;:11,&quot;uom&quot;:&quot;in&quot;&#125;,&quot;status&quot;:&quot;D&quot;&#125;,</span><br><span class="line">    &#123;&quot;item&quot;:&quot;planner&quot;,&quot;qty&quot;: 75, &quot;size&quot;:&#123;&quot;h&quot;: 22.85,&quot;w&quot;: 30, &quot;uom&quot;:&quot;cm&quot;&#125;,&quot;status&quot;: &quot;D&quot;&#125;,</span><br><span class="line">    &#123;&quot;item&quot;:&quot;postcard&quot;, &quot;qty&quot;:45,&quot;size&quot;:&#123;&quot;h&quot;:10,&quot;w&quot;: 15.25,&quot;uom&quot;:&quot;cm&quot;&#125;,&quot;status&quot;:&quot;A&quot;&#125;</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">报错记录</span><br><span class="line">dba58:SECONDARY&gt; show tables</span><br><span class="line">2022-09-14T09:48:34.569+0800 E QUERY    [thread1] Error: listCollections failed: &#123;</span><br><span class="line">	&quot;operationTime&quot; : Timestamp(1663120105, 1),</span><br><span class="line">	&quot;ok&quot; : 0,</span><br><span class="line">	&quot;errmsg&quot; : &quot;not master and slaveOk=false&quot;,</span><br><span class="line">	&quot;code&quot; : 13435,</span><br><span class="line">	&quot;codeName&quot; : &quot;NotMasterNoSlaveOk&quot;,</span><br><span class="line">	&quot;$clusterTime&quot; : &#123;</span><br><span class="line">		&quot;clusterTime&quot; : Timestamp(1663120105, 1),</span><br><span class="line">		&quot;signature&quot; : &#123;</span><br><span class="line">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">			&quot;keyId&quot; : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; :</span><br><span class="line"></span><br><span class="line">解决方法</span><br><span class="line">临时解决</span><br><span class="line">slaveOK=true</span><br><span class="line">永久解决</span><br><span class="line">[mongo@mongodb ~]$ vim .mongorc.js</span><br><span class="line">rs.slaveOk();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">报错记录3</span><br><span class="line">从库执行命令</span><br><span class="line">dba58:SECONDARY&gt; db.inventory.deleteOne(&#123;&quot;item&quot;:&quot;journal&quot;&#125;)</span><br><span class="line">2022-09-14T10:11:54.020+0800 E QUERY    [thread1] WriteCommandError: not master :</span><br><span class="line">WriteCommandError(&#123;</span><br><span class="line">	&quot;operationTime&quot; : Timestamp(1663121505, 1),</span><br><span class="line">	&quot;ok&quot; : 0,</span><br><span class="line">	&quot;errmsg&quot; : &quot;not master&quot;,</span><br><span class="line">	&quot;code&quot; : 10107,</span><br><span class="line">	&quot;codeName&quot; : &quot;NotMaster&quot;,</span><br><span class="line">	&quot;$clusterTime&quot; : &#123;</span><br><span class="line">		&quot;clusterTime&quot; : Timestamp(1663121505, 1),</span><br><span class="line">		&quot;signature&quot; : &#123;</span><br><span class="line">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">			&quot;keyId&quot; : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">问题原因：</span><br><span class="line">从库不能执行增删改命令</span><br></pre></td></tr></table></figure>



<h2 id="10-4-创建多实例目录"><a href="#10-4-创建多实例目录" class="headerlink" title="10.4 创建多实例目录"></a>10.4 创建多实例目录</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# mkdir -p /opt/mongo_cluster/mongo_2801&#123;7,8,9&#125;/&#123;conf,logs,pid&#125;</span><br><span class="line">[root@db01 ~]# tree /opt/ -L 2</span><br><span class="line">[root@mongodb mongo_cluster]# tree /opt/ -L 3</span><br><span class="line">/opt/</span><br><span class="line">└── mongo_cluster</span><br><span class="line">    ├── mongodb -&gt; mongodb-linux-x86_64-3.6.13</span><br><span class="line">    ├── mongo_27017</span><br><span class="line">    │   ├── conf</span><br><span class="line">    │   ├── logs</span><br><span class="line">    │   └── pid</span><br><span class="line">    ├── mongo_28017</span><br><span class="line">    │   ├── conf</span><br><span class="line">    │   ├── logs</span><br><span class="line">    │   └── pid</span><br><span class="line">    ├── mongo_28018</span><br><span class="line">    │   ├── conf</span><br><span class="line">    │   ├── logs</span><br><span class="line">    │   └── pid</span><br><span class="line">    ├── mongo_28019</span><br></pre></td></tr></table></figure>



<h2 id="10-5-创建配置文件"><a href="#10-5-创建配置文件" class="headerlink" title="10.5 创建配置文件"></a>10.5 创建配置文件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# cat &gt;/opt/mongo_cluster/mongo_28017/conf/mongo_28017.conf &lt;&lt;EOF</span><br><span class="line">systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: true</span><br><span class="line">  path: /opt/mongo_cluster/mongo_28017/logs/mongodb.log</span><br><span class="line">  </span><br><span class="line">storage:</span><br><span class="line">  journal:</span><br><span class="line">    enabled: true</span><br><span class="line">  dbPath: /data/mongo_cluster/mongo_28017</span><br><span class="line">  directoryPerDB: true</span><br><span class="line">  wiredTiger:</span><br><span class="line">    engineConfig:</span><br><span class="line">      cacheSizeGB: 0.5</span><br><span class="line">      directoryForIndexes: true</span><br><span class="line">    collectionConfig:</span><br><span class="line">      blockCompressor: zlib</span><br><span class="line">    indexConfig:</span><br><span class="line">      prefixCompression: true</span><br><span class="line"></span><br><span class="line">processManagement:</span><br><span class="line">  fork: true</span><br><span class="line">  pidFilePath: /opt/mongo_cluster/mongo_28017/pid/mongod.pid</span><br><span class="line"></span><br><span class="line">net:</span><br><span class="line">  port: 28017</span><br><span class="line">  bindIp: 127.0.0.1,10.0.0.51</span><br><span class="line"></span><br><span class="line">security:</span><br><span class="line">  authorization: enabled</span><br><span class="line">replication:</span><br><span class="line">  oplogSizeMB: 1024</span><br><span class="line">  replSetName: dba58</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">[root@db01 ~]# cp /opt/mongo_cluster/mongo_28017/conf/mongo_28017.conf /opt/mongo_cluster/mongo_28018/conf/mongo_28018.conf</span><br><span class="line">[root@db01 ~]# cp /opt/mongo_cluster/mongo_28017/conf/mongo_28017.conf /opt/mongo_cluster/mongo_28019/conf/mongo_28019.conf</span><br><span class="line">[root@db01 ~]# sed -i &#x27;s#28017#28018#g&#x27; /opt/mongo_cluster/mongo_28018/conf/mongo_28018.conf</span><br><span class="line">[root@db01 ~]# sed -i &#x27;s#28017#28019#g&#x27; /opt/mongo_cluster/mongo_28019/conf/mongo_28019.conf</span><br></pre></td></tr></table></figure>



<h2 id="10-6-创建数据目录"><a href="#10-6-创建数据目录" class="headerlink" title="10.6 创建数据目录"></a>10.6 创建数据目录</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# mkdir /data/mongo_cluster/mongo_2801&#123;7,8,9&#125;</span><br><span class="line">[root@db01 ~]# tree /data/ -L 1</span><br><span class="line">/data/</span><br><span class="line">├── mongo_27017</span><br><span class="line">├── mongo_28017</span><br><span class="line">├── mongo_28018</span><br><span class="line">└── mongo_28019</span><br></pre></td></tr></table></figure>





<h2 id="10-7-更改目录权限"><a href="#10-7-更改目录权限" class="headerlink" title="10.7 更改目录权限"></a>10.7 更改目录权限</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# chown -R mongo:mongo /data/mongo_cluster</span><br><span class="line">[root@db01 ~]# chown -R mongo:mongo /opt/mongo_cluster</span><br></pre></td></tr></table></figure>



<h2 id="10-8-启动所有节点"><a href="#10-8-启动所有节点" class="headerlink" title="10.8 启动所有节点"></a>10.8 启动所有节点</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ mongod -f /opt/mongo_cluster/mongo_28017/conf/mongo_28017.conf</span><br><span class="line">[mongo@db01 ~]$ mongod -f /opt/mongo_cluster/mongo_28018/conf/mongo_28018.conf</span><br><span class="line">[mongo@db01 ~]$ mongod -f /opt/mongo_cluster/mongo_28019/conf/mongo_28019.conf</span><br></pre></td></tr></table></figure>



<h2 id="10-9-初始化副本集"><a href="#10-9-初始化副本集" class="headerlink" title="10.9 初始化副本集"></a>10.9 初始化副本集</h2><p>初始化命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">config = &#123;</span><br><span class="line">_id: &quot;dba58&quot;,</span><br><span class="line">members :[</span><br><span class="line">&#123;_id: 0, host: &quot;db01:28017&quot;&#125;,</span><br><span class="line">&#123;_id: 1, host: &quot;db01:28018&quot;&#125;,</span><br><span class="line">&#123;_id: 2, host: &quot;db01:28019&quot;&#125;,</span><br><span class="line">]&#125;</span><br><span class="line">rs.initiate(config)</span><br></pre></td></tr></table></figure>

<p>执行过程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ mongo db01:28017</span><br><span class="line">&gt; config = &#123;</span><br><span class="line">... _id: &quot;dba58&quot;,</span><br><span class="line">... members :[</span><br><span class="line">... &#123;_id: 0, host: &quot;db01:28017&quot;&#125;,</span><br><span class="line">... &#123;_id: 1, host: &quot;db01:28018&quot;&#125;,</span><br><span class="line">... &#123;_id: 2, host: &quot;db01:28019&quot;&#125;,</span><br><span class="line">... ]&#125;</span><br><span class="line">&#123;</span><br><span class="line">	&quot;_id&quot; : &quot;dba58&quot;,</span><br><span class="line">	&quot;members&quot; : [</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;_id&quot; : 0,</span><br><span class="line">			&quot;host&quot; : &quot;db01:28017&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;_id&quot; : 1,</span><br><span class="line">			&quot;host&quot; : &quot;db01:28018&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;_id&quot; : 2,</span><br><span class="line">			&quot;host&quot; : &quot;db01:28019&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br><span class="line">&gt; rs.initiate(config)</span><br><span class="line">&#123;</span><br><span class="line">	&quot;ok&quot; : 1,</span><br><span class="line">	&quot;operationTime&quot; : Timestamp(1663084798, 1),</span><br><span class="line">	&quot;$clusterTime&quot; : &#123;</span><br><span class="line">		&quot;clusterTime&quot; : Timestamp(1663084798, 1),</span><br><span class="line">		&quot;signature&quot; : &#123;</span><br><span class="line">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">			&quot;keyId&quot; : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">dba58:SECONDARY&gt;</span><br><span class="line">dba58:PRIMARY&gt;</span><br></pre></td></tr></table></figure>



<h2 id="10-10查看状态"><a href="#10-10查看状态" class="headerlink" title="10.10查看状态"></a>10.10查看状态</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dba58:PRIMARY&gt; rs.status()</span><br></pre></td></tr></table></figure>



<h2 id="10-11写入测试数据"><a href="#10-11写入测试数据" class="headerlink" title="10.11写入测试数据"></a>10.11写入测试数据</h2><p>命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.insertMany([</span><br><span class="line">    &#123;&quot;item&quot;: &quot;journal&quot;,&quot;qty&quot;:25, &quot;size&quot;:&#123;&quot;h&quot;:14, &quot;w&quot;: 21,&quot;uom&quot;:&quot;cm&quot;&#125;,&quot;status&quot;:&quot;A&quot;&#125;,</span><br><span class="line">    &#123;&quot;item&quot;: &quot;notebook&quot;,&quot;qty&quot;: 50, &quot;size&quot;:&#123;&quot;h&quot;: 8.5, &quot;w&quot;: 11,&quot;uom&quot;:&quot;in&quot;&#125;, &quot;status&quot;:&quot;A&quot;&#125;,</span><br><span class="line">    &#123;&quot;item&quot;:&quot;paper&quot;,&quot;qty&quot;: 100,&quot;size&quot;:&#123;&quot;h&quot;:8.5,&quot;w&quot;:11,&quot;uom&quot;:&quot;in&quot;&#125;,&quot;status&quot;:&quot;D&quot;&#125;,</span><br><span class="line">    &#123;&quot;item&quot;:&quot;planner&quot;,&quot;qty&quot;: 75, &quot;size&quot;:&#123;&quot;h&quot;: 22.85,&quot;w&quot;: 30, &quot;uom&quot;:&quot;cm&quot;&#125;,&quot;status&quot;: &quot;D&quot;&#125;,</span><br><span class="line">    &#123;&quot;item&quot;:&quot;postcard&quot;, &quot;qty&quot;:45,&quot;size&quot;:&#123;&quot;h&quot;:10,&quot;w&quot;: 15.25,&quot;uom&quot;:&quot;cm&quot;&#125;,&quot;status&quot;:&quot;A&quot;&#125;</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<p>执行过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">dba58:PRIMARY&gt; db.inventory.insertMany([</span><br><span class="line">...     &#123;&quot;item&quot;: &quot;journal&quot;,&quot;qty&quot;:25, &quot;size&quot;:&#123;&quot;h&quot;:14, &quot;w&quot;: 21,&quot;uom&quot;:&quot;cm&quot;&#125;,&quot;status&quot;:&quot;A&quot;&#125;,</span><br><span class="line">...     &#123;&quot;item&quot;: &quot;notebook&quot;,&quot;qty&quot;: 50, &quot;size&quot;:&#123;&quot;h&quot;: 8.5, &quot;w&quot;: 11,&quot;uom&quot;:&quot;in&quot;&#125;, &quot;status&quot;:&quot;A&quot;&#125;,</span><br><span class="line">...     &#123;&quot;item&quot;:&quot;paper&quot;,&quot;qty&quot;: 100,&quot;size&quot;:&#123;&quot;h&quot;:8.5,&quot;w&quot;:11,&quot;uom&quot;:&quot;in&quot;&#125;,&quot;status&quot;:&quot;D&quot;&#125;,</span><br><span class="line">...     &#123;&quot;item&quot;:&quot;planner&quot;,&quot;qty&quot;: 75, &quot;size&quot;:&#123;&quot;h&quot;: 22.85,&quot;w&quot;: 30, &quot;uom&quot;:&quot;cm&quot;&#125;,&quot;status&quot;: &quot;D&quot;&#125;,</span><br><span class="line">...     &#123;&quot;item&quot;:&quot;postcard&quot;, &quot;qty&quot;:45,&quot;size&quot;:&#123;&quot;h&quot;:10,&quot;w&quot;: 15.25,&quot;uom&quot;:&quot;cm&quot;&#125;,&quot;status&quot;:&quot;A&quot;&#125;</span><br><span class="line">... ]);</span><br><span class="line">&#123;</span><br><span class="line">	&quot;acknowledged&quot; : true,</span><br><span class="line">	&quot;insertedIds&quot; : [</span><br><span class="line">		ObjectId(&quot;632132a296bce41c6259c731&quot;),</span><br><span class="line">		ObjectId(&quot;632132a296bce41c6259c732&quot;),</span><br><span class="line">		ObjectId(&quot;632132a296bce41c6259c733&quot;),</span><br><span class="line">		ObjectId(&quot;632132a296bce41c6259c734&quot;),</span><br><span class="line">		ObjectId(&quot;632132a296bce41c6259c735&quot;)</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br><span class="line">dba58:PRIMARY&gt; db.inventory.find()</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;632132a296bce41c6259c731&quot;), &quot;item&quot; : &quot;journal&quot;, &quot;qty&quot; : 25, &quot;size&quot; : &#123; &quot;h&quot; : 14, &quot;w&quot; : 21, &quot;uom&quot; : &quot;cm&quot; &#125;, &quot;status&quot; : &quot;A&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;632132a296bce41c6259c732&quot;), &quot;item&quot; : &quot;notebook&quot;, &quot;qty&quot; : 50, &quot;size&quot; : &#123; &quot;h&quot; : 8.5, &quot;w&quot; : 11, &quot;uom&quot; : &quot;in&quot; &#125;, &quot;status&quot; : &quot;A&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;632132a296bce41c6259c733&quot;), &quot;item&quot; : &quot;paper&quot;, &quot;qty&quot; : 100, &quot;size&quot; : &#123; &quot;h&quot; : 8.5, &quot;w&quot; : 11, &quot;uom&quot; : &quot;in&quot; &#125;, &quot;status&quot; : &quot;D&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;632132a296bce41c6259c734&quot;), &quot;item&quot; : &quot;planner&quot;, &quot;qty&quot; : 75, &quot;size&quot; : &#123; &quot;h&quot; : 22.85, &quot;w&quot; : 30, &quot;uom&quot; : &quot;cm&quot; &#125;, &quot;status&quot; : &quot;D&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;632132a296bce41c6259c735&quot;), &quot;item&quot; : &quot;postcard&quot;, &quot;qty&quot; : 45, &quot;size&quot; : &#123; &quot;h&quot; : 10, &quot;w&quot; : 15.25, &quot;uom&quot; : &quot;cm&quot; &#125;, &quot;status&quot; : &quot;A&quot; &#125;</span><br></pre></td></tr></table></figure>





<h2 id="10-12-验证副本是否同步"><a href="#10-12-验证副本是否同步" class="headerlink" title="10.12 验证副本是否同步"></a>10.12 验证副本是否同步</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">dba58:SECONDARY&gt; show tables</span><br><span class="line">2022-09-14T09:48:34.569+0800 E QUERY    [thread1] Error: listCollections failed: &#123;</span><br><span class="line">	&quot;operationTime&quot; : Timestamp(1663120105, 1),</span><br><span class="line">	&quot;ok&quot; : 0,</span><br><span class="line">	&quot;errmsg&quot; : &quot;not master and slaveOk=false&quot;,</span><br><span class="line">	&quot;code&quot; : 13435,</span><br><span class="line">	&quot;codeName&quot; : &quot;NotMasterNoSlaveOk&quot;,</span><br><span class="line">	&quot;$clusterTime&quot; : &#123;</span><br><span class="line">		&quot;clusterTime&quot; : Timestamp(1663120105, 1),</span><br><span class="line">		&quot;signature&quot; : &#123;</span><br><span class="line">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">			&quot;keyId&quot; : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里会提示副本不可读，通过命令配置副本可读</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dba58:SECONDARY&gt; rs.slaveOk();</span><br></pre></td></tr></table></figure>

<p>再次查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dba58:SECONDARY&gt; db.inventory.find()</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;632132a296bce41c6259c732&quot;), &quot;item&quot; : &quot;notebook&quot;, &quot;qty&quot; : 50, &quot;size&quot; : &#123; &quot;h&quot; : 8.5, &quot;w&quot; : 11, &quot;uom&quot; : &quot;in&quot; &#125;, &quot;status&quot; : &quot;A&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;632132a296bce41c6259c735&quot;), &quot;item&quot; : &quot;postcard&quot;, &quot;qty&quot; : 45, &quot;size&quot; : &#123; &quot;h&quot; : 10, &quot;w&quot; : 15.25, &quot;uom&quot; : &quot;cm&quot; &#125;, &quot;status&quot; : &quot;A&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;632132a296bce41c6259c733&quot;), &quot;item&quot; : &quot;paper&quot;, &quot;qty&quot; : 100, &quot;size&quot; : &#123; &quot;h&quot; : 8.5, &quot;w&quot; : 11, &quot;uom&quot; : &quot;in&quot; &#125;, &quot;status&quot; : &quot;D&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;632132a296bce41c6259c734&quot;), &quot;item&quot; : &quot;planner&quot;, &quot;qty&quot; : 75, &quot;size&quot; : &#123; &quot;h&quot; : 22.85, &quot;w&quot; : 30, &quot;uom&quot; : &quot;cm&quot; &#125;, &quot;status&quot; : &quot;D&quot; &#125;</span><br><span class="line">&#123; &quot;_id&quot; : ObjectId(&quot;632132a296bce41c6259c731&quot;), &quot;item&quot; : &quot;journal&quot;, &quot;qty&quot; : 25, &quot;size&quot; : &#123; &quot;h&quot; : 14, &quot;w&quot; : 21, &quot;uom&quot; : &quot;cm&quot; &#125;, &quot;status&quot; : &quot;A&quot; &#125;</span><br></pre></td></tr></table></figure>

<p>配置文件修改</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mongo@mongodb ~]$ vim .mongorc.js</span><br><span class="line">rs.slaveOk();</span><br></pre></td></tr></table></figure>

<p>尝试删除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">dba58:SECONDARY&gt; db.inventory.remove(4)</span><br><span class="line">dba58:SECONDARY&gt; db.inventory.deleteOne(&#123;&quot;item&quot;:&quot;journal&quot;&#125;)</span><br><span class="line">2022-09-14T10:11:54.020+0800 E QUERY    [thread1] WriteCommandError: not master :</span><br><span class="line">WriteCommandError(&#123;</span><br><span class="line">	&quot;operationTime&quot; : Timestamp(1663121505, 1),</span><br><span class="line">	&quot;ok&quot; : 0,</span><br><span class="line">	&quot;errmsg&quot; : &quot;not master&quot;,</span><br><span class="line">	&quot;code&quot; : 10107,</span><br><span class="line">	&quot;codeName&quot; : &quot;NotMaster&quot;,</span><br><span class="line">	&quot;$clusterTime&quot; : &#123;</span><br><span class="line">		&quot;clusterTime&quot; : Timestamp(1663121505, 1),</span><br><span class="line">		&quot;signature&quot; : &#123;</span><br><span class="line">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">			&quot;keyId&quot; : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>





<h2 id="10-13-故障转移"><a href="#10-13-故障转移" class="headerlink" title="10.13 故障转移"></a>10.13 故障转移</h2><p>将主节点杀掉</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ mongod -f /opt/mongo_cluster/mongo_28017/conf/mongo_28017.conf --shutdown</span><br><span class="line">killing process with pid: 3847</span><br></pre></td></tr></table></figure>

<p>登陆副本节点查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ mongo db01:28019</span><br><span class="line">dba58:PRIMARY&gt;</span><br></pre></td></tr></table></figure>

<p>尝试修改数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dba58:PRIMARY&gt;db.test.insert(&#123;&quot;name&quot;:&quot;zhangya&quot;,&quot;age&quot;:27,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;)</span><br><span class="line">WriteResult(&#123;&quot;nInserted&quot;: 1 &#125;)</span><br><span class="line">dba58:PRIMARY&gt; db.test.find()</span><br><span class="line">&#123;&quot;_id&quot;:Objectld(&quot;5d2091fc89c7e9177a03e785&quot;),&quot;name&quot;:&quot;zhangya&quot;,&quot;age&quot;:27,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>在从库上查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ mongo db01:28018</span><br><span class="line">dba58:SECONDARY&gt; rs.slaveOk();</span><br><span class="line">dba58:SECONDARY&gt; db.test.find()</span><br><span class="line">&#123;&quot;_id&quot;:ObjectId(&quot;5d2091fc89c7e9177a03e785&quot;),&quot;name&quot;:&quot;zhangya&quot;,&quot;age&quot;:27,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>重新启动损坏节点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ mongod -f /opt/mongo_cluster/mongo_28017/conf/mongo_28017.conf</span><br></pre></td></tr></table></figure>

<p>登陆查看数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ mongo db01:28017</span><br><span class="line">dba58:SECONDARY&gt; rs.slaveOk();</span><br><span class="line">dba58:SECONDARY&gt; db.test.find()</span><br><span class="line">&#123;&quot;_id&quot;:Objectld(&quot;5d2091fc89c7e9177a03e785&quot;),&quot;name&quot;:&quot;zhangya&quot;,&quot;age&quot;:27,&quot;ad&quot;:&quot;北京市朝阳区&quot;&#125;</span><br></pre></td></tr></table></figure>





<h2 id="10-14-副本集权重调整"><a href="#10-14-副本集权重调整" class="headerlink" title="10.14 副本集权重调整"></a>10.14 副本集权重调整</h2><p>如果初始化进群的时候没有设置权重，那么默认每个节点的权重都是一样的，也就是说每个节点都可以竞选主节点。</p>
<p>视频操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">权重调整</span><br><span class="line">1.查看配置信息</span><br><span class="line">rs.conf()</span><br><span class="line"></span><br><span class="line">2.配置权重</span><br><span class="line">config = rs.conf()</span><br><span class="line">config.members[2].priority=100</span><br><span class="line"></span><br><span class="line">3.重新导入配置信息</span><br><span class="line">rs.reconfig(config)</span><br><span class="line"> </span><br><span class="line">4.主库降级，发起重新选举</span><br><span class="line">rs.stepDown()</span><br><span class="line"></span><br><span class="line">5.恢复成默认权重</span><br><span class="line">config = rs.conf()</span><br><span class="line">config.members[2].priority=1</span><br><span class="line">rs.reconfig(config)</span><br><span class="line">rs.stepDown()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">增加节点</span><br><span class="line">1.安装配置启动新节点</span><br><span class="line">mkdir /opt/mongo_cluster/mongo_28010/&#123;conf,logs,pid&#125; -p</span><br><span class="line">mkdir /data/mongo_cluster/mongo_28010</span><br><span class="line">cp /opt/mongo_cluster/mongo_28017/conf/mongo_28017.conf /opt/mongo_cluster/mongo_28010/conf/mongo_28010.conf</span><br><span class="line">sed -i &#x27;s#28017#28010#g&#x27; /opt/mongo_cluster/mongo_28010/conf/mongo_28010.conf</span><br><span class="line">mongod -f /opt/mongo_cluster/mongo_28010/conf/mongo_28010.conf</span><br><span class="line">mongo db01:28010</span><br><span class="line"></span><br><span class="line">2.主库执行添加新节点操作</span><br><span class="line">use admin</span><br><span class="line">rs.add(&quot;db01:28010&quot;)</span><br><span class="line"></span><br><span class="line">查看集群状态</span><br><span class="line">rs.status()</span><br><span class="line"></span><br><span class="line">删除旧节点</span><br><span class="line">1.主库操作，删除旧节点</span><br><span class="line">mongo db01:28017</span><br><span class="line">rs.remove(&quot;db01:28010&quot;)</span><br><span class="line">2.节点下线</span><br><span class="line">mongod -f /bpt/mongo_cluster/mongo_28010/conf/mongo_28010.conf --shutdown</span><br><span class="line"></span><br><span class="line">添加仲裁节点</span><br><span class="line">1.清空28010节点的数据</span><br><span class="line">rm -rf /data/mongo_cluster/mongo_28010/*</span><br><span class="line">2.重新启动</span><br><span class="line">mongod -f /opt/mongo_cluster/mongo_28010/conf/mongo_28010.conf</span><br><span class="line">3.检查</span><br><span class="line">mongo db01:28010</span><br><span class="line">4.主库操作</span><br><span class="line">mongo db01:28017</span><br><span class="line">rs.addArb(&quot;db01:28010&quot;)</span><br><span class="line">5.查看节点状态</span><br><span class="line">mongo db01:28010</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="10-14-1查看集群配置"><a href="#10-14-1查看集群配置" class="headerlink" title="10.14.1查看集群配置"></a>10.14.1查看集群配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ mongo db01:28019</span><br><span class="line">dba58:PRIMARY&gt; rs.conf()</span><br><span class="line">&#123;</span><br><span class="line">	&quot;_id&quot; : &quot;dba58&quot;,</span><br><span class="line">	&quot;version&quot; : 1,</span><br><span class="line">	&quot;protocolVersion&quot; : NumberLong(1),</span><br><span class="line">	&quot;members&quot; : [</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;_id&quot; : 0,</span><br><span class="line">			&quot;host&quot; : &quot;db01:28017&quot;,</span><br><span class="line">			&quot;arbiterOnly&quot; : false,</span><br><span class="line">			&quot;buildIndexes&quot; : true,</span><br><span class="line">			&quot;hidden&quot; : false,</span><br><span class="line">			&quot;priority&quot; : 1,</span><br><span class="line">			&quot;tags&quot; : &#123;</span><br><span class="line">				</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">			&quot;votes&quot; : 1</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;_id&quot; : 1,</span><br><span class="line">			&quot;host&quot; : &quot;db01:28018&quot;,</span><br><span class="line">			&quot;arbiterOnly&quot; : false,</span><br><span class="line">			&quot;buildIndexes&quot; : true,</span><br><span class="line">			&quot;hidden&quot; : false,</span><br><span class="line">			&quot;priority&quot; : 1,</span><br><span class="line">			&quot;tags&quot; : &#123;</span><br><span class="line">				</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">			&quot;votes&quot; : 1</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;_id&quot; : 2,</span><br><span class="line">			&quot;host&quot; : &quot;db01:28019&quot;,</span><br><span class="line">			&quot;arbiterOnly&quot; : false,</span><br><span class="line">			&quot;buildIndexes&quot; : true,</span><br><span class="line">			&quot;hidden&quot; : false,</span><br><span class="line">			&quot;priority&quot; : 1,</span><br><span class="line">			&quot;tags&quot; : &#123;</span><br><span class="line">				</span><br><span class="line">			&#125;,</span><br><span class="line">			&quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">			&quot;votes&quot; : 1</span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	&quot;settings&quot; : &#123;</span><br><span class="line">		&quot;chainingAllowed&quot; : true,</span><br><span class="line">		&quot;heartbeatIntervalMillis&quot; : 2000,</span><br><span class="line">		&quot;heartbeatTimeoutSecs&quot; : 10,</span><br><span class="line">		&quot;electionTimeoutMillis&quot; : 10000,</span><br><span class="line">		&quot;catchUpTimeoutMillis&quot; : -1,</span><br><span class="line">		&quot;catchUpTakeoverDelayMillis&quot; : 30000,</span><br><span class="line">		&quot;getLastErrorModes&quot; : &#123;</span><br><span class="line">			</span><br><span class="line">		&#125;,</span><br><span class="line">		&quot;getLastErrorDefaults&quot; : &#123;</span><br><span class="line">			&quot;w&quot; : 1,</span><br><span class="line">			&quot;wtimeout&quot; : 0</span><br><span class="line">		&#125;,</span><br><span class="line">		&quot;replicaSetId&quot; : ObjectId(&quot;6320a8fee3e50ba1e9ba30cd&quot;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="10-14-2调整节点权重"><a href="#10-14-2调整节点权重" class="headerlink" title="10.14.2调整节点权重"></a>10.14.2调整节点权重</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">dba58:PRIMARY&gt; config = rs.conf()</span><br><span class="line">dba58:PRIMARY&gt; config.members[0].priority=100</span><br><span class="line">100</span><br><span class="line">dba58:PRIMARY&gt; rs.reconfig(config)</span><br><span class="line">&#123;</span><br><span class="line">	&quot;ok&quot; : 1,</span><br><span class="line">	&quot;operationTime&quot; : Timestamp(1663121738, 1),</span><br><span class="line">	&quot;$clusterTime&quot; : &#123;</span><br><span class="line">		&quot;clusterTime&quot; : Timestamp(1663121738, 1),</span><br><span class="line">		&quot;signature&quot; : &#123;</span><br><span class="line">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">			&quot;keyId&quot; : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="10-14-3-主节点主动降级"><a href="#10-14-3-主节点主动降级" class="headerlink" title="10.14.3 主节点主动降级"></a>10.14.3 主节点主动降级</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dba58:PRIMARY&gt; rs.stepDown()</span><br></pre></td></tr></table></figure>



<h2 id="10-15增加新节点"><a href="#10-15增加新节点" class="headerlink" title="10.15增加新节点"></a>10.15增加新节点</h2><p>创建新节点目录及启动</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ mkdir /opt/mongo_cluster/mongo_28010/&#123;conf,logs,pid&#125; -p</span><br><span class="line">[mongo@db01 ~]$ mkdir /data/mongo_cluster/mongo_28010</span><br><span class="line">[mongo@db01 ~]$ cp /opt/mongo_cluster/mongo_28017/conf/mongo_28017.conf /opt/mongo_cluster/mongo_28010/conf/mongo_28010.conf</span><br><span class="line">[mongo@db01 ~]$ sed -i &#x27;s#28017#28010#g&#x27; /opt/mongo_cluster/mongo_28010/conf/mongo_28010.conf</span><br><span class="line">[mongo@db01 ~]$ mongod -f /opt/mongo_cluster/mongo_28010/conf/mongo_28010.conf</span><br><span class="line">[mongo@db01 ~]$ mongo db01:28010</span><br></pre></td></tr></table></figure>

<p>主库执行添加新节点操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">dba58:PRIMARY&gt; rs.add(&quot;db01:28010&quot;)</span><br><span class="line">&#123;</span><br><span class="line">	&quot;ok&quot; : 1,</span><br><span class="line">	&quot;operationTime&quot; : Timestamp(1663125256, 1),</span><br><span class="line">	&quot;$clusterTime&quot; : &#123;</span><br><span class="line">		&quot;clusterTime&quot; : Timestamp(1663125256, 1),</span><br><span class="line">		&quot;signature&quot; : &#123;</span><br><span class="line">			&quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),</span><br><span class="line">			&quot;keyId&quot; : NumberLong(0)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="10-16-删除新节点"><a href="#10-16-删除新节点" class="headerlink" title="10.16 删除新节点"></a>10.16 删除新节点</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mongo db01:28017</span><br><span class="line">rs.remove(&quot;db01:28010&quot;)</span><br></pre></td></tr></table></figure>



<h2 id="10-17-增加仲裁节点"><a href="#10-17-增加仲裁节点" class="headerlink" title="10.17 增加仲裁节点"></a>10.17 增加仲裁节点</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mongo db01:28017</span><br><span class="line">rs.addArb(&quot;db01:28010&quot;)</span><br></pre></td></tr></table></figure>

<p>查看节点状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mongo@mongodb ~]$ mongo db01:28010</span><br><span class="line">dba58:ARBITER&gt; </span><br></pre></td></tr></table></figure>



<h1 id="第11章-备份恢复"><a href="#第11章-备份恢复" class="headerlink" title="第11章 备份恢复"></a>第11章 备份恢复</h1><h2 id="11-1备份恢复工具介绍"><a href="#11-1备份恢复工具介绍" class="headerlink" title="11.1备份恢复工具介绍"></a>11.1备份恢复工具介绍</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(1) mongoexport/mongoimport</span><br><span class="line">(2) mongodump/mongorestore</span><br></pre></td></tr></table></figure>



<h2 id="11-2备份工具区别在哪里？"><a href="#11-2备份工具区别在哪里？" class="headerlink" title="11.2备份工具区别在哪里？"></a>11.2备份工具区别在哪里？</h2><p>应用场景总结：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1、异构平台迁移 mysql &lt;---&gt; mongodb</span><br><span class="line">2、同平台，跨大版本：mongodb 2 ----&gt; mongodb 3</span><br><span class="line">mongoexport/mongoimport:json csv</span><br><span class="line">日常备份恢复时使用.</span><br><span class="line">mongodump/mongorestore</span><br></pre></td></tr></table></figure>



<h2 id="11-3-导出工具mongoexport"><a href="#11-3-导出工具mongoexport" class="headerlink" title="11.3 导出工具mongoexport"></a>11.3 导出工具mongoexport</h2><p>mongoexport具体用法如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ mongoexport --help</span><br><span class="line">参数说明：</span><br><span class="line">-h: 指明数据库宿主机的IP</span><br><span class="line">-u: 指明数据库的用户名</span><br><span class="line">-p: 指明数据库的密码</span><br><span class="line">-d: 指明数据库的名字</span><br><span class="line">-c: 指明collection的名字</span><br><span class="line">-f: 指明要导出那些列</span><br><span class="line">-o: 指明到要导出的文件名</span><br><span class="line">-q: 指明导出数据的过滤条件</span><br><span class="line">--authenticationDatabase admin</span><br></pre></td></tr></table></figure>

<p>举例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1.单表备份至 json 格式</span><br><span class="line">mongoexport –uroot –proot123 ––port 27017 -–authenticationDatabase admin –d oldboy –c log –o /mongodb/log. json</span><br><span class="line">注：备份文件的名字可以自定义，默认导出了JSON格式的数据。</span><br><span class="line"></span><br><span class="line">2.单表备份至csv格式</span><br><span class="line">如果我们需要导出csv格式的数据，则需要使用--—-type=csv参数：</span><br><span class="line">mongoexport -uroot -proot123 --port 27017 --authenticationDatabase admin -d test -c log --type=csv -f uid,name,age, date -o /mongodb/log. csv</span><br></pre></td></tr></table></figure>



<p>视频操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">备份恢复</span><br><span class="line">导出</span><br><span class="line">[mongo@mongodb backup]$ mongoexport --port 28017 -d test -c inventory -o /backup/log.json</span><br><span class="line">[mongo@mongodb backup]$ mongoexport --port 28017 -d test -c inventory --type=csv -f item,qty,size,status -o /backup/log.csv</span><br><span class="line">导入</span><br><span class="line">[mongo@mongodb backup]$ mongoimport --port 27017 -d oldboy -c inventory /backup/log.json</span><br><span class="line">导入csv</span><br><span class="line">mongoimport --port 27017 -d dba58 -c log --type=csv -f item,qty,size,status --file /backup/log.csv</span><br></pre></td></tr></table></figure>



<h2 id="11-4-导入工具"><a href="#11-4-导入工具" class="headerlink" title="11.4 导入工具"></a>11.4 导入工具</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ mongoimport --help</span><br><span class="line">参数说明：</span><br><span class="line">-h: 指明数据库宿主机的IP</span><br><span class="line">-u: 指明数据库的用户名</span><br><span class="line">-p: 指明数据库的密码</span><br><span class="line">-d: 指明数据库的名字</span><br><span class="line">-c: 指明collection的名字</span><br><span class="line">-f: 指明要导入那些列</span><br><span class="line">-j, -numInsertionWorkers=&lt;number&gt; number of insert operations to run concurrently</span><br><span class="line">(defaults to 1)</span><br><span class="line">//并行</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">数据恢复：</span><br><span class="line">1.恢复json格式表数据到1og1</span><br><span class="line">mongoimport -uroot -proot123 --port 27017 --authenticationDatabase admin -d oldboy -c log1 /mongodb/log. json</span><br><span class="line"></span><br><span class="line">2.恢复csv格式的文件到log2</span><br><span class="line">上面演示的是导入JSON格式的文件中的内容，如果要导入csv格式文件中的内容，则需要通过--type参数指定导入格式，具体如下所示：</span><br><span class="line"></span><br><span class="line">错误的恢复</span><br><span class="line"></span><br><span class="line">注意：</span><br><span class="line">（1）csv格式的文件头行，有列名字</span><br><span class="line">mongoimport -uroot -proot123 --port 27017 --authenticationDatabase admin -d oldboy -c log2 --type=csv --headerline --file /mongodb/log.csv</span><br><span class="line"></span><br><span class="line">（2）csv格式的文件头行，没有列名字</span><br><span class="line">mongoimport -uroot -proot123 --port 27017 --authenticationDatabase admin -d oldboy -c log3 --type=csv -f id,name,age, date --file /mongodb/log.csv</span><br><span class="line">--headerline: 指明第一行是列名，不需要导入。</span><br></pre></td></tr></table></figure>



<h2 id="11-5异构平台迁移案例"><a href="#11-5异构平台迁移案例" class="headerlink" title="11.5异构平台迁移案例"></a>11.5异构平台迁移案例</h2><p>1.安装数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# yum install mariadb mariadb-server -y</span><br></pre></td></tr></table></figure>

<p>2.开启安全路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/my.cnf &lt;&lt; EOF</span><br><span class="line">secure-file-priv=/tmp</span><br></pre></td></tr></table></figure>

<p>3.重启数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# systemctl restart mariadb.service</span><br></pre></td></tr></table></figure>

<p>4.导入城市数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# mysql</span><br><span class="line">MariaDB [(none)]&gt; source /root/world.sql</span><br></pre></td></tr></table></figure>

<p>5.将样本数据导出成csv格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [world]&gt; select * from world.city into outfile &#x27;/tmp/city1.csv&#x27; fields terminated by &#x27;,&#x27;;</span><br></pre></td></tr></table></figure>

<p>6.查看表结构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; desc world.city;</span><br><span class="line">+-------------+----------+------+-----+---------+----------------+</span><br><span class="line">| Field       | Type     | Null | Key | Default | Extra          |</span><br><span class="line">+-------------+----------+------+-----+---------+----------------+</span><br><span class="line">| ID          | int(11)  | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| Name        | char(35) | NO   |     |         |                |</span><br><span class="line">| CountryCode | char(3)  | NO   | MUL |         |                |</span><br><span class="line">| District    | char(20) | NO   |     |         |                |</span><br><span class="line">| Population  | int(11)  | NO   |     | 0       |                |</span><br><span class="line">+-------------+----------+------+-----+---------+----------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>7.处理备份文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /tmp/city.csv    ### 添加第一行列名信息</span><br><span class="line">ID,Name,CountryCode,District,Population</span><br></pre></td></tr></table></figure>

<p>8.在 mongodb 中导入备份</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# su - mongo</span><br><span class="line">[mongo@mongodb ~]$ mongoimport --port 28017 -d world -c city --type=csv -f ID,Name,CountryCode,District,Population --file /tmp/city1.csv</span><br><span class="line">2022-09-14T13:41:40.354+0800	connected to: localhost:28017</span><br><span class="line">2022-09-14T13:41:40.535+0800	imported 4079 documents</span><br></pre></td></tr></table></figure>



<p>视频操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql导出csv</span><br><span class="line"></span><br><span class="line">导入csv</span><br><span class="line">mongoimport --port 28017 -d world -c city --type=csv -f ID,Name,CountryCode,District,Population --file /tmp/city1.csv</span><br><span class="line"></span><br><span class="line">全备</span><br><span class="line">mongodump --port 28017 -o /data/backup</span><br><span class="line"></span><br><span class="line">只备一个库</span><br><span class="line">mongodump --port 28017 -d world -o /data/backup</span><br><span class="line"></span><br><span class="line">恢复：</span><br><span class="line">mongorestore –-port 28017 -d world1 /data/backup/world/</span><br><span class="line"></span><br><span class="line">恢复之前先删掉</span><br><span class="line">mongorestore --port 28017 -d world1 /data/backup/world/ --drop</span><br><span class="line"></span><br><span class="line">db.oplog.rs.find(&#123;&quot;op&quot;:&quot;i&quot;,&quot;ns&quot;:&quot;oldboy.foo&quot;&#125;).pretty()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>9.查看数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[mongo@mongodb ~]$ mongo db01:28017</span><br><span class="line">dba58:PRIMARY&gt; show dbs</span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line">local   0.001GB</span><br><span class="line">test    0.000GB</span><br><span class="line">world   0.000GB</span><br></pre></td></tr></table></figure>





<h2 id="11-6-mongodump-和-mongorestore"><a href="#11-6-mongodump-和-mongorestore" class="headerlink" title="11.6 mongodump 和 mongorestore"></a>11.6 mongodump 和 mongorestore</h2><p>1.介绍：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mongodump 能够在 Mongodb 运行时进行备份，它的工作原理是对运行的 Mongodb 做查询，然后将所有查到的文档写入磁盘。</span><br><span class="line">但是存在的问题时使用mongodump产生的备份不一定是数据库的实时快照，如果我们在备份时对数据库进行了写入操作，则备份出来的文件可能不完全和Mongodb实时数据相等。另外在备份时可能会对其它客户端性能产生不利的影响。</span><br></pre></td></tr></table></figure>

<p>2.使用方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ mongodump --help</span><br><span class="line">参数说明：</span><br><span class="line">-h: 指明数据库宿主机的IP</span><br><span class="line">-u: 指明数据库的用户名</span><br><span class="line">-p: 指明数据库的密码</span><br><span class="line">-d: 指明数据库的名字</span><br><span class="line">-c: 指明collection的名字</span><br><span class="line">-o: 指明到要导出的文件名</span><br><span class="line">-q: 指明导出数据的过滤条件</span><br><span class="line">-j, --numParallelCollecions= number of collections to dump in parallel (4 by default)</span><br><span class="line">-oplog备份的同时备份oplog</span><br></pre></td></tr></table></figure>

<p>3.mongodump和mongorestore基本使用</p>
<p>全库备份</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# mkdir /data/backup</span><br><span class="line">[root@db01 ~]# chown -R mongo:mongo /data/backup/</span><br><span class="line">[root@db01 ~]# su - mongo</span><br><span class="line">[mongo@db01 ~]$ mongodump --port 28017 -o /data/backup</span><br><span class="line">[mongo@db01 ~]$ mongodump --port 28017 -d world -o /data/backup</span><br></pre></td></tr></table></figure>

<p>备份word库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 &quot;]$ mongodump --port 28017 -d world -o /data/backup</span><br></pre></td></tr></table></figure>

<p>压缩备份</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ mongodump --port 28017 -o /data/backup --gzip</span><br><span class="line">[mongo@db01 ~]$ mongodump --port 28017 -d world -o /data/backup --gzip</span><br></pre></td></tr></table></figure>

<p>恢复world库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dba58:PRIMARY&gt; dbs</span><br><span class="line">dba58:PRIMARY&gt; use world</span><br><span class="line">dba58:PRIMARY&gt; db.dropDatabase()</span><br><span class="line">dba58:PRIMARY&gt; show dbs</span><br><span class="line">[mongo@db01 ~]$ mongorestore –-port 28017 -d world1 /data/backup/world/</span><br></pre></td></tr></table></figure>

<p>恢复之前先删掉</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ mongorestore --port 28017 -d world1 /data/backup/world/ --drop</span><br></pre></td></tr></table></figure>





<h2 id="11-7-mongodump和mongorestore高级企业应用-–oplog）"><a href="#11-7-mongodump和mongorestore高级企业应用-–oplog）" class="headerlink" title="11.7 mongodump和mongorestore高级企业应用(–oplog）"></a>11.7 mongodump和mongorestore高级企业应用(–oplog）</h2><p>注意：这是 replica set 或者 master&#x2F;slave 模式专用</p>
<p>1.oplog介绍</p>
<p>在replica set 中oplog是一个定容集合（capped collection），它的默认大小是磁盘空间的5%（可以通过–oplogSizeMB参数修改）.</p>
<p>位于local库的db.oplog.rs，有兴趣可以看看里面到底有些什么内容。</p>
<p>其中记录的是整个mongodb实例一段时间内数据库的所有变更（插入&#x2F;更新&#x2F;删除）操作。</p>
<p>当空间用完时新记录自动覆盖最老的记录。</p>
<p>其覆盖范围被称作oplog 时间窗口。需要注意的是，因为oplog是一个定容集合，</p>
<p>所以时间窗口能覆盖的范围会因为你单位时间内的更新次数不同而变化。</p>
<p>想要查看当前的oplog时间窗口预计值，可以使用以下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">dba58:PRIMARY&gt; use local</span><br><span class="line">dba58:PRIMARY&gt; db.oplog.rs.find().pretty()</span><br><span class="line">.......................</span><br><span class="line">	&quot;ts&quot; : Timestamp(1663084798, 1),</span><br><span class="line">	&quot;h&quot; : NumberLong(&quot;7640343022562293415&quot;),</span><br><span class="line">	&quot;v&quot; : 2,</span><br><span class="line">	&quot;op&quot; : &quot;n&quot;,</span><br><span class="line">	&quot;ns&quot; : &quot;&quot;,</span><br><span class="line">	&quot;wall&quot; : ISODate(&quot;2022-09-13T15:59:58.621Z&quot;),</span><br><span class="line">	&quot;o&quot; : &#123;</span><br><span class="line">		&quot;msg&quot; : &quot;initiating set&quot;</span><br><span class="line">	&#125;</span><br><span class="line">.......................</span><br><span class="line">dba58:PRIMARY&gt; rs.printReplicationInfo()</span><br><span class="line">configured oplog size:   1024MB    #集合大小</span><br><span class="line">log length start to end: 56060secs (15.57hrs)  #预计窗口覆盖时间</span><br><span class="line">oplog first event time:  Tue Sep 13 2022 23:59:58 GMT+0800 (CST)</span><br><span class="line">oplog last event time:   Wed Sep 14 2022 15:34:18 GMT+0800 (CST)</span><br><span class="line">now:                     Wed Sep 14 2022 15:34:19 GMT+0800 (CST)</span><br></pre></td></tr></table></figure>



<p>2.oplog企业级应用</p>
<p>（1）实现热备，在备份时使用–oplbg选项</p>
<p>注：为了演示效果我们在备份过程，模拟数据插入</p>
<p>(2）准备测试数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ mongo db01:28017</span><br><span class="line">dba58:PRIMARY&gt; use oldboy</span><br><span class="line">switched to db oldboy</span><br><span class="line">dba58:PRIMARY&gt; for(var i = 1;i &lt; 100;i++)&#123;db.foo.insert(&#123;a:i&#125;);&#125;</span><br><span class="line">dba58:PRIMARY&gt; use local</span><br><span class="line">dba58:PRIMARY&gt; db.oplog.rs.find(&#123;&quot;op&quot;:&quot;i&quot;&#125;).pretty()</span><br></pre></td></tr></table></figure>

<p>(3）oplog 配合mongodump实现热备</p>
<p>作用介绍：–oplog会记录备份过程中的数据变化。会以oplog.bson保存下来</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ mongodump --port 28017 -oplog -o /data/backup</span><br></pre></td></tr></table></figure>

<p>恢复</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ mongorestore --port 28017 --oplogReplay /data/backup --drop</span><br></pre></td></tr></table></figure>



<h2 id="11-8-oplog高级应用"><a href="#11-8-oplog高级应用" class="headerlink" title="11.8 oplog高级应用"></a>11.8 oplog高级应用</h2><p>背景：每天0点全备，oplog恢复窗口为48小时</p>
<p>某天，上午10点world.city业务表被误删除。</p>
<p>恢复思路：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0、停应用</span><br><span class="line">2、找测试库</span><br><span class="line">3、恢复昨天晚上全备</span><br><span class="line">4、截取全备之后到 world.city 误删除时间点的oplog，并恢复到测试库</span><br></pre></td></tr></table></figure>

<p>恢复步骤：</p>
<p>模拟故障环境：</p>
<p>1、全备数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">模拟原姶数据</span><br><span class="line">[mongo@db01 ~]$ mongo db01:28017</span><br><span class="line">dba58:PRIMARY&gt; use wo</span><br><span class="line">dba58:PRIMARY&gt; for(var i = 1 ;i &lt;20; i++)&#123;</span><br><span class="line">    db.ci.insert(&#123;a: i&#125;);</span><br><span class="line">&#125;</span><br><span class="line">dba58:PRIMARY&gt; db.ci.find()</span><br></pre></td></tr></table></figure>

<p>2.全备</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ rm -rf /data/backup/*</span><br><span class="line">[mongo@db01 ~]$ mongodump --port 28017 --oplog -o /data/backup</span><br><span class="line">--oplog功能：在备份同时，将备份过程中产生的日志进行备份</span><br><span class="line">文件必须存放在/data/backup下,自动命令为 oplog.bson</span><br></pre></td></tr></table></figure>

<p>3.再次模拟数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ mongo db01:28017</span><br><span class="line">dba58:PRIMARY&gt; use wo</span><br><span class="line">dba58:PRIMARY&gt; db.ci1.insert(&#123;id:1&#125;)</span><br><span class="line">dba58:PRIMARY&gt; db.ci2.insert(&#123;id:2&#125;)</span><br><span class="line">dba58:PRIMARY&gt; show tables</span><br><span class="line">ci</span><br><span class="line">ci1</span><br><span class="line">ci2</span><br></pre></td></tr></table></figure>

<p>4.上午10点：删除wo库下的ci表</p>
<p>10:00 时刻，误删除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dba58:PRIMARY&gt; db.ci.drop()</span><br><span class="line">true</span><br><span class="line">dba58:PRIMARY&gt; show tables</span><br><span class="line">ci1</span><br><span class="line">ci2</span><br></pre></td></tr></table></figure>

<p>5.备份现有的oplogrs表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ mongodump --port 28017 -d local -c oplog.rs -o /data/backup</span><br></pre></td></tr></table></figure>

<p>6.截取oplog并恢复到drop之前的位置</p>
<p>更合理的方法：登陆到原数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ mongo db01:28017</span><br><span class="line">dba58:PRIMARY&gt; use local</span><br><span class="line">dba58:PRIMARY&gt; db.oplog.rs.find(&#123;ns:&quot;wo.$cmd&quot;&#125;).pretty();</span><br><span class="line">&#123;</span><br><span class="line">	&quot;ts&quot; : Timestamp(1663142424, 1),</span><br><span class="line">	&quot;t&quot; : NumberLong(15),</span><br><span class="line">	&quot;h&quot; : NumberLong(&quot;74886958017182209&quot;),</span><br><span class="line">	&quot;v&quot; : 2,</span><br><span class="line">	&quot;op&quot; : &quot;c&quot;,</span><br><span class="line">	&quot;ns&quot; : &quot;wo.$cmd&quot;,</span><br><span class="line">	&quot;ui&quot; : UUID(&quot;dc679020-a97a-430c-bb0d-bf25cd693b0f&quot;),</span><br><span class="line">	&quot;wall&quot; : ISODate(&quot;2022-09-14T08:00:24.108Z&quot;),</span><br><span class="line">	&quot;o&quot; : &#123;</span><br><span class="line">		&quot;drop&quot; : &quot;ci&quot;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>7.恢复备份+应用oplog</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[mongo@db01 ~]$ cd /data/backup/local/</span><br><span class="line">[mongo@db01 /data/backup/local]$ ls</span><br><span class="line">oplog.rs.bson  oplog.rs.metadata.json</span><br><span class="line">[mongo@db01 /data/backup/local]$ cp oplog.rs.bson ../oplog.bson</span><br><span class="line">[mongo@db01 /data/backup/local]$ rm -rf /data/backup/local/</span><br><span class="line">[mongo@db01 ~]$ mongorestore --port 28017 --oplogReplay --oplogLimit &quot;1663142424:1&quot; --drop /data/backup/</span><br><span class="line">[mongo@db01 ~]$ mongo db01:28017</span><br><span class="line">dba58:PRIMARY&gt; use wo</span><br><span class="line">switched to db wo</span><br><span class="line">dba58:PRIMARY&gt; show tables</span><br><span class="line">ci</span><br><span class="line">cil</span><br><span class="line">ci2</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">今天回顾：</span><br><span class="line">1.sql和nosql关系</span><br><span class="line">2.mongo介绍</span><br><span class="line">3.mongo的应用场景</span><br><span class="line">4.安装部署</span><br><span class="line">5.修改配置文件，启动关闭</span><br><span class="line">6.优化警告</span><br><span class="line">7.插入</span><br><span class="line">- 单条插入</span><br><span class="line">- 多条插入</span><br><span class="line">8.查询</span><br><span class="line">- 查询所有</span><br><span class="line">- 按条件查询</span><br><span class="line">- 按条件和正则查询</span><br><span class="line">9.更新</span><br><span class="line">10.删除</span><br><span class="line">- 按条件删除</span><br><span class="line">- 删除整个库或者表</span><br><span class="line">11.授权</span><br><span class="line">-创建admin用户</span><br><span class="line">-创建普通用户授予不同角色和不同权限</span><br><span class="line">12.副本集操作</span><br><span class="line">-配置文件添加副本集参数</span><br><span class="line">-启动所有节点</span><br><span class="line">-配置副本集命令</span><br><span class="line">-初始化副本集</span><br><span class="line">-故障转移</span><br><span class="line">-增加节点</span><br><span class="line">-删除节点</span><br><span class="line">-仲裁节点</span><br><span class="line">-权重调整，主库降级</span><br><span class="line">-故障案例，4台竞争，只剩一台，老张的忧伤</span><br><span class="line">13.工具使用</span><br><span class="line">mongostat</span><br><span class="line">mongotop</span><br><span class="line">14.备份恢复</span><br><span class="line">mongoexport/mongoimport:json csv</span><br><span class="line">- 异构平台迁移 mysql &lt;---&gt; mongodb</span><br><span class="line">mongodump/mongorestore</span><br><span class="line">日常备份恢复时使用.</span><br><span class="line"></span><br><span class="line">15.故障恢复案例</span><br><span class="line">-全备</span><br><span class="line">-误操作</span><br><span class="line">-查询误操作时间点</span><br><span class="line">-备份oplog</span><br><span class="line">-恢复到误操作时间点以前的数据</span><br><span class="line">-检查数据是否恢复完整</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">mongo知识回顾</span><br><span class="line">1.sql和nosql区别</span><br><span class="line">2.应用场景</span><br><span class="line">- 用户评论</span><br><span class="line">- 游戏装备</span><br><span class="line">- 问卷调查</span><br><span class="line">- 日志</span><br><span class="line">3.mongo特点</span><br><span class="line">4.安装部署</span><br><span class="line">5.配置文件</span><br><span class="line">6.CURD增删改查</span><br><span class="line">7.用户授权</span><br><span class="line">- admin root角色</span><br><span class="line">- 自定义 read write角色</span><br><span class="line">8.副本集</span><br><span class="line">- 创建目录</span><br><span class="line">- 修改配置</span><br><span class="line">- 启动所有节点</span><br><span class="line">- 初始化副本集配置参数</span><br><span class="line">- 测试主从复制是否正常</span><br><span class="line">- 模拟故障转移</span><br><span class="line">- 扩容和收缩</span><br><span class="line">- 权重调整和主库降级</span><br><span class="line">- 仲裁节点</span><br><span class="line">9.备份恢复</span><br><span class="line">- 全备</span><br><span class="line">- oplog备份</span><br><span class="line">- mysql导出csv,导入到mongo</span><br><span class="line">10.模拟误删除操作</span><br><span class="line">- 全备</span><br><span class="line">- 模拟误删除</span><br><span class="line">- 备份oplog</span><br><span class="line">- 切换到local下，查找误删除语句的时间点</span><br><span class="line">- 处理备份文件</span><br><span class="line">- 恢复到误操作时间点以前</span><br><span class="line">- 检验数据是否恢复成功</span><br></pre></td></tr></table></figure>



<h1 id="第12章升级步骤"><a href="#第12章升级步骤" class="headerlink" title="第12章升级步骤"></a>第12章升级步骤</h1><p>1.首先确保是副本集状态</p>
<p>2.先关闭1个副本节点</p>
<p>3.检测数据是否可以升级</p>
<p>4.升级副本节点的可执行文件</p>
<p>5.更新配置文件</p>
<p>6.启动升级后的副本节点</p>
<p>7.确保集群工作正常</p>
<p>8.滚动升级其他副本节点</p>
<p>9.最后主节点降级</p>
<p>10.确保集群可用</p>
<p>11.关闭降级的老的主节点</p>
<p>12.升级老的主节点</p>
<p>13.重新加入集群</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://mo-li001.github.io">壹拾陆</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://mo-li001.github.io/posts/64f8eb0f.html">https://mo-li001.github.io/posts/64f8eb0f.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mo-li001.github.io" target="_blank">壹拾陆</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/cf315399.html"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Nginx详解教学</div></div></a></div><div class="next-post pull-right"><a href="/posts/e2a4903b.html"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Openstack部署</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/9f353bc9.html" title="Devops"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Devops</div></div></a></div><div><a href="/posts/f5f9fa9b.html" title="Docker"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Docker</div></div></a></div><div><a href="/posts/34d20e28.html" title="ELK"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">ELK</div></div></a></div><div><a href="/posts/8005.html" title="ELK快速部署"><img class="cover" src="https://tuchuangs.com/imgs/2022/09/18/074f3836d4f471b8.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">ELK快速部署</div></div></a></div><div><a href="/posts/9bdc030a.html" title="HAproxy"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">HAproxy</div></div></a></div><div><a href="/posts/a71433d.html" title="Ansible"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Ansible</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202209182232723.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">壹拾陆</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">69</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mo-li001/"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">个人笔记</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#MongoDB"><span class="toc-text">MongoDB</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC1%E7%AB%A0NoSQL%E4%BB%8B%E7%BB%8D"><span class="toc-text">第1章NoSQL介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-NoSQL%E7%AE%80%E4%BB%8B"><span class="toc-text">1.1 NoSQL简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2%E4%BB%80%E4%B9%88%E6%98%AFNoSQL"><span class="toc-text">1.2什么是NoSQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8NoSQL%EF%BC%9F"><span class="toc-text">1.3为什么使用NoSQL？</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC2%E7%AB%A0MongoDB%E7%AE%80%E4%BB%8B"><span class="toc-text">第2章MongoDB简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-MongoDB%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F"><span class="toc-text">2.1 MongoDB数据格式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-JSON"><span class="toc-text">2.1.1 JSON</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-BSON"><span class="toc-text">2.1.2 BSON</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-MangoDB-%E7%89%B9%E7%82%B9"><span class="toc-text">2.2 MangoDB 特点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-MongoDB%E5%8C%85%E5%90%AB%E7%9A%84%E7%A8%8B%E5%BA%8F"><span class="toc-text">2.3 MongoDB包含的程序</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC3%E7%AB%A0%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">第3章应用场景</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC4%E7%AB%A0%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2"><span class="toc-text">第4章安装部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3"><span class="toc-text">4.1官方文档</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F"><span class="toc-text">4.2安装方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3%E7%9B%AE%E5%BD%95%E8%A7%84%E5%88%92"><span class="toc-text">4.3目录规划</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-text">4.4软件安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">4.5配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6-%E5%90%AF%E5%8A%A8%E5%85%B3%E9%97%AD"><span class="toc-text">4.6 启动关闭</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-1%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4"><span class="toc-text">4.6.1启动命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-2%E6%A3%80%E6%9F%A5%E5%91%BD%E4%BB%A4"><span class="toc-text">4.6.2检查命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-3-%E5%86%99%E5%85%A5%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-text">4.6.3 写入环境变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-4%E5%88%9B%E5%BB%BAhosts%E8%A7%A3%E6%9E%90"><span class="toc-text">4.6.4创建hosts解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-5-%E8%BF%9E%E6%8E%A5%E5%91%BD%E4%BB%A4"><span class="toc-text">4.6.5 连接命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-6-%E5%85%B3%E9%97%AD%E5%91%BD%E4%BB%A4"><span class="toc-text">4.6.6 关闭命令</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC5%E7%AB%A0-%E5%91%8A%E8%AD%A6%E4%BC%98%E5%8C%96"><span class="toc-text">第5章 告警优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E7%99%BB%E9%99%86"><span class="toc-text">5.1普通用户登陆</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E5%85%B3%E9%97%AD%E5%A4%A7%E5%86%85%E5%AD%98%E9%A1%B5-hugepage"><span class="toc-text">5.2 关闭大内存页 hugepage</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8%E8%B6%85%E8%BF%8780"><span class="toc-text">5.3内存占用超过80%</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4%E7%94%A8%E6%88%B7%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="toc-text">5.4用户访问控制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-relimit%E8%AD%A6%E5%91%8A"><span class="toc-text">5.5 relimit警告</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC6%E7%AB%A0-mongodb%E9%BB%98%E8%AE%A4%E5%AD%98%E5%9C%A8%E7%9A%84%E5%BA%93"><span class="toc-text">第6章 mongodb默认存在的库</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC7%E7%AB%A0%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-text">第7章基本操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1%E4%BB%8B%E7%BB%8D"><span class="toc-text">7.1介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2%E6%98%BE%E7%A4%BA%E5%91%BD%E4%BB%A4"><span class="toc-text">7.2显示命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="toc-text">7.3创建索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4-%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-text">7.4 插入数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-1-%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3"><span class="toc-text">7.4.1 官方文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-2%E5%8D%95%E8%A1%8C%E6%8F%92%E5%85%A5"><span class="toc-text">7.4.2单行插入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-3%E5%A4%9A%E8%A1%8C%E6%8F%92%E5%85%A5"><span class="toc-text">7.4.3多行插入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-5%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE"><span class="toc-text">7.5查询数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-1%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89"><span class="toc-text">7.5.1查询所有</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-2%E6%9F%A5%E8%AF%A2%E5%8D%95%E6%9D%A1"><span class="toc-text">7.5.2查询单条</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-3%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2"><span class="toc-text">7.5.3条件查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-4%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E5%91%BD%E4%BB%A4"><span class="toc-text">7.5.4查看数据库命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-6%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE"><span class="toc-text">7.6更新数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-6-1%E8%B7%9F%E6%96%B0%E5%8D%95%E4%B8%AA%E6%96%87%E6%A1%A3"><span class="toc-text">7.6.1跟新单个文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-6-2-%E6%9B%B4%E6%96%B0%E5%A4%9A%E6%9D%A1%E6%95%B0%E6%8D%AE"><span class="toc-text">7.6.2 更新多条数据</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-7-%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE"><span class="toc-text">7.7 删除数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-7-1%E5%88%A0%E9%99%A4%E5%8D%95%E6%9D%A1%E6%96%87%E6%A1%A3"><span class="toc-text">7.7.1删除单条文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-7-2-%E5%88%A0%E9%99%A4%E5%A4%9A%E6%9D%A1%E6%96%87%E6%A1%A3"><span class="toc-text">7.7.2 删除多条文档</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC8%E7%AB%A0%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D"><span class="toc-text">第8章工具介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1%E5%AE%98%E7%BD%91%E5%9C%B0%E5%9D%80"><span class="toc-text">8.1官网地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-mongod"><span class="toc-text">8.2 mongod</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-mongos"><span class="toc-text">8.3 mongos</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-4-Mongostat"><span class="toc-text">8.4 Mongostat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-5-Mongotop"><span class="toc-text">8.5 Mongotop</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-6-Mongooplog"><span class="toc-text">8.6 Mongooplog</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-7-Mongoperf"><span class="toc-text">8.7 Mongoperf</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC9%E7%AB%A0-%E6%8E%88%E6%9D%83%E8%AE%A4%E8%AF%81"><span class="toc-text">第9章 授权认证</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-%E5%AE%98%E6%96%B9%E7%BD%91%E5%9D%80"><span class="toc-text">9.1 官方网址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-%E6%8E%88%E6%9D%83%E4%BB%8B%E7%BB%8D"><span class="toc-text">9.2 授权介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-3-%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E5%92%8C%E8%A7%92%E8%89%B2"><span class="toc-text">9.3 创建用户和角色</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-4-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">9.4 配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-5-%E4%BD%BF%E7%94%A8%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E8%BF%9E%E6%8E%A5"><span class="toc-text">9.5 使用账号密码连接</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC10%E7%AB%A0-%E5%89%AF%E6%9C%AC%E9%9B%86%E9%85%8D%E7%BD%AE"><span class="toc-text">第10章 副本集配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1%E5%AE%98%E6%96%B9%E7%BD%91%E7%AB%99"><span class="toc-text">10.1官方网站</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2%E5%89%AF%E6%9C%AC%E9%9B%86%E4%BB%8B%E7%BB%8D"><span class="toc-text">10.2副本集介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-3%E7%9B%AE%E5%BD%95%E8%A7%84%E5%88%92"><span class="toc-text">10.3目录规划</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-4-%E5%88%9B%E5%BB%BA%E5%A4%9A%E5%AE%9E%E4%BE%8B%E7%9B%AE%E5%BD%95"><span class="toc-text">10.4 创建多实例目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-5-%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">10.5 创建配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-6-%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E7%9B%AE%E5%BD%95"><span class="toc-text">10.6 创建数据目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-7-%E6%9B%B4%E6%94%B9%E7%9B%AE%E5%BD%95%E6%9D%83%E9%99%90"><span class="toc-text">10.7 更改目录权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-8-%E5%90%AF%E5%8A%A8%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9"><span class="toc-text">10.8 启动所有节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-9-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-text">10.9 初始化副本集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-10%E6%9F%A5%E7%9C%8B%E7%8A%B6%E6%80%81"><span class="toc-text">10.10查看状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-11%E5%86%99%E5%85%A5%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE"><span class="toc-text">10.11写入测试数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-12-%E9%AA%8C%E8%AF%81%E5%89%AF%E6%9C%AC%E6%98%AF%E5%90%A6%E5%90%8C%E6%AD%A5"><span class="toc-text">10.12 验证副本是否同步</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-13-%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-text">10.13 故障转移</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-14-%E5%89%AF%E6%9C%AC%E9%9B%86%E6%9D%83%E9%87%8D%E8%B0%83%E6%95%B4"><span class="toc-text">10.14 副本集权重调整</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-14-1%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE"><span class="toc-text">10.14.1查看集群配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-14-2%E8%B0%83%E6%95%B4%E8%8A%82%E7%82%B9%E6%9D%83%E9%87%8D"><span class="toc-text">10.14.2调整节点权重</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-14-3-%E4%B8%BB%E8%8A%82%E7%82%B9%E4%B8%BB%E5%8A%A8%E9%99%8D%E7%BA%A7"><span class="toc-text">10.14.3 主节点主动降级</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-15%E5%A2%9E%E5%8A%A0%E6%96%B0%E8%8A%82%E7%82%B9"><span class="toc-text">10.15增加新节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-16-%E5%88%A0%E9%99%A4%E6%96%B0%E8%8A%82%E7%82%B9"><span class="toc-text">10.16 删除新节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-17-%E5%A2%9E%E5%8A%A0%E4%BB%B2%E8%A3%81%E8%8A%82%E7%82%B9"><span class="toc-text">10.17 增加仲裁节点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC11%E7%AB%A0-%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D"><span class="toc-text">第11章 备份恢复</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#11-1%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D"><span class="toc-text">11.1备份恢复工具介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-2%E5%A4%87%E4%BB%BD%E5%B7%A5%E5%85%B7%E5%8C%BA%E5%88%AB%E5%9C%A8%E5%93%AA%E9%87%8C%EF%BC%9F"><span class="toc-text">11.2备份工具区别在哪里？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-3-%E5%AF%BC%E5%87%BA%E5%B7%A5%E5%85%B7mongoexport"><span class="toc-text">11.3 导出工具mongoexport</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-4-%E5%AF%BC%E5%85%A5%E5%B7%A5%E5%85%B7"><span class="toc-text">11.4 导入工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-5%E5%BC%82%E6%9E%84%E5%B9%B3%E5%8F%B0%E8%BF%81%E7%A7%BB%E6%A1%88%E4%BE%8B"><span class="toc-text">11.5异构平台迁移案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-6-mongodump-%E5%92%8C-mongorestore"><span class="toc-text">11.6 mongodump 和 mongorestore</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-7-mongodump%E5%92%8Cmongorestore%E9%AB%98%E7%BA%A7%E4%BC%81%E4%B8%9A%E5%BA%94%E7%94%A8-%E2%80%93oplog%EF%BC%89"><span class="toc-text">11.7 mongodump和mongorestore高级企业应用(–oplog）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-8-oplog%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8"><span class="toc-text">11.8 oplog高级应用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC12%E7%AB%A0%E5%8D%87%E7%BA%A7%E6%AD%A5%E9%AA%A4"><span class="toc-text">第12章升级步骤</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/c35a7f86.html" title="脚本暂存">脚本暂存</a><time datetime="2023-02-03T12:41:14.000Z" title="发表于 2023-02-03 20:41:14">2023-02-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/90f47a19.html" title="自动化装机">自动化装机</a><time datetime="2023-02-02T12:41:14.000Z" title="发表于 2023-02-02 20:41:14">2023-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/64202.html" title="linux">linux</a><time datetime="2023-02-02T12:41:14.000Z" title="发表于 2023-02-02 20:41:14">2023-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/8fb4d8df.html" title="zabbix">zabbix</a><time datetime="2023-02-02T01:43:57.000Z" title="发表于 2023-02-02 09:43:57">2023-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/8d6735b8.html" title="超经典SQL练习题，做完这些你的ＳＱＬ就过关了">超经典SQL练习题，做完这些你的ＳＱＬ就过关了</a><time datetime="2023-02-02T01:43:57.000Z" title="发表于 2023-02-02 09:43:57">2023-02-02</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 壹拾陆</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>