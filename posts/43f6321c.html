<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>zabbix笔记 | 壹拾陆</title><meta name="keywords" content="Linux"><meta name="author" content="壹拾陆"><meta name="copyright" content="壹拾陆"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Zabbix一、Linux的那些独孤九剑级别的命令   项目 对应检查命令    网站&#x2F;业务&#x2F;api curl&#x2F;wget   服务 systemctl&#x2F;service&#x2F;chkconfig(c6)   进程 ps&#x2F;pstree&#x2F;pgrep&#x2F;pidstat&#x2F;top&#x2F;htop   CPU top&amp;#x2F">
<meta property="og:type" content="article">
<meta property="og:title" content="zabbix笔记">
<meta property="og:url" content="https://mo-li001.github.io/posts/43f6321c.html">
<meta property="og:site_name" content="壹拾陆">
<meta property="og:description" content="Zabbix一、Linux的那些独孤九剑级别的命令   项目 对应检查命令    网站&#x2F;业务&#x2F;api curl&#x2F;wget   服务 systemctl&#x2F;service&#x2F;chkconfig(c6)   进程 ps&#x2F;pstree&#x2F;pgrep&#x2F;pidstat&#x2F;top&#x2F;htop   CPU top&amp;#x2F">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-10-23T11:48:44.000Z">
<meta property="article:modified_time" content="2022-10-28T02:58:38.000Z">
<meta property="article:author" content="壹拾陆">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://mo-li001.github.io/posts/43f6321c"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'zabbix笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-28 10:58:38'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202209182232723.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">69</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">壹拾陆</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">zabbix笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-10-23T11:48:44.000Z" title="发表于 2022-10-23 19:48:44">2022-10-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-10-28T02:58:38.000Z" title="更新于 2022-10-28 10:58:38">2022-10-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="zabbix笔记"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Zabbix"><a href="#Zabbix" class="headerlink" title="Zabbix"></a><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1R24y1o7Nv/?p=8&spm_id_from=pageDriver&vd_source=629395ac7befa1625191c3f496068941">Zabbix</a></h1><h1 id="一、Linux的那些独孤九剑级别的命令"><a href="#一、Linux的那些独孤九剑级别的命令" class="headerlink" title="一、Linux的那些独孤九剑级别的命令"></a>一、Linux的那些独孤九剑级别的命令</h1><table>
<thead>
<tr>
<th>项目</th>
<th>对应检查命令</th>
</tr>
</thead>
<tbody><tr>
<td>网站&#x2F;业务&#x2F;api</td>
<td><strong>curl&#x2F;wget</strong></td>
</tr>
<tr>
<td>服务</td>
<td><strong>systemctl</strong>&#x2F;service&#x2F;chkconfig(c6)</td>
</tr>
<tr>
<td>进程</td>
<td><strong>ps&#x2F;pstree</strong>&#x2F;pgrep&#x2F;pidstat&#x2F;top&#x2F;htop</td>
</tr>
<tr>
<td>CPU</td>
<td><strong>top&#x2F;htop</strong>&#x2F;vmstat&#x2F;mpstat&#x2F;lscpu&#x2F;cpuinfo&#x2F;w&#x2F;uptime&#x2F;sar</td>
</tr>
<tr>
<td>内存</td>
<td><strong>top&#x2F;free&#x2F;ps&#x2F;iotop(swap)</strong>&#x2F;vmstat&#x2F;mpstat&#x2F;sar&#x2F;hcache(buffer+cache)</td>
</tr>
<tr>
<td>磁盘</td>
<td><strong>iotop</strong>&#x2F;iostat&#x2F;sar  #磁盘测试命令 <strong>dd,fio</strong></td>
</tr>
<tr>
<td>网络</td>
<td><strong>iftop(整体带宽使用情况)&#x2F;nethogs(精确到进程)</strong>&#x2F;nstat&#x2F;ifstat&#x2F;mtr&#x2F;sar</td>
</tr>
<tr>
<td>硬件</td>
<td>Megacli(监控raid)&#x2F;ipmitool(温度,cpu风扇转速)&#x2F;lm_sensors(温度)</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进程</span></span><br><span class="line">pgrep  过滤出指定服务的进程pid    <span class="comment"># ps -ef |grep</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###pidstat</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#CPU</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##vmstat</span></span><br><span class="line">[root@VM-20-4-centos ~]<span class="comment"># vmstat</span></span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   <span class="keyword">in</span>   cs us sy <span class="built_in">id</span> wa st</span><br><span class="line"> 2  0      0 227824 191572 2893468    0    0    25    14    1    1  4  6 90  0  0</span><br><span class="line"></span><br><span class="line">Procs</span><br><span class="line">    r: The number of runnable processes (running or waiting <span class="keyword">for</span> run time).  <span class="comment">#cpu 正在运行或等待运行的进程数</span></span><br><span class="line">    b: The number of processes blocked waiting <span class="keyword">for</span> I/O to complete.  <span class="comment">#处于io状态进程数量</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#自行回顾：ps,top  详细信息  进程状态</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##mpstat</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#内存</span></span><br><span class="line">https://github.com/silenceshell/hcache</span><br><span class="line"></span><br><span class="line"><span class="comment">#网络</span></span><br><span class="line">nstat/ifstat/mtr/sar</span><br><span class="line"></span><br><span class="line"><span class="comment">##ifstat</span></span><br><span class="line">[root@VM-20-4-centos ~]<span class="comment"># ifstat</span></span><br><span class="line"><span class="comment">#kernel</span></span><br><span class="line">Interface        RX Pkts/Rate    TX Pkts/Rate    RX Data/Rate    TX Data/Rate  </span><br><span class="line">                 RX Errs/Drop    TX Errs/Drop    RX Over/Rate    TX Coll/Rate  </span><br><span class="line">lo                86528K 0        86528K 0         1651M 0         1651M 0      </span><br><span class="line">                       0 0             0 0             0 0             0 0      </span><br><span class="line">eth0              99204K 0        94462K 0         4035M 0         1693M 0      </span><br><span class="line">                       0 0             0 0             0 0             0 0      </span><br><span class="line">docker0            2579K 0         2495K 0         2297M 0         3886M 0      </span><br><span class="line">                       0 0             0 0             0 0             0 0      </span><br><span class="line">veth406d24a        1732K 0         1597K 0         2189M 0         2169M 0      </span><br><span class="line">                       0 0             0 0             0 0             0 0      </span><br><span class="line">veth1ba4e8f         2224 0          2855 0        300315 0        583370 0      </span><br><span class="line">                       0 0             0 0             0 0             0 0      </span><br><span class="line">veth334f09c        72199 0         74256 0        76233K 0        31214K 0      </span><br><span class="line">                       0 0             0 0             0 0             0 0      </span><br><span class="line">[root@VM-20-4-centos ~]<span class="comment"># </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##mtr</span></span><br><span class="line">[root@aliyun-ansible ~]<span class="comment"># #动态 tracert 或traceroute 路由追踪</span></span><br><span class="line">[root@aliyun-ansible ~]<span class="comment"># mtr WWw.baidu.com</span></span><br></pre></td></tr></table></figure>



<h1 id="二、公司监控如何做的"><a href="#二、公司监控如何做的" class="headerlink" title="二、公司监控如何做的"></a>二、公司监控如何做的</h1><ul>
<li><p>角度01：<strong>单台机器</strong></p>
<ul>
<li>业务(应用&#x2F;api)信息：应用，程序代码是否有问题，（需要我们与开发沟通，书写一个页面） eg：lnmp的时候的php与mysql测试页面.</li>
<li>服务信息：各种服务状态，进程，端口，状态，特定的信息（不同服务）</li>
<li>系统信息：cpu,内存(内存,swap,buffer&#x2F;cache),磁盘(io,使用率,inode),负载,网络(in&#x2F;out)……</li>
<li>硬件信息：磁盘，raid状态，温度，风扇转速，机房温度，湿度</li>
</ul>
</li>
<li><p>角度02：<strong>网站集群监控（用户访问流程）</strong></p>
<ul>
<li>DNS解析：<strong>ping&#x2F;dig</strong>&#x2F;nslookup&#x2F;host</li>
<li>DNS解析域CDN是否ok  本质：<strong>通过全局访问测试工具（模仿用户在全国（全球）各地访问我们的网站）</strong><ul>
<li>任性不差钱：全国各地（核心城市），1台服务器，在服务器访问你们的源站&#x2F;cdn&#x2F;dns,（对应的服务：smokeping)</li>
<li>免费:<a target="_blank" rel="noopener" href="http://17ce.com/">http://17ce.com</a> <a target="_blank" rel="noopener" href="http://ping.chinaz.com/">http://ping.chinaz.com/</a>        调试工具：<a target="_blank" rel="noopener" href="http://cesule.tingyun.com/cesule/home">http://cesule.tingyun.com/cesule/home</a></li>
<li>商业版：<a target="_blank" rel="noopener" href="https://www.tingyun.com/">听云</a>，<a target="_blank" rel="noopener" href="https://www.jiankongbao.com/">监控宝</a>（告警）</li>
</ul>
</li>
<li>TCP三次握手-网站负载均衡监控 ss-ant</li>
<li>HITP请求豹纹-监控web日志查看（状态码）补充：加上HTTPS监控过期</li>
<li>请求经过网站架构<ul>
<li>负载均衡（Nginx）</li>
<li>web服务器(php,tomcat)</li>
<li>缓存</li>
<li>数据库</li>
<li>存储</li>
</ul>
</li>
<li>HTTP响应豹纹-监控web日志查看（状态码）</li>
<li>TCP四次挥手-网站负载均衡监控 ss-ant</li>
<li>断开连接</li>
</ul>
</li>
<li><p>角度03：其他</p>
<ul>
<li><strong>错误日志监控，error.log，catalina.out</strong></li>
<li>网站性能监控：apm监控，skywalking…</li>
<li>舆情监控</li>
</ul>
</li>
<li><p>smokeping demon</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://oss.oetiker.ch/smokeping-demo/</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="三、监控的脚本时代-过去时"><a href="#三、监控的脚本时代-过去时" class="headerlink" title="三、监控的脚本时代-过去时"></a>三、监控的脚本时代-过去时</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">脚本取出内存使用率</span></span><br><span class="line">cat /server/scripts/check_mem.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">author: lidao996</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">desc:  check system memory us age</span></span><br><span class="line"></span><br><span class="line">MEM=`free -m|awk &#x27;NR==2&#123;print $NF&#125;&#x27;`</span><br><span class="line">if [ $MEM -le 100 ];then</span><br><span class="line">    echo &quot;当前的内存还剩余 $MEM&quot;|mail -s &#x27;内存不足了！oom&#x27; youjiu_linux@qq.com</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>



<h1 id="四、监控的现代时"><a href="#四、监控的现代时" class="headerlink" title="四、监控的现代时"></a>四、监控的现代时</h1><table>
<thead>
<tr>
<th>阶段</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>过去</td>
<td>Nagios(难够死)+Cacti</td>
</tr>
<tr>
<td>目前</td>
<td>Zabbix+Grafana,OpenFalcon,Prometheus(普罗米修斯)</td>
</tr>
<tr>
<td>未来</td>
<td>Zabbix 6.0&#x2F;7.0 Its ? , something new ??</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">阶段</span><br><span class="line">过去</span><br><span class="line">Nagios(难够死)+Cacti</span><br><span class="line">Zabbix+Grafana,OpenFalcon,Prometheus(普罗米修斯)</span><br><span class="line">目前</span><br><span class="line">未来</span><br><span class="line">Zabbix 6.0/7.0 Its ? , something new ??</span><br></pre></td></tr></table></figure>



<h1 id="五、Zabbix监控架构"><a href="#五、Zabbix监控架构" class="headerlink" title="五、Zabbix监控架构"></a>五、Zabbix监控架构</h1><h2 id="5-1-生命周期"><a href="#5-1-生命周期" class="headerlink" title="5.1 生命周期"></a>5.1 生命周期</h2><ul>
<li>LTS  Long Time Support  长期维护版本</li>
<li>zabbix生命周期及版本选择</li>
<li>zabbix-in-the-furture</li>
</ul>
<h2 id="5-2-Zabbix监控架构"><a href="#5-2-Zabbix监控架构" class="headerlink" title="5.2 Zabbix监控架构"></a>5.2 Zabbix监控架构</h2><ul>
<li>Zabbix是一个CS（服务端&#x2F;客户端）架构的服务</li>
<li>zabbix监控架构</li>
<li>Zabbix-Agent获取数据–发送给–&gt;Zabbix-Server服务端—数据会被存放-&gt;数据库&lt;—Zabbix Web页面展示数据</li>
<li>采集数据—-&gt;数据收集，数据分析，报警—&gt;存储—&gt;友好的展示</li>
</ul>
<h1 id="六、Zabbix生产快速实践指南"><a href="#六、Zabbix生产快速实践指南" class="headerlink" title="六、Zabbix生产快速实践指南"></a>六、Zabbix生产快速实践指南</h1><h2 id="6-1-主机规划"><a href="#6-1-主机规划" class="headerlink" title="6.1 主机规划"></a>6.1 主机规划</h2><ul>
<li>配置要求</li>
</ul>
<table>
<thead>
<tr>
<th>规模</th>
<th>平台</th>
<th>CPU&#x2F;内存</th>
<th>数据库</th>
<th>受监控的主机数量</th>
</tr>
</thead>
<tbody><tr>
<td>小型</td>
<td>CentOS</td>
<td>Virtual Appliance</td>
<td>MySQL InnoDB</td>
<td>100</td>
</tr>
<tr>
<td>中型</td>
<td>CentOS</td>
<td>2 CPU cores&#x2F;2GB</td>
<td>MySQL InnoDB</td>
<td>500</td>
</tr>
<tr>
<td>大型</td>
<td>RedHat Enterprise Linux</td>
<td>4 CPU cores&#x2F;8GB</td>
<td>RAID10 MySQL InnoDB 或 PostgreSQL</td>
<td>&gt;1000</td>
</tr>
<tr>
<td>极大型</td>
<td>RedHat Enterprise Linux</td>
<td>8 CPU cores&#x2F;16GB</td>
<td>Fast RAID10 MySQL InnoDB 或 PostgreSQL</td>
<td>&gt;10000</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>角色</th>
<th>主机名</th>
<th>eth0&#x2F;eth1</th>
<th>配置</th>
</tr>
</thead>
<tbody><tr>
<td>Zabbix服务端</td>
<td>m03-zabbix-server</td>
<td>10.0.0.71&#x2F;172.16.1.71</td>
<td>1C1G(实际推荐1C2G)</td>
</tr>
<tr>
<td>Zabbix服务端</td>
<td>web01</td>
<td>10.0.0.7&#x2F;172.16.1.7</td>
<td>1C1G</td>
</tr>
<tr>
<td>Zabbix服务端</td>
<td>db01</td>
<td>10.0.0.51&#x2F;172.16.1.51</td>
<td>1C1G</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>参数</th>
<th>所需磁盘空间的计算公式（单位：字节）</th>
</tr>
</thead>
<tbody><tr>
<td>Zabbix 配置文件</td>
<td>固定大小。通常为10MB或更少。</td>
</tr>
<tr>
<td>History(历史数据)</td>
<td>days(items&#x2F;refresh rate)243600bytes items：监控项数量。days：保留历史数据的天数。refresh rate：监控项的更新间隔。bytes：保留单个值所需要占用的字节数，依赖于数据库引擎，通常为~90字节。</td>
</tr>
<tr>
<td>Trends(趋势数据)</td>
<td>days(items&#x2F;3600)243600bytes items：监控项数量。days:保留历史数据的天数。bytes:保留单个趋势数据所需要占用的字节数，依赖于数据库引擎，通常为~90字节。</td>
</tr>
<tr>
<td>Events(事件数据)</td>
<td>daysevents243600bytes events：每秒产生的事件数量。假设最糟糕的情况下，每秒产生1个事件。days：保留历史数据的天数。bytes:保留单个趋势数据所需的字节数，取决于数据库引 通常为~170字节。</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>角色</th>
<th>主机名</th>
<th>eth0&#x2F;eth1</th>
<th>配置</th>
</tr>
</thead>
<tbody><tr>
<td>Zabbix服务端</td>
<td>m03-zabbix-server</td>
<td>10.0.0.72&#x2F;172.16.1.72</td>
<td>1C1G(实际推荐1C2G)</td>
</tr>
<tr>
<td>Zabbix服务端</td>
<td>web01</td>
<td>10.0.0.7&#x2F;172.16.1.7</td>
<td>1C1G</td>
</tr>
<tr>
<td>Zabbix服务端</td>
<td>db01</td>
<td>10.0.0.51&#x2F;172.16.1.51</td>
<td>1C1G</td>
</tr>
</tbody></table>
<h2 id="6-2-企业Zabbix安装最佳实战-CentOS7"><a href="#6-2-企业Zabbix安装最佳实战-CentOS7" class="headerlink" title="6.2 企业Zabbix安装最佳实战-CentOS7"></a>6.2 企业Zabbix安装最佳实战-CentOS7</h2><table>
<thead>
<tr>
<th>安装方式</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>极速全自动安装yum</td>
<td></td>
</tr>
<tr>
<td>混合安装yum+自定义配置<strong>（最佳实践）</strong></td>
<td>lnmp(yum)  zabbix-server(yum)  zabbix-web环境(源码包)</td>
</tr>
<tr>
<td>docker</td>
<td></td>
</tr>
<tr>
<td>源码编译安装</td>
<td></td>
</tr>
</tbody></table>
<p>zabbix-server+页面（前端）</p>
<p>:one:nginx</p>
<p>:two:php</p>
<p>:three:数据库</p>
<p>:four:zabbix-server</p>
<p>:five:web部署</p>
<p>:one:nginx环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#m03  zabbix-server  10.0.0.72/172.16.1.72</span></span><br><span class="line"><span class="comment">###配置nginx源</span></span><br><span class="line"></span><br><span class="line">[root@m03 ~]<span class="comment"># cat /etc/yum.repos.d/nginx.repo</span></span><br><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/<span class="variable">$releasever</span>/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=<span class="literal">true</span></span><br><span class="line">[root@m03 ~]<span class="comment"># yum install nginx --enablerepo=nginx-stable</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>:two:php</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#nginx  1.20.1  php7.2</span></span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line">yum install epel-release.noarch -y  <span class="comment">#webtatic要求</span></span><br><span class="line">curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm  <span class="comment">#webtatic源</span></span><br><span class="line">yum install php72w-cli php72w-fpm php72w-gd php72w-mbstring php72w-bcmath php72w-xml php72w-ldap php72w-mysqlnd -y</span><br><span class="line"></span><br><span class="line">[root@m03 ~]<span class="comment"># rpm -qa |egrep &#x27;nginx|php72w&#x27;</span></span><br></pre></td></tr></table></figure>



<p>:three:nginx+php</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">01</span></span><br><span class="line">[root@m03 ~]# systemctl enable nginx php-fpm.service</span><br><span class="line">[root@m03 ~]# systemctl start nginx php-fpm.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">02 nginx配置</span></span><br><span class="line">[root@m03 ~]# cat /etc/nginx/conf.d/zabbix.conf</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  zbx.oldboylinux.cn;</span><br><span class="line">        root         /code/zabbix;</span><br><span class="line">        location / &#123;</span><br><span class="line">            index index.php;</span><br><span class="line">        &#125;</span><br><span class="line">        location ~ \.php$ &#123;</span><br><span class="line">            fastcgi_pass  127.0.0.1:9000;</span><br><span class="line">            fastcgi_index  index.php;</span><br><span class="line">            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">            include    fastcgi_params;</span><br><span class="line">        &#125;        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@m03 ~]# nginx -t</span><br><span class="line">[root@m03 ~]# systemctl reload nginx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">03 php 配置</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改php用户</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">准备 php会话保持目录</span></span><br><span class="line"></span><br><span class="line">[root@m03 ~]# sed -ri &#x27;/^(user|group)/s#apache#nginx#g&#x27; /etc/php-fpm.d/www.conf</span><br><span class="line">[root@m03 ~]# egrep &#x27;^(user|group)&#x27; /etc/php-fpm.d/www.conf</span><br><span class="line">user = nginx</span><br><span class="line">group = nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@m03 ~]# grep &#x27;var/lib/php/session&#x27; /etc/php-fpm.d/www.conf</span><br><span class="line">php_value[session.save_path] = /var/lib/php/session</span><br><span class="line">[root@m03 ~]# mkdir -p /var/lib/php/session</span><br><span class="line">[root@m03 ~]# chown nginx.nginx /var/lib/php/session</span><br><span class="line"></span><br><span class="line">[root@m03 ~]# php-fpm -t</span><br><span class="line">[15-Jul-2021 15:33:44] NOTICE: configuration file /etc/php-fpm.conf test is successful</span><br><span class="line"></span><br><span class="line">[root@m03 ~]# systemctl reload php-fpm.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">04 php+nginx测试</span></span><br><span class="line">[root@m03 ~]# mkdir -p /code/zabbix</span><br><span class="line">[root@m03 ~]# chown nginx.nginx /code/zabbix</span><br><span class="line">[root@m03 ~]# vim /code/zabbix/info.php</span><br><span class="line">[root@m03 ~]# cat /code/zabbix/info.php</span><br><span class="line">&lt;?php</span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line">[root@m03 ~]#</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>略过👇</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建目录测试文件</span></span><br><span class="line"><span class="built_in">cat</span> /app/code/zbx/info.php</span><br><span class="line">&lt;?php</span><br><span class="line">  phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务与ces</span></span><br><span class="line">systemcatl <span class="built_in">enable</span> nginx php-fpm</span><br><span class="line">systemctl start nginx php-fpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试web(hosts解析)</span></span><br><span class="line">10.0.0.63  zbx.oldboylinux.cn</span><br></pre></td></tr></table></figure>

<p>略过👆</p>
<p>:four:数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@m03 ~]<span class="comment"># yum install -y mariadb-server</span></span><br><span class="line">[root@m03 ~]<span class="comment"># mysql_secure_installation</span></span><br><span class="line">Y Y Y Y Y</span><br><span class="line">MariaDB [(none)]&gt; select user,host from mysql.user;</span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">create database zabbix charset utf8 collate utf8_bin;</span><br><span class="line">grant all on zabbix.* to <span class="string">&#x27;zabbix&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">grant all on zabbix.* to <span class="string">&#x27;zabbix&#x27;</span>@<span class="string">&#x27;172.16.1.%&#x27;</span> identified by <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">MariaDB [(none)]&gt; select user,host from mysql.user;</span><br></pre></td></tr></table></figure>





<p>略过👇</p>
<p>zabbix 6.0 不支持 mariadb 5.5(默认源中的mariadb)安装mariadb 10.5</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1gN4y1g74Q?p=16&vd_source=629395ac7befa1625191c3f496068941">配置mariadb yum源</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@m03 ~]<span class="comment"># cat /etc/yum.repos.d/mariadb.repo</span></span><br><span class="line">[mariadb]</span><br><span class="line">name = MariaDB</span><br><span class="line">baseurl = http://mirrors.aliyun.com/mariadb/yum/10.5/centos7-amd64/</span><br><span class="line">gpgkey = http://mirrors.aliyun.com/mariadb/yum/RPM-GPG-KEY-MariaDB</span><br><span class="line">gpgcheck = 1</span><br><span class="line">enabled=1</span><br><span class="line"></span><br><span class="line">[root@m03 ~]<span class="comment"># yum install -y mariadb-server</span></span><br><span class="line">[root@m03 ~]<span class="comment"># rpm -qa |grep -i mariadb</span></span><br><span class="line">[root@m03 ~]<span class="comment"># systemctl enable mariadb</span></span><br><span class="line">[root@m03 ~]<span class="comment"># systemctl start mariadb</span></span><br><span class="line">[root@m03 ~]<span class="comment"># mysql_secure_installation  # 数据库初始化（仅1次）</span></span><br><span class="line">Enter current password <span class="keyword">for</span> root (enter <span class="keyword">for</span> none): 回车</span><br><span class="line">Switch to unix_socket authentication [Y/n] 输入n</span><br><span class="line">Change the root password? [Y/n] 输入Y 设置root密码</span><br><span class="line">Remove anonymous <span class="built_in">users</span>? [Y/n] 输入Y</span><br><span class="line">Disallow root login remotely? [Y/n] 输入Y</span><br><span class="line">Remove <span class="built_in">test</span> database and access to it? [Y/n] 输入Y</span><br><span class="line">Reload privilege tables now? [Y/n] 输入Y</span><br><span class="line">Thanks <span class="keyword">for</span> using MariaDB!  表示完成</span><br></pre></td></tr></table></figure>

<p>创建zabbix用户</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">user</span>,host <span class="keyword">from</span> mysql.user;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="keyword">create</span> database zabbix charset utf8 <span class="keyword">collate</span> utf8_general_ci;  #有问题</span><br><span class="line"><span class="keyword">create</span> database zabbix <span class="type">character</span> <span class="keyword">set</span> utf8 <span class="keyword">collate</span> utf8_bin;</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> zabbix.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;zabbix&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> zabbix.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;zabbix&#x27;</span>@<span class="string">&#x27;172.16.1.%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;1&#x27;</span>; #如果数据与zabbix,php不在一起</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">user</span>,host <span class="keyword">from</span> mysql.user;</span><br></pre></td></tr></table></figure>

<p>导入数据库(注意导入顺序)  (跳过)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@m03 ~]<span class="comment"># wget https://cdn.zabbix.com/zabbix/sources/stable/6.0/zabbix-6.0.9.tar.gz</span></span><br><span class="line">[root@m03 ~]<span class="comment"># tar xf zabbix-6.0.9.tar.gz</span></span><br><span class="line">[root@m03 ~]<span class="comment"># cd zabbix-6.0.9/database/mysql</span></span><br><span class="line">[root@m03 ~]<span class="comment"># ls -l</span></span><br><span class="line">[root@m03 ~]<span class="comment"># mysql -uroot -p1 zabbix &lt;schema.sql</span></span><br><span class="line">[root@m03 ~]<span class="comment"># mysql -uroot -p1 zabbix &lt;images.sql</span></span><br><span class="line">[root@m03 ~]<span class="comment"># mysql -uroot -p1 zabbix &lt;data.sql</span></span><br><span class="line">[root@m03 ~]<span class="comment"># mysql -uroot -p1 zabbix &lt;double.sql</span></span><br><span class="line">[root@m03 ~]<span class="comment"># mysql -uroot -p1 zabbix &lt;history_pk_prepare.sql</span></span><br></pre></td></tr></table></figure>

<p>测试数据库</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat mysqli.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//$link_id=mysqli_connect(&#x27;主机名&#x27;,&#x27;用户&#x27;,&#x27;密码&#x27;);</span></span><br><span class="line"><span class="variable">$link_id</span>=<span class="title function_ invoke__">mysqli_connect</span>(<span class="string">&#x27;localhost&#x27;</span>,<span class="string">&#x27;zabbix&#x27;</span>,<span class="string">&#x27;1&#x27;</span>) <span class="keyword">or</span></span><br><span class="line"><span class="title function_ invoke__">mysqli_error</span>();</span><br><span class="line">  <span class="keyword">if</span>(<span class="variable">$link_id</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;mysql successful by oldboy !&quot;</span>;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">mysqli_error</span>();</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//这是php单行注释</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>略过👆</p>
<p>:five:zabbix-服务端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装zabbix yum源</span></span><br><span class="line">yum -Uvh https://mirrors.tuna.tsinghua.edu.cn/zabbix/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-1.el7.noarch.rpm</span><br><span class="line"></span><br><span class="line">sed <span class="string">&#x27;s#http://repo.zabbix.com#https://mirrors.tuna.tsinghua.edu.cn/zabbix#g&#x27;</span> /etc/yum.repos.d/zabbix.repo</span><br><span class="line"></span><br><span class="line"><span class="comment">#zabbix-release.....rpm zabbix yum源的配置文件</span></span><br><span class="line"></span><br><span class="line">[root@m03 ~]<span class="comment"># cat /etc/yum.repos.d/zabbix.repo</span></span><br><span class="line">[zabbix]</span><br><span class="line">name=Zabbix Official Repository - <span class="variable">$basearch</span></span><br><span class="line">baseurl=https://mirror.tuna.tsinghua.edu.cn/zabbix/zabbix/5.0/rhel/7/<span class="variable">$basearch</span>/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-ZABBIX-A14FE591</span><br><span class="line"></span><br><span class="line">[zabbix-frontend]</span><br><span class="line">name=Zabbix Official Repository frontend - <span class="variable">$basearch</span></span><br><span class="line">baseurl=https://mirror.tuna.tsinghua.edu.cn/zabbix/zabbix/5.0/rhel/7/<span class="variable">$basearch</span>/frontend</span><br><span class="line">enabled=0</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-ZABBIX-A14FE591</span><br><span class="line"></span><br><span class="line">[zabbix-debuginfo]</span><br><span class="line">name=Zabbix Official Repository debuginfo - <span class="variable">$basearch</span></span><br><span class="line">baseurl=https://mirror.tuna.tsinghua.edu.cn/zabbix/zabbix/5.0/rhel/7/<span class="variable">$basearch</span>/debuginfo/</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-ZABBIX-A14FE591</span><br><span class="line">gpgcheck=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 zabbix-server</span></span><br><span class="line">[root@m03 ~]<span class="comment"># yum install -y zabbix-server-mysql zabbix-agent2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># zabbix 数据库导入数据</span></span><br><span class="line">[root@m03 ~]<span class="comment"># zcat /usr/share/doc/zabbix-server-mysql-5.0.13/create.sql.gz |mysql -uzabbix -p1 zabbix</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># zabbix 服务端 配置连接数据库</span></span><br><span class="line">[root@m03 ~]<span class="comment"># vim /etc/zabbix/zabbix_server.conf</span></span><br><span class="line">[root@m03 ~]<span class="comment"># grep ^DB /etc/zabbix/zabbix_server.conf</span></span><br><span class="line">DBHost=localhost</span><br><span class="line">DBName=zabbix</span><br><span class="line">DBUser=zabbix</span><br><span class="line">DBPassword=1</span><br><span class="line"></span><br><span class="line">[root@m03 ~]<span class="comment"># grep -n &#x27;^DB&#x27; /etc/zabbix/zabbix_server.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改后 zabbix 服务端开启的功能（不用修改）</span></span><br><span class="line">[root@m03 ~]<span class="comment"># grep &#x27;^[a-Z]&#x27; /etc/zabbix/zabbix_server.conf</span></span><br><span class="line">LogFile=/var/log/zabbix/zabbix_server.log</span><br><span class="line">LogFileSize=0</span><br><span class="line">PidFile=/var/run/zabbix/zabbix_server.pid</span><br><span class="line">SocketDir=/var/run/zabbix</span><br><span class="line">DBHost=localhost</span><br><span class="line">DBName=zabbix</span><br><span class="line">DBUser=zabbix</span><br><span class="line">DBPassword=1</span><br><span class="line">SNMPTrapperFile=/var/log/snmptrap/snmptrap.log</span><br><span class="line">Timeout=4</span><br><span class="line">AlertScriptsPath=/usr/lib/zabbix/alertscripts</span><br><span class="line">ExternalScripts=/usr/lib/zabbix/externalscripts</span><br><span class="line">LogSlowQueries=3000</span><br><span class="line">StatsAllowedIP=127.0.0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 zabbix-server</span></span><br><span class="line">[root@m03 ~]<span class="comment"># systemctl enable zabbix-server</span></span><br><span class="line">[root@m03 ~]<span class="comment"># systemctl start zabbix-server</span></span><br><span class="line">[root@m03 ~]<span class="comment"># ss -lntup |grep zabbix</span></span><br><span class="line">[root@m03 ~]<span class="comment"># ps -ef |grep zabbix</span></span><br></pre></td></tr></table></figure>



<p>:six:zabbix前端页面准备</p>
<p><code>https://www.zabbix.com/cn/download_sources</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用源码包</span></span><br><span class="line">wget https://cdn.zabbix.com/zabbix/sources/stable/5.0/zabbix-5.0.18.tar.gz</span><br><span class="line">tar xf zabbix-5.0.18</span><br><span class="line"><span class="built_in">cd</span> zabbix-5.0.18</span><br><span class="line"><span class="built_in">cp</span> -a ui/* /app/code/zbx/</span><br><span class="line"><span class="built_in">chown</span> -R nginx.nginx /app/code/zbx/</span><br></pre></td></tr></table></figure>



<p>:seven:安装zabbix(zabbix前端页面连接数据库与zabbix-server)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#php最后的配置</span></span><br><span class="line">Minimum required size of PHP post is 16M (configuration option <span class="string">&quot;post_max_size&quot;</span>).</span><br><span class="line">Minimum required <span class="built_in">limit</span> on execution time of PHP scripts is 300 (configuration option <span class="string">&quot;max_execution_time&quot;</span>).</span><br><span class="line">Minimum required <span class="built_in">limit</span> on input parse time <span class="keyword">for</span> PHP scripts is 300 (configuration option <span class="string">&quot;max_input_time&quot;</span>).</span><br><span class="line">Time zone <span class="keyword">for</span> PHP is not <span class="built_in">set</span> (configuration parameter <span class="string">&quot;date.timezone&quot;</span>).</span><br><span class="line"></span><br><span class="line">[root@m03 ~]<span class="comment"># vim /etc/php.ini</span></span><br><span class="line">post_max_size = 16M</span><br><span class="line">max_execution_time = 300</span><br><span class="line">max_input_time = 300</span><br><span class="line">date.timezone = Asia/Shanghai</span><br><span class="line"></span><br><span class="line">[root@m03 ~]<span class="comment"># egrep -n &#x27;^(max_|date.timezone|post_max)&#x27; /etc/php.ini</span></span><br><span class="line">368:max_execution_time = 300</span><br><span class="line">378:max_input_time = 600</span><br><span class="line">656:post_max_size = 80M</span><br><span class="line">802:max_file_uploads = 20</span><br><span class="line">877:date.timezone = Asia/Shanghai</span><br><span class="line"></span><br><span class="line">[root@m03 ~]<span class="comment"># rpm -ivh php72w-bcmath-7.2.34-1.w7.x86_64.rpm</span></span><br><span class="line">[root@m03 ~]<span class="comment"># yum install -y php72w-ldap</span></span><br><span class="line">[root@m03 ~]<span class="comment"># rpm -ivh php72w-ldap</span></span><br><span class="line">[root@m03 ~]<span class="comment"># systemctl reload php-fpm.service</span></span><br><span class="line">[root@m03 ~]<span class="comment"># systemctl restart php-fpm</span></span><br></pre></td></tr></table></figure>

<p>浏览器访问zbx.oldboylinux.cn  用户：admin，密码：zabbix</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@m03 ~]<span class="comment"># systemctl enable zabbix-agent2.service</span></span><br><span class="line">[root@m03 ~]<span class="comment"># systemctl start zabbix-agent2.service</span></span><br></pre></td></tr></table></figure>





<h1 id="七、监控一台服务器主机"><a href="#七、监控一台服务器主机" class="headerlink" title="七、监控一台服务器主机"></a>七、监控一台服务器主机</h1><h2 id="7-1-Zabbix-agent-vs-agent2"><a href="#7-1-Zabbix-agent-vs-agent2" class="headerlink" title="7.1 Zabbix agent vs agent2"></a>7.1 Zabbix agent vs agent2</h2><p>在任何一台服务器上面安装zabbix-agent  zabbix-agent2</p>
<table>
<thead>
<tr>
<th></th>
<th>zabbix agent</th>
<th>zabbix agent2</th>
</tr>
</thead>
<tbody><tr>
<td>开发语言</td>
<td>C语言</td>
<td>Go语言，和C语言</td>
</tr>
<tr>
<td>性能</td>
<td>独立进程方式运行</td>
<td>1个进程多线程技术运行，减少资源消耗占用较少tcp资源，能够承受更高并发</td>
</tr>
</tbody></table>
<h2 id="7-2-Zabbix-Agent-2-监控流程"><a href="#7-2-Zabbix-Agent-2-监控流程" class="headerlink" title="7.2 Zabbix Agent[2]监控流程"></a>7.2 Zabbix Agent[2]监控流程</h2><p>Linux安装与配置客户端</p>
<p>web添加与配置主机</p>
<p>:one:Liunx:在客户端安装zabbix-agent2(rpm)</p>
<p>:two:Liunx:修改配置文件指定Server为zabbix服务端</p>
<p>:three:web页面:配置–&gt;主机中添加主机与关联模板</p>
<p>:four:web页面:添加后检测与检查数据</p>
<h3 id="1）补充-zabbix服务端与客户端配置详解"><a href="#1）补充-zabbix服务端与客户端配置详解" class="headerlink" title="1）补充:zabbix服务端与客户端配置详解"></a>1）补充:zabbix服务端与客户端配置详解</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#zabbix 服务端 说明</span></span><br><span class="line"></span><br><span class="line">[root@m03 ~]<span class="comment"># rpm -qa |grep zabbix</span></span><br><span class="line">zabbix-release-5.0-1.el7.noarch    <span class="comment">#zabbix yum源配置文件</span></span><br><span class="line">zabbix-server-mysql-5.0.13-1.el7.x86_64    <span class="comment">#server</span></span><br><span class="line">zabbix-agent2-5.0.13-1.el7.x86_64    <span class="comment">#agent2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#zabbix服务端</span></span><br><span class="line">[root@m03 ~]<span class="comment"># rpm -ql zabbix-server-mysql</span></span><br><span class="line">/etc/logrotate.d/zabbix-server    <span class="comment">#日志切割</span></span><br><span class="line">/etc/zabbix/zabbix_server.conf    <span class="comment">#zabbix服务端配置文件</span></span><br><span class="line">/usr/lib/systemd/system/zabbix-server.service    <span class="comment">#systemctl start/stop/restart 调用配置文件</span></span><br><span class="line">/usr/lib/zabbix/alertscripts    <span class="comment">#报警使用的脚本  存放处</span></span><br><span class="line">/usr/lib/zabbix/externalscripts</span><br></pre></td></tr></table></figure>



<h3 id="2）监控客户端"><a href="#2）监控客户端" class="headerlink" title="2）监控客户端"></a>2）监控客户端</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]<span class="comment"># rpm -ivh https://mirrors.tuna.tsinghua.edu.cn/zabbix/zabbix/5.0/rhel/7/x86_64/zabbix-sender-5.0.18-1.el7.x86_64.rpm</span></span><br><span class="line">[root@web01 ~]<span class="comment"># systemctl enable zabbix-agent2.service</span></span><br><span class="line">[root@web01 ~]<span class="comment"># systemctl start zabbix-agent2.service</span></span><br><span class="line">[root@web01 ~]<span class="comment"># grep &#x27;^[a-Z]&#x27; /etc/zabbix/zabbix_agent2.conf</span></span><br><span class="line">[root@web01 ~]<span class="comment"># vim /etc/zabbix/zabbix_agent2.conf</span></span><br><span class="line">Server=172.16.1.71    <span class="comment">#改</span></span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@m03 ~]<span class="comment"># yum install -y zabbix-get</span></span><br><span class="line">[root@m03 ~]<span class="comment"># zabbix_get -s 172.16.1.7 -p 10050 -k system.hostname</span></span><br><span class="line">web01</span><br></pre></td></tr></table></figure>



<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032582.png" alt="image-20220925203729370"></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032584.png" alt="image-20220925203857824"></p>
<h2 id="7-3-日常查看数据"><a href="#7-3-日常查看数据" class="headerlink" title="7.3 日常查看数据"></a>7.3 日常查看数据</h2><h2 id="7-4-Zabbix中文乱码问题"><a href="#7-4-Zabbix中文乱码问题" class="headerlink" title="7.4 Zabbix中文乱码问题"></a>7.4 Zabbix中文乱码问题</h2><p>解决zabbix默认图形乱码问题</p>
<p>修改zabbix字体</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /code/zabbix/assets/fonts/</span><br><span class="line"><span class="comment">#上传一个中文的ttf字体  替换  zabbix自用的字体即可.</span></span><br><span class="line"><span class="built_in">cp</span> /code/zabbix/assets/fonts/DejavuSans.ttf&#123;,.bak&#125;</span><br><span class="line"><span class="built_in">cp</span> msyh.ttc /code/zabbix/assets/fonts/DejaVuSans.ttf</span><br></pre></td></tr></table></figure>





<h1 id="八、自定义监控那点事"><a href="#八、自定义监控那点事" class="headerlink" title="八、自定义监控那点事"></a>八、自定义监控那点事</h1><h2 id="8-1-自定义监控概述"><a href="#8-1-自定义监控概述" class="headerlink" title="8.1 自定义监控概述"></a>8.1 自定义监控概述</h2><ul>
<li>应用场景：<ul>
<li><strong>定制：</strong>默认的模板中没有我们要的监控项</li>
<li><strong>提升zabbix性能&#x2F;优化：</strong>去掉&#x2F;定制监控项，提升zabbix服务端的性能</li>
</ul>
</li>
<li>zabbix自定义监控，记住一句话，闯天下：<strong>只要能够通过命令&#x2F;脚本取出来的内容，就可以做自定义监控</strong></li>
</ul>
<h2 id="8-2-自定义监控项流程"><a href="#8-2-自定义监控项流程" class="headerlink" title="8.2 自定义监控项流程"></a>8.2 自定义监控项流程</h2><p>:one:Zabbix客户端，创建key（键值）与调试（自定义监控的核心）</p>
<p>​	书写监控命令&#x2F;脚本</p>
<p>​	调试Debug命令与脚本</p>
<p>​	写入到zabbix客户端配置文件中 UserParameter&#x3D;key,command或脚本  与调试  zabbix_get</p>
<p>:two:Zabbix服务端web页面-点点点</p>
<p>​	Web页面添加&#x2F;修改模板</p>
<p>​	Web页面分组</p>
<p>​	:three:Web页面监控项-zabbix服务端是否可以获取数据</p>
<p>​	:four:Web页面触发器 trigger-什么时候报警</p>
<p>​	:five:Web页面图形</p>
<ul>
<li>要求，统计web01  80端口是否存在</li>
<li>假设，zabbix无法获取端口状态</li>
<li>zabbix自定义监控项</li>
</ul>
<h2 id="zbx-自定义监控"><a href="#zbx-自定义监控" class="headerlink" title="zbx-自定义监控"></a>zbx-自定义监控</h2><h3 id="1-需求：检查当前机器是否root远程登录"><a href="#1-需求：检查当前机器是否root远程登录" class="headerlink" title="1.需求：检查当前机器是否root远程登录"></a>1.需求：检查当前机器是否root远程登录</h3><ul>
<li>:a:zbx-agent: web01 命令行<ul>
<li>书写满足要求的命令</li>
</ul>
</li>
<li>:b:zbx-server web页面<ul>
<li>命令行创建的键值与<strong>监控项</strong>关联起来</li>
</ul>
</li>
</ul>
<h4 id="1-1-Linux：命令"><a href="#1-1-Linux：命令" class="headerlink" title="1.1 Linux：命令"></a>1.1 Linux：命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">who</span> |awk <span class="string">&#x27;$1==&quot;root&quot;&#x27;</span> |<span class="built_in">wc</span> -l  <span class="comment">#数字大于1 表示有root远程登录.</span></span><br></pre></td></tr></table></figure>



<h4 id="1-2-Linux：创建键值-zbx-server识别）"><a href="#1-2-Linux：创建键值-zbx-server识别）" class="headerlink" title="1.2 Linux：创建键值(zbx-server识别）"></a>1.2 Linux：创建键值(zbx-server识别）</h4><ul>
<li>key键值：zbx服务端内置，用户创建的命令，可以被zabbix服务端识别。服务端执行对应的键值就会获取对应的数据。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在客户端配置文件中按照要求的格式书写即可.</span></span><br><span class="line"></span><br><span class="line">[root@web01 ~]<span class="comment"># vim /etc/zabbix/zabbix_agent2.d/web.conf</span></span><br><span class="line"><span class="comment">#UserParameter=键值名字,对应的命令或脚本</span></span><br><span class="line">UserParameter=root.login, <span class="built_in">who</span> |awk <span class="string">&#x27;$1==&quot;root&quot;&#x27;</span> |<span class="built_in">wc</span> -l</span><br><span class="line">[root@web01 ~]<span class="comment"># systemctl restart zabbix-agent2</span></span><br></pre></td></tr></table></figure>



<h4 id="1-3-Linux：测试-zbx-服务端"><a href="#1-3-Linux：测试-zbx-服务端" class="headerlink" title="1.3 Linux：测试-zbx-服务端"></a>1.3 Linux：测试-zbx-服务端</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@m03 ~]<span class="comment"># zabbix_get -s 172.16.1.7 -k root.login</span></span><br><span class="line">1</span><br></pre></td></tr></table></figure>



<h4 id="1-4-web：创建监控项"><a href="#1-4-web：创建监控项" class="headerlink" title="1.4 web：创建监控项"></a>1.4 web：创建监控项</h4><p>更新间隔：线上环境推荐1m，不太重要10m 或1h</p>
<p>监控项：zbx服务端向客户端获取数据的一个方式    监控项与键值关联</p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032585.png"></p>
<p>历史数据：每个间隔获取的数据，不太推荐保留过长</p>
<p>趋势数据：每个小时，或者更长时间获取一次历史数据的平均值    可以长期保存</p>
<p>应用集：对 监控项进行分类</p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032586.png" alt="image-20220925214501414"></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032587.png" alt="image-20220925214552078"></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032588.png" alt="image-20220925214622832"></p>
<h4 id="1-5-web：创建触发器"><a href="#1-5-web：创建触发器" class="headerlink" title="1.5 web：创建触发器"></a>1.5 web：创建触发器</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">报警的条件：root登录的数量大于2</span><br><span class="line"></span><br><span class="line">&#123;web01:root.login.last()&#125;    &gt;        2</span><br><span class="line">获取数据                      条件    条件对应的值(阈值)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;主机名:键值.函数功能&#125;</span><br><span class="line">函数功能：对应的不同的数据的处理方法</span><br><span class="line">比如 last() 最新的值</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">比如 sum() 求和</span><br><span class="line">min()  最小值</span><br><span class="line">max()  最大值</span><br><span class="line">avg()  平均值</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">分析：</span><br><span class="line">&#123;web01:system.uptime.last()&#125;&lt;10m #重启</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032589.png" alt="image-20220925220908600"></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032590.png" alt="image-20220925221354232"></p>
<h4 id="1-6-web：创建图形"><a href="#1-6-web：创建图形" class="headerlink" title="1.6 web：创建图形"></a>1.6 web：创建图形</h4><p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032591.png" alt="image-20220925230011298"></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032594.png" alt="image-20220925230026168"></p>
<h3 id="2-创建模板：添加监控项，触发器，图形"><a href="#2-创建模板：添加监控项，触发器，图形" class="headerlink" title="2.创建模板：添加监控项，触发器，图形"></a>2.创建模板：添加监控项，触发器，图形</h3><h4 id="2-1-创建模板"><a href="#2-1-创建模板" class="headerlink" title="2.1 创建模板"></a>2.1 创建模板</h4><p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032595.png" alt="image-20220925230809175"></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032596.png" alt="image-20220925230838460"></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032597.png" alt="image-20220925230942274"></p>
<h4 id="2-2-模板关联主机"><a href="#2-2-模板关联主机" class="headerlink" title="2.2 模板关联主机"></a>2.2 模板关联主机</h4><p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032598.png" alt="image-20220925231219140"></p>
<h3 id="3-监控告警"><a href="#3-监控告警" class="headerlink" title="3 监控告警"></a>3 监控告警</h3><h1 id="zbx-全网全链路-x2F-全流程监控-架构"><a href="#zbx-全网全链路-x2F-全流程监控-架构" class="headerlink" title="zbx-全网全链路&#x2F;全流程监控-架构"></a>zbx-全网全链路&#x2F;全流程监控-架构</h1><p>面试题：你公司监控了什么？&#x2F;你们公司监控是如何做？</p>
<ul>
<li>维度01：每个机器<ul>
<li>业务&#x2F;api接口</li>
<li>服务层</li>
<li>系统层</li>
<li>物理层</li>
</ul>
</li>
<li>维度02：用户访问网站（集群）<ul>
<li>DNS</li>
<li>CDN</li>
<li>网站架构<ul>
<li>带宽</li>
<li>并发（用户数量），日活，pv,uv,ip</li>
<li>具体服务监控</li>
</ul>
</li>
</ul>
</li>
<li>维度03：其他<ul>
<li>日志的错误信息</li>
<li>证书过期</li>
<li>apm监控  链路监控</li>
</ul>
</li>
</ul>
<p>zbx监控架构</p>
<p>zbx监控节点</p>
<ul>
<li>linux</li>
<li>web<ul>
<li>创建主机</li>
<li>关联模板</li>
</ul>
</li>
</ul>
<p>zbx自定义监控</p>
<ul>
<li>Linux客户端（自定义键值key）<ul>
<li>根据需求书写命令&#x2F;脚本并测试</li>
<li>命令或脚本按照要求的格式，写入到客户端配置文件</li>
<li>进行调试</li>
</ul>
</li>
<li>SRV服务端web页面：<ul>
<li>修改主机信息</li>
<li>添加监控项<ul>
<li>linux键值 与 web页面 关联起来,server可以通过键值获取数据.</li>
</ul>
</li>
<li>添加触发器<ul>
<li>是否告警</li>
</ul>
</li>
<li>添加图形</li>
</ul>
</li>
<li>制作模板<ul>
<li>先找个主机<ul>
<li>应用集</li>
<li>创建监控项</li>
<li>创建触发器</li>
<li>创建图形</li>
</ul>
</li>
<li>复制到模板中</li>
</ul>
</li>
</ul>
<p>zbx告警方式</p>
<ul>
<li>邮件</li>
<li>微信</li>
<li>onealert</li>
</ul>
<p>zbx客户端类型</p>
<ul>
<li>zabbix agent2客户满</li>
<li>snmp 网络设备</li>
<li>jmx java</li>
<li>ipmi</li>
</ul>
<p>自动化</p>
<ul>
<li>自动发现</li>
<li>自动注册</li>
<li>分布式监控<ul>
<li>多个机房，多个局域网监控</li>
</ul>
</li>
</ul>
<p>zbx监控项目</p>
<p>综合架构开始</p>
<ul>
<li>搭建要求</li>
<li>搭建流程</li>
<li>搭建结果如何验收</li>
</ul>
<h1 id="九、监控报警"><a href="#九、监控报警" class="headerlink" title="九、监控报警"></a>九、监控报警</h1><h2 id="9-1-告警分类"><a href="#9-1-告警分类" class="headerlink" title="9.1 告警分类"></a>9.1 告警分类</h2><table>
<thead>
<tr>
<th>报警方式</th>
<th>企业应用场景</th>
</tr>
</thead>
<tbody><tr>
<td>发邮件        个人邮箱</td>
<td>企业邮箱，免费使用</td>
</tr>
<tr>
<td>企业微信-告警应用（机器人）</td>
<td>需要使用企业微信，免费</td>
</tr>
<tr>
<td>OA系统（钉钉）</td>
<td>与阿里云，免费</td>
</tr>
<tr>
<td>短信</td>
<td>0.045元&#x2F;条左右（阿里云短信服务）收费</td>
</tr>
<tr>
<td>电话</td>
<td>收费</td>
</tr>
<tr>
<td>第三方报警工具&#x2F;平台：onealert（省事）</td>
<td>只需要配置onealert的平台信息，免费使用（限制），收费</td>
</tr>
</tbody></table>
<h2 id="9-2-邮件报警"><a href="#9-2-邮件报警" class="headerlink" title="9.2 邮件报警"></a>9.2 邮件报警</h2><h3 id="1）全流程"><a href="#1）全流程" class="headerlink" title="1）全流程"></a>1）全流程</h3><p>:one:个人邮箱&#x2F;企业邮箱</p>
<p>:two:开启个人邮箱  smtp功能  获取授权码</p>
<p>:three:<strong>发件人：</strong>配置zabbix <strong>报警媒介类型</strong></p>
<p>:four:<strong>收件人：</strong>配置用户接收报警</p>
<p>:five:<strong>什么时候发邮件：</strong>配置动作</p>
<h3 id="2）个人邮箱准备（略）"><a href="#2）个人邮箱准备（略）" class="headerlink" title="2）个人邮箱准备（略）"></a>2）个人邮箱准备（略）</h3><p>配置个人邮箱</p>
<h3 id="3）配置发件人"><a href="#3）配置发件人" class="headerlink" title="3）配置发件人"></a>3）配置发件人</h3><p>配置发件人-报警媒介</p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032599.png" alt="image-20220925233709769"></p>
<p>告警邮件内容：Messages template</p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032601.png" alt="image-20220925234035750"></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032602.png" alt="image-20220925234011891"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#信息类型是：问题（发生故障）</span></span><br><span class="line"></span><br><span class="line">主题： 故障名称：&#123;EVENT.NAME&#125;</span><br><span class="line"></span><br><span class="line">消息：</span><br><span class="line">故障始于时间：&#123;EVENT.TIME&#125;  日期：&#123;EVENT.DATE&#125;</span><br><span class="line">故障名称：&#123;EVENT.NAME&#125;</span><br><span class="line">故障主机：&#123;HOST.NAME&#125;</span><br><span class="line">严重程度：&#123;EVENT.SEVERITY&#125;</span><br><span class="line">额外信息：&#123;EVENT.OPDATA&#125;</span><br><span class="line">故障ID：&#123;EVENT.ID&#125;</span><br><span class="line">触发器地址：&#123;TRIGGER.URL&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#信息类型是：Problem recov  故障解决的时候</span></span><br><span class="line"></span><br><span class="line">主题： 故障解决 <span class="keyword">in</span> &#123;EVENT.DURATION&#125;: &#123;EVENT.NAME&#125;</span><br><span class="line"></span><br><span class="line">消息：</span><br><span class="line">故障已经解决 时间：&#123;EVENT.RECOVERY.TIME&#125;  日期：&#123;EVENT.RECOVERY.DATE&#125;</span><br><span class="line">故障名称：&#123;EVENT.NAME&#125;</span><br><span class="line">故障持续时间：&#123;EVENT.DURATION&#125;</span><br><span class="line">故障主机：&#123;HOST.NAME&#125;</span><br><span class="line">故障级别：&#123;EVENT.SEVERITY&#125;</span><br><span class="line">故障ID：&#123;EVENT.ID&#125;</span><br><span class="line">&#123;TRIGGER.URL&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032603.png" alt="image-20220925234233140"></p>
<p>多种触发条件</p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032604.png" alt="image-20220925234616949"></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032605.png" alt="image-20220925234643754"></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032606.png" alt="image-20220925234905343"></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032607.png" alt="image-20220925234724709"></p>
<p>多种 操作（发消息，远程命令）</p>
<h2 id="9-3-微信报警"><a href="#9-3-微信报警" class="headerlink" title="9.3 微信报警"></a>9.3 微信报警</h2><h3 id="1）全流程-1"><a href="#1）全流程-1" class="headerlink" title="1）全流程"></a>1）全流程</h3><p>微信报警，短信，电话，钉钉自定义脚本报警</p>
<p>通过脚本(py,shell)，调用对方api接口（输入接口需要的信息，访问与使用api接口）</p>
<p>:one:企业微信</p>
<p>:two:企业微信id和告警机器人id</p>
<p>:three:使用脚本(shell&#x2F;python)调用企业微信api接口：python  输入  收件人  信息</p>
<p>:four:发件人：报警媒介</p>
<p>:five:收件人：个人  媒体类型</p>
<p>:six:动作：已经完成</p>
<h3 id="2）准备环境-1-3"><a href="#2）准备环境-1-3" class="headerlink" title="2）准备环境 1-3"></a>2）准备环境 1-3</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.企业微信 id号</span></span><br><span class="line">Wwed9036e79f2da881</span><br><span class="line"></span><br><span class="line"><span class="comment">#2.创建1个报警机器人（应用)</span></span><br><span class="line"><span class="comment">##机器人的id(应用id)</span></span><br><span class="line">agentid 1000084</span><br><span class="line"></span><br><span class="line"><span class="comment">##应用密码</span></span><br><span class="line">Secret rfWL-rd6gF_eONI20QMHo-FvuuFHOwsXCfXmI9c0B4</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">[root@m03-zabbix-server ~]<span class="comment"># vim /usr/lib/zabbix/alertscripts/wechat.py</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment">#author: oldboy-linux</span></span><br><span class="line"><span class="comment">#date: 2021</span></span><br><span class="line"><span class="comment">#comment: Zabbix Wechat Alerts Scripts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logging.basicConfig(level = logging.DEBUG, <span class="built_in">format</span> = <span class="string">&#x27;%(asctime)s, %(filename)s, %(levelname)s, %(message)s&#x27;</span>,</span><br><span class="line">                datefmt = <span class="string">&#x27;%a, %d %b %Y %H:%M:%S&#x27;</span>,</span><br><span class="line">                filename = os.path.join(<span class="string">&#x27;/tmp&#x27;</span>,<span class="string">&#x27;weixin.log&#x27;</span>),</span><br><span class="line">                filemode = <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#id和secret需要修改</span></span><br><span class="line"><span class="comment">#企业id</span></span><br><span class="line">corpid=<span class="string">&#x27;wxd074861951c6ba6&#x27;</span></span><br><span class="line"><span class="comment">#机器人密码</span></span><br><span class="line">appsecret=<span class="string">&#x27;QtraZrI936DZ0Z3aSWTZ-lFVheAMgLmq3toM4B9U1A&#x27;</span></span><br><span class="line"><span class="comment">#机器人id</span></span><br><span class="line">agentid=<span class="number">1000004</span></span><br><span class="line"><span class="comment">#获取accesstoken</span></span><br><span class="line">token_url=<span class="string">&#x27;https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=&#x27;</span> + corpid + <span class="string">&#x27;&amp;corpsecret=&#x27;</span> + appsecret req=requests.get(token_url)</span><br><span class="line">accesstoken=req.json()[<span class="string">&#x27;access_token&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#发送消息</span></span><br><span class="line">msgsend_url=<span class="string">&#x27;https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=&#x27;</span> + accesstoken</span><br><span class="line"></span><br><span class="line"><span class="comment">#脚本参数</span></span><br><span class="line">touser=sys.argv[<span class="number">1</span>]</span><br><span class="line">subject=sys.argv[<span class="number">2</span>]</span><br><span class="line">message=sys.argv[<span class="number">2</span>] + <span class="string">&quot;\n\n&quot;</span> +sys.argv[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">params=&#123;</span><br><span class="line">        <span class="string">&quot;touser&quot;</span>: touser,</span><br><span class="line"><span class="comment">#       &quot;toparty&quot;: toparty,</span></span><br><span class="line">        <span class="string">&quot;msgtype&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="string">&quot;agentid&quot;</span>: agentid,</span><br><span class="line">        <span class="string">&quot;text&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;content&quot;</span>: message</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;safe&quot;</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">req=requests.post(msgsend_url, data=json.dumps(params))</span><br><span class="line"></span><br><span class="line">logging.info(<span class="string">&#x27;sendto:&#x27;</span> + touser + <span class="string">&#x27;;;subject:&#x27;</span> + subject + <span class="string">&#x27;;;message:&#x27;</span> + message)</span><br><span class="line"></span><br><span class="line">[root@m03-zabbix-server ~]<span class="comment"># chmod +x /usr/lib/zabbix/alertscripts/wechat.py</span></span><br><span class="line">[root@m03-zabbix-server ~]<span class="comment"># python /usr/lib/zabbix/alertscripts/wechat.py 用户(id) 主题 内容</span></span><br><span class="line">[root@m03-zabbix-server ~]<span class="comment"># python /usr/lib/zabbix/alertscripts/wechat.py lidao996 主题 内容</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试</span></span><br><span class="line">[root@m03-zabbix-server ~]<span class="comment"># python /usr/lib/zabbix/alertscripts/wechat.py all &#x27;下雨&#x27; &#x27;打雷收衣服&#x27;</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/usr/lib/zabbix/alertscripts/wechat.py&quot;</span>, line <span class="number">7</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    <span class="keyword">import</span> requests</span><br><span class="line">ImportError: No module named requests</span><br><span class="line"></span><br><span class="line">yum install -y python-pip</span><br><span class="line">pip install requests -i https://mirrors.aliyun.com/pypi/simple/</span><br><span class="line"></span><br><span class="line"><span class="comment">#web页面  发件人：报警媒介类型</span></span><br><span class="line">&#123;ALERT.SENDTO&#125;  <span class="comment">#发给谁</span></span><br><span class="line">&#123;ALERT.SUBJECT&#125;  <span class="comment">#报警标题</span></span><br><span class="line">&#123;ALERT.MESSAGE&#125;  <span class="comment">#报警内容</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">故障目前已经解决时间：&#123;EVENT.RE COVERY.TIME&#125;  日期&#123;EVENT.RECOVERY.DATE&#125;</span><br><span class="line">故障名称：&#123;EVENT.NAME&#125;</span><br><span class="line">故障经历多久：&#123;EVENT.DURATION&#125;</span><br><span class="line">故障主机：&#123;HOST.NAME&#125;</span><br><span class="line">故障级别：&#123;EVENT.SEVERITY&#125;</span><br><span class="line">故障ID：&#123;EVENT.ID&#125;</span><br><span class="line">&#123;TRIGGER.URL&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#web页面 收件人：接收用户</span></span><br><span class="line"><span class="comment">#web页面 配置--&gt;动作</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">https://qyapi.weixin.qq.com:<span class="number">443</span> <span class="string">&quot;POST /cgi-bin/message/send?access_token=kCT_jUrfrzc-_QIQX3pno12a7cR8TnNERQxAD7-cA3wnTQ85BBSZV8PJH5oxraYDarMy4i04BY2BPOdiAgoSe8jMEWwjXQv4DLHSMhkLbu3SNw1Va0T6nLhlg6CU0jJ9GTUTtfJEb-WAprHMLFV8hIUjI80j09mRxmEbhwOFgul_AlhsaCc8H_PQfwwXfV-rD4mOuTCBnSZhNJLeHBcQ</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">https://qyapi.weixin.qq.com</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">/cgi-bin/message/send?</span></span><br><span class="line"><span class="string">access_token=kCT_jUrfrzc-_QIQX3pno12a7cR8TnNERQxAD7-cA3wnTQY-</span></span><br><span class="line"><span class="string">85BBSZV8PJH5oxraYDarMy4i04BY2BPOdiAgoSe8jMEWwjXQv4DLHSMhkLbu3SNw1Va0T6nLhlg6CU0jJ9GTUTtfJEb-</span></span><br><span class="line"><span class="string">WAprHMlFV8hIUjI80j09mRxmEbhwOFgul_AlhsaCc8H_PQfwwXfV-rD4mOuTCBnSZhNJLeHBcQ</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#shell版本的 脚本</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@m03/usr/lib/zabbix/alertscripts]<span class="comment"># python wechat.py @all &#x27;网站挂了&#x27; &#x27;www.oldboylinux.cn&#x27;</span></span><br><span class="line"></span><br><span class="line">测试OK</span><br></pre></td></tr></table></figure>



<h3 id="3）配置发件人-1"><a href="#3）配置发件人-1" class="headerlink" title="3）配置发件人"></a>3）配置发件人</h3><p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032608.png" alt="image-20220926002703777"></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032609.png" alt="image-20220926003456347"></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032610.png" alt="image-20220926003626085"></p>
<h1 id="十、换个角度看监控-zabbiz-agent"><a href="#十、换个角度看监控-zabbiz-agent" class="headerlink" title="十、换个角度看监控-zabbiz-agent"></a>十、换个角度看监控-zabbiz-agent</h1><h2 id="10-1-Zabbix客户端概述"><a href="#10-1-Zabbix客户端概述" class="headerlink" title="10.1 Zabbix客户端概述"></a>10.1 Zabbix客户端概述</h2><table>
<thead>
<tr>
<th>zabbix客户端</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>Zabbix-agent2(最常用)</td>
<td>适用于几乎所有情况，支持自定义监控，linux,windows,android&#x2F;ios</td>
</tr>
<tr>
<td>SNMP客户端</td>
<td>Simple Network Management Protocal  <strong>简单网络管理协议</strong>  监控网络设备</td>
</tr>
<tr>
<td>JMX</td>
<td>Java-gateway 监控java app(tomcat),<strong>未来推荐自定义监控(zabbix_agents2 + jmap&#x2F;jstats)</strong></td>
</tr>
<tr>
<td>IPMI</td>
<td>监控硬件(物理服务器,联想(IBM X86架构ThinkServer),华为,浪潮,Dell,IBM,HP)<strong>直接使用自定义监控(ipmitool + megacli)</strong></td>
</tr>
</tbody></table>
<h2 id="10-2-Zabbix-agent2-监控-windows"><a href="#10-2-Zabbix-agent2-监控-windows" class="headerlink" title="10.2 Zabbix_agent2 监控 windows"></a>10.2 Zabbix_agent2 监控 windows</h2><h2 id="10-3-snmp监控网络设备"><a href="#10-3-snmp监控网络设备" class="headerlink" title="10.3 snmp监控网络设备"></a>10.3 snmp监控网络设备</h2><ul>
<li>应用：<ul>
<li><strong>监控网络设备（常用）</strong></li>
<li>也支持监控可以启动SNMP功能的设备（windows,linux,打印机……）</li>
</ul>
</li>
</ul>
<h3 id="1）监控网络设备"><a href="#1）监控网络设备" class="headerlink" title="1）监控网络设备"></a>1）监控网络设备</h3><p>:one:启动 设备的SNMP功能（网络设备）</p>
<p>:two:zabbix服务端进行测试 能否获取到 网络设备的信息</p>
<p>:three:web添加主机，监控项……</p>
<h4 id="a-启动snmp"><a href="#a-启动snmp" class="headerlink" title="a.启动snmp"></a>a.启动snmp</h4><table>
<thead>
<tr>
<th>snmp版本</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>v3</td>
<td>通过用户名和密码 访问 snmp信息</td>
</tr>
<tr>
<td>v2c</td>
<td>通过 团体名id 访问设备 访问 snmp信息</td>
</tr>
<tr>
<td>V1</td>
<td></td>
</tr>
</tbody></table>
<p>zabbix-server检查 网络设备状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">yum install -y net-snmp-utils</span><br><span class="line"></span><br><span class="line">COMIMUNITY</span><br><span class="line"></span><br><span class="line">[rootgm03 ~]<span class="comment"># snmpwalk -c oldboykx -v 2c 192.168.13.1 SysDesc</span></span><br><span class="line">SNMPv2-MIB::sysDescr.0 = STRING: H3C Product Version ERHMG2-MNW100-R1117</span><br><span class="line">H3C ERHMG2</span><br><span class="line">Copyright(c) 2014-2018 New H3C Technologies Co., Ltd. All rights reserved.</span><br><span class="line">[root@m03 ~]<span class="comment"># snmpwalk -c oldboykx -v 2c 192.168.13.1 sysdesc</span></span><br><span class="line">SNMPv2-MIB::sysDescr.0 = STRING: H3C Product Version ERHMG2-MNW100-R1117</span><br><span class="line">H3C ERHMG2</span><br><span class="line">Copyright(c) 2014-2018 New H3C Technologies Co., Ltd. All rights reserved.</span><br><span class="line"></span><br><span class="line">snmpwalk 命令 使用get方式访问网络设备</span><br><span class="line">-c 团体名称  <span class="comment">#v2c版本使用 团体名称</span></span><br><span class="line">-v 指定snmp版本  <span class="comment">#v2c v3</span></span><br><span class="line">ip地址</span><br><span class="line">指令（获取网络设备的信息）  名称方式/oid</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#oid Object ID 事务id 给世间万物设置独一无二的id号</span></span><br><span class="line">[root@m03 /tmp]<span class="comment"># snmpwalk -c oldboykx -v 2c 192.168.13.1 sysdesc</span></span><br><span class="line">[root@m03 /tmp]<span class="comment"># snmpwalk -c oldboykx -v 2c 192.168.13.1 sysUptime</span></span><br><span class="line">DISMAN-EVENT-MIB::sysUpTimeInstance = Timeticks: (48733900) 4 days, 17:08:59.00</span><br><span class="line">[root@m03/tmp]<span class="comment">#</span></span><br><span class="line">[root@m03/tmp]<span class="comment">#</span></span><br><span class="line">[root@m03 /tmp]<span class="comment"># snmpwalk -c oldboykx -v 2c 192.168.13.1 IfNumber</span></span><br><span class="line">IF-MIB::ifNumber.0 = INTEGER:19</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h4 id="4-6-zabbix客户端常见类型"><a href="#4-6-zabbix客户端常见类型" class="headerlink" title="4.6 zabbix客户端常见类型"></a>4.6 zabbix客户端常见类型</h4><table>
<thead>
<tr>
<th>zabbix客户端</th>
<th>特点概述</th>
<th>主要应用场景</th>
</tr>
</thead>
<tbody><tr>
<td>Zabbix-agent2(最常用)</td>
<td>通用的客户端，支持自定义监控配合命令与脚本</td>
<td>用于几乎所有情况，linux,windows,android&#x2F;ios,</td>
</tr>
<tr>
<td>SNMP客户端</td>
<td>Simple Network Management Protocal  <strong>简单网络管理协议</strong></td>
<td><strong>监控网络设备</strong>（可以监控linux&#x2F;windows…..)</td>
</tr>
<tr>
<td>JMX</td>
<td>Java-gateway 监控java app(tomcat),<strong>未来推荐自定义监控(zabbix_agents2 + jmap&#x2F;jstats)</strong></td>
<td>监控java app(tomcat)<br/>推荐<strong>自定义监控</strong></td>
</tr>
<tr>
<td>IPMI</td>
<td>监控硬件(物理服务器,联想(IBM X86架构ThinkServer),华为,浪潮,Dell,IBM,HP)<strong>直接使用自定义监控(ipmitool + megacli)</strong></td>
<td>监控硬件<br/>应用推荐：直接使用自定义监控(ipmitool + megacli )</td>
</tr>
</tbody></table>
<h3 id="5-自动化"><a href="#5-自动化" class="headerlink" title="5.自动化"></a>5.自动化</h3><p>自动添加主机</p>
<p>公司拥有多个机房（北京，上海，南极）</p>
<h4 id="5-1-自动添加主机"><a href="#5-1-自动添加主机" class="headerlink" title="5.1 自动添加主机"></a>5.1 自动添加主机</h4><p>自动发现</p>
<p>自动注册</p>
<table>
<thead>
<tr>
<th>自动添加策略</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>自动发现</td>
<td><strong>服务端主动扫描</strong>局域网所有的机器，有新的则添加</td>
<td>配置简单方便效率不高</td>
</tr>
<tr>
<td>自动注册</td>
<td><strong>客户端主动</strong>向服务端注册，服务端只需要等待与验证即可</td>
<td>配置有点点复杂，效率高</td>
</tr>
</tbody></table>
<h3 id="12-2-自动发现"><a href="#12-2-自动发现" class="headerlink" title="12.2 自动发现"></a>12.2 自动发现</h3><p>1）环境准备</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>db01</td>
<td>10.0.0.51&#x2F;172.16.1.51</td>
<td>zabbix客户端,server指向.72</td>
</tr>
<tr>
<td>nfs01</td>
<td>10.0.0.31&#x2F;172.16.1.31</td>
<td>zabbix客户端,server指向.72</td>
</tr>
<tr>
<td>backup</td>
<td>10.0.0.41&#x2F;172.16.1.41</td>
<td>zabbix客户端,server指向.72</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#01.3台机器部署好zabbixx客户端</span></span><br><span class="line"><span class="comment">#02.修改Server为172.16.1.72</span></span><br><span class="line"><span class="comment">#03.启动并开机自启动</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="2）部署流程"><a href="#2）部署流程" class="headerlink" title="2）部署流程"></a>2）部署流程</h4><p>:one:配置自动发现<strong>规则-发现主机</strong></p>
<p>:two:启动自动发现<strong>动作</strong>-发现主机后关联模板，添加主机，加入主机组，启用</p>
<p>配置<strong>自动发现规则</strong></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032611.png" alt="image-20220926105236965"></p>
<h3 id="12-3-自动注册"><a href="#12-3-自动注册" class="headerlink" title="12.3 自动注册"></a>12.3 自动注册</h3><h4 id="1）环境准备"><a href="#1）环境准备" class="headerlink" title="1）环境准备"></a>1）环境准备</h4><p>关闭自动发现 <strong>规则</strong></p>
<p>关闭 自动发现 动作</p>
<p>自动发现的主机 删除</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>db01</td>
<td>10.0.0.51&#x2F;172.16.1.51</td>
<td>zabbix客户端,server指向.72</td>
</tr>
<tr>
<td>nfs01</td>
<td>10.0.0.31&#x2F;172.16.1.31</td>
<td>zabbix客户端,server指向.72</td>
</tr>
<tr>
<td>backup</td>
<td>10.0.0.41&#x2F;172.16.1.41</td>
<td>zabbix客户端,server指向.72</td>
</tr>
</tbody></table>
<h4 id="2）部署流程-1"><a href="#2）部署流程-1" class="headerlink" title="2）部署流程"></a>2）部署流程</h4><p>:one:修改zabbix<strong>客户端配置文件</strong>: ServerActive&#x3D;服务端ip 和Hostname&#x3D;……</p>
<p>:two:web页面，<strong>动作</strong>–&gt;自动注册 autoreg……</p>
<h5 id="a-修改客户端配置文件"><a href="#a-修改客户端配置文件" class="headerlink" title="a.修改客户端配置文件"></a>a.修改客户端配置文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">自动注册：</span></span><br><span class="line">配置zabbix-agent</span><br><span class="line">Server=172.16.1.72</span><br><span class="line">ServerActive=172.16.1.72    #主动模式 服务端ip地址</span><br><span class="line">Hostname=web01    #主机名，独一无二</span><br><span class="line">HostMetadata=web01    #主机名的元数据（属性）  主机名  使用HostMetadataItem=system.hostname</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Hostname自动获取</span></span><br><span class="line"></span><br><span class="line">HostnameItem=system.hostname    #自动获取主机名 这个 与Hostname 二选一</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">HostMetadata自动获取</span></span><br><span class="line">HostMetadataItem=system.hostname    #自动获取主机的元数据(主机名)  这个与HostMeatadata 二选一</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">完整的 客户端配置文件</span></span><br><span class="line">[root@db01 ~]# grep &#x27;^[a-Z]&#x27; /etc/zabbix/zabbix_agent2.conf</span><br><span class="line">PidFile=/var/run/zabbix/zabbix_agent2.pid</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@db01 ~]# grep &#x27;^Server|^Host&#x27; /etc/zabbix/zabbix_agent2.conf</span><br><span class="line">Server=172.16.1.71</span><br><span class="line">ServerActive=172.16.1.71 </span><br><span class="line">HostnameItem=system.hostname</span><br><span class="line">HostMetadataItem=system.uname</span><br><span class="line">[root@db01 ~]# systemctl restart zabbix-agent</span><br></pre></td></tr></table></figure>

<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032612.png" alt="image-20220926112343507"></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032613.png" alt="image-20220926112451330"></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032614.png" alt="image-20220926112520661"></p>
<h3 id="15-1-目标：监控整个网站架构-全流程）"><a href="#15-1-目标：监控整个网站架构-全流程）" class="headerlink" title="15.1 目标：监控整个网站架构(全流程）"></a>15.1 目标：监控整个网站架构(全流程）</h3><ul>
<li><p><strong>单台机器</strong></p>
<ul>
<li>业务(应用&#x2F;api)信息：应用，程序代码是否有问题，（需要我们与开发沟通，书写一个页面） eg：lnmp的时候的php与mysql测试页面.</li>
<li>服务信息：各种服务状态，进程，端口，状态，特定的信息（不同服务）</li>
<li>系统信息：cpu,内存(内存,swap,buffer&#x2F;cache),磁盘(io,使用率,inode),负载,网络(in&#x2F;out)……</li>
<li>硬件信息：磁盘，raid状态，温度，风扇转速，机房温度，湿度</li>
</ul>
</li>
<li><p><strong>网站集群监控（用户访问流程）</strong></p>
<ul>
<li>DNS解析域CDN是否ok  本质：<strong>通过全局访问测试工具（模仿用户在全国（全球）各地访问我们的网站）</strong><ul>
<li>免费:<a target="_blank" rel="noopener" href="http://17ce.com/">http://17ce.com</a> <a target="_blank" rel="noopener" href="http://ping.chinaz.com/">http://ping.chinaz.com/</a>        调试工具：<a target="_blank" rel="noopener" href="http://cesule.tingyun.com/cesule/home">http://cesule.tingyun.com/cesule/home</a></li>
<li>商业版：<a target="_blank" rel="noopener" href="https://www.tingyun.com/">听云</a>，<a target="_blank" rel="noopener" href="https://www.jiankongbao.com/">监控宝</a>（告警）</li>
</ul>
</li>
<li>TCP三次握手-网站负载均衡监控 ss-ant（tcp状态）</li>
<li>HITP请求豹纹-监控web日志查看（状态码）补充：加上HTTPS监控过期</li>
<li>请求经过网站架构<ul>
<li>负载均衡（Nginx）</li>
<li>web服务器(php,tomcat)</li>
<li>缓存</li>
<li>数据库</li>
<li>存储</li>
</ul>
</li>
<li>HTTP响应报文-监控web日志查看（状态码）</li>
<li>TCP四次挥手-网站负载均衡监控 ss-ant</li>
<li>断开连接</li>
</ul>
</li>
</ul>
<h2 id="6-架构监控"><a href="#6-架构监控" class="headerlink" title="6 架构监控"></a>6 架构监控</h2><h3 id="6-1-基础项目"><a href="#6-1-基础项目" class="headerlink" title="6.1 基础项目"></a>6.1 基础项目</h3><h3 id="6-2-负载"><a href="#6-2-负载" class="headerlink" title="6.2 负载"></a>6.2 负载</h3><p>nginx</p>
<p>tcp: <code>ss  -ant |grep -i &#39;estab&#39; |awk &#39;$3~/:80$/&#39;</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">[root@lb01~]# </span><span class="language-bash"><span class="built_in">cat</span> /etc/nginx/conf.d/default.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen     80 default_server;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    location / &#123;</span><br><span class="line">      index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">    location /nginx_status &#123;</span><br><span class="line">      stub_status;</span><br><span class="line">      #allow</span><br><span class="line">      #deny</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@lb01 ~]# curl 10.9.0.5/nginx_status</span><br><span class="line">Active connections: 1</span><br><span class="line">server accepts handled requests</span><br><span class="line"> 2 2 2</span><br><span class="line">Reading: 0 Writing: 1 Waiting: 0</span><br><span class="line">[root@lb01 ~]#</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">自定义监控</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">zbx 模板</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="4）证书是否过期"><a href="#4）证书是否过期" class="headerlink" title="4）证书是否过期"></a>4）证书是否过期</h3><p>通过openssl命令获取某一个证书的过期时间</p>
<p>与当前时间计算得出剩余时间</p>
<p>添加监控项</p>
<p>添加触发器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01/etc/nginx/ssl_key]<span class="comment"># cat /server/scripts/check_ssl_crt.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#author: lidao996</span></span><br><span class="line"><span class="comment">#desc: check one ssl crt expire time</span></span><br><span class="line"><span class="comment">#desc：检查 https证书还有多少天过期</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#获取过期时间</span></span><br><span class="line">last_day=`openssl x509 -<span class="keyword">in</span> /etc/nginx/ssl_key/server.crt -noout -text |awk <span class="string">&#x27;/After/&#123;gsub(/Jun/,&quot;06&quot;);print $7&quot;-&quot;$4&quot;-&quot;$5&#125;&#x27;</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取秒</span></span><br><span class="line">last_day_sec=`<span class="built_in">date</span> +%s -d <span class="string">&quot;<span class="variable">$last_day</span> &quot;</span>`</span><br><span class="line">today_sec=`<span class="built_in">date</span> +%s`</span><br><span class="line"></span><br><span class="line"><span class="comment">#进行计算</span></span><br><span class="line">awk -vlast=<span class="variable">$last_day_sec</span> -vnow=<span class="variable">$today_sec</span> <span class="string">&#x27;BEGIN&#123;print ( last - now )/60/60/24)&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="5）端口进程"><a href="#5）端口进程" class="headerlink" title="5）端口进程"></a>5）端口进程</h3><p>找出系统内置的键值使用</p>
<p>添加监控项</p>
<p>添加触发器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@m02 /server/files]<span class="comment"># zabbix_get -s 172.16.1.5 -k net.tcp.port[,80]</span></span><br><span class="line">1</span><br><span class="line">[root@m02 /server/files]<span class="comment"># zabbix_get -s 172.16.1.5 -k proc.num[nginx]</span></span><br><span class="line">2</span><br><span class="line"></span><br><span class="line">[root@m03 ~]<span class="comment"># zabbix_get -s lb01 -k net.tcp.port[,80]</span></span><br><span class="line">1</span><br><span class="line">[root@m03 ~]<span class="comment"># zabbix_get -s lb01 -k proc.num[]</span></span><br><span class="line">115</span><br><span class="line">[root@m03 ~]<span class="comment"># zabbix_get -s lb01 -k proc.num[nginx]</span></span><br><span class="line">2</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="6）把创建好的监控项复制到模板中"><a href="#6）把创建好的监控项复制到模板中" class="headerlink" title="6）把创建好的监控项复制到模板中"></a>6）把创建好的监控项复制到模板中</h3><p>nginx模板-日志状态，证书是否过期，端口与进程</p>
<p>tcp模板-连接状态</p>
<h2 id="14-6-web服务器"><a href="#14-6-web服务器" class="headerlink" title="14.6 web服务器"></a>14.6 web服务器</h2><p>nginx  nginx_status  端口进程</p>
<p>php  php status</p>
<p>可用性监控（web监控（场景））</p>
<h3 id="1）监控php状态"><a href="#1）监控php状态" class="headerlink" title="1）监控php状态"></a>1）监控php状态</h3><p>开启 php状态检查</p>
<p>创建自定义监控项-脚本方式</p>
<p>创建自定义监控项-主要项-相关项</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 /etc/nginx/conf.d]# cat default.conf</span><br><span class="line">server &#123;</span><br><span class="line">  listen 80 default_server;</span><br><span class="line">  server_name localhost;</span><br><span class="line">  root /code/default;</span><br><span class="line">  location /nginx_status &#123;</span><br><span class="line">    allow 127.0.0.1;</span><br><span class="line">    allow localhost;</span><br><span class="line">    deny all;</span><br><span class="line">    stub_status ;</span><br><span class="line">  &#125;</span><br><span class="line">  location /php_status &#123;</span><br><span class="line">    allow 127.0.0.1;</span><br><span class="line">    allow localhost;</span><br><span class="line">    deny all;</span><br><span class="line">    fastcgi_pass  127.0.0.1:9000;</span><br><span class="line">    fastcgi_index  index.php;</span><br><span class="line">    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br><span class="line">    include    fastcgi_params;</span><br><span class="line">  &#125;</span><br><span class="line">  location ~ \.php$ &#123;</span><br><span class="line">    fastcgi_pass  127.0.0.1:9000;</span><br><span class="line">    fastcgi_index index.php;</span><br><span class="line">    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br><span class="line">    include    fastcgi_params;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@web01 /etc/nginx/conf.d]# vim /etc/php-fpm.d/www.conf</span><br><span class="line">pm.status_path = /php_status</span><br><span class="line">[root@web01 /etc/nginx/conf.d]# grep pm.status_path /etc/php-fpm.d/www.conf</span><br><span class="line">pm.status_path = /php_status</span><br><span class="line"></span><br><span class="line">[root@web01 /etc/nginx/conf.d]# nginx -t</span><br><span class="line">[root@web01 /etc/nginx/conf.d]# php-fpm -t</span><br><span class="line"></span><br><span class="line">[root@web01 /etc/nginx/conf.d]# systemctl reload nginx php-fpm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@web01 /etc/nginx/conf.d]# curl 10.0.0.7/nginx_status</span><br><span class="line">[root@web01 /etc/nginx/conf.d]# curl 10.0.0.7/php_status</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@web01 /server/scripts]# sh fpm.sh &quot;total processes&quot; &quot;localhost/php_status&quot;</span><br><span class="line">5</span><br><span class="line">[root@web01 ~]# cat /etc/zabbix/zabbix_agent2.d/web.conf</span><br><span class="line">UserParameter=php.fpm[*],sh /server/scripts/fpm.sh &quot;$1&quot; &quot;$2&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">[root@m02~]#</span><span class="language-bash">zabbix_get -s 172.16.1.7 -k php.fpm[<span class="string">&quot;total processes&quot;</span>,<span class="string">&quot;localhost/php_status&quot;</span>]</span></span><br><span class="line">5</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032615.png" alt="image-20220926152613349"></p>
<p>创建 主要键</p>
<h2 id="14-8-mysql"><a href="#14-8-mysql" class="headerlink" title="14.8 mysql"></a>14.8 mysql</h2><p>percona-mysql……</p>
<p>zabbix内置模板：Template DB MySQL by Zabbix agent 2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">php脚本获取数据库指标</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">xml模板文件</span></span><br><span class="line"></span><br><span class="line">[root@db01 ~]# rpm -ql percona-zabbix-templates</span><br><span class="line">/var/lib/zabbix/percona</span><br><span class="line">/var/lib/zabbix/percona/scripts</span><br><span class="line">/var/lib/zabbix/percona/scripts/get_mysql_stats_wrapper.sh</span><br><span class="line">/var/lib/zabbix/percona/scripts/ss_get_mysql_stats.php</span><br><span class="line">/var/lib/zabbix/percona/templates</span><br><span class="line">/var/lib/zabbix/percona/templates/userparameter_percona_mysql.conf</span><br><span class="line">/var/lib/zabbix/percona/templates/zabbix_agent_template_percona_mysql_server_ht_2.0.9-sver1.1.8.xml</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">zabbix_get -s db01 -k get.mysql.status</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">---执行 sh get_mysql...sh</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">---执行 php ss_get_mysql...php</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">生产环境 需要一个对数据库有只读权限的用户即可。  select,show</span></span><br><span class="line">grant select,show on *.* to zabbix@&#x27;localhost&#x27; identified by &#x27;123456&#x27;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@db01 ~]# vim /var/lib/zabbix/percona/scripts/ss_get_mysql_stats.php</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">mysql_user = <span class="string">&#x27;lidao996&#x27;</span>;</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">mysql_pass = <span class="string">&#x27;1&#x27;</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@db01 ~]# egrep &#x27;^\$mysql_(user|pass)&#x27; /var/lib/zabbix/percona/scripts/ss_get_mysql_stats.php</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">mysql_user = <span class="string">&#x27;root&#x27;</span>;</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">mysql_pass = <span class="string">&#x27;123456&#x27;</span>;</span></span><br><span class="line"></span><br><span class="line">[root@db01 ~]# cp /var/lib/zabbix/percona/templates/userparameter_percona_mysql.conf /etc/zabbix/zabbix_agent2.d/</span><br><span class="line"></span><br><span class="line">[root@db01 ~]# yum install -y php php-mysqlnd</span><br><span class="line"></span><br><span class="line">[root@db01 ~]# systemctl restart zabbix-agent2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@m02 ~]# zabbix_get -s 172.16.1.51 -k MySQL.State-login</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">sh /var/lib/zabbix/percona/scripts/get_mysql_stats_wrapper.sh lw</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>1.概述</p>
<ul>
<li>综合架构的目标：<ul>
<li>搭建并熟练描述网站架构（面试题：你公司架构是什么样？）基础架构：动静分离，前后端分离</li>
</ul>
</li>
<li>过程<ul>
<li>痛苦的，快乐着，搭建的时候，分层次搭建出来</li>
</ul>
</li>
<li>痛苦的，快乐着，搭建的时候，分层次搭建出来<ul>
<li>讲排<ul>
<li>讲解，熟练讲解网站架构流程：用户访问与ngx处理流程</li>
<li>排错，记录总结</li>
<li>搭建</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>2.分层次架构</p>
<ul>
<li><p>绘制自己的架构图（纸笔,processon)</p>
</li>
<li><p>分层次</p>
<ul>
<li>用户：<ul>
<li>数据层：:one:备份  :two:存储  :three:实时同步  :four:数据库  :five:redis缓存​</li>
<li>web层：:one:web01 nginx,php,conf  :two:部署代码  代码配置传输web02  :three:nginx+tomcat  配置，部署代码  代码与配置文件传输到web04​</li>
<li>负载：:one:nginx  :two:keepalived</li>
<li>安全：防火墙…</li>
</ul>
</li>
<li>运维<ul>
<li>:one:openvpn</li>
<li>:two:jms&#x2F;teleport</li>
<li>:three:ansible批量管理（提前准备好）</li>
<li>:four:zbx监控</li>
</ul>
</li>
</ul>
</li>
<li><p>一键部署流程推荐</p>
<ul>
<li>一步一步部署每个服务（安装过程，配置文件，相关内容目录，用户，数据库.…）</li>
<li>思考每个服务如何一键部署（安装（yum仓库），配置（分发配置文件），启动，代码部署（如果需要））（独立模块&#x2F;服务）</li>
<li>最后联合在一起一键部署所有（联调）</li>
</ul>
</li>
</ul>
<h1 id="12-6-zabbix分布式监控proxy"><a href="#12-6-zabbix分布式监控proxy" class="headerlink" title="12.6 zabbix分布式监控proxy"></a>12.6 zabbix分布式监控proxy</h1><p>应用场景：有多个机房&#x2F;网段&#x2F;地域，进行监控.分布式监控(proxy代理监控)</p>
<h1 id="15-部署前端页面提示连接数据库失败"><a href="#15-部署前端页面提示连接数据库失败" class="headerlink" title="15.部署前端页面提示连接数据库失败"></a>15.部署前端页面提示连接数据库失败</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Unsupported charset or collation <span class="keyword">for</span> tables  <span class="comment">#创建数据库的时候字符集不对。</span></span><br></pre></td></tr></table></figure>





<h1 id="zbx-故障记录"><a href="#zbx-故障记录" class="headerlink" title="zbx-故障记录"></a>zbx-故障记录</h1><h2 id="Unknown-metric-root-login"><a href="#Unknown-metric-root-login" class="headerlink" title="Unknown metric root.login"></a>Unknown metric root.login</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">无法识别的监控项/键值  root.login</span><br></pre></td></tr></table></figure>



<h2 id="No-module-named-requests"><a href="#No-module-named-requests" class="headerlink" title="No module named requests"></a>No module named requests</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@m03-zabbix-server ~]<span class="comment"># python /usr/lib/zabbix/alertscripts/wechat.py</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/usr/lib/zabbix/alertscripts/wechat.py&quot;</span>, line 7, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    import requests</span><br><span class="line">ImportError: No module named requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#python是通过各种模块实现目标与需求.</span></span><br><span class="line"></span><br><span class="line">requests  <span class="comment">#实现客户---&gt;服务端发出  http请求  curl/wget</span></span><br><span class="line"></span><br><span class="line">yum/apt</span><br><span class="line"><span class="comment">#安装python模块</span></span><br><span class="line">yum install -y python-pip</span><br><span class="line">pip install requests -i https://mirrors.aliyun.com/pypi/simple/</span><br><span class="line"></span><br></pre></td></tr></table></figure>







<h1 id="7-分布式监控-proxy"><a href="#7-分布式监控-proxy" class="headerlink" title="7.分布式监控-proxy"></a>7.分布式监控-proxy</h1><ul>
<li>使用流程<ul>
<li>配置zabbix服务端和客户端</li>
<li>部署zbx_proxy代理</li>
<li>创建数据库，zbx proxy</li>
<li>zbx客户端配置</li>
</ul>
</li>
</ul>
<p>web01 zbx-proxy代理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#01 安装zbx proxy</span></span><br><span class="line">yum install -y https://mirrors.tuna.tsinghua.edu.cn/zabbix/zabbix/5.0/rhel/7/x86_64/zabbix-proxy-mysql-5.0.18-1.el7.x86_64.rpm</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建对应的数据库，初始化数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##启动数据库并创建数据库 zabbix_proxy</span></span><br><span class="line">systemctl start mariadb</span><br><span class="line">systemctl <span class="built_in">enable</span> mariadb</span><br><span class="line">mysql -uroot -py</span><br><span class="line">&gt; create database zabbix_proxy charset utf8;</span><br><span class="line">&gt; select user,host from mysql.user</span><br><span class="line">MariaDB [(none)]&gt; grant all on zabbix_proxy.* to zabbix_proxy@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">##初始化数据库</span></span><br><span class="line">rpm -ql zabbix-proxy-mysql</span><br><span class="line">zcat /usr/share/doc/zabbix-proxy-mysql-5.0.18/schema.sql.gz |mysql -uroot -py zabbix_proxy</span><br><span class="line"></span><br><span class="line"><span class="comment">##检查</span></span><br><span class="line">show tables from zabbix_proxy;</span><br></pre></td></tr></table></figure>

<p>配置zbx proxy与zbx服务端</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##zbx proxy代理|</span></span><br><span class="line">- hosts: zabbix_proxy web01</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@web01 ~]<span class="comment"># egrep -n &#x27;^Server|^Host|^DB&#x27; /etc/zabbix/zabbix_proxy.conf</span></span><br><span class="line">30:Server=172.16.1.71</span><br><span class="line">49:Hostname=njproxy</span><br><span class="line">162:DBHost=localhost</span><br><span class="line">173:DBName=zabbix_proxy</span><br><span class="line">188:DBUser=zabbix_proxy</span><br><span class="line">196:DBPassword=1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> zabbix-proxy.service</span><br><span class="line">systemctl start zabbix-proxy.service</span><br><span class="line">ss -lntup |grep zabbix</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##zbx server</span></span><br><span class="line">- hosts:zabbix-server服务端</span><br><span class="line"><span class="comment">##命令行配置文件  检查  是否有收集proxy数据的进程</span></span><br><span class="line"></span><br><span class="line">vim /etc/zabbix/zabbix_server.conf</span><br><span class="line">StartProxyPollers=5</span><br><span class="line"></span><br><span class="line">grep ProxyPollers /etc/zabbix/zabbix_server.conf  <span class="comment">#非0即可</span></span><br><span class="line">StartProxyPollers=5</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>zbx服务端   web页面添加代理</p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032616.png" alt="image-20220926171904219"></p>
<p>客户端配置与web页面修改</p>
<p>​	配置文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@nfs01 ~]<span class="comment"># sed -i &#x27;s#172.16.1.71#172.16.1.7#g&#x27; /etc/zabbix/zabbix_agent2.conf</span></span><br><span class="line">[root@nfs01 ~]<span class="comment"># systemctl restart zabbix-agent2</span></span><br><span class="line">[root@nfs01 ~]<span class="comment"># grep ^Server /etc/zabbix/zabbix_agent2.conf</span></span><br><span class="line">Server=172.16.1.7</span><br><span class="line">ServerActive=172.16.1.7</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​	web页面</p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032617.png" alt="image-20220926172628679"></p>
<h2 id="7-3-小结"><a href="#7-3-小结" class="headerlink" title="7.3 小结"></a>7.3 小结</h2><p>应用场景：多个机房监控</p>
<p>使用流程：配置代理，添加，启动代理</p>
<p>故障：不绿，重启</p>
<h1 id="8-Grafana增强展示"><a href="#8-Grafana增强展示" class="headerlink" title="8.Grafana增强展示"></a>8.Grafana增强展示</h1><p>zabbix-server部署grafana</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget --no-check-certificate -P /server/tools https://mirrors.tuna.tsinghua.edu.cn/grafana/yum/rpm/grafana-7.3.5-1.x86_64.rpm</span><br><span class="line">yum localinstall -y /server/tools/grafana-7.3.5-1.x86_64.rpm</span><br><span class="line">systemctl start grafana-server</span><br><span class="line">systemctl <span class="built_in">enable</span> grafana-server</span><br><span class="line">ss -lntup|grep grafana</span><br></pre></td></tr></table></figure>

<p>浏览器访问zbx.oldboylinux.cn:3000，用户 admin，密码 admin</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">grafana-cli plugins list-remote |grep zabbix</span><br><span class="line"></span><br><span class="line">grafana-cli plugins install alexanderzobnin-zabbix-app</span><br><span class="line"></span><br><span class="line"><span class="built_in">du</span> -sh /var/lib/grafana/plugins/alexanderzobnin-zabbix-app/</span><br><span class="line"></span><br><span class="line">tar xf grafana-zabbix-plugin.tar.gz -C /</span><br><span class="line"></span><br><span class="line">systemctl restart grafana-server</span><br></pre></td></tr></table></figure>



<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032618.png" alt="image-20220926174151679"></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032619.png" alt="image-20221001152212470"></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210281032620.png" alt="image-20221001152632476"></p>
<h1 id="12"><a href="#12" class="headerlink" title="12"></a>12</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#01.安装zabbix-proxy</span></span><br><span class="line"><span class="comment">#rpm -ivh https://mirrors.tuna.tsinghua.edu.cn/zabbix/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-1.el7.noarch.rpm</span></span><br><span class="line"><span class="comment">#yum install zabbix-proxy-mysql -y</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#01.直接安装zabbix proxy</span></span><br><span class="line">yum install -y https://mirror.tuna.tsinghua.edu.cn/zabbix/zabbix/5.0/rhel/7/x86_64/zabbix-proxy-mysql-5.0.13-1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#02.安装数据库</span></span><br><span class="line">yum install mariadb-server -y</span><br><span class="line">systemctl start mariadb</span><br><span class="line">systemctl <span class="built_in">enable</span> mariadb</span><br><span class="line">mysql_secure_installation    <span class="comment">#自动删除空用户适用于安装数据库后马上使用</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; create database zabbix_proxy character <span class="built_in">set</span> utf8 collate utf8_bin;</span><br><span class="line">mysql&gt; grant all privileges on zabbix_proxy.* to zabbix_proxy@localhost identified by <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#手动删除空用户，事后补救</span></span><br><span class="line">drop user <span class="string">&#x27;&#x27;</span>@localhost;</span><br><span class="line">drop user <span class="string">&#x27;&#x27;</span>@web01;</span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#03.导入zabbixx proxy表结构（数据）</span></span><br><span class="line">zcat /usr/share/doc/zabbix-proxy-mysql*/schema.sql.gz | mysql -uzabbix -p123456 zabbix_</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#04.配置zabbix-proxy</span></span><br><span class="line">[root@web01~]<span class="comment"># grep &#x27;^[a-Z]&#x27; /etc/zabbix/zabbix_proxy.conf</span></span><br><span class="line">Server=172.16.1.72</span><br><span class="line">Hostname=nanji_server</span><br><span class="line">LogFile=/var/log/zabbix/zabbix_proxy.log</span><br><span class="line">LogFileSize=0</span><br><span class="line">PidFile=/var/run/zabbix/zabbix_proxy.pid</span><br><span class="line">SocketDir=/var/run/zabbix</span><br><span class="line">DBHost=localhost</span><br><span class="line">DBName=zabbix_proxy</span><br><span class="line">DBUser=zabbix_proxy</span><br><span class="line">DBPassword=123456</span><br><span class="line">SNMPTrapperFile=/var/log/snmptrap/snmptrap.log</span><br><span class="line">Timeout=4</span><br><span class="line">ExternalScripts=/usr/lib/zabbix/externalscripts</span><br><span class="line">LogSlawQueries=3000</span><br><span class="line">StatsAllowedIP=127.0.0.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl start zabbix-proxy.service</span><br><span class="line">systemctl <span class="built_in">enable</span> zabbix-proxy.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#服务端日志报错</span></span><br><span class="line">32598:20218720:123124.836 cannot parse proxy data from active proxy at <span class="string">&quot;172.16.1.7&quot;</span>: proxy <span class="string">&quot;nanj1_proxy&quot;</span> not found</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#zabbix proxy日志报错</span></span><br><span class="line">12136:20210625:175428.425 cannot send proxy data to server at <span class="string">&quot;172.16.1.71&quot;</span>: proxy <span class="string">&quot;nanj1_server&quot;</span> not found</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#服务端 zabbix server日志</span></span><br><span class="line">32596:20210720:123641.116 cannot parse proxy data from active proxy at <span class="string">&quot;172.16.1.7&quot;</span>: proxy <span class="string">&quot;nanji_proxy&quot;</span> not found</span><br><span class="line"></span><br><span class="line">32598:20210720:123657.163 sending configuration data to proxy <span class="string">&quot;nanji_proxy&quot;</span> at <span class="string">&quot;172.16.1.7&quot;</span>, datalen 3662</span><br><span class="line"></span><br><span class="line"><span class="comment">#代理服务  zabbix proxy 日志</span></span><br><span class="line">12536:20210720:123657.160 received configuration data from server at <span class="string">&quot;172.16.1.72&quot;</span>, datalen 3662</span><br></pre></td></tr></table></figure>

<p>修改客户端配置文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#zabbix 客户端配置</span></span><br><span class="line">[root@db01 ~]<span class="comment"># vim /etc/zabbix/zabbix_agent2.conf</span></span><br><span class="line">[root@dbe1 ~]<span class="comment"># systemctl restart zabbix-agent2</span></span><br><span class="line">[root@db01 ~]<span class="comment">#grep Server /etc/zabbix/zabbix_agent2.conf</span></span><br><span class="line">Server=172.16.1.7</span><br><span class="line">ServerActive=172.16.1.7</span><br><span class="line">[root@db01 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://mo-li001.github.io">壹拾陆</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://mo-li001.github.io/posts/43f6321c.html">https://mo-li001.github.io/posts/43f6321c.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mo-li001.github.io" target="_blank">壹拾陆</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/bea64271.html"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">VIM</div></div></a></div><div class="next-post pull-right"><a href="/posts/1315a465.html"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">rpm 打包</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/9f353bc9.html" title="Devops"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Devops</div></div></a></div><div><a href="/posts/f5f9fa9b.html" title="Docker"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Docker</div></div></a></div><div><a href="/posts/34d20e28.html" title="ELK"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">ELK</div></div></a></div><div><a href="/posts/8005.html" title="ELK快速部署"><img class="cover" src="https://tuchuangs.com/imgs/2022/09/18/074f3836d4f471b8.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">ELK快速部署</div></div></a></div><div><a href="/posts/9bdc030a.html" title="HAproxy"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">HAproxy</div></div></a></div><div><a href="/posts/a71433d.html" title="Ansible"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Ansible</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202209182232723.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">壹拾陆</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">69</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mo-li001/"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">个人笔记</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Zabbix"><span class="toc-text">Zabbix</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81Linux%E7%9A%84%E9%82%A3%E4%BA%9B%E7%8B%AC%E5%AD%A4%E4%B9%9D%E5%89%91%E7%BA%A7%E5%88%AB%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-text">一、Linux的那些独孤九剑级别的命令</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%85%AC%E5%8F%B8%E7%9B%91%E6%8E%A7%E5%A6%82%E4%BD%95%E5%81%9A%E7%9A%84"><span class="toc-text">二、公司监控如何做的</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E7%9B%91%E6%8E%A7%E7%9A%84%E8%84%9A%E6%9C%AC%E6%97%B6%E4%BB%A3-%E8%BF%87%E5%8E%BB%E6%97%B6"><span class="toc-text">三、监控的脚本时代-过去时</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E7%9B%91%E6%8E%A7%E7%9A%84%E7%8E%B0%E4%BB%A3%E6%97%B6"><span class="toc-text">四、监控的现代时</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81Zabbix%E7%9B%91%E6%8E%A7%E6%9E%B6%E6%9E%84"><span class="toc-text">五、Zabbix监控架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-text">5.1 生命周期</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-Zabbix%E7%9B%91%E6%8E%A7%E6%9E%B6%E6%9E%84"><span class="toc-text">5.2 Zabbix监控架构</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81Zabbix%E7%94%9F%E4%BA%A7%E5%BF%AB%E9%80%9F%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97"><span class="toc-text">六、Zabbix生产快速实践指南</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E4%B8%BB%E6%9C%BA%E8%A7%84%E5%88%92"><span class="toc-text">6.1 主机规划</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E4%BC%81%E4%B8%9AZabbix%E5%AE%89%E8%A3%85%E6%9C%80%E4%BD%B3%E5%AE%9E%E6%88%98-CentOS7"><span class="toc-text">6.2 企业Zabbix安装最佳实战-CentOS7</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E7%9B%91%E6%8E%A7%E4%B8%80%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%BB%E6%9C%BA"><span class="toc-text">七、监控一台服务器主机</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-Zabbix-agent-vs-agent2"><span class="toc-text">7.1 Zabbix agent vs agent2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-Zabbix-Agent-2-%E7%9B%91%E6%8E%A7%E6%B5%81%E7%A8%8B"><span class="toc-text">7.2 Zabbix Agent[2]监控流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%BC%89%E8%A1%A5%E5%85%85-zabbix%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%B8%8E%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3"><span class="toc-text">1）补充:zabbix服务端与客户端配置详解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%BC%89%E7%9B%91%E6%8E%A7%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text">2）监控客户端</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-%E6%97%A5%E5%B8%B8%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE"><span class="toc-text">7.3 日常查看数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4-Zabbix%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98"><span class="toc-text">7.4 Zabbix中文乱码问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9B%91%E6%8E%A7%E9%82%A3%E7%82%B9%E4%BA%8B"><span class="toc-text">八、自定义监控那点事</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9B%91%E6%8E%A7%E6%A6%82%E8%BF%B0"><span class="toc-text">8.1 自定义监控概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9B%91%E6%8E%A7%E9%A1%B9%E6%B5%81%E7%A8%8B"><span class="toc-text">8.2 自定义监控项流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zbx-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9B%91%E6%8E%A7"><span class="toc-text">zbx-自定义监控</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%9C%80%E6%B1%82%EF%BC%9A%E6%A3%80%E6%9F%A5%E5%BD%93%E5%89%8D%E6%9C%BA%E5%99%A8%E6%98%AF%E5%90%A6root%E8%BF%9C%E7%A8%8B%E7%99%BB%E5%BD%95"><span class="toc-text">1.需求：检查当前机器是否root远程登录</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-Linux%EF%BC%9A%E5%91%BD%E4%BB%A4"><span class="toc-text">1.1 Linux：命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-Linux%EF%BC%9A%E5%88%9B%E5%BB%BA%E9%94%AE%E5%80%BC-zbx-server%E8%AF%86%E5%88%AB%EF%BC%89"><span class="toc-text">1.2 Linux：创建键值(zbx-server识别）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-Linux%EF%BC%9A%E6%B5%8B%E8%AF%95-zbx-%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-text">1.3 Linux：测试-zbx-服务端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-web%EF%BC%9A%E5%88%9B%E5%BB%BA%E7%9B%91%E6%8E%A7%E9%A1%B9"><span class="toc-text">1.4 web：创建监控项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-web%EF%BC%9A%E5%88%9B%E5%BB%BA%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-text">1.5 web：创建触发器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-web%EF%BC%9A%E5%88%9B%E5%BB%BA%E5%9B%BE%E5%BD%A2"><span class="toc-text">1.6 web：创建图形</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%9B%E5%BB%BA%E6%A8%A1%E6%9D%BF%EF%BC%9A%E6%B7%BB%E5%8A%A0%E7%9B%91%E6%8E%A7%E9%A1%B9%EF%BC%8C%E8%A7%A6%E5%8F%91%E5%99%A8%EF%BC%8C%E5%9B%BE%E5%BD%A2"><span class="toc-text">2.创建模板：添加监控项，触发器，图形</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E5%88%9B%E5%BB%BA%E6%A8%A1%E6%9D%BF"><span class="toc-text">2.1 创建模板</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-%E6%A8%A1%E6%9D%BF%E5%85%B3%E8%81%94%E4%B8%BB%E6%9C%BA"><span class="toc-text">2.2 模板关联主机</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6"><span class="toc-text">3 监控告警</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#zbx-%E5%85%A8%E7%BD%91%E5%85%A8%E9%93%BE%E8%B7%AF-x2F-%E5%85%A8%E6%B5%81%E7%A8%8B%E7%9B%91%E6%8E%A7-%E6%9E%B6%E6%9E%84"><span class="toc-text">zbx-全网全链路&#x2F;全流程监控-架构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E7%9B%91%E6%8E%A7%E6%8A%A5%E8%AD%A6"><span class="toc-text">九、监控报警</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-%E5%91%8A%E8%AD%A6%E5%88%86%E7%B1%BB"><span class="toc-text">9.1 告警分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-%E9%82%AE%E4%BB%B6%E6%8A%A5%E8%AD%A6"><span class="toc-text">9.2 邮件报警</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%BC%89%E5%85%A8%E6%B5%81%E7%A8%8B"><span class="toc-text">1）全流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%BC%89%E4%B8%AA%E4%BA%BA%E9%82%AE%E7%AE%B1%E5%87%86%E5%A4%87%EF%BC%88%E7%95%A5%EF%BC%89"><span class="toc-text">2）个人邮箱准备（略）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%EF%BC%89%E9%85%8D%E7%BD%AE%E5%8F%91%E4%BB%B6%E4%BA%BA"><span class="toc-text">3）配置发件人</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-3-%E5%BE%AE%E4%BF%A1%E6%8A%A5%E8%AD%A6"><span class="toc-text">9.3 微信报警</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%BC%89%E5%85%A8%E6%B5%81%E7%A8%8B-1"><span class="toc-text">1）全流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%BC%89%E5%87%86%E5%A4%87%E7%8E%AF%E5%A2%83-1-3"><span class="toc-text">2）准备环境 1-3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%EF%BC%89%E9%85%8D%E7%BD%AE%E5%8F%91%E4%BB%B6%E4%BA%BA-1"><span class="toc-text">3）配置发件人</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E3%80%81%E6%8D%A2%E4%B8%AA%E8%A7%92%E5%BA%A6%E7%9C%8B%E7%9B%91%E6%8E%A7-zabbiz-agent"><span class="toc-text">十、换个角度看监控-zabbiz-agent</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1-Zabbix%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A6%82%E8%BF%B0"><span class="toc-text">10.1 Zabbix客户端概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2-Zabbix-agent2-%E7%9B%91%E6%8E%A7-windows"><span class="toc-text">10.2 Zabbix_agent2 监控 windows</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-3-snmp%E7%9B%91%E6%8E%A7%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87"><span class="toc-text">10.3 snmp监控网络设备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%BC%89%E7%9B%91%E6%8E%A7%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87"><span class="toc-text">1）监控网络设备</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#a-%E5%90%AF%E5%8A%A8snmp"><span class="toc-text">a.启动snmp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-6-zabbix%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B8%B8%E8%A7%81%E7%B1%BB%E5%9E%8B"><span class="toc-text">4.6 zabbix客户端常见类型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E8%87%AA%E5%8A%A8%E5%8C%96"><span class="toc-text">5.自动化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-%E8%87%AA%E5%8A%A8%E6%B7%BB%E5%8A%A0%E4%B8%BB%E6%9C%BA"><span class="toc-text">5.1 自动添加主机</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-2-%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0"><span class="toc-text">12.2 自动发现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B"><span class="toc-text">2）部署流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-3-%E8%87%AA%E5%8A%A8%E6%B3%A8%E5%86%8C"><span class="toc-text">12.3 自动注册</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">1）环境准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B-1"><span class="toc-text">2）部署流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#a-%E4%BF%AE%E6%94%B9%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">a.修改客户端配置文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-%E7%9B%AE%E6%A0%87%EF%BC%9A%E7%9B%91%E6%8E%A7%E6%95%B4%E4%B8%AA%E7%BD%91%E7%AB%99%E6%9E%B6%E6%9E%84-%E5%85%A8%E6%B5%81%E7%A8%8B%EF%BC%89"><span class="toc-text">15.1 目标：监控整个网站架构(全流程）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%9E%B6%E6%9E%84%E7%9B%91%E6%8E%A7"><span class="toc-text">6 架构监控</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E5%9F%BA%E7%A1%80%E9%A1%B9%E7%9B%AE"><span class="toc-text">6.1 基础项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E8%B4%9F%E8%BD%BD"><span class="toc-text">6.2 负载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%EF%BC%89%E8%AF%81%E4%B9%A6%E6%98%AF%E5%90%A6%E8%BF%87%E6%9C%9F"><span class="toc-text">4）证书是否过期</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%EF%BC%89%E7%AB%AF%E5%8F%A3%E8%BF%9B%E7%A8%8B"><span class="toc-text">5）端口进程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%EF%BC%89%E6%8A%8A%E5%88%9B%E5%BB%BA%E5%A5%BD%E7%9A%84%E7%9B%91%E6%8E%A7%E9%A1%B9%E5%A4%8D%E5%88%B6%E5%88%B0%E6%A8%A1%E6%9D%BF%E4%B8%AD"><span class="toc-text">6）把创建好的监控项复制到模板中</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-6-web%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">14.6 web服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%BC%89%E7%9B%91%E6%8E%A7php%E7%8A%B6%E6%80%81"><span class="toc-text">1）监控php状态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-8-mysql"><span class="toc-text">14.8 mysql</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12-6-zabbix%E5%88%86%E5%B8%83%E5%BC%8F%E7%9B%91%E6%8E%A7proxy"><span class="toc-text">12.6 zabbix分布式监控proxy</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#15-%E9%83%A8%E7%BD%B2%E5%89%8D%E7%AB%AF%E9%A1%B5%E9%9D%A2%E6%8F%90%E7%A4%BA%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%B1%E8%B4%A5"><span class="toc-text">15.部署前端页面提示连接数据库失败</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#zbx-%E6%95%85%E9%9A%9C%E8%AE%B0%E5%BD%95"><span class="toc-text">zbx-故障记录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Unknown-metric-root-login"><span class="toc-text">Unknown metric root.login</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-module-named-requests"><span class="toc-text">No module named requests</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-%E5%88%86%E5%B8%83%E5%BC%8F%E7%9B%91%E6%8E%A7-proxy"><span class="toc-text">7.分布式监控-proxy</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-%E5%B0%8F%E7%BB%93"><span class="toc-text">7.3 小结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-Grafana%E5%A2%9E%E5%BC%BA%E5%B1%95%E7%A4%BA"><span class="toc-text">8.Grafana增强展示</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12"><span class="toc-text">12</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/c35a7f86.html" title="脚本暂存">脚本暂存</a><time datetime="2023-02-03T12:41:14.000Z" title="发表于 2023-02-03 20:41:14">2023-02-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/90f47a19.html" title="自动化装机">自动化装机</a><time datetime="2023-02-02T12:41:14.000Z" title="发表于 2023-02-02 20:41:14">2023-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/64202.html" title="linux">linux</a><time datetime="2023-02-02T12:41:14.000Z" title="发表于 2023-02-02 20:41:14">2023-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/8fb4d8df.html" title="zabbix">zabbix</a><time datetime="2023-02-02T01:43:57.000Z" title="发表于 2023-02-02 09:43:57">2023-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/8d6735b8.html" title="超经典SQL练习题，做完这些你的ＳＱＬ就过关了">超经典SQL练习题，做完这些你的ＳＱＬ就过关了</a><time datetime="2023-02-02T01:43:57.000Z" title="发表于 2023-02-02 09:43:57">2023-02-02</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 壹拾陆</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>