<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>ELK部署 | 壹拾陆</title><meta name="keywords" content="Linux"><meta name="author" content="壹拾陆"><meta name="copyright" content="壹拾陆"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、Elastic Stack在企业的常见架构1.没有日志收集系统运维工作的日常“通点”概述如上图所示，我简单画了一下互联网常用的一些技术栈相关架构图，请问如果让你对上图中的各组件日志进行收集，分析，存储，展示该如何做呢？ 你是否也会经常面临一下的运维痛点呢？ 痛点1：生出现故障后，运维需要不停的查看各种不同的日志进行分析?是不是毫无头绪? 痛点2：项目上线出现错误，如何快速定位问题？如果后端节点">
<meta property="og:type" content="article">
<meta property="og:title" content="ELK部署">
<meta property="og:url" content="https://mo-li001.github.io/posts/dd49d155.html">
<meta property="og:site_name" content="壹拾陆">
<meta property="og:description" content="一、Elastic Stack在企业的常见架构1.没有日志收集系统运维工作的日常“通点”概述如上图所示，我简单画了一下互联网常用的一些技术栈相关架构图，请问如果让你对上图中的各组件日志进行收集，分析，存储，展示该如何做呢？ 你是否也会经常面临一下的运维痛点呢？ 痛点1：生出现故障后，运维需要不停的查看各种不同的日志进行分析?是不是毫无头绪? 痛点2：项目上线出现错误，如何快速定位问题？如果后端节点">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-08-31T12:41:14.000Z">
<meta property="article:modified_time" content="2022-10-23T15:27:21.000Z">
<meta property="article:author" content="壹拾陆">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://mo-li001.github.io/posts/dd49d155"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ELK部署',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-23 23:27:21'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202209182232723.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">68</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">壹拾陆</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ELK部署</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-31T12:41:14.000Z" title="发表于 2022-08-31 20:41:14">2022-08-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-10-23T15:27:21.000Z" title="更新于 2022-10-23 23:27:21">2022-10-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ELK部署"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="一、Elastic-Stack在企业的常见架构"><a href="#一、Elastic-Stack在企业的常见架构" class="headerlink" title="一、Elastic Stack在企业的常见架构"></a><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1qG41187nn?p=2&spm_id_from=pageDriver&vd_source=629395ac7befa1625191c3f496068941">一、Elastic Stack在企业的常见架构</a></h1><h2 id="1-没有日志收集系统运维工作的日常“通点”概述"><a href="#1-没有日志收集系统运维工作的日常“通点”概述" class="headerlink" title="1.没有日志收集系统运维工作的日常“通点”概述"></a>1.没有日志收集系统运维工作的日常“通点”概述</h2><p>如上图所示，我简单画了一下互联网常用的一些技术栈相关架构图，请问如果让你对上图中的各组件日志进行收集，分析，存储，展示该如何做呢？</p>
<p>你是否也会经常面临一下的运维痛点呢？</p>
<p>痛点1：生出现故障后，运维需要不停的查看各种不同的日志进行分析?是不是毫无头绪?</p>
<p>痛点2：项目上线出现错误，如何快速定位问题？如果后端节点过多、日志分散怎么办？</p>
<p>痛点3：开发人员需要实时查看日志但又不想给服务器的登陆权限，怎么办？难道每天帮开发取日志？</p>
<p>痛点4：如何在海量的日志中快速的提取我们想要的数据？比如：PV、UV、TOP10的URL？如果分析的日志数据量大，那么势必会导致查询速度慢、难度增大，最终则会导致我们无法快速的获取到想要的指标。</p>
<p>痛点5：CDN公司需要不停的分析日志，那分析什么？主要分析命中率，为什么？因为我们给用户承诺的命中率是90以上。如果没有达到90，我们就要去分析数据为什么没有被命中、为什么没有被缓存下来。</p>
<p>痛点6：近期某影视公司周五下午频繁出现被盗链的情况，导致异常流量突增2G有余，给公司带来了损失，那又该如何分析异常流量呢？</p>
<p>痛点7：上百台Mysql实例的慢日志查询分析如何聚集?</p>
<p>痛点8：docker，K8s平台日志如何收集分析?</p>
<p>痛点N：……</p>
<p>如上所有的痛点都可以使用日志分析系统“Elastic Stack”解决，将运维所有的服务器日志，业务系统日志都收集到一个平台下，然后提取想要的内容，比如错误信息，警告信息等，当过滤到这种信息，就马上告警，告警后，运维人员就能马上定位是哪台机器、哪个业务系统出现了问题，出现了什么问题。</p>
<h2 id="2-Elastic-Stack分布式日志系统概述"><a href="#2-Elastic-Stack分布式日志系统概述" class="headerlink" title="2.Elastic Stack分布式日志系统概述"></a>2.Elastic Stack分布式日志系统概述</h2><p>The Elastic Stack，包括Elasticsearch、Kibana、Beats和Logstash(也称为 ELK Stack)。</p>
<p>ElaticSearch:</p>
<p>​	简称为ES，ES是一个开源的高扩展的分布式全文搜索引擎，是整个Elastic Stack技术栈的核心。</p>
<p>​	它可以近乎实时的存储、检索数据；本身扩展性很好，可以扩展到上百台服务器，处理PB级别的数据。</p>
<p>Kibana:</p>
<p>​	是一个免费且开放的用户界面，能够让您对Elasticsearch数据进行可视化，并让您在Elastic Stack中进行导航。</p>
<p>​	您可以进行各种操作，从跟踪查询负载，到理解请求如何流经您的整个应用，都能轻松完成。</p>
<p>Beats:</p>
<p>​	是一个免费且开放的平台，集合了多种单一用途数据采集器。</p>
<p>​	它们从成百上千或成千上万台机器和系统向Logstash 或 Elasticsearch发送数据。</p>
<p>Logstash:</p>
<p>​	是免费且开放的服务器端数据处理管道，能够从多个来源采集数据，转换数据，然后将数据发送到您最喜欢的“存储库”中。</p>
<p>Elastic Stack的主要优点有如下几个：</p>
<p>​	（1）处理方式灵活：</p>
<p>​				elasticsearch是实时全文索引，具有强大的搜索功能。</p>
<p>​	（2）配置相对简单：</p>
<p>​				elasticsearch全部使用JSON 接口，logstash使用模块配置，kibana的配置文件部分更简单。</p>
<p>​	（3）检索性能高效：</p>
<p>​				基于优秀的设计，虽然每次查询都是实时，但是也可以达到百亿级数据的查询秒级响应。</p>
<p>​	（4）集群线性扩展：</p>
<p>​				elasticsearch和logstash都可以灵活线性扩展。</p>
<p>​	（5）前端操作绚丽：</p>
<p>​				kibana的前端设计比较绚丽，而且操作简单。</p>
<p>使用elastic stack能收集那些日志：</p>
<p>​	容器管理工具：</p>
<p>​			docker</p>
<p>​	容器编排工具：</p>
<p>​			docker swarm，Kubernetes</p>
<p>​	负载均衡服务器：</p>
<p>​			lvs，haproxy，nginx</p>
<p>​	web服务器：</p>
<p>​			httpd，nginx，tomcat</p>
<p>​	数据库：</p>
<p>​			mysql，redis，MongoDB，Hbase，Kudu，ClickHouse，PostgresQL</p>
<p>​	存储：</p>
<p>​			nfs，gluterfs，fastdfs，HDFS，Ceph</p>
<p>​	系统：</p>
<p>​			message，security</p>
<p>​	业务：</p>
<p>​			包括但不限于C，C++，Java，PHP，Go，Python，Shell等编程语言研发的App。</p>
<h2 id="3-Elastic-Stack企业级“EFK“架构图解"><a href="#3-Elastic-Stack企业级“EFK“架构图解" class="headerlink" title="3.Elastic Stack企业级“EFK“架构图解"></a>3.Elastic Stack企业级“EFK“架构图解</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">数据流走向：源数据层(nginx,tomcat) ---&gt; 数据采集层(filebeat) ---&gt; 数据存储层(ElasticSearch)。</span><br></pre></td></tr></table></figure>



<h2 id="4-Elastic-Stack企业级”ELK“架构图解"><a href="#4-Elastic-Stack企业级”ELK“架构图解" class="headerlink" title="4.Elastic Stack企业级”ELK“架构图解"></a>4.Elastic Stack企业级”ELK“架构图解</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">数据流走向：源数据层(nginx,tomcat) ---&gt; 数据采集/转换层(Logstash) ---&gt; 数据存储层(ElasticSearch)。</span><br></pre></td></tr></table></figure>



<h2 id="5-Elastic-Stack企业级”ELFK“架构图解"><a href="#5-Elastic-Stack企业级”ELFK“架构图解" class="headerlink" title="5.Elastic Stack企业级”ELFK“架构图解"></a>5.Elastic Stack企业级”ELFK“架构图解</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">数据流走向：源数据层(nginx,tomcat) ---&gt; 数据采集(filebeat) ---&gt; 转换层(Logstash) ---&gt; 数据存储层</span><br><span class="line">(ElasticSearch)。</span><br></pre></td></tr></table></figure>



<h2 id="6-Elastic-Stack企业级”ELFK”-”Kafka”架构图解"><a href="#6-Elastic-Stack企业级”ELFK”-”Kafka”架构图解" class="headerlink" title="6.Elastic Stack企业级”ELFK”+”Kafka”架构图解"></a>6.Elastic Stack企业级”ELFK”+”Kafka”架构图解</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">数据流走向：源数据层（nginx,tomcat) ---&gt; 数据采集(filebeat) ---&gt; 数据缓存层(kafka) ---&gt; 转换层(Logstash) ---&gt; 数据存储层(ElasticSearch)。</span><br></pre></td></tr></table></figure>



<h2 id="7-Elastic-Stack企业级”ELFK”-”kafka”架构演变"><a href="#7-Elastic-Stack企业级”ELFK”-”kafka”架构演变" class="headerlink" title="7.Elastic Stack企业级”ELFK”+”kafka”架构演变"></a>7.Elastic Stack企业级”ELFK”+”kafka”架构演变</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如上图所示，在实际工作中，如果有大数据部门的存在，也有可能kafka的数据要被多个公司使用哟。</span><br></pre></td></tr></table></figure>



<h2 id="8-课程学习方法介绍"><a href="#8-课程学习方法介绍" class="headerlink" title="8.课程学习方法介绍"></a>8.课程学习方法介绍</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">（1）学而时习之，上课不能光听不练习，听懂不等于会了；</span><br><span class="line">（2）将学习的内容用自己的话说出来，毕竟将来找工作的时候需要跟面试官面对面交流；</span><br><span class="line">（3）多动手，画架构图，勤做笔记，好记性不如烂笔头；</span><br><span class="line">（4）课堂上讲解的内容，遇到问题可以尝试自己先行排查，但超过30分钟以上还搞不定，就得问老师或同学了；</span><br><span class="line">（5）认真完成课后作业，有助于你巩固知识点甚至扩展新的内容；</span><br></pre></td></tr></table></figure>





<h1 id="二-ElasticSearch和Solr的抉择"><a href="#二-ElasticSearch和Solr的抉择" class="headerlink" title="二.ElasticSearch和Solr的抉择"></a>二.ElasticSearch和Solr的抉择</h1><h2 id="1-ElasticSearch和Lucene的关系"><a href="#1-ElasticSearch和Lucene的关系" class="headerlink" title="1.ElasticSearch和Lucene的关系"></a>1.ElasticSearch和Lucene的关系</h2><p>Lucene的优缺点：</p>
<p>​		优点：</p>
<p>​				可以被认为是迄今为止最先进，性能最好的，功能最全的搜索引擎库（框架）。</p>
<p>​		缺点：</p>
<p>​				（1）只能在Java项目中使用，并且要以jar包的方式直接集成在项目中；</p>
<p>​				（2）使用很复杂，你需要深入了解检索的相关知识来创建索引和搜索索引代码；</p>
<p>​				（3）不支持集群环境，索引数据不同步（不支持大型项目）；</p>
<p>​				（4）扩展性差，索引库和应用所在同一个服务器，当索引数据过大时，效率逐渐降低；</p>
<p>值得注意的是，上述的Lucene框架中的缺点，Elasticsearch全部都能解决。</p>
<p>ElasticSearch是一个实时的分布式搜索和分析引擎。它可以帮助你用前所未有的速度去处理大规模数据。</p>
<p>ES可以用于全文搜索，结构化搜索以及分析，当然你也可以将这三者进行组合。</p>
<p>有哪些公司在使用ElasticSearch呢，全球几乎所有的大型互联网公司都在拥抱这个开源项目：</p>
<p>​		<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/customers/success-stories">https://www.elastic.co/cn/customers/success-stories</a></p>
<h2 id="2-ElasticSearch和Solr如何抉择"><a href="#2-ElasticSearch和Solr如何抉择" class="headerlink" title="2.ElasticSearch和Solr如何抉择"></a>2.ElasticSearch和Solr如何抉择</h2><p>Solr是Apache Lucene项目的开源企业搜索平台。其主要功能包括全文检索、命中标示、分面搜索、动态聚类、数据库集成，以及富文本（如Word、PDF）的处理。</p>
<p>Solr是高度可扩展的，并提供了分布式搜索和索引复制。Solr是最流行的企业级搜索引擎，Solr4 还增加了NoSQL支持。</p>
<p>Elasticsearch(下面简称”ES”)与solr的比较：</p>
<p>（1）Solr利用zookeeper进行分布式管理，而Es自身带有分布式协调管理功能；</p>
<p>（2）Solr支持更多格式（JSON、XML、CSV）的数据，而ES仅支持JSON文件格式；</p>
<p>（3）Solr官方提供的功能更多，而ES本身更注重于核心功能，高级功能多有第三方插件提供；</p>
<p>（4）Solr在“传统搜索”（已有数据）中表现好于ES，但在处理“实时搜索”（实时建立索引）应用时效率明显低于ES。</p>
<p>（5）Solr是传统搜索应用的有力解决方案，但Elasticsearch更适用于新兴的实时搜索应用。</p>
<p>如下图所示，有网友在生产环境测试，将搜索引擎从solr转到ElasticSearch以后的平均查询速度有了将近50倍的提升。</p>
<h1 id="三-集群基础环境初始化"><a href="#三-集群基础环境初始化" class="headerlink" title="三.集群基础环境初始化"></a>三.集群基础环境初始化</h1><h2 id="1-准备虚拟机"><a href="#1-准备虚拟机" class="headerlink" title="1.准备虚拟机"></a>1.准备虚拟机</h2><table>
<thead>
<tr>
<th>IP地址</th>
<th>主机名</th>
<th>CPU配置</th>
<th>内存配置</th>
<th>磁盘配置</th>
<th>角色说明</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.101</td>
<td>elk101</td>
<td>2 core</td>
<td>4G</td>
<td>20G+</td>
<td>ES node</td>
</tr>
<tr>
<td>10.0.0.102</td>
<td>elk102</td>
<td>2 core</td>
<td>4G</td>
<td>20G+</td>
<td>ES node</td>
</tr>
<tr>
<td>10.0.0.103</td>
<td>elk103</td>
<td>2 core</td>
<td>4G</td>
<td>20G+</td>
<td>ES node</td>
</tr>
</tbody></table>
<h2 id="2-修改软件源"><a href="#2-修改软件源" class="headerlink" title="2.修改软件源"></a>2.修改软件源</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -e &#x27;s|^mirrorlist=|#mirrorlist=|g&#x27; \</span><br><span class="line">         -e &#x27;s|^#baseurl=http://mirror.centos.org|baseurl=https://mirrors.tuna.tsinghua.edu.cn|g&#x27; \</span><br><span class="line">         -i.bak \</span><br><span class="line">         /etc/yum.repos.d/CentOS-*.repo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">参考链接：</span><br><span class="line">    https://mirrors.tuna.tsinghua.edu.cn/help/centos/</span><br></pre></td></tr></table></figure>



<h2 id="3-修改终端颜色"><a href="#3-修改终端颜色" class="headerlink" title="3.修改终端颜色"></a>3.修改终端颜色</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;&gt; ~/.bashrc</span><br><span class="line">PS1=&#x27;[\[\e[34;1m\]\u@\[\e[0m\]\[\e[32;1m\]\H\[\e[0m\]\[\e[31;1m\] \W\[\e[0m\]]# &#x27;</span><br><span class="line">EOF</span><br><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure>



<h2 id="4-修改sshd服务优化"><a href="#4-修改sshd服务优化" class="headerlink" title="4.修改sshd服务优化"></a>4.修改sshd服务优化</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sed -ri &#x27;s@^#UseDNS yes@UseDNS no@g&#x27; /etc/ssh/sshd_config</span><br><span class="line">sed -ri &#x27;s#^GSSAPIAuthentication yes#GSSAPIAuthentication no#g&#x27; /etc/ssh/sshd_config</span><br><span class="line">grep ^UseDNS /etc/ssh/sshd_config</span><br><span class="line">grep ^GSSAPIAuthentication /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure>



<h2 id="5-关闭防火墙"><a href="#5-关闭防火墙" class="headerlink" title="5.关闭防火墙"></a>5.关闭防火墙</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable --now firewalld &amp;&amp; systemctl is-enabled firewalld</span><br><span class="line">systemctl status firewalld</span><br></pre></td></tr></table></figure>



<h2 id="6-禁用selinux"><a href="#6-禁用selinux" class="headerlink" title="6.禁用selinux"></a>6.禁用selinux</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sed -ri &#x27;s#(SELINUX=)enforcing#\1disabled#&#x27; /etc/selinux/config</span><br><span class="line">grep ^SELINUX= /etc/selinux/config</span><br><span class="line">setenforce 0</span><br><span class="line">getenforce</span><br></pre></td></tr></table></figure>



<h2 id="7-配置集群免密登录及同步脚本"><a href="#7-配置集群免密登录及同步脚本" class="headerlink" title="7.配置集群免密登录及同步脚本"></a>7.配置集群免密登录及同步脚本</h2><p>（1）修改主机列表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">10.0.0.101 elk101</span><br><span class="line">10.0.0.102 elk102</span><br><span class="line">10.0.0.103 elk103</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>（2）elk101节点上生成密钥对</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -P &#x27;&#x27; -f ~/.ssh/id_rsa -q</span><br></pre></td></tr></table></figure>

<p>（3）elk101配置所有集群节点的免密登录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for ((host_id=101;host_id&lt;=103;host_id++));do ssh-copy-id elk$&#123;host_id&#125; ;done</span><br></pre></td></tr></table></figure>

<p>（4）链接测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh &#x27;elkl01&#x27;</span><br><span class="line">ssh &#x27;elkl02&#x27;</span><br><span class="line">ssh &#x27;elkl03&#x27;</span><br></pre></td></tr></table></figure>

<p>（5）所有节点安装rsync数据同步工具</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install rsync</span><br></pre></td></tr></table></figure>

<p>（6）编写同步脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/sbin/data_rsync.sh # 将下面的内容拷贝到该文件即可</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Auther: Jason Yin</span></span><br><span class="line"></span><br><span class="line">if [ $# -ne 1 ];then</span><br><span class="line">  echo &quot;Usage: $0 /path/to/file(绝对路径)&quot;</span><br><span class="line">  exit</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">判断文件是否存在</span></span><br><span class="line">if [ ! -e $1 ];then</span><br><span class="line">  echo &quot;[ $1 ] dir or file not find!&quot;</span><br><span class="line">  exit</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">获取父路径</span></span><br><span class="line">fullpath=`dirname $1`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">获取子路径</span></span><br><span class="line">basename=`basename $1`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">进入到父路径</span></span><br><span class="line">cd $fullpath</span><br><span class="line"></span><br><span class="line">for ((host_id=102;host_id&lt;=103;host_id++))</span><br><span class="line">  do</span><br><span class="line">    # 使得终端输出变为绿色</span><br><span class="line">    tput setaf 2</span><br><span class="line">    echo ===== rsyncing elk$&#123;host_id&#125;: $basename =====</span><br><span class="line">    # 使得终端恢复原来的颜色</span><br><span class="line">    tput setaf 7</span><br><span class="line">    # 将数据同步到其他两个节点</span><br><span class="line">    rsync -az $basename `whoami`@elk$&#123;host_id&#125;:$fullpath</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">      echo &quot;命令执行成功！&quot;</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>（7）给脚本授权</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /usr/local/sbin/data_rsync.sh</span><br></pre></td></tr></table></figure>



<h2 id="8-集群时间同步"><a href="#8-集群时间同步" class="headerlink" title="8.集群时间同步"></a>8.集群时间同步</h2><p>（1）安装常用的Linux工具，您可以自定义哈。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install vim net-tools</span><br></pre></td></tr></table></figure>

<p>（2）安装chrony服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ntpdate chrony</span><br></pre></td></tr></table></figure>

<p>（3）修改chrony服务配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/chrony.conf</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注释官方的时间服务器，换成国内的时间服务器即可</span></span><br><span class="line">server ntp.aliyun.com iburst</span><br><span class="line">server ntp1.aliyun.com iburst</span><br><span class="line">server ntp2.aliyun.com iburst</span><br><span class="line">server ntp3.aliyun.com iburst</span><br><span class="line">server ntp4.aliyun.com iburst</span><br><span class="line">server ntp5.aliyun.com iburst</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>（4）配置chronyd的开机自启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now chronyd</span><br></pre></td></tr></table></figure>

<p>（5）重启服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart chronyd</span><br></pre></td></tr></table></figure>

<p>（6）查看服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status chronyd</span><br></pre></td></tr></table></figure>



<h1 id="四-ElasticSearch单点部署"><a href="#四-ElasticSearch单点部署" class="headerlink" title="四.ElasticSearch单点部署"></a>四.ElasticSearch单点部署</h1><h2 id="1-下载指定的ES版本"><a href="#1-下载指定的ES版本" class="headerlink" title="1.下载指定的ES版本"></a>1.下载指定的ES版本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">详细步骤见视频。</span><br><span class="line"></span><br><span class="line">参考链接：</span><br><span class="line">    https://www.elastic.co/cn/downloads/elasticsearch</span><br></pre></td></tr></table></figure>



<p>视频操作：</p>
<p>下载Elasticsearch 7.17.3 tar包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.17.3-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>

<p>下载Elasticsearch 7.17.3 RPM包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.17.3-x86_64.rpm</span><br></pre></td></tr></table></figure>



<h2 id="2-部署JDK环境-可选步骤-跳过"><a href="#2-部署JDK环境-可选步骤-跳过" class="headerlink" title="2.部署JDK环境-可选步骤(跳过)"></a>2.部署JDK环境-可选步骤(跳过)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">官方连接：</span><br><span class="line">    https://www.oracle.com/java/technologies/downloads/#java8</span><br><span class="line">  </span><br><span class="line">elk101节点部署oracle jdk步骤：</span><br><span class="line">    （1）创建工作目录</span><br><span class="line">mkdir -pv /oldboyedu/softwares</span><br><span class="line"></span><br><span class="line">    （2）解压JDK到指定的目录</span><br><span class="line">tar xf jdk-8u321-linux-x64.tar.gz -C /oldboyedu/softwares/</span><br><span class="line"></span><br><span class="line">    （3）创建符号链接</span><br><span class="line">cd /oldboyedu/softwares/ &amp;&amp; ln -sv jdk1.8.0_321 jdk</span><br><span class="line"></span><br><span class="line">    （4）创建环境变量</span><br><span class="line">cat &gt; /etc/profile.d/elk.sh &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">export JAVA_HOME=/oldboyedu/softwares/jdk</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line">EOF</span><br><span class="line">source /etc/profile.d/jdk.sh</span><br><span class="line"></span><br><span class="line">    （5）查看JDK的版本号</span><br><span class="line">java -version</span><br><span class="line"></span><br><span class="line">    （6）同步jdk环境到其他节点</span><br><span class="line">data_rsync.sh /oldboyedu/</span><br><span class="line">data_rsync.sh /etc/profile.d/elk.sh</span><br><span class="line"></span><br><span class="line">    （7）其他节点测试</span><br><span class="line">source /etc/profile.d/elk.sh</span><br><span class="line">java -version</span><br></pre></td></tr></table></figure>



<h2 id="3-单点部署elasticsearh"><a href="#3-单点部署elasticsearh" class="headerlink" title="3.单点部署elasticsearh"></a>3.单点部署elasticsearh</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">（1）安装服务</span><br><span class="line">yum -y localinstall elasticsearch-7.17.3-x86_64.rpm</span><br><span class="line"></span><br><span class="line">（2）修改配置文件</span><br><span class="line">egrep -v &quot;^#|^$&quot; /etc/elasticsearch/elasticsearch.yml</span><br><span class="line">cluster.name: oldboyedu-elk</span><br><span class="line">node.name: oldboyedu-elk103</span><br><span class="line">path.data: /var/lib/elasticsearch</span><br><span class="line">path.logs: /var/log/elasticsearch</span><br><span class="line">network.host: 10.0.0.103</span><br><span class="line">discovery.seed_hosts: [&quot;10.0.0.103&quot;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">相关参数说明：</span><br><span class="line">    cluster.name:</span><br><span class="line">        集群名称，若不指定，则默认是&quot;elasticsearch”，日志文件的前缀也是集群名称。</span><br><span class="line">    node.name:</span><br><span class="line">        指定节点的名称，可以自定义，批荐使用当前的主机名，要求集群唯一。</span><br><span class="line">    path.data:</span><br><span class="line">        数据路径。</span><br><span class="line">    path.logs:</span><br><span class="line">        日志路径</span><br><span class="line">    network.host:</span><br><span class="line">        ES服务监听的IP地址</span><br><span class="line">    discovery.seed_hosts:</span><br><span class="line">        服务发现的主机列表，对于单点部署而言，主机列表和&quot;network.host&quot;字段配置相同即可。</span><br><span class="line">        </span><br><span class="line">（3）启动服务</span><br><span class="line">systemctl start elasticsearch.service</span><br></pre></td></tr></table></figure>

<p>视频练习：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">本地安装rpm包</span><br><span class="line">yum -y localinstall elasticsearch-7.17.3-x86_64.rpm</span><br><span class="line"></span><br><span class="line">启动服务</span><br><span class="line">systemctl start elasticsearch.service</span><br><span class="line"></span><br><span class="line">查看端口9200和9300</span><br><span class="line">ss -ntl</span><br><span class="line"></span><br><span class="line">访问9200</span><br><span class="line">curl 10.0.0.101:9200</span><br><span class="line"></span><br><span class="line">修改配置</span><br><span class="line">vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line">cluster.name: oldboyedu-elk</span><br><span class="line">node.name: elk101</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">discovery.seed_hosts: [&quot;10.0.0.101&quot;]</span><br><span class="line"></span><br><span class="line">重启服务</span><br><span class="line">systemctl restart elasticsearch.service</span><br></pre></td></tr></table></figure>



<h2 id="4-OpenJDK切换Oracle-JDK并修改堆内存大小-跳过"><a href="#4-OpenJDK切换Oracle-JDK并修改堆内存大小-跳过" class="headerlink" title="4.OpenJDK切换Oracle JDK并修改堆内存大小-(跳过)"></a>4.OpenJDK切换Oracle JDK并修改堆内存大小-(跳过)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">（1）修改es的环境变量配置文件</span><br><span class="line">vim /etc/sysconfig/elasticsearch</span><br><span class="line">...</span><br><span class="line">ES_JAVA_HOME=/oldboyedu/softwares/jdk</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">（2）修改堆内存大小</span><br><span class="line">vim /etc/elasticsearch/jvm.options</span><br><span class="line">...</span><br><span class="line">-Xms256m</span><br><span class="line">-Xmx256m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">（3）验证堆内存大小</span><br><span class="line">jmap -heap `ps -ef | grep java | grep -v grep | awk &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">（4）同步配置文件到其他节点</span><br><span class="line">data_rsync.sh /etc/sysconfig/elasticsearch</span><br><span class="line">data_rsync.sh /etc/elasticsearch/jvm.options</span><br></pre></td></tr></table></figure>





<h1 id="五-ElasticSearch分布式集群部署"><a href="#五-ElasticSearch分布式集群部署" class="headerlink" title="五.ElasticSearch分布式集群部署"></a>五.ElasticSearch分布式集群部署</h1><h2 id="1-elk101修改配置文件"><a href="#1-elk101修改配置文件" class="headerlink" title="1.elk101修改配置文件"></a>1.elk101修改配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line">...</span><br><span class="line">cluster.name: oldboyedu-elk</span><br><span class="line">node.name: elk101</span><br><span class="line">path.data: /var/lib/elasticsearch</span><br><span class="line">path.logs: /var/log/elasticsearch</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">discovery.seed_hosts: [&quot;elk101&quot;,&quot;elk102&quot;,&quot;elk103&quot;]</span><br><span class="line">cluster.initial_master_nodes: [&quot;elk101&quot;, &quot;elk102&quot;, &quot;elk103&quot;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">温馨提示：</span><br><span class="line">    &quot;node.name&quot;各个节点配置要区分清楚，建议写对应的主机名称。</span><br></pre></td></tr></table></figure>



<h2 id="2-同步配置文件到集群的其他节点"><a href="#2-同步配置文件到集群的其他节点" class="headerlink" title="2.同步配置文件到集群的其他节点"></a>2.同步配置文件到集群的其他节点</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">（1）elk101同步配置文件到集群的其他节点</span><br><span class="line">data_rsync.sh /etc/elasticsearch/elasticsearch.yml</span><br><span class="line"></span><br><span class="line">（2）elk102节点配置</span><br><span class="line">vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line">...</span><br><span class="line">node.name: elk102</span><br><span class="line"></span><br><span class="line">（3）elk103节点配置</span><br><span class="line">vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line">...</span><br><span class="line">node.name: elk103</span><br></pre></td></tr></table></figure>



<h2 id="3-所有节点删除之前的临时数据"><a href="#3-所有节点删除之前的临时数据" class="headerlink" title="3.所有节点删除之前的临时数据"></a>3.所有节点删除之前的临时数据</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pkill java</span><br><span class="line">rm -rf rm -rf /var/&#123;lib,log&#125;/elasticsearch/* /tmp/*</span><br><span class="line">11 /var/lib/elasticsearch/ /var/log/elasticsearch/ /tmp/</span><br></pre></td></tr></table></figure>



<h2 id="4-所有节点启动服务"><a href="#4-所有节点启动服务" class="headerlink" title="4.所有节点启动服务"></a>4.所有节点启动服务</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">（1）所有节点启动服务</span><br><span class="line">systemctl start elasticsearch</span><br><span class="line"></span><br><span class="line">（2）启动过程中建议查看日志</span><br><span class="line">tail -100f /var/log/elasticsearch/oldboyedu-elk.log</span><br></pre></td></tr></table></figure>



<h2 id="5-验证集群是否正常"><a href="#5-验证集群是否正常" class="headerlink" title="5.验证集群是否正常"></a>5.验证集群是否正常</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl elk103:9200/_cat/nodes?v</span><br></pre></td></tr></table></figure>



<p>视频操作：</p>
<p>elk102、elk103安装elasticsearch-7.17.3-x86_64.rpm</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101 ~]# scp elasticsearch-7.17.3-x86_64.rpm elk102:~</span><br><span class="line">[root@elk101 ~]# scp elasticsearch-7.17.3-x86_64.rpm elk103:~</span><br><span class="line">[root@elk102 ~]# yum -y localinstall elasticsearch-7.17.3-x86_64.rpm</span><br><span class="line">[root@elk103 ~]# yum -y localinstall elasticsearch-7.17.3-x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>elk101修改elasticsearch.yml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101 ~]# vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line">cluster.name: oldboyedu-elk</span><br><span class="line">node.name: elk101</span><br><span class="line">path.data: /var/lib/elasticsearch</span><br><span class="line">path.logs: /var/log/elasticsearch</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">discovery.seed_hosts: [&quot;10.0.0.101&quot;,&quot;10.0.0.102&quot;,&quot;10.0.0.103&quot;]</span><br><span class="line">cluster.initial_master_nodes: [&quot;10.0.0.101&quot;,&quot;10.0.0.102&quot;,&quot;10.0.0.103&quot;]</span><br><span class="line">[root@elk101 ~]# data_rsync.sh /etc/elasticsearch/elasticsearch.yml</span><br></pre></td></tr></table></figure>

<p>elk102节点配置、elk103节点配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102 ~]# vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line">...</span><br><span class="line">node.name: elk102</span><br><span class="line"></span><br><span class="line">[root@elk103 ~]# vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line">...</span><br><span class="line">node.name: elk103</span><br></pre></td></tr></table></figure>

<p>清空目录文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101 ~]# rm -rf /tmp/*</span><br><span class="line">[root@elk102 ~]# rm -rf /tmp/*</span><br><span class="line">[root@elk103 ~]# rm -rf /tmp/*</span><br><span class="line">[root@elk101 ~]# ll /tmp/</span><br><span class="line">[root@elk102 ~]# ll /tmp/</span><br><span class="line">[root@elk103 ~]# ll /tmp/</span><br><span class="line">[root@elk101 ~]# rm -rf /var/&#123;lib,log&#125;/elasticsearch/*</span><br><span class="line">[root@elk101 ~]# ll /var/&#123;lib,log&#125;/elasticsearch/</span><br><span class="line">[root@elk102 ~]# rm -rf /var/&#123;lib,log&#125;/elasticsearch/*</span><br><span class="line">[root@elk102 ~]# ll /var/&#123;lib,log&#125;/elasticsearch/</span><br><span class="line">[root@elk103 ~]# rm -rf /var/&#123;lib,log&#125;/elasticsearch/*</span><br><span class="line">[root@elk103 ~]# ll /var/&#123;lib,log&#125;/elasticsearch/</span><br></pre></td></tr></table></figure>

<p>elk101、elk102、elk103启动服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101 ~]# systemctl start elasticsearch.service</span><br><span class="line">[root@elk102 ~]# systemctl start elasticsearch.service</span><br><span class="line">[root@elk103 ~]# systemctl start elasticsearch.service</span><br></pre></td></tr></table></figure>

<p>访问9200</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@elk103 ~]# curl 10.0.0.101:9200</span><br><span class="line">[root@elk103 ~]# curl 10.0.0.102:9200</span><br><span class="line">[root@elk103 ~]# curl 10.0.0.103:9200</span><br></pre></td></tr></table></figure>

<p>检查服务是否正常</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101 ~]# curl 10.0.0.101:9200/_cat/nodes</span><br><span class="line">[root@elk102 ~]# curl 10.0.0.102:9200/_cat/nodes</span><br><span class="line">[root@elk103 ~]# curl 10.0.0.103:9200/_cat/nodes</span><br></pre></td></tr></table></figure>

<p>查看日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101 ~]# tail -100f /var/log/elasticsearch/oldboyedu-elk.log</span><br></pre></td></tr></table></figure>

<p>检查配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101 ~]# egrep -V &quot;^$|^#&quot; /etc/elasticsearch/elasticsearch.yml</span><br></pre></td></tr></table></figure>

<p>检查集群是否正常</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101 ~]# curl elk101:9200/_cat/nodes</span><br></pre></td></tr></table></figure>





<h1 id="六-部署kibana服务"><a href="#六-部署kibana服务" class="headerlink" title="六.部署kibana服务"></a>六.部署kibana服务</h1><h2 id="1-本地安装kibana"><a href="#1-本地安装kibana" class="headerlink" title="1.本地安装kibana"></a>1.本地安装kibana</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y localinstall kibana-7.17.2-x86_64.rpm</span><br></pre></td></tr></table></figure>



<h2 id="2-修改kibana的配置文件"><a href="#2-修改kibana的配置文件" class="headerlink" title="2.修改kibana的配置文件"></a>2.修改kibana的配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kibana/kibana.yml</span><br><span class="line">...</span><br><span class="line">server.host: &quot;10.0.0.101&quot;</span><br><span class="line">server.name: &quot;oldboyedu-kibana-server&quot;</span><br><span class="line">elasticsearch.hosts: [&quot;http://10.0.0.101:9200&quot;,&quot;http://10.0.0.102:9200&quot;,&quot;http://10.0.0.103:9200&quot;]</span><br><span class="line">i18n.locale: &quot;zh-CN&quot;</span><br></pre></td></tr></table></figure>



<h2 id="3-启动kibana服务"><a href="#3-启动kibana服务" class="headerlink" title="3.启动kibana服务"></a>3.启动kibana服务</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now kibana</span><br><span class="line">systemctl status kibana</span><br></pre></td></tr></table></figure>



<h2 id="4-访问kibana的webUI"><a href="#4-访问kibana的webUI" class="headerlink" title="4.访问kibana的webUI"></a>4.访问kibana的webUI</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">见视频。</span><br></pre></td></tr></table></figure>



<p>视频操作：</p>
<p>kibana可以安装任意节点，视频选择安装elk103上</p>
<p>下载kibana-7.17.3-x86_64.rpm</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk103 ~]# wget https://artifacts.elastic.co/downloads/kibana/kibana-7.17.3-x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>下载kibana-7.17.3-linux-x86_64.tar.gz</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk103 ~]# wget https://artifacts.elastic.co/downloads/kibana/kibana-7.17.3-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>

<p>本地安装kibana</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk103 ~]# yum -y localinstall kibana-7.17.3-x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>配置&#x2F;etc&#x2F;kibana&#x2F;kibana.yml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@elk103 ~]# vim /etc/kibana/kibana.yml</span><br><span class="line">server.host: &quot;0.0.0.0&quot;</span><br><span class="line">server.name: &quot;oldboyedu-elk&quot;</span><br><span class="line">elasticsearch.hosts: [&quot;http://10.0.0.101:9200&quot;,&quot;http://10.0.0.102:9200&quot;,&quot;http://10.0.0.103:9200&quot;]  # 指定部署的elasticsearch节点</span><br><span class="line">i18n.locale: &quot;zh-CN&quot;</span><br></pre></td></tr></table></figure>

<p>检查配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk103 ~]# egrep -v &quot;^$|^#&quot; /etc/kibana/kibana.yml</span><br></pre></td></tr></table></figure>

<p>启动服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk103 ~]# systemctl start kibana</span><br></pre></td></tr></table></figure>

<p>查看服务状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk103 ~]# systemctl status kibana</span><br></pre></td></tr></table></figure>

<p>查看kibana日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk103 ~]# journalctl -u kibana</span><br></pre></td></tr></table></figure>

<p>查看kibana日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk103 ~]# cat /var/log/kibana/kibana.log</span><br></pre></td></tr></table></figure>

<p>查看端口5601</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk103 ~]# ss -ntl</span><br></pre></td></tr></table></figure>

<p>浏览器访问 10.0.0.103:5601</p>
<h1 id="七-filebeat环境部署"><a href="#七-filebeat环境部署" class="headerlink" title="七.filebeat环境部署"></a>七.filebeat环境部署</h1><h2 id="1-部署filebeat环境"><a href="#1-部署filebeat环境" class="headerlink" title="1.部署filebeat环境"></a>1.部署filebeat环境</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum -y localinstall filebeat-7.17.2-x86_64.rpm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">温馨提示：</span><br><span class="line">    elk102节点操作。</span><br></pre></td></tr></table></figure>



<h2 id="2-修改filebeat的配置文件"><a href="#2-修改filebeat的配置文件" class="headerlink" title="2.修改filebeat的配置文件"></a>2.修改filebeat的配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">（1）编写测试的配置文件</span><br><span class="line">mkdir /etc/filebeat/config</span><br><span class="line">cat &gt; /etc/filebeat/config/01-stdin-to-console.yml &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定输入的类型</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定输入的类型为<span class="string">&quot;stdin&quot;</span>,表示标准输入</span></span><br><span class="line">- type: stdin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定输出的类型</span></span><br><span class="line">output.console:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">打印漂亮的格式</span></span><br><span class="line">  pretty: true</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">(2)运行filebeat实例</span><br><span class="line">filebeat -e -c /etc/filebeat/config/01-stdin-to-console.yml</span><br><span class="line"></span><br><span class="line">(3)测试</span><br><span class="line">见视频。</span><br></pre></td></tr></table></figure>



<h2 id="3-input的log类型"><a href="#3-input的log类型" class="headerlink" title="3.input的log类型"></a>3.input的log类型</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; config/02-log-to-console.yml &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test.log</span><br><span class="line"></span><br><span class="line">output.console:</span><br><span class="line">  pretty: true</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h2 id="4-input的通配符案例"><a href="#4-input的通配符案例" class="headerlink" title="4.input的通配符案例"></a>4.input的通配符案例</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; config/03-log-to-console.yml &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test.log</span><br><span class="line">    - /tmp/*.txt</span><br><span class="line"></span><br><span class="line">output.console:</span><br><span class="line">  pretty: true</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h2 id="5-input的通用字段案例"><a href="#5-input的通用字段案例" class="headerlink" title="5.input的通用字段案例"></a>5.input的通用字段案例</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; config/04-log-to-console.yml &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">是否启动当前的输入类型，默认值为<span class="literal">true</span></span></span><br><span class="line">  enabled: true</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定数据路径</span></span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test.log</span><br><span class="line">    - /tmp/*.txt</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">给当前的输入类型搭上标签</span></span><br><span class="line">  tags: [&quot;oldboyedu-linux80&quot;，&quot;容器运维&quot;,&quot;DBA运维&quot;,&quot;SRE运维工程师&quot;]</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">自定义字段</span></span><br><span class="line">  fields:</span><br><span class="line">    school: &quot;北京昌平区沙河镇&quot;</span><br><span class="line">    class: &quot;linux80&quot;</span><br><span class="line"></span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test/*/*.log</span><br><span class="line">  tags:[&quot;oldboyedu-python&quot;,&quot;云原生开发&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    name: &quot;oldboy&quot;</span><br><span class="line">    hobby: &quot;linux,抖音&quot;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">将自定义字段的key-value放到顶级字段.</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">默认值为<span class="literal">false</span>，会将数据放在一个叫<span class="string">&quot;fields&quot;</span>字段的下面.</span></span><br><span class="line">  fields_under_root: true</span><br><span class="line">    </span><br><span class="line">output.console:</span><br><span class="line">  pretty: true</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h2 id="6-将数据写入es案例"><a href="#6-将数据写入es案例" class="headerlink" title="6.将数据写入es案例"></a>6.将数据写入es案例</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; config/05-log-to-console.yml &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test.log</span><br><span class="line">    - /tmp/*.txt</span><br><span class="line">  tags: [&quot;oldboyedu-linux80&quot;，&quot;容器运维&quot;,&quot;DBA运维&quot;,&quot;SRE运维工程师&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    school: &quot;北京昌平区沙河镇&quot;</span><br><span class="line">    class: &quot;linux80&quot;</span><br><span class="line"></span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test/*/*.log</span><br><span class="line">  tags:[&quot;oldboyedu-python&quot;,&quot;云原生开发&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    name: &quot;oldboy&quot;</span><br><span class="line">    hobby: &quot;linux,抖音&quot;</span><br><span class="line">  fields_under_root: true</span><br><span class="line">    </span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;http://10.0.0.101:9200&quot;,&quot;http://10.0.0.102:9200&quot;,&quot;http://10.0.0.103:9200&quot;]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h2 id="7-自定义es索引名称"><a href="#7-自定义es索引名称" class="headerlink" title="7.自定义es索引名称"></a>7.自定义es索引名称</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; config/06-log-to-console.yml &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test.log</span><br><span class="line">    - /tmp/*.txt</span><br><span class="line">  tags: [&quot;oldboyedu-linux80&quot;，&quot;容器运维&quot;,&quot;DBA运维&quot;,&quot;SRE运维工程师&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    school: &quot;北京昌平区沙河镇&quot;</span><br><span class="line">    class: &quot;linux80&quot;</span><br><span class="line"></span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test/*/*.log</span><br><span class="line">  tags:[&quot;oldboyedu-python&quot;,&quot;云原生开发&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    name: &quot;oldboy&quot;</span><br><span class="line">    hobby: &quot;linux,抖音&quot;</span><br><span class="line">  fields_under_root: true</span><br><span class="line">    </span><br><span class="line">output.elasticsearch:</span><br><span class="line">  enabled: true</span><br><span class="line">  hosts: [&quot;http://10.0.0.101:9200&quot;,&quot;http://10.0.0.102:9200&quot;,&quot;http://10.0.0.103:9200&quot;]</span><br><span class="line">  index: &quot;oldboyedu-linux-elk%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁用索引生命周期管理</span></span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的名称</span></span><br><span class="line">setup.template.name: &quot;oldboyedu-linux&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的匹配模式</span></span><br><span class="line">setup.template.pattern: &quot;oldboyedu-linux*&quot; </span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h2 id="8-多个索引写入案例"><a href="#8-多个索引写入案例" class="headerlink" title="8.多个索引写入案例"></a>8.多个索引写入案例</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; config/06-log-to-console.yml &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test.log</span><br><span class="line">    - /tmp/*.txt</span><br><span class="line">  tags: [&quot;oldboyedu-linux80&quot;，&quot;容器运维&quot;,&quot;DBA运维&quot;,&quot;SRE运维工程师&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    school: &quot;北京昌平区沙河镇&quot;</span><br><span class="line">    class: &quot;linux80&quot;</span><br><span class="line"></span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test/*/*.log</span><br><span class="line">  tags:[&quot;oldboyedu-python&quot;,&quot;云原生开发&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    name: &quot;oldboy&quot;</span><br><span class="line">    hobby: &quot;linux,抖音&quot;</span><br><span class="line">  fields_under_root: true</span><br><span class="line">    </span><br><span class="line">output.elasticsearch:</span><br><span class="line">  enabled: true</span><br><span class="line">  hosts: [&quot;http://10.0.0.101:9200&quot;,&quot;http://10.0.0.102:9200&quot;,&quot;http://10.0.0.103:9200&quot;]</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">index: <span class="string">&quot;oldboyedu-linux-elk%&#123;+yyyy.MM.dd&#125;&quot;</span></span></span><br><span class="line">  indices:</span><br><span class="line">    - index: &quot;oldboyedu-linux-elk-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      # 匹配指定字段包含的内容</span><br><span class="line">      when.contains:</span><br><span class="line">        tags: &quot;oldboyedu-linux80&quot;</span><br><span class="line">    - index: &quot;oldboyedu-linux-python-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.contains:</span><br><span class="line">        tags: &quot;oldboyedu-python&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁用索引生命周期管理</span></span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的名称</span></span><br><span class="line">setup.template.name: &quot;oldboyedu-linux&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的匹配模式</span></span><br><span class="line">setup.template.pattern: &quot;oldboyedu-linux*&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h2 id="9-自定义分片和副本案例"><a href="#9-自定义分片和副本案例" class="headerlink" title="9.自定义分片和副本案例"></a>9.自定义分片和副本案例</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; config/06-log-to-console.yml &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test.log</span><br><span class="line">    - /tmp/*.txt</span><br><span class="line">  tags: [&quot;oldboyedu-linux80&quot;，&quot;容器运维&quot;,&quot;DBA运维&quot;,&quot;SRE运维工程师&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    school: &quot;北京昌平区沙河镇&quot;</span><br><span class="line">    class: &quot;linux80&quot;</span><br><span class="line"></span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test/*/*.log</span><br><span class="line">  tags:[&quot;oldboyedu-python&quot;,&quot;云原生开发&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    name: &quot;oldboy&quot;</span><br><span class="line">    hobby: &quot;linux,抖音&quot;</span><br><span class="line">  fields_under_root: true</span><br><span class="line">    </span><br><span class="line">output.elasticsearch:</span><br><span class="line">  enabled: true</span><br><span class="line">  hosts: [&quot;http://10.0.0.101:9200&quot;,&quot;http://10.0.0.102:9200&quot;,&quot;http://10.0.0.103:9200&quot;]</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">index: <span class="string">&quot;oldboyedu-linux-elk%&#123;+yyyy.MM.dd&#125;&quot;</span></span></span><br><span class="line">  indices:</span><br><span class="line">    - index: &quot;oldboyedu-linux-elk-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      # 匹配指定字段包含的内容</span><br><span class="line">      when.contains:</span><br><span class="line">        tags: &quot;oldboyedu-linux80&quot;</span><br><span class="line">    - index: &quot;oldboyedu-linux-python-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.contains:</span><br><span class="line">        tags: &quot;oldboyedu-python&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁用索引生命周期管理</span></span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的名称</span></span><br><span class="line">setup.template.name: &quot;oldboyedu-linux&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的匹配模式</span></span><br><span class="line">setup.template.pattern: &quot;oldboyedu-linux*&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">覆盖已有的索引模板</span></span><br><span class="line">setup.template.overwrite: false</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置索引模板</span></span><br><span class="line">setup.template.settings:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">设置分片数量</span></span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">设置副本数量，要求小于集群的数量</span></span><br><span class="line">  index.number_of_replicas: 2</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<p>视频操作：</p>
<p>视频里选用elk102，实际生产环境需要部署到收集日志的服务器上</p>
<p>下载filebeat-7.17.3-x86_64.rpm</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102 ~]# wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.17.3-x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>下载filebeat-7.17.3-linux-x86_64.tar.gz</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102 ~]# wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.17.3-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>

<p>本地安装filebeat</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102 ~]# yum -y localinstall filebeat-7.17.3-x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>查看帮助</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102 ~]# filebeat -h</span><br></pre></td></tr></table></figure>

<p>查看配置文件路径</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102 ~]# systemctl cat filebeat</span><br></pre></td></tr></table></figure>

<p>查看配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102 ~]# egrep -v &quot;^*#|^$&quot; /etc/filebeat/filebeat.yml</span><br></pre></td></tr></table></figure>

<p>备份更名配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102 ~]# mv /etc/filebeat/filebeat.yml /etc/filebeat/filebeat.yml-`date +%F`</span><br></pre></td></tr></table></figure>

<p>手动编写配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102 ~]# vim /etc/filebeat/filebeat.yml</span><br><span class="line">:set paste</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定输入的类型</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定输入的类型为<span class="string">&quot;stdin&quot;</span>,表示标准输入</span></span><br><span class="line">- type: stdin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定输出的类型</span></span><br><span class="line">output.console:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">打印漂亮的格式</span></span><br><span class="line">  pretty: true</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>filebeat实例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input(数据源)    output(目的端)</span><br></pre></td></tr></table></figure>

<p>查看官网配置文档</p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/7.17/index.html">https://www.elastic.co/guide/en/beats/filebeat/7.17/index.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/7.17/filebeat-input-log.html">https://www.elastic.co/guide/en/beats/filebeat/7.17/filebeat-input-log.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/7.17/console-output.html">https://www.elastic.co/guide/en/beats/filebeat/7.17/console-output.html</a></p>
<p>启动服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102 ~]# filebeat -e -c /etc/filebeat/filebeat.yml</span><br></pre></td></tr></table></figure>

<p>创建文件夹，拷贝到文件夹使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102 ~]# mkdir config</span><br><span class="line">[root@elk102 ~]# cp /etc/filebeat/filebeat.yml config/01-stdin-to-console.yml</span><br><span class="line">[root@elk102 ~]# filebeat -e -c ~/config/01-stdin-to-console.yml</span><br></pre></td></tr></table></figure>

<p>参考文档<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/7.17/filebeat-input-log.html">https://www.elastic.co/guide/en/beats/filebeat/7.17/filebeat-input-log.html</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102 ~]# vim config/02-log-to-console.yml</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test.log</span><br><span class="line"></span><br><span class="line">output.console:</span><br><span class="line">  pretty: true</span><br><span class="line">[root@elk102 ~]# filebeat -e -c ~/config/02-log-to-console.yml</span><br></pre></td></tr></table></figure>

<p>查看记录文件，log.json记录了各个文件的offset(偏移量)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102 ~]# ll /var/lib/filebeat/registry/filebeat/</span><br><span class="line">[root@elk102 ~]# cat /var/lib/filebeat/registry/filebeat/log.json</span><br></pre></td></tr></table></figure>

<p>04-log-to-console.yml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# cat ~/config/04-log-to-console.yml</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">是否启动当前的输入类型，默认值为<span class="literal">true</span></span></span><br><span class="line">  enabled: true</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定数据路径</span></span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test.log</span><br><span class="line">    - /tmp/*.txt</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">给当前的输入类型搭上标签</span></span><br><span class="line">  tags: [&quot;oldboyedu-linux80&quot;，&quot;容器运维&quot;,&quot;DBA运维&quot;,&quot;SRE运维工程师&quot;]</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">自定义字段</span></span><br><span class="line">  fields:</span><br><span class="line">    school: &quot;北京昌平区沙河镇&quot;</span><br><span class="line">    class: &quot;linux80&quot;</span><br><span class="line"></span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test/*/*.log</span><br><span class="line">  tags:[&quot;oldboyedu-python&quot;,&quot;云原生开发&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    name: &quot;oldboy&quot;</span><br><span class="line">    hobby: &quot;linux,抖音&quot;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">将自定义字段的key-value放到顶级字段</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">默认值为<span class="literal">false</span>，会将数据放在一个叫<span class="string">&quot;fields&quot;</span>字段的下面</span></span><br><span class="line">  fields_under_root: true</span><br><span class="line">    </span><br><span class="line">output.console:</span><br><span class="line">  pretty: true</span><br></pre></td></tr></table></figure>

<p>05-log-to-es.yml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# cat ~/config/05-log-to-es.yml</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test.log</span><br><span class="line">    - /tmp/*.txt</span><br><span class="line">  tags: [&quot;oldboyedu-linux80&quot;，&quot;容器运维&quot;,&quot;DBA运维&quot;,&quot;SRE运维工程师&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    school: &quot;北京昌平区沙河镇&quot;</span><br><span class="line">    class: &quot;linux80&quot;</span><br><span class="line"></span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test/*/*.log</span><br><span class="line">  tags:[&quot;oldboyedu-python&quot;,&quot;云原生开发&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    name: &quot;oldboy&quot;</span><br><span class="line">    hobby: &quot;linux,抖音&quot;</span><br><span class="line">  fields_under_root: true</span><br><span class="line">    </span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;http://10.0.0.101:9200&quot;,&quot;http://10.0.0.102:9200&quot;,&quot;http://10.0.0.103:9200&quot;]</span><br></pre></td></tr></table></figure>

<p>06-log-to-es.yml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# cat ~/config/06-log-to-es.yml</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test.log</span><br><span class="line">    - /tmp/*.txt</span><br><span class="line">  tags: [&quot;oldboyedu-linux80&quot;，&quot;容器运维&quot;,&quot;DBA运维&quot;,&quot;SRE运维工程师&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    school: &quot;北京昌平区沙河镇&quot;</span><br><span class="line">    class: &quot;linux80&quot;</span><br><span class="line"></span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test/*/*.log</span><br><span class="line">  tags:[&quot;oldboyedu-python&quot;,&quot;云原生开发&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    name: &quot;oldboy&quot;</span><br><span class="line">    hobby: &quot;linux,抖音&quot;</span><br><span class="line">  fields_under_root: true</span><br><span class="line">    </span><br><span class="line">output.elasticsearch:</span><br><span class="line">  enabled: true</span><br><span class="line">  hosts: [&quot;http://10.0.0.101:9200&quot;,&quot;http://10.0.0.102:9200&quot;,&quot;http://10.0.0.103:9200&quot;]</span><br><span class="line">  index: &quot;oldboyedu-linux-elk-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁用索引生命周期管理</span></span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的名称</span></span><br><span class="line">setup.template.name: &quot;oldboyedu-linux&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的匹配模式</span></span><br><span class="line">setup.template.pattern: &quot;oldboyedu-linux*&quot; </span><br></pre></td></tr></table></figure>

<p>07-log-to-es.yml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# cat ~/config/07-log-to-es.yml</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test.log</span><br><span class="line">    - /tmp/*.txt</span><br><span class="line">  tags: [&quot;oldboyedu-linux80&quot;，&quot;容器运维&quot;,&quot;DBA运维&quot;,&quot;SRE运维工程师&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    school: &quot;北京昌平区沙河镇&quot;</span><br><span class="line">    class: &quot;linux80&quot;</span><br><span class="line"></span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test/*/*.log</span><br><span class="line">  tags:[&quot;oldboyedu-python&quot;,&quot;云原生开发&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    name: &quot;oldboy&quot;</span><br><span class="line">    hobby: &quot;linux,抖音&quot;</span><br><span class="line">  fields_under_root: true</span><br><span class="line">    </span><br><span class="line">output.elasticsearch:</span><br><span class="line">  enabled: true</span><br><span class="line">  hosts: [&quot;http://10.0.0.101:9200&quot;,&quot;http://10.0.0.102:9200&quot;,&quot;http://10.0.0.103:9200&quot;]</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">index: <span class="string">&quot;oldboyedu-linux-elk-%&#123;+yyyy.MM.dd&#125;&quot;</span></span></span><br><span class="line">  indices:</span><br><span class="line">    - index: &quot;oldboyedu-linux-elk-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      # 匹配指定字段包含的内容</span><br><span class="line">      when.contains:</span><br><span class="line">        tags: &quot;oldboyedu-linux80&quot;</span><br><span class="line">    - index: &quot;oldboyedu-linux-python-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.contains:</span><br><span class="line">        tags: &quot;oldboyedu-python&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁用索引生命周期管理</span></span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的名称</span></span><br><span class="line">setup.template.name: &quot;oldboyedu-linux&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的匹配模式</span></span><br><span class="line">setup.template.pattern: &quot;oldboyedu-linux*&quot;</span><br></pre></td></tr></table></figure>

<p>08-log-to-es.yml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# cat ~/config/08-log-to-es.yml</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test.log</span><br><span class="line">    - /tmp/*.txt</span><br><span class="line">  tags: [&quot;oldboyedu-linux80&quot;，&quot;容器运维&quot;,&quot;DBA运维&quot;,&quot;SRE运维工程师&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    school: &quot;北京昌平区沙河镇&quot;</span><br><span class="line">    class: &quot;linux80&quot;</span><br><span class="line"></span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test/*/*.log</span><br><span class="line">  tags:[&quot;oldboyedu-python&quot;,&quot;云原生开发&quot;]</span><br><span class="line">  fields:</span><br><span class="line">    name: &quot;oldboy&quot;</span><br><span class="line">    hobby: &quot;linux,抖音&quot;</span><br><span class="line">  fields_under_root: true</span><br><span class="line">    </span><br><span class="line">output.elasticsearch:</span><br><span class="line">  enabled: true</span><br><span class="line">  hosts: [&quot;http://10.0.0.101:9200&quot;,&quot;http://10.0.0.102:9200&quot;,&quot;http://10.0.0.103:9200&quot;]</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">index: <span class="string">&quot;oldboyedu-linux-elk-%&#123;+yyyy.MM.dd&#125;&quot;</span></span></span><br><span class="line">  indices:</span><br><span class="line">    - index: &quot;oldboyedu-linux-elk-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      # 匹配指定字段包含的内容</span><br><span class="line">      when.contains:</span><br><span class="line">        tags: &quot;oldboyedu-linux80&quot;</span><br><span class="line">    - index: &quot;oldboyedu-linux-python-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.contains:</span><br><span class="line">        tags: &quot;oldboyedu-python&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁用索引生命周期管理</span></span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的名称</span></span><br><span class="line">setup.template.name: &quot;oldboyedu-linux&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的匹配模式</span></span><br><span class="line">setup.template.pattern: &quot;oldboyedu-linux*&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">覆盖已有的索引模板</span></span><br><span class="line">setup.template.overwrite: false</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置索引模板</span></span><br><span class="line">setup.template.settings:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">设置分片数量</span></span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">设置副本数量，要求小于集群的数量</span></span><br><span class="line">  index.number_of_replicas: 2</span><br></pre></td></tr></table></figure>



<p>3分片1副本</p>
<p>分片数量配置后可以修改吗？ — 不可以！</p>
<p>副本数量配置后可以修改吗？ — 可以</p>
<p><strong>集群颜色：</strong></p>
<p>​	Red：集群的部分主分片无法访问。</p>
<p>​	Yellow：集群的部分副本分片无法访问。</p>
<p>​	Green：集群的主分片和副本分片可以访问。</p>
<p><strong>主分片和副本分片的区别：</strong></p>
<p>​	(1)主分片可以读写，即rw</p>
<p>​	(2)副本分片只读，即ro</p>
<p><strong>filebeat</strong>：(数据采集，数据传输)</p>
<p>​	input —&gt; 指定源数据</p>
<p>​	outout —&gt; 指定数据的目的地</p>
<p><strong>ElasticSearch</strong>：(简称ES，存储，查询，分析)</p>
<p>​	索引(index) —&gt; 数据的逻辑存储名称。</p>
<p>​	分片(shard) —&gt; 一个索引至少有一个或多个分片。</p>
<p>​	副本(replica) —&gt; 一个分片至少有0个或多个副本。</p>
<p><strong>Kibana</strong>：(数据展示)</p>
<p>​	索引模式 —&gt; ES上的索引。</p>
<p>​	创建索引模式时至少匹配一个或多个索引。</p>
<h1 id="八-EFK架构企业级实战案例"><a href="#八-EFK架构企业级实战案例" class="headerlink" title="八.EFK架构企业级实战案例"></a>八.EFK架构企业级实战案例</h1><h2 id="1-部署nginx服务"><a href="#1-部署nginx服务" class="headerlink" title="1.部署nginx服务"></a>1.部署nginx服务</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(1)安装nginx服务并启动</span><br><span class="line">cat &gt; /etc/yum.repos.d/nginx.repo &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=true</span><br><span class="line"></span><br><span class="line">[nginx-mainline]</span><br><span class="line">name=nginx mainline repo</span><br><span class="line">baseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=true</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">(2)安装nginx服务</span><br><span class="line">yum -y install nginx</span><br><span class="line"></span><br><span class="line">(3)启动nginx服务</span><br><span class="line">systemctl start nginx</span><br></pre></td></tr></table></figure>





<h2 id="2-基于log类型收集nginx原生日志"><a href="#2-基于log类型收集nginx原生日志" class="headerlink" title="2.基于log类型收集nginx原生日志"></a>2.基于log类型收集nginx原生日志</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/nginx/access.log*</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;access&quot;</span>]</span><br><span class="line">    </span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;http://10.0.0.101:9200&quot;</span>,<span class="string">&quot;http://10.0.0.102:9200&quot;</span>,<span class="string">&quot;http://10.0.0.103:9200&quot;</span>]</span><br><span class="line">  <span class="attr">index:</span> <span class="string">&quot;oldboyedu-linux-nginx-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用索引生命周期管理</span></span><br><span class="line"><span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># 设置索引模板的名称</span></span><br><span class="line"><span class="attr">setup.template.name:</span> <span class="string">&quot;oldboyedu-linux&quot;</span></span><br><span class="line"><span class="comment"># 设置索引模板的匹配模式</span></span><br><span class="line"><span class="attr">setup.template.pattern:</span> <span class="string">&quot;oldboyedu-linux*&quot;</span></span><br><span class="line"><span class="comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span></span><br><span class="line"><span class="attr">setup.template.overwrite:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 配置索引模板</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="comment"># 设置分片数量</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># 设置副本数量，要求小于集群的数量</span></span><br><span class="line">  <span class="attr">index.number_of_replicas:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>视频操作：</p>
<p>09-nginx-to-es.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/09-nginx-to-es.yml</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/nginx/access.log*</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;access&quot;</span>]</span><br><span class="line">    </span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;http://10.0.0.101:9200&quot;</span>,<span class="string">&quot;http://10.0.0.102:9200&quot;</span>,<span class="string">&quot;http://10.0.0.103:9200&quot;</span>]</span><br><span class="line">  <span class="attr">index:</span> <span class="string">&quot;oldboyedu-linux-nginx-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用索引生命周期管理</span></span><br><span class="line"><span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># 设置索引模板的名称</span></span><br><span class="line"><span class="attr">setup.template.name:</span> <span class="string">&quot;oldboyedu-linux&quot;</span></span><br><span class="line"><span class="comment"># 设置索引模板的匹配模式</span></span><br><span class="line"><span class="attr">setup.template.pattern:</span> <span class="string">&quot;oldboyedu-linux*&quot;</span></span><br><span class="line"><span class="comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span></span><br><span class="line"><span class="attr">setup.template.overwrite:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 配置索引模板</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="comment"># 设置分片数量</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># 设置副本数量，要求小于集群的数量</span></span><br><span class="line">  <span class="attr">index.number_of_replicas:</span> <span class="number">0</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -e -c ~/config/09-nginx-to-es.yml</span></span><br></pre></td></tr></table></figure>





<h2 id="3-基于log类型收集nginx的json日志"><a href="#3-基于log类型收集nginx的json日志" class="headerlink" title="3.基于log类型收集nginx的json日志"></a>3.基于log类型收集nginx的json日志</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(1)修改nginx的源日志格式</span><br><span class="line">vim /etc/nginx/nginx.conf</span><br><span class="line">...</span><br><span class="line">  log_format oldboyedu_nginx_json &#x27;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;host&quot;:&quot;$server_addr&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;clientip&quot;:&quot;$remote_addr&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;SendBytes&quot;:$body_bytes_sent,&#x27;</span><br><span class="line">                              &#x27;&quot;responsetime&quot;:$request_time,&#x27;</span><br><span class="line">                              &#x27;&quot;upstreamtime&quot;:&quot;$upstream_response_time&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;upstreamhost&quot;:&quot;$upstream_addr&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;http_host&quot;:&quot;$host&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;uri&quot;:&quot;$uri&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;domain&quot;:&quot;$host&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;xff&quot;:&quot;$http_x_forwarded_for&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;referer&quot;:&quot;$http_referer&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;tcp_xff&quot;:&quot;$proxy_protocol_addr&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;http_user_agent&quot;:&quot;$http_user_agent&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;status&quot;:&quot;$status&quot;&#125;&#x27;;</span><br><span class="line">                              </span><br><span class="line">  access_log /var/log/nginx/access.log oldboyedu_nginx_json;</span><br><span class="line"></span><br><span class="line">(2)检查nginx的配置文件语法并重启nginx服务</span><br><span class="line">nginx -t</span><br><span class="line">systemctl restart nginx</span><br></pre></td></tr></table></figure>

<p>视频操作：</p>
<p>10-nginx-to-es.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/10-nginx-to-es.yml</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/nginx/access.log*</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;access&quot;</span>]</span><br><span class="line">  <span class="attr">json.keys_under_root:</span> <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;http://10.0.0.101:9200&quot;</span>,<span class="string">&quot;http://10.0.0.102:9200&quot;</span>,<span class="string">&quot;http://10.0.0.103:9200&quot;</span>]</span><br><span class="line">  <span class="attr">index:</span> <span class="string">&quot;oldboyedu-linux-nginx-access-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用索引生命周期管理</span></span><br><span class="line"><span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># 设置索引模板的名称</span></span><br><span class="line"><span class="attr">setup.template.name:</span> <span class="string">&quot;oldboyedu-linux&quot;</span></span><br><span class="line"><span class="comment"># 设置索引模板的匹配模式</span></span><br><span class="line"><span class="attr">setup.template.pattern:</span> <span class="string">&quot;oldboyedu-linux*&quot;</span></span><br><span class="line"><span class="comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span></span><br><span class="line"><span class="attr">setup.template.overwrite:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 配置索引模板</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="comment"># 设置分片数量</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># 设置副本数量，要求小于集群的数量</span></span><br><span class="line">  <span class="attr">index.number_of_replicas:</span> <span class="number">0</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -e -c ~/config/10-nginx-to-es.yml</span></span><br></pre></td></tr></table></figure>



<h2 id="4-基于模块采集nginx日志文件"><a href="#4-基于模块采集nginx日志文件" class="headerlink" title="4.基于模块采集nginx日志文件"></a>4.基于模块采集nginx日志文件</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/11-nginx-to-es.yml</span></span><br><span class="line"><span class="attr">filebeat.config.modules:</span></span><br><span class="line">  <span class="comment"># 指定模块的配置文件路径，如果是yum方式安装，在7.17.3版本中不能使用如下的默认值.</span></span><br><span class="line">  <span class="comment">#   path: $&#123;path.config&#125;/modules.d/*.yml</span></span><br><span class="line">  <span class="comment"># 经过实际测试，推荐大家使用如下的配置，此处写绝对路径即可!而对于二进制部署无需做此操作.</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/etc/filebeat/modules.d/*.yml</span></span><br><span class="line">  <span class="comment"># 开启热加载功能</span></span><br><span class="line">  <span class="attr">reload.enabled:</span> <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;http://10.0.0.101:9200&quot;</span>,<span class="string">&quot;http://10.0.0.102:9200&quot;</span>,<span class="string">&quot;http://10.0.0.103:9200&quot;</span>]</span><br><span class="line">  <span class="attr">index:</span> <span class="string">&quot;oldboyedu-linux-nginx-access-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用索引生命周期管理</span></span><br><span class="line"><span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># 设置索引模板的名称</span></span><br><span class="line"><span class="attr">setup.template.name:</span> <span class="string">&quot;oldboyedu-linux&quot;</span></span><br><span class="line"><span class="comment"># 设置索引模板的匹配模式</span></span><br><span class="line"><span class="attr">setup.template.pattern:</span> <span class="string">&quot;oldboyedu-linux*&quot;</span></span><br><span class="line"><span class="comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span></span><br><span class="line"><span class="attr">setup.template.overwrite:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 配置索引模板</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="comment"># 设置分片数量</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># 设置副本数量，要求小于集群的数量</span></span><br><span class="line">  <span class="attr">index.number_of_replicas:</span> <span class="number">0</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -c ~/config/11-nginx-to-es.yml modules list</span></span><br><span class="line"><span class="comment"># 启用modules</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -c ~/config/11-nginx-to-es.yml modules enable nginx tomcat</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -c ~/config/11-nginx-to-es.yml modules list</span></span><br><span class="line"><span class="comment"># 关闭modules</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -c ~/config/11-nginx-to-es.yml modules disable nginx tomcat</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># vim /etc/filebeat/modules.d/nginx.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">module:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">access:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">var.paths:</span> [<span class="string">&quot;/var/log/nginx/access.log*&quot;</span>]</span><br><span class="line">  <span class="attr">error:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">var.paths:</span> [<span class="string">&quot;/var/log/nginx/error.log*&quot;</span>]</span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -e -c ~/config/11-nginx-to-es.yml</span></span><br></pre></td></tr></table></figure>



<h2 id="5-基于模块采集tomcat日志文件"><a href="#5-基于模块采集tomcat日志文件" class="headerlink" title="5.基于模块采集tomcat日志文件"></a>5.基于模块采集tomcat日志文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">(1)部署tomcat服务</span><br><span class="line">    1)解压tomcat软件包</span><br><span class="line">tar xf apache-tomcat-10.0.20.tar.gz -C /oldboyedu/softwares/</span><br><span class="line"></span><br><span class="line">    2)创建符号链接</span><br><span class="line">cd /oldboyedu/softwares/ &amp;&amp; ln -sv apache-tomcat-10.0.20 tomcat</span><br><span class="line"></span><br><span class="line">    3)配置环境变量</span><br><span class="line">vim /etc/profile.d/elk.sh</span><br><span class="line">...</span><br><span class="line">export TOMCAT_HOME=/oldboyedu/softwares/tomcat</span><br><span class="line">export JAVA_HOME=/usr/share/elasticsearch/jdk</span><br><span class="line">export PATH=$PATH:$TOMCAT_HOME/bin:$JAVA_HOME/bin</span><br><span class="line"></span><br><span class="line">    4)使得环境变量生效</span><br><span class="line">source /etc/profile.d/elk.sh</span><br><span class="line"></span><br><span class="line">    5)启动服务</span><br><span class="line">catalina.sh start</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(2)启用tomcat的模块管理</span><br><span class="line">filebeat -c ~/config/11-nginx-to-es.yml modules disable nginx</span><br><span class="line">filebeat -c ~/config/11-nginx-to-es.yml modules enable tomcat</span><br><span class="line">filebeat -c ~/config/11-nginx-to-es.yml modules list | head</span><br></pre></td></tr></table></figure>

<p>12-tomcat-to-es.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/12-tomcat-to-es.yml</span></span><br><span class="line"><span class="attr">filebeat.config.modules:</span></span><br><span class="line">  <span class="comment"># 指定模块的配置文件路径，如果是yum方式安装，在7.17.3版本中不能使用如下的默认值.</span></span><br><span class="line">  <span class="comment">#   path: $&#123;path.config&#125;/modules.d/*.yml</span></span><br><span class="line">  <span class="comment"># 经过实际测试，推荐大家使用如下的配置，此处写绝对路径即可!而对于二进制部署无需做此操作.</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/etc/filebeat/modules.d/*.yml</span></span><br><span class="line">  <span class="comment"># 开启热加载功能</span></span><br><span class="line">  <span class="attr">reload.enabled:</span> <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;http://10.0.0.101:9200&quot;</span>,<span class="string">&quot;http://10.0.0.102:9200&quot;</span>,<span class="string">&quot;http://10.0.0.103:9200&quot;</span>]</span><br><span class="line">  <span class="attr">index:</span> <span class="string">&quot;oldboyedu-linux-tomcat-access-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用索引生命周期管理</span></span><br><span class="line"><span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># 设置索引模板的名称</span></span><br><span class="line"><span class="attr">setup.template.name:</span> <span class="string">&quot;oldboyedu-linux&quot;</span></span><br><span class="line"><span class="comment"># 设置索引模板的匹配模式</span></span><br><span class="line"><span class="attr">setup.template.pattern:</span> <span class="string">&quot;oldboyedu-linux*&quot;</span></span><br><span class="line"><span class="comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span></span><br><span class="line"><span class="attr">setup.template.overwrite:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 配置索引模板</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="comment"># 设置分片数量</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># 设置副本数量，要求小于集群的数量</span></span><br><span class="line">  <span class="attr">index.number_of_replicas:</span> <span class="number">0</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -c ~/config/11-nginx-to-es.yml modules list</span></span><br><span class="line"><span class="comment"># 启用modules</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -c ~/config/11-nginx-to-es.yml modules enable nginx tomcat</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -c ~/config/11-nginx-to-es.yml modules list</span></span><br><span class="line"><span class="comment"># 关闭modules</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -c ~/config/11-nginx-to-es.yml modules disable nginx tomcat</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># vim /etc/filebeat/modules.d/nginx.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">module:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">access:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">var.paths:</span> [<span class="string">&quot;/var/log/nginx/access.log*&quot;</span>]</span><br><span class="line">  <span class="attr">error:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">var.paths:</span> [<span class="string">&quot;/var/log/nginx/error.log*&quot;</span>]</span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># vim /etc/filebeat/modules.d/tomcat.yml</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">module:</span> <span class="string">tomcat</span></span><br><span class="line">  <span class="attr">log:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">var.input:</span> <span class="string">file</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">var.paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/oldboyedu/softwares/apache-tomcat-10.0.20/logs/*.txt</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -e -c ~/config/12-tomcat-to-es.yml</span></span><br></pre></td></tr></table></figure>



<h2 id="6-基于log类型收集tomcat的原生日志"><a href="#6-基于log类型收集tomcat的原生日志" class="headerlink" title="6.基于log类型收集tomcat的原生日志"></a>6.基于log类型收集tomcat的原生日志</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/13-tomcat-to-es.yml</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/oldboyedu/softwares/apache-tomcat-10.0.20/logs/*.txt</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;http://10.0.0.101:9200&quot;</span>,<span class="string">&quot;http://10.0.0.102:9200&quot;</span>,<span class="string">&quot;http://10.0.0.103:9200&quot;</span>]</span><br><span class="line">  <span class="attr">index:</span> <span class="string">&quot;oldboyedu-linux-tomcat-access-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用索引生命周期管理</span></span><br><span class="line"><span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># 设置索引模板的名称</span></span><br><span class="line"><span class="attr">setup.template.name:</span> <span class="string">&quot;oldboyedu-linux&quot;</span></span><br><span class="line"><span class="comment"># 设置索引模板的匹配模式</span></span><br><span class="line"><span class="attr">setup.template.pattern:</span> <span class="string">&quot;oldboyedu-linux*&quot;</span></span><br><span class="line"><span class="comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span></span><br><span class="line"><span class="attr">setup.template.overwrite:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 配置索引模板</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="comment"># 设置分片数量</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># 设置副本数量，要求小于集群的数量</span></span><br><span class="line">  <span class="attr">index.number_of_replicas:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>



<h2 id="7-基于log类型收集tomcat的json日志"><a href="#7-基于log类型收集tomcat的json日志" class="headerlink" title="7.基于log类型收集tomcat的json日志"></a>7.基于log类型收集tomcat的json日志</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">(1)自定义tomcat的日志格式</span><br><span class="line">cp /oldboyedu/softwares/apache-tomcat-10.0.20/conf/&#123;server.xml,server.xml-`date +%F`&#125;</span><br><span class="line">...(切换到行尾修改，大概是在133-149之间)</span><br><span class="line">          &lt;Host name=&quot;tomcat.oldboyedu.com&quot; appBase=&quot;webapps&quot;</span><br><span class="line">                unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</span><br><span class="line">                </span><br><span class="line">          &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;</span><br><span class="line">              prefix=&quot;tomcat.oldboyedu.com_access_log&quot; suffix=&quot;.txt&quot;</span><br><span class="line">pattern=&quot;&#123;&amp;quot;clientip&amp;quot;:&amp;quot;%h&amp;quot;,&amp;quot;ClientUser&amp;quot;:&amp;quot;%l&amp;quot;,&amp;quot;authenticated&amp;quot;:&amp;quot;%u&amp;quot;,&amp;quot;AccessTime&amp;quot;:&amp;quot;%t&amp;quot;,&amp;quot;request&amp;quot;:&amp;quot;%r&amp;quot;,&amp;quot;status&amp;quot;:&amp;quot;%s&amp;quot;,&amp;quot;SendBytes&amp;quot;:&amp;quot;%b&amp;quot;,&amp;quot;Query?string&amp;quot;:&amp;quot;%q&amp;quot;,&amp;quot;partner&amp;quot;:&amp;quot;%&#123;Referer&#125;i&amp;quot;,&amp;quot;http_user_agent&amp;quot;:&amp;quot;%&#123;User-Agent&#125;i&amp;quot;&#125;&quot;/&gt;</span><br><span class="line"></span><br><span class="line">          &lt;/Host&gt;</span><br><span class="line">          </span><br><span class="line">(2)修改filebeat的配置文件</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /oldboyedu/softwares/apache-tomcat-10.0.20/logs/*.txt</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">解析message字段的json格式，并放在顶级字段中</span></span><br><span class="line">  json.keys_under_root: true</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  enabled: true</span><br><span class="line">  hosts: [&quot;http://10.0.0.101:9200&quot;,&quot;http://10.0.0.102:9200&quot;,&quot;http://10.0.0.103:9200&quot;]</span><br><span class="line">  index: &quot;oldboyedu-linux-tomcat-access-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁用索引生命周期管理</span></span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的名称</span></span><br><span class="line">setup.template.name: &quot;oldboyedu-linux&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的匹配模式</span></span><br><span class="line">setup.template.pattern: &quot;oldboyedu-linux*&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">覆盖已有的索引模板，如果为<span class="literal">true</span>，则会直接覆盖现有的索引模板，如果为<span class="literal">false</span>则不覆盖!</span></span><br><span class="line">setup.template.overwrite: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置索引模板</span></span><br><span class="line">setup.template.settings:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">设置分片数量</span></span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">设置副本数量，要求小于集群的数量</span></span><br><span class="line">  index.number_of_replicas: 0</span><br></pre></td></tr></table></figure>



<h2 id="8-多行匹配-收集tomcat的错误日志"><a href="#8-多行匹配-收集tomcat的错误日志" class="headerlink" title="8.多行匹配-收集tomcat的错误日志"></a>8.多行匹配-收集tomcat的错误日志</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# cat ~/config/15-tomcat-to-es.yml</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: false</span><br><span class="line">  paths:</span><br><span class="line">    - /oldboyedu/softwares/apache-tomcat-10.0.20/logs/*.txt</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">解析message字段的json格式，并放在顶级字段中</span></span><br><span class="line">  json.keys_under_root: true</span><br><span class="line"></span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /oldboyedu/softwares/apache-tomcat-10.0.20/logs/*.out</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定多行匹配的类型，可选值为<span class="string">&quot;pattern&quot;</span>,<span class="string">&quot;count&quot;</span></span></span><br><span class="line">  multiline.type: pattern</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定匹配模式</span></span><br><span class="line">  multiline.pattern: &#x27;^\d&#123;2&#125;&#x27;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">下面2个参数参考官方架构图即可</span></span><br><span class="line">  multiline.negate: true</span><br><span class="line">  multiline.match: after</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  enabled: true</span><br><span class="line">  hosts: [&quot;http://10.0.0.101:9200&quot;,&quot;http://10.0.0.102:9200&quot;,&quot;http://10.0.0.103:9200&quot;]</span><br><span class="line">  index: &quot;oldboyedu-linux-tomcat-error-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁用索引生命周期管理</span></span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的名称</span></span><br><span class="line">setup.template.name: &quot;oldboyedu-linux&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的匹配模式</span></span><br><span class="line">setup.template.pattern: &quot;oldboyedu-linux*&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">覆盖已有的索引模板，如果为<span class="literal">true</span>，则会直接覆盖现有的索引模板，如果为<span class="literal">false</span>则不覆盖!</span></span><br><span class="line">setup.template.overwrite: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置索引模板</span></span><br><span class="line">setup.template.settings:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">设置分片数量</span></span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">设置副本数量，要求小于集群的数量</span></span><br><span class="line">  index.number_of_replicas: 0</span><br><span class="line">[root@elk102.oldboyedu.com ~]# rm -rf /var/lib/filebeat/*</span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -e -c ~/config/15-tomcat-to-es.yml</span><br></pre></td></tr></table></figure>



<h2 id="9-多行匹配-收集elasticsearch的错误日志"><a href="#9-多行匹配-收集elasticsearch的错误日志" class="headerlink" title="9.多行匹配-收集elasticsearch的错误日志"></a>9.多行匹配-收集elasticsearch的错误日志</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# cat ~/config/16-eslog-to-es.yml</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/elasticsearch/oldboyedu-elk-2022.log*</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定多行匹配的类型，可选值为<span class="string">&quot;pattern&quot;</span>,<span class="string">&quot;count&quot;</span></span></span><br><span class="line">  multiline.type: pattern</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定匹配模式</span></span><br><span class="line">  multiline.pattern: &#x27;^\[&#x27;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">下面2个参数参考官方架构图即可</span></span><br><span class="line">  multiline.negate: true</span><br><span class="line">  multiline.match: after</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  enabled: true</span><br><span class="line">  hosts: [&quot;http://10.0.0.101:9200&quot;,&quot;http://10.0.0.102:9200&quot;,&quot;http://10.0.0.103:9200&quot;]</span><br><span class="line">  index: &quot;oldboyedu-linux-es-error-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁用索引生命周期管理</span></span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的名称</span></span><br><span class="line">setup.template.name: &quot;oldboyedu-linux&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的匹配模式</span></span><br><span class="line">setup.template.pattern: &quot;oldboyedu-linux*&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">覆盖已有的索引模板，如果为<span class="literal">true</span>，则会直接覆盖现有的索引模板，如果为<span class="literal">false</span>则不覆盖!</span></span><br><span class="line">setup.template.overwrite: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置索引模板</span></span><br><span class="line">setup.template.settings:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">设置分片数量</span></span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">设置副本数量，要求小于集群的数量</span></span><br><span class="line">  index.number_of_replicas: 0</span><br><span class="line">[root@elk102.oldboyedu.com ~]# rm -rf /var/lib/filebeat/*</span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -e -c ~/config/16-eslog-to-es.yml</span><br></pre></td></tr></table></figure>



<h2 id="10-nginx错误日志过滤"><a href="#10-nginx错误日志过滤" class="headerlink" title="10.nginx错误日志过滤"></a>10.nginx错误日志过滤</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/18-nginx-to-es.yml</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/nginx/access.log*</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;access&quot;</span>]</span><br><span class="line">  <span class="comment"># 解析message字段的json格式，并放在顶级字段中</span></span><br><span class="line">  <span class="attr">json.keys_under_root:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/nginx/error.log*</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;error&quot;</span>]</span><br><span class="line">  <span class="attr">include_lines:</span> [<span class="string">&#x27;\[error\]&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;http://10.0.0.101:9200&quot;</span>,<span class="string">&quot;http://10.0.0.102:9200&quot;</span>,<span class="string">&quot;http://10.0.0.103:9200&quot;</span>]</span><br><span class="line">  <span class="comment"># index: &quot;oldboyedu-linux-elk-%&#123;+yyyy.MM.dd&#125;&quot;</span></span><br><span class="line">  <span class="attr">indices:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;oldboyedu-linux-web-nginx-access-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">      <span class="comment"># 匹配指定字段包含的内容</span></span><br><span class="line">      <span class="attr">when.contains:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">&quot;access&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;oldboyedu-linux-web-nginx-error-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">when.contains:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">&quot;error&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用索引生命周期管理</span></span><br><span class="line"><span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># 设置索引模板的名称</span></span><br><span class="line"><span class="attr">setup.template.name:</span> <span class="string">&quot;oldboyedu-linux&quot;</span></span><br><span class="line"><span class="comment"># 设置索引模板的匹配模式</span></span><br><span class="line"><span class="attr">setup.template.pattern:</span> <span class="string">&quot;oldboyedu-linux*&quot;</span></span><br><span class="line"><span class="comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span></span><br><span class="line"><span class="attr">setup.template.overwrite:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 配置索引模板</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="comment"># 设置分片数量</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># 设置副本数量，要求小于集群的数量</span></span><br><span class="line">  <span class="attr">index.number_of_replicas:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>视频操作：</p>
<p>17-log-to-console.yml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# cat ~/config/17-log-to-console.yml</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/test/*.log</span><br><span class="line">    # 注意，黑白名单均支持通配符，生产环境中不建议同时使用.</span><br><span class="line">    # 指定白名单，包含指定的内容才会采集，且区分大小写!</span><br><span class="line">    # include_lines: [&#x27;^ERR&#x27;,&#x27;^WARN&#x27;,&#x27;oldboyedu&#x27;]</span><br><span class="line">    # 指定黑名单，排除指定的内容</span><br><span class="line">    exclude_lines: [&#x27;^DBG&#x27;,&quot;linux&quot;]</span><br><span class="line"></span><br><span class="line">output.console:</span><br><span class="line">  pretty: true</span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -e -c ~/config/17-log-to-console.yml</span><br></pre></td></tr></table></figure>



<h2 id="11-nginx和tomcat同时采集案例"><a href="#11-nginx和tomcat同时采集案例" class="headerlink" title="11.nginx和tomcat同时采集案例"></a>11.nginx和tomcat同时采集案例</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/19-web-to-es.yml</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/nginx/access.log*</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;nginx-access&quot;</span>]</span><br><span class="line">  <span class="comment"># 解析message字段的json格式，并放在顶级字段中</span></span><br><span class="line">  <span class="attr">json.keys_under_root:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/nginx/error.log*</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;nginx-error&quot;</span>]</span><br><span class="line">  <span class="attr">include_lines:</span> [<span class="string">&#x27;\[error\]&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/oldboyedu/softwares/apache-tomcat-10.0.20/logs/*.txt</span></span><br><span class="line">  <span class="comment"># 解析message字段的json格式，并放在顶级字段中</span></span><br><span class="line">  <span class="attr">json.keys_under_root:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;tomcat-access&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/oldboyedu/softwares/apache-tomcat-10.0.20/logs/*.out</span></span><br><span class="line">  <span class="comment"># 指定多行匹配的类型，可选值为&quot;pattern&quot;,&quot;count&quot;</span></span><br><span class="line">  <span class="attr">multiline.type:</span> <span class="string">pattern</span></span><br><span class="line">  <span class="comment"># 指定匹配模式</span></span><br><span class="line">  <span class="attr">multiline.pattern:</span> <span class="string">&#x27;^\d&#123;2&#125;&#x27;</span></span><br><span class="line">  <span class="comment"># 下面2个参数参考官方架构图即可</span></span><br><span class="line">  <span class="attr">multiline.negate:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">multiline.match:</span> <span class="string">after</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;tomcat-error&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;http://10.0.0.101:9200&quot;</span>,<span class="string">&quot;http://10.0.0.102:9200&quot;</span>,<span class="string">&quot;http://10.0.0.103:9200&quot;</span>]</span><br><span class="line">  <span class="comment"># index: &quot;oldboyedu-linux-elk-%&#123;+yyyy.MM.dd&#125;&quot;</span></span><br><span class="line">  <span class="attr">indices:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;oldboyedu-linux-web-nginx-access-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">      <span class="comment"># 匹配指定字段包含的内容</span></span><br><span class="line">      <span class="attr">when.contains:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">&quot;nginx-access&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;oldboyedu-linux-web-nginx-error-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">when.contains:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">&quot;nginx-error&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;oldboyedu-linux-web-tomcat-access-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">when.contains:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">&quot;tomcat-access&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;oldboyedu-linux-web-tomcat-error-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">when.contains:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">&quot;tomcat-error&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用索引生命周期管理</span></span><br><span class="line"><span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># 设置索引模板的名称</span></span><br><span class="line"><span class="attr">setup.template.name:</span> <span class="string">&quot;oldboyedu-linux&quot;</span></span><br><span class="line"><span class="comment"># 设置索引模板的匹配模式</span></span><br><span class="line"><span class="attr">setup.template.pattern:</span> <span class="string">&quot;oldboyedu-linux*&quot;</span></span><br><span class="line"><span class="comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span></span><br><span class="line"><span class="attr">setup.template.overwrite:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 配置索引模板</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="comment"># 设置分片数量</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># 设置副本数量，要求小于集群的数量</span></span><br><span class="line">  <span class="attr">index.number_of_replicas:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -e -c ~/config/19-web-to-es.yml</span></span><br></pre></td></tr></table></figure>



<h2 id="12-input插件filestream类型案例"><a href="#12-input插件filestream类型案例" class="headerlink" title="12.input插件filestream类型案例"></a>12.input插件filestream类型案例</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>







<h1 id="九-filebeat企业常见案例-EFK架构"><a href="#九-filebeat企业常见案例-EFK架构" class="headerlink" title="九.filebeat企业常见案例(EFK架构)"></a>九.filebeat企业常见案例(EFK架构)</h1><h2 id="1-使用filebeat收集nginx日志到es集群"><a href="#1-使用filebeat收集nginx日志到es集群" class="headerlink" title="1.使用filebeat收集nginx日志到es集群"></a>1.使用filebeat收集nginx日志到es集群</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">(1)安装nginx服务并启动</span><br><span class="line">cat &gt; /etc/yum.repos.d/nginx.repo &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=true</span><br><span class="line"></span><br><span class="line">[nginx-mainline]</span><br><span class="line">name=nginx mainline repo</span><br><span class="line">baseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=true</span><br><span class="line">EOF</span><br><span class="line">yum -y install nginx</span><br><span class="line">systemctl start nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(2)配置filebeat收集nginx日志并写入到ES</span><br><span class="line">    基于filestream采集案例</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: filestream</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定收集访问日志的路径</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/nginx/access.log</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定ES集群的列表</span></span><br><span class="line">  hosts:</span><br><span class="line">    - &quot;http://10.0.0.101:9200&quot;</span><br><span class="line">    - &quot;http://10.0.0.102:9200&quot;</span><br><span class="line">    - &quot;http://10.0.0.103:9200&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    基于log采集案例</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: filestream</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定收集访问日志的路径</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/nginx/access.log</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定ES集群的列表</span></span><br><span class="line">  hosts:</span><br><span class="line">    - &quot;http://10.0.0.101:9200&quot;</span><br><span class="line">    - &quot;http://10.0.0.102:9200&quot;</span><br><span class="line">    - &quot;http://10.0.0.103:9200&quot;</span><br><span class="line"></span><br><span class="line">(3)启动filebeat</span><br><span class="line">filebeat -e -c /etc/filebeat/config/02-filestream-to-console.yml</span><br><span class="line"></span><br><span class="line">(4)通过kibana查看日志</span><br><span class="line">略，见视频。</span><br></pre></td></tr></table></figure>

<p>视频操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# egrep -v &quot;^*#|^$&quot; /etc/filebeat/filebeat.yml-2022-05-10</span><br></pre></td></tr></table></figure>

<p>11-nginx-to-es.yml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# cat ~/config/11-nginx-to-es.yml</span><br><span class="line">filebeat.config.modules:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定模块的配置文件路径，如果是yum方式安装，在7.17.3版本中不能使用如下的默认值.</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">  path: <span class="variable">$&#123;path.config&#125;</span>/modules.d/*.yml</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">经过实际测试，推荐大家使用如下的配置，此处写绝对路径即可!而对于二进制部署无需做此操作.</span></span><br><span class="line">  path: /etc/filebeat/modules.d/*.yml</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">开启热加载功能</span></span><br><span class="line">  reload.enabled: true</span><br><span class="line">    </span><br><span class="line">output.elasticsearch:</span><br><span class="line">  enabled: true</span><br><span class="line">  hosts: [&quot;http://10.0.0.101:9200&quot;,&quot;http://10.0.0.102:9200&quot;,&quot;http://10.0.0.103:9200&quot;]</span><br><span class="line">  index: &quot;oldboyedu-linux-nginx-access-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁用索引生命周期管理</span></span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的名称</span></span><br><span class="line">setup.template.name: &quot;oldboyedu-linux&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的匹配模式</span></span><br><span class="line">setup.template.pattern: &quot;oldboyedu-linux*&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">覆盖已有的索引模板，如果为<span class="literal">true</span>，则会直接覆盖现有的索引模板，如果为<span class="literal">false</span>则不覆盖!</span></span><br><span class="line">setup.template.overwrite: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置索引模板</span></span><br><span class="line">setup.template.settings:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">设置分片数量</span></span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">设置副本数量，要求小于集群的数量</span></span><br><span class="line">  index.number_of_replicas: 0</span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -c ~/config/11-nginx-to-es.yml modules list</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用modules</span></span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -c ~/config/11-nginx-to-es.yml modules enable nginx tomcat</span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -c ~/config/11-nginx-to-es.yml modules list</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭modules</span></span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -c ~/config/11-nginx-to-es.yml modules disable nginx tomcat</span><br><span class="line">[root@elk102.oldboyedu.com ~]# vim /etc/filebeat/modules.d/nginx.yml</span><br><span class="line">- module: nginx</span><br><span class="line">  access:</span><br><span class="line">    enabled: true</span><br><span class="line">    ...</span><br><span class="line">    var.paths: [&quot;/var/log/nginx/access.log*&quot;]</span><br><span class="line">  error:</span><br><span class="line">    enabled: false</span><br><span class="line">    ...</span><br><span class="line">    var.paths: [&quot;/var/log/nginx/error.log*&quot;]</span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -e -c ~/config/11-nginx-to-es.yml</span><br></pre></td></tr></table></figure>

<p>二进制部署</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# mkdir /oldboyedu/softwares -pv</span><br><span class="line">[root@elk102.oldboyedu.com ~]# tar xf filebeat-7.17.3-linux-x86_64.tar.gz -C /oldboyedu/softwares/</span><br><span class="line">[root@elk102.oldboyedu.com ~]# cd /oldboyedu/softwares</span><br><span class="line">[root@elk102.oldboyedu.com softwares]# cd filebeat-7.17.3-linux-x86_64</span><br><span class="line">[root@elk102.oldboyedu.com filebeat-7.17.3-linux-x86_64]# ./filebeat modules list</span><br><span class="line">[root@elk102.oldboyedu.com ~]# mv config/ /oldboyedu/softwares/filebeat-7.17.3-linux-x86_64/</span><br><span class="line">[root@elk102.oldboyedu.com filebeat-7.17.3-linux-x86_64]# ./filebeat -c /config/11-nginx-to-es.yml modules list</span><br></pre></td></tr></table></figure>





<h2 id="2-自定义nginx日志格式及ES索引名称"><a href="#2-自定义nginx日志格式及ES索引名称" class="headerlink" title="2.自定义nginx日志格式及ES索引名称"></a>2.自定义nginx日志格式及ES索引名称</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">(1)修改nginx的源日志格式</span><br><span class="line">vim /etc/nginx/nginx.conf</span><br><span class="line">...</span><br><span class="line">  log_format oldboyedu_nginx_json &#x27;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;host&quot;:&quot;$server_addr&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;clientip&quot;:&quot;$remote_addr&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;size&quot;:$body_bytes_sent,&#x27;</span><br><span class="line">                              &#x27;&quot;responsetime&quot;:$request_time,&#x27;</span><br><span class="line">                              &#x27;&quot;upstreamtime&quot;:&quot;$upstream_response_time&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;upstreamhost&quot;:&quot;$upstream_addr&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;http_host&quot;:&quot;$host&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;uri&quot;:&quot;$uri&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;domain&quot;:&quot;$host&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;xff&quot;:&quot;$http_x_forwarded_for&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;referer&quot;:&quot;$http_referer&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;tcp_xff&quot;:&quot;$proxy_protocol_addr&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;http_user_agent&quot;:&quot;$http_user_agent&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;status&quot;:&quot;$status&quot;&#125;&#x27;;</span><br><span class="line">                              </span><br><span class="line">  access_log /var/log/nginx/access.log oldboyedu_nginx_json;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(2)检查nginx的配置文件语法并重启nginx服务</span><br><span class="line">nginx -t</span><br><span class="line">systemctl restart nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(3)编写filebeat配置文件</span><br><span class="line">cat &gt; /etc/filebeat/config/03-nginx-to-es.yml &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: filestream</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定收集访问日志的路径</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/nginx/access.log</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">配置解析器</span></span><br><span class="line">  parsers:</span><br><span class="line">      # 使 Filebeat能够解码结构化为JSoN消息的日志。</span><br><span class="line">      # Filebeat逐行处理日志，因此JSON解码仅在每条消息有一个JSON对象时才有效。</span><br><span class="line">    - ndjson:</span><br><span class="line">      # 对message字段进行JSON格式解析，并将key放在根字段。</span><br><span class="line">      keys_under_root: true</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定ES集群的列表</span></span><br><span class="line">  hosts:</span><br><span class="line">    - &quot;http://10.0.0.101:9200&quot;</span><br><span class="line">    - &quot;http://10.0.0.102:9200&quot;</span><br><span class="line">    - &quot;http://10.0.0.103:9200&quot;</span><br><span class="line">  index: &quot;oldboyedu-linux-elk-8&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line"><span class="meta prompt_">  </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭索引的生命周期，若开启则上面的index配置会被无视!</span></span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定索引模板的名称，所谓索引模板就是创建索引的方式</span></span><br><span class="line">setup.template.name: &quot;oldboyedu-linux-elk&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定索引目标的匹配模式</span></span><br><span class="line">setup.template.pattern: &quot;oldboyedu-linux-elk*&quot;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(4)启动filebeat实例</span><br><span class="line">rm -rf /var/lib/filebeat/*</span><br><span class="line">filebeat -e -c /etc/filebeat/config/03-nginx-to-es.yml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(5)在kibana查看数据</span><br><span class="line">略，见视频。</span><br></pre></td></tr></table></figure>

<p>视频操作：</p>
<p>1.filestream类型json解析配置</p>
<p>20-nginx-to-es.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/20-nginx-to-es.yml</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">filestream</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/nginx/access.log*</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;access&quot;</span>]</span><br><span class="line">  <span class="comment"># 对于filestream类型而言，不能直接配置json解析，而是需要借助解析器实现</span></span><br><span class="line">  <span class="comment">#   json.keys_under_root: true</span></span><br><span class="line">  <span class="comment"># 综上所述，我们就需要使用以下的写法实现.</span></span><br><span class="line">  <span class="attr">parsers:</span></span><br><span class="line">    <span class="comment"># 使Filestream能够解码结构化为JSON消息的日志。</span></span><br><span class="line">    <span class="comment"># Filestream逐行处理日志，因此JSON解码仅在每条消息有一个JSON对象时才有效。</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ndjson:</span></span><br><span class="line">        <span class="comment"># 对message字段进行JSON格式解析，并将key放在顶级字段。</span></span><br><span class="line">        <span class="attr">keys_under_root:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;http://10.0.0.101:9200&quot;</span>,<span class="string">&quot;http://10.0.0.102:9200&quot;</span>,<span class="string">&quot;http://10.0.0.103:9200&quot;</span>]</span><br><span class="line">  <span class="attr">index:</span> <span class="string">&quot;oldboyedu-linux-nginx-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">setup.template.name:</span> <span class="string">&quot;oldboyedu-linux&quot;</span></span><br><span class="line"><span class="attr">setup.template.pattern:</span> <span class="string">&quot;oldboyedu-linux*&quot;</span></span><br><span class="line"><span class="attr">setup.template.overwrite:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">index.number_of_replicas:</span> <span class="number">0</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -e -c ~/config/20-nginx-to-es.yml</span></span><br></pre></td></tr></table></figure>



<p>2.filestream类型多行匹配</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">(1)编写filebeat配置文件</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">config/08-tomcat-error-to-es.yml</span> <span class="string">&lt;&#x27;EOF&#x27;</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">filestream</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/oldboyedu/softwares/tomcat/logs/catalina.out</span></span><br><span class="line">  <span class="attr">parsers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">multiline:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">pattern</span></span><br><span class="line">        <span class="attr">pattern:</span> <span class="string">&#x27;^\d&#123;2&#125;&#x27;</span></span><br><span class="line">        <span class="attr">negate:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">match:</span> <span class="string">after</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;http://10.0.0.101:9200&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;http://10.0.0.102:9200&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;http://10.0.0.103:9200&quot;</span></span><br><span class="line">  <span class="attr">index:</span> <span class="string">&quot;oldboyedu-tomcat-error-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">setup.template.name:</span> <span class="string">&quot;oldboyedu-tomcat-error&quot;</span></span><br><span class="line"><span class="attr">setup.template.pattern:</span> <span class="string">&quot;oldboyedu-tomcat-error*&quot;</span></span><br><span class="line"><span class="attr">setup.template.overwrite:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">index.number_of_replicas:</span> <span class="number">0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">(2)启动filebeat实例</span></span><br><span class="line"><span class="string">filebeat</span> <span class="string">test</span> <span class="string">config</span> <span class="string">-c</span> <span class="string">config/08-tomcat-error-to-es.yml</span></span><br><span class="line"><span class="string">filebeat</span> <span class="string">-e</span> <span class="string">-c</span> <span class="string">config/08-tomcat-error-to-es.yml</span></span><br></pre></td></tr></table></figure>

<p>视频操作：</p>
<p>21-nginx-to-es.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/21-nginx-to-es.yml</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">filestream</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/oldboyedu/softwares/apache-tomcat-10.0.20/logs/*.txt</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;access&quot;</span>]</span><br><span class="line">  <span class="attr">parsers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ndjson:</span></span><br><span class="line">        <span class="attr">keys_under_root:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">filestream</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/oldboyedu/softwares/apache-tomcat-10.0.20/logs/*.out</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;error&quot;</span>]</span><br><span class="line">  <span class="attr">parsers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">multiline:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">pattern</span></span><br><span class="line">        <span class="attr">pattern:</span> <span class="string">&#x27;^\d&#123;2&#125;&#x27;</span></span><br><span class="line">        <span class="attr">negate:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">match:</span> <span class="string">after</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;http://10.0.0.101:9200&quot;</span>,<span class="string">&quot;http://10.0.0.102:9200&quot;</span>,<span class="string">&quot;http://10.0.0.103:9200&quot;</span>]</span><br><span class="line">  <span class="attr">indices:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;oldboyedu-linux-web-tomcat-access-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">      <span class="comment"># 匹配指定字段包含的内容</span></span><br><span class="line">      <span class="attr">when.contains:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">&quot;access&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;oldboyedu-linux-web-tomcat-error-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">when.contains:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">&quot;error&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">setup.template.name:</span> <span class="string">&quot;oldboyedu-linux&quot;</span></span><br><span class="line"><span class="attr">setup.template.pattern:</span> <span class="string">&quot;oldboyedu-linux*&quot;</span></span><br><span class="line"><span class="attr">setup.template.overwrite:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">index.number_of_replicas:</span> <span class="number">0</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -e -c ~/config/21-nginx-to-es.yml</span></span><br></pre></td></tr></table></figure>





<h2 id="3-自定义tomcat日志格式并指定索引分片"><a href="#3-自定义tomcat日志格式并指定索引分片" class="headerlink" title="3.自定义tomcat日志格式并指定索引分片"></a><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1qG41187nn?p=26&spm_id_from=pageDriver&vd_source=629395ac7befa1625191c3f496068941">3.自定义tomcat日志格式并指定索引分片</a></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">(1)部署tomcat服务</span><br><span class="line">    1)解压tomcat软件包</span><br><span class="line">tar xf apache-tomcat-10.0.20.tar.gz -C /oldboyedu/softwares/</span><br><span class="line"></span><br><span class="line">    2)创建符号链接</span><br><span class="line">cd /oldboyedu/softwares/ &amp;&amp; ln -sv apache-tomcat-10.0.20 tomcat</span><br><span class="line"></span><br><span class="line">    3)配置环境变量</span><br><span class="line">vim /etc/profile.d/elk.sh</span><br><span class="line">...</span><br><span class="line">export TOMCAT_HOME=/oldboyedu/softwares/tomcat</span><br><span class="line">export JAVA_HOME=/usr/share/elasticsearch/jdk</span><br><span class="line">export PATH=$PATH:$TOMCAT_HOME/bin:$JAVA_HOME/bin</span><br><span class="line"></span><br><span class="line">    4)使得环境变量生效</span><br><span class="line">source /etc/profile.d/elk.sh</span><br><span class="line"></span><br><span class="line">    5)备份配置文件</span><br><span class="line">cp /oldboyedu/softwares/tomcat/conf/&#123;server.xml,server.xml- date +9F&#x27;&#125;</span><br><span class="line"></span><br><span class="line">    6)修改配置文件</span><br><span class="line">vim /oldboyedu/softwares/tomcat/conf/server.xml</span><br><span class="line">...(切换到行尾修改，大概是在133-149之间)</span><br><span class="line">          &lt;Host name=&quot;tomcat.oldboyedu.com&quot; appBase=&quot;webapps&quot;</span><br><span class="line">                unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</span><br><span class="line">                </span><br><span class="line">          &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;</span><br><span class="line">              prefix=&quot;tomcat.oldboyedu.com_access_log&quot; suffix=&quot;.txt&quot;</span><br><span class="line">pattern=&quot;&#123;&amp;quot;clientip&amp;quot;:&amp;quot;%h&amp;quot;,&amp;quot;ClientUser&amp;quot;:&amp;quot;%l&amp;quot;,&amp;quot;authenticated&amp;quot;:&amp;quot;%u&amp;quot;,&amp;quot;AccessTime&amp;quot;:&amp;quot;%t&amp;quot;,&amp;quot;request&amp;quot;:&amp;quot;%r&amp;quot;,&amp;quot;status&amp;quot;:&amp;quot;%s&amp;quot;,&amp;quot;SendBytes&amp;quot;:&amp;quot;%b&amp;quot;,&amp;quot;Query?string&amp;quot;:&amp;quot;%q&amp;quot;,&amp;quot;partner&amp;quot;:&amp;quot;%&#123;Referer&#125;i&amp;quot;,&amp;quot;AgentVersion&amp;quot;:&amp;quot;%&#123;User-Agent&#125;i&amp;quot;&#125;&quot;/&gt;</span><br><span class="line"></span><br><span class="line">          &lt;/Host&gt;</span><br><span class="line"></span><br><span class="line">    7)启动tomcat访问</span><br><span class="line">catalina.sh start</span><br><span class="line"></span><br><span class="line">    8)访问测试，并查看日志格式</span><br><span class="line">tail -100f /oldboyedu/softwares/tomcat/logs/tomcat.oldboyedu.com_access_log.2022-04-19.txt</span><br><span class="line"></span><br><span class="line">(2)配置filebeat收集tomcat日志</span><br><span class="line">cat &gt; /etc/filebeat/config/04-tomcat-to-es.yml &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: filestream</span><br><span class="line">  paths:</span><br><span class="line">    - /oldboyedu/softwares/tomcat/logs/tomcat.oldboyedu.com_access_log*.txt</span><br><span class="line">  parsers:</span><br><span class="line">    - ndjson:</span><br><span class="line">        keys_under_root: true</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts:</span><br><span class="line">    - &quot;http://10.0.0.101:9200&quot;</span><br><span class="line">    - &quot;http://10.0.0.102:9200&quot;</span><br><span class="line">    - &quot;http://10.0.0.103:9200&quot;</span><br><span class="line">  index: &quot;oldboyedu-tomcat-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line"></span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line">setup.template.name: &quot;oldboyedu-tomcat&quot;</span><br><span class="line">setup.template.pattern: &quot;oldboyedu-tomcat*&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">覆盖已存在的索引模板</span></span><br><span class="line">setup.template.overwrite: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置分片的信息</span></span><br><span class="line">setup.template.settings:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">主分片数量为3</span></span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">副本分片为0</span></span><br><span class="line">  index.number_of_replicas: 0</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>视频操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# tar xf apache-tomcat-10.0.20.tar.gz -C /oldboyedu/softwares/</span><br><span class="line">[root@elk102.oldboyedu.com ~]# cd /oldboyedu/softwares/</span><br><span class="line">[root@elk102.oldboyedu.com softwares]# cd apache-tomcat-10.0.20/</span><br><span class="line">[root@elk102.oldboyedu.com apache-tomcat-10.0.20]# cd /bin</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动报错</span></span><br><span class="line">[root@elk102.oldboyedu.com bin]# ./catalina.sh start</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加JAVA环境</span></span><br><span class="line">[root@elk102.oldboyedu.com ~]# vim /etc/profile.d/jdk.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">export JAVA_HOME=/usr/share/elasticsearch/jdk</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line">[root@elk102.oldboyedu.com ~]# source /etc/profile.d/jdk.sh</span><br><span class="line">[root@elk102.oldboyedu.com ~]# java -version</span><br><span class="line">[root@elk102.oldboyedu.com bin]# ./catalina.sh start</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看8080端口</span></span><br><span class="line">[root@elk102.oldboyedu.com bin]# ss -ntl</span><br><span class="line">[root@elk102.oldboyedu.com apache-tomcat-10.0.20]# cd logs/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看没有日志</span></span><br><span class="line">[root@elk102.oldboyedu.com logs]# cat localhost_access_log.2022-05-11.txt</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">访问8080</span></span><br><span class="line">[root@elk102.oldboyedu.com logs]# curl 127.0.0.1:8080</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看日志</span></span><br><span class="line">[root@elk102.oldboyedu.com logs]# cat localhost_access_log.2022-05-11.txt</span><br></pre></td></tr></table></figure>

<p>12-tomcat-to-es.yml，基于模块采集tomcat日志文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -c ~/config/11-nginx-to-es.yml modules disable nginx</span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -c ~/config/11-nginx-to-es.yml modules enable tomcat</span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -c ~/config/11-nginx-to-es.yml modules list | head</span><br><span class="line"></span><br><span class="line">[root@elk102.oldboyedu.com ~]# cat ~/config/12-tomcat-to-es.yml</span><br><span class="line">filebeat.config.modules:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定模块的配置文件路径，如果是yum方式安装，在7.17.3版本中不能使用如下的默认值.</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">  path: <span class="variable">$&#123;path.config&#125;</span>/modules.d/*.yml</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">经过实际测试，推荐大家使用如下的配置，此处写绝对路径即可!而对于二进制部署无需做此操作.</span></span><br><span class="line">  path: /etc/filebeat/modules.d/*.yml</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">开启热加载功能</span></span><br><span class="line">  reload.enabled: true</span><br><span class="line">    </span><br><span class="line">output.elasticsearch:</span><br><span class="line">  enabled: true</span><br><span class="line">  hosts: [&quot;http://10.0.0.101:9200&quot;,&quot;http://10.0.0.102:9200&quot;,&quot;http://10.0.0.103:9200&quot;]</span><br><span class="line">  index: &quot;oldboyedu-linux-tomcat-access-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁用索引生命周期管理</span></span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的名称</span></span><br><span class="line">setup.template.name: &quot;oldboyedu-linux&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的匹配模式</span></span><br><span class="line">setup.template.pattern: &quot;oldboyedu-linux*&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">覆盖已有的索引模板，如果为<span class="literal">true</span>，则会直接覆盖现有的索引模板，如果为<span class="literal">false</span>则不覆盖!</span></span><br><span class="line">setup.template.overwrite: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置索引模板</span></span><br><span class="line">setup.template.settings:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">设置分片数量</span></span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">设置副本数量，要求小于集群的数量</span></span><br><span class="line">  index.number_of_replicas: 0</span><br><span class="line"></span><br><span class="line">[root@elk102.oldboyedu.com ~]# vim /etc/filebeat/modules.d/tomcat.yml</span><br><span class="line">...</span><br><span class="line">- module: tomcat</span><br><span class="line">  log:</span><br><span class="line">    enabled: true</span><br><span class="line">    ...</span><br><span class="line">    var.input: file</span><br><span class="line">    ...</span><br><span class="line">    var.paths:</span><br><span class="line">      - /oldboyedu/softwares/apache-tomcat-10.0.20/logs/*.txt</span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -e -c ~/config/12-tomcat-to-es.yml</span><br></pre></td></tr></table></figure>

<p>13-tomcat-to-es.yml，原生日志</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/13-tomcat-to-es.yml</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/oldboyedu/softwares/apache-tomcat-10.0.20/logs/*.txt</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;http://10.0.0.101:9200&quot;</span>,<span class="string">&quot;http://10.0.0.102:9200&quot;</span>,<span class="string">&quot;http://10.0.0.103:9200&quot;</span>]</span><br><span class="line">  <span class="attr">index:</span> <span class="string">&quot;oldboyedu-linux-tomcat-access-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用索引生命周期管理</span></span><br><span class="line"><span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># 设置索引模板的名称</span></span><br><span class="line"><span class="attr">setup.template.name:</span> <span class="string">&quot;oldboyedu-linux&quot;</span></span><br><span class="line"><span class="comment"># 设置索引模板的匹配模式</span></span><br><span class="line"><span class="attr">setup.template.pattern:</span> <span class="string">&quot;oldboyedu-linux*&quot;</span></span><br><span class="line"><span class="comment"># 覆盖已有的索引模板，如果为true，则会直接覆盖现有的索引模板，如果为false则不覆盖!</span></span><br><span class="line"><span class="attr">setup.template.overwrite:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 配置索引模板</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="comment"># 设置分片数量</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># 设置副本数量，要求小于集群的数量</span></span><br><span class="line">  <span class="attr">index.number_of_replicas:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>视频操作： json日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# cp /oldboyedu/softwares/apache-tomcat-10.0.20/conf/&#123;server.xml,server.xml-`date +%F`&#125;</span><br><span class="line">[root@elk102.oldboyedu.com ~]# vim /oldboyedu/softwares/apache-tomcat-10.0.20/conf/server.xml</span><br><span class="line">...(切换到行尾修改，大概是在133-149之间)</span><br><span class="line">          &lt;Host name=&quot;tomcat.oldboyedu.com&quot; appBase=&quot;webapps&quot;</span><br><span class="line">                unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</span><br><span class="line">                </span><br><span class="line">          &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;</span><br><span class="line">              prefix=&quot;tomcat.oldboyedu.com_access_log&quot; suffix=&quot;.txt&quot;</span><br><span class="line">pattern=&quot;&#123;&amp;quot;clientip&amp;quot;:&amp;quot;%h&amp;quot;,&amp;quot;ClientUser&amp;quot;:&amp;quot;%l&amp;quot;,&amp;quot;authenticated&amp;quot;:&amp;quot;%u&amp;quot;,&amp;quot;AccessTime&amp;quot;:&amp;quot;%t&amp;quot;,&amp;quot;request&amp;quot;:&amp;quot;%r&amp;quot;,&amp;quot;status&amp;quot;:&amp;quot;%s&amp;quot;,&amp;quot;SendBytes&amp;quot;:&amp;quot;%b&amp;quot;,&amp;quot;Query?string&amp;quot;:&amp;quot;%q&amp;quot;,&amp;quot;partner&amp;quot;:&amp;quot;%&#123;Referer&#125;i&amp;quot;,&amp;quot;http_user_agent&amp;quot;:&amp;quot;%&#123;User-Agent&#125;i&amp;quot;&#125;&quot;/&gt;</span><br><span class="line"></span><br><span class="line">          &lt;/Host&gt;</span><br><span class="line">[root@elk102.oldboyedu.com ~]# cd /oldboyedu/softwares/</span><br><span class="line">[root@elk102.oldboyedu.com softwares]# cd apache-tomcat-10.0.20/</span><br><span class="line">[root@elk102.oldboyedu.com apache-tomcat-10.0.20]# cd /bin</span><br><span class="line">[root@elk102.oldboyedu.com bin]# ./catalina.sh stop</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看8080端口</span></span><br><span class="line">[root@elk102.oldboyedu.com bin]# ss -ntl</span><br><span class="line">[root@elk102.oldboyedu.com ~]# cd /oldboyedu/softwares/apache-tomcat-10.0.20/logs/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">清空日志文件</span></span><br><span class="line">[root@elk102.oldboyedu.com logs]# rm -f *</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看json格式的日志</span></span><br><span class="line">[root@elk102.oldboyedu.com logs]# cat tomcat.oldboyedu.com_access_log.2022-05-11.txt</span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -e -c ~/config/13-tomcat-to-es.yml</span><br></pre></td></tr></table></figure>

<p>14-tomcat-to-es.yml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# cat ~/config/14-tomcat-to-es.yml</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /oldboyedu/softwares/apache-tomcat-10.0.20/logs/*.txt</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">解析message字段的json格式，并放在顶级字段中</span></span><br><span class="line">  json.keys_under_root: true</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  enabled: true</span><br><span class="line">  hosts: [&quot;http://10.0.0.101:9200&quot;,&quot;http://10.0.0.102:9200&quot;,&quot;http://10.0.0.103:9200&quot;]</span><br><span class="line">  index: &quot;oldboyedu-linux-tomcat-access-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁用索引生命周期管理</span></span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的名称</span></span><br><span class="line">setup.template.name: &quot;oldboyedu-linux&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置索引模板的匹配模式</span></span><br><span class="line">setup.template.pattern: &quot;oldboyedu-linux*&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">覆盖已有的索引模板，如果为<span class="literal">true</span>，则会直接覆盖现有的索引模板，如果为<span class="literal">false</span>则不覆盖!</span></span><br><span class="line">setup.template.overwrite: true</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置索引模板</span></span><br><span class="line">setup.template.settings:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">设置分片数量</span></span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">设置副本数量，要求小于集群的数量</span></span><br><span class="line">  index.number_of_replicas: 0</span><br><span class="line">[root@elk102.oldboyedu.com ~]# rm -rf /var/lib/filebeat/*</span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -e -c ~/config/14-tomcat-to-es.yml</span><br></pre></td></tr></table></figure>



<h1 id="十-log类型切换filestream类型注意事项"><a href="#十-log类型切换filestream类型注意事项" class="headerlink" title="十.log类型切换filestream类型注意事项"></a>十.log类型切换filestream类型注意事项</h1><h2 id="1-filestream类型json解析配置"><a href="#1-filestream类型json解析配置" class="headerlink" title="1.filestream类型json解析配置"></a>1.filestream类型json解析配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">filestream</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/nginx/access.log*</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;access&quot;</span>]</span><br><span class="line">  <span class="comment"># 对于filestream类型而言，不能直接配置json解析，而是需要借助解析器实现</span></span><br><span class="line">  <span class="comment">#   json.keys_under_root: true</span></span><br><span class="line">  <span class="comment"># 综上所述，我们就需要使用以下的写法实现.</span></span><br><span class="line">  <span class="attr">parsers:</span></span><br><span class="line">    <span class="comment"># 使Filestream能够解码结构化为JSON消息的日志。</span></span><br><span class="line">    <span class="comment"># Filestream逐行处理日志，因此JSON解码仅在每条消息有一个JSON对象时才有效。</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ndjson:</span></span><br><span class="line">        <span class="comment"># 对message字段进行JSON格式解析，并将key放在顶级字段。</span></span><br><span class="line">        <span class="attr">keys_under_root:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;http://10.0.0.101:9200&quot;</span>,<span class="string">&quot;http://10.0.0.102:9200&quot;</span>,<span class="string">&quot;http://10.0.0.103:9200&quot;</span>]</span><br><span class="line">  <span class="attr">index:</span> <span class="string">&quot;oldboyedu-linux-nginx-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">setup.template.name:</span> <span class="string">&quot;oldboyedu-linux&quot;</span></span><br><span class="line"><span class="attr">setup.template.pattern:</span> <span class="string">&quot;oldboyedu-linux*&quot;</span></span><br><span class="line"><span class="attr">setup.template.overwrite:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">index.number_of_replicas:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>



<h2 id="2-filestream类型多行匹配"><a href="#2-filestream类型多行匹配" class="headerlink" title="2.filestream类型多行匹配"></a>2.filestream类型多行匹配</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">(1)编写filebeat配置文件</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">config/08-tomcat-error-to-es.yml</span> <span class="string">&lt;&#x27;EOF&#x27;</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">filestream</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/oldboyedu/softwares/tomcat/logs/catalina.out</span></span><br><span class="line">  <span class="attr">parsers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">multiline:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">pattern</span></span><br><span class="line">        <span class="attr">pattern:</span> <span class="string">&#x27;^\d&#123;2&#125;&#x27;</span></span><br><span class="line">        <span class="attr">negate:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">match:</span> <span class="string">after</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;http://10.0.0.101:9200&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;http://10.0.0.102:9200&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;http://10.0.0.103:9200&quot;</span></span><br><span class="line">  <span class="attr">index:</span> <span class="string">&quot;oldboyedu-tomcat-error-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">setup.template.name:</span> <span class="string">&quot;oldboyedu-tomcat-error&quot;</span></span><br><span class="line"><span class="attr">setup.template.pattern:</span> <span class="string">&quot;oldboyedu-tomcat-error*&quot;</span></span><br><span class="line"><span class="attr">setup.template.overwrite:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">index.number_of_replicas:</span> <span class="number">0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">(2)启动filebeat实例</span></span><br><span class="line"><span class="string">filebeat</span> <span class="string">test</span> <span class="string">config</span> <span class="string">-c</span> <span class="string">config/08-tomcat-error-to-es.yml</span></span><br><span class="line"><span class="string">filebeat</span> <span class="string">-e</span> <span class="string">-c</span> <span class="string">config/08-tomcat-error-to-es.yml</span></span><br><span class="line"></span><br><span class="line"><span class="string">(3)kibana查看</span></span><br><span class="line"><span class="string">略。</span></span><br></pre></td></tr></table></figure>

<p>视频操作：</p>
<p>21-nginx-to-es.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/21-nginx-to-es.yml</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">filestream</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/oldboyedu/softwares/apache-tomcat-10.0.20/logs/*.txt</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;access&quot;</span>]</span><br><span class="line">  <span class="attr">parsers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ndjson:</span></span><br><span class="line">        <span class="attr">keys_under_root:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">filestream</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/oldboyedu/softwares/apache-tomcat-10.0.20/logs/*.out</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;error&quot;</span>]</span><br><span class="line">  <span class="attr">parsers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">multiline:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">pattern</span></span><br><span class="line">        <span class="attr">pattern:</span> <span class="string">&#x27;^\d&#123;2&#125;&#x27;</span></span><br><span class="line">        <span class="attr">negate:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">match:</span> <span class="string">after</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;http://10.0.0.101:9200&quot;</span>,<span class="string">&quot;http://10.0.0.102:9200&quot;</span>,<span class="string">&quot;http://10.0.0.103:9200&quot;</span>]</span><br><span class="line">  <span class="attr">indices:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;oldboyedu-linux-web-tomcat-access-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">      <span class="comment"># 匹配指定字段包含的内容</span></span><br><span class="line">      <span class="attr">when.contains:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">&quot;access&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;oldboyedu-linux-web-tomcat-error-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">when.contains:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">&quot;error&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">setup.template.name:</span> <span class="string">&quot;oldboyedu-linux&quot;</span></span><br><span class="line"><span class="attr">setup.template.pattern:</span> <span class="string">&quot;oldboyedu-linux*&quot;</span></span><br><span class="line"><span class="attr">setup.template.overwrite:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">index.number_of_replicas:</span> <span class="number">0</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -e -c ~/config/21-nginx-to-es.yml</span></span><br></pre></td></tr></table></figure>



<h2 id="13-收集日志到redis服务"><a href="#13-收集日志到redis服务" class="headerlink" title="13.收集日志到redis服务"></a>13.收集日志到redis服务</h2><h3 id="13-1-部署redis"><a href="#13-1-部署redis" class="headerlink" title="13.1 部署redis"></a>13.1 部署redis</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install epel-release</span><br><span class="line">yum -y install redis</span><br></pre></td></tr></table></figure>



<h3 id="13-2-修改配置文件"><a href="#13-2-修改配置文件" class="headerlink" title="13.2 修改配置文件"></a>13.2 修改配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim /etc/redis.conf</span><br><span class="line">...</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">requirepass oldboyedu</span><br></pre></td></tr></table></figure>



<h3 id="13-3-启动redis服务"><a href="#13-3-启动redis服务" class="headerlink" title="13.3 启动redis服务"></a>13.3 启动redis服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start redis</span><br></pre></td></tr></table></figure>

<p>查看6379端口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# ss -ntl</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@elk103.oldboyedu.com ~]# redis-cli -a oldboyedu -h 10.0.0.101 -p 6379 --raw</span><br><span class="line">10.0.0.101:6379&gt; KEYS *</span><br><span class="line">10.0.0.101:6379&gt; set school oldboyedu</span><br><span class="line">10.0.0.101:6379&gt; KEYS *</span><br><span class="line">school</span><br><span class="line">10.0.0.101:6379&gt; get school</span><br><span class="line">oldboyedu</span><br><span class="line">10.0.0.101:6379&gt; FLUSHALL</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>



<h3 id="13-4-其他节点连接测试redis环境"><a href="#13-4-其他节点连接测试redis环境" class="headerlink" title="13.4 其他节点连接测试redis环境"></a>13.4 其他节点连接测试redis环境</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk103.oldboyedu.com ~]# redis-cli -a oldboyedu -h 10.0.0.101 -p 6379 --raw -n 5</span><br></pre></td></tr></table></figure>



<h3 id="13-5-将filebeat数据写入到Redis环境"><a href="#13-5-将filebeat数据写入到Redis环境" class="headerlink" title="13.5 将filebeat数据写入到Redis环境"></a>13.5 将filebeat数据写入到Redis环境</h3><p>28-tcp-to-redis.yml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# cat ~/config/28-tcp-to-redis.yml</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: tcp</span><br><span class="line">  host: &quot;0.0.0.0:9000&quot;</span><br><span class="line"></span><br><span class="line">output.redis:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">写入redis的主机地址</span></span><br><span class="line">  hosts: [&quot;10.0.0.101:6379&quot;]</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定redis的认证口令</span></span><br><span class="line">  password: &quot;oldboyedu&quot;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定连接数据库的编号</span></span><br><span class="line">  db: 5</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定的key值</span></span><br><span class="line">  key: &quot;oldboyedu-linux80-filebeat&quot;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">规定超时时间</span></span><br><span class="line">  timeout: 3</span><br><span class="line"></span><br><span class="line">[root@elk102.oldboyedu.com ~]# rm -rf /var/lib/filebeat/*</span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -e -c ~/config/28-tcp-to-redis.yml</span><br><span class="line">[root@elk101.oldboyedu.com ~]# nc 10.0.0.102 9000</span><br><span class="line">AAAAAAA</span><br><span class="line">bbbbbbb</span><br><span class="line">ccccccc</span><br><span class="line">[root@elk103.oldboyedu.com ~]# redis-cli -a oldboyedu -h 10.0.0.101 -p 6379 --raw -n 5</span><br><span class="line">10.0.0.101:6379[5]&gt; KEYS *</span><br><span class="line">oldboyedu-linux80-filebeat</span><br><span class="line">10.0.0.101:6379[5]&gt; TYPE oldboyedu-linux80-filebeat</span><br><span class="line">list</span><br><span class="line">10.0.0.101:6379[5]&gt; LRANGE oldboyedu-linux80-filebeat 0 -1</span><br></pre></td></tr></table></figure>



<h3 id="13-6-测试写入数据"><a href="#13-6-测试写入数据" class="headerlink" title="13.6 测试写入数据"></a>13.6 测试写入数据</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">写入数据：</span><br><span class="line">echo 33333333333333333333| nc 10.0.0.102 9000</span><br><span class="line"></span><br><span class="line">查看数据：</span><br><span class="line">[root@elk103.oldboyedu.com ~]# redis-cli -a oldboyedu -h 10.0.0.101 -p 6379 --raw -n 5</span><br><span class="line">.....</span><br><span class="line">10.0.0.101:6379[5]&gt; LRANGE oldboyedu-linux80-filebeat 0 -1</span><br></pre></td></tr></table></figure>





<p>14.今日作业</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">(1)完成课堂的所有练习</span><br><span class="line">(2)使用filebeat收集以下系统日志：</span><br><span class="line">    /var/log/secure</span><br><span class="line">    /var/log/maillog</span><br><span class="line">    /var/log/yum.log</span><br><span class="line">    /var/log/firewalld</span><br><span class="line">    /var/log/cron</span><br><span class="line">    /var/log/messages</span><br><span class="line"></span><br><span class="line">要求如下：</span><br><span class="line">    (1)在同一个filebeat配置文件中书写;</span><br><span class="line">    (2)将上述6类日志分别写入不同的索引,索引前缀名称为&quot;oldboyedu-elk-system-log-&#123;xxx&#125;-%&#123;+yyyy.MM.dd&#125;&quot;;</span><br><span class="line">    (3)要求副本数量为0，分片数量为10;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">7.17.3版本可能遇到的问题：</span><br><span class="line">    (1)input源配置一旦超过4个，写入ES时，就可能会复现出部分数据无法写入的问题；</span><br><span class="line">        有两种解决方案：</span><br><span class="line">            方案一：拆成多个filebeat实例。运行多个filebeat实例时需要指定数据路径&quot;--path.data&quot;.</span><br><span class="line">                filebeat -e -c ~/config/23-systemLog-to-es.yml --path.data /tmp/filebeat</span><br><span class="line">                </span><br><span class="line">            方案二：日志聚合思路解决问题。</span><br><span class="line">                1)部署服务</span><br><span class="line">                yum -y install rsyslog</span><br><span class="line">                </span><br><span class="line">                2)修改配置文件</span><br><span class="line">                vim /etc/rsyslog.conf</span><br><span class="line">                ...</span><br><span class="line">                $ModLoad imtcp</span><br><span class="line">                $InputTCPServerRun 514</span><br><span class="line">                ...</span><br><span class="line">                *.*            /var/log/oldboyedu.log</span><br><span class="line">                </span><br><span class="line">                3)重启服务并测试</span><br><span class="line">                systemctl restart rsyslog</span><br><span class="line">                logger &quot;1111&quot;</span><br></pre></td></tr></table></figure>



<p>内容回顾</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">input:</span><br><span class="line">log ---&gt; 7.16版本开始弃用</span><br><span class="line">filestream ---&gt; 替代log，用法上稍微有点差别</span><br><span class="line">stdin ---&gt; 调试</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">elasticsearch</span><br><span class="line">logstash</span><br><span class="line">redis</span><br><span class="line">kafka</span><br><span class="line">console ---&gt; 调试</span><br><span class="line"></span><br><span class="line">使用注意事项:</span><br><span class="line">  (1)多行匹配;</span><br><span class="line">  (2)son格式解析;</span><br></pre></td></tr></table></figure>



<p>22-systemLog-to-es.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/22-systemLog-to-es.yml</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">filestream</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/secure</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;secure&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">filestream</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/maillog</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;maillog&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">filestream</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/yum.log</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;yum&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">filestream</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/firewalld</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;firewalld&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">filestream</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/cron</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;cron&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">filestream</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/messages</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;messages&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;http://10.0.0.101:9200&quot;</span>,<span class="string">&quot;http://10.0.0.102:9200&quot;</span>,<span class="string">&quot;http://10.0.0.103:9200&quot;</span>]</span><br><span class="line">  <span class="attr">indices:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;oldboyedu-elk-system-log-secure-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">when.contains:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">&quot;secure&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;oldboyedu-elk-system-log-maillog-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">when.contains:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">&quot;maillog&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;oldboyedu-elk-system-log-yum-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">when.contains:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">&quot;yum&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;oldboyedu-elk-system-log-firewalld-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">when.contains:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">&quot;firewalld&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;oldboyedu-elk-system-log-cron-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">when.contains:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">&quot;cron&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;oldboyedu-elk-system-log-messages-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">when.contains:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">&quot;messages&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">setup.template.name:</span> <span class="string">&quot;oldboyedu-elk-system-log&quot;</span></span><br><span class="line"><span class="attr">setup.template.pattern:</span> <span class="string">&quot;oldboyedu-elk-system-log*&quot;</span></span><br><span class="line"><span class="attr">setup.template.overwrite:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">index.number_of_replicas:</span> <span class="number">0</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -e -c ~/config/22-systemLog-to-es.yml --path.data /tmp/filebeat</span></span><br></pre></td></tr></table></figure>



<p>23-systemLog-to-es.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/23-systemLog-to-es.yml</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">filestream</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/firewalld</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;firewalld&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">filestream</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/cron</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;cron&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">filestream</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/messages</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;messages&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;http://10.0.0.101:9200&quot;</span>,<span class="string">&quot;http://10.0.0.102:9200&quot;</span>,<span class="string">&quot;http://10.0.0.103:9200&quot;</span>]</span><br><span class="line">  <span class="attr">indices:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;oldboyedu-elk-system-log-firewalld-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">when.contains:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">&quot;firewalld&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;oldboyedu-elk-system-log-cron-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">when.contains:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">&quot;cron&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;oldboyedu-elk-system-log-messages-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">when.contains:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">&quot;messages&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">setup.template.name:</span> <span class="string">&quot;oldboyedu-elk-system-log&quot;</span></span><br><span class="line"><span class="attr">setup.template.pattern:</span> <span class="string">&quot;oldboyedu-elk-system-log*&quot;</span></span><br><span class="line"><span class="attr">setup.template.overwrite:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">index.number_of_replicas:</span> <span class="number">0</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -e -c ~/config/23-systemLog-to-es.yml --path.data /tmp/filebeat</span></span><br></pre></td></tr></table></figure>



<p>24-systemLog-to-es.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/24-systemLog-to-es.yml</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">filestream</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/oldboyedu.log</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;rsyslog&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;http://10.0.0.101:9200&quot;</span>,<span class="string">&quot;http://10.0.0.102:9200&quot;</span>,<span class="string">&quot;http://10.0.0.103:9200&quot;</span>]</span><br><span class="line">  <span class="attr">indices:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;oldboyedu-elk-system-rsyslog-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">when.contains:</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">&quot;rsyslog&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">setup.template.name:</span> <span class="string">&quot;oldboyedu-elk-system-log&quot;</span></span><br><span class="line"><span class="attr">setup.template.pattern:</span> <span class="string">&quot;oldboyedu-elk-system-log*&quot;</span></span><br><span class="line"><span class="attr">setup.template.overwrite:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">index.number_of_replicas:</span> <span class="number">0</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -e -c ~/config/24-systemLog-to-es.yml</span></span><br></pre></td></tr></table></figure>



<p>03-使用rsyslog收集系统日志</p>
<p>方案二：日志聚合思路解决问题。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# vim /etc/rsyslog.conf</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">ModLoad imtcp</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">InputTCPServerRun 514</span></span><br><span class="line">*.*            /var/log/oldboyedu.log</span><br><span class="line">[root@elk102.oldboyedu.com ~]# systemctl restart rsyslog</span><br></pre></td></tr></table></figure>



<p>04-filebeat实现日志聚合思路</p>
<p>25-tcp-to-es.yml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# cat ~/config/25-tcp-to-es.yml</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: tcp</span><br><span class="line">  host: &quot;0.0.0.0:9000&quot;</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  enabled: true</span><br><span class="line">  hosts: [&quot;http://10.0.0.101:9200&quot;,&quot;http://10.0.0.102:9200&quot;,&quot;http://10.0.0.103:9200&quot;]</span><br><span class="line">  index: &quot;oldboyedu-linux80-elk-tcp-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line">setup.template.name: &quot;oldboyedu-linux80-elk&quot;</span><br><span class="line">setup.template.pattern: &quot;oldboyedu-linux80-elk*&quot;</span><br><span class="line">setup.template.overwrite: true</span><br><span class="line">setup.template.settings:</span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line">  index.number_of_replicas: 0</span><br><span class="line">[root@elk102.oldboyedu.com ~]# rm -rf /var/lib/filebeat/*</span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -e -c ~/config/25-tcp-to-es.yml</span><br><span class="line">[root@elk103.oldboyedu.com ~]# yum -y intall telnet nc</span><br><span class="line">[root@elk103.oldboyedu.com ~]# nc 10.0.0.102 9000</span><br><span class="line">11111</span><br><span class="line">2222</span><br><span class="line">[root@elk103.oldboyedu.com ~]# telnet 10.0.0.102 9000</span><br><span class="line">aaaaaaa</span><br></pre></td></tr></table></figure>

<p>04-filebeat实现日志聚合思路</p>
<p>26-tcp-to-es.yml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# cat ~/config/26-tcp-to-es.yml</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: tcp</span><br><span class="line">  host: &quot;0.0.0.0:9000&quot;</span><br><span class="line">  tags: [&quot;aaa&quot;]</span><br><span class="line">  </span><br><span class="line">- type: tcp</span><br><span class="line">  host: &quot;0.0.0.0:8000&quot;</span><br><span class="line">  tags: [&quot;bbb&quot;]</span><br><span class="line">  </span><br><span class="line">output.elasticsearch:</span><br><span class="line">  enabled: true</span><br><span class="line">  hosts: [&quot;http://10.0.0.101:9200&quot;,&quot;http://10.0.0.102:9200&quot;,&quot;http://10.0.0.103:9200&quot;]</span><br><span class="line">  indices:</span><br><span class="line">    - index: &quot;oldboyedu-linux80-elk-aaa-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.contains:</span><br><span class="line">        tags: &quot;aaa&quot;</span><br><span class="line">        </span><br><span class="line">    - index: &quot;oldboyedu-linux80-elk-bbb-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.contains:</span><br><span class="line">        tags: &quot;bbb&quot;</span><br><span class="line"></span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line">setup.template.name: &quot;oldboyedu-linux80-elk&quot;</span><br><span class="line">setup.template.pattern: &quot;oldboyedu-linux80-elk*&quot;</span><br><span class="line">setup.template.overwrite: true</span><br><span class="line">setup.template.settings:</span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line">  index.number_of_replicas: 0</span><br><span class="line">[root@elk102.oldboyedu.com ~]# rm -rf /var/lib/filebeat/*</span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -e -c ~/config/26-tcp-to-es.yml</span><br></pre></td></tr></table></figure>

<p>05-filebeat日志聚合到本地</p>
<p>27-tcp-to-es.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/27-tcp-to-es.yml</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">tcp</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">&quot;0.0.0.0:9000&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.file:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">&quot;/tmp/filebeat&quot;</span></span><br><span class="line">  <span class="attr">filename:</span> <span class="string">oldboyedu-linux80</span></span><br><span class="line">  <span class="comment"># 指定文件的滚动大小，默认值为20MB</span></span><br><span class="line">  <span class="attr">rotate_every_kb:</span> <span class="number">102400</span></span><br><span class="line">  <span class="comment"># 指定保存的文件个数，默认是7个，有效值为2-1024个</span></span><br><span class="line">  <span class="attr">number_of_files:</span> <span class="number">300</span></span><br><span class="line">  <span class="comment"># 指定文件的权限，默认权限是0600</span></span><br><span class="line">  <span class="attr">permissions:</span> <span class="number">0600</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -e -c ~/config/27-tcp-to-es.yml</span></span><br></pre></td></tr></table></figure>









<h1 id="九-部署logstash环境及基础使用"><a href="#九-部署logstash环境及基础使用" class="headerlink" title="九.部署logstash环境及基础使用"></a>九.部署logstash环境及基础使用</h1><h2 id="1-部署logstash环境"><a href="#1-部署logstash环境" class="headerlink" title="1.部署logstash环境"></a>1.部署logstash环境</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/logstash/logstash-7.17.3-x86_64.rpm</span><br><span class="line">wget https://artifacts.elastic.co/downloads/logstash/logstash-7.17.3-linux-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line">[root@elk101.oldboyedu.com ~]# yum -y localinstall logstash-7.17.2-x86_64.rpm</span><br><span class="line"></span><br><span class="line">ln -sv /usr/share/logstash/bin/logstash /usr/local/bin/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">下载地址：</span><br><span class="line">    https://www.elastic.co/downloads/past-releases#logstash</span><br></pre></td></tr></table></figure>



<h2 id="2-修改logstash的配置文件"><a href="#2-修改logstash的配置文件" class="headerlink" title="2.修改logstash的配置文件"></a>2.修改logstash的配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">(1)编写配置文件</span><br><span class="line">cat &gt; conf.d/01-stdin-to-stdout.conf &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">input &#123;</span><br><span class="line">  stdin &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(2)检查配置文件语法</span><br><span class="line">logstash -tf conf.d/01-stdin-to-stdout.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(3)启动logstash实例</span><br><span class="line">logstash -f conf.d/01-stdin-to-stdout.conf</span><br></pre></td></tr></table></figure>



<p>视频操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# yum -y localinstall logstash-7.17.2-x86_64.rpm</span><br><span class="line">[root@elk101.oldboyedu.com ~]# ln -sv /usr/share/logstash/bin/logstash /usr/local/bin/</span><br><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/01-stdin-to-stdout.conf</span><br><span class="line">input &#123;</span><br><span class="line">  stdin &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试语法是否正确</span></span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -tf config-logstash/01-stdin-to-stdout.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动</span></span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -f config-logstash/01-stdin-to-stdout.conf</span><br></pre></td></tr></table></figure>





<h1 id="十-logstash企业级常见案例-ELFK案例"><a href="#十-logstash企业级常见案例-ELFK案例" class="headerlink" title="十.logstash企业级常见案例(ELFK案例)"></a>十.logstash企业级常见案例(ELFK案例)</h1><h2 id="1-logstash收集本地文件"><a href="#1-logstash收集本地文件" class="headerlink" title="1.logstash收集本地文件"></a>1.logstash收集本地文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">(1)编写logstash的配置文件</span><br><span class="line">cat &gt; conf.d/02-file-to-stdout &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">      # 指定收集的路径</span><br><span class="line">      path =&gt; [&quot;/tmp/test/*.txt&quot;]</span><br><span class="line">      # 指定文件的读取位置,仅在&quot;.sincedb*&quot;文件中没有记录的情况下生效!</span><br><span class="line">      start_positioh =&gt; &quot;beginning&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">  </span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">elasticsearch &#123;</span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">&#125;</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(2)启动logstash实例</span><br><span class="line">logstash -rf conf.d/02-file-to-stdout</span><br></pre></td></tr></table></figure>



<p>视频操作：</p>
<p>02-file-to-stdout.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/02-file-to-stdout.conf</span><br><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">      # 指定收集的路径</span><br><span class="line">      path =&gt; [&quot;/tmp/test/*.txt&quot;]</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -f config-logstash/02-file-to-stdout.conf</span><br><span class="line">[root@elk101.oldboyedu.com ~]# cd /tmp</span><br><span class="line">[root@elk101.oldboyedu.com tmp]# mkdir test</span><br><span class="line">[root@elk101.oldboyedu.com tmp]# cd test</span><br><span class="line">[root@elk101.oldboyedu.com test]# echo 1111 &gt; 1.txt</span><br><span class="line">[root@elk101.oldboyedu.com test]# echo 2222 &gt;&gt; 1.txt</span><br><span class="line">[root@elk101.oldboyedu.com test]# echo 3333 &gt;&gt; 1.txt</span><br><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/02-file-to-stdout.conf</span><br><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">      # 指定收集的路径</span><br><span class="line">      path =&gt; [&quot;/tmp/test/*.txt&quot;]</span><br><span class="line">      # 指定文件的读取位置,仅在&quot;.sincedb*&quot;文件中没有记录的情况下生效!</span><br><span class="line">      start_positioh =&gt; &quot;beginning&quot;</span><br><span class="line">      # start_positioh =&gt; &quot;end&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -f config-logstash/02-file-to-stdout.conf</span><br></pre></td></tr></table></figure>



<p>03-tcp-to-stdout.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/03-tcp-to-stdout.conf</span><br><span class="line">input &#123;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    port =&gt; 8888</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -f config-logstash/03-tcp-to-stdout.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看监听8888端口</span></span><br><span class="line">[root@elk101.oldboyedu.com ~]# ss -ntl</span><br><span class="line">[root@elk103.oldboyedu.com ~]# telnet 10.0.0.101 8888</span><br><span class="line">aaaaaaaaaaaaaa</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">多端口启动</span></span><br><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/03-tcp-to-stdout.conf</span><br><span class="line">input &#123;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    port =&gt; 8888</span><br><span class="line">  &#125;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    port =&gt; 9999</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>04-http-to-stdout.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/04-http-to-stdout.conf</span><br><span class="line">input &#123;</span><br><span class="line">  http &#123;</span><br><span class="line">    port =&gt; 8888</span><br><span class="line">  &#125;</span><br><span class="line">  http &#123;</span><br><span class="line">    port =&gt; 9999</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -f config-logstash/04-http-to-stdout.conf</span><br></pre></td></tr></table></figure>



<h2 id="3-logstash收集本地文件、input插件基于file案例"><a href="#3-logstash收集本地文件、input插件基于file案例" class="headerlink" title="3.logstash收集本地文件、input插件基于file案例"></a>3.logstash收集本地文件、input插件基于file案例</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/02-file-to-stdout.conf</span><br><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">      # 指定收集的路径</span><br><span class="line">      path =&gt; [&quot;/tmp/test/*.txt&quot;]</span><br><span class="line">      # 指定文件的读取位置,仅在&quot;.sincedb*&quot;文件中没有记录的情况下生效!</span><br><span class="line">      start_positioh =&gt; &quot;beginning&quot;</span><br><span class="line">      # start_positioh =&gt; &quot;end&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -f config-logstash/02-file-to-stdout.conf</span><br></pre></td></tr></table></figure>





<h2 id="4-logstash实现日志聚合、input插件基于tcp案例"><a href="#4-logstash实现日志聚合、input插件基于tcp案例" class="headerlink" title="4.logstash实现日志聚合、input插件基于tcp案例"></a>4.logstash实现日志聚合、input插件基于tcp案例</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/03-tcp-to-stdout.conf</span><br><span class="line">input &#123;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    port =&gt; 8888</span><br><span class="line">  &#125;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    port =&gt; 9999</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-input插件基于基于http案例"><a href="#5-input插件基于基于http案例" class="headerlink" title="5.input插件基于基于http案例"></a>5.input插件基于基于http案例</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/04-http-to-stdout.conf</span><br><span class="line">input &#123;</span><br><span class="line">  http &#123;</span><br><span class="line">    port =&gt; 8888</span><br><span class="line">  &#125;</span><br><span class="line">  http &#123;</span><br><span class="line">    port =&gt; 9999</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -f config-logstash/04-http-to-stdout.conf</span><br></pre></td></tr></table></figure>



<h2 id="6-input插件基于redis案例"><a href="#6-input插件基于redis案例" class="headerlink" title="6.input插件基于redis案例"></a>6.input插件基于redis案例</h2><p>14-logstash和redis对接</p>
<p>05-redis-to-stdout.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/05-redis-to-stdout.conf</span><br><span class="line">input &#123;</span><br><span class="line">  redis &#123;</span><br><span class="line">    # 指定的是REDIS的键(key)的类型</span><br><span class="line">    data_type =&gt; &quot;list&quot;</span><br><span class="line">    # 指定数据库的编号,默认值是0号数据库</span><br><span class="line">    db =&gt; 5</span><br><span class="line">    # 指定数据库的ip地址,默认值是localhost</span><br><span class="line">    host =&gt; &quot;10.0.0.101&quot;</span><br><span class="line">    # 指定数据库的端口号,默认值为6379</span><br><span class="line">    port =&gt; 6379</span><br><span class="line">    # 指定redis的认证密码</span><br><span class="line">    password =&gt; &quot;oldboyedu&quot;</span><br><span class="line">    # 指定从redis的哪个key取数据</span><br><span class="line">    key =&gt; &quot;oldboyedu-linux80-filebeat&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -f config-logstash/05-redis-to-stdout.conf</span><br></pre></td></tr></table></figure>

<p>14-logstash和redis对接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# cat ~/config/28-tcp-to-redis.yml</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: tcp</span><br><span class="line">  host: &quot;0.0.0.0:9000&quot;</span><br><span class="line"></span><br><span class="line">output.redis:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">写入redis的主机地址</span></span><br><span class="line">  hosts: [&quot;10.0.0.101:6379&quot;]</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定redis的认证口令</span></span><br><span class="line">  password: &quot;oldboyedu&quot;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定连接数据库的编号</span></span><br><span class="line">  db: 5</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定的key值</span></span><br><span class="line">  key: &quot;oldboyedu-linux80-filebeat&quot;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">规定超时时间</span></span><br><span class="line">  timeout: 3</span><br><span class="line"></span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -e -c ~/config/28-tcp-to-redis.yml</span><br><span class="line">[root@elk103.oldboyedu.com ~]# redis-cli -h 10.0.0.101 -a oldboyedu</span><br><span class="line">10.0.0.101:6379&gt; SELECT 5</span><br><span class="line">OK</span><br><span class="line">10.0.0.101:6379&gt; KEYS *</span><br><span class="line">1) &quot;oldboyedu-linux80-filebeat&quot;</span><br><span class="line">10.0.0.101:6379&gt; TYPE oldboyedu-linux80-filebeat</span><br><span class="line">list</span><br><span class="line">10.0.0.101:6379&gt; LRANGE oldboyedu-linux80-filebeat</span><br></pre></td></tr></table></figure>





<h2 id="7-input插件基于beats案例、filebeat和logstash打通"><a href="#7-input插件基于beats案例、filebeat和logstash打通" class="headerlink" title="7.input插件基于beats案例、filebeat和logstash打通"></a>7.input插件基于beats案例、filebeat和logstash打通</h2><p>15-logstsh和filebeat对接案例</p>
<p>29-tcp-to-logstash.yml  filbeat配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# cat ~/config/29-tcp-to-logstash.yml</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: tcp</span><br><span class="line">  host: &quot;0.0.0.0:9000&quot;</span><br><span class="line"></span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [&quot;10.0.0.101:5044&quot;]</span><br><span class="line"></span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -e -c ~/config/29-tcp-to-logstash.yml</span><br></pre></td></tr></table></figure>

<p>06-beats-to-stdout.conf  logstash配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/06-beats-to-stdout.conf</span><br><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 5044</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -rf config-logstash/06-beats-to-stdout.conf</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 222222 | nc 10.0.0.102 9000</span><br></pre></td></tr></table></figure>



<h2 id="8-output插件基于redis案例"><a href="#8-output插件基于redis案例" class="headerlink" title="8.output插件基于redis案例"></a>8.output插件基于redis案例</h2><p>16-logstash发送数据到redis环境</p>
<p>07-tcp-to-redis.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/07-tcp-to-redis.conf</span><br><span class="line">input &#123;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    port =&gt; 9999</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  redis &#123;</span><br><span class="line">    # 指定redis的主机地址</span><br><span class="line">    host =&gt; &quot;10.0.0.101&quot;</span><br><span class="line">    # 指定redis的端口号</span><br><span class="line">    port =&gt; &quot;6379&quot;</span><br><span class="line">    # 指定redis数据库编号</span><br><span class="line">    db =&gt; 10</span><br><span class="line">    # 指定redis的密码</span><br><span class="line">    password =&gt; &quot;oldboyedu&quot;</span><br><span class="line">    # 指定写入数据的key类型</span><br><span class="line">    data_type =&gt; &quot;list&quot;</span><br><span class="line">    # 指定的写入的key名称</span><br><span class="line">    key =&gt; &quot;oldboyedu-linux80-logstash&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -rf config-logstash/07-tcp-to-redis.conf</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 111111111 | nc 10.0.0.101 9999</span><br></pre></td></tr></table></figure>

<p>查看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@elk103.oldboyedu.com ~]# redis-cli -h 10.0.0.101 -a oldboyedu --raw</span><br><span class="line">10.0.0.101:6379[10]&gt; LRRANGE oldboyedu-linux80-logstash 0 -1</span><br></pre></td></tr></table></figure>



<h2 id="9-output插件基于file案例"><a href="#9-output插件基于file案例" class="headerlink" title="9.output插件基于file案例"></a>9.output插件基于file案例</h2><p>17-logstash输出插件file案例</p>
<p>08-tcp-to-file.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/08-tcp-to-file.conf</span><br><span class="line">input &#123;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    port =&gt; 9999</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  file &#123;</span><br><span class="line">    # 指定磁盘的落地位置</span><br><span class="line">    path =&gt; &quot;/tmp/oldboyedu-linux80-logstash.log&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -f config-logstash/08-tcp-to-file.conf</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 123 | nc 10.0.0.101 9999</span><br></pre></td></tr></table></figure>

<p>查看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# cat /tmp/oldboyedu-linux80-logstash.log</span><br></pre></td></tr></table></figure>



<p>18-logstash的output插件es案例</p>
<p>09-tcp-to-es.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/09-tcp-to-es.conf</span><br><span class="line">input &#123;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    port =&gt; 9999</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line">    index =&gt; &quot;oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -rf config-logstash/09-tcp-to-es.conf</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 123 | nc 10.0.0.101 9999</span><br></pre></td></tr></table></figure>



<h2 id="10-logstash综合案例"><a href="#10-logstash综合案例" class="headerlink" title="10.logstash综合案例"></a>10.logstash综合案例</h2><p>19-logstash综合案例</p>
<p><img src="D:\文件管理\Typora\images\ELK部署.assest\image-20220828155752044.png" alt="image-20220828155752044"></p>
<p>10-many-to-es.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/10-many-to-es.conf</span><br><span class="line">input &#123;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    type =&gt; &quot;oldboyedutcp&quot;</span><br><span class="line">    port =&gt; 6666</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  beats &#123;</span><br><span class="line">    type =&gt; &quot;oldboyedu-beat&quot;</span><br><span class="line">    port =&gt; 7777</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  redis &#123;</span><br><span class="line">    type =&gt; &quot;oldboyedu-redis&quot;</span><br><span class="line">    data_type =&gt; &quot;list&quot;</span><br><span class="line">    db =&gt; 5</span><br><span class="line">    host =&gt; &quot;10.0.0.101&quot;</span><br><span class="line">    port =&gt; 6379</span><br><span class="line">    password =&gt; &quot;oldboyedu&quot;</span><br><span class="line">    key =&gt; &quot;oldboyedu-linux80-filebeat&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">stdout &#123;&#125;</span></span><br><span class="line">  </span><br><span class="line">  if [type] == &quot;oldboyedu-tcp&quot; &#123;</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">          hosts =&gt; [&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line">          index =&gt; &quot;oldboyedu-linux80-tcp-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125; else if [type] == &quot;oldboyedu-beat&quot; &#123;</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">          hosts =&gt; [&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line">          index =&gt; &quot;oldboyedu-linux80-beat-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125; else if [type] == &quot;oldboyedu-redis&quot; &#123;</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">          hosts =&gt; [&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line">          index =&gt; &quot;oldboyedu-linux80-redis-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">          hosts =&gt; [&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line">          index =&gt; &quot;oldboyedu-linux80-other-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -rf config-logstash/10-many-to-es.conf</span><br></pre></td></tr></table></figure>

<p>测试tcp</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo aaaaaaa | nc 10.0.0.101 6666</span><br></pre></td></tr></table></figure>

<p>30-tcp-to-logstash.yml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# cat ~/config/30-tcp-to-logstash.yml</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: tcp</span><br><span class="line">  host: &quot;0.0.0.0:9999&quot;</span><br><span class="line"></span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [&quot;10.0.0.101:7777&quot;]</span><br><span class="line"></span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -e -c ~/config/30-tcp-to-logstash.yml</span><br></pre></td></tr></table></figure>

<p>测试beat</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo bbbbbbbbb | nc 10.0.0.102 9999</span><br></pre></td></tr></table></figure>

<p>31-tcp-to-redis.yml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# cat ~/config/31-tcp-to-redis.yml</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: tcp</span><br><span class="line">  host: &quot;0.0.0.0:8888&quot;</span><br><span class="line"></span><br><span class="line">output.redis:</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">写入redis的主机地址</span></span><br><span class="line">  hosts: [&quot;10.0.0.101:6379&quot;]</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定redis的认证口令</span></span><br><span class="line">  password: &quot;oldboyedu&quot;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定连接数据库的编号</span></span><br><span class="line">  db: 5</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">指定的key值</span></span><br><span class="line">  key: &quot;oldboyedu-linux80-filebeat&quot;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">规定超时时间</span></span><br><span class="line">  timeout: 3</span><br><span class="line"></span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -e -c ~/config/31-tcp-to-redis.yml --path.data /tmp/filebeat/</span><br></pre></td></tr></table></figure>

<p>测试redis</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo cccccc | nc 10.0.0.102 8888</span><br></pre></td></tr></table></figure>



<p>01-昨日作业讲解</p>
<p>32-nginx-to-redis.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/32-nginx-to-redis.yml</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/nginx/access.log*</span></span><br><span class="line">  <span class="attr">json.keys_under_root:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.redis:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;10.0.0.101:6379&quot;</span>]</span><br><span class="line">  <span class="attr">password:</span> <span class="string">&quot;oldboyedu&quot;</span></span><br><span class="line">  <span class="attr">db:</span> <span class="number">8</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">&quot;oldboyedu-linux80-filebeat&quot;</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="number">3</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -e -c ~/config/32-nginx-to-redis.yml</span></span><br></pre></td></tr></table></figure>

<p>11-many-to-es.conf</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk101.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># vim config-logstash/11-many-to-es.conf</span></span><br><span class="line"><span class="string">input</span> &#123;</span><br><span class="line">  <span class="string">beats</span> &#123;</span><br><span class="line">    <span class="string">port</span> <span class="string">=&gt;</span> <span class="number">8888</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">redis</span> &#123;</span><br><span class="line">    <span class="string">data_type</span> <span class="string">=&gt;</span> <span class="string">&quot;list&quot;</span></span><br><span class="line">    <span class="string">db</span> <span class="string">=&gt;</span> <span class="number">8</span></span><br><span class="line">    <span class="string">host</span> <span class="string">=&gt;</span> <span class="string">&quot;10.0.0.101&quot;</span></span><br><span class="line">    <span class="string">port</span> <span class="string">=&gt;</span> <span class="number">6379</span></span><br><span class="line">    <span class="string">password</span> <span class="string">=&gt;</span> <span class="string">&quot;oldboyedu&quot;</span></span><br><span class="line">    <span class="string">key</span> <span class="string">=&gt;</span> <span class="string">&quot;oldboyedu-linux80-filebeat&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">output</span> &#123;</span><br><span class="line">  <span class="string">stdout</span> &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="string">elasticsearch</span> &#123;</span><br><span class="line">    <span class="string">hosts</span> <span class="string">=&gt;</span> [<span class="string">&quot;10.0.0.101:9200&quot;</span>,<span class="string">&quot;10.0.0.102:9200&quot;</span>,<span class="string">&quot;10.0.0.103:9200&quot;</span>]</span><br><span class="line">    <span class="string">index</span> <span class="string">=&gt;</span> <span class="string">&quot;oldboyedu-linux80-logstash-<span class="template-variable">%&#123;+YYYY.MM.dd&#125;</span>&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[<span class="string">root@elk101.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># logstash -f config-logstash/11-many-to-es.conf</span></span><br></pre></td></tr></table></figure>

<p>33-tomcat-to-logstash.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/33-tomcat-to-logstash.yml</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/oldboyedu/softwares/apache-tomcat-10.0.20/logs/*.txt</span></span><br><span class="line">  <span class="attr">json.keys_under_root:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.logstash:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;10.0.0.101:8888&quot;</span>]</span><br><span class="line"></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -e -c ~/config/33-tomcat-to-logstash.yml --path.data /tmp/filebeat/</span></span><br></pre></td></tr></table></figure>



<p>02-logstsash多实例案例</p>
<p>12-beat-to-es.conf</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk101.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># vim config-logstash/12-beat-to-es.conf</span></span><br><span class="line"><span class="string">input</span> &#123;</span><br><span class="line">  <span class="string">beats</span> &#123;</span><br><span class="line">    <span class="string">port</span> <span class="string">=&gt;</span> <span class="number">8888</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">output</span> &#123;</span><br><span class="line">  <span class="string">stdout</span> &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="string">elasticsearch</span> &#123;</span><br><span class="line">    <span class="string">hosts</span> <span class="string">=&gt;</span> [<span class="string">&quot;10.0.0.101:9200&quot;</span>,<span class="string">&quot;10.0.0.102:9200&quot;</span>,<span class="string">&quot;10.0.0.103:9200&quot;</span>]</span><br><span class="line">    <span class="string">index</span> <span class="string">=&gt;</span> <span class="string">&quot;oldboyedu-linux80-logstash-<span class="template-variable">%&#123;+YYYY.MM.dd&#125;</span>&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[<span class="string">root@elk101.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># logstash -f config-logstash/12-beat-to-es.conf --path.data /tmp/logstash/</span></span><br></pre></td></tr></table></figure>

<p>13-redis-to-es.conf</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk101.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># vim config-logstash/13-redis-to-es.conf</span></span><br><span class="line"><span class="string">input</span> &#123;</span><br><span class="line">  <span class="string">redis</span> &#123;</span><br><span class="line">    <span class="string">data_type</span> <span class="string">=&gt;</span> <span class="string">&quot;list&quot;</span></span><br><span class="line">    <span class="string">db</span> <span class="string">=&gt;</span> <span class="number">8</span></span><br><span class="line">    <span class="string">host</span> <span class="string">=&gt;</span> <span class="string">&quot;10.0.0.101&quot;</span></span><br><span class="line">    <span class="string">port</span> <span class="string">=&gt;</span> <span class="number">6379</span></span><br><span class="line">    <span class="string">password</span> <span class="string">=&gt;</span> <span class="string">&quot;oldboyedu&quot;</span></span><br><span class="line">    <span class="string">key</span> <span class="string">=&gt;</span> <span class="string">&quot;oldboyedu-linux80-filebeat&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">output</span> &#123;</span><br><span class="line">  <span class="string">stdout</span> &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="string">elasticsearch</span> &#123;</span><br><span class="line">    <span class="string">hosts</span> <span class="string">=&gt;</span> [<span class="string">&quot;10.0.0.101:9200&quot;</span>,<span class="string">&quot;10.0.0.102:9200&quot;</span>,<span class="string">&quot;10.0.0.103:9200&quot;</span>]</span><br><span class="line">    <span class="string">index</span> <span class="string">=&gt;</span> <span class="string">&quot;oldboyedu-linux80-logstash-<span class="template-variable">%&#123;+YYYY.MM.dd&#125;</span>&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[<span class="string">root@elk101.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># logstash -f config-logstash/13-redis-to-es.conf</span></span><br></pre></td></tr></table></figure>





<h1 id="十-logstash企业级插件案例-ELFK架构"><a href="#十-logstash企业级插件案例-ELFK架构" class="headerlink" title="十.logstash企业级插件案例(ELFK架构)"></a>十.logstash企业级插件案例(ELFK架构)</h1><h2 id="1-常见的插件概述"><a href="#1-常见的插件概述" class="headerlink" title="1.常见的插件概述"></a>1.常见的插件概述</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gork插件:</span><br><span class="line">    Grok是将非结构化日志数据解析为结构化和可查询的好方法。底层原理是基于正则匹配任意文本格式。</span><br><span class="line">    该工具非常适合syslog日志、apache和其他网络服务器日志、mysql日志，以及通常为人类而非计算机消耗而编写的任何日志格式。</span><br><span class="line">    内置120种匹配模式，当然也可以自定义匹配模式：</span><br><span class="line">        https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns</span><br></pre></td></tr></table></figure>



<h2 id="2-使用grok内置的正则案例"><a href="#2-使用grok内置的正则案例" class="headerlink" title="2.使用grok内置的正则案例"></a>2.使用grok内置的正则案例</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk101.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># vim config-logstash/14-beat-grok-es.conf</span></span><br><span class="line"><span class="string">input</span> &#123;</span><br><span class="line">  <span class="string">beats</span> &#123;</span><br><span class="line">    <span class="string">port</span> <span class="string">=&gt;</span> <span class="number">8888</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">filter&#123;</span></span><br><span class="line">  <span class="string">grok</span> &#123;</span><br><span class="line">    <span class="string">match</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">      <span class="string">&quot;message&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;<span class="template-variable">%&#123;COMBINEDAPACHELOG&#125;</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">output</span> &#123;</span><br><span class="line">  <span class="string">stdout</span> &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="string">elasticsearch</span> &#123;</span><br><span class="line">    <span class="string">hosts</span> <span class="string">=&gt;</span> [<span class="string">&quot;10.0.0.101:9200&quot;</span>,<span class="string">&quot;10.0.0.102:9200&quot;</span>,<span class="string">&quot;10.0.0.103:9200&quot;</span>]</span><br><span class="line">    <span class="string">index</span> <span class="string">=&gt;</span> <span class="string">&quot;oldboyedu-linux80-logstash-<span class="template-variable">%&#123;+YYYY.MM.dd&#125;</span>&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[<span class="string">root@elk101.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># logstash -rf config-logstash/14-beat-grok-es.conf</span></span><br></pre></td></tr></table></figure>

<p>03-grok插件实战案例</p>
<p>14-beat-grok-es.conf</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk101.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># vim config-logstash/14-beat-grok-es.conf</span></span><br><span class="line"><span class="string">input</span> &#123;</span><br><span class="line">  <span class="string">beats</span> &#123;</span><br><span class="line">    <span class="string">port</span> <span class="string">=&gt;</span> <span class="number">8888</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">filter&#123;</span></span><br><span class="line">  <span class="string">grok</span> &#123;</span><br><span class="line">    <span class="string">match</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">      <span class="comment"># &quot;message&quot; =&gt; &quot;%&#123;COMBINEDAPACHELOG&#125;&quot;</span></span><br><span class="line">      <span class="comment"># 上面的变量&quot;&quot;变量官方github上已经废弃，建议使用下面的匹配模式</span></span><br><span class="line">      <span class="comment">#  https://github.com/logstash-plugins/logstash-patterns-core/blob/main/patterns/legacy/httpd</span></span><br><span class="line">      <span class="string">&quot;message&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;<span class="template-variable">%&#123;HTTPD_COMMONLOG&#125;</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">output</span> &#123;</span><br><span class="line">  <span class="string">stdout</span> &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="string">elasticsearch</span> &#123;</span><br><span class="line">    <span class="string">hosts</span> <span class="string">=&gt;</span> [<span class="string">&quot;10.0.0.101:9200&quot;</span>,<span class="string">&quot;10.0.0.102:9200&quot;</span>,<span class="string">&quot;10.0.0.103:9200&quot;</span>]</span><br><span class="line">    <span class="string">index</span> <span class="string">=&gt;</span> <span class="string">&quot;oldboyedu-linux80-logstash-<span class="template-variable">%&#123;+YYYY.MM.dd&#125;</span>&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[<span class="string">root@elk101.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># logstash -rf config-logstash/14-beat-grok-es.conf</span></span><br></pre></td></tr></table></figure>

<p>34-nginx-to-logstash.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/34-nginx-to-logstash.yml</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/nginx/access.log</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.logstash:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;10.0.0.101:8888&quot;</span>]</span><br><span class="line"></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -e -c ~/config/34-nginx-to-logstash.yml</span></span><br></pre></td></tr></table></figure>



<h2 id="3-使用grok自定义的正则案例1"><a href="#3-使用grok自定义的正则案例1" class="headerlink" title="3.使用grok自定义的正则案例1"></a>3.使用grok自定义的正则案例1</h2><p>15-stdin-grok-stdout.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/15-stdin-grok-stdout.conf</span><br><span class="line">input &#123;</span><br><span class="line">  stdin &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    match =&gt; &#123;</span><br><span class="line">      &quot;message&quot; =&gt; &quot;%&#123;IP:oldboyedu-client&#125; %&#123;WORD:oldboyedu-method&#125; %&#123;URIPATHPARAM:oldboyedu-request&#125; %&#123;NUMBER:oldboyedu-bytes&#125; %&#123;NUMBER:oldboyedu-duration&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -rf config-logstash/15-stdin-grok-stdout.conf</span><br></pre></td></tr></table></figure>

<p>测试，输入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">55.3.244.1 GET /index.html 15824 0.043</span><br></pre></td></tr></table></figure>





<h2 id="4-使用grok自定义的正则案例2"><a href="#4-使用grok自定义的正则案例2" class="headerlink" title="4.使用grok自定义的正则案例2"></a>4.使用grok自定义的正则案例2</h2><p>16-stdin-grok_custom_patterns-stdout.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/16-stdin-grok_custom_patterns-stdout.conf</span><br><span class="line">input &#123;</span><br><span class="line">  stdin &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    # 指定匹配模式的目录，可以使用绝对路径</span><br><span class="line">    patterns_dir =&gt; [&quot;./patterns&quot;]</span><br><span class="line">    # 匹配模式</span><br><span class="line">    match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;SYSLOGBASE&#125; %&#123;POSTFIX_QUEUEID:queue_id&#125;: %&#123;GREEDYDATA:syslog_message&#125;&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@elk101.oldboyedu.com ~]# mkdir patterns</span><br><span class="line">[root@elk101.oldboyedu.com ~]# echo &quot;POSTFIX_QUEUEID [0-9A-F]&#123;10,11&#125;&quot; &gt;&gt; patterns/1</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -f config-logstash/16-stdin-grok_custom_patterns-stdout.conf</span><br></pre></td></tr></table></figure>

<p>测试，输入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Jan  1 06:25:43 mailserver14 postfix/cleanup[21403]: BEF25A72965: message-id=&lt;20130101142543.5828399CCAF@mailserver14.example.com&gt;</span><br></pre></td></tr></table></figure>

<p>修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# cat patterns/1</span><br><span class="line">POSTFIX_QUEUEID [0-9A-F]&#123;10,11&#125;</span><br><span class="line">OLDBOYEDU_LINUX80 [\d]&#123;3&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/16-stdin-grok_custom_patterns-stdout.conf</span><br><span class="line">input &#123;</span><br><span class="line">  stdin &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    # 指定匹配模式的目录，可以使用绝对路径</span><br><span class="line">    # 在./patterns目录下随便创建一个文件，并写入以下匹配模式</span><br><span class="line">    #    POSTFIX_QUEUEID [0-9A-F]&#123;10,11&#125;</span><br><span class="line">    #    OLDBOYEDU_LINUX80 [\d]&#123;3&#125;</span><br><span class="line">    patterns_dir =&gt; [&quot;./patterns&quot;]</span><br><span class="line">    </span><br><span class="line">    # 匹配模式</span><br><span class="line">    # 测试数据为：Jan  1 06:25:43 mailserver14 postfix/cleanup[21403]: BEF25A72965: message-id=&lt;20130101142543.5828399CCAF@mailserver14.example.com&gt;</span><br><span class="line">    # match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;SYSLOGBASE&#125; %&#123;POSTFIX_QUEUEID:queue_id&#125;: %&#123;GREEDYDATA:syslog_message&#125;&quot; &#125;</span><br><span class="line">    </span><br><span class="line">    # 测试数据为：ABCDE12345678910 ---&gt; 333FGHIJK</span><br><span class="line">    match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;SYSLOGBASE&#125; %&#123;POSTFIX_QUEUEID:oldboyedu_queue_id&#125; ---&gt; %&#123;OLDBOYEDU_LINUX80:oldboyedu_linux80_elk&#125;&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -f config-logstash/16-stdin-grok_custom_patterns-stdout.conf</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">12345678910 ---&gt; 333</span><br></pre></td></tr></table></figure>





<p>06-filter插件字段remove_field，移除指定的字段</p>
<p>17-beat-grok-es.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/17-beat-grok-es.conf</span><br><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 8888</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter&#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    match =&gt; &#123;</span><br><span class="line">      # &quot;message&quot; =&gt; &quot;%&#123;COMBINEDAPACHELOG&#125;&quot;</span><br><span class="line">      # 上面的变量&quot;&quot;变量官方github上已经废弃，建议使用下面的匹配模式</span><br><span class="line">      #  https://github.com/logstash-plugins/logstash-patterns-core/blob/main/patterns/legacy/httpd</span><br><span class="line">      &quot;message&quot; =&gt; &quot;%&#123;HTTPD_COMMONLOG&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    # 移除指定的字段</span><br><span class="line">    remove_field =&gt; [ &quot;@version&quot;, &quot;ecs&quot;, &quot;tags&quot;, &quot;agent&quot;, &quot;input&quot;, &quot;log&quot; ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line">    index =&gt; &quot;oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -rf config-logstash/17-beat-grok-es.conf</span><br></pre></td></tr></table></figure>



<p>07-filter通用字段add_field案例，添加指定的字段</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/17-beat-grok-es.conf</span><br><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 8888</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter&#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    match =&gt; &#123;</span><br><span class="line">      # &quot;message&quot; =&gt; &quot;%&#123;COMBINEDAPACHELOG&#125;&quot;</span><br><span class="line">      # 上面的变量&quot;&quot;变量官方github上已经废弃，建议使用下面的匹配模式</span><br><span class="line">      #  https://github.com/logstash-plugins/logstash-patterns-core/blob/main/patterns/legacy/httpd</span><br><span class="line">      &quot;message&quot; =&gt; &quot;%&#123;HTTPD_COMMONLOG&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    # 移除指定的字段</span><br><span class="line">    remove_field =&gt; [ &quot;@version&quot;, &quot;ecs&quot;, &quot;tags&quot;, &quot;agent&quot;, &quot;input&quot;, &quot;log&quot; ]</span><br><span class="line">    </span><br><span class="line">    # 添加指定的字段</span><br><span class="line">    add_field =&gt; &#123; &quot;oldboyedu-clientip&quot; =&gt; &quot;clientip ---&gt; %&#123;clientip&#125;&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line">    index =&gt; &quot;oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -rf config-logstash/17-beat-grok-es.conf</span><br></pre></td></tr></table></figure>

<p>添加多个字段</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/17-beat-grok-es.conf</span><br><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 8888</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter&#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    match =&gt; &#123;</span><br><span class="line">      # &quot;message&quot; =&gt; &quot;%&#123;COMBINEDAPACHELOG&#125;&quot;</span><br><span class="line">      # 上面的变量&quot;&quot;变量官方github上已经废弃，建议使用下面的匹配模式</span><br><span class="line">      #  https://github.com/logstash-plugins/logstash-patterns-core/blob/main/patterns/legacy/httpd</span><br><span class="line">      &quot;message&quot; =&gt; &quot;%&#123;HTTPD_COMMONLOG&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    # 移除指定的字段</span><br><span class="line">    remove_field =&gt; [ &quot;@version&quot;, &quot;ecs&quot;, &quot;tags&quot;, &quot;agent&quot;, &quot;input&quot;, &quot;log&quot; ]</span><br><span class="line">    </span><br><span class="line">    # 添加指定的字段</span><br><span class="line">    add_field =&gt; &#123;</span><br><span class="line">      &quot;school&quot; =&gt; &quot;北京市昌平区沙河镇老男孩IT教育&quot;</span><br><span class="line">      &quot;oldboyedu-clientip&quot; =&gt; &quot;clientip ---&gt; %&#123;clientip&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line">    index =&gt; &quot;oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -rf config-logstash/17-beat-grok-es.conf</span><br></pre></td></tr></table></figure>



<h2 id="5-通用字段案例"><a href="#5-通用字段案例" class="headerlink" title="5.通用字段案例"></a>5.通用字段案例</h2><p>08-filebeat的通用字段案例</p>
<p>17-beat-grok-es.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/17-beat-grok-es.conf</span><br><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 8888</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter&#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    match =&gt; &#123;</span><br><span class="line">      # &quot;message&quot; =&gt; &quot;%&#123;COMBINEDAPACHELOG&#125;&quot;</span><br><span class="line">      # 上面的变量&quot;&quot;变量官方github上已经废弃，建议使用下面的匹配模式</span><br><span class="line">      #  https://github.com/logstash-plugins/logstash-patterns-core/blob/main/patterns/legacy/httpd</span><br><span class="line">      &quot;message&quot; =&gt; &quot;%&#123;HTTPD_COMMONLOG&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    # 移除指定的字段</span><br><span class="line">    remove_field =&gt; [ &quot;@version&quot;, &quot;ecs&quot;, &quot;tags&quot;, &quot;agent&quot;, &quot;input&quot;, &quot;log&quot; ]</span><br><span class="line">    </span><br><span class="line">    # 添加指定的字段</span><br><span class="line">    add_field =&gt; &#123;</span><br><span class="line">      &quot;school&quot; =&gt; &quot;北京市昌平区沙河镇老男孩IT教育&quot;</span><br><span class="line">      &quot;oldboyedu-clientip&quot; =&gt; &quot;clientip ---&gt; %&#123;clientip&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    # 添加tag</span><br><span class="line">    add_tag =&gt; [ &quot;linux80&quot;,&quot;zookeeper&quot;,&quot;kafka&quot;,&quot;elk&quot; ]</span><br><span class="line">    </span><br><span class="line">    # 移除tag</span><br><span class="line">    remove_tag =&gt; [ &quot;zookeeper&quot;, &quot;kafka&quot; ]</span><br><span class="line">    </span><br><span class="line">    # 创建插件的唯一ID，如果不创建则系统默认生成</span><br><span class="line">    id =&gt; &quot;nginx&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line">    index =&gt; &quot;oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -rf config-logstash/17-beat-grok-es.conf</span><br></pre></td></tr></table></figure>



<p>01-ELasticStack技术栈数据流走向</p>
<p><img src="D:\文件管理\Typora\images\ELK部署.assest\image-20220829094507209.png" alt="image-20220829094507209"></p>
<p>02-互联网产品架构分层</p>
<p><img src="D:\文件管理\Typora\images\ELK部署.assest\image-20220829095648310.png" alt="image-20220829095648310"></p>
<h2 id="6-date插件修改写入ES的时间"><a href="#6-date插件修改写入ES的时间" class="headerlink" title="6.date插件修改写入ES的时间"></a>6.date插件修改写入ES的时间</h2><p>18-beat-grok_geoip-es.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/18-beat-grok_date-es.conf</span><br><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 8888</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter&#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    match =&gt; &#123;</span><br><span class="line">      # &quot;message&quot; =&gt; &quot;%&#123;COMBINEDAPACHELOG&#125;&quot;</span><br><span class="line">      # 上面的变量&quot;&quot;变量官方github上已经废弃，建议使用下面的匹配模式</span><br><span class="line">      #  https://github.com/logstash-plugins/logstash-patterns-core/blob/main/patterns/legacy/httpd</span><br><span class="line">      &quot;message&quot; =&gt; &quot;%&#123;HTTPD_COMMONLOG&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    # 移除指定的字段</span><br><span class="line">    remove_field =&gt; [ &quot;@version&quot;, &quot;ecs&quot;, &quot;tags&quot;, &quot;agent&quot;, &quot;input&quot;, &quot;log&quot; ]</span><br><span class="line">    </span><br><span class="line">    # 添加指定的字段</span><br><span class="line">    add_field =&gt; &#123;</span><br><span class="line">      &quot;school&quot; =&gt; &quot;北京市昌平区沙河镇老男孩IT教育&quot;</span><br><span class="line">    &#125;    </span><br><span class="line">  &#125;</span><br><span class="line">  date &#123;</span><br><span class="line">      # 匹配时间字段并解析，值得注意的是，logstash的输出时间可能会错8小时，但写入es的数据是准确的!</span><br><span class="line">      # &quot;13/May/2022:15:47:24 +0800&quot;,以下2种match写法均可!</span><br><span class="line">      match =&gt; [&quot;timestamp&quot;,&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]</span><br><span class="line">      # 当然，我们也可以不对时区字段进行解析，而是使用&quot;timezone&quot;指定时区</span><br><span class="line">      # match =&gt; [&quot;timestamp&quot;,&quot;dd/MMM/yyyy:HH:mm:ss +0800&quot;]</span><br><span class="line">      </span><br><span class="line">      # 设置时区字段为UTC时间,写入ES的数据时间是不准确的</span><br><span class="line">      # timezone =&gt; &quot;UTC&quot;</span><br><span class="line">      # 建议大家设置为&quot;Asia/Shanghai&quot;，写入ES的数据是准确的!</span><br><span class="line">      # timezone =&gt; &quot;Asia/Shanghai&quot;</span><br><span class="line">      </span><br><span class="line">      # 将匹配到到时间字段解析后存储到目标字段，若不指定，则默认字段为&quot;@timestamp&quot;字段</span><br><span class="line">      target =&gt; &quot;oldboyedu-linux80-nginx-access-time&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line">    index =&gt; &quot;oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -rf config-logstash/18-beat-grok_date-es.conf</span><br></pre></td></tr></table></figure>

<p>34-nginx-to-logstash.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/34-nginx-to-logstash.yml</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/nginx/access.log*</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.logstash:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;10.0.0.101:8888&quot;</span>]</span><br><span class="line"></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -e -c ~/config/34-nginx-to-logstash.yml</span></span><br></pre></td></tr></table></figure>





<h2 id="7-geoip分析源地址的地址位置"><a href="#7-geoip分析源地址的地址位置" class="headerlink" title="7.geoip分析源地址的地址位置"></a>7.geoip分析源地址的地址位置</h2><p>05-geoip分析客户端的IP地理位置实战案例</p>
<p>19-beat-grok_date_geoip-es.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/19-beat-grok_date_geoip-es.conf</span><br><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 8888</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter&#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    match =&gt; &#123;</span><br><span class="line">      &quot;message&quot; =&gt; &quot;%&#123;HTTPD_COMMONLOG&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    remove_field =&gt; [ &quot;host&quot;,&quot;@version&quot;, &quot;ecs&quot;, &quot;tags&quot;, &quot;agent&quot;, &quot;input&quot;, &quot;log&quot; ]</span><br><span class="line">    add_field =&gt; &#123;</span><br><span class="line">      &quot;school&quot; =&gt; &quot;北京市昌平区沙河镇老男孩IT教育&quot;</span><br><span class="line">    &#125;    </span><br><span class="line">  &#125;</span><br><span class="line">  date &#123;</span><br><span class="line">      match =&gt; [&quot;timestamp&quot;,&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]</span><br><span class="line">      timezone =&gt; &quot;Asia/Shanghai&quot;</span><br><span class="line">      target =&gt; &quot;oldboyedu-linux80-nginx-access-time&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  geoip &#123;</span><br><span class="line">      # 指定基于哪个字段分析IP地址</span><br><span class="line">      source =&gt; &quot;clientip&quot;</span><br><span class="line">      </span><br><span class="line">      # 如果期望查看指定的字段，则可以在这里配置即可，若不设置，表示显示所有的查询字段.</span><br><span class="line">      fields =&gt; [&quot;city_name&quot;,&quot;country_name&quot;,&quot;ip&quot;]</span><br><span class="line"></span><br><span class="line">      # 指定geoip的输出字段，如果想要对多个IP地址进行分析，则该字段很有用</span><br><span class="line">      target =&gt; &quot;oldboyedu-linux80&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line">    index =&gt; &quot;oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -rf config-logstash/19-beat-grok_date_geoip-es.conf</span><br><span class="line">[root@elk102.oldboyedu.com ~]# rm -rf /var/lib/filebeat/*</span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -e -c ~/config/34-nginx-to-logstash.yml</span><br></pre></td></tr></table></figure>





<h2 id="8-useragent分析客户端的设备类型"><a href="#8-useragent分析客户端的设备类型" class="headerlink" title="8.useragent分析客户端的设备类型"></a>8.useragent分析客户端的设备类型</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/20-beat-grok_date_geoip_useragent-es.conf</span><br><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 8888</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter&#123;</span><br><span class="line">  date &#123;</span><br><span class="line">      match =&gt; [&quot;timestamp&quot;,&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]</span><br><span class="line">      timezone =&gt; &quot;Asia/Shanghai&quot;</span><br><span class="line">      target =&gt; &quot;oldboyedu-linux80-nginx-access-time&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  mutate &#123;</span><br><span class="line">      remove_field =&gt; [ &quot;agent&quot;, &quot;host&quot;, &quot;@version&quot;, &quot;ecs&quot;, &quot;tags&quot;, &quot;agent&quot;, &quot;input&quot;, &quot;log&quot; ]</span><br><span class="line">      add_field =&gt; &#123;</span><br><span class="line">          &quot;school&quot; =&gt; &quot;北京市昌平区沙河镇老男孩IT教育&quot;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  geoip &#123;</span><br><span class="line">      source =&gt; &quot;clientip&quot;</span><br><span class="line">      fields =&gt; [&quot;city_name&quot;,&quot;country_name&quot;,&quot;ip&quot;]</span><br><span class="line">      target =&gt; &quot;oldboyedu-linux80-geoip&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  useragent &#123;</span><br><span class="line">      # 指定客户端的设备相关信息的字段</span><br><span class="line">      source =&gt; &quot;http_user_agent&quot;</span><br><span class="line">      </span><br><span class="line">      # 将分析的数据存储在一个指定的字段中，若不指定，则默认存储在target字段中。</span><br><span class="line">      target =&gt; &quot;oldboyedu-linux80-useragent&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line">    index =&gt; &quot;oldboyedu-linux80-logstash-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -rf config-logstash/19-beat-grok_date_geoip-es.conf</span><br></pre></td></tr></table></figure>

<p>修改nginx的源日志格式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/nginx/nginx.conf</span><br><span class="line">...</span><br><span class="line">  log_format oldboyedu_nginx_json &#x27;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;host&quot;:&quot;$server_addr&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;clientip&quot;:&quot;$remote_addr&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;SendBytes&quot;:$body_bytes_sent,&#x27;</span><br><span class="line">                              &#x27;&quot;responsetime&quot;:$request_time,&#x27;</span><br><span class="line">                              &#x27;&quot;upstreamtime&quot;:&quot;$upstream_response_time&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;upstreamhost&quot;:&quot;$upstream_addr&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;http_host&quot;:&quot;$host&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;uri&quot;:&quot;$uri&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;domain&quot;:&quot;$host&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;xff&quot;:&quot;$http_x_forwarded_for&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;referer&quot;:&quot;$http_referer&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;tcp_xff&quot;:&quot;$proxy_protocol_addr&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;http_user_agent&quot;:&quot;$http_user_agent&quot;,&#x27;</span><br><span class="line">                              &#x27;&quot;status&quot;:&quot;$status&quot;&#125;&#x27;;</span><br><span class="line">                              </span><br><span class="line">  access_log /var/log/nginx/access.log oldboyedu_nginx_json;</span><br></pre></td></tr></table></figure>

<p>检查nginx的配置文件语法并重启nginx服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br><span class="line">systemctl restart nginx</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl 127.0.0.1</span><br><span class="line">cat /var/log/nginx/access.log</span><br></pre></td></tr></table></figure>

<p>35-nginx-to-logstash.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/35-nginx-to-logstash.yml</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/nginx/access.log*</span></span><br><span class="line">  <span class="attr">json.keys_under_root:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.logstash:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;10.0.0.101:8888&quot;</span>]</span><br><span class="line"></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -e -c ~/config/35-nginx-to-logstash.yml</span></span><br></pre></td></tr></table></figure>





<h2 id="9-mutate组件常用字段案例"><a href="#9-mutate组件常用字段案例" class="headerlink" title="9.mutate组件常用字段案例"></a>9.mutate组件常用字段案例</h2><p>21-mutate.conf</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk101.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># vim config-logstash/21-mutate.conf</span></span><br><span class="line"><span class="string">input</span> &#123;</span><br><span class="line">  <span class="string">beats</span> &#123;</span><br><span class="line">    <span class="string">port</span> <span class="string">=&gt;</span> <span class="number">8888</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">filter&#123;</span></span><br><span class="line"></span><br><span class="line">  <span class="string">mutate</span> &#123;</span><br><span class="line">      <span class="string">remove_field</span> <span class="string">=&gt;</span> [ <span class="string">&quot;@timestamp&quot;</span>, <span class="string">&quot;agent&quot;</span>, <span class="string">&quot;host&quot;</span>, <span class="string">&quot;@version&quot;</span>, <span class="string">&quot;ecs&quot;</span>, <span class="string">&quot;tags&quot;</span>, <span class="string">&quot;agent&quot;</span>, <span class="string">&quot;input&quot;</span>, <span class="string">&quot;log&quot;</span> ]</span><br><span class="line">      <span class="string">add_field</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">          <span class="string">&quot;school&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;北京市昌平区沙河镇老男孩IT教育&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">mutate</span> &#123;</span><br><span class="line">      <span class="comment"># 对&quot;message&quot;字段使用&quot;|&quot;进行切分。</span></span><br><span class="line">      <span class="string">split</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">          <span class="string">&quot;message&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;|&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">mutate</span> &#123;</span><br><span class="line">      <span class="comment"># 添加字段，其中引用到了变量</span></span><br><span class="line">      <span class="string">add_field</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">          <span class="string">&quot;user_id&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;<span class="template-variable">%&#123;[message][1]&#125;</span>&quot;</span></span><br><span class="line">          <span class="string">&quot;action&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;<span class="template-variable">%&#123;[message][2]&#125;</span>&quot;</span></span><br><span class="line">          <span class="string">&quot;svip&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;<span class="template-variable">%&#123;[message][3]&#125;</span>&quot;</span></span><br><span class="line">          <span class="string">&quot;price&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;<span class="template-variable">%&#123;[message][4]&#125;</span>&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">mutate</span> &#123;</span><br><span class="line">         <span class="string">strip</span> <span class="string">=&gt;</span> [<span class="string">&quot;svip&quot;</span>]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">mutate</span> &#123;</span><br><span class="line">      <span class="comment"># 将指定字段转换成相应对数据类型.</span></span><br><span class="line">      <span class="string">convert</span> <span class="string">=&gt;</span> &#123;</span><br><span class="line">          <span class="string">&quot;user_id&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">          <span class="string">&quot;svip&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;boolean&quot;</span></span><br><span class="line">          <span class="string">&quot;price&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;float&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">mutate</span> &#123;</span><br><span class="line">      <span class="comment"># 将&quot;price&quot;字段拷贝到&quot;oldboyedu-linux80-price&quot;字段中.</span></span><br><span class="line">      <span class="string">copy</span> <span class="string">=&gt;</span> &#123; <span class="string">&quot;price&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;oldboyedu-linux80-price&quot;</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">mutate</span> &#123;</span><br><span class="line">      <span class="comment"># 修改字段的名称</span></span><br><span class="line">      <span class="string">rename</span> <span class="string">=&gt;</span> &#123; <span class="string">&quot;svip&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;oldboyedu-ssvip&quot;</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="string">mutate</span> &#123;</span><br><span class="line">      <span class="comment"># 替换字段的内容</span></span><br><span class="line">      <span class="string">replace</span> <span class="string">=&gt;</span> &#123; <span class="string">&quot;message&quot;</span> <span class="string">=&gt;</span> <span class="string">&quot;<span class="template-variable">%&#123;message&#125;</span>: My new message&quot;</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">mutate</span> &#123;</span><br><span class="line">    <span class="comment"># 将指定字段的字母全部大写</span></span><br><span class="line">    <span class="string">uppercase</span> <span class="string">=&gt;</span> [ <span class="string">&quot;message&quot;</span> ]</span><br><span class="line">  &#125;</span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">output</span> &#123;</span><br><span class="line">  <span class="string">stdout</span> &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="string">elasticsearch</span> &#123;</span><br><span class="line">    <span class="string">hosts</span> <span class="string">=&gt;</span> [<span class="string">&quot;10.0.0.101:9200&quot;</span>,<span class="string">&quot;10.0.0.102:9200&quot;</span>,<span class="string">&quot;10.0.0.103:9200&quot;</span>]</span><br><span class="line">    <span class="string">index</span> <span class="string">=&gt;</span> <span class="string">&quot;oldboyedu-linux80-logstash-<span class="template-variable">%&#123;+YYYY.MM.dd&#125;</span>&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[<span class="string">root@elk101.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># logstash -rf config-logstash/21-mutate.conf</span></span><br></pre></td></tr></table></figure>



<h2 id="9-mutate组件数据准备-python脚本"><a href="#9-mutate组件数据准备-python脚本" class="headerlink" title="9.mutate组件数据准备-python脚本"></a>9.mutate组件数据准备-python脚本</h2><p>generate_log.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]<span class="comment"># cat &gt; generate_log.py &lt;&lt;EOF</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="comment"># @author : oldboyedu-linux80</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">LOG_FORMAT = <span class="string">&quot;%(levelname)s %(asctime)s [com.oldboyedu.%(module)s] - %(message)s &quot;</span></span><br><span class="line">DATE_FORMAT = <span class="string">&quot;%Y–%m-%d %H:%M:%S&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置root的logging.Logger实例的基本配置</span></span><br><span class="line">logging.basicConfig(level=logging.INFO, <span class="built_in">format</span>=LOG_FORMAT, datefmt=DATE_FORMAT, filename=sys.argv[<span class="number">1</span>], filemode=<span class="string">&#x27;a&#x27;</span>,)</span><br><span class="line">actions = [<span class="string">&quot;浏览页面&quot;</span>, <span class="string">&quot;评论商品&quot;</span>, <span class="string">&quot;加入收藏&quot;</span>, <span class="string">&quot;加入购物车&quot;</span>, <span class="string">&quot;提交订单&quot;</span>, <span class="string">&quot;使用优惠券&quot;</span>, <span class="string">&quot;领取优惠券&quot;</span>, <span class="string">&quot;搜索&quot;</span>, <span class="string">&quot;查看订单&quot;</span>, <span class="string">&quot;付款&quot;</span>, <span class="string">&quot;清空购物车&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    time.sleep(random.randint(<span class="number">1</span>, <span class="number">5</span>))</span><br><span class="line">    user_id = random.randint(<span class="number">1</span>, <span class="number">10000</span>)</span><br><span class="line">    <span class="comment"># 对生成的浮点数保留2位有效数字.</span></span><br><span class="line">    price = <span class="built_in">round</span>(random.uniform(<span class="number">15000</span>, <span class="number">30000</span>),<span class="number">2</span>)</span><br><span class="line">    action = random.choice(actions)</span><br><span class="line">    svip = random.choice([<span class="number">0</span>,<span class="number">1</span>])</span><br><span class="line">    logging.info(<span class="string">&quot;DAU|&#123;0&#125;|&#123;1&#125;|&#123;2&#125;|&#123;3&#125;&quot;</span>.<span class="built_in">format</span>(user_id, action,svip,price))</span><br><span class="line">EOF</span><br><span class="line">[root@elk102.oldboyedu.com ~]<span class="comment"># python generate_log.py /tmp/app.log</span></span><br><span class="line"><span class="comment"># 放到后台启动</span></span><br><span class="line">[root@elk102.oldboyedu.com ~]<span class="comment"># nohup python generate_log.py /tmp/app.log &amp;&gt;/dev/null </span></span><br><span class="line"><span class="comment"># 查看生成的日志</span></span><br><span class="line">[root@elk102.oldboyedu.com ~]<span class="comment"># tail -100f /tmp/app.log</span></span><br></pre></td></tr></table></figure>

<p>36-apps-to-logstash.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/36-apps-to-logstash.yml</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/tmp/app.log*</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.logstash:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;10.0.0.101:8888&quot;</span>]</span><br><span class="line"></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -e -c ~/config/35-nginx-to-logstash.yml</span></span><br></pre></td></tr></table></figure>



<h2 id="10-logstash的多if分支案例"><a href="#10-logstash的多if分支案例" class="headerlink" title="10.logstash的多if分支案例"></a>10.logstash的多if分支案例</h2><p>11-ELFK架构多if分支判断多综合案例</p>
<p>22-beats_tcp-filter-es.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/22-beats_tcp-filter-es.conf</span><br><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    type =&gt; &quot;oldboyedu-beats&quot;</span><br><span class="line">    port =&gt; 8888</span><br><span class="line">  &#125;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    type =&gt; &quot;oldboyedu-tcp&quot;</span><br><span class="line">    port =&gt; 9999</span><br><span class="line">  &#125;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    type =&gt; &quot;oldboyedu-tcp-new&quot;</span><br><span class="line">    port =&gt; 7777</span><br><span class="line">  &#125;</span><br><span class="line">  http &#123;</span><br><span class="line">    type =&gt; &quot;oldboyedu-http&quot;</span><br><span class="line">    port =&gt; 6666</span><br><span class="line">  &#125;</span><br><span class="line">  file &#123;</span><br><span class="line">    type =&gt; &quot;oldboyedu-file&quot;</span><br><span class="line">    path =&gt; &quot;/tmp/apps.log&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter&#123;</span><br><span class="line">  mutate &#123;</span><br><span class="line">      add_field =&gt; &#123;</span><br><span class="line">          &quot;school&quot; =&gt; &quot;北京市昌平区沙河镇老男孩IT教育&quot;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  if [type] == [&quot;oldboyedu-beats&quot;,&quot;oldboyedu-tcp-new&quot;,&quot;oldboyedu-http&quot;] &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">      remove_field =&gt; [ &quot;agent&quot;, &quot;host&quot;, &quot;@version&quot;, &quot;ecs&quot;, &quot;tags&quot;, &quot;agent&quot;, &quot;input&quot;, &quot;log&quot; ]</span><br><span class="line">    &#125;</span><br><span class="line">    geoip &#123;</span><br><span class="line">      source =&gt; &quot;clientip&quot;</span><br><span class="line">      target =&gt; &quot;oldboyedu-linux80-geoip&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    useragent &#123;</span><br><span class="line">      source =&gt; &quot;http_user_agent&quot;</span><br><span class="line">      target =&gt; &quot;oldboyedu-linux80-useragent&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else if [type] == &quot;oldboyedu-file&quot; &#123;</span><br><span class="line">      mutate &#123;</span><br><span class="line">        add_field =&gt; &#123;</span><br><span class="line">          &quot;class&quot; =&gt; &quot;oldboyedu-linux80&quot;</span><br><span class="line">          &quot;address&quot; =&gt; &quot;北京昌平区沙河镇老男孩IT教育&quot;</span><br><span class="line">          &quot;hobby&quot; =&gt; &quot;LOL&quot;,&quot;王者荣耀&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        remove_field =&gt; [&quot;host&quot;,&quot;@version&quot;,&quot;school&quot;]</span><br><span class="line">      &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">      mutate &#123;</span><br><span class="line">        remove_field =&gt; [&quot;port&quot;, &quot;@version&quot;, &quot;host&quot;]</span><br><span class="line">      &#125;</span><br><span class="line">      mutate &#123;</span><br><span class="line">        split =&gt; &#123;</span><br><span class="line">          &quot;message&quot; =&gt; &quot;|&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      add_field =&gt; &#123;</span><br><span class="line">          &quot;user_id&quot; =&gt; &quot;%&#123;[message][1]&#125;&quot;</span><br><span class="line">          &quot;action&quot; =&gt; &quot;%&#123;[message][2]&#125;&quot;</span><br><span class="line">          &quot;svip&quot; =&gt; &quot;%&#123;[message][3]&#125;&quot;</span><br><span class="line">          &quot;price&quot; =&gt; &quot;%&#123;[message][4]&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">      # 利用完message字段后，在删除是可以的，注意代码的执行顺序</span><br><span class="line">      remove_field =&gt; [&quot;message&quot;]</span><br><span class="line">      strip =&gt; [&quot;svip&quot;]</span><br><span class="line"></span><br><span class="line">      mutate &#123;</span><br><span class="line">        convert =&gt; &#123;</span><br><span class="line">          &quot;user_id&quot; =&gt; &quot;integer&quot;</span><br><span class="line">          &quot;svip&quot; =&gt; &quot;boolean&quot;</span><br><span class="line">          &quot;price&quot; =&gt; &quot;float&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  if [type] == &quot;oldboyedu-beats&quot; &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line">      index =&gt; &quot;oldboyedu-linux80-logstash-beats-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">        hosts =&gt; [&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line">        index =&gt; &quot;oldboyedu-linux80-logstash-tcp-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -rf config-logstash/22-beats_tcp-filter-es.conf</span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -e -c ~/config/35-nginx-to-logstash.yml</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /tmp/app.log | nc 10.0.0.101 9999</span><br><span class="line">echo 1111 &gt; /tmp/apps.log</span><br></pre></td></tr></table></figure>



<h2 id="11-今日作业"><a href="#11-今日作业" class="headerlink" title="11.今日作业"></a>11.今日作业</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">如上图所示，要求完成以下内容：</span><br><span class="line">(1)收集nginx日志，写入ES集群，分片数量为3,副本数量为0,索引名称为&quot;oldboyedu-linux80-nginx&quot;;</span><br><span class="line">(2)收集tomcat日志，写入Es集群,分片数量为5,副本数量为0,索引名称为&quot;oldboyedu-linux80-tomcat&quot;;</span><br><span class="line">(3)收集app日志，写入Es集群，分片数量为10,副本数量为0,索引名称为&quot;oldboyedu-linux80-app&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">进阶作业：</span><br><span class="line">  分析出nginx，tomcat的客户端ip所属城市，访问时使用的设备类型等。</span><br></pre></td></tr></table></figure>



<h2 id="Filebeat收集nginx日志"><a href="#Filebeat收集nginx日志" class="headerlink" title="Filebeat收集nginx日志"></a>Filebeat收集nginx日志</h2><p>37-nginx-to-logstash.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/37-nginx-to-logstash.yml</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/nginx/access.log*</span></span><br><span class="line">  <span class="attr">json.keys_under_root:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># tags: nginx</span></span><br><span class="line">  <span class="comment"># fields:</span></span><br><span class="line">   <span class="comment">#  oldboyedu-type: nginx</span></span><br><span class="line">  <span class="comment"># fields_under_root: true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.logstash:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;10.0.0.101:8888&quot;</span>]</span><br><span class="line"></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -e -c ~/config/37-nginx-to-logstash.yml</span></span><br></pre></td></tr></table></figure>



<p>23-beats-to-es.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/23-beats-to-es.conf</span><br><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    type =&gt; &quot;nginx&quot;</span><br><span class="line">    port =&gt; 8888</span><br><span class="line">  &#125;</span><br><span class="line">  beats &#123;</span><br><span class="line">    type =&gt; &quot;tomcat&quot;</span><br><span class="line">    port =&gt; 7777</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter&#123;</span><br><span class="line">  mutate &#123;</span><br><span class="line">      remove_field =&gt; [ &quot;tags&quot;, &quot;log&quot;, &quot;agent&quot;, &quot;@version&quot;, &quot;input&quot;,&quot;ecs&quot; ]</span><br><span class="line">      # remove_tag =&gt; [ &quot;beats_input_raw_event&quot; ]</span><br><span class="line">  &#125;</span><br><span class="line">  if [&quot;type&quot;] == [&quot;nginx&quot;] &#123;</span><br><span class="line">    geoip &#123;</span><br><span class="line">      source =&gt; &quot;clientip&quot;</span><br><span class="line">      target =&gt; &quot;oldboyedu-linux80-geoip&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    useragent &#123;</span><br><span class="line">      source =&gt; &quot;http_user_agent&quot;</span><br><span class="line">      target =&gt; &quot;oldboyedu-linux80-useragent&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [&quot;type&quot;] == [&quot;tomcat&quot;] &#123;</span><br><span class="line">    geoip &#123;</span><br><span class="line">      source =&gt; &quot;clientip&quot;</span><br><span class="line">      target =&gt; &quot;oldboyedu-linux80-geoip&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    useragent &#123;</span><br><span class="line">      source =&gt; &quot;AgentVersion&quot;</span><br><span class="line">      target =&gt; &quot;oldboyedu-linux80-useragent&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  if [&quot;type&quot;] == [&quot;nginx&quot;] &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line">      index =&gt; &quot;oldboyedu-linux80-nginx&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [&quot;type&quot;] == [&quot;tomcat&quot;] &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line">      index =&gt; &quot;oldboyedu-linux80-tomcat&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -rf config-logstash/23-beats-to-es.conf</span><br><span class="line">[root@elk102.oldboyedu.com ~]# rm -rf /var/lib/filebeat/*</span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -e -c ~/config/37-nginx-to-logstash.yml</span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -e -c ~/config/38-tomcat-to-logstash.yml --path.data /tmp/filebeat/</span><br></pre></td></tr></table></figure>



<h2 id="Filebeat收集tomcat日志"><a href="#Filebeat收集tomcat日志" class="headerlink" title="Filebeat收集tomcat日志"></a>Filebeat收集tomcat日志</h2><p>38-tomcat-to-logstash.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># cat ~/config/38-tomcat-to-logstash.yml</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/oldboyedu/softwares/apache-tomcat-10.0.20/logs/*txt</span></span><br><span class="line">  <span class="attr">json.keys_under_root:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.logstash:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;10.0.0.101:7777&quot;</span>]</span><br><span class="line"></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># rm -rf /var/lib/filebeat/*</span></span><br><span class="line">[<span class="string">root@elk102.oldboyedu.com</span> <span class="string">~</span>]<span class="comment"># filebeat -e -c ~/config/38-tomcat-to-logstash.yml</span></span><br></pre></td></tr></table></figure>



<h2 id="Filebeat收集apps日志"><a href="#Filebeat收集apps日志" class="headerlink" title="Filebeat收集apps日志"></a>Filebeat收集apps日志</h2><p>39-apps-to-logstash.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@elk102.oldboyedu.com ~]# cat ~/config/39-apps-to-logstash.yml</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/app.log*</span><br><span class="line"></span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [&quot;10.0.0.101:6666&quot;]</span><br><span class="line"></span><br><span class="line">[root@elk102.oldboyedu.com ~]# rm -rf /var/lib/filebeat/*</span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -e -c ~/config/39-apps-to-logstash.yml</span><br></pre></td></tr></table></figure>



<p>23-bug-beats-to-es.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# vim config-logstash/23-beats-to-es.conf</span><br><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    type =&gt; &quot;nginx&quot;</span><br><span class="line">    port =&gt; 8888</span><br><span class="line">  &#125;</span><br><span class="line">  beats &#123;</span><br><span class="line">    type =&gt; &quot;tomcat&quot;</span><br><span class="line">    port =&gt; 7777</span><br><span class="line">  &#125;</span><br><span class="line">  beats &#123;</span><br><span class="line">    type =&gt; &quot;apps&quot;</span><br><span class="line">    port =&gt; 6666</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter&#123;</span><br><span class="line">  mutate &#123;</span><br><span class="line">      remove_field =&gt; [ &quot;tags&quot;, &quot;log&quot;, &quot;agent&quot;, &quot;@version&quot;, &quot;input&quot;,&quot;ecs&quot; ]</span><br><span class="line">      # remove_tag =&gt; [ &quot;beats_input_raw_event&quot; ]</span><br><span class="line">  &#125;</span><br><span class="line">  if [&quot;type&quot;] == [&quot;nginx&quot;] &#123;</span><br><span class="line">    geoip &#123;</span><br><span class="line">      source =&gt; &quot;clientip&quot;</span><br><span class="line">      target =&gt; &quot;oldboyedu-linux80-geoip&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    useragent &#123;</span><br><span class="line">      source =&gt; &quot;http_user_agent&quot;</span><br><span class="line">      target =&gt; &quot;oldboyedu-linux80-useragent&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [&quot;type&quot;] == [&quot;tomcat&quot;] &#123;</span><br><span class="line">    geoip &#123;</span><br><span class="line">      source =&gt; &quot;clientip&quot;</span><br><span class="line">      target =&gt; &quot;oldboyedu-linux80-geoip&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    useragent &#123;</span><br><span class="line">      source =&gt; &quot;AgentVersion&quot;</span><br><span class="line">      target =&gt; &quot;oldboyedu-linux80-useragent&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [&quot;type&quot;] == [&quot;apps&quot;] &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">      remove_field =&gt; [&quot;port&quot;,&quot;@version&quot;,&quot;host&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">    mutate &#123;</span><br><span class="line">      split =&gt; &#123;</span><br><span class="line">        &quot;message&quot; =&gt; &quot;|&quot;</span><br><span class="line">      &#125;</span><br><span class="line">      add_field =&gt; &#123;</span><br><span class="line">        &quot;user_id&quot; =&gt; &quot;%&#123;[message][1]&#125;&quot;</span><br><span class="line">        &quot;action&quot; =&gt; &quot;%&#123;[message][2]&#125;&quot;</span><br><span class="line">        &quot;svip&quot; =&gt; &quot;%&#123;[message][3]&#125;&quot;</span><br><span class="line">        &quot;price&quot; =&gt; &quot;%&#123;[message][4]&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">      # 利用完message字段后，在删除是可以的！注意代码的执行顺序！</span><br><span class="line">      remove_field =&gt; [&quot;message&quot;]</span><br><span class="line">      strip =&gt; [&quot;svip&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">    mutate &#123;</span><br><span class="line">      convert =&gt; &#123;</span><br><span class="line">        &quot;user_id&quot; =&gt; &quot;integer&quot;</span><br><span class="line">        &quot;svip&quot; =&gt; &quot;boolean&quot;</span><br><span class="line">        &quot;price&quot; =&gt; &quot;float&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  if [&quot;type&quot;] == [&quot;nginx&quot;] &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line">      index =&gt; &quot;oldboyedu-linux80-nginx&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [&quot;type&quot;] == [&quot;tomcat&quot;] &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line">      index =&gt; &quot;oldboyedu-linux80-tomcat&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [&quot;type&quot;] == [&quot;apps&quot;] &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line">      index =&gt; &quot;oldboyedu-linux80-apps&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -rf config-logstash/23-beats-to-es.conf</span><br><span class="line">[root@elk102.oldboyedu.com ~]# rm -rf /var/lib/filebeat/*</span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -e -c ~/config/37-nginx-to-logstash.yml</span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -e -c ~/config/38-tomcat-to-logstash.yml --path.data /tmp/filebeat</span><br><span class="line">[root@elk102.oldboyedu.com ~]# filebeat -e -c ~/config/39-apps-to-logstash.yml --path.data /tmp/filebeat-apps</span><br></pre></td></tr></table></figure>



<h2 id="logstash收集nginx日志"><a href="#logstash收集nginx日志" class="headerlink" title="logstash收集nginx日志"></a>logstash收集nginx日志</h2><p>24-homework-01-to-es.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 8888</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">filter&#123;</span><br><span class="line">  mutate &#123;</span><br><span class="line">      remove_field =&gt; [ &quot;tags&quot;, &quot;log&quot;, &quot;agent&quot;, &quot;@version&quot;, &quot;input&quot;,&quot;ecs&quot; ]</span><br><span class="line">  &#125;</span><br><span class="line">  geoip &#123;</span><br><span class="line">    source =&gt; &quot;clientip&quot;</span><br><span class="line">    target =&gt; &quot;oldboyedu-linux80-geoip&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  useragent &#123;</span><br><span class="line">    source =&gt; &quot;http_user_agent&quot;</span><br><span class="line">    target =&gt; &quot;oldboyedu-linux80-useragent&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line">    index =&gt; &quot;oldboyedu-linux80-nginx&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="logstash收集tomcat日志"><a href="#logstash收集tomcat日志" class="headerlink" title="logstash收集tomcat日志"></a>logstash收集tomcat日志</h2><p>24-homework-02-to-es.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 7777</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">filter&#123;</span><br><span class="line">  mutate &#123;</span><br><span class="line">      remove_field =&gt; [ &quot;tags&quot;, &quot;log&quot;, &quot;agent&quot;, &quot;@version&quot;, &quot;input&quot;,&quot;ecs&quot; ]</span><br><span class="line">  &#125;</span><br><span class="line">  geoip &#123;</span><br><span class="line">    source =&gt; &quot;clientip&quot;</span><br><span class="line">    target =&gt; &quot;oldboyedu-linux80-geoip&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  useragent &#123;</span><br><span class="line">    source =&gt; &quot;http_user_agent&quot;</span><br><span class="line">    target =&gt; &quot;oldboyedu-linux80-useragent&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line">    index =&gt; &quot;oldboyedu-linux80-tomcat&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="logstash收集apps日志"><a href="#logstash收集apps日志" class="headerlink" title="logstash收集apps日志"></a>logstash收集apps日志</h2><p>24-homework-03-to-es.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 6666</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">filter&#123;</span><br><span class="line">  mutate &#123;</span><br><span class="line">      remove_field =&gt; [ &quot;tags&quot;, &quot;log&quot;, &quot;agent&quot;, &quot;@version&quot;, &quot;input&quot;,&quot;ecs&quot; ]</span><br><span class="line">  &#125;</span><br><span class="line">  mutate &#123;</span><br><span class="line">      remove_field =&gt; [&quot;port&quot;,&quot;@version&quot;,&quot;host&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">  mutate &#123;</span><br><span class="line">    split =&gt; &#123;</span><br><span class="line">    &quot;message&quot; =&gt; &quot;|&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    add_field =&gt; &#123;</span><br><span class="line">      &quot;user_id&quot; =&gt; &quot;%&#123;[message][1]&#125;&quot;</span><br><span class="line">      &quot;action&quot; =&gt; &quot;%&#123;[message][2]&#125;&quot;</span><br><span class="line">      &quot;svip&quot; =&gt; &quot;%&#123;[message][3]&#125;&quot;</span><br><span class="line">      &quot;price&quot; =&gt; &quot;%&#123;[message][4]&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    # 利用完message字段后，在删除是可以的！注意代码的执行顺序！</span><br><span class="line">    remove_field =&gt; [&quot;message&quot;]</span><br><span class="line">    strip =&gt; [&quot;svip&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">  mutate &#123;</span><br><span class="line">    convert =&gt; &#123;</span><br><span class="line">      &quot;user_id&quot; =&gt; &quot;integer&quot;</span><br><span class="line">      &quot;svip&quot; =&gt; &quot;boolean&quot;</span><br><span class="line">      &quot;price&quot; =&gt; &quot;float&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line">    index =&gt; &quot;oldboyedu-linux80-apps&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# logstash -rf config-logstash/24-homework-03-to-es.conf</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -rf config-logstash/24-homework-02-to-es.conf --path.data /tmp/homework-logstash-02</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -rf config-logstash/24-homework-01-to-es.conf --path.data /tmp/homework-logstash-01</span><br></pre></td></tr></table></figure>







<h1 id="十一-kibana的dashboard定制"><a href="#十一-kibana的dashboard定制" class="headerlink" title="十一.kibana的dashboard定制"></a>十一.kibana的dashboard定制</h1><h2 id="1-统计PV"><a href="#1-统计PV" class="headerlink" title="1.统计PV"></a>1.统计PV</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Page View(简称:&quot;pv&quot;)</span><br><span class="line">    页面访问或点击量。</span><br><span class="line"></span><br><span class="line">kibana界面鼠标依次点击如下：</span><br><span class="line">  (1)菜单栏;</span><br><span class="line">  (2)Visualize Library(可视化库);</span><br><span class="line">  (3)新建可视化</span><br><span class="line">  (4)基于聚合</span><br><span class="line">  (5)指标</span><br><span class="line">  (6)选择索引模式(例如：&quot;oldboyedu-linux80-nginx*&quot;)</span><br><span class="line">  (7)指标栏中选择：</span><br><span class="line">      聚合：计数</span><br><span class="line">      定制标签：PV</span><br></pre></td></tr></table></figure>



<h2 id="2-统计客户端IP"><a href="#2-统计客户端IP" class="headerlink" title="2.统计客户端IP"></a>2.统计客户端IP</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">客户端IP：</span><br><span class="line">    通常指的是访问Web服务器的客户端IP地址，但要注意，客户端IP数量并不难代表UV。</span><br><span class="line"></span><br><span class="line">kibana界面鼠标依次点击如下：</span><br><span class="line">  (1)菜单栏;</span><br><span class="line">  (2)Visualize Library(可视化库);</span><br><span class="line">  (3)创建可视化</span><br><span class="line">  (4)基于聚合</span><br><span class="line">  (5)指标</span><br><span class="line">  (6)选择索引模式(例如：&quot;oldboyedu-linux80-nginx*&quot;)</span><br><span class="line">  (7)指标栏中选择：</span><br><span class="line">      聚合：唯一计数</span><br><span class="line">      字段：clientip.keyword</span><br><span class="line">      定制标签：IP</span><br></pre></td></tr></table></figure>



<h2 id="3-统计web下载带宽"><a href="#3-统计web下载带宽" class="headerlink" title="3.统计web下载带宽"></a>3.统计web下载带宽</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">带宽：</span><br><span class="line">    统计nginx返回给客户端文件大小的字段进行累计求和。</span><br><span class="line"></span><br><span class="line">kibana界面鼠标依次点击如下：</span><br><span class="line">  (1)菜单栏;</span><br><span class="line">  (2)Visualize Library(可视化库);</span><br><span class="line">  (3)创建可视化</span><br><span class="line">  (4)基于聚合</span><br><span class="line">  (5)指标</span><br><span class="line">  (6)选择索引模式(例如：&quot;oldboyedu-linux80-nginx*&quot;)</span><br><span class="line">  (7)指标栏中选择：</span><br><span class="line">      聚合：求和</span><br><span class="line">      字段：SendBytes</span><br><span class="line">      定制标签：带宽</span><br></pre></td></tr></table></figure>



<h2 id="4-访问页面统计"><a href="#4-访问页面统计" class="headerlink" title="4.访问页面统计"></a>4.访问页面统计</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">访问资源统计：</span><br><span class="line">    对URI的访问次数统计。</span><br><span class="line"></span><br><span class="line">kibana界面鼠标依次点击如下：</span><br><span class="line">  (1)菜单栏;</span><br><span class="line">  (2)Visualize Library(可视化库);</span><br><span class="line">  (3)创建可视化</span><br><span class="line">  (4)基于聚合</span><br><span class="line">  (5)水平条形图</span><br><span class="line">  (6)选择索引模式(例如：&quot;oldboyedu-linux80-nginx*&quot;)</span><br><span class="line">  (7)指标栏中设置(即Y轴)</span><br><span class="line">      聚合：计数</span><br><span class="line">      定制标签：访问量</span><br><span class="line">  (8)添加&quot;存储桶&quot;，选择&quot;X&quot;轴</span><br><span class="line">      聚合：词</span><br><span class="line">      字段：uri.keyword</span><br><span class="line">      ...</span><br><span class="line">      定制标签：URI   </span><br></pre></td></tr></table></figure>



<h2 id="7-IP的TopN统计-仪表盘"><a href="#7-IP的TopN统计-仪表盘" class="headerlink" title="7.IP的TopN统计(仪表盘)"></a>7.IP的TopN统计(仪表盘)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">IP的ToPN统计：</span><br><span class="line">    统计访问量的客户端IP最大的是谁。</span><br><span class="line">    </span><br><span class="line">kibana界面鼠标依次点击如下：</span><br><span class="line">    (1)菜单栏；</span><br><span class="line">    (2)Visualize Library(可视化库）;</span><br><span class="line">    (3)创建可视化</span><br><span class="line">    (4)基于聚合</span><br><span class="line">    (5)仪表盘</span><br><span class="line">    (6)选择索引模式(例如&quot;oldboyedu-linux80-nginx*&quot;)</span><br><span class="line">    (7)指标栏中设置(即Y轴)</span><br><span class="line">        聚合：计数</span><br><span class="line">    (8)添加&quot;存储桶&quot;，选择&quot;X&quot;轴</span><br><span class="line">        聚合：词</span><br><span class="line">        字段：client.keyword</span><br><span class="line">        顺序：降序</span><br><span class="line">        大小：3</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>



<h2 id="8-自定义dashboard"><a href="#8-自定义dashboard" class="headerlink" title="8.自定义dashboard"></a>8.自定义dashboard</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kibana界面鼠标依次点击如下：</span><br><span class="line">    (1)菜单栏;</span><br><span class="line">    (2)Dashboard</span><br><span class="line">    (3)创建仪表盘</span><br><span class="line">    (4)从可视化库中添加即可。</span><br><span class="line"></span><br><span class="line">如上图和下图所示，为我添加到dashboard界面。</span><br></pre></td></tr></table></figure>





<h1 id="十二-ElasticStack二进制部署及排错"><a href="#十二-ElasticStack二进制部署及排错" class="headerlink" title="十二.ElasticStack二进制部署及排错"></a>十二.ElasticStack二进制部署及排错</h1><h2 id="1-部署Oracle-JDK环境"><a href="#1-部署Oracle-JDK环境" class="headerlink" title="1.部署Oracle JDK环境"></a>1.部署Oracle JDK环境</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">官方连接：</span><br><span class="line">    https://www.oracle.com/java/technologies/downloads/#java8</span><br><span class="line">  </span><br><span class="line">elk101单节点部署oracle jdk步骤：</span><br><span class="line">    （1）创建工作目录</span><br><span class="line">mkdir -pv /oldboyedu/softwares</span><br><span class="line"></span><br><span class="line">    （2）解压JDK到指定的目录</span><br><span class="line">tar xf jdk-8u321-linux-x64.tar.gz -C /oldboyedu/softwares/</span><br><span class="line"></span><br><span class="line">    （3）创建符号链接</span><br><span class="line">cd /oldboyedu/softwares/ &amp;&amp; ln -sv jdk1.8.0_321 jdk</span><br><span class="line"></span><br><span class="line">    （4）创建环境变量</span><br><span class="line">cat &gt; /etc/profile.d/elk.sh &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">export JAVA_HOME=/oldboyedu/softwares/jdk</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line">EOF</span><br><span class="line">source /etc/profile.d/elk.sh</span><br><span class="line"></span><br><span class="line">    （5）查看JDK的版本号</span><br><span class="line">java -version</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">集群部署还需要做下面2个步骤：</span><br><span class="line">    （6）同步jdk环境到其他节点</span><br><span class="line">data_rsync.sh /oldboyedu/</span><br><span class="line">data_rsync.sh /etc/profile.d/elk.sh</span><br><span class="line"></span><br><span class="line">    （7）其他节点测试</span><br><span class="line">source /etc/profile.d/elk.sh</span><br><span class="line">java -version</span><br></pre></td></tr></table></figure>



<h2 id="2-单节点ES部署"><a href="#2-单节点ES部署" class="headerlink" title="2.单节点ES部署"></a>2.单节点ES部署</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">(1)下载ES软件</span><br><span class="line">[root@elk101.oldboyedu.com ~]# wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.17.3-linux-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line">(2)解压ES</span><br><span class="line">[root@elk101.oldboyedu.com ~]# tar xf elasticsearch-7.17.3-linux-x86_64.tar.gz -C /oldboyedu/softwares/</span><br><span class="line"></span><br><span class="line">(3)创建符号链接</span><br><span class="line">[root@elk101.oldboyedu.com ~]# cd /oldboyedu/softwares/ &amp;&amp; ln -sv elasticsearch-7.17.3 es</span><br><span class="line"></span><br><span class="line">(4)配置环境变量</span><br><span class="line">[root@elk101.oldboyedu.com ~]# cat &gt;&gt; /etc/profile.d/elk.sh &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">......</span><br><span class="line">export ES_HOME=/oldboyedu/softwares/es</span><br><span class="line">export PATH=$PATH:$ES_HOME/bin</span><br><span class="line">EOF</span><br><span class="line">[root@elk101.oldboyedu.com ~]# source /etc/profile.d/elk.sh</span><br><span class="line"></span><br><span class="line">(5)创建ES用户，用于运行ES服务</span><br><span class="line">[root@elk101.oldboyedu.com ~]# useradd oldboyedu</span><br><span class="line"></span><br><span class="line">(6)修改配置文件</span><br><span class="line">[root@elk101.oldboyedu.com ~]# vim /oldboyedu/softwares/elasticsearch-7.17.3/config/elasticsearch.yml</span><br><span class="line">...</span><br><span class="line">cluster.name: oldboyedu-linux80-elk</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">discovery.seed_hosts: [&quot;10.0.0.101&quot;]</span><br><span class="line">cluster.initial_master_nodes: [&quot;10.0.0.101&quot;]</span><br><span class="line"></span><br><span class="line">(7)修改权限</span><br><span class="line">[root@elk101.oldboyedu.com ~]# chown oldboyedu:oldboyedu -R /oldboyedu/softwares/elasticsearch-7.17.3/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(8)修改文件打开数量的限制(退出当前会话立即生效)</span><br><span class="line">[root@elk101.oldboyedu.com ~]# cp /etc/security/limits.d/20-nproc.conf /etc/security/limits.d/elk.conf</span><br><span class="line">[root@elk101.oldboyedu.com ~]# vim /etc/security/limits.d/elk.conf</span><br><span class="line">*    soft    nofile    65535</span><br><span class="line">*    hard    nofile    131070</span><br><span class="line"></span><br><span class="line">(9)修改内核参数的内存映射信息</span><br><span class="line">[root@elk101.oldboyedu.com ~]# vim /etc/sysctl.d/elk.conf</span><br><span class="line">vm.max_map_count = 262144</span><br><span class="line">[root@elk101.oldboyedu.com ~]# sysctl -f /etc/sysctl.d/elk.conf</span><br><span class="line">[root@elk101.oldboyedu.com ~]# sysctl -q vm.max_map_count</span><br><span class="line"></span><br><span class="line">(10)启动服务(&quot;-d&quot;选项代表是后台启动服务)</span><br><span class="line">[root@elk101.oldboyedu.com ~]# rm -rf /oldboyedu/softwares/es/&#123;logs,data&#125;/*</span><br><span class="line">[root@elk101.oldboyedu.com ~]# su -c &quot;elasticsearch&quot; oldboyedu</span><br><span class="line">[root@elk101.oldboyedu.com ~]# su -c &quot;elasticsearch -d&quot; oldboyedu</span><br><span class="line"></span><br><span class="line">(11)验证服务</span><br><span class="line">[root@elk101.oldboyedu.com ~]# curl 127.0.0.1:9200</span><br><span class="line">[root@elk101.oldboyedu.com ~]# curl 127.0.0.1:9200/_cat/nodes</span><br></pre></td></tr></table></figure>



<h2 id="3-修改ES的堆-heap-内存大小"><a href="#3-修改ES的堆-heap-内存大小" class="headerlink" title="3.修改ES的堆(heap)内存大小"></a>3.修改ES的堆(heap)内存大小</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">前置知识：</span><br><span class="line">    jps快速入门：</span><br><span class="line">        作用：</span><br><span class="line">            查看java相关的进程信息。</span><br><span class="line"></span><br><span class="line">        常用参数：</span><br><span class="line">            -l：显示包名称。</span><br><span class="line">            -v：显示进程的相关信息</span><br><span class="line">            -V：默认就是该选项，表示查看简要信息。</span><br><span class="line">            -g：只查看pid。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    jmap快速入门：</span><br><span class="line">        作用：</span><br><span class="line">            查看java的堆栈信息。</span><br><span class="line">        常用参数：</span><br><span class="line">            -heap：查看堆内存的大小。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(1)修改堆内存大小</span><br><span class="line">[root@elk101.oldboyedu.com ~]# vim /oldboyedu/softwares/es/config/jvm.options</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">堆内存设置不建议超过32G.</span></span><br><span class="line">-Xms256m</span><br><span class="line">-Xmx256m</span><br><span class="line"></span><br><span class="line">(2)重启服务</span><br><span class="line">kill `jps | grep Elasticsearch | awk &#x27;&#123;print $1&#125;&#x27;`</span><br><span class="line">su -c &quot;elasticsearch -d&quot; oldboyedu</span><br><span class="line"></span><br><span class="line">(3)验证堆内存的大小</span><br><span class="line">jmap -heap `jps | grep Elasticsearch | awk &#x27;&#123;print $1&#125;&#x27;`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">推荐阅读：</span><br><span class="line">    https://www.elastic.co/guide/en/elasticsearch/reference/7.17/advanced-configuration.html#set-jvm-heap-size</span><br></pre></td></tr></table></figure>



<h2 id="4-ES启动脚本编写"><a href="#4-ES启动脚本编写" class="headerlink" title="4.ES启动脚本编写"></a>4.ES启动脚本编写</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101.oldboyedu.com ~]# cat &gt; /usr/lib/systemd/system/es.service &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">[Unit]</span><br><span class="line">Description=Oldboyedu linux80 ELK</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line"></span><br><span class="line">ExecStart=/oldboyedu/softwares/es/bin/elasticsearch -d</span><br><span class="line">Restart=ono</span><br><span class="line">User=oldboy</span><br><span class="line">Group=oldboy</span><br><span class="line">LimitNOFILE=131070</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">[root@elk101.oldboyedu.com ~]# systemctl daemon-reload</span><br><span class="line">[root@elk101.oldboyedu.com ~]# systemctl start es</span><br></pre></td></tr></table></figure>



<h2 id="5-部署ES集群"><a href="#5-部署ES集群" class="headerlink" title="5.部署ES集群"></a>5.部署ES集群</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">(1)停止ES服务并删除集群之前的数据(如果是ES集群扩容就别删除数据了，我这里是部署一个&quot;干净&quot;的集群)</span><br><span class="line">systemctl stop es</span><br><span class="line">rm -rf /oldboyedu/softwares/&#123;data,logs&#125; /tmp/*</span><br><span class="line">install -o oldboyedu -g oldboyedu -d /oldboyedu/softwares/es/logs</span><br><span class="line"></span><br><span class="line">(2)创建数据和日志目录</span><br><span class="line">[root@elk101.oldboyedu.com ~]# mkdir -pv /oldboyedu/&#123;data,logs&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# ll /oldboyedu/&#123;data,logs&#125;</span><br><span class="line">[root@elk101.oldboyedu.com ~]# install -d /oldboyedu/&#123;data,logs&#125;/es7 -o oldboyedu -g oldboyedu</span><br><span class="line"></span><br><span class="line">(3)修改配置文件</span><br><span class="line">[root@elk101.oldboyedu.com ~]# vim /oldboyedu/softwares/es/config/elasticsearch.yml</span><br><span class="line">...</span><br><span class="line">cluster.name: oldboyedu-linux80-elk</span><br><span class="line">path.data: /oldboyedu/data/es7</span><br><span class="line">path.logs: /oldboyedu/logs/es7</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">discovery.seed_hosts: [&quot;10.0.0.101&quot;,&quot;10.0.0.102&quot;,&quot;10.0.0.103&quot;]</span><br><span class="line">cluster.initial_master_nodes: [&quot;10.0.0.101&quot;,&quot;10.0.0.102&quot;,&quot;10.0.0.103&quot;]</span><br><span class="line"></span><br><span class="line">(4)elk101节点同步数据到其他节点,其他节点需要创建用户</span><br><span class="line">[root@elk101.oldboyedu.com ~]# data_rsync.sh /oldboyedu/</span><br><span class="line">[root@elk101.oldboyedu.com ~]# data_rsync.sh /etc/security/limits.d/elk.conf</span><br><span class="line">[root@elk101.oldboyedu.com ~]# data_rsync.sh /etc/sysctl.d/elk.conf</span><br><span class="line">[root@elk101.oldboyedu.com ~]# data_rsync.sh /usr/lib/systemd/system/es.service</span><br><span class="line">[root@elk101.oldboyedu.com ~]# data_rsync.sh /etc/profile.d/elk.sh</span><br><span class="line"></span><br><span class="line">(5)其他节点重连会话后执行以下操作</span><br><span class="line">[root@elk102.oldboyedu.com ~]# useradd oldboyedu</span><br><span class="line">[root@elk103.oldboyedu.com ~]# useradd oldboyedu</span><br><span class="line">[root@elk102.oldboyedu.com ~]# sysctl -f /etc/sysctl.d/elk.conf</span><br><span class="line">[root@elk102.oldboyedu.com ~]# sysctl -q vm.max_map_count</span><br><span class="line">[root@elk103.oldboyedu.com ~]# sysctl -f /etc/sysctl.d/elk.conf</span><br><span class="line">[root@elk103.oldboyedu.com ~]# sysctl -q vm.max_map_count</span><br><span class="line">[root@elk102.oldboyedu.com ~]# systemctl daemon-reload</span><br><span class="line">[root@elk103.oldboyedu.com ~]# systemctl daemon-reload</span><br><span class="line">[root@elk102.oldboyedu.com ~]# install -o oldboyedu -g oldboyedu -d /oldboyedu/softwares/es/logs</span><br><span class="line">[root@elk103.oldboyedu.com ~]# install -o oldboyedu -g oldboyedu -d /oldboyedu/softwares/es/logs</span><br><span class="line"></span><br><span class="line">(6)启动服务</span><br><span class="line">[root@elk102.oldboyedu.com ~]# systemctl start es</span><br><span class="line">[root@elk103.oldboyedu.com ~]# systemctl start es</span><br><span class="line"></span><br><span class="line">(7)查看集群</span><br><span class="line">[root@elk101.oldboyedu.com ~]# curl 10.0.0.101:9200/_cat/nodes</span><br></pre></td></tr></table></figure>





<h2 id="6-部署kibana服务"><a href="#6-部署kibana服务" class="headerlink" title="6.部署kibana服务"></a>6.部署kibana服务</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@elk103.oldboyedu.com ~]# wget https://artifacts.elastic.co/downloads/kibana/kibana-7.17.3-linux-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line">(1)解压软件包</span><br><span class="line">[root@elk103.oldboyedu.com ~]# tar xf kibana-7.17.3-linux-x86_64.tar.gz -C /oldboyedu/softwares/</span><br><span class="line"></span><br><span class="line">(2)创建符号链接</span><br><span class="line">[root@elk103.oldboyedu.com ~]# cd /oldboyedu/softwares/ &amp;&amp; ln -sv kibana-7.17.3-linux-x86_64 kibana</span><br><span class="line"></span><br><span class="line">(3)配置环境变量</span><br><span class="line">[root@elk103.oldboyedu.com ~]# cat &gt;&gt; /etc/profile.d/elk.sh &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">export KIBANA_HOME=/oldboyedu/softwares/kibana</span><br><span class="line">export PATH=$PATH:$KIBANA_HOME/bin</span><br><span class="line">EOF</span><br><span class="line">[root@elk103.oldboyedu.com ~]# source /etc/profile.d/jdk.sh</span><br><span class="line"></span><br><span class="line">(4)修改文件权限</span><br><span class="line">[root@elk103.oldboyedu.com ~]# chown oldboyedu:oldboyedu -R /oldboyedu/softwares/kibana-7.17.3-linux-x86_64/</span><br><span class="line"></span><br><span class="line">(5)修改配置文件</span><br><span class="line">[root@elk103.oldboyedu.com ~]# vim  /oldboyedu/softwares/kibana/config/kibana.yml</span><br><span class="line">...</span><br><span class="line">server.host: &quot;0.0.0.0&quot;</span><br><span class="line">server.name: &quot;oldboyedu-linux80-kibana&quot;</span><br><span class="line">elasticsearch.hosts: [&quot;http://10.0.0.101:9200&quot;,&quot;http://10.0.0.102:9200&quot;,&quot;http://10.0.0.103:9200&quot;]</span><br><span class="line">i18n.locale: &quot;zh-CN&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(6)启动服务</span><br><span class="line">[root@elk103.oldboyedu.com ~]# su -c &quot;kibana&quot; oldboyedu</span><br></pre></td></tr></table></figure>





<h2 id="7-部署logstash"><a href="#7-部署logstash" class="headerlink" title="7.部署logstash"></a>7.部署logstash</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/logstash/logstash-7.17.3-linux-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line">(1)解压logstaash</span><br><span class="line">[root@elk101.oldboyedu.com ~]# tar xf logstash-7.17.3-linux-x86_64.tar.gz -C /oldboyedu/softwares/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(2)创建符号链接</span><br><span class="line">[root@elk101.oldboyedu.com ~]# cd /oldboyedu/softwares/ &amp;&amp; ln -sv logstash-7.17.3 logstash</span><br><span class="line"></span><br><span class="line">(3)配置环境变量</span><br><span class="line">[root@elk101.oldboyedu.com ~]# cat &gt;&gt; /etc/profile.d/elk.sh &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">export LOGSTASH_HOME=/oldboyedu/softwares/logstash</span><br><span class="line">export PATH=$PATH:$LOGSTASH_HOME/bin</span><br><span class="line">EOF</span><br><span class="line">[root@elk101.oldboyedu.com ~]# source /etc/profile.d/jdk.sh</span><br><span class="line"></span><br><span class="line">(4)编写测试案例</span><br><span class="line">[root@elk101.oldboyedu.com ~]# vim conf-logstash/01-stdin-to-stdout.conf</span><br><span class="line">input &#123;</span><br><span class="line">  stdin &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(5)运行测试案例</span><br><span class="line">[root@elk101.oldboyedu.com ~]# logstash -f conf-logstash/01-stdin-to-stdout.conf</span><br></pre></td></tr></table></figure>



<h2 id="8-部署filebeat"><a href="#8-部署filebeat" class="headerlink" title="8.部署filebeat"></a>8.部署filebeat</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.17.3-linux-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line">(1)解压软件包</span><br><span class="line">[root@elk102.oldboyedu.com ~]# tar xf filebeat-7.17.3-linux-x86_64.tar.gz -C /oldboyedu/softwares/</span><br><span class="line"></span><br><span class="line">(2)编写配置文件</span><br><span class="line">[root@elk102.oldboyedu.com filebeat-7.17.3-linux-x86_64]# vim config-filebeat/01-stdin-to-console.yml</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: stdin</span><br><span class="line"></span><br><span class="line">output.console:</span><br><span class="line">  pretty: true</span><br><span class="line"></span><br><span class="line">(3)启动filebeat实例</span><br><span class="line">[root@elk102.oldboyedu.com filebeat-7.17.3-linux-x86_64]# ./filebeat -e -c config-filebeat/01-stdin-to-console.yml</span><br></pre></td></tr></table></figure>





<h2 id="9-部署es-head插件"><a href="#9-部署es-head插件" class="headerlink" title="9.部署es-head插件"></a>9.部署es-head插件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(1)解压es-head组件的软件包</span><br><span class="line">unzip es-head-0.1.4_0.crx.zip</span><br><span class="line"></span><br><span class="line">(2)谷歌浏览器导入软件包</span><br><span class="line">设置 ---&gt; 扩展程序 ---&gt; 勾选&quot;开发者模式&quot; ---&gt; &quot;加载已解压的扩展程序&quot;  ---&gt; 选择&quot;上一步骤解压的目录&quot;</span><br></pre></td></tr></table></figure>



<h2 id="10-部署postman组件"><a href="#10-部署postman组件" class="headerlink" title="10.部署postman组件"></a>10.部署postman组件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(1)下载postman组件</span><br><span class="line">https://www/postman.com/downloads/</span><br><span class="line"></span><br><span class="line">(2)post的使用</span><br></pre></td></tr></table></figure>



<h2 id="11-今日作业-1"><a href="#11-今日作业-1" class="headerlink" title="11.今日作业"></a>11.今日作业</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(1)完成课堂的所有练习</span><br><span class="line">(2)完善kibana的启动脚本使用systemctl工具管理kibana并设置为开机自启动；</span><br><span class="line"></span><br><span class="line">进阶作业：</span><br><span class="line">    调研logstash的多pipline编写。</span><br></pre></td></tr></table></figure>





<h1 id="十三-ElasticSearch的Restful风格API实战"><a href="#十三-ElasticSearch的Restful风格API实战" class="headerlink" title="十三.ElasticSearch的Restful风格API实战"></a>十三.ElasticSearch的Restful风格API实战</h1><h2 id="1-1-Restful及JSON格式"><a href="#1-1-Restful及JSON格式" class="headerlink" title="1.1.Restful及JSON格式"></a>1.1.Restful及JSON格式</h2><table>
<thead>
<tr>
<th>数据类型</th>
<th>描述</th>
<th>举例</th>
</tr>
</thead>
<tbody><tr>
<td>字符串</td>
<td>要求使用双引号(“”)引起来的数据</td>
<td>“oldboyedu”</td>
</tr>
<tr>
<td>数字</td>
<td>通常指的是0-9的所有数字。</td>
<td>100</td>
</tr>
<tr>
<td>布尔值</td>
<td>只有true和false两个值。</td>
<td>true</td>
</tr>
<tr>
<td>空值</td>
<td>只有null一个值。</td>
<td>null</td>
</tr>
<tr>
<td>数组</td>
<td>使用一对中括号(“[]”)放入不同的元素(支持高级数据类型和基础数据类型)</td>
<td>[“linux”,100,false]</td>
</tr>
<tr>
<td>对象</td>
<td>使用一对大括号(“{}”)扩起来，里面的数据使用KEY-VALUE键值对即可。</td>
<td>{“class”:”linux80”,”age”:25}</td>
</tr>
</tbody></table>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Restful风格程序：</span><br><span class="line">    RESTFUL是一种网络应用程序的设计风格和开发方式，基于HTTP，可以使用XML格式定义或JSON格式定义。</span><br><span class="line">    REST（英文：Representational State Transfer，简称REST）描述了一个架构样式的网络系统，比如 web 应用程序。</span><br><span class="line">    REST首次出现在 <span class="number">2000</span> 年 Roy Fielding 的博士论文中，Roy Fielding是 HTTP 规范的主要编写者之一。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">JSON语法：</span><br><span class="line">    基础数据类型：</span><br><span class="line">        字符串：</span><br><span class="line">            <span class="string">&quot;oldboyedu&quot;</span></span><br><span class="line">            <span class="string">&quot;老男孩IT教育&quot;</span></span><br><span class="line">            <span class="string">&quot;2022&quot;</span></span><br><span class="line">            <span class="string">&quot;&quot;</span></span><br><span class="line">        数字：</span><br><span class="line">            <span class="number">0</span></span><br><span class="line">            <span class="number">1</span></span><br><span class="line">            <span class="number">2</span></span><br><span class="line">        布尔值：</span><br><span class="line">            <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">            <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        空值：</span><br><span class="line">            <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">            </span><br><span class="line">    高级数据类型：</span><br><span class="line">        数组：</span><br><span class="line">            <span class="punctuation">[</span><span class="string">&quot;oldboyedu&quot;</span><span class="punctuation">,</span><span class="string">&quot;沙河&quot;</span><span class="punctuation">,</span><span class="number">2022</span><span class="punctuation">,</span><span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">]</span></span><br><span class="line">            </span><br><span class="line">        对象：</span><br><span class="line">            <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;oldboy&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">40</span><span class="punctuation">,</span> <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span><span class="string">&quot;北京沙河&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;hobby&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;Linux&quot;</span><span class="punctuation">,</span><span class="string">&quot;思想课&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span><span class="attr">&quot;other&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">null</span></span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">课堂练习：</span><br><span class="line">   使用json格式记录你的名字(name)，年龄(age)，学校(school)<span class="punctuation">,</span>爱好(hobby)<span class="punctuation">,</span>地址(address)。</span><br></pre></td></tr></table></figure>



<h2 id="2-ElasticSearch的相关术语"><a href="#2-ElasticSearch的相关术语" class="headerlink" title="2.ElasticSearch的相关术语"></a>2.ElasticSearch的相关术语</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Document:</span><br><span class="line">    即文档，是用户存储在ES的一些数据，它是ES中最小的存储单元。换句话说，一个文档是不可被拆分的。</span><br><span class="line">    一个文档使用的是json的对象数据类型存储。</span><br><span class="line"></span><br><span class="line">filed:</span><br><span class="line">    相当于数据库表的字段，对文档数据根据不同属性进行分类标示。</span><br><span class="line"></span><br><span class="line">index:</span><br><span class="line">    即索引，一个索引就是一个拥有相似特征文档的集合。</span><br><span class="line">    </span><br><span class="line">shard:</span><br><span class="line">    即分片，是真正存储数据的地方，每个分片底层对应的是一个Lucene库。一个索引至少有一个或多个分片。</span><br><span class="line"></span><br><span class="line">replica:</span><br><span class="line">    即副本，是对数据的备份，一个分片可以有0个或多个副本。</span><br><span class="line">    一旦副本数量不为0,就会引入主分片(primary shard)和副本分片(replica shard)的概念。</span><br><span class="line">        主分片(primary shard)：</span><br><span class="line">            可以实现数据的读写操作。</span><br><span class="line">        副本分片（replica shard)：</span><br><span class="line">            可以实现数据读操作，与此同时，需要去主分片同步数据，当主分片挂掉，副本分片会变为主分片。</span><br><span class="line"></span><br><span class="line">Allocation:</span><br><span class="line">    即分配，将分片(shard)分配给某个节点的过程，包括主分片和副本分片。</span><br><span class="line">    如果是副本分片，还包含从主分片复制数据的过程，这个分配过程由master节点调度完成。</span><br><span class="line"></span><br><span class="line">Type:</span><br><span class="line">    在es 5.x即更早的版本，在一个索引中，我们可以定义一种或多种数据类型。但在es7仅支持&quot;_doc&quot;类型。</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://mo-li001.github.io">壹拾陆</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://mo-li001.github.io/posts/dd49d155.html">https://mo-li001.github.io/posts/dd49d155.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mo-li001.github.io" target="_blank">壹拾陆</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/52994.html"><img class="prev-cover" src="https://tuchuangs.com/imgs/2022/09/18/074f3836d4f471b8.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">KVM软件安装</div></div></a></div><div class="next-post pull-right"><a href="/posts/3c2afe45.html"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Keepalived</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/9f353bc9.html" title="Devops"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Devops</div></div></a></div><div><a href="/posts/f5f9fa9b.html" title="Docker"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Docker</div></div></a></div><div><a href="/posts/34d20e28.html" title="ELK"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">ELK</div></div></a></div><div><a href="/posts/8005.html" title="ELK快速部署"><img class="cover" src="https://tuchuangs.com/imgs/2022/09/18/074f3836d4f471b8.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">ELK快速部署</div></div></a></div><div><a href="/posts/9bdc030a.html" title="HAproxy"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">HAproxy</div></div></a></div><div><a href="/posts/a71433d.html" title="Ansible"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Ansible</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202209182232723.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">壹拾陆</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">68</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mo-li001/"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">个人笔记</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81Elastic-Stack%E5%9C%A8%E4%BC%81%E4%B8%9A%E7%9A%84%E5%B8%B8%E8%A7%81%E6%9E%B6%E6%9E%84"><span class="toc-text">一、Elastic Stack在企业的常见架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%B2%A1%E6%9C%89%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E7%B3%BB%E7%BB%9F%E8%BF%90%E7%BB%B4%E5%B7%A5%E4%BD%9C%E7%9A%84%E6%97%A5%E5%B8%B8%E2%80%9C%E9%80%9A%E7%82%B9%E2%80%9D%E6%A6%82%E8%BF%B0"><span class="toc-text">1.没有日志收集系统运维工作的日常“通点”概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Elastic-Stack%E5%88%86%E5%B8%83%E5%BC%8F%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0"><span class="toc-text">2.Elastic Stack分布式日志系统概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Elastic-Stack%E4%BC%81%E4%B8%9A%E7%BA%A7%E2%80%9CEFK%E2%80%9C%E6%9E%B6%E6%9E%84%E5%9B%BE%E8%A7%A3"><span class="toc-text">3.Elastic Stack企业级“EFK“架构图解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Elastic-Stack%E4%BC%81%E4%B8%9A%E7%BA%A7%E2%80%9DELK%E2%80%9C%E6%9E%B6%E6%9E%84%E5%9B%BE%E8%A7%A3"><span class="toc-text">4.Elastic Stack企业级”ELK“架构图解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Elastic-Stack%E4%BC%81%E4%B8%9A%E7%BA%A7%E2%80%9DELFK%E2%80%9C%E6%9E%B6%E6%9E%84%E5%9B%BE%E8%A7%A3"><span class="toc-text">5.Elastic Stack企业级”ELFK“架构图解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Elastic-Stack%E4%BC%81%E4%B8%9A%E7%BA%A7%E2%80%9DELFK%E2%80%9D-%E2%80%9DKafka%E2%80%9D%E6%9E%B6%E6%9E%84%E5%9B%BE%E8%A7%A3"><span class="toc-text">6.Elastic Stack企业级”ELFK”+”Kafka”架构图解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-Elastic-Stack%E4%BC%81%E4%B8%9A%E7%BA%A7%E2%80%9DELFK%E2%80%9D-%E2%80%9Dkafka%E2%80%9D%E6%9E%B6%E6%9E%84%E6%BC%94%E5%8F%98"><span class="toc-text">7.Elastic Stack企业级”ELFK”+”kafka”架构演变</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0%E6%96%B9%E6%B3%95%E4%BB%8B%E7%BB%8D"><span class="toc-text">8.课程学习方法介绍</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C-ElasticSearch%E5%92%8CSolr%E7%9A%84%E6%8A%89%E6%8B%A9"><span class="toc-text">二.ElasticSearch和Solr的抉择</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-ElasticSearch%E5%92%8CLucene%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-text">1.ElasticSearch和Lucene的关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-ElasticSearch%E5%92%8CSolr%E5%A6%82%E4%BD%95%E6%8A%89%E6%8B%A9"><span class="toc-text">2.ElasticSearch和Solr如何抉择</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89-%E9%9B%86%E7%BE%A4%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">三.集群基础环境初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%87%86%E5%A4%87%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-text">1.准备虚拟机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%BF%AE%E6%94%B9%E8%BD%AF%E4%BB%B6%E6%BA%90"><span class="toc-text">2.修改软件源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%BF%AE%E6%94%B9%E7%BB%88%E7%AB%AF%E9%A2%9C%E8%89%B2"><span class="toc-text">3.修改终端颜色</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E4%BF%AE%E6%94%B9sshd%E6%9C%8D%E5%8A%A1%E4%BC%98%E5%8C%96"><span class="toc-text">4.修改sshd服务优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99"><span class="toc-text">5.关闭防火墙</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E7%A6%81%E7%94%A8selinux"><span class="toc-text">6.禁用selinux</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95%E5%8F%8A%E5%90%8C%E6%AD%A5%E8%84%9A%E6%9C%AC"><span class="toc-text">7.配置集群免密登录及同步脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E9%9B%86%E7%BE%A4%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5"><span class="toc-text">8.集群时间同步</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B-ElasticSearch%E5%8D%95%E7%82%B9%E9%83%A8%E7%BD%B2"><span class="toc-text">四.ElasticSearch单点部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%B8%8B%E8%BD%BD%E6%8C%87%E5%AE%9A%E7%9A%84ES%E7%89%88%E6%9C%AC"><span class="toc-text">1.下载指定的ES版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E9%83%A8%E7%BD%B2JDK%E7%8E%AF%E5%A2%83-%E5%8F%AF%E9%80%89%E6%AD%A5%E9%AA%A4-%E8%B7%B3%E8%BF%87"><span class="toc-text">2.部署JDK环境-可选步骤(跳过)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%8D%95%E7%82%B9%E9%83%A8%E7%BD%B2elasticsearh"><span class="toc-text">3.单点部署elasticsearh</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-OpenJDK%E5%88%87%E6%8D%A2Oracle-JDK%E5%B9%B6%E4%BF%AE%E6%94%B9%E5%A0%86%E5%86%85%E5%AD%98%E5%A4%A7%E5%B0%8F-%E8%B7%B3%E8%BF%87"><span class="toc-text">4.OpenJDK切换Oracle JDK并修改堆内存大小-(跳过)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94-ElasticSearch%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="toc-text">五.ElasticSearch分布式集群部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-elk101%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">1.elk101修改配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%90%8C%E6%AD%A5%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%88%B0%E9%9B%86%E7%BE%A4%E7%9A%84%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9"><span class="toc-text">2.同步配置文件到集群的其他节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E5%88%A0%E9%99%A4%E4%B9%8B%E5%89%8D%E7%9A%84%E4%B8%B4%E6%97%B6%E6%95%B0%E6%8D%AE"><span class="toc-text">3.所有节点删除之前的临时数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-text">4.所有节点启动服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E9%AA%8C%E8%AF%81%E9%9B%86%E7%BE%A4%E6%98%AF%E5%90%A6%E6%AD%A3%E5%B8%B8"><span class="toc-text">5.验证集群是否正常</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD-%E9%83%A8%E7%BD%B2kibana%E6%9C%8D%E5%8A%A1"><span class="toc-text">六.部署kibana服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%9C%AC%E5%9C%B0%E5%AE%89%E8%A3%85kibana"><span class="toc-text">1.本地安装kibana</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%BF%AE%E6%94%B9kibana%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">2.修改kibana的配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%90%AF%E5%8A%A8kibana%E6%9C%8D%E5%8A%A1"><span class="toc-text">3.启动kibana服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%AE%BF%E9%97%AEkibana%E7%9A%84webUI"><span class="toc-text">4.访问kibana的webUI</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83-filebeat%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2"><span class="toc-text">七.filebeat环境部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%83%A8%E7%BD%B2filebeat%E7%8E%AF%E5%A2%83"><span class="toc-text">1.部署filebeat环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%BF%AE%E6%94%B9filebeat%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">2.修改filebeat的配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-input%E7%9A%84log%E7%B1%BB%E5%9E%8B"><span class="toc-text">3.input的log类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-input%E7%9A%84%E9%80%9A%E9%85%8D%E7%AC%A6%E6%A1%88%E4%BE%8B"><span class="toc-text">4.input的通配符案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-input%E7%9A%84%E9%80%9A%E7%94%A8%E5%AD%97%E6%AE%B5%E6%A1%88%E4%BE%8B"><span class="toc-text">5.input的通用字段案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%B0%86%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5es%E6%A1%88%E4%BE%8B"><span class="toc-text">6.将数据写入es案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E8%87%AA%E5%AE%9A%E4%B9%89es%E7%B4%A2%E5%BC%95%E5%90%8D%E7%A7%B0"><span class="toc-text">7.自定义es索引名称</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E5%A4%9A%E4%B8%AA%E7%B4%A2%E5%BC%95%E5%86%99%E5%85%A5%E6%A1%88%E4%BE%8B"><span class="toc-text">8.多个索引写入案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E7%89%87%E5%92%8C%E5%89%AF%E6%9C%AC%E6%A1%88%E4%BE%8B"><span class="toc-text">9.自定义分片和副本案例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AB-EFK%E6%9E%B6%E6%9E%84%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="toc-text">八.EFK架构企业级实战案例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%83%A8%E7%BD%B2nginx%E6%9C%8D%E5%8A%A1"><span class="toc-text">1.部署nginx服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%9F%BA%E4%BA%8Elog%E7%B1%BB%E5%9E%8B%E6%94%B6%E9%9B%86nginx%E5%8E%9F%E7%94%9F%E6%97%A5%E5%BF%97"><span class="toc-text">2.基于log类型收集nginx原生日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%9F%BA%E4%BA%8Elog%E7%B1%BB%E5%9E%8B%E6%94%B6%E9%9B%86nginx%E7%9A%84json%E6%97%A5%E5%BF%97"><span class="toc-text">3.基于log类型收集nginx的json日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%9F%BA%E4%BA%8E%E6%A8%A1%E5%9D%97%E9%87%87%E9%9B%86nginx%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6"><span class="toc-text">4.基于模块采集nginx日志文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%9F%BA%E4%BA%8E%E6%A8%A1%E5%9D%97%E9%87%87%E9%9B%86tomcat%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6"><span class="toc-text">5.基于模块采集tomcat日志文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%9F%BA%E4%BA%8Elog%E7%B1%BB%E5%9E%8B%E6%94%B6%E9%9B%86tomcat%E7%9A%84%E5%8E%9F%E7%94%9F%E6%97%A5%E5%BF%97"><span class="toc-text">6.基于log类型收集tomcat的原生日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E5%9F%BA%E4%BA%8Elog%E7%B1%BB%E5%9E%8B%E6%94%B6%E9%9B%86tomcat%E7%9A%84json%E6%97%A5%E5%BF%97"><span class="toc-text">7.基于log类型收集tomcat的json日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E5%A4%9A%E8%A1%8C%E5%8C%B9%E9%85%8D-%E6%94%B6%E9%9B%86tomcat%E7%9A%84%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97"><span class="toc-text">8.多行匹配-收集tomcat的错误日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E5%A4%9A%E8%A1%8C%E5%8C%B9%E9%85%8D-%E6%94%B6%E9%9B%86elasticsearch%E7%9A%84%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97"><span class="toc-text">9.多行匹配-收集elasticsearch的错误日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-nginx%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97%E8%BF%87%E6%BB%A4"><span class="toc-text">10.nginx错误日志过滤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-nginx%E5%92%8Ctomcat%E5%90%8C%E6%97%B6%E9%87%87%E9%9B%86%E6%A1%88%E4%BE%8B"><span class="toc-text">11.nginx和tomcat同时采集案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-input%E6%8F%92%E4%BB%B6filestream%E7%B1%BB%E5%9E%8B%E6%A1%88%E4%BE%8B"><span class="toc-text">12.input插件filestream类型案例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B9%9D-filebeat%E4%BC%81%E4%B8%9A%E5%B8%B8%E8%A7%81%E6%A1%88%E4%BE%8B-EFK%E6%9E%B6%E6%9E%84"><span class="toc-text">九.filebeat企业常见案例(EFK架构)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%BD%BF%E7%94%A8filebeat%E6%94%B6%E9%9B%86nginx%E6%97%A5%E5%BF%97%E5%88%B0es%E9%9B%86%E7%BE%A4"><span class="toc-text">1.使用filebeat收集nginx日志到es集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E8%87%AA%E5%AE%9A%E4%B9%89nginx%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F%E5%8F%8AES%E7%B4%A2%E5%BC%95%E5%90%8D%E7%A7%B0"><span class="toc-text">2.自定义nginx日志格式及ES索引名称</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E8%87%AA%E5%AE%9A%E4%B9%89tomcat%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F%E5%B9%B6%E6%8C%87%E5%AE%9A%E7%B4%A2%E5%BC%95%E5%88%86%E7%89%87"><span class="toc-text">3.自定义tomcat日志格式并指定索引分片</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81-log%E7%B1%BB%E5%9E%8B%E5%88%87%E6%8D%A2filestream%E7%B1%BB%E5%9E%8B%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text">十.log类型切换filestream类型注意事项</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-filestream%E7%B1%BB%E5%9E%8Bjson%E8%A7%A3%E6%9E%90%E9%85%8D%E7%BD%AE"><span class="toc-text">1.filestream类型json解析配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-filestream%E7%B1%BB%E5%9E%8B%E5%A4%9A%E8%A1%8C%E5%8C%B9%E9%85%8D"><span class="toc-text">2.filestream类型多行匹配</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-%E6%94%B6%E9%9B%86%E6%97%A5%E5%BF%97%E5%88%B0redis%E6%9C%8D%E5%8A%A1"><span class="toc-text">13.收集日志到redis服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#13-1-%E9%83%A8%E7%BD%B2redis"><span class="toc-text">13.1 部署redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">13.2 修改配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-3-%E5%90%AF%E5%8A%A8redis%E6%9C%8D%E5%8A%A1"><span class="toc-text">13.3 启动redis服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-4-%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9%E8%BF%9E%E6%8E%A5%E6%B5%8B%E8%AF%95redis%E7%8E%AF%E5%A2%83"><span class="toc-text">13.4 其他节点连接测试redis环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-5-%E5%B0%86filebeat%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5%E5%88%B0Redis%E7%8E%AF%E5%A2%83"><span class="toc-text">13.5 将filebeat数据写入到Redis环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-6-%E6%B5%8B%E8%AF%95%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-text">13.6 测试写入数据</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B9%9D-%E9%83%A8%E7%BD%B2logstash%E7%8E%AF%E5%A2%83%E5%8F%8A%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8"><span class="toc-text">九.部署logstash环境及基础使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%83%A8%E7%BD%B2logstash%E7%8E%AF%E5%A2%83"><span class="toc-text">1.部署logstash环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%BF%AE%E6%94%B9logstash%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">2.修改logstash的配置文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81-logstash%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%B8%B8%E8%A7%81%E6%A1%88%E4%BE%8B-ELFK%E6%A1%88%E4%BE%8B"><span class="toc-text">十.logstash企业级常见案例(ELFK案例)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-logstash%E6%94%B6%E9%9B%86%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6"><span class="toc-text">1.logstash收集本地文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-logstash%E6%94%B6%E9%9B%86%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E3%80%81input%E6%8F%92%E4%BB%B6%E5%9F%BA%E4%BA%8Efile%E6%A1%88%E4%BE%8B"><span class="toc-text">3.logstash收集本地文件、input插件基于file案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-logstash%E5%AE%9E%E7%8E%B0%E6%97%A5%E5%BF%97%E8%81%9A%E5%90%88%E3%80%81input%E6%8F%92%E4%BB%B6%E5%9F%BA%E4%BA%8Etcp%E6%A1%88%E4%BE%8B"><span class="toc-text">4.logstash实现日志聚合、input插件基于tcp案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-input%E6%8F%92%E4%BB%B6%E5%9F%BA%E4%BA%8E%E5%9F%BA%E4%BA%8Ehttp%E6%A1%88%E4%BE%8B"><span class="toc-text">5.input插件基于基于http案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-input%E6%8F%92%E4%BB%B6%E5%9F%BA%E4%BA%8Eredis%E6%A1%88%E4%BE%8B"><span class="toc-text">6.input插件基于redis案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-input%E6%8F%92%E4%BB%B6%E5%9F%BA%E4%BA%8Ebeats%E6%A1%88%E4%BE%8B%E3%80%81filebeat%E5%92%8Clogstash%E6%89%93%E9%80%9A"><span class="toc-text">7.input插件基于beats案例、filebeat和logstash打通</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-output%E6%8F%92%E4%BB%B6%E5%9F%BA%E4%BA%8Eredis%E6%A1%88%E4%BE%8B"><span class="toc-text">8.output插件基于redis案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-output%E6%8F%92%E4%BB%B6%E5%9F%BA%E4%BA%8Efile%E6%A1%88%E4%BE%8B"><span class="toc-text">9.output插件基于file案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-logstash%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B"><span class="toc-text">10.logstash综合案例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81-logstash%E4%BC%81%E4%B8%9A%E7%BA%A7%E6%8F%92%E4%BB%B6%E6%A1%88%E4%BE%8B-ELFK%E6%9E%B6%E6%9E%84"><span class="toc-text">十.logstash企业级插件案例(ELFK架构)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%B8%B8%E8%A7%81%E7%9A%84%E6%8F%92%E4%BB%B6%E6%A6%82%E8%BF%B0"><span class="toc-text">1.常见的插件概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8grok%E5%86%85%E7%BD%AE%E7%9A%84%E6%AD%A3%E5%88%99%E6%A1%88%E4%BE%8B"><span class="toc-text">2.使用grok内置的正则案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%BD%BF%E7%94%A8grok%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E6%AD%A3%E5%88%99%E6%A1%88%E4%BE%8B1"><span class="toc-text">3.使用grok自定义的正则案例1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E4%BD%BF%E7%94%A8grok%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E6%AD%A3%E5%88%99%E6%A1%88%E4%BE%8B2"><span class="toc-text">4.使用grok自定义的正则案例2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E9%80%9A%E7%94%A8%E5%AD%97%E6%AE%B5%E6%A1%88%E4%BE%8B"><span class="toc-text">5.通用字段案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-date%E6%8F%92%E4%BB%B6%E4%BF%AE%E6%94%B9%E5%86%99%E5%85%A5ES%E7%9A%84%E6%97%B6%E9%97%B4"><span class="toc-text">6.date插件修改写入ES的时间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-geoip%E5%88%86%E6%9E%90%E6%BA%90%E5%9C%B0%E5%9D%80%E7%9A%84%E5%9C%B0%E5%9D%80%E4%BD%8D%E7%BD%AE"><span class="toc-text">7.geoip分析源地址的地址位置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-useragent%E5%88%86%E6%9E%90%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E8%AE%BE%E5%A4%87%E7%B1%BB%E5%9E%8B"><span class="toc-text">8.useragent分析客户端的设备类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-mutate%E7%BB%84%E4%BB%B6%E5%B8%B8%E7%94%A8%E5%AD%97%E6%AE%B5%E6%A1%88%E4%BE%8B"><span class="toc-text">9.mutate组件常用字段案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-mutate%E7%BB%84%E4%BB%B6%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87-python%E8%84%9A%E6%9C%AC"><span class="toc-text">9.mutate组件数据准备-python脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-logstash%E7%9A%84%E5%A4%9Aif%E5%88%86%E6%94%AF%E6%A1%88%E4%BE%8B"><span class="toc-text">10.logstash的多if分支案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-%E4%BB%8A%E6%97%A5%E4%BD%9C%E4%B8%9A"><span class="toc-text">11.今日作业</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Filebeat%E6%94%B6%E9%9B%86nginx%E6%97%A5%E5%BF%97"><span class="toc-text">Filebeat收集nginx日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Filebeat%E6%94%B6%E9%9B%86tomcat%E6%97%A5%E5%BF%97"><span class="toc-text">Filebeat收集tomcat日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Filebeat%E6%94%B6%E9%9B%86apps%E6%97%A5%E5%BF%97"><span class="toc-text">Filebeat收集apps日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#logstash%E6%94%B6%E9%9B%86nginx%E6%97%A5%E5%BF%97"><span class="toc-text">logstash收集nginx日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#logstash%E6%94%B6%E9%9B%86tomcat%E6%97%A5%E5%BF%97"><span class="toc-text">logstash收集tomcat日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#logstash%E6%94%B6%E9%9B%86apps%E6%97%A5%E5%BF%97"><span class="toc-text">logstash收集apps日志</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%B8%80-kibana%E7%9A%84dashboard%E5%AE%9A%E5%88%B6"><span class="toc-text">十一.kibana的dashboard定制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%BB%9F%E8%AE%A1PV"><span class="toc-text">1.统计PV</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%BB%9F%E8%AE%A1%E5%AE%A2%E6%88%B7%E7%AB%AFIP"><span class="toc-text">2.统计客户端IP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%BB%9F%E8%AE%A1web%E4%B8%8B%E8%BD%BD%E5%B8%A6%E5%AE%BD"><span class="toc-text">3.统计web下载带宽</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%AE%BF%E9%97%AE%E9%A1%B5%E9%9D%A2%E7%BB%9F%E8%AE%A1"><span class="toc-text">4.访问页面统计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-IP%E7%9A%84TopN%E7%BB%9F%E8%AE%A1-%E4%BB%AA%E8%A1%A8%E7%9B%98"><span class="toc-text">7.IP的TopN统计(仪表盘)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E8%87%AA%E5%AE%9A%E4%B9%89dashboard"><span class="toc-text">8.自定义dashboard</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C-ElasticStack%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2%E5%8F%8A%E6%8E%92%E9%94%99"><span class="toc-text">十二.ElasticStack二进制部署及排错</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%83%A8%E7%BD%B2Oracle-JDK%E7%8E%AF%E5%A2%83"><span class="toc-text">1.部署Oracle JDK环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%8D%95%E8%8A%82%E7%82%B9ES%E9%83%A8%E7%BD%B2"><span class="toc-text">2.单节点ES部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%BF%AE%E6%94%B9ES%E7%9A%84%E5%A0%86-heap-%E5%86%85%E5%AD%98%E5%A4%A7%E5%B0%8F"><span class="toc-text">3.修改ES的堆(heap)内存大小</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-ES%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC%E7%BC%96%E5%86%99"><span class="toc-text">4.ES启动脚本编写</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E9%83%A8%E7%BD%B2ES%E9%9B%86%E7%BE%A4"><span class="toc-text">5.部署ES集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E9%83%A8%E7%BD%B2kibana%E6%9C%8D%E5%8A%A1"><span class="toc-text">6.部署kibana服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E9%83%A8%E7%BD%B2logstash"><span class="toc-text">7.部署logstash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E9%83%A8%E7%BD%B2filebeat"><span class="toc-text">8.部署filebeat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E9%83%A8%E7%BD%B2es-head%E6%8F%92%E4%BB%B6"><span class="toc-text">9.部署es-head插件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-%E9%83%A8%E7%BD%B2postman%E7%BB%84%E4%BB%B6"><span class="toc-text">10.部署postman组件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-%E4%BB%8A%E6%97%A5%E4%BD%9C%E4%B8%9A-1"><span class="toc-text">11.今日作业</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%B8%89-ElasticSearch%E7%9A%84Restful%E9%A3%8E%E6%A0%BCAPI%E5%AE%9E%E6%88%98"><span class="toc-text">十三.ElasticSearch的Restful风格API实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-Restful%E5%8F%8AJSON%E6%A0%BC%E5%BC%8F"><span class="toc-text">1.1.Restful及JSON格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-ElasticSearch%E7%9A%84%E7%9B%B8%E5%85%B3%E6%9C%AF%E8%AF%AD"><span class="toc-text">2.ElasticSearch的相关术语</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/90f47a19.html" title="自动化装机">自动化装机</a><time datetime="2023-02-02T12:41:14.000Z" title="发表于 2023-02-02 20:41:14">2023-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/64202.html" title="linux">linux</a><time datetime="2023-02-02T12:41:14.000Z" title="发表于 2023-02-02 20:41:14">2023-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/8fb4d8df.html" title="zabbix">zabbix</a><time datetime="2023-02-02T01:43:57.000Z" title="发表于 2023-02-02 09:43:57">2023-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/8d6735b8.html" title="超经典SQL练习题，做完这些你的ＳＱＬ就过关了">超经典SQL练习题，做完这些你的ＳＱＬ就过关了</a><time datetime="2023-02-02T01:43:57.000Z" title="发表于 2023-02-02 09:43:57">2023-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/39d18a59.html" title="Mermaid绘图">Mermaid绘图</a><time datetime="2023-01-11T12:41:14.000Z" title="发表于 2023-01-11 20:41:14">2023-01-11</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 壹拾陆</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>