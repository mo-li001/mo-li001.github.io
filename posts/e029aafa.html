<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>二进制安装k8s | 壹拾陆</title><meta name="keywords" content="Linux"><meta name="author" content="壹拾陆"><meta name="copyright" content="壹拾陆"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="二进制安装k8s配置hosts 12345678cat &gt;&gt;&#x2F;etc&#x2F;hosts&lt;&lt;&amp;#x27;EOF&amp;#x27;192.168.0.107 k8s-master01192.168.0.108 k8s-master02192.168.0.109 k8s-master03192.168.0.236 k8s-master-lb  # 如果不是高可用集群，该IP为Master01">
<meta property="og:type" content="article">
<meta property="og:title" content="二进制安装k8s">
<meta property="og:url" content="https://mo-li001.github.io/posts/e029aafa.html">
<meta property="og:site_name" content="壹拾陆">
<meta property="og:description" content="二进制安装k8s配置hosts 12345678cat &gt;&gt;&#x2F;etc&#x2F;hosts&lt;&lt;&amp;#x27;EOF&amp;#x27;192.168.0.107 k8s-master01192.168.0.108 k8s-master02192.168.0.109 k8s-master03192.168.0.236 k8s-master-lb  # 如果不是高可用集群，该IP为Master01">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-08-31T12:41:14.000Z">
<meta property="article:modified_time" content="2022-12-01T15:47:55.734Z">
<meta property="article:author" content="壹拾陆">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://mo-li001.github.io/posts/e029aafa"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '二进制安装k8s',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-12-01 23:47:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202209182232723.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">96</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">壹拾陆</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">二进制安装k8s</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-31T12:41:14.000Z" title="发表于 2022-08-31 20:41:14">2022-08-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-12-01T15:47:55.734Z" title="更新于 2022-12-01 23:47:55">2022-12-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="二进制安装k8s"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="二进制安装k8s"><a href="#二进制安装k8s" class="headerlink" title="二进制安装k8s"></a><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV16Z4y1b74y?p=18&spm_id_from=pageDriver&vd_source=629395ac7befa1625191c3f496068941">二进制安装k8s</a></h1><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1848877">配置hosts</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt;/etc/hosts&lt;&lt;&#x27;EOF&#x27;</span><br><span class="line">192.168.0.107 k8s-master01</span><br><span class="line">192.168.0.108 k8s-master02</span><br><span class="line">192.168.0.109 k8s-master03</span><br><span class="line">192.168.0.236 k8s-master-lb  # 如果不是高可用集群，该IP为Master01的IP</span><br><span class="line">192.168.0.110 k8s-node01</span><br><span class="line">192.168.0.111 k8s-node02</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>配置yum源，安装基本工具</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repoe</span><br><span class="line">sed -i -e &#x27;/mirrors.cloud.aliyuncs.com/d&#x27; -e &#x27;/mirrors.aliyuncs.com/d&#x27; /etc/yum.repos.d/centos-Base.repoe</span><br></pre></td></tr></table></figure>

<p>必备工具安装</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install wget jq psmisc vim net-tools telnet yum-utils device-mapper-persistent-data lvm2 git -y</span><br></pre></td></tr></table></figure>

<p>所有节点关闭firewalld、dnsmasq、selinux(CentOS7需要关闭NetworkManager,CentOS8不需要）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">disable</span> --now firewalld</span><br><span class="line">Systemctl <span class="built_in">disable</span> --now dnsmasg</span><br><span class="line">aXstemctl <span class="built_in">disable</span> --now NetworkManagers</span><br><span class="line"></span><br><span class="line">setenforce 0</span><br><span class="line">sed -i <span class="string">&#x27;s#SELINUX=enforcing#SELINUX=disabled#g&#x27;</span> /etc/sysconfig/selinux</span><br><span class="line">sed -i <span class="string">&#x27;s#SELINUX=enforcing#SELINUX=disabled#g&#x27;</span> /etc/selinux/configt</span><br></pre></td></tr></table></figure>

<p>所有节点关闭swap分区，fstab注释swap</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a &amp;&amp; sysctl -w vm.swappiness=0</span><br><span class="line">sed -ri <span class="string">&#x27;/^[^#]*swap/s@^@#@&#x27;</span> /etc/fstab</span><br></pre></td></tr></table></figure>

<p>所有节点同步时间</p>
<p>安装 ntpdate</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm</span><br><span class="line">yum install ntpdate -y</span><br></pre></td></tr></table></figure>

<p>所有节点同步时间。时间同步配置如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ln</span> -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtimee</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;Asia/Shanghai&#x27;</span> &gt;/etc/timezone</span><br><span class="line">ntpdate time2.aliyun.come</span><br><span class="line"><span class="comment"># 加入到crontabe</span></span><br><span class="line">*/5 * * * * ntpdate time2.aliyun.com-</span><br></pre></td></tr></table></figure>

<p>所有节点配置limit：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -SHn 65535</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt;&gt;/etc/security/limits.conf&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string"># 末尾添加如下内容</span></span><br><span class="line"><span class="string">* soft nofile 655360</span></span><br><span class="line"><span class="string">* hard nofile 131072</span></span><br><span class="line"><span class="string">* soft nproc 655350</span></span><br><span class="line"><span class="string">* hard nproc 655350</span></span><br><span class="line"><span class="string">* soft memlock unlimited</span></span><br><span class="line"><span class="string">* hard memlock unlimited</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>Master01节点免密钥登录其他节点，安装过程中生成配置文件和证书均在Master01上操作，集群管理也在Mastero1上操作，阿里云或者AWS上需要单独一台kubectl服务器。密钥配置如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># ssh-keygen -t rsa</span></span><br></pre></td></tr></table></figure>

<p>Mastero1配置免密码登录其他节点</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02;<span class="keyword">do</span> ssh-copy-id -i .ssh/id_rsa.pub <span class="variable">$i</span>;<span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>所有节点安装基本工具</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install wget jq psmisc vim net-tools yum-utils device-mapper-persistent-data lvm2 git -y</span><br></pre></td></tr></table></figure>

<p>Master01 下载安装文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># cd /root/; git clone https://github.com/dotbalo/k8s-ha-install.git</span></span><br></pre></td></tr></table></figure>

<p>所有节点升级系统并重启，此处升级没有升级内核，下节会单独升级内核：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y --exclude=kernel* &amp;&amp; reboot  <span class="comment"># CentOS7需要升级,CentOS8可以按需升级系统</span></span><br></pre></td></tr></table></figure>



<h2 id="内核升级"><a href="#内核升级" class="headerlink" title="内核升级"></a>内核升级</h2><p>CentOS7 需要升级内核至 4.18+，本地升级的版本为 4.19</p>
<p>在master01节点下载内核：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /root</span><br><span class="line">wget http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm</span><br><span class="line">wget http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>从master01节点传到其他节点：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> k8s-master02 k8s-master03 k8s-node01 k8s-node02;<span class="keyword">do</span> scp kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm <span class="variable">$i</span>:/root/ ; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>所有节点安装内核</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root &amp;&amp; yum localinstall -y kernel-ml*</span><br></pre></td></tr></table></figure>

<p>所有节点更改内核启动顺序</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grub2-set-default 0 &amp;&amp; grub2-mkconfig -o /etc/grub2.cfg</span><br><span class="line">grubby --args=<span class="string">&quot;user_namespace.enable=1&quot;</span> --update-kernel=<span class="string">&quot;<span class="subst">$(grubby --default-kernel)</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>检查默认内核是不是 4.19</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master02 ~]<span class="comment"># grubby --default-kernele</span></span><br><span class="line">/boot/vmlinuz-4.19.12-1.el7.elrepo.x86_64</span><br></pre></td></tr></table></figure>

<p>所有节点重启，然后检查内核是不是 4.19</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master02 ~]<span class="comment"># reboot</span></span><br><span class="line">[root@k8s-master02 ~]<span class="comment"># uname -a</span></span><br><span class="line">Linux k8s-master02 4.19.12-1.el7.elrepo.x86_64 <span class="comment">#1 SMP Fri Dec 21 11:06:36 EST 2018 x86_64 x86_64 x86_64 GNU/Linux</span></span><br></pre></td></tr></table></figure>

<p>所有节点安装ipvsadm：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install ipvsadm ipset sysstat conntrack libseccomp -y</span><br></pre></td></tr></table></figure>

<p>所有节点配置ipvs模块，在内核 4.19+版本 nf_conntrack_ipv4 已经改为 nf_conntrack，4.18以下使用 nf_conntrack_ipv4 即可：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- nf_conntrack</span><br><span class="line">vim &gt;&gt;/etc/modules-load.d/ipvs.conf&lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment"># 加入以下内容</span></span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_lc</span><br><span class="line">ip_vs_wlc</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_lblc</span><br><span class="line">ip_vs_lblcr</span><br><span class="line">ip_vs_dh</span><br><span class="line">ip_vs_sh</span><br><span class="line">ip_vs_fo</span><br><span class="line">ip_vs_nq</span><br><span class="line">ip_vs_sed</span><br><span class="line">ip_vs_ftp</span><br><span class="line">ip_vs_sh</span><br><span class="line">nf_conntrack</span><br><span class="line">ip_tables</span><br><span class="line">ip_set</span><br><span class="line">xt_set</span><br><span class="line">ipt_set</span><br><span class="line">ipt_rpfilter</span><br><span class="line">ipt_REJECT</span><br><span class="line">ipip</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>然后执行，加载内核配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> --now systemd-modules-load.service</span><br></pre></td></tr></table></figure>

<p>检查是否加载：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master02 ~]<span class="comment"># lsmod | grep -e ip_vs -e nf_conntrack</span></span><br></pre></td></tr></table></figure>

<p>开启一些k8s集群中必须的内核参数，所有节点配置k8s内核</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">fs.may_detach_mounts = 1</span></span><br><span class="line"><span class="string">vm.overcommit_memory = 1</span></span><br><span class="line"><span class="string">vm.panic_on_oom = 0</span></span><br><span class="line"><span class="string">fs.inotify.max_user_watches = 89100</span></span><br><span class="line"><span class="string">fs.file-max = 52706963</span></span><br><span class="line"><span class="string">fs.nr_open = 52706963</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_max = 2310720</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_time = 600</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_probes = 3</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_intvl = 15</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_tw_buckets = 36000</span></span><br><span class="line"><span class="string">net.ipv4.tcp_tw_reuse = 1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_orphans = 327680</span></span><br><span class="line"><span class="string">net.ipv4.tcp_orphan_retries = 3</span></span><br><span class="line"><span class="string">net.ipv4.tcp_syncookies = 1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog = 16384</span></span><br><span class="line"><span class="string">net.ipv4.ip_conntrack_max = 65536</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog = 16384</span></span><br><span class="line"><span class="string">net.ipv4.tcp_timestamps = 0</span></span><br><span class="line"><span class="string">net.core.somaxconn = 16384</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure>

<p>所有节点配置完内核后，重启服务器，保证熏启后内核依旧加载</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br><span class="line">lsmod | grep --color=auto -e ip_vs -e nf_conntrack</span><br></pre></td></tr></table></figure>



<h1 id="基本组件安装"><a href="#基本组件安装" class="headerlink" title="基本组件安装"></a>基本组件安装</h1><p>本节主要安装的是集群中用到的各种组件，比如Docker-ce、Kubernetes各组件等。</p>
<h2 id="Docker安装"><a href="#Docker安装" class="headerlink" title="Docker安装"></a>Docker安装</h2><p>所有节点安装Docker-ce 19.03</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install docker-ce-19.03.* -y</span><br></pre></td></tr></table></figure>

<p>温馨提示：</p>
<p>由于新版 kubelet 建议使用 systemd，所以可以把 docker 的 CgroupDriver 改成 systemde</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /etc/dockere</span><br><span class="line"><span class="built_in">cat</span> &gt;/etc/docker/daemon.json&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;exec-opts&quot;:[&quot;native.cgroupdriver=systemd&quot;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>所有节点设置开机自启动Docker:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> --now docker</span><br></pre></td></tr></table></figure>



<h2 id="K8s-及-etcd-安装"><a href="#K8s-及-etcd-安装" class="headerlink" title="K8s 及 etcd 安装"></a>K8s 及 etcd 安装</h2><p>Master01 下载kubernetes 安装包</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># wget https://dl.k8s.io/v1.20.0/kubernetes-server-linux-amd64.tar.gz</span></span><br></pre></td></tr></table></figure>

<p>注意目前版本是1.20.0学员安装时需要下载最新的1.20.x版本：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md</a></p>
<p>打开页面后点击：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md#v1200">v1.20.0</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md#downloads-for-v1200">Downloads for v1.20.0</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md#server-binaries-15">Server Binaries</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>以下操作都在 master01 执行</p>
<p>下载 etcd 安装包</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># wget https://github.com/etcd-io/etcd/releases/download/v3.4.13/etcd-v3.4.13-linux-amd64.tar.gz</span></span><br></pre></td></tr></table></figure>

<p>解压 kubernetes 安装文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># tar -xf kubernetes-server-linux-amd64.tar.gz --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125;</span></span><br></pre></td></tr></table></figure>

<p>解压 etcd 安装文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># tar -zxvf etcd-v3.4.13-linux-amd64.tar.gz --strip-components=1 -C /usr/local/bin etcd-v3.4.13-linux-amd64/etcd&#123;,ctl&#125;</span></span><br></pre></td></tr></table></figure>

<p>版本查看</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~&#125;<span class="comment"># kubelet --version</span></span><br><span class="line">Kubernetes v1.20.0</span><br><span class="line">[root@k8s-master01 ~&#125;<span class="comment"># etcdctl version</span></span><br><span class="line">etcdctl version: 3.4.13</span><br><span class="line">API version: 3.4</span><br></pre></td></tr></table></figure>

<p>将组件发送到其他节点</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MasterNodes=<span class="string">&#x27;k8s-master02 k8s-master03&#x27;</span></span><br><span class="line">WorkNodes=<span class="string">&#x27;k8s-node01 k8s-node02&#x27;</span></span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$MasterNodes</span>; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$NODE</span>; scp /usr/local/bin/kube&#123;<span class="built_in">let</span>,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125; <span class="variable">$NODE</span>:/usr/local/bin/; scp /usr/local/bin/etcd* <span class="variable">$NODE</span>:/usr/local/bin/; <span class="keyword">done</span></span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> <span class="variable">$WorkNodes</span>; <span class="keyword">do</span> scp /usr/local/bin/kube&#123;<span class="built_in">let</span>,-proxy&#125; <span class="variable">$NODE</span>:/usr/local/bin/; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>k8s github : <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/">https://github.com/kubernetes/kubernetes/</a></p>
<p>所有节点创建&#x2F;opt&#x2F;cni&#x2F;bin目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /opt/cni/bin</span><br></pre></td></tr></table></figure>

<p>切换分支</p>
<p>切换到 1.20.x 分支（其他版本可以切换到其他分支）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> k8s-ha-install &amp;&amp; git checkout manual-installation-v1.20.x</span><br></pre></td></tr></table></figure>





<h1 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h1><p>二进制安装最关键步骤，一步错误全盘皆输，一定要注意每个步骤都要是正确的</p>
<p>Master01 下载生成证书工具</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget <span class="string">&quot;https://pkg.cfssl.org/R1.2/cfssl_linux-amd64&quot;</span> -O /usr/local/bin/cfssl</span><br><span class="line">wget <span class="string">&quot;https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64&quot;</span> -O /usr/local/bin/cfssljson</span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/cfssl /usr/local/bin/cfssljson</span><br></pre></td></tr></table></figure>

<p>所有Master节点创建etcd 证书目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /etc/etcd/ssl -p</span><br></pre></td></tr></table></figure>

<p>所有节点创建kubernetes相关目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /etc/kubernetes/pki</span><br></pre></td></tr></table></figure>

<p>Master01 节点生成 eted 证书</p>
<p>生成证书的 CSR 文件：证书签名请求文件，配置了一些域名、公司、单位</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 pki]<span class="comment"># cd /root/k8s-ha-install/pki</span></span><br><span class="line"><span class="comment"># 生成 etcd CA 证书和 CA 证书的 key</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># cfssl gencert -initca etcd-ca-csr.json | cfsslison -bare /etc/etcd/ssl/etcd-ca</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># cfssl gencert\</span></span><br><span class="line">-ca=/etc/etcd/ssl/etcd-ca.pem \</span><br><span class="line">-ca-key=/etc/etcd/ssl/etcd-ca-key.pem \</span><br><span class="line">-config=ca-config.json \</span><br><span class="line">-hostname=127.0.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.0.201,192.168.0.202,192.168.0.203 \</span><br><span class="line">-profile=kubernetes \</span><br><span class="line">etcd-csr.json | cfssljson -bare /etc/etcd/ssl/etcd</span><br><span class="line"></span><br><span class="line">2019/12/26 22:48:00 [INFO] generate received request</span><br><span class="line">2019/12/26 22:48:00 [INFO] received CSR</span><br><span class="line">2019/12/26 22:48:00 [INFO]generating key: rsa-2048]</span><br><span class="line">2019/12/26 22:48:01 [INFO] encoded CSR</span><br><span class="line">2019/12/26 22:48:01 [INFO] signed certificate with serial number</span><br><span class="line">250230878926052708909595617022917808304837732033-</span><br></pre></td></tr></table></figure>

<p>将证书复制到其他节点</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 pki]<span class="comment"># MasterNodes=&#x27;k8s-master02 k8s-master03&#x27;</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># WorkNodes=&#x27;k8s-node01 k8s-node02&#x27;</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># for NODE in $MasterNodes; do </span></span><br><span class="line">ssh <span class="variable">$NODE</span> <span class="string">&quot;mkdir -p /etc/etcd/ssl&quot;</span> </span><br><span class="line"><span class="keyword">for</span> FILE <span class="keyword">in</span> etcd-ca-key.pem etcd-ca.pem etcd-key.pem etcd.pem; <span class="keyword">do</span> </span><br><span class="line">scp /etc/etcd/ssl/$[FILE&#125; <span class="variable">$NODE</span>:/etc/etcd/ssl/$[FILE&#125; </span><br><span class="line"><span class="keyword">done</span> </span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>Master01 生成 kubernetes 证书</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 pki]<span class="comment"># cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 10.96.0.是k8s service 的网段，如果说需要更改 k8s service 网段，那就需要更改 10.96.0.1</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># cfssl gencert -ca=/etc/kubernetes/pki/ca.pem \</span></span><br><span class="line">-ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">-config=ca-config.json \</span><br><span class="line">-hostname=10.96.0.1,192.168.0.211,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,192.168.0.201,192.168.0.202,192.168.0.203 \</span><br><span class="line">-profile=kubernetes \</span><br><span class="line">apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiservere</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># cfssl gencert -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成 apiserver 的聚合证书,Requestheader-client-xxx requestheader-allowwd-xxx:aggerator</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># cfssl gencert \</span></span><br><span class="line">-ca=/etc/kubernetes/pki/front-proxy-ca.pem \</span><br><span class="line">-ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem \</span><br><span class="line">-config=ca-config.json \</span><br><span class="line">-profile=kubernetes \</span><br><span class="line">front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成 controller-manager 的证书</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># cfssl gencert \</span></span><br><span class="line">-ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">-ca-key=/etc/kubernetes/pki/ca-key pem \</span><br><span class="line">-config=ca-config.json \</span><br><span class="line">-profile=kubernetes \</span><br><span class="line">manager-csr.json | cfssljson -bare /etc/kubernetes/pki/controller-manager</span><br><span class="line"></span><br><span class="line"><span class="comment"># set-cluster: 设置一个集群项</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">--certificate-authority=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">--embed-certs=<span class="literal">true</span> \</span><br><span class="line">--server=https://192.168.0.211:8443 \</span><br><span class="line">--kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># set-credentials 设置一个用户项</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># kubectl config set-credentials system:kube-controller-manager \</span></span><br><span class="line">--client-certificate=/etc/kubernetes/pki/controller-manager.pem \</span><br><span class="line">--client-key=/etc/kubernetes/pki/controller-manager-key.pem \</span><br><span class="line">--embed-certs=<span class="literal">true</span> \</span><br><span class="line">--kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line">User <span class="string">&quot;system:kube-controller-manager&quot;</span> <span class="built_in">set</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置一个环境项，一个上下文</span></span><br><span class="line">kubectl config set-context system:kube-controller-manager@kubernetes \</span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=system:kube-controller-manager \</span><br><span class="line">--kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用某个环境当做默认环境</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment">#</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># kubecti config use-context system:kube-controller-manager@kubernetes \</span></span><br><span class="line">--kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line">Switched to context <span class="string">&quot;system:kube-controller-manager@kubernetes&quot;</span>.</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># cfssl gencert \</span></span><br><span class="line">-ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">-ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">-config=ca-config.json \</span><br><span class="line">-profile=kubernetes \</span><br><span class="line">scheduler-csr.json | cfssljson -bare /etc/kubernetes/pki/scheduler</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># kubectl config set-cluster kubernetes \</span></span><br><span class="line">--certificate-authority=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">--embed-certs=<span class="literal">true</span> \</span><br><span class="line">--server=https://192.168.0.211:8443 \</span><br><span class="line">--kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">Cluster <span class="string">&quot;kubernetes&quot;</span> <span class="built_in">set</span>.</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># kubectl config set-credentials system:kube-scheduler \</span></span><br><span class="line">--client-certificate=/etc/kubernetes/pki/scheduler.pem \</span><br><span class="line">--client-key=/etc/kubernetes/pki/scheduler-key.pem \</span><br><span class="line">--embed-certs=<span class="literal">true</span> \</span><br><span class="line">--kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">User <span class="string">&quot;system:kube-scheduler&quot;</span> <span class="built_in">set</span>.</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># kubectl config set-context system:kube-scheduler@kubernetes \</span></span><br><span class="line">--cluster=kubernetes \</span><br><span class="line">--user=system:kube-scheduler \</span><br><span class="line">--kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">Context <span class="string">&quot;system:kube-scheduler@kubernetes&quot;</span> created.</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># kubectl config use-context system:kube-scheduler@kubernetes \</span></span><br><span class="line">--kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">Switched to context <span class="string">&quot;system:kube-scheduler@kubernetes&quot;</span>.</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># cfssl gencert \</span></span><br><span class="line">-ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">-ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">-config=ca-config.json \</span><br><span class="line">-profile=kubernetes \</span><br><span class="line">admin-csr.json | cfsslison -bare /etc/kubernetes/pki/admin</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># kubectl config set-cluster kubernetes --certificate-authority=/etc/kubernetes/pki/ca.pem --embed-certs=true --server=https://192.168.0.211:8443 --kubeconfig=/etc/kubernetes/admin.kubeconfig</span></span><br><span class="line"></span><br><span class="line">Cluster <span class="string">&quot;kubernetes&quot;</span> <span class="built_in">set</span>.</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># kubectl config set-credentials kubernetes-admin --client-certificate=/etc/kubernetes/pki/admin.pem --client-key=/etc/kubernetes/pki/admin-key.pem --embed-certs=true --kubeconfig=/etc/kubernetes/admin.kubeconfig</span></span><br><span class="line"></span><br><span class="line">User <span class="string">&quot;kubernetes -admin&quot;</span> <span class="built_in">set</span>.</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># kubectl config set-context kubernetes-admin@kubernetes --cluster=kubernetes --user=kubernetes-admin --kubeconfig=/etc/kubernetes/admin.kubeconfig</span></span><br><span class="line"></span><br><span class="line">Context <span class="string">&quot;kubernetes-admin@kubernetes&quot;</span> created.</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># kubectl config use-context kubernetes-admin@kubernetes --kubeconfig=/etc/kubernetes/admin.kubeconfig</span></span><br><span class="line"></span><br><span class="line">Context <span class="string">&quot;kubernetes-admin@kubernetes&quot;</span> created.</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># kubectl config use-context kubernetes-admin@kubernetes --kubeconfig=/etc/kubernetes/admin.kubeconfig</span></span><br><span class="line"></span><br><span class="line">Switched to context <span class="string">&quot;kubernetes-admin@kubernetes&quot;</span>.</span><br></pre></td></tr></table></figure>

<p>创建 ServiceAccount Keye</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 pki]<span class="comment"># openssl genrsa -out /etc/kubernetes/pki/sa.key 2048</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment">#</span></span><br><span class="line"><span class="keyword">for</span> NODE <span class="keyword">in</span> k8s-master02 k8s-master03; <span class="keyword">do</span></span><br><span class="line"><span class="keyword">for</span> FILE <span class="keyword">in</span> $(<span class="built_in">ls</span> /etc/kubernetes/pki | grep -v etcd); <span class="keyword">do</span></span><br><span class="line">scp /etc/kubernetes/pki/<span class="variable">$&#123;FILE&#125;</span> <span class="variable">$NODE</span>:/etc/kubernetes/pki/<span class="variable">$&#123;FILE&#125;</span>;</span><br><span class="line"><span class="keyword">done</span>;</span><br><span class="line"><span class="keyword">for</span> FILE <span class="keyword">in</span> admin.kubeconfig controller-manager.kubeconfig</span><br><span class="line">scheduler.kubeconfig; <span class="keyword">do</span></span><br><span class="line">scp /etc/kubernetes/<span class="variable">$&#123;FILE&#125;</span> <span class="variable">$NODE</span>:/etc/kubernetes/<span class="variable">$&#123;FILE&#125;</span>;</span><br><span class="line"><span class="keyword">done</span>;</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>查看证书文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 pki]<span class="comment"># ls /etc/kubernetes/pki/</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># ls /etc/kubernetes/pki/ |wc -l</span></span><br><span class="line">23</span><br></pre></td></tr></table></figure>





<h1 id="Kubernetes系统组件配置"><a href="#Kubernetes系统组件配置" class="headerlink" title="Kubernetes系统组件配置"></a>Kubernetes系统组件配置</h1><h2 id="etcd-配置"><a href="#etcd-配置" class="headerlink" title="etcd 配置"></a>etcd 配置</h2><p>etcd 配置大致相同，注意修改每个 Master 节点的 etcd 配置的主机名和 IP 地址</p>
<h3 id="Master01"><a href="#Master01" class="headerlink" title="Master01"></a>Master01</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;&gt;/etc/etcd/etcd.config.yml&lt;&lt;&#x27;EOF&#x27;</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">&#x27;k8s-master01&#x27;</span></span><br><span class="line"><span class="attr">data-dir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">wal-dir:</span> <span class="string">/var/lib/etcd/wal</span></span><br><span class="line"><span class="attr">snapshot-count:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">heartbeat-interval:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">election-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">quota-backend-bytes:</span> <span class="number">04</span></span><br><span class="line"><span class="attr">listen-peer-urls:</span> <span class="string">&#x27;https://192.168.0.107:2380&#x27;</span></span><br><span class="line"><span class="attr">listen-client-urls:</span> <span class="string">&#x27;https://192.168.0.107:2379,http://127.0.0.1:2379&#x27;</span></span><br><span class="line"><span class="attr">max-snapshots:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">max-wals:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">cors:</span></span><br><span class="line"><span class="attr">initial-advertise-peer-urlg:</span> <span class="string">&#x27;https://192.168.0.107:2380&#x27;</span></span><br><span class="line"><span class="attr">advertise-client-urls:</span> <span class="string">&#x27;https://192.168.0.107:2379&#x27;</span></span><br><span class="line"><span class="attr">discovery:</span></span><br><span class="line"><span class="attr">discovery-fallback:</span> <span class="string">&#x27;proxy&#x27;</span></span><br><span class="line"><span class="attr">discovery-proxy:</span></span><br><span class="line"><span class="attr">discovery-srv:</span></span><br><span class="line"><span class="attr">initial-cluster:</span> <span class="string">&#x27;k8s-masten01=https://192.168.0.107:2380,k8s-master02=https://192.168.0.108:2380,k8s-master03=https://192.168.0.109:2380&#x27;</span></span><br><span class="line"><span class="attr">initial-cluster-token:</span> <span class="string">&#x27;etcd-k8s-cluster&#x27;</span></span><br><span class="line"><span class="attr">initial-cluster-state:</span> <span class="string">&#x27;new&#x27;</span></span><br><span class="line"><span class="attr">strict-reconfig-check:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">enable-v2:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">enable-pprof:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">proxy:</span> <span class="string">&#x27;off&#x27;</span></span><br><span class="line"><span class="attr">proxy-failure-wait:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">proxy-refresh-interval:</span> <span class="number">30000</span></span><br><span class="line"><span class="attr">proxy-dial-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">proxy-write-timeout:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">proxy-read-timeout:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">client-transport-security:</span></span><br><span class="line">  <span class="attr">cert-file:</span> <span class="string">&#x27;/etc/kukernetes/pki/etcd/etcd.pem&#x27;</span></span><br><span class="line">  <span class="attr">key-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span></span><br><span class="line">  <span class="attr">client-cert-auth:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">trusted-ca-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span></span><br><span class="line">  <span class="attr">auto-tls:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">peer-transport-security:</span></span><br><span class="line">  <span class="attr">cert-file:</span> <span class="string">&#x27;/etc/kukents/pki/td/etcd.pem&#x27;</span></span><br><span class="line">  <span class="attr">key-file:</span> <span class="string">&#x27;/etc/kuberneteg/pki/etcd/etcd-key.pem&#x27;</span></span><br><span class="line">  <span class="attr">peer-client-cert-auth:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">trusted-ca-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span></span><br><span class="line">  <span class="attr">auto-tlg:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">debug:</span> <span class="string">falsee</span></span><br><span class="line"><span class="attr">log-package-levels:</span></span><br><span class="line"><span class="attr">log-outputs:</span> [<span class="string">default</span>]</span><br><span class="line"><span class="attr">force-new-cluster:</span> <span class="literal">false</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h3 id="Master02"><a href="#Master02" class="headerlink" title="Master02"></a>Master02</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;&gt;/etc/etcd/etcd.config.yml&lt;&lt;&#x27;EOF&#x27;</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">&#x27;k8s-master02&#x27;</span></span><br><span class="line"><span class="attr">data-dir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">wal-dir:</span> <span class="string">/var/lib/etcd/wal</span></span><br><span class="line"><span class="attr">snapshot-count:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">heartbeat-interval:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">election-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">quota-backend-bytes:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">listen-peer-urls:</span> <span class="string">&#x27;https://192.168.0.108:2380&#x27;</span></span><br><span class="line"><span class="attr">listen-client-urls:</span> <span class="string">&#x27;https://192.168.0.108:2379,http://127.0.0.1:2379&#x27;</span></span><br><span class="line"><span class="attr">max-snapshots:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">max-wals:</span> <span class="number">54</span></span><br><span class="line"><span class="attr">cors:</span></span><br><span class="line"><span class="attr">initial-advertise-peer-urls:</span> <span class="string">&#x27;https://192.168.0.108:2380&#x27;</span></span><br><span class="line"><span class="attr">discovery:</span></span><br><span class="line"><span class="attr">discovery-fallback:</span> <span class="string">&#x27;proxy&#x27;</span></span><br><span class="line"><span class="attr">discovery-proxy:</span></span><br><span class="line"><span class="attr">discovery-srv:</span></span><br><span class="line"><span class="attr">initial-cluster:</span> <span class="string">&#x27;k8s-master01=https://192.168.0.107:2380,k8s-master02=https://192.168.0.108:2380,k8s-master03=https://192.168.0.109:2380&#x27;</span></span><br><span class="line"><span class="attr">initial-cluster-token:</span> <span class="string">&#x27;etcd-k8s-cluster&#x27;</span></span><br><span class="line"><span class="attr">initial-cluster-state:</span> <span class="string">&#x27;new&#x27;</span></span><br><span class="line"><span class="attr">strict-reconfig-check:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">enable-v2:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">enable-pprof:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">proxy:</span> <span class="string">&#x27;off&#x27;</span></span><br><span class="line"><span class="attr">proxy-failure-wait:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">proxy-refresh-interval:</span> <span class="number">30000</span></span><br><span class="line"><span class="attr">proxy-dial-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">proxy-write-timeout:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">proxy-read-timeout:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">client-transport-security:</span></span><br><span class="line">  <span class="attr">cert-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span></span><br><span class="line">  <span class="attr">key-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span></span><br><span class="line">  <span class="attr">client-cert-auth:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">trusted-ca-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span></span><br><span class="line">  <span class="attr">auto-tls:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">peer-transport-security:</span></span><br><span class="line">  <span class="attr">cert-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etsd/etcd.pem&#x27;</span></span><br><span class="line">  <span class="attr">key-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span></span><br><span class="line">  <span class="attr">peer-client-cert-auth:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">trusted-ca-file:</span> <span class="string">&#x27;/etc/kubernet/pki/etcd/etcd-ca.pem&#x27;</span></span><br><span class="line">  <span class="attr">auto-tls:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">debug:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">1og-package-levels:</span></span><br><span class="line"><span class="attr">log-outputs:</span> [<span class="string">default</span>]</span><br><span class="line"><span class="attr">force-new-cluster:</span> <span class="literal">false</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h3 id="Master03"><a href="#Master03" class="headerlink" title="Master03"></a>Master03</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;&gt;/etc/etcd/etcd.config.yml&lt;&lt;&#x27;EOF&#x27;</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">&#x27;k8s-master03&#x27;</span></span><br><span class="line"><span class="attr">data-dir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">wal-rdir:</span> <span class="string">/var/lib/etcd/wal</span></span><br><span class="line"><span class="attr">snapshot-count:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">heartbeat-interval:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">election-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">quota-backend-bytes:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">listen-peer-urls:</span> <span class="string">&#x27;https://192.168.0.109:2380&#x27;</span></span><br><span class="line"><span class="attr">listen-client-urls:</span> <span class="string">&#x27;https://192.168.0.109:2379,http://127.0.0.1:2379&#x27;</span></span><br><span class="line"><span class="attr">max-snapshots:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">max-wals:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">cora:</span></span><br><span class="line"><span class="attr">initial-advertise-peer-urls:</span> <span class="string">&#x27;https://192.168.0.109:2380&#x27;</span></span><br><span class="line"><span class="attr">advertise-client-urls:</span> <span class="string">&#x27;https://192.168.0.109:2379&#x27;</span></span><br><span class="line"><span class="attr">discovery:</span></span><br><span class="line"><span class="attr">discovery-fallback:</span> <span class="string">&#x27;proxy&#x27;</span></span><br><span class="line"><span class="attr">discovery-proxy:</span></span><br><span class="line"><span class="attr">discovery-srv:</span></span><br><span class="line"><span class="attr">initial-cluster:</span> <span class="string">&#x27;k8s-master01=https://192.168.0.107:2380,k8s-master02=https://192.168.0.108:2380,k8s-master03=https://192.168.0.109:2380&#x27;</span></span><br><span class="line"><span class="attr">initial-cluster-token:</span> <span class="string">&#x27;etcd-k8s-cluster&#x27;</span></span><br><span class="line"><span class="attr">initial-cluster-state:</span> <span class="string">&#x27;new&#x27;</span></span><br><span class="line"><span class="attr">strict-reconfig-check:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">enable-v2:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">enable-pprof:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">proxy:</span> <span class="string">&#x27;off&#x27;</span></span><br><span class="line"><span class="attr">proxy-failure-wait:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">proxy-refresh-interval:</span> <span class="number">30000</span></span><br><span class="line"><span class="attr">proxy-dial-timeout:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">proxy-write-timeout:</span> <span class="number">5000</span></span><br><span class="line"><span class="attr">proxy-read-timeout:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">client-transport-security:</span></span><br><span class="line">  <span class="attr">cert-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span></span><br><span class="line">  <span class="attr">key-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etsd/etcd-key.pem&#x27;</span></span><br><span class="line">  <span class="attr">client-cert-auth:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">trusted-ca-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span></span><br><span class="line">  <span class="attr">auto-tls:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">peer-transport-security:</span></span><br><span class="line">  <span class="attr">cert-file:</span> <span class="string">&#x27;/etc/kubernetea/pki/etcd/etcd.pem&#x27;</span></span><br><span class="line">  <span class="attr">key-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span></span><br><span class="line">  <span class="attr">peer-client-cert-auth:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">trusted-ca-file:</span> <span class="string">&#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span></span><br><span class="line">  <span class="attr">auto-tls:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">debug:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">log-package-levels:</span></span><br><span class="line"><span class="attr">log-outputs:</span> [<span class="string">default</span>]</span><br><span class="line"><span class="attr">force-new-cluster:</span> <span class="literal">false</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h3 id="创建Service"><a href="#创建Service" class="headerlink" title="创建Service"></a>创建Service</h3><p>所有 Master 节点创建 etcd service 并启动</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /usr/lib/systemd/system/etcd.servicee</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Service</span><br><span class="line">Documentation=https://coreos.com/etcd/docs/latest/</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yml</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">Alias=etcd3.service</span><br></pre></td></tr></table></figure>

<p>所有Master节点创建etcd的证书目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /etc/kubernetes/pki/etcd</span><br><span class="line"><span class="built_in">ln</span> -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> --now etcd</span><br></pre></td></tr></table></figure>

<p>查看etcd状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ETCDCTL_API=3</span><br><span class="line">etcdctl --endpoints=<span class="string">&quot;192.168.0.109:2379,192.168.0.108:2379,192 --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem endpoint status --write-out=table</span></span><br></pre></td></tr></table></figure>



<h1 id="高可用配置"><a href="#高可用配置" class="headerlink" title="高可用配置"></a>高可用配置</h1><p>高可用配置（注意；如果不是高可用集群，haproxy 和 keepalived 无需安装）</p>
<p>如果在云上安装也无需执行此章节的步骤，可以直接使用云上的Ib，比如阿里云slb，腾讯云elb等</p>
<p>所有 Master 节点安装 keepalived 和 haproxy</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install keepalived haproxy -y</span><br></pre></td></tr></table></figure>

<p>所有 Master 配置 HAProxy，配置一样</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;/etc/haproxy/haproxy.cfg&lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">global</span><br><span class="line">  maxconn  2000</span><br><span class="line">  ulimit-n  163844</span><br><span class="line">  <span class="built_in">log</span>  127.0.0.1 local0 err</span><br><span class="line">  stats <span class="built_in">timeout</span> 30s</span><br><span class="line"></span><br><span class="line">defaultse</span><br><span class="line">  <span class="built_in">log</span> global</span><br><span class="line">  mode  http</span><br><span class="line">  optio  httplog</span><br><span class="line">  <span class="built_in">timeout</span> connect 5000</span><br><span class="line">  <span class="built_in">timeout</span> client  50000</span><br><span class="line">  <span class="built_in">timeout</span> server  50000</span><br><span class="line">  <span class="built_in">timeout</span> http-request 15s</span><br><span class="line">  <span class="built_in">timeout</span> http-keep-alive 15s</span><br><span class="line"></span><br><span class="line">frontend k8s-mastere</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:8443</span><br><span class="line">  <span class="built_in">bind</span> 127.0.0.1:8443</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  tcp-request inspect-delay 5s</span><br><span class="line">  default_backend k8s-master</span><br><span class="line">  </span><br><span class="line">backend k8s-master</span><br><span class="line">  mode tcp</span><br><span class="line">  option tcplog</span><br><span class="line">  option tcp-check</span><br><span class="line">  balance roundrobin</span><br><span class="line">  default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100</span><br><span class="line">  server k8s-master01  192.168.0.107:6443  check</span><br><span class="line">  server k8s-master02  192.168.0.108:6443  check</span><br><span class="line">  server k8s-master03  192.168.0.109:6443  check</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h2 id="Master01-keepalived"><a href="#Master01-keepalived" class="headerlink" title="Master01 keepalived"></a>Master01 keepalived</h2><p>所有Master节点配置KeepAlived,配置不一样，注意区分，注意每个节点的 IP 和网卡（interface参数）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;/etc/keepalived/keepalived.conf&lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">    script <span class="string">&quot;/etc/keepalived/check_apiserver.sh&quot;</span></span><br><span class="line">    interval 5</span><br><span class="line">    weight -5</span><br><span class="line">    fall 2</span><br><span class="line">    rise 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    mcast_src_ip 192.168.0.107</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 101</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.0.236</span><br><span class="line">    &#125;</span><br><span class="line">    track_script&#123;</span><br><span class="line">        chk_apiserver</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h2 id="Master02-keepalived"><a href="#Master02-keepalived" class="headerlink" title="Master02 keepalived"></a>Master02 keepalived</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;/etc/keepalived/keepalived.conf&lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">    script <span class="string">&quot;/etc/keepalived/check_apiserver.sh&quot;</span></span><br><span class="line">    interval 5</span><br><span class="line">    weight -5</span><br><span class="line">    fall 2</span><br><span class="line">    rise 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens33</span><br><span class="line">    mcast_src_ip 192.168.0.108</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.0.236</span><br><span class="line">    &#125;</span><br><span class="line">    track_script&#123;</span><br><span class="line">        chk_apiserver</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h2 id="Master03-keepalived"><a href="#Master03-keepalived" class="headerlink" title="Master03 keepalived"></a>Master03 keepalived</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;/etc/keepalived/keepalived.conf&lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">    script <span class="string">&quot;/etc/keepalived/check_apiserver.sh&quot;</span></span><br><span class="line">    interval 5</span><br><span class="line">    weight -5</span><br><span class="line">    fall 2</span><br><span class="line">    rise 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens33</span><br><span class="line">    mcast_src_ip 192.168.0.109</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.0.236</span><br><span class="line">    &#125;</span><br><span class="line">    track_script&#123;</span><br><span class="line">        chk_apiserver</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h2 id="健康检查配置"><a href="#健康检查配置" class="headerlink" title="健康检查配置"></a>健康检查配置</h2><p>所有 master 节点</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;/etc/keepalived/check_apiserver.sh&lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">err=0</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> $(<span class="built_in">seq</span> 1 3)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    check_code=$(pgrep haproxy)</span><br><span class="line">    <span class="keyword">if</span> [[ <span class="variable">$check_code</span> == <span class="string">&quot;&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        err=$(<span class="built_in">expr</span> <span class="variable">$err</span> + 1)</span><br><span class="line">        <span class="built_in">sleep</span> 1</span><br><span class="line">        <span class="built_in">continue</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        err=0</span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$err</span> != <span class="string">&quot;0&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;systemctl stop keepalived&quot;</span></span><br><span class="line">    /usr/bin/systemctl stop keepalived</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>增加执行权限</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x /etc/keepalived/check_apiserver.sh</span><br></pre></td></tr></table></figure>

<p>所有 master 节点启动 haproxy 和 keepalived</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 keepalived]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@k8s-master01 keepalived]<span class="comment"># systemctl enable --now haproxy</span></span><br><span class="line">[root@k8s-master01 keepalived]<span class="comment"># systemctl enable --now keepalived</span></span><br></pre></td></tr></table></figure>

<p>VIP测试</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 pki]<span class="comment"># ping 192.168.0.236</span></span><br><span class="line">PING 192.168.0.236 (192.168.0.236) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.0.236: icmp seg=1 ttl=64 time=1.39 mse</span><br><span class="line">64 bytes from 192.168.0.236: icmp seg=2 ttl=64 time=2.46 ms</span><br><span class="line">64 bytes from 192.168.0.236: icmp seg=3 ttl=64 time=1.68 ms</span><br><span class="line">64 bytes from 192.168.0.236: icmp seg=4 ttl=64 time=1.08 ms</span><br></pre></td></tr></table></figure>

<p>重要：如果安装了 keepalived 和 haproxy ,需要测试 keepalived 是否是正常的</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet 192.168.0.236 8443</span><br></pre></td></tr></table></figure>

<p>如果 ping 不通且telnet没有出现 <code>]</code>，则认为VIP不可以，不可在继续往下执行，需要排查keepalived 的问题，比如防火墙和selinux, haproxy 和keepalived 的状态，监听端口等</p>
<p>所有节点查看防火墙状态必须为disable和inactive: systemctl status firewallde</p>
<p>所有节点查看selinux状态，必须为disable：getenforce</p>
<p>master节点查看 haproxy 和keepalived 状态：svstemetl status keepalived haproxye</p>
<p>master节点查看监听端口：netstat -Intp</p>
<h1 id="Kubernetes组件配置"><a href="#Kubernetes组件配置" class="headerlink" title="Kubernetes组件配置"></a>Kubernetes组件配置</h1><p>所有节点创建相关目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /etc/kubernetes/manifests/ /etc/systemd/system/kubelet.service.d /var/lib/kubelet /var/log/kubernetes</span><br></pre></td></tr></table></figure>



<h2 id="Apiserver"><a href="#Apiserver" class="headerlink" title="Apiserver"></a>Apiserver</h2><p>所有Master节点创建kube-apiserver service,# 注意，如果不是高可用集群，192.168.0.236 改为 master01 的地址</p>
<h3 id="Master01配置"><a href="#Master01配置" class="headerlink" title="Master01配置"></a>Master01配置</h3><p>注意本文档使用的 k8s service 网段为192.168.0.0&#x2F;16，该网段不能和宿主机的网段、Pod网段的<br>重复，请按需修改</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 pki]<span class="comment"># cat /usr/lib/systemd/system/kube-apiserver.service</span></span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \</span><br><span class="line">    --v=2 \</span><br><span class="line">    --logtostderr=<span class="literal">true</span> \</span><br><span class="line">    --allow-privileged=<span class="literal">true</span> \</span><br><span class="line">    --bind-address=0.0.0.0 \</span><br><span class="line">    --secure-port=6443 \</span><br><span class="line">    --insecure-port=0 \</span><br><span class="line">    --advertise-address=192.168.0.107 \</span><br><span class="line">    --service-cluster-jp-range=10.96.0.0/12 \</span><br><span class="line">    --service-node-port-range=30000-32767 \</span><br><span class="line">    --etcd-servers=https://192.168.0.107:2379,https://192.168.0.108:2379,https://192.168.0.109:2379 \</span><br><span class="line">    --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \</span><br><span class="line">    --etcd-certfile=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">    --etcd-kevfile=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">    --client-ca-file=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">    --tls-cert-file=/etc/kubernetes/pki/apiserver.pem \</span><br><span class="line">    --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem \</span><br><span class="line">    --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem \</span><br><span class="line">    --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem \</span><br><span class="line">    --service-account-key-file=/etc/kubernetes/pki/sa.pub \</span><br><span class="line">    --service-account-signing-key-file=/etc/kubernetes/pki/sa.key \</span><br><span class="line">    --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">    --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \</span><br><span class="line">    --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota \</span><br><span class="line">    --authorization-mode=Node,RBAC \</span><br><span class="line">    --enable-bootstrap-token-auth=<span class="literal">true</span> \</span><br><span class="line">    --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \</span><br><span class="line">    --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem \</span><br><span class="line">    --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem \</span><br><span class="line">    --requestheader-allowed-names=aggregator \</span><br><span class="line">    --reguestheader-group-headers=X-Remote-Group \</span><br><span class="line">    --requestheader-extra-headers-prefix=X-Remote-Extra- \</span><br><span class="line">    --requestheader-username-headers=X-Remote-User</span><br><span class="line">    <span class="comment"># --token-auth-file=/etc/kubernetes/token.csv</span></span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>



<h3 id="Master02-配置"><a href="#Master02-配置" class="headerlink" title="Master02 配置"></a>Master02 配置</h3><p>注意本文档使用的 k8s service 网段为 10.96.0.0&#x2F;12，该网段不能和宿主机的网段、Pod网段的重复，请按需修改</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 pki]<span class="comment"># cat /usr/lib/systemd/system/kube-apiserver.service</span></span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Descriptipn=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \</span><br><span class="line">  --v=2 \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --allow-privileged=<span class="literal">true</span> \</span><br><span class="line">  --bind-address=0.0.0.0 \</span><br><span class="line">  --secure-port=6443 \</span><br><span class="line">  --insecure-port=0 \</span><br><span class="line">  --advertise-address=192.168.0.108 \</span><br><span class="line">  --service-cluster-ip-range=10.96.0.0/12 \</span><br><span class="line">  --service-node-port-range=30000-32767 \</span><br><span class="line">  --etcd-servers=https://192.168.0.107:2379,https://192.168.0.108:2379,https://192.168.0.109:2379 \</span><br><span class="line">  --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem</span><br><span class="line">  --etcd-certfile=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --etcd-kevfile=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/pki/apiserver.pem \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem \</span><br><span class="line">  --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem \</span><br><span class="line">  --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem \</span><br><span class="line">  --service-account-key-file=/etc/kubernetes/pki/sa.pub \</span><br><span class="line">  --service-account-signing-key-file=/etc/kubernetes/pki/sa.key \</span><br><span class="line">  --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">  --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \</span><br><span class="line">  --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota \</span><br><span class="line">  --authorization-mode=Node,RBAC \</span><br><span class="line">  --enable-bootstrap-token-auth=<span class="literal">true</span> \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \</span><br><span class="line">  --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem \</span><br><span class="line">  --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem \</span><br><span class="line">  --requestheader-allowed-names=aggregator \</span><br><span class="line">  --reguestheader-group-headers=X-Remote-Group \</span><br><span class="line">  --requestheader-extra-headers-prefix=X-Remote-Extra- \</span><br><span class="line">  --requestheader-username-headers=X-Remote-User</span><br><span class="line">  <span class="comment"># --token-auth-file=/etc/kubernetes/token.csv</span></span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>



<h3 id="Master03-配置"><a href="#Master03-配置" class="headerlink" title="Master03 配置"></a>Master03 配置</h3><p>注意本文档使用的k8s service网段为10.96.0.0&#x2F;12，该网段不能和宿主机的网段、Pod网段的重复，请按需修改</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 pki]<span class="comment"># cat /usr/lib/systemd/system/kube-apiserver.service</span></span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Descriptipn=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \</span><br><span class="line">  --v=2 \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --allow-privileged=<span class="literal">true</span> \</span><br><span class="line">  --bind-address=0.0.0.0 \</span><br><span class="line">  --secure-port=6443 \</span><br><span class="line">  --insecure-port=0 \</span><br><span class="line">  --advertise-address=192.168.0.109 \</span><br><span class="line">  --service-cluster-ip-range=10.96.0.0/12 \</span><br><span class="line">  --service-node-port-range=30000-32767 \</span><br><span class="line">  --etcd-servers=https://192.168.0.107:2379,https://192.168.0.108:2379,https://192.168.0.109:2379 \</span><br><span class="line">  --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem</span><br><span class="line">  --etcd-certfile=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --etcd-kevfile=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --client-ca-file=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/pki/apiserver.pem \</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem \</span><br><span class="line">  --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem \</span><br><span class="line">  --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem \</span><br><span class="line">  --service-account-key-file=/etc/kubernetes/pki/sa.pub \</span><br><span class="line">  --service-account-signing-key-file=/etc/kubernetes/pki/sa.key \</span><br><span class="line">  --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">  --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \</span><br><span class="line">  --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota \</span><br><span class="line">  --authorization-mode=Node,RBAC \</span><br><span class="line">  --enable-bootstrap-token-auth=<span class="literal">true</span> \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \</span><br><span class="line">  --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem \</span><br><span class="line">  --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem \</span><br><span class="line">  --requestheader-allowed-names=aggregator \</span><br><span class="line">  --reguestheader-group-headers=X-Remote-Group \</span><br><span class="line">  --requestheader-extra-headers-prefix=X-Remote-Extra- \</span><br><span class="line">  --requestheader-username-headers=X-Remote-User</span><br><span class="line">  <span class="comment"># --token-auth-file=/etc/kubernetes/token.csv</span></span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>



<h3 id="启动apiserver"><a href="#启动apiserver" class="headerlink" title="启动apiserver"></a>启动apiserver</h3><p>所有 Master 节点开启 kube-apiserver</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> --now kube-apiserver</span><br></pre></td></tr></table></figure>

<p>检测 kube-server 状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl status kube-apiserver</span></span><br><span class="line">● kube-apiserver.service - Kubernetes API Server</span><br><span class="line">  Loaded: loaded (/usr/lib/systemd/system/kube-apiserver.service; enabled; vendor preset:disabled)</span><br><span class="line">  Active: active (running) since Sat 2020-08-22 21:26:49 CST; 26s ago</span><br></pre></td></tr></table></figure>

<p>系统日志的这些提示可以忽略</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Dec 11 20:51:15 k8s-master01 kube-apiserver: 11211 20:51:15.0047397450 glientconn.go:948] ClientConn switching balancer to <span class="string">&quot;pick first&quot;</span></span><br><span class="line">Dec 11 20:51:15 k8s-master01 kube-aniserxer: 11211 20:51:15.0048437450 balancer_conn_wrappera.qg:78] pickfirstBalancer:</span><br><span class="line">HandleSubConnStateChange: Oxc011bd4c80, (CONNECTING &lt;ni1&gt;)</span><br><span class="line">Dec 11 20:51:15 k8s-master01 kube-apiserver: I1211 20:51:15.010725</span><br></pre></td></tr></table></figure>





<h2 id="ControllerManager"><a href="#ControllerManager" class="headerlink" title="ControllerManager"></a><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV16Z4y1b74y/?p=21&spm_id_from=333.880.my_history.page.click&vd_source=629395ac7befa1625191c3f496068941">ControllerManager</a></h2><p>所有Master 节点配置kube-controller-manager service</p>
<p>注意本文档使用的k8s Pod网段为172.16.0.0&#x2F;12，该网段不能和宿主机的网段、k8s Service网段的重复，请按需修改</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-controller-manager \</span><br><span class="line">  --v=2 \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --address=127.0.0.1 \</span><br><span class="line">  --root-ca-file=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">  --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">  --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">  --service-account-private-key-file=/etc/kubernetes/pki/sa.key \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \</span><br><span class="line">  --leader-elect=<span class="literal">true</span> \</span><br><span class="line">  --use-service-account-credentials=<span class="literal">true</span> \</span><br><span class="line">  --node-monitor-grace-period=40s \</span><br><span class="line">  --node-monitor-period=5s \</span><br><span class="line">  --pod-eviction-timeout=2m0s \</span><br><span class="line">  --controllers=*,bootstrapsigner,tokencleaner \</span><br><span class="line">  --allocate-node-cidrs=<span class="literal">true</span> \</span><br><span class="line">  --cluster-cidr=172.16.0.0/12 \</span><br><span class="line">  --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \</span><br><span class="line">  --node-cidr-mask-size=24</span><br><span class="line"></span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>所有Master节点启动 kube-controller-manager</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 pki]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># systemctl enable --now kube-controller-manager</span></span><br></pre></td></tr></table></figure>

<p>查看启动状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 pki]<span class="comment"># aXatemctl enable --now kube-controller-manager</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># axatemctl status kube-controller-manager</span></span><br></pre></td></tr></table></figure>



<h2 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a>Scheduler</h2><p>所有 Master 节点配置 kube-scheduler service</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 pkil<span class="comment"># cat /usr/lib/systemd/system/kube-scheduler.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-scheduler \</span><br><span class="line">  --v=2 \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --address=127.0.0.1 \</span><br><span class="line">  --leader-elect=<span class="literal">true</span> \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line">  </span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@k8s-master01 pki]<span class="comment"># systemctl enable --now kube-scheduler</span></span><br></pre></td></tr></table></figure>



<h1 id="TLS-Bootstrapping-配置"><a href="#TLS-Bootstrapping-配置" class="headerlink" title="TLS Bootstrapping 配置"></a>TLS Bootstrapping 配置</h1><p>在 Mastero1 创建 bootstrape</p>
<p>注意，如果不是高可用集群，192.168.0.236:8443改为master01的地址，8443改为apiserver的端口，默认是6443</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /root/k8s-ha-install/bootstrap</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 bootstrap]<span class="comment"># kubectl config set-cluster kubernetes --certificate-authority=/etc/kubernetes/pki/ca.pem --embed-certs=true --server=https://192.168.0.236:8443 --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master01 bootstrap]<span class="comment"># kubectl config set-credentials tls-bootstrap-token-user --token=c8ad9c.2e4d610cf3e7426e --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master01 bootstrap]<span class="comment"># kubectl config use-context tls-bootstrap-token-user@kubernetes --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span></span><br></pre></td></tr></table></figure>

<p>注意：如果要修改 bootstrap.secret.yaml 的 token-id 和 token-secret ,需要保证下图红圈内的字符串一致的，并且位数是一样的。还要保证上个命令的黄色字体：c8ad9c.2e4d610cf3e7426e与你修改的字符串要一致</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /root/.kube; <span class="built_in">cp</span> /etc/kubernetes/admin.kubeconfig /root/.kube/config</span><br><span class="line">kubectl create -f bootstrap.secret.yaml</span><br></pre></td></tr></table></figure>





<h1 id="Node节点配置"><a href="#Node节点配置" class="headerlink" title="Node节点配置"></a>Node节点配置</h1><h2 id="复制证书"><a href="#复制证书" class="headerlink" title="复制证书"></a>复制证书</h2><p>Master01 节点复制证书至 Node 节点</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/kubernetes/</span><br><span class="line">[root@k8s-master01 kubernetes]<span class="comment"># for NODE in k8s-master02 k8s-master03 k8s-node01 k8s-node02; do</span></span><br><span class="line">ssh <span class="variable">$NODE</span> <span class="built_in">mkdir</span> -p /etc/kubernetes/pki /etc/etcd/ssl /etc/etcd/ssl</span><br><span class="line"><span class="keyword">for</span> FILE <span class="keyword">in</span> etcd-ca.pem etcd.pem etcd-key.pem; <span class="keyword">do</span></span><br><span class="line">  scp /etc/etcd/ssl/<span class="variable">$FILE</span> <span class="variable">$NODE</span>:/etc/etcd/ssl/</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">for</span> FILE <span class="keyword">in</span> pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig; <span class="keyword">do</span></span><br><span class="line">  scp /etc/kubernetes/SEILE sNODE:/etc/kubernetes/SkETiEt…  …r.</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>



<h2 id="Kubelet配置"><a href="#Kubelet配置" class="headerlink" title="Kubelet配置"></a>Kubelet配置</h2><p>所有节点创建相关目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /var/lib/kubelet /var/log/kubernetes /etc/systemd/system/kubelet.service.d /etc/kubernetes/manifests/</span><br></pre></td></tr></table></figure>

<p>所有节点配置 kubelet service</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 bootstrap]<span class="comment"># vim /usr/lib/systemd/system/kubelet.service</span></span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kubelet</span><br><span class="line"></span><br><span class="line">Restart=always</span><br><span class="line">StartLimitInterval=0</span><br><span class="line">RestartSec=10</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>所有节点配置 kubelet service 的配置文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/systemd/system/kubelet.service.d/10-kubelet.conf</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig&quot;</span></span><br><span class="line">Environment=<span class="string">&quot;KUBELET_SYSTEM_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin&quot;</span></span><br><span class="line">Environment=<span class="string">&quot;KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.2&quot;</span></span><br><span class="line">Environment=<span class="string">&quot;KUBELET_EXTRA_ARGS=--node-labels=node.kubernetes.io/node=&#x27;&#x27; &quot;</span></span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/local/bin/Kubelet <span class="variable">$KUBELET_KUBECONFIG_ARGS</span> <span class="variable">$KUBELET_CONFIG_ARGS</span> <span class="variable">$KUBELET_SYSTEM_ARGS</span> <span class="variable">$KUBELET_EXTRA_ARGS</span></span><br></pre></td></tr></table></figure>



<p>创建kubelet的配置文件</p>
<p>注意：如果更改了k8s的service 网段，需要更改 kubelet-conf.yml 的clusterDNS:配置，改成k8s Service网段的第十个地址，比如10.96.0.10</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 bootstrap]<span class="comment">## vim /etc/kubernetes/kubelet-conf.yml</span></span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">kind: KubeletConfiguratione</span><br><span class="line">address: 0.0.0.0</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: <span class="literal">false</span></span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile:/etc/kubernetes/pki/ca.pem</span><br><span class="line">  authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">  cacheAuthorizedTTL: 5m0s</span><br><span class="line">  cacheUnauthorizedTTL: 30s</span><br><span class="line">cgroupDriver: systemd</span><br><span class="line">cgroupsPerQOS: <span class="literal">true</span></span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.96.0.10</span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">containerLogMaxFiles: 5</span><br><span class="line">containerLogMaxSize: 10Mi</span><br><span class="line">contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">cpuCFSQuota: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">cpuManagerPolicy: none</span><br><span class="line">cpuManagerReconcilePeriod: 10s</span><br><span class="line">enableControllerAttachDetach: <span class="literal">true</span></span><br><span class="line">enableDebuggingHandlers: <span class="literal">true</span></span><br><span class="line">enforceNodeAllocatable:</span><br><span class="line">- pods</span><br><span class="line">eventBurst: 10</span><br><span class="line">eventRecordQPS: 5</span><br><span class="line">evictionHard:</span><br><span class="line">  imagefs.available: 15%</span><br><span class="line">  memory.available: 100Mi</span><br><span class="line">  nodefs.available: 10%</span><br><span class="line">  nodefs.inodesFree: 5%</span><br><span class="line">evictionPressureTransitionPeriod: 5m0s</span><br><span class="line">failSwapOn: <span class="literal">true</span></span><br><span class="line">fileCheckFrequency: 20s</span><br><span class="line">hairpinMode: promiscuous-bridge</span><br><span class="line">healthzBindAddress: 127.0.0.1</span><br><span class="line">healthzPort: 10248</span><br><span class="line">httpCheckFrequency: 20s</span><br><span class="line">imageGCHighThresholdPercent: 85</span><br><span class="line">imageGCLowThresholdPercent: 80</span><br><span class="line">imageMinimumGCAge: 2m0s</span><br><span class="line">iptablesDropBit: 15</span><br><span class="line">iptablesMasqueradeBit: 14</span><br><span class="line">kubeAPIBurst: 10</span><br><span class="line">kubeAPIQPS:5</span><br><span class="line">makelPTablesUtilChains: <span class="literal">true</span></span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">maxPods: 110</span><br><span class="line">nodeStatusUpdateFrequency: 10s</span><br><span class="line">oomScoreAdj: -999</span><br><span class="line">podPidsLimit: -1</span><br><span class="line">registryBurst: 10</span><br><span class="line">registryPullQPS: 54</span><br><span class="line">resolvConf: /etc/resolv.conf</span><br><span class="line">rotateCertificates: <span class="literal">true</span></span><br><span class="line">runtimeRequestTimeout: 2m0s</span><br><span class="line">serializelmagePulls: <span class="literal">true</span></span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">streamingConnectionldleTimeout: 4h0m0s</span><br><span class="line">syncFrequency: 1m0s</span><br><span class="line">volumeStatsAggPeriod: 1m0s</span><br></pre></td></tr></table></figure>

<p>启动所有节点 kubelet</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> --now kubelet</span><br></pre></td></tr></table></figure>



<p>此时系统日志&#x2F;var&#x2F;log&#x2F;messages</p>
<p><code>Unable to update cni config:no networks found in/etc/cni/net.d</code> 显示只有如下信息为正常</p>
<p>查看集群状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 bootstrap]<span class="comment"># kubectl get node</span></span><br></pre></td></tr></table></figure>





<h2 id="kube-proxy配置"><a href="#kube-proxy配置" class="headerlink" title="kube-proxy配置"></a>kube-proxy配置</h2><p>注意，如果不是高可用集群，192.168.0.236:8443改为master01的地址，8443改为apiserver的端口，默认是6443</p>
<p>以下操作在Master01执行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /root/k8s-ha-install</span><br><span class="line">kubectl -n kube-system create serviceaccount kube-proxy</span><br><span class="line">kubectl create clusterrolebinding system:kube-proxy --clusterrole system:node-proxier --serviceaccount kube-system:kube-proxy</span><br><span class="line">SECRET=$(kubectl -n kube-system get sa/kube-proxy \</span><br><span class="line">--output=jsonpath=<span class="string">&#x27;&#123;.secrets[0].name&#125;&#x27;</span>)</span><br><span class="line">JWT_TOKEN=$(kubectl -n kube-system get secret/<span class="variable">$SECRET</span> \</span><br><span class="line">--output=jsonpath=<span class="string">&#x27;&#123;.data.token&#125;&#x27;</span>| <span class="built_in">base64</span> -d)</span><br><span class="line">PKI_DIR=/etc/kubernetes/pki</span><br><span class="line">K8S_DIR=/etc/kubernetes</span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes --certificate-authority=/etc/kubernetes/pki/ca.pem --embed-certs=<span class="literal">true</span> --server=https://192.168.0.236:8443 --kubeconfig=<span class="variable">$&#123;K8S_DIR&#125;</span>/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl contig set-credentials kubernetes --token=<span class="variable">$&#123;JWI_TOKEN&#125;</span> --kubeconfig=/etc/kubernetes/kube-proxy,kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config set-context kubernetes --cluster=kubernetes --user=kubernetes --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">kubectl config use-context kubernetes --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<p>在 master01 将kube-proxy的systemd Service文件发送到其他节点</p>
<p>如果更改了集群Pod的网段，需要更改 kube-proxy&#x2F;kube-proxy.conf 的 clusterCIDR:172.16.0.0&#x2F;12参数为pod的网段。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim kube-proxy/kube-proxy.conf</span><br><span class="line">clusterCIDR: 172.16.0.0/12  <span class="comment"># 修改</span></span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 k8s-ha-install]<span class="comment"># for NODE in k8s-master01 k8s-master02 k8s-master03; do</span></span><br><span class="line">scp <span class="variable">$&#123;K8S_DIR&#125;</span>/kube-proxy.kubeconfig <span class="variable">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line">scp kube-proxy/kube-proxy.conf <span class="variable">$NODE</span>:/etc/kubernetes/kube-proxy.conf</span><br><span class="line">scp kube-proxy/kube-proxy.service <span class="variable">$NODE</span>:/usr/lib/systemd/system/kube-proxy.service</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master01 k8s-ha-install]<span class="comment"># for NODE in k8s-node01 k8s-node02; do</span></span><br><span class="line">scp /etc/kubernetes/kube-proxy.kubeconfig <span class="variable">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line">scp kube-proxy/kube-proxy.conf <span class="variable">$NODE</span>:/etc/kubernetes/kube-proxy.conf</span><br><span class="line">scp kube-proxy/kube-proxy.service <span class="variable">$NODE</span>:/usr/lib/systemd/system/kube-proxy.service</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>所有节点启动 kube-proxy</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 k8s-ha-install]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@k8s-master01 k8s-ha-install]<span class="comment"># systemctl enable --now kube-proxy</span></span><br></pre></td></tr></table></figure>





<h1 id="安装Calico"><a href="#安装Calico" class="headerlink" title="安装Calico"></a>安装Calico</h1><p>Calico 的安装请必须听视频课程和最后一章升级 Calico 的视频</p>
<p>以下步骤只在master01执行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /root/k8s-ha-install/calico/</span><br></pre></td></tr></table></figure>

<p>修改 calico-etcd.yaml 的以下位置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;s#etcd_endpoints: &quot;http://&lt;ETCD_IP&gt;:&lt;ETCD_PORT&gt;&quot;#etcd_endpoints: &quot;https://192.168.0.107:2379,https://192.168.0.108:2379,https://192.168.0.109:2379&quot;#g&#x27;</span> calico-etcd.yaml</span><br><span class="line"></span><br><span class="line">ETCD_CA=`<span class="built_in">cat</span> /etc/kubernetes/pki/etcd/etcd-ca.pem | <span class="built_in">base64</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span>`</span><br><span class="line">ETCD_CERT=`<span class="built_in">cat</span> /etc/kubernetes/pki/etcd/etcd.pem | <span class="built_in">base64</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span>`</span><br><span class="line">ETCD_KEY=`<span class="built_in">cat</span> /etc/kubernetes/pki/etcd/etcd-key.pem | <span class="built_in">base64</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span>`</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">&quot;s@# etcd-key: null@etcd-key: <span class="variable">$&#123;ETCD_KEY&#125;</span>@g; s@# etcd-cert:null@etcd-cert: <span class="variable">$&#123;ETCD_CERT&#125;</span>@g; s@# etcd-ca: null@etcd-ca: <span class="variable">$&#123;ETCD_CA&#125;</span>@g&quot;</span> calico-etcd.yaml</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">&#x27;s#etcd_ca: &quot;&quot;#etcd_ca: &quot;/calico-secrets/etcd-ca&quot;#g; s#etcd_cert: &quot;&quot;#etcd_cert: &quot;/calico-secrets/etcd-cert&quot;#g; s#etcd_key: &quot;&quot; #etcd_key: &quot;/calico-secrets/etcd-key&quot;#g&#x27;</span> calico-etcd.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更改此处为自己的pod网段</span></span><br><span class="line">POD_SUBNET=<span class="string">&quot;172.16.0.0/12&quot;</span></span><br><span class="line"></span><br><span class="line">sed -i <span class="string">&#x27;s@# - name: CALICO_IPV4P00L_CIDR@- name: CALICO_IPV4P00L_CIDR@g; s@#  value:&quot;192.168.00/16&quot;@  value: &#x27;</span><span class="string">&quot;<span class="variable">$&#123;POD_SUBNET&#125;</span>&quot;</span><span class="string">&#x27;@g&#x27;</span> calico-etcd.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f calico-etcd.yamle</span><br></pre></td></tr></table></figure>

<p>查看容器状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 calico]<span class="comment"># kubectl get po -n kube-systeme</span></span><br></pre></td></tr></table></figure>

<p>如果容器状态异常可以使用 kubectl describe 或者 logs 查看容器的日志</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 calico]<span class="comment"># vim calico-etcd.yaml</span></span><br><span class="line">    image: registry.cn-beijing.aliyuncs.com/dotbalo/kube-controllers:v3.15.3</span><br></pre></td></tr></table></figure>







<h1 id="安装CoreDNS"><a href="#安装CoreDNS" class="headerlink" title="安装CoreDNS"></a>安装CoreDNS</h1><h2 id="安装对应版本（推荐）"><a href="#安装对应版本（推荐）" class="headerlink" title="安装对应版本（推荐）"></a>安装对应版本（推荐）</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /root/k8s-ha-install/</span><br></pre></td></tr></table></figure>

<p>如果更改了k8s service的网段需要将coredns的service lP改成k8s service网段的第十个IP</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&quot;s#10.96.0.10#10.96.0.10#g&quot;</span> CoreDNS/coredns.yaml</span><br></pre></td></tr></table></figure>

<p>安装 coredns</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 k8s-ha-instal1]<span class="comment"># kubectl create -f</span></span><br><span class="line">CoreDNS/coredns.vaml</span><br><span class="line">seryiceaccount/coredns createde</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:coredns createde</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:coredns createde</span><br><span class="line">configmap/coredns createde</span><br><span class="line">deplovment.apps/coredns createde</span><br><span class="line">service/kube-dns created</span><br></pre></td></tr></table></figure>



<h2 id="安装最新版CoreDNS"><a href="#安装最新版CoreDNS" class="headerlink" title="安装最新版CoreDNS"></a>安装最新版CoreDNS</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/coredns/deployment.git</span><br><span class="line"><span class="built_in">cd</span> deployment/kubernetes</span><br><span class="line"><span class="comment"># ./deploy.sh -s -i 192.168.0.10 | kubectl apply -f</span></span><br><span class="line">serviceaccount/coredns created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">configmap/coredns created</span><br><span class="line">deployment.apps/coredns created</span><br><span class="line">service/kube-dns created</span><br><span class="line">查看状态</span><br><span class="line"><span class="comment"># kubectl get po -n kube-system -I k8s-app=kube-dns</span></span><br></pre></td></tr></table></figure>





<h1 id="安装Metrics-Server"><a href="#安装Metrics-Server" class="headerlink" title="安装Metrics Server"></a>安装Metrics Server</h1><p>在新版的 Kubernetes 中系统资源的采集均使用 Metrics-server，可以通过 Metrics 采集节点和 Pod 的内存、磁盘、CPU和网络的使用率。</p>
<p>安装metrics servere</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /root/k8s-ha-install/metrics-server-0.4.x/</span><br><span class="line">kubectl create -f .</span><br></pre></td></tr></table></figure>

<p>等待 metrics server 启动然后查看状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get po -n kube-system</span><br><span class="line">kubectl top node</span><br><span class="line">kubectl top po -A</span><br></pre></td></tr></table></figure>



<h1 id="集群验证"><a href="#集群验证" class="headerlink" title="集群验证"></a>集群验证</h1><p>集群验证请参考视频的集群验证，必须要做！！！</p>
<p>安装busybox</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span>&lt;&lt;<span class="string">EOF | kubectl apply -f -</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: busybox</span></span><br><span class="line"><span class="string">  namespace: default</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: busybox</span></span><br><span class="line"><span class="string">    image:busybox:1.28</span></span><br><span class="line"><span class="string">    command:</span></span><br><span class="line"><span class="string">      - sleep</span></span><br><span class="line"><span class="string">      - &quot;3600&quot;</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">  restartPolicy: Always</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>1.Pod必须能解析 Service</p>
<p>2.Pod必须能解析跨 namespace 的Service</p>
<p>3.每个节点都必须要能访问Kubernetes的kubernetes svc 443和kube-dns 的service 53</p>
<p>4.Pod和Pod之前要能通</p>
<p>a)同namespace能通信</p>
<p>b) 跨namespace 能通信</p>
<p>c)跨机器能通信</p>
<p>验证解析（请参考视频集群验证）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 CoreDNS]<span class="comment"># kubectl exec busybox -n default -- nslookup kubernetes</span></span><br><span class="line">[root@k8s-master01 CoreDNS]<span class="comment"># kubectl exec busybox -n default -- nslookup kube-dns.kube-system</span></span><br></pre></td></tr></table></figure>







<h1 id="安装dashboard"><a href="#安装dashboard" class="headerlink" title="安装dashboard"></a>安装dashboard</h1><h2 id="Dashboard部署"><a href="#Dashboard部署" class="headerlink" title="Dashboard部署"></a>Dashboard部署</h2><p>Dashboard用于展示集群中的各类资源，同时也可以通过Dashboard实时查看Pod的日志和在容器中执行一些命令等。</p>
<h3 id="安装指定版本dashboard"><a href="#安装指定版本dashboard" class="headerlink" title="安装指定版本dashboard"></a>安装指定版本dashboard</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /root/k8s-ha-install/dashboard/</span><br><span class="line">[root@k8s-master01 dashboard]<span class="comment"># kubectl create -f.</span></span><br></pre></td></tr></table></figure>



<h2 id="安装最新版"><a href="#安装最新版" class="headerlink" title="安装最新版"></a>安装最新版</h2><p>官方GitHub地址：<a target="_blank" rel="noopener" href="https://github.com/kubernetes/dashboard">https://github.com/kubernetes/dashboard</a></p>
<p>可以在官方dashboard 查看到最新版dashboard</p>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.3/aio/deploy/recommended.yaml">https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.3/aio/deploy/recommended.yaml</a></p>
<p>创建管理员用户vim admin.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">rbac.authorization.kubernetes.io/autoupdate:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># kubectl apply -f admin.yaml -n kube-system</span></span><br></pre></td></tr></table></figure>







<h2 id="登录dashboard"><a href="#登录dashboard" class="headerlink" title="登录dashboard"></a>登录dashboard</h2><p>在谷歌浏览器（Chrome）启动文件中加入启动参数，用于解决无法访问Dashboard的问题，</p>
<p>参考图1-1：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--test-type --ignore-certificate-errors</span><br></pre></td></tr></table></figure>





<p>更改dashboard的svc为NodePort:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard</span><br><span class="line">  <span class="built_in">type</span>: NodePort  <span class="comment">#修改</span></span><br></pre></td></tr></table></figure>

<p>将ClusterIP更改为NodePort（如果已经为NodePort忽略此步骤）：</p>
<p>查看端口号：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc kubernetes-dashboard -n kubernetes-dashboard</span><br></pre></td></tr></table></figure>

<p>根据自己的实例端口号，通过任意安装了kube-proxy的宿主机或者VIP的IP+端口即可访问到dashboard:</p>
<p>访问Dashboard：<a href="https://192.168.0.236:18282（请更改18282为自己的端口），选择登录方式为令牌（即token方式），参考图1-2“">https://192.168.0.236:18282（请更改18282为自己的端口），选择登录方式为令牌（即token方式），参考图1-2“</a></p>
<p>查看token值：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>







<h1 id="生产环境关键性配置"><a href="#生产环境关键性配置" class="headerlink" title="生产环境关键性配置"></a>生产环境关键性配置</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">/etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;registry-mirrors&quot;:</span> [</span><br><span class="line">    <span class="string">&quot;https://registry.docker-cn.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;http://hub-mirror.c.163.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;exec-opts&quot;:</span> [<span class="string">&quot;native.cgroupdriver=systemd&quot;</span>],</span><br><span class="line">  <span class="attr">&quot;max-concurrent-downloads&quot;:</span> <span class="number">10</span>,</span><br><span class="line">  <span class="attr">&quot;max-concurrent-uploads&quot;:</span> <span class="number">5</span>,</span><br><span class="line">  <span class="attr">&quot;log-opts&quot;:</span> &#123;</span><br><span class="line">    <span class="attr">&quot;max-size&quot;:</span> <span class="string">&quot;300m&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;max-file&quot;:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">&#125;,</span><br><span class="line">  <span class="attr">&quot;live-restore&quot;:</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">systemctl</span> <span class="string">daemon-reload</span></span><br><span class="line"><span class="string">systemctl</span> <span class="string">restart</span> <span class="string">docker</span></span><br></pre></td></tr></table></figure>





<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/kube-controller-manager.service</span><br><span class="line"><span class="comment"># --feature-gates=RotateKubeletClientCertificate=true,RotateKubeletServerCertificate=true \</span></span><br><span class="line">--experimental-cluster-signing-duration=876000h0m0s \</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/systemd/systea/kubelet.service.d/10-kubelet.conf</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">&quot;KUBELET KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet. kubeconfig --kubeconfig=/etc/kubernetes/kubelet. kubeconfig&quot;</span></span><br><span class="line">Environment=<span class="string">&quot;KUBELETsYSTEM ARGS=--network-pLugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin&quot;</span></span><br><span class="line">Environment=<span class="string">&quot;KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf. yml --pod- infra-container- image=registry.cn-hangzhou. aliyuncs.com/google_containers/pause-amd64:3.1&quot;</span></span><br><span class="line">Environment=<span class="string">&quot;KUBELET_EXTRA_ARGS=--node-Labels=node.kubernetes.io/node=&#x27;&#x27; --tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ETDHE_RSA_WITH_AES_256_GCM_SHA384 --image-pull-progress-deadline-30m &quot;</span></span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/Local/bin/kubeLet <span class="variable">$KUBELET_KUBECONFIG_ARGS</span> <span class="variable">$KUBELET_CONFIG_ARGS</span> <span class="variable">$KUBELET_SYSTEM_ARGS</span> <span class="variable">$KUBELET_EXTRA_ARGS</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vim</span> <span class="string">/etc/kubernetes/kubelet-conf.yml</span></span><br><span class="line"><span class="string">添加如下配置</span></span><br><span class="line"><span class="attr">allowedUnsafeSysctls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;net.core*&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;net.ipv4.*&quot;</span></span><br><span class="line"><span class="attr">kubeReserved:</span></span><br><span class="line">  <span class="attr">cpu:</span> <span class="string">&quot;10m&quot;</span></span><br><span class="line">  <span class="attr">memory:</span> <span class="string">10Mi</span></span><br><span class="line">  <span class="attr">ephemeral-storage:</span> <span class="string">10Mi</span></span><br><span class="line"><span class="attr">svstemReserved:</span></span><br><span class="line">  <span class="attr">cpu:</span> <span class="string">&quot;10m&quot;</span></span><br><span class="line">  <span class="attr">memory:</span> <span class="string">20Mi</span></span><br><span class="line">  <span class="attr">ephemeral-storage:</span> <span class="string">1Gi</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>安装总结：</p>
<p>1、kubeadm</p>
<p>2、二进制</p>
<p>3、自动化安装</p>
<p>a) Ansiblek</p>
<p>i.Master节点安装不需要写自动化。</p>
<p>ii.添加Node节点，playbook。</p>
<p>4、安装需要注意的细节</p>
<p>a) 上面的细节配置</p>
<p>b）生产环境中etcd一定要和系统盘分开，一定要用ssd硬盘。</p>
<p>c) Docker数据盘也要和系统盘分开，有条件的话可以使用ssd 硬盘</p>
<h1 id="Docker基础"><a href="#Docker基础" class="headerlink" title="Docker基础"></a>Docker基础</h1><p>Docker：它是一个开源的软件项目，在Linux操作系统上，docker提供了一个额外的软件抽象层及操作系统层虚拟化的自动管理机制。</p>
<p>物理机：</p>
<p>1.安装系统</p>
<p>2.依赖环境</p>
<p>​	a) Java - jdk jre</p>
<p>​	b) NodeJS – Node</p>
<p>​	C) PHP -PHP</p>
<p>3.应用程序</p>
<p>4.加一个物理机—&gt;提高并发量</p>
<p>虚拟机：</p>
<p>​	KVM Xen</p>
<p>​	1.把一个物理机虚拟机虚拟成多个机器</p>
<p>​	2.把依赖环境打成一个系统的模板</p>
<p>容器化：</p>
<p>​	Dockere</p>
<p>​	1.镜像基础</p>
<p>​		a) 依赖环境的镜像4</p>
<p>​			Java-Java基础的基础镜像</p>
<p>​			PHP-PHP基础的基础镜像</p>
<p>​		b）根据基础镜像-放入自己的代码或者包</p>
<p>​			生产一个新镜像</p>
<p>​			程序镜像</p>
<p>​		c）镜像 - 按层存储</p>
<p>​			A –Java → JDK1.8</p>
<p>​			a.jar</p>
<p>​			B– Java -&gt; JDK1.8</p>
<p>​			b.jar</p>
<p>​	2.启动时间特别，秒级启动</p>
<p>容器：把自己的应用程序，根据某个依赖的基础镜像，生成一个应用程序镜像应用程序镜像，可以运行在任何部署了Docker环境的机器上。</p>
<h2 id="Docker命令"><a href="#Docker命令" class="headerlink" title="Docker命令"></a>Docker命令</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">docker versian</span><br><span class="line">docker <span class="built_in">cp</span></span><br><span class="line">docker info</span><br><span class="line">docker rmi</span><br><span class="line">docker search</span><br><span class="line">docker <span class="built_in">rm</span></span><br><span class="line">docker.pull</span><br><span class="line">docker tag</span><br><span class="line">docker push</span><br><span class="line">docker images</span><br><span class="line">docker run</span><br><span class="line">docker stop</span><br><span class="line">dọcker logs</span><br><span class="line">docker build</span><br><span class="line">docker ps</span><br><span class="line">docker <span class="built_in">history</span></span><br><span class="line">docker <span class="built_in">exec</span></span><br><span class="line">docker commit</span><br></pre></td></tr></table></figure>









<h2 id="为什么要用Kubernetes？"><a href="#为什么要用Kubernetes？" class="headerlink" title="为什么要用Kubernetes？"></a><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1852363"><strong>为什么要用Kubernetes？</strong></a></h2><ul>
<li>容器管理</li>
<li>自动恢复</li>
<li>健康检查</li>
<li>弹性扩容</li>
<li>内部通讯</li>
<li>高可用</li>
</ul>
<h2 id="K8s控制节点-Master概念"><a href="#K8s控制节点-Master概念" class="headerlink" title="K8s控制节点-Master概念"></a><a target="_blank" rel="noopener" href="https://blog.csdn.net/rzy1248873545/article/details/125479217"><strong>K8s控制节点-Master概念</strong></a></h2><p>Kubernetes是谷歌以Borg为前身，基于谷歌15年生产环境经验的基础上开源的一个项目，Kubernetes致力于提供跨主机集群的自动部署、扩展、高可用以及运行应用程序容器的平台。</p>
<h2 id="Master-节点：整个集群的控制中枢"><a href="#Master-节点：整个集群的控制中枢" class="headerlink" title="Master 节点：整个集群的控制中枢"></a>Master 节点：整个集群的控制中枢</h2><ul>
<li>Kube-APIServer：集群的控制中枢，各个模块之间信息交互都需要经过 Kube-APIServer，同时它也是集群管理、资源配置、整个集群安全机制的入口。</li>
<li>Controller-Manager：集群的状态管理器，保证 Pod 或其他资源达到期望值，也是需要和 APIServer 进行通信，在需要的时候创建、更新或删除它所管理的资源。</li>
<li>Scheduler：集群的调度中心，它会根据指定的一系列条件，选择一个或一批最佳的节点，然后部署我们的Pod。</li>
<li>Etcd：键值数据库，报错一些集群的信息，一般生产环境中建议部署三个以上节点（奇数个）。</li>
</ul>
<p>Node：工作节点</p>
<p>Worker、node节点、minion节点</p>
<p>Kubelet：负责监听节点上Pod的状态，同时负责上报节点和节点上面Pod的状态，负责与Master节点通信，并管理节点上面的Pod。</p>
<p>Kube-proxy：负责Pod之间的通信和负载均衡，将指定的流量分发到后端正确的机器上。</p>
<p>查看 Kube-proxy 工作模式：curl 127.0.0.1:10249&#x2F;proxyMode</p>
<p>IPVS：监听Master节点增加和删除 service 以及 endpoint 的消息，调用 Netlink 接口创建相应的 IPVS 规则。通过 IPVS 规则，将流量转发至相应的 Pod 上。</p>
<p>iptables：监听Master节点增加和删除 service 以及 endpoint 的消息，对于每一个Service，他都会场景一个iptables规则，将 service 的 cluster lP 代理到后端对应的Pod。</p>
<p>Calico：符合 CNl 标准的网络插件，给每个Pod生成一个唯一的IP地址，并且把每个节点当做一个路由器。</p>
<p>Cilium</p>
<p>CoreDNS：用于 Kubernetes 集群内部 Service 的解析，可以让 Pod 把 Service 名称解析成 IP 地址，然后通过 Service 的 IP 地址进行连接到对应的应用上。</p>
<p>Docker：容器引擎，负责对容器的管理。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span> <span class="comment"># 必选，API的版本号</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span>    <span class="comment"># 必选，类型Pod</span></span><br><span class="line"><span class="attr">metadata:</span>    <span class="comment"># 必选，元数据</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">nginx</span>  <span class="comment"># 必选，符合RFC 1035规范的Pod名称</span></span><br><span class="line"> <span class="attr">namespace:</span> <span class="string">default</span> <span class="comment"># 可选，Pod所在的命名空间，不指定默认为default，可以使用-n 指定namespace </span></span><br><span class="line"> <span class="attr">labels:</span>    <span class="comment"># 可选，标签选择器，一般用于过滤和区分Pod</span></span><br><span class="line">  <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">role:</span> <span class="string">frontend</span> <span class="comment"># 可以写多个</span></span><br><span class="line"> <span class="attr">annotations:</span> <span class="comment"># 可选，注释列表，可以写多个</span></span><br><span class="line">  <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span>  <span class="comment"># 必选，用于定义容器的详细信息</span></span><br><span class="line"> <span class="attr">initContainers:</span> <span class="comment"># 初始化容器，在容器启动之前执行的一些初始化操作</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;I am InitContainer for init some configuration&quot;</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">  <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">init-container</span></span><br><span class="line"> <span class="attr">containers:</span>  <span class="comment"># 必选，容器列表</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span> <span class="comment"># 必选，符合RFC 1035规范的容器名称</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">nginx:latest</span>  <span class="comment"># 必选，容器所用的镜像的地址</span></span><br><span class="line">  <span class="attr">imagePullPolicy:</span> <span class="string">Always</span>   <span class="comment"># 可选，镜像拉取策略</span></span><br><span class="line">  <span class="attr">command:</span> <span class="comment"># 可选，容器启动执行的命令</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nginx</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="string">-g</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;daemon off;&quot;</span></span><br><span class="line">  <span class="attr">workingDir:</span> <span class="string">/usr/share/nginx/html</span>    <span class="comment"># 可选，容器的工作目录</span></span><br><span class="line">  <span class="attr">volumeMounts:</span>  <span class="comment"># 可选，存储卷配置，可以配置多个</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webroot</span> <span class="comment"># 存储卷名称</span></span><br><span class="line">   <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span> <span class="comment"># 挂载目录</span></span><br><span class="line">   <span class="attr">readOnly:</span> <span class="literal">true</span>    <span class="comment"># 只读</span></span><br><span class="line">  <span class="attr">ports:</span> <span class="comment"># 可选，容器需要暴露的端口号列表</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span>  <span class="comment"># 端口名称</span></span><br><span class="line">   <span class="attr">containerPort:</span> <span class="number">80</span>   <span class="comment"># 端口号</span></span><br><span class="line">   <span class="attr">protocol:</span> <span class="string">TCP</span> <span class="comment"># 端口协议，默认TCP</span></span><br><span class="line">  <span class="attr">env:</span>  <span class="comment"># 可选，环境变量配置列表</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TZ</span>   <span class="comment"># 变量名</span></span><br><span class="line">   <span class="attr">value:</span> <span class="string">Asia/Shanghai</span> <span class="comment"># 变量的值</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LANG</span></span><br><span class="line">   <span class="attr">value:</span> <span class="string">en_US.utf8</span></span><br><span class="line">  <span class="attr">resources:</span>   <span class="comment"># 可选，资源限制和资源请求限制</span></span><br><span class="line">   <span class="attr">limits:</span>    <span class="comment"># 最大限制设置</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">1000m</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">1024Mi</span></span><br><span class="line">   <span class="attr">requests:</span>   <span class="comment"># 启动所需的资源</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line"><span class="comment">#  startupProbe: # 可选，检测容器内进程是否完成启动。注意三种检查方式同时只能使用一种。</span></span><br><span class="line"><span class="comment">#   httpGet:   # httpGet检测方式，生产环境建议使用httpGet实现接口级健康检查，健康检查由应用程序提供。</span></span><br><span class="line"><span class="comment">#      path: /api/successStart # 检查路径</span></span><br><span class="line"><span class="comment">#      port: 80</span></span><br><span class="line">  <span class="attr">readinessProbe:</span> <span class="comment"># 可选，健康检查。注意三种检查方式同时只能使用一种。</span></span><br><span class="line">   <span class="attr">httpGet:</span>   <span class="comment"># httpGet检测方式，生产环境建议使用httpGet实现接口级健康检查，健康检查由应用程序提供。</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/</span> <span class="comment"># 检查路径</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span>    <span class="comment"># 监控端口</span></span><br><span class="line">  <span class="attr">livenessProbe:</span> <span class="comment"># 可选，健康检查</span></span><br><span class="line">   <span class="comment">#exec:    # 执行容器命令检测方式</span></span><br><span class="line">      <span class="comment">#command: </span></span><br><span class="line">      <span class="comment">#- cat</span></span><br><span class="line">      <span class="comment">#- /health</span></span><br><span class="line">  <span class="comment">#httpGet:    # httpGet检测方式</span></span><br><span class="line">  <span class="comment">#  path: /_health # 检查路径</span></span><br><span class="line">  <span class="comment">#  port: 8080</span></span><br><span class="line">  <span class="comment">#  httpHeaders: # 检查的请求头</span></span><br><span class="line">  <span class="comment">#  - name: end-user</span></span><br><span class="line">  <span class="comment">#   value: Jason </span></span><br><span class="line">   <span class="attr">tcpSocket:</span>  <span class="comment"># 端口检测方式</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">   <span class="attr">initialDelaySeconds:</span> <span class="number">60</span>    <span class="comment"># 初始化时间</span></span><br><span class="line">   <span class="attr">timeoutSeconds:</span> <span class="number">2</span>   <span class="comment"># 超时时间</span></span><br><span class="line">   <span class="attr">periodSeconds:</span> <span class="number">5</span>   <span class="comment"># 检测间隔</span></span><br><span class="line">   <span class="attr">successThreshold:</span> <span class="number">1</span> <span class="comment"># 检查成功为2次表示就绪</span></span><br><span class="line">   <span class="attr">failureThreshold:</span> <span class="number">2</span> <span class="comment"># 检测失败1次表示未就绪</span></span><br><span class="line">  <span class="attr">lifecycle:</span></span><br><span class="line">   <span class="attr">postStart:</span> <span class="comment"># 容器创建完成后执行的指令, 可以是exec httpGet TCPSocket</span></span><br><span class="line">    <span class="attr">exec:</span></span><br><span class="line">     <span class="attr">command:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">&#x27;mkdir /data/ &#x27;</span></span><br><span class="line">   <span class="attr">preStop:</span></span><br><span class="line">    <span class="attr">httpGet:</span>   </span><br><span class="line">       <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">       <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">   <span class="comment"># exec:</span></span><br><span class="line">   <span class="comment">#  command:</span></span><br><span class="line">   <span class="comment">#  - sh</span></span><br><span class="line">   <span class="comment">#  - -c</span></span><br><span class="line">   <span class="comment">#  - sleep 9</span></span><br><span class="line"> <span class="attr">restartPolicy:</span> <span class="string">Always</span>  <span class="comment"># 可选，默认为Always</span></span><br><span class="line"> <span class="comment">#nodeSelector: # 可选，指定Node节点</span></span><br><span class="line"> <span class="comment">#   region: subnet7</span></span><br><span class="line"> <span class="attr">imagePullSecrets:</span>   <span class="comment"># 可选，拉取镜像使用的secret，可以配置多个</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-dockercfg-86258</span></span><br><span class="line"> <span class="attr">hostNetwork:</span> <span class="literal">false</span>  <span class="comment"># 可选，是否为主机模式，如是，会占用主机端口</span></span><br><span class="line"> <span class="attr">volumes:</span>   <span class="comment"># 共享存储卷列表</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webroot</span> <span class="comment"># 名称，与上述对应</span></span><br><span class="line">  <span class="attr">emptyDir:</span> &#123;&#125;  <span class="comment"># 挂载目录</span></span><br><span class="line">    <span class="comment">#hostPath:       # 挂载本机目录</span></span><br><span class="line">    <span class="comment"># path: /etc/hosts</span></span><br></pre></td></tr></table></figure>



<h2 id="1-1-什么是Pod？"><a href="#1-1-什么是Pod？" class="headerlink" title="1.1 什么是Pod？"></a>1.1 什么是Pod？</h2><p>Pod是Kubernetes中最小的单元，它由一组、一个或多个容器组成，每个Pod还包含了一个Pause容器，Pause容器是Pod的父容器，主要负责僵尸进程的回收管理，通过Pause容器可以使同一个Pod里面的多个容器共享存储、网络、PID、IPC等。</p>
<h2 id="1-2-为什么要引入Pod"><a href="#1-2-为什么要引入Pod" class="headerlink" title="1.2 为什么要引入Pod?"></a>1.2 为什么要引入Pod?</h2><p>因为一个应用不可能单个容器就能支撑的，需要很多微服务支撑，可能出现一种情况就是两个服务，A服务和B服务之间需要网络互通，延迟非常小，而且两个服务有数据的依赖性，服务B需要用到服务A产生的文件，如果直接用k8s裸机的话，服务A和服务B不一定会在同一台宿主机上，当副本数非常大的时候，很难保证两个文件可以共享一个目录</p>
<p>每个pod有一个唯一的ip地址，便于管理</p>
<p>从k8s的角度看，它作为一个非常流行的编排工具，需要兼容很多的容器技术，所以通过pod管理不同的符合该标准的容器，而没有直接操作容器</p>
<p>其他容器技术：<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/">https://kubernetes.io/docs/setup/production-environment/container-runtimes/</a></p>
<h2 id="1-3-Pod探针"><a href="#1-3-Pod探针" class="headerlink" title="1.3 Pod探针"></a><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1852363">1.3 Pod探针</a></h2><h4 id="StartupProbe"><a href="#StartupProbe" class="headerlink" title="StartupProbe"></a><strong>StartupProbe</strong></h4><p>StartupProbe：k8s1.16版本后新加的探测方式，用于判断容器内应用程序是否已经启动。如果配置了startupProbe，就会先禁止其他的探测，直到它成功为止，成功后将不在进行探测。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#    startupProbe: # 可选，检测容器内进程是否完成启动。注意三种检查方式同时只能使用一种。</span></span><br><span class="line"><span class="comment">#      httpGet:      # httpGet检测方式，生产环境建议使用httpGet实现接口级健康检查，健康检查由应用程序提供。</span></span><br><span class="line"><span class="comment">#            path: /api/successStart # 检查路径</span></span><br><span class="line"><span class="comment">#            port: 80</span></span><br></pre></td></tr></table></figure>



<h4 id="LivenessProbe"><a href="#LivenessProbe" class="headerlink" title="LivenessProbe"></a><strong>LivenessProbe</strong></h4><p>LivenessProbe：用于探测容器是否运行，如果探测失败，kubelet会根据配置的重启策略进行相应的处理。若没有配置该探针，默认就是success。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#    livenessProbe:  # 可选，健康检查</span></span><br><span class="line">      <span class="comment">#exec:        # 执行容器命令检测方式</span></span><br><span class="line">            <span class="comment">#command: </span></span><br><span class="line">            <span class="comment">#- cat</span></span><br><span class="line">            <span class="comment">#- /health</span></span><br></pre></td></tr></table></figure>



<h4 id="ReadinessProbe"><a href="#ReadinessProbe" class="headerlink" title="ReadinessProbe"></a><strong>ReadinessProbe</strong></h4><p>ReadinessProbe：一般用于探测容器内的程序是否健康，它的返回值如果为success，那么久代表这个容器已经完成启动，并且程序已经是可以接受流量的状态。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#    readinessProbe: # 可选，健康检查。注意三种检查方式同时只能使用一种。</span></span><br><span class="line"><span class="comment">#      httpGet:      # httpGet检测方式，生产环境建议使用httpGet实现接口级健康检查，健康检查由应用程序提供。</span></span><br><span class="line"><span class="comment">#            path: / # 检查路径</span></span><br><span class="line"><span class="comment">#            port: 80        # 监控端口</span></span><br></pre></td></tr></table></figure>



<h2 id="1-4-Pod探针的检测方式"><a href="#1-4-Pod探针的检测方式" class="headerlink" title="1.4 Pod探针的检测方式"></a>1.4 Pod探针的检测方式</h2><h4 id="ExecAction"><a href="#ExecAction" class="headerlink" title="ExecAction"></a><strong>ExecAction</strong></h4><p>ExecAction：在容器内执行一个命令，如果返回值为0，则认为容器健康。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#    livenessProbe:  # 可选，健康检查</span></span><br><span class="line">      <span class="comment">#exec:        # 执行容器命令检测方式</span></span><br><span class="line">            <span class="comment">#command: </span></span><br><span class="line">            <span class="comment">#- cat</span></span><br><span class="line">            <span class="comment">#- /health</span></span><br></pre></td></tr></table></figure>

<h4 id="TCPSocketAction"><a href="#TCPSocketAction" class="headerlink" title="TCPSocketAction"></a><strong>TCPSocketAction</strong></h4><p>TCPSocketAction：通过TCP连接检查容器内的端口是否是通的，如果是通的就认为容器健康。</p>
<h4 id="HTTPGetAction"><a href="#HTTPGetAction" class="headerlink" title="HTTPGetAction"></a><strong>HTTPGetAction</strong></h4><p>HTTPGetAction：通过应用程序暴露的API地址来检查程序是否是正常的，如果状态码为200~400之间，则认为容器健康。</p>
<h2 id="1-5-探针检查参数配置"><a href="#1-5-探针检查参数配置" class="headerlink" title="1.5 探针检查参数配置"></a>1.5 探针检查参数配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">initialDelaySeconds:</span> <span class="number">60</span>    <span class="comment"># 初始化时间</span></span><br><span class="line"><span class="attr">timeoutSeconds:</span> <span class="number">2</span>   <span class="comment"># 超时时间</span></span><br><span class="line"><span class="attr">periodSeconds:</span> <span class="number">5</span>   <span class="comment"># 检测间隔</span></span><br><span class="line"><span class="attr">successThreshold:</span> <span class="number">1</span> <span class="comment"># 检查成功为1次表示就绪</span></span><br><span class="line"><span class="attr">failureThreshold:</span> <span class="number">2</span> <span class="comment"># 检测失败2次表示未就绪</span></span><br></pre></td></tr></table></figure>





<h2 id="零宕机必备知识：PreStop的使用"><a href="#零宕机必备知识：PreStop的使用" class="headerlink" title="零宕机必备知识：PreStop的使用"></a><strong>零宕机必备知识：PreStop的使用</strong></h2><p>Prestop：先去请求eureka接口，把自己的IP地址和端口号，进行下线，eureka从注册表中删除该应用的IP地址。然后容器进行sleep 90；kill <code>pgrep java</code></p>
<p>如果sleep时间过长，需要修改terminationGracePeriodSeconds</p>
<h2 id="Replication-Controller和ReplicaSet"><a href="#Replication-Controller和ReplicaSet" class="headerlink" title="Replication Controller和ReplicaSet"></a><strong><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1855459">Replication Controller和ReplicaSet</a></strong></h2><p>Replication Controller（复制控制器，RC）和ReplicaSet（复制集，RS）是两种简单部署Pod的方式。在生产环境中，主要使用更高级的Deployment等方式进行Pod的管理和部署。</p>
<ul>
<li>Replication Controller</li>
<li>ReplicaSet</li>
</ul>
<h3 id="Replication-Controller"><a href="#Replication-Controller" class="headerlink" title="Replication Controller"></a><strong>Replication Controller</strong></h3><p>Replication Controller（简称RC）可确保Pod副本数达到期望值，也就是RC定义的数量。换句话说，Replication Controller可确保一个Pod或一组同类Pod总是可用。</p>
<p>如果存在的Pod大于设定的值，则Replication Controller将终止额外的Pod。如果太小，Replication Controller将启动更多的Pod用于保证达到期望值。与手动创建Pod不同的是，用Replication Controller维护的Pod在失败、删除或终止时会自动替换。因此即使应用程序只需要一个Pod，也应该使用Replication Controller或其他方式管理。Replication Controller类似于进程管理程序，但是Replication Controller不是监视单个节点上的各个进程，而是监视多个节点上的多个Pod。</p>
<p>定义一个Replication Controller的示例如下。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<h3 id="ReplicaSet"><a href="#ReplicaSet" class="headerlink" title="ReplicaSet"></a><strong>ReplicaSet</strong></h3><p>ReplicaSet是支持基于集合的标签选择器的下一代Replication Controller，它主要用作Deployment协调创建、删除和更新Pod，和Replication Controller唯一的区别是，ReplicaSet支持标签选择器。在实际应用中，虽然ReplicaSet可以单独使用，但是一般建议使用Deployment来自动管理ReplicaSet，除非自定义的Pod不需要更新或有其他编排等。</p>
<p>定义一个ReplicaSet的示例如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">guestbook</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># modify replicas according to your case</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">matchExpressions:</span></span><br><span class="line">      <span class="bullet">-</span> &#123;<span class="attr">key:</span> <span class="string">tier</span>, <span class="attr">operator:</span> <span class="string">In</span>, <span class="attr">values:</span> [<span class="string">frontend</span>]&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">guestbook</span></span><br><span class="line">        <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">php-redis</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">gcr.io/google_samples/gb-frontend:v3</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GET_HOSTS_FROM</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">dns</span></span><br><span class="line">          <span class="comment"># If your cluster config does not include a dns service, then to</span></span><br><span class="line">          <span class="comment"># instead access environment variables to find service host</span></span><br><span class="line">          <span class="comment"># info, comment out the &#x27;value: dns&#x27; line above, and uncomment the</span></span><br><span class="line">          <span class="comment"># line below.</span></span><br><span class="line">          <span class="comment"># value: env</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>查看一下使用Deployment来自动管理ReplicaSet</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get deploy -n kube-system</span></span><br><span class="line">NAME                      READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">metrics-server            1/1     1            1           2d</span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get deploy -n kube-system metrics-server -oyaml</span></span><br><span class="line">message: ReplicaSet <span class="string">&quot;metrics-server-64c6c494dc&quot;</span> has successfully progressed.</span><br></pre></td></tr></table></figure>

<p>查看ReplicaSet</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get rs -n kube-system</span></span><br><span class="line">NAME                                DESIRED   CURRENT   READY   AGE</span><br><span class="line">metrics-server-64c6c494dc           1         1         1       2d</span><br></pre></td></tr></table></figure>

<p>如果我们改动了一个参数，做了滚动升级，它就会重新生成一个rs，这个rs可以被回滚，而rc是不支持回滚的，我们一般使用高级的功能比如Deployment和DaemonSet去管理我们的rc或rs，再通过rs管理我们的pod</p>
<p>Replication Controller和ReplicaSet的创建删除和Pod并无太大区别，Replication Controller目前几乎已经不在生产环境中使用，ReplicaSet也很少单独被使用，都是使用更高级的资源Deployment、DaemonSet、StatefulSet进行管理Pod。</p>
<h2 id="无状态服务Deployment概念"><a href="#无状态服务Deployment概念" class="headerlink" title="无状态服务Deployment概念"></a><strong>无状态服务Deployment概念</strong></h2><p>用于部署无状态的服务，这个最常用的控制器。一般用于管理维护企业内部无状态的微服务，比如configserver、zuul、springboot。他可以管理多个副本的Pod实现无缝迁移、自动扩容缩容、自动灾难恢复、一键回滚等功能。</p>
<h2 id="Deployment的创建"><a href="#Deployment的创建" class="headerlink" title="Deployment的创建"></a><strong>Deployment的创建</strong></h2><p>手动创建</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl create deployment nginx --image=nginx:1.15.2</span></span><br><span class="line">deployment.apps/nginx created</span><br></pre></td></tr></table></figure>

<p>导出到nginx-deploy.yaml</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get deployment nginx -o yaml &gt; nginx-deploy.yaml</span></span><br></pre></td></tr></table></figure>

<p>查看nginx-deploy.yaml</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># vim nginx-deploy.yaml </span></span><br></pre></td></tr></table></figure>

<p>删除status以下的内容，修改副本数</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">replicas:</span> <span class="number">2</span> <span class="comment">#副本数</span></span><br></pre></td></tr></table></figure>

<p>更新配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl replace -f nginx-deploy.yaml</span></span><br><span class="line">deployment.apps/nginx replaced</span><br></pre></td></tr></table></figure>

<p>查看副本数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-66bbc9fdc5-vtk4n   1/1     Running   0          16m</span><br><span class="line">nginx-66bbc9fdc5-x87z5   1/1     Running   0          34s</span><br></pre></td></tr></table></figure>

<p>以上是使用文件的方式管理，也可以使用edit</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl edit deploy nginx</span></span><br><span class="line"><span class="comment"># 把副本数改回1</span></span><br><span class="line">replicas: 1</span><br></pre></td></tr></table></figure>

<p>查看副本数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-66bbc9fdc5-vtk4n   1/1     Running   0          19m</span><br></pre></td></tr></table></figure>

<p>查看文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master01</span> <span class="string">~</span>]<span class="comment"># cat nginx-deploy.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">deployment.kubernetes.io/revision:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2021-07-22T08:50:24Z&quot;</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">labels:</span> <span class="comment"># Deployment本身的labels</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;1439468&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">f6659adb-7b49-48a5-8db6-fbafa6baa1d7</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">progressDeadlineSeconds:</span> <span class="number">600</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span> <span class="comment"># 副本数</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span> <span class="comment"># 历史记录保留的个数</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span> <span class="comment"># 与下面pod的labels必须保持一致，不然管理不了pod，匹配rs，新版本创建之后不允许修改，修改之后产生新的rs，无法对应旧的label</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="string">rollingUpdate:#</span> <span class="string">滚动升级的策略</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">  <span class="attr">template:</span> <span class="comment"># pod的参数</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.15.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">        <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">      <span class="attr">securityContext:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>

<p>查看deploy的labels</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get deploy --show-labels</span></span><br><span class="line">NAME    READY   UP-TO-DATE   AVAILABLE   AGE   LABELS</span><br><span class="line">nginx   1/1     1            1           22m   app=nginx</span><br></pre></td></tr></table></figure>

<p>状态解析</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get deploy -owide</span></span><br><span class="line">NAME    READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR</span><br><span class="line">nginx   1/1     1            1           40m   nginx        nginx:1.15.2   app=nginx</span><br></pre></td></tr></table></figure>

<ul>
<li>NAME： Deployment名称</li>
<li>READY：Pod的状态，已经Ready的个数</li>
<li>UP-TO-DATE：已经达到期望状态的被更新的副本数</li>
<li>AVAILABLE：已经可以用的副本数</li>
<li>AGE：显示应用程序运行的时间</li>
<li>CONTAINERS：容器名称</li>
<li>IMAGES：容器的镜像</li>
<li>SELECTOR：管理的Pod的标签</li>
</ul>
<h2 id="Deployment的更新"><a href="#Deployment的更新" class="headerlink" title="Deployment的更新"></a><strong>Deployment的更新</strong></h2><p>修改spec里面的template才会触发更新</p>
<p>查看镜像版本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get deploy -oyaml | grep image</span></span><br><span class="line">        - image: nginx:1.15.2</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br></pre></td></tr></table></figure>

<p>更改deployment的镜像并记录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl set image deploy nginx nginx=nginx:1.15.3 --record</span></span><br><span class="line">Flag --record has been deprecated, --record will be removed <span class="keyword">in</span> the future</span><br><span class="line">deployment.apps/nginx image updated</span><br></pre></td></tr></table></figure>

<p>查看滚动更新过程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl rollout status deploy nginx</span></span><br><span class="line">deployment <span class="string">&quot;nginx&quot;</span> successfully rolled out</span><br></pre></td></tr></table></figure>

<p>或者使用describe查看</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl describe deploy nginx</span></span><br><span class="line">Events:</span><br><span class="line">  Type    Reason             Age                   From                   Message</span><br><span class="line">  ----    ------             ----                  ----                   -------</span><br><span class="line">  Normal  ScalingReplicaSet  8m37s (x2 over 21h)   deployment-controller  Scaled up replica <span class="built_in">set</span> nginx-66bbc9fdc5 to 1</span><br><span class="line">  Normal  ScalingReplicaSet  8m35s                 deployment-controller  Scaled down replica <span class="built_in">set</span> nginx-5dfc8689c6 to 0</span><br><span class="line">  Normal  ScalingReplicaSet  7m41s (x2 over 165m)  deployment-controller  Scaled up replica <span class="built_in">set</span> nginx-5dfc8689c6 to 1</span><br><span class="line">  Normal  ScalingReplicaSet  7m39s (x2 over 165m)  deployment-controller  Scaled down replica <span class="built_in">set</span> nginx-66bbc9fdc5 to 0</span><br></pre></td></tr></table></figure>

<p>查看rs</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get rs</span></span><br><span class="line">NAME               DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-5dfc8689c6   1         1         1       165m</span><br><span class="line">nginx-66bbc9fdc5   0         0         0       21h</span><br></pre></td></tr></table></figure>

<p>滚动更新的策略是：先启动一个新的rs，将副本数设置为1，再把旧的删掉一个，然后再启动一个新的</p>
<p>查看滚动更新策略配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># vim nginx-deploy.yaml </span></span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 25%</span><br><span class="line">      maxUnavailable: 25%</span><br><span class="line">    <span class="built_in">type</span>: RollingUpdat</span><br></pre></td></tr></table></figure>



<h2 id="Deployment的回滚"><a href="#Deployment的回滚" class="headerlink" title="Deployment的回滚"></a><strong>Deployment的回滚</strong></h2><p>更新deploy镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl set image deploy nginx nginx=nginx:787977da --record</span></span><br><span class="line">Flag --record has been deprecated, --record will be removed <span class="keyword">in</span> the future</span><br><span class="line">deployment.apps/nginx image updated</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po</span></span><br><span class="line">NAME                     READY   STATUS         RESTARTS   AGE</span><br><span class="line">nginx-5dfc8689c6-ww9v4   1/1     Running        0          17m</span><br><span class="line">nginx-7d79b96f68-m94sh   0/1     ErrImagePull   0          12s</span><br></pre></td></tr></table></figure>

<p>查看历史版本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl rollout history deploy nginx</span></span><br><span class="line">deployment.apps/nginx </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">3         kubectl <span class="built_in">set</span> image deploy nginx nginx=nginx:1.15.3 --record=<span class="literal">true</span></span><br><span class="line">4         kubectl <span class="built_in">set</span> image deploy nginx nginx=nginx:1.15.3 --record=<span class="literal">true</span></span><br><span class="line">5         kubectl <span class="built_in">set</span> image deploy nginx nginx=nginx:787977da --record=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>回滚到上一个版本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl rollout undo deploy nginx</span></span><br><span class="line">deployment.apps/nginx rolled back</span><br></pre></td></tr></table></figure>

<p>查看pod，可以看到只剩一个</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-5dfc8689c6-ww9v4   1/1     Running   0          20m</span><br></pre></td></tr></table></figure>

<p>进行多次更新</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl set image deploy nginx nginx=nginx:787977da --record</span></span><br><span class="line">deployment.apps/nginx image updated</span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl set image deploy nginx nginx=nginx:787977dadaa --record</span></span><br><span class="line">deployment.apps/nginx image updated</span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl set image deploy nginx nginx=nginx:787977xxxxxdadaa --record</span></span><br><span class="line">deployment.apps/nginx image updated</span><br></pre></td></tr></table></figure>

<p>查看历史记录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl rollout history deploy nginx</span></span><br><span class="line">deployment.apps/nginx </span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">3         kubectl <span class="built_in">set</span> image deploy nginx nginx=nginx:1.15.3 --record=<span class="literal">true</span></span><br><span class="line">6         kubectl <span class="built_in">set</span> image deploy nginx nginx=nginx:1.15.3 --record=<span class="literal">true</span></span><br><span class="line">7         kubectl <span class="built_in">set</span> image deploy nginx nginx=nginx:787977da --record=<span class="literal">true</span></span><br><span class="line">8         kubectl <span class="built_in">set</span> image deploy nginx nginx=nginx:787977dadaa --record=<span class="literal">true</span></span><br><span class="line">9         kubectl <span class="built_in">set</span> image deploy nginx nginx=nginx:787977xxxxxdadaa --record=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>查看指定版本的详细信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl rollout history deploy nginx --revision=6</span></span><br><span class="line">deployment.apps/nginx with revision <span class="comment">#6</span></span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:	app=nginx</span><br><span class="line">	pod-template-hash=5dfc8689c6</span><br><span class="line">  Annotations:	kubernetes.io/change-cause: kubectl <span class="built_in">set</span> image deploy nginx nginx=nginx:1.15.3 --record=<span class="literal">true</span></span><br><span class="line">  Containers:</span><br><span class="line">   nginx:</span><br><span class="line">    Image:	nginx:1.15.3</span><br><span class="line">    Port:	&lt;none&gt;</span><br><span class="line">    Host Port:	&lt;none&gt;</span><br><span class="line">    Environment:	&lt;none&gt;</span><br><span class="line">    Mounts:	&lt;none&gt;</span><br><span class="line">  Volumes:	&lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>回滚到执行的版本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl rollout undo deploy nginx --to-revision=6</span></span><br><span class="line">deployment.apps/nginx rolled back</span><br></pre></td></tr></table></figure>

<p>查看deploy状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get deploy -oyaml</span></span><br></pre></td></tr></table></figure>





<h2 id="Deployment扩容和缩容"><a href="#Deployment扩容和缩容" class="headerlink" title="Deployment扩容和缩容"></a><strong>Deployment扩容和缩容</strong></h2><p>扩容</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl scale --replicas=3 deploy nginx</span></span><br><span class="line">deployment.apps/nginx scaled</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-5dfc8689c6-nhplc   1/1     Running   0          41s</span><br><span class="line">nginx-5dfc8689c6-ww9v4   1/1     Running   0          72m</span><br><span class="line">nginx-5dfc8689c6-xh9l6   1/1     Running   0          41s</span><br></pre></td></tr></table></figure>

<p>缩容</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl scale --replicas=2 deploy nginx</span></span><br><span class="line">deployment.apps/nginx scaled</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po</span></span><br><span class="line">NAME                     READY   STATUS        RESTARTS   AGE</span><br><span class="line">nginx-5dfc8689c6-nhplc   1/1     Running       0          2m1s</span><br><span class="line">nginx-5dfc8689c6-ww9v4   1/1     Running       0          73m</span><br><span class="line">nginx-5dfc8689c6-xh9l6   0/1     Terminating   0          2m1s</span><br><span class="line"></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-5dfc8689c6-nhplc   1/1     Running   0          2m17s</span><br><span class="line">nginx-5dfc8689c6-ww9v4   1/1     Running   0          73m</span><br></pre></td></tr></table></figure>



<h2 id="Deployment更新暂停和恢复"><a href="#Deployment更新暂停和恢复" class="headerlink" title="Deployment更新暂停和恢复"></a><strong>Deployment更新暂停和恢复</strong></h2><p>使用edit命令可以修改多个配置，再一次性更新，但是通过set命令，每次都会触发更新，那么该如何做呢？可以使用Deployment更新暂停功能</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl rollout pause deployment nginx</span></span><br><span class="line">deployment.apps/nginx paused</span><br></pre></td></tr></table></figure>

<p>使用set命令修改配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl set image deploy nginx nginx=nginx:1.15.3 --record</span></span><br><span class="line">Flag --record has been deprecated, --record will be removed <span class="keyword">in</span> the future</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进行第二次配置变更，添加内存CPU配置</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl set resources deploy nginx -c nginx --limits=cpu=200m,memory=128Mi --requests=cpu=10m,memory=16Mi</span></span><br><span class="line">deployment.apps/nginx resource requirements updated</span><br></pre></td></tr></table></figure>

<p>查看deploy</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get deploy nginx -oyaml</span></span><br><span class="line">        resources:</span><br><span class="line">          limits:<span class="comment"># 容器最大的CPU和内容容量</span></span><br><span class="line">            cpu: 200m</span><br><span class="line">            memory: 128Mi</span><br><span class="line">          requests: <span class="comment"># 容器启动最小的CPU和内容容量</span></span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 16Mi</span><br></pre></td></tr></table></figure>

<p>查看pod是否被更新</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-5dfc8689c6-nhplc   1/1     Running   0          22m</span><br><span class="line">nginx-5dfc8689c6-ww9v4   1/1     Running   0          93m</span><br></pre></td></tr></table></figure>

<p>可以看到pod没有更新</p>
<p>更新恢复</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl rollout resume deploy nginx</span></span><br><span class="line">deployment.apps/nginx resumed</span><br></pre></td></tr></table></figure>

<p>查看rs</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get rs</span></span><br><span class="line">NAME               DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-5475c49ffb   0         0         0       71m</span><br><span class="line">nginx-5dfc8689c6   0         0         0       4h12m</span><br><span class="line">nginx-66bbc9fdc5   0         0         0       23h</span><br><span class="line">nginx-68db656dd8   2         2         2       32s</span><br><span class="line">nginx-799b8478d4   0         0         0       71m</span><br><span class="line">nginx-7d79b96f68   0         0         0       77m</span><br></pre></td></tr></table></figure>

<p>可以看到32s前新增了nginx的rs，更新被恢复就可以创建新的容器了</p>
<h2 id="Deployment更新注意事项"><a href="#Deployment更新注意事项" class="headerlink" title="Deployment更新注意事项"></a><strong>Deployment更新注意事项</strong></h2><p>查看deploy</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master01</span> <span class="string">~</span>]<span class="comment"># kubectl get deploy nginx -oyaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">deployment.kubernetes.io/revision:</span> <span class="string">&quot;11&quot;</span></span><br><span class="line">    <span class="attr">kubernetes.io/change-cause:</span> <span class="string">kubectl</span> <span class="string">set</span> <span class="string">image</span> <span class="string">deploy</span> <span class="string">nginx</span> <span class="string">nginx=nginx:1.15.3</span></span><br><span class="line">      <span class="string">--record=true</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2021-07-22T08:50:24Z&quot;</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">20</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;1588198&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">f6659adb-7b49-48a5-8db6-fbafa6baa1d7</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">progressDeadlineSeconds:</span> <span class="number">600</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span> <span class="comment"># 设置保留RS旧的revision的个数，设置为0的话，不保留历史数据</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">strategy:</span> <span class="comment"># 滚动更新的策略</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">25</span><span class="string">%</span> <span class="comment"># 可以超过期望值的最大Pod数，可选字段，默认为25%，可以设置成数字或百分比，如果该值为0，那么maxUnavailable不能为0</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">25</span><span class="string">%</span> <span class="comment"># 指定在回滚或更新时最大不可用的Pod的数量，可选字段，默认25%，可以设置成数字或百分比，如果该值为0，那么maxSurge就不能0</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span> <span class="comment"># 更新deployment的方式，默认是RollingUpdate，滚动更新，可以指定maxSurge和maxUnavailable</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.15.3</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">200m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">128Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">16Mi</span></span><br><span class="line">        <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">        <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">      <span class="attr">securityContext:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">availableReplicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2021-07-23T07:48:01Z&quot;</span></span><br><span class="line">    <span class="attr">lastUpdateTime:</span> <span class="string">&quot;2021-07-23T07:48:01Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">Deployment</span> <span class="string">has</span> <span class="string">minimum</span> <span class="string">availability.</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">MinimumReplicasAvailable</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Available</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2021-07-23T08:10:50Z&quot;</span></span><br><span class="line">    <span class="attr">lastUpdateTime:</span> <span class="string">&quot;2021-07-23T08:10:53Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">ReplicaSet</span> <span class="string">&quot;nginx-68db656dd8&quot;</span> <span class="string">has</span> <span class="string">successfully</span> <span class="string">progressed.</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">NewReplicaSetAvailable</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Progressing</span></span><br><span class="line">  <span class="attr">observedGeneration:</span> <span class="number">20</span></span><br><span class="line">  <span class="attr">readyReplicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">updatedReplicas:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>.spec.minReadySeconds：可选参数，指定新创建的Pod在没有任何容器崩溃的情况下视为Ready最小的秒数，默认为0，即一旦被创建就视为可用。</p>
<p>.spec.strategy.type Recreate：重建，先删除旧的Pod，在创建新的Pod</p>
<h2 id="有状态应用管理StatefulSet概念"><a href="#有状态应用管理StatefulSet概念" class="headerlink" title="有状态应用管理StatefulSet概念"></a><strong>有状态应用管理StatefulSet概念</strong></h2><p>StatefulSet（有状态集，缩写为sts）常用于部署有状态的且需要有序启动的应用程序，比如在进行SpringCloud项目容器化时，Eureka的部署是比较适合用StatefulSet部署方式的，可以给每个Eureka实例创建一个唯一且固定的标识符，并且每个Eureka实例无需配置多余的Service，其余Spring Boot应用可以直接通过Eureka的Headless Service即可进行注册。</p>
<ul>
<li>Eureka的statefulset的资源名称是eureka，eureka-0 eureka-1 eureka-2</li>
<li>Service：headless service，没有ClusterIP eureka-svc</li>
<li>Eureka-0.eureka-svc.NAMESPACE_NAME eureka-1.eureka-svc …</li>
</ul>
<h3 id="StatefulSet的基本概念"><a href="#StatefulSet的基本概念" class="headerlink" title="StatefulSet的基本概念"></a><strong>StatefulSet的基本概念</strong></h3><p>StatefulSet主要用于管理有状态应用程序的工作负载API对象。比如在生产环境中，可以部署ElasticSearch集群、<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/mongodb?from=10680">MongoDB</a>集群或者需要持久化的RabbitMQ集群、<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/crs?from=10680">Redis</a>集群、Kafka集群和ZooKeeper集群等。</p>
<p>和Deployment类似，一个StatefulSet也同样管理着基于相同容器规范的Pod。不同的是，StatefulSet为每个Pod维护了一个粘性标识。这些Pod是根据相同的规范创建的，但是不可互换，每个Pod都有一个持久的标识符，在重新调度时也会保留，一般格式为StatefulSetName-Number。比如定义一个名字是Redis-Sentinel的StatefulSet，指定创建三个Pod，那么创建出来的Pod名字就为Redis-Sentinel-0、Redis-Sentinel-1、Redis-Sentinel-2。而StatefulSet创建的Pod一般使用Headless Service（无头服务）进行通信，和普通的Service的区别在于Headless Service没有ClusterIP，它使用的是Endpoint进行互相通信，Headless一般的格式为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">statefulSetName-&#123;<span class="number">0.</span>.<span class="property">N</span>-<span class="number">1</span>&#125;.<span class="property">serviceName</span>.<span class="property">namespace</span>.<span class="property">svc</span>.<span class="property">cluster</span>.<span class="property">local</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<ul>
<li>serviceName为Headless Service的名字，创建StatefulSet时，必须指定Headless Service名称；</li>
<li>0..N-1为Pod所在的序号，从0开始到N-1；</li>
<li>statefulSetName为StatefulSet的名字；</li>
<li>namespace为服务所在的命名空间；</li>
<li>.cluster.local为Cluster Domain（集群域）。</li>
</ul>
<p>假如公司某个项目需要在Kubernetes中部署一个主从模式的Redis，此时使用StatefulSet部署就极为合适，因为StatefulSet启动时，只有当前一个容器完全启动时，后一个容器才会被调度，并且每个容器的标识符是固定的，那么就可以通过标识符来断定当前Pod的角色。</p>
<p>比如用一个名为redis-ms的StatefulSet部署主从架构的Redis，第一个容器启动时，它的标识符为redis-ms-0，并且Pod内主机名也为redis-ms-0，此时就可以根据主机名来判断，当主机名为redis-ms-0的容器作为Redis的主节点，其余从节点，那么Slave连接Master主机配置就可以使用不会更改的Master的Headless Service，此时Redis从节点（Slave）配置文件如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">port</span> <span class="number">6379</span></span><br><span class="line"><span class="string">slaveof</span> <span class="string">redis-ms-0.redis-ms.public-service.svc.cluster.local</span> <span class="number">6379</span></span><br><span class="line"><span class="string">tcp-backlog</span> <span class="number">511</span></span><br><span class="line"><span class="string">timeout</span> <span class="number">0</span></span><br><span class="line"><span class="string">tcp-keepalive</span> <span class="number">0</span></span><br><span class="line"><span class="string">……</span></span><br></pre></td></tr></table></figure>

<p>其中redis-ms-0.redis-ms.public-service.svc.cluster.local是Redis Master的Headless Service，在同一命名空间下只需要写redis-ms-0.redis-ms即可，后面的public-service.svc.cluster.local可以省略。</p>
<h3 id="StatefulSet注意事项"><a href="#StatefulSet注意事项" class="headerlink" title="StatefulSet注意事项"></a><strong>StatefulSet注意事项</strong></h3><p>一般StatefulSet用于有以下一个或者多个需求的应用程序：</p>
<ul>
<li>需要稳定的独一无二的网络标识符。</li>
<li>需要持久化数据。</li>
<li>需要有序的、优雅的部署和扩展。</li>
<li>需要有序的自动滚动更新。</li>
</ul>
<p>如果应用程序不需要任何稳定的标识符或者有序的部署、删除或者扩展，应该使用无状态的控制器部署应用程序，比如Deployment或者ReplicaSet。</p>
<p>StatefulSet是Kubernetes 1.9版本之前的beta资源，在1.5版本之前的任何Kubernetes版本都没有。</p>
<p>Pod所用的存储必须由PersistentVolume Provisioner（持久化卷配置器）根据请求配置StorageClass，或者由管理员预先配置，当然也可以不配置存储。</p>
<p>为了确保<a target="_blank" rel="noopener" href="https://cloud.tencent.com/solution/data_protection?from=10680">数据安全</a>，删除和缩放StatefulSet不会删除与StatefulSet关联的卷，可以手动选择性地删除PVC和PV</p>
<p>StatefulSet目前使用Headless Service（无头服务）负责Pod的网络身份和通信，需要提前创建此服务。</p>
<p>删除一个StatefulSet时，不保证对Pod的终止，要在StatefulSet中实现Pod的有序和正常终止，可以在删除之前将StatefulSet的副本缩减为0。</p>
<h2 id="创建一个StatefulSet应用"><a href="#创建一个StatefulSet应用" class="headerlink" title="创建一个StatefulSet应用"></a><strong>创建一个StatefulSet应用</strong></h2><ul>
<li>定义一个StatefulSet资源文件</li>
<li>创建一个StatefulSet</li>
</ul>
<h3 id="定义一个StatefulSet资源文件"><a href="#定义一个StatefulSet资源文件" class="headerlink" title="定义一个StatefulSet资源文件"></a><strong>定义一个StatefulSet资源文件</strong></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master01</span> <span class="string">~</span>]<span class="comment"># vim nginx-sts.yaml</span></span><br><span class="line"><span class="comment"># 添加以下内容</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;nginx&quot;</span> <span class="comment"># StatefulSet必须配置一个serviceName，它指向已经存在的service，上面定义</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.15.2</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<ul>
<li>kind: Service定义了一个名字为Nginx的Headless Service，创建的Service格式为nginx-0.nginx.default.svc.cluster.local，其他的类似，因为没有指定Namespace（命名空间），所以默认部署在default。</li>
<li>kind: StatefulSet定义了一个名字为web的StatefulSet，replicas表示部署Pod的副本数，本实例为2。</li>
</ul>
<p>在StatefulSet中必须设置Pod选择器（.spec.selector）用来匹配其标签（.spec.template.metadata.labels）。在1.8版本之前，如果未配置该字段（.spec.selector），将被设置为默认值，在1.8版本之后，如果未指定匹配Pod Selector，则会导致StatefulSet创建错误。</p>
<p>当StatefulSet控制器创建Pod时，它会添加一个标签statefulset.kubernetes.io&#x2F;pod-name，该标签的值为Pod的名称，用于匹配Service。</p>
<h3 id="创建一个StatefulSet"><a href="#创建一个StatefulSet" class="headerlink" title="创建一个StatefulSet"></a><strong>创建一个StatefulSet</strong></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl create -f nginx-sts.yaml</span></span><br><span class="line">service/nginx created</span><br><span class="line">statefulset.apps/web created</span><br></pre></td></tr></table></figure>

<p>查看pod</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">web-0                    1/1     Running   0          5s</span><br><span class="line">web-1                    1/1     Running   0          3s</span><br></pre></td></tr></table></figure>

<p>查看service</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get svc</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   14d</span><br><span class="line">nginx        ClusterIP   None         &lt;none&gt;        80/TCP    52s</span><br></pre></td></tr></table></figure>

<p>扩容sts</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl scale --replicas=3 sts web</span></span><br><span class="line">statefulset.apps/web scaled</span><br></pre></td></tr></table></figure>

<p>查看pod</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">web-0                    1/1     Running   0          2m21s</span><br><span class="line">web-1                    1/1     Running   0          2m19s</span><br><span class="line">web-2                    1/1     Running   0          14s</span><br></pre></td></tr></table></figure>

<p>新增busybox，解析无头service</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span>&lt;&lt;<span class="string">EOF | kubectl apply -f -</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: busybox</span></span><br><span class="line"><span class="string">  namespace: default</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: busybox</span></span><br><span class="line"><span class="string">    image: busybox:1.28</span></span><br><span class="line"><span class="string">    command:</span></span><br><span class="line"><span class="string">      - sleep</span></span><br><span class="line"><span class="string">      - &quot;3600&quot;</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">  restartPolicy: Always</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p>验证StatefulSet</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl exec -ti busybox -- sh</span></span><br><span class="line">/ <span class="comment"># ls</span></span><br><span class="line">bin   dev   etc   home  proc  root  sys   tmp   usr   var</span><br><span class="line">/ <span class="comment"># nslookup web-0.nginx</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      web-0.nginx</span><br><span class="line">Address 1: 172.25.244.242 web-0.nginx.default.svc.cluster.local</span><br><span class="line">/ <span class="comment"># exit</span></span><br></pre></td></tr></table></figure>

<p>获取pod的IP</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po -owide</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP               NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">busybox                  1/1     Running   0          3m34s   172.25.244.245   k8s-master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-68db656dd8-2dv8l   1/1     Running   0          106m    172.25.244.241   k8s-master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-68db656dd8-8lcrk   1/1     Running   0          106m    172.25.244.240   k8s-master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">web-0                    1/1     Running   0          9m3s    172.25.244.242   k8s-master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">web-1                    1/1     Running   0          9m1s    172.25.244.243   k8s-master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">web-2                    1/1     Running   0          6m56s   172.25.244.244   k8s-master01   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到它直接把service地址解析成pod的IP，不通过service访问，直接通过IP访问，减少了一层代理，性能更高，所以不需要配置clusterIP</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">clusterIP:</span> <span class="string">None</span></span><br></pre></td></tr></table></figure>





<h2 id="StatefulSet扩容缩容"><a href="#StatefulSet扩容缩容" class="headerlink" title="StatefulSet扩容缩容"></a><strong>StatefulSet扩容缩容</strong></h2><p>查看nginx副本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS       AGE</span><br><span class="line">web-0                    1/1     Running   1 (7h1m ago)   22h</span><br><span class="line">web-1                    1/1     Running   1 (7h1m ago)   22h</span><br><span class="line">web-2                    1/1     Running   1 (7h1m ago)   22h</span><br></pre></td></tr></table></figure>

<p>StatefulSet副本启动顺序按照名称0，1，2，只有web-0完全启动之后才会启动web-1，web-1完全启动之后才会启动web-2</p>
<p>删除的时候顺序与启动相反，从最后一个序号开始，2，1，0，如果web-2删除过程中，web-0挂掉了，那么web-1不会被删除，必须等待web-0启动状态变为ready之后，才会删除web-1</p>
<p>打开另一个窗口监控StatefulSet</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po -l app=nginx -w</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS        AGE</span><br><span class="line">web-0                    1/1     Running   1 (7h14m ago)   22h</span><br><span class="line">web-1                    1/1     Running   1 (7h14m ago)   22h</span><br><span class="line">web-2                    1/1     Running   1 (7h14m ago)   22h</span><br></pre></td></tr></table></figure>

<p>扩容到5个副本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl scale --replicas=5 sts web</span></span><br><span class="line">statefulset.apps/web scaled</span><br></pre></td></tr></table></figure>

<p>监控情况（可以看到按顺序启动）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po -l app=nginx -w</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS        AGE</span><br><span class="line">web-3                    0/1     Pending   0               0s</span><br><span class="line">web-3                    0/1     Pending   0               0s</span><br><span class="line">web-3                    0/1     ContainerCreating   0               0s</span><br><span class="line">web-3                    1/1     Running             0               1s</span><br><span class="line">web-4                    0/1     Pending             0               0s</span><br><span class="line">web-4                    0/1     Pending             0               0s</span><br><span class="line">web-4                    0/1     ContainerCreating   0               0s</span><br><span class="line">web-4                    1/1     Running             0               1s</span><br></pre></td></tr></table></figure>

<p>缩容到2个副本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl scale --replicas=2 sts web</span></span><br><span class="line">statefulset.apps/web scaled</span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>监控情况（可以看到删除的顺序与启动的顺序相反）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">web-4                    1/1     Terminating         0               14m</span><br><span class="line">web-4                    0/1     Terminating         0               14m</span><br><span class="line">web-4                    0/1     Terminating         0               14m</span><br><span class="line">web-4                    0/1     Terminating         0               14m</span><br><span class="line">web-3                    1/1     Terminating         0               14m</span><br><span class="line">web-3                    0/1     Terminating         0               14m</span><br><span class="line">web-3                    0/1     Terminating         0               14m</span><br><span class="line">web-3                    0/1     Terminating         0               14m</span><br><span class="line">web-2                    1/1     Terminating         1 (7h29m ago)   22h</span><br><span class="line">web-2                    0/1     Terminating         1 (7h29m ago)   22h</span><br><span class="line">web-2                    0/1     Terminating         1 (7h29m ago)   22h</span><br><span class="line">web-2                    0/1     Terminating         1 (7h29m ago)   22h</span><br></pre></td></tr></table></figure>

<p>StatefulSet滚动更新的时候会先删除旧的副本，再创建新的副本，如果只有一个副本的话，会导致业务不可用，所以要根据自己的实际情况选择使用StatefulSet或者Deployment，如果必须固定主机名或者pod名称，建议使用StatefulSet</p>
<p>查看主机名称</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl exec -ti web-0 -- sh</span></span><br><span class="line"><span class="comment"># hostname</span></span><br><span class="line">web-0</span><br><span class="line"><span class="comment"># exit</span></span><br></pre></td></tr></table></figure>



<h2 id="StatefulSet更新策略"><a href="#StatefulSet更新策略" class="headerlink" title="StatefulSet更新策略"></a><strong>StatefulSet更新策略</strong></h2><ul>
<li>RollingUpdate</li>
<li>OnDelete</li>
</ul>
<p>StatefulSet和Deployment一样，有几种更新方式</p>
<h3 id="RollingUpdate"><a href="#RollingUpdate" class="headerlink" title="RollingUpdate"></a><strong>RollingUpdate</strong></h3><p>查看更新方式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get sts -o yaml</span></span><br><span class="line">    updateStrategy:</span><br><span class="line">      rollingUpdate:</span><br><span class="line">        partition: 0</span><br><span class="line">      <span class="built_in">type</span>: RollingUpdate <span class="comment"># 默认滚动更新，从下往上更新</span></span><br></pre></td></tr></table></figure>

<p>扩容到3个副本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl scale --replicas=3 sts web</span></span><br><span class="line">statefulset.apps/web scaled</span><br></pre></td></tr></table></figure>

<p>查看pod</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS       AGE</span><br><span class="line">web-0                    1/1     Running   0              53m</span><br><span class="line">web-1                    1/1     Running   1 (8h ago)     23h</span><br><span class="line">web-2                    1/1     Running   0              15s</span><br></pre></td></tr></table></figure>

<p>滚动更新顺序是web-2，web-1，web-0，从下往上更新，如果更新过程中web-0挂掉了，则会等待web-0恢复到状态为ready之后再继续从下往上滚动更新</p>
<p>打开另一个窗口监控StatefulSet</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po -l app=nginx -w</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS     AGE</span><br><span class="line">web-0                    1/1     Running   0            13s</span><br><span class="line">web-1                    1/1     Running   0            23s</span><br><span class="line">web-2                    1/1     Running   0            33s</span><br></pre></td></tr></table></figure>

<p>修改镜像地址触发更新</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl edit sts web</span></span><br><span class="line">/image 回车</span><br><span class="line"><span class="comment"># 修改镜像</span></span><br><span class="line">      - image: nginx:1.15.3</span><br></pre></td></tr></table></figure>

<p>查看更新过程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po</span></span><br><span class="line">NAME                     READY   STATUS        RESTARTS       AGE</span><br><span class="line">web-0                    1/1     Running       0              58m</span><br><span class="line">web-1                    0/1     Terminating   1 (8h ago)     23h</span><br><span class="line">web-2                    1/1     Running       0              4s</span><br></pre></td></tr></table></figure>

<p>查看监控</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po -l app=nginx -w</span></span><br><span class="line">web-2                    1/1     Terminating   0            101s</span><br><span class="line">web-2                    0/1     Terminating   0            101s</span><br><span class="line">web-2                    0/1     Terminating   0            110s</span><br><span class="line">web-2                    0/1     Terminating   0            110s</span><br><span class="line">web-2                    0/1     Pending       0            0s</span><br><span class="line">web-2                    0/1     Pending       0            0s</span><br><span class="line">web-2                    0/1     ContainerCreating   0            0s</span><br><span class="line">web-2                    1/1     Running             0            2s</span><br><span class="line">web-1                    1/1     Terminating         0            102s</span><br><span class="line">web-1                    0/1     Terminating         0            103s</span><br><span class="line">web-1                    0/1     Terminating         0            110s</span><br><span class="line">web-1                    0/1     Terminating         0            110s</span><br><span class="line">web-1                    0/1     Pending             0            0s</span><br><span class="line">web-1                    0/1     Pending             0            0s</span><br><span class="line">web-1                    0/1     ContainerCreating   0            0s</span><br><span class="line">web-1                    1/1     Running             0            1s</span><br><span class="line">web-0                    1/1     Terminating         0            101s</span><br><span class="line">web-0                    0/1     Terminating         0            102s</span><br><span class="line">web-0                    0/1     Terminating         0            110s</span><br><span class="line">web-0                    0/1     Terminating         0            110s</span><br><span class="line">web-0                    0/1     Pending             0            0s</span><br><span class="line">web-0                    0/1     Pending             0            0s</span><br><span class="line">web-0                    0/1     ContainerCreating   0            0s</span><br><span class="line">web-0                    1/1     Running             0            1s</span><br></pre></td></tr></table></figure>



<h3 id="OnDelete"><a href="#OnDelete" class="headerlink" title="OnDelete"></a><strong>OnDelete</strong></h3><p>修改更新状态为OnDelete</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl edit sts web</span></span><br><span class="line"><span class="comment"># 修改以下内容</span></span><br><span class="line">  updateStrategy:</span><br><span class="line">    <span class="built_in">type</span>: OnDelete</span><br></pre></td></tr></table></figure>

<p>修改镜像地址</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl edit sts web</span></span><br><span class="line">/image 回车</span><br><span class="line"><span class="comment"># 修改镜像</span></span><br><span class="line">      - image: nginx:1.15.2</span><br></pre></td></tr></table></figure>

<p>查看pod，可以看到没有更新</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS       AGE</span><br><span class="line">web-0                    1/1     Running   0              3m26s</span><br><span class="line">web-1                    1/1     Running   0              3m36s</span><br><span class="line">web-2                    1/1     Running   0              3m49s</span><br></pre></td></tr></table></figure>

<p>手动删除pod触发更新</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl delete po web-2</span></span><br><span class="line">pod <span class="string">&quot;web-2&quot;</span> deleted</span><br></pre></td></tr></table></figure>

<p>查看pod</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS       AGE</span><br><span class="line">web-0                    1/1     Running   0              5m6s</span><br><span class="line">web-1                    1/1     Running   0              5m16s</span><br><span class="line">web-2                    1/1     Running   0              9s</span><br></pre></td></tr></table></figure>

<p>查看web-2镜像，可以看到更新成功</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po web-2 -oyaml | grep image</span></span><br><span class="line">  - image: nginx:1.15.2</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    image: nginx:1.15.2</span><br><span class="line">    imageID: docker-pullable://nginx@sha256:d85914d547a6c92faa39ce7058bd7529baacab7e0cd4255442b04577c4d1f424</span><br></pre></td></tr></table></figure>

<p>查看web-1镜像，可以看到没有更新，所以只有删除的时候才会更新镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po web-1 -oyaml | grep image</span></span><br><span class="line">  - image: nginx:1.15.3</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    image: nginx:1.15.3</span><br><span class="line">    imageID: docker-pullable://nginx@sha256:24a0c4b4a4c0eb97a1aabb8e29f18e917d05abfe1b7a7c07857230879ce7d3d3</span><br></pre></td></tr></table></figure>

<p>删除两个pod</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl delete po web-0 web-1</span></span><br><span class="line">pod <span class="string">&quot;web-0&quot;</span> deleted</span><br><span class="line">pod <span class="string">&quot;web-1&quot;</span> deleted</span><br></pre></td></tr></table></figure>

<p>查看监控，可以看到按照删除顺序创建</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">web-0                    0/1     Pending             0            0s</span><br><span class="line">web-0                    0/1     ContainerCreating   0            0s</span><br><span class="line">web-0                    1/1     Running             0            1s</span><br><span class="line">web-1                    0/1     Pending             0            0s</span><br><span class="line">web-1                    0/1     Pending             0            0s</span><br><span class="line">web-1                    0/1     ContainerCreating   0            0s</span><br><span class="line">web-1                    1/1     Running             0            1s</span><br></pre></td></tr></table></figure>

<p>查看所有pod镜像，可以看到三个pod的镜像都更新了</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master01</span> <span class="string">~</span>]<span class="comment"># kubectl get po -oyaml | grep image</span></span><br><span class="line">      <span class="attr">imageID:</span> <span class="string">docker-pullable://nginx@sha256:24a0c4b4a4c0eb97a1aabb8e29f18e917d05abfe1b7a7c07857230879ce7d3d3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.15.2</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.15.2</span></span><br><span class="line">      <span class="attr">imageID:</span> <span class="string">docker-pullable://nginx@sha256:d85914d547a6c92faa39ce7058bd7529baacab7e0cd4255442b04577c4d1f424</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.15.2</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.15.2</span></span><br><span class="line">      <span class="attr">imageID:</span> <span class="string">docker-pullable://nginx@sha256:d85914d547a6c92faa39ce7058bd7529baacab7e0cd4255442b04577c4d1f424</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.15.2</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.15.2</span></span><br><span class="line">      <span class="attr">imageID:</span> <span class="string">docker-pullable://nginx@sha256:d85914d547a6c92faa39ce7058bd7529baacab7e0cd4255442b04577c4d1f424</span></span><br></pre></td></tr></table></figure>



<h2 id="StatefulSet灰度发布"><a href="#StatefulSet灰度发布" class="headerlink" title="StatefulSet灰度发布"></a><strong>StatefulSet灰度发布</strong></h2><p>修改配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master01</span> <span class="string">~</span>]<span class="comment"># kubectl edit sts web</span></span><br><span class="line"><span class="comment"># 修改以下内容</span></span><br><span class="line">  <span class="attr">updateStrategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span> </span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">        <span class="attr">partition:</span> <span class="number">2</span> <span class="comment"># 小于2的不会被更新</span></span><br></pre></td></tr></table></figure>

<p>打开另一个窗口监控</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po -l app=nginx -w</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS       AGE</span><br><span class="line">web-0                    1/1     Running   0              44h</span><br><span class="line">web-1                    1/1     Running   0              44h</span><br><span class="line">web-2                    1/1     Running   0              44h</span><br></pre></td></tr></table></figure>

<p>修改镜像（nginx:1.15.2 -&gt; nginx:1.15.3）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl edit sts web</span></span><br><span class="line"><span class="comment"># 修改以下内容s</span></span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx:1.15.3</span><br></pre></td></tr></table></figure>

<p>查看监控，可以看到只有大于2的在更新</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po -l app=nginx -w</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS       AGE</span><br><span class="line">web-0                    1/1     Running   0              44h</span><br><span class="line">web-1                    1/1     Running   0              44h</span><br><span class="line">web-2                    1/1     Running   0              44h</span><br><span class="line">web-2                    1/1     Terminating   0              44h</span><br><span class="line">web-2                    0/1     Terminating   0              44h</span><br><span class="line">web-2                    0/1     Terminating   0              44h</span><br><span class="line">web-2                    0/1     Terminating   0              44h</span><br><span class="line">web-2                    0/1     Pending       0              0s</span><br><span class="line">web-2                    0/1     Pending       0              0s</span><br><span class="line">web-2                    0/1     ContainerCreating   0              0s</span><br><span class="line">web-2                    1/1     Running             0              3s</span><br></pre></td></tr></table></figure>

<p>查看镜像，可以看到web-2的镜像是nginx:1.15.3，另外两个是nginx:1.15.2</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master01</span> <span class="string">~</span>]<span class="comment"># kubectl get po -oyaml | grep image</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.15.2</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.15.2</span></span><br><span class="line">      <span class="attr">imageID:</span> <span class="string">docker-pullable://nginx@sha256:d85914d547a6c92faa39ce7058bd7529baacab7e0cd4255442b04577c4d1f424</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.15.2</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.15.2</span></span><br><span class="line">      <span class="attr">imageID:</span> <span class="string">docker-pullable://nginx@sha256:d85914d547a6c92faa39ce7058bd7529baacab7e0cd4255442b04577c4d1f424</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.15.3</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.15.3</span></span><br><span class="line">      <span class="attr">imageID:</span> <span class="string">docker-pullable://nginx@sha256:24a0c4b4a4c0eb97a1aabb8e29f18e917d05abfe1b7a7c07857230879ce7d3d3</span></span><br></pre></td></tr></table></figure>

<p>可以使用这种机制实现灰度机制，先发布一两个实例，确认没有问题之后再发布所有实例，这就是stateful的分段更新，相当于灰度发布的机制，也可以使用其它的方式，比如<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/tcm?from=10680">服务网格</a>，或者myservices</p>
<h2 id="StatefulSet级联删除和非级联删除"><a href="#StatefulSet级联删除和非级联删除" class="headerlink" title="StatefulSet级联删除和非级联删除"></a><strong>StatefulSet级联删除和非级联删除</strong></h2><ul>
<li>级联删除：删除sts时同时删除Pod</li>
<li>非级联删除：删除sts时不删Pod</li>
</ul>
<p>获取sts</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get sts</span></span><br><span class="line">NAME   READY   AGE</span><br><span class="line">web    3/3     2d20h</span><br></pre></td></tr></table></figure>

<p>级联删除</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl delete sts web</span></span><br><span class="line">statefulset.apps <span class="string">&quot;web&quot;</span> deleted</span><br></pre></td></tr></table></figure>

<p>查看pod</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po</span></span><br><span class="line">NAME                     READY   STATUS        RESTARTS       AGE</span><br><span class="line">web-0                    0/1     Terminating   0              45h</span><br><span class="line">web-1                    0/1     Terminating   0              45h</span><br><span class="line">web-2                    0/1     Terminating   0              11m</span><br></pre></td></tr></table></figure>

<p>创建pod</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl create -f nginx-sts.yaml</span></span><br><span class="line">statefulset.apps/web created</span><br><span class="line">Error from server (AlreadyExists): error when creating <span class="string">&quot;nginx-sts.yaml&quot;</span>: services <span class="string">&quot;nginx&quot;</span> already exists</span><br></pre></td></tr></table></figure>

<p>查看pod</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS       AGE</span><br><span class="line">web-0                    1/1     Running   0              7s</span><br><span class="line">web-1                    1/1     Running   0              5s</span><br></pre></td></tr></table></figure>

<p>非级联删除</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl delete sts web --cascade=false</span></span><br><span class="line">warning: --cascade=<span class="literal">false</span> is deprecated (boolean value) and can be replaced with --cascade=orphan.</span><br><span class="line">statefulset.apps <span class="string">&quot;web&quot;</span> deleted</span><br></pre></td></tr></table></figure>

<p>查看sts，可以看到sts被删除了</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get sts</span></span><br><span class="line">No resources found <span class="keyword">in</span> default namespace.</span><br></pre></td></tr></table></figure>

<p>查看pod，可以看到pod依然存在，只是没有sts管理了，再次删除pod不会被重新创建</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS       AGE</span><br><span class="line">web-0                    1/1     Running   0              3m37s</span><br><span class="line">web-1                    1/1     Running   0              3m35s</span><br></pre></td></tr></table></figure>

<p>删除web-1，web-0</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl delete po web-1 web-0</span></span><br><span class="line">pod <span class="string">&quot;web-1&quot;</span> deleted</span><br><span class="line">pod <span class="string">&quot;web-0&quot;</span> deleted</span><br></pre></td></tr></table></figure>

<p>查看pod，可以看到没有sts管理的pod，删除之后不会重新创建</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS         AGE</span><br></pre></td></tr></table></figure>



<h2 id="守护进程服务DaemonSet"><a href="#守护进程服务DaemonSet" class="headerlink" title="守护进程服务DaemonSet"></a><strong>守护进程服务DaemonSet</strong></h2><p>DaemonSet：守护进程集，缩写为ds，在所有节点或者是匹配的节点上都部署一个Pod。</p>
<p>使用DaemonSet的场景</p>
<ul>
<li>运行集群存储的daemon，比如ceph或者glusterd</li>
<li>节点的CNI网络插件，calico</li>
<li>节点日志的收集：fluentd或者是filebeat</li>
<li>节点的监控：node exporter</li>
<li>服务暴露：部署一个ingress nginx</li>
</ul>
<h2 id="DaemonSet的使用"><a href="#DaemonSet的使用" class="headerlink" title="DaemonSet的使用"></a><strong>DaemonSet的使用</strong></h2><p>新建DaemonSet</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master01</span> <span class="string">~</span>]<span class="comment"># cp nginx-deploy.yaml nginx-ds.yaml</span></span><br><span class="line">[<span class="string">root@k8s-master01</span> <span class="string">~</span>]<span class="comment"># vim nginx-ds.yaml </span></span><br><span class="line"><span class="comment"># 修改内容如下</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.15.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">        <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">      <span class="attr">securityContext:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>

<p>创建一个ds，因为没有配置notselect，所有它会在每个节点启动一个</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl create -f nginx-ds.yaml</span></span><br><span class="line">daemonset.apps/nginx created</span><br></pre></td></tr></table></figure>

<p>查看pod</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po -owide</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP               NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-2xtms              1/1     Running   0          90s     172.25.244.196   k8s-master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-66bbc9fdc5-4xqcw   1/1     Running   0          5m43s   172.25.244.195   k8s-master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-ct4xh              1/1     Running   0          90s     172.17.125.2     k8s-node01     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-hx9ws              1/1     Running   0          90s     172.27.14.195    k8s-node02     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-mjph9              1/1     Running   0          90s     172.18.195.2     k8s-master03   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-p64rf              1/1     Running   0          90s     172.25.92.67     k8s-master02   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>给需要部署的<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/tke?from=10680">容器</a>打标签</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl label node k8s-node01 k8s-node02 ds=true</span></span><br><span class="line">node/k8s-node01 labeled</span><br><span class="line">node/k8s-node02 labeled</span><br></pre></td></tr></table></figure>

<p>查看容器标签</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get node --show-labels</span></span><br><span class="line">NAME           STATUS   ROLES    AGE   VERSION   LABELS</span><br><span class="line">k8s-master01   Ready    &lt;none&gt;   3d    v1.20.9   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-master01,kubernetes.io/os=linux,node.kubernetes.io/node=</span><br><span class="line">k8s-master02   Ready    &lt;none&gt;   3d    v1.20.9   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-master02,kubernetes.io/os=linux,node.kubernetes.io/node=</span><br><span class="line">k8s-master03   Ready    &lt;none&gt;   3d    v1.20.9   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-master03,kubernetes.io/os=linux,node.kubernetes.io/node=</span><br><span class="line">k8s-node01     Ready    &lt;none&gt;   3d    v1.20.9   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,ds=<span class="literal">true</span>,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node01,kubernetes.io/os=linux,node.kubernetes.io/node=</span><br><span class="line">k8s-node02     Ready    &lt;none&gt;   3d    v1.20.9   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,ds=<span class="literal">true</span>,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node02,kubernetes.io/os=linux,node.kubernetes.io/node=</span><br></pre></td></tr></table></figure>

<p>修改nginx-ds.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master01</span> <span class="string">~</span>]<span class="comment"># vim nginx-ds.yaml</span></span><br><span class="line"><span class="comment">#修改以下内容</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">ds:</span> <span class="string">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>

<p>更新配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl replace -f nginx-ds.yaml</span></span><br></pre></td></tr></table></figure>

<p>查看pod，可以看到不符合标签的pod被删除了</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get po -owide</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE   IP               NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-66bbc9fdc5-4xqcw   1/1     Running   0          15m   172.25.244.195   k8s-master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-gd6sp              1/1     Running   0          44s   172.27.14.196    k8s-node02     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-pl4dz              1/1     Running   0          47s   172.17.125.3     k8s-node01     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>



<h2 id="DaemonSet的更新和回滚"><a href="#DaemonSet的更新和回滚" class="headerlink" title="DaemonSet的更新和回滚"></a><strong>DaemonSet的更新和回滚</strong></h2><p>Statefulset 和 DaemonSet 更新回滚和 Deployment 一致</p>
<p>更新策略推荐使用 OnDelete</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">updateStrategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">OnDelete</span></span><br></pre></td></tr></table></figure>

<p>因为 DaemonSet 可能部署在 k8s 集群的很多节点上，一开始先在一些节点上进行测试，删除后触发更新不影响其他节点</p>
<p>查看更新记录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout <span class="built_in">history</span> ds nginx</span><br></pre></td></tr></table></figure>



<h2 id="Label-amp-Selector"><a href="#Label-amp-Selector" class="headerlink" title="Label&amp;Selector"></a><strong>Label&amp;Selector</strong></h2><p>Label：对k8s中各种资源进行分类、分组，添加一个具有特别属性的一个标签</p>
<p>Selector：通过一个过滤的语法进行查找到对应标签的资源</p>
<p>当Kubernetes对系统的任何API对象如Pod和节点进行“分组”时，会对其添加Label（key&#x3D;value形式的“键-值对”）用以精准地选择对应的API对象。而Selector（标签选择器）则是针对匹配对象的查询方法。注：键-值对就是key-value pair</p>
<p>例如，常用的标签tier可用于区分容器的属性，如frontend、backend；或者一个release_track用于区分容器的环境，如canary、production等</p>
<h3 id="Label"><a href="#Label" class="headerlink" title="Label"></a><strong>Label</strong></h3><p>定义 Label</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl label node k8s-node02 region=subnet7</span></span><br><span class="line">node/k8s-node02 labeled</span><br></pre></td></tr></table></figure>

<p>通过Selector对其筛选</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get no -l region=subnet7</span></span><br><span class="line">NAME         STATUS   ROLES    AGE     VERSION</span><br><span class="line">k8s-node02   Ready    &lt;none&gt;   3d17h   v1.17.3</span><br></pre></td></tr></table></figure>

<p>在Deployment或其他控制器中指定将Pod部署到该节点</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line">  <span class="string">......</span></span><br><span class="line"><span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line"><span class="attr">nodeSelector:</span></span><br><span class="line">  <span class="attr">region:</span> <span class="string">subnet7</span></span><br><span class="line"><span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="string">......</span></span><br></pre></td></tr></table></figure>

<p>对Service进行Label</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl label svc canary-v1 -n canary-production env=canary version=v1</span></span><br><span class="line">service/canary-v1 labeled</span><br></pre></td></tr></table></figure>

<p>查看Labels</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get svc -n canary-production --show-labels</span></span><br><span class="line">NAME        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE   LABELS</span><br><span class="line">canary-v1   ClusterIP   10.110.253.62   &lt;none&gt;        8080/TCP   24h   <span class="built_in">env</span>=canary,version=v1</span><br></pre></td></tr></table></figure>

<p>查看所有Version为v1的svc</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 canary]<span class="comment"># kubectl get svc --all-namespaces -l version=v1</span></span><br><span class="line">NAMESPACE           NAME        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">canary-production   canary-v1   ClusterIP   10.110.253.62   &lt;none&gt;        8080/TCP   25h</span><br></pre></td></tr></table></figure>



<h3 id="Selector"><a href="#Selector" class="headerlink" title="Selector"></a><strong>Selector</strong></h3><p>Selector主要用于资源的匹配，只有符合条件的资源才会被调用或使用，可以使用该方式对集群中的各类资源进行分配</p>
<p>假如对Selector进行条件匹配，目前已有的Label如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get svc --show-labels</span></span><br><span class="line">NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE     LABELS</span><br><span class="line">details       ClusterIP   10.99.9.178      &lt;none&gt;        9080/TCP   45h     app=details</span><br><span class="line">kubernetes    ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP    3d19h   component=apiserver,provider=kubernetes</span><br><span class="line">nginx         ClusterIP   10.106.194.137   &lt;none&gt;        80/TCP     2d21h   app=productpage,version=v1</span><br><span class="line">nginx-v2      ClusterIP   10.108.176.132   &lt;none&gt;        80/TCP     2d20h   &lt;none&gt;</span><br><span class="line">productpage   ClusterIP   10.105.229.52    &lt;none&gt;        9080/TCP   45h     app=productpage,tier=frontend</span><br><span class="line">ratings       ClusterIP   10.96.104.95     &lt;none&gt;        9080/TCP   45h     app=ratings</span><br><span class="line">reviews       ClusterIP   10.102.188.143   &lt;none&gt;        9080/TCP   45h     app=reviews</span><br></pre></td></tr></table></figure>



<p>选择app为reviews或者productpage的svc</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get svc -l  &#x27;app in (details, productpage)&#x27; --show-labels</span></span><br><span class="line">NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE     LABELS</span><br><span class="line">details       ClusterIP   10.99.9.178      &lt;none&gt;        9080/TCP   45h     app=details</span><br><span class="line">nginx         ClusterIP   10.106.194.137   &lt;none&gt;        80/TCP     2d21h   app=productpage,version=v1</span><br><span class="line">productpage   ClusterIP   10.105.229.52    &lt;none&gt;        9080/TCP   45h     app=productpage,tier=frontend</span><br></pre></td></tr></table></figure>



<p>选择app为productpage或reviews但不包括version&#x3D;v1的svc</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get svc -l  version!=v1,&#x27;app in (details, productpage)&#x27; --show-labels</span></span><br><span class="line">NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE   LABELS</span><br><span class="line">details       ClusterIP   10.99.9.178     &lt;none&gt;        9080/TCP   45h   app=details</span><br><span class="line">productpage   ClusterIP   10.105.229.52   &lt;none&gt;        9080/TCP   45h   app=productpage,tier=frontend</span><br></pre></td></tr></table></figure>



<p>选择labelkey名为app的svc</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get svc -l app --show-labels</span></span><br><span class="line">NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE     LABELS</span><br><span class="line">details       ClusterIP   10.99.9.178      &lt;none&gt;        9080/TCP   45h     app=details</span><br><span class="line">nginx         ClusterIP   10.106.194.137   &lt;none&gt;        80/TCP     2d21h   app=productpage,version=v1</span><br><span class="line">productpage   ClusterIP   10.105.229.52    &lt;none&gt;        9080/TCP   45h     app=productpage,tier=frontend</span><br><span class="line">ratings       ClusterIP   10.96.104.95     &lt;none&gt;        9080/TCP   45h     app=ratings</span><br><span class="line">reviews       ClusterIP   10.102.188.143   &lt;none&gt;        9080/TCP   45h     app=reviews</span><br></pre></td></tr></table></figure>

<p>在实际使用中，Label的更改是经常发生的事情，可以使用overwrite参数修改标签</p>
<p>修改标签，比如将version&#x3D;v1改为version&#x3D;v2</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 canary]<span class="comment"># kubectl get svc -n canary-production --show-labels</span></span><br><span class="line">NAME        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE   LABELS</span><br><span class="line">canary-v1   ClusterIP   10.110.253.62   &lt;none&gt;        8080/TCP   26h   <span class="built_in">env</span>=canary,version=v1</span><br><span class="line">[root@k8s-master01 canary]<span class="comment"># kubectl label svc canary-v1 -n canary-production version=v2 --overwrite</span></span><br><span class="line">service/canary-v1 labeled</span><br><span class="line">[root@k8s-master01 canary]<span class="comment"># kubectl get svc -n canary-production --show-labels</span></span><br><span class="line">NAME        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE   LABELS</span><br><span class="line">canary-v1   ClusterIP   10.110.253.62   &lt;none&gt;        8080/TCP   26h   <span class="built_in">env</span>=canary,version=v2</span><br></pre></td></tr></table></figure>

<p>删除标签，比如删除version</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 canary]<span class="comment"># kubectl label svc canary-v1 -n canary-production version-</span></span><br><span class="line">service/canary-v1 labeled</span><br><span class="line">[root@k8s-master01 canary]<span class="comment"># kubectl get svc -n canary-production --show-labels</span></span><br><span class="line">NAME        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE   LABELS</span><br><span class="line">canary-v1   ClusterIP   10.110.253.62   &lt;none&gt;        8080/TCP   26h   <span class="built_in">env</span>=canary</span><br></pre></td></tr></table></figure>



<h2 id="什么是HPA？"><a href="#什么是HPA？" class="headerlink" title="什么是HPA？"></a><strong>什么是HPA？</strong></h2><p>Horizontal Pod Autoscaler</p>
<p>水平 pod 自动伸缩器</p>
<p>k8s 不推荐使用 VPA，因为节点有很多，推荐将流量分发到不同的节点上，而不是分发到同一个节点上</p>
<ul>
<li>HPA v1为稳定版自动水平伸缩，只支持CPU指标</li>
<li>V2为beta版本，分为v2beta1(支持CPU、内存和自定义指标)</li>
<li>v2beta2(支持CPU、内存、自定义指标Custom和额外指标ExternalMetrics)</li>
</ul>
<h2 id="自动扩缩容HPA实践"><a href="#自动扩缩容HPA实践" class="headerlink" title="自动扩缩容HPA实践"></a><strong>自动扩缩容HPA实践</strong></h2><ul>
<li>必须安装metrics-server或其他自定义metrics-server</li>
<li>必须配置requests参数</li>
<li>不能扩容无法缩放的对象，比如DaemonSet</li>
</ul>
<p>dry-run导出yaml文件，以便于进行二次修改</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment hpa-nginx --image=registry.cn-beijing.aliyuncs.com/dotbalo/nginx --dry-run=client -oyaml &gt; hpa-nginx.yaml</span><br></pre></td></tr></table></figure>



<p>编辑文件 hpa-nginx.yaml，containers 添加参数</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">image:</span> <span class="string">registry.cn-beijing.aliyuncs.com/dotbalo/nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">10m</span></span><br></pre></td></tr></table></figure>



<p>创建</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create hpa-nginx.yaml</span><br></pre></td></tr></table></figure>



<p>暴露一个服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose deployment hpa-nginx --port=80</span><br></pre></td></tr></table></figure>



<p>配置autoscale</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl autoscale deployment hpa-nginx --cpu-percent=10 --min=1 --max=10</span><br></pre></td></tr></table></figure>



<p>循环执行提高cpu，暂停后cpu下降</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> wget -q -O- <span class="attr">http</span>:<span class="comment">//192.168.42.44 &gt; /dev/null; done</span></span><br></pre></td></tr></table></figure>





<h3 id="什么是Service？"><a href="#什么是Service？" class="headerlink" title="什么是Service？"></a><a target="_blank" rel="noopener" href="https://www.cnblogs.com/hsyw/p/14195074.html">什么是Service？</a></h3><p>Service可以简单的理解为逻辑上的一组Pod。一种可以访问Pod的策略，而且其他Pod可以通过这个Service访问到这个Service代理的Pod。相对于Pod而言，它会有一个固定的名称，一旦创建就固定不变。</p>
<p>可以简单的理解成访问一个或者一组Pod的时候，先访问service再去访的IP的,service的名称的固定的，不管你怎么重启Pod，Pod的IP怎么改变，都不影响用户的使用</p>
<h3 id="创建一个简单的Service"><a href="#创建一个简单的Service" class="headerlink" title="创建一个简单的Service"></a>创建一个简单的Service</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master01</span> <span class="string">~</span>]<span class="comment"># cat nginx-svc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-svc</span>    <span class="comment">#service 标签名字</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-svc</span>	  <span class="comment">#service 固定名字</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span> 		<span class="comment"># Service端口的名称</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span> 	    <span class="comment"># Service自己的端口, servicea --&gt; serviceb http://serviceb,  http://serviceb:8080 </span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span>   <span class="comment"># UDP TCP SCTP default: TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span>  <span class="comment"># 后端应用的端口</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span>     </span><br><span class="line">    <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">443</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 创建一个service</span></span><br><span class="line">[<span class="string">root@k8s-master01</span> <span class="string">~</span>]<span class="comment"># kubectl create -f nginx-svc.yaml </span></span><br></pre></td></tr></table></figure>



<h3 id="使用Service代理k8s外部应用"><a href="#使用Service代理k8s外部应用" class="headerlink" title="使用Service代理k8s外部应用"></a>使用Service代理k8s外部应用</h3><p><strong>使用场景：</strong></p>
<p>希望在生产环境中使用某个固定的名称而非IP地址进行访问外部的中间件服务</p>
<p>希望Service指向另一个Namespace中或其他集群中的服务</p>
<p>某个项目正在迁移至k8s集群，但是一部分服务仍然在集群外部，此时可以使用service代理至k8s集群外部的服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个类型为external的service（svc），这个svc不会自动创建一个ep</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># vim nginx-svc-external.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-svc-external</span><br><span class="line">  name: nginx-svc-external</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: http <span class="comment"># Service端口的名称</span></span><br><span class="line">    port: 80 <span class="comment"># Service自己的端口, servicea --&gt; serviceb http://serviceb,  http://serviceb:8080 </span></span><br><span class="line">    protocol: TCP <span class="comment"># UDP TCP SCTP default: TCP</span></span><br><span class="line">    targetPort: 80 <span class="comment"># 后端应用的端口</span></span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line"></span><br><span class="line"><span class="comment"># create svc</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl create -f nginx-svc-external.yaml </span></span><br><span class="line">service/nginx-svc-external created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看svc</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get svc</span></span><br><span class="line">NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">kubernetes           ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP          6d4h</span><br><span class="line">nginx-svc            ClusterIP   10.96.141.65    &lt;none&gt;        80/TCP,443/TCP   4d3h</span><br><span class="line">nginx-svc-external   ClusterIP   10.109.18.238   &lt;none&gt;        80/TCP           16s</span><br><span class="line"><span class="comment"># 手动创建一个ep，跟上面创建的svc关联起来</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># vim nginx-ep-external.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-svc-external   <span class="comment">#名字要跟svc的一致</span></span><br><span class="line">  name: nginx-svc-external</span><br><span class="line">  namespace: default</span><br><span class="line">subsets:</span><br><span class="line">- addresses:</span><br><span class="line">  - ip: 220.181.38.148 </span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">   </span><br><span class="line"><span class="comment"># create ep</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl create -f nginx-ep-external.yaml</span></span><br><span class="line">endpoints/nginx-svc-external created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看ep (EP后面对应的列表就是可用Pod的列表)</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># kubectl get ep</span></span><br><span class="line">NAME                 ENDPOINTS                                                               AGE</span><br><span class="line">kubernetes           192.168.1.100:6443,192.168.1.101:6443,192.168.1.102:6443                6d4h</span><br><span class="line">nginx-svc            172.161.125.15:443,172.162.195.15:443,172.169.244.194:443 + 9 more...   4d3h</span><br><span class="line">nginx-svc-external   220.181.38.148:80                                                       35s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问ep</span></span><br><span class="line">[root@k8s-master01 ~]<span class="comment"># curl 220.181.38.148:80 -I</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Sat, 26 Dec 2020 16:00:57 GMT</span><br><span class="line">Server: Apache</span><br><span class="line">Last-Modified: Tue, 12 Jan 2010 13:48:00 GMT</span><br><span class="line">ETag: <span class="string">&quot;51-47cf7e6ee8400&quot;</span></span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line">Content-Length: 81</span><br><span class="line">Cache-Control: max-age=86400</span><br><span class="line">Expires: Sun, 27 Dec 2020 16:00:57 GMT</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Content-Type: text/html</span><br></pre></td></tr></table></figure>



<h3 id="四、使用Service反代域名"><a href="#四、使用Service反代域名" class="headerlink" title="四、使用Service反代域名"></a>四、使用Service反代域名</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; nginx-externalName.yaml  &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-externalname</span><br><span class="line">  name: nginx-externalname</span><br><span class="line">spec:</span><br><span class="line">  type: ExternalName</span><br><span class="line">  externalName: www.baidu.com</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">create svc</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl create -f nginx-externalName.yaml</span><br><span class="line">service/nginx-externalname created</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看svc</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl get svc</span><br><span class="line">NAME                 TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)          AGE</span><br><span class="line">kubernetes           ClusterIP      10.96.0.1       &lt;none&gt;          443/TCP          6d4h</span><br><span class="line">nginx-externalname   ExternalName   &lt;none&gt;          www.baidu.com   &lt;none&gt;           27s</span><br><span class="line">nginx-svc            ClusterIP      10.96.141.65    &lt;none&gt;          80/TCP,443/TCP   4d3h</span><br><span class="line">nginx-svc-external   ClusterIP      10.109.18.238   &lt;none&gt;          80/TCP           18m</span><br></pre></td></tr></table></figure>



<h3 id="SVC类型"><a href="#SVC类型" class="headerlink" title="SVC类型"></a>SVC类型</h3><p>ClusterIP：在集群内部使用，也是默认值</p>
<p>ExternalName：通过返回定义的CNAME别名</p>
<p>NodePort：在所有安装了kube-proxy的节点上打开一个端口，此端口可以代理至后端Pod，然后集群外部可以使用节点的IP地址和NodePort的端口号访问到集群Pod的服务。NodePort端口范围默认是30000-32767</p>
<p>LoadBalancer：使用云提供商的负载均衡器公开服务</p>
<h3 id="一、什么是Ingress？"><a href="#一、什么是Ingress？" class="headerlink" title="一、什么是Ingress？"></a>一、什么是Ingress？</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">通俗来讲，ingress和之前提到的Service、Deployment，也是一个k8s的资源类型，ingress用于实现用域名的方式访问k8s内部应用</span><br><span class="line">管理对集群中的服务(通常是HTTP)的外部访问的API对象。Ingress可以提供负载平衡、SSL终端和基于名称的虚拟主机</span><br></pre></td></tr></table></figure>

<h3 id="二、Ingress安装"><a href="#二、Ingress安装" class="headerlink" title="二、Ingress安装"></a>二、Ingress安装</h3><h4 id="2-1、首先安装helm管理工具"><a href="#2-1、首先安装helm管理工具" class="headerlink" title="2.1、首先安装helm管理工具"></a>2.1、首先安装helm管理工具</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1、下载</span></span><br><span class="line">[root@k8s-master01 ~]# wget https://get.helm.sh/helm-v3.4.2-linux-amd64.tar.gz</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2、安装</span></span><br><span class="line">[root@k8s-master01 ~]# tar -zxvf helm-v3.4.2-linux-amd64.tar.gz </span><br><span class="line">[root@k8s-master01 ~]# mv linux-amd64/helm /usr/local/bin/helm</span><br></pre></td></tr></table></figure>

<h4 id="2-2、使用helm安装ingress"><a href="#2-2、使用helm安装ingress" class="headerlink" title="2.2、使用helm安装ingress"></a>2.2、使用helm安装ingress</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1、添加ingress的helm仓库</span></span><br><span class="line">[root@k8s-master01 ~]# helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx</span><br><span class="line">&quot;ingress-nginx&quot; has been added to your repositories</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2、下载ingress的helm包至本地（helm pull ingress-nginx/ingress-nginx --version 3.6.0---指定版本下载）</span></span><br><span class="line">[root@k8s-master01 ~]# mkdir /helm_images &amp;&amp; cd /helm_images</span><br><span class="line">[root@k8s-master01 helm_images]# helm pull ingress-nginx/ingress-nginx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3、更改对应的配置</span></span><br><span class="line">[root@k8s-master01 helm_images]# tar -zxvf ingress-nginx-3.17.0.tgz &amp;&amp; cd ingress-nginx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4、需要修改的位置</span></span><br><span class="line">	a)	Controller和admissionWebhook的镜像地址，需要将公网镜像同步至公司内网镜像仓库</span><br><span class="line">	b)	hostNetwork设置为true</span><br><span class="line">	c)	dnsPolicy设置为 ClusterFirstWithHostNet</span><br><span class="line">	d)	NodeSelector添加ingress: &quot;true&quot;部署至指定节点</span><br><span class="line">	e)	类型更改为kind: DaemonSet</span><br><span class="line">	f)  镜像仓库地址需要改2处</span><br><span class="line">	</span><br><span class="line">	修改完成后的文件：</span><br><span class="line">	controller:</span><br><span class="line">  name: controller</span><br><span class="line">  image:</span><br><span class="line">    repository: registry.cn-beijing.aliyuncs.com/dotbalo/controller #修改</span><br><span class="line">    tag: &quot;v0.40.2&quot;</span><br><span class="line">    digest: xxx #注释digest</span><br><span class="line">    pullPolicy: IfNotPresent</span><br><span class="line">    runAsUser: 101</span><br><span class="line">    allowPrivilegeEscalation: true</span><br><span class="line">  containerPort:</span><br><span class="line">    http: 80</span><br><span class="line">    https: 443</span><br><span class="line">  config: &#123;&#125;</span><br><span class="line">  configAnnotations: &#123;&#125;</span><br><span class="line">  proxySetHeaders: &#123;&#125;</span><br><span class="line">  addHeaders: &#123;&#125;</span><br><span class="line">  dnsConfig: &#123;&#125;</span><br><span class="line">  dnsPolicy: ClusterFirstWithHostNet #修改</span><br><span class="line">  reportNodeInternalIp: false</span><br><span class="line">  hostNetwork: true #修改</span><br><span class="line">  hostPort:</span><br><span class="line">    enabled: false</span><br><span class="line">    ports:</span><br><span class="line">      http: 80</span><br><span class="line">      https: 443</span><br><span class="line">  electionID: ingress-controller-leader</span><br><span class="line">  ingressClass: nginx</span><br><span class="line">  podLabels: &#123;&#125;</span><br><span class="line">  podSecurityContext: &#123;&#125;</span><br><span class="line">  sysctls: &#123;&#125;</span><br><span class="line">  publishService:</span><br><span class="line">    enabled: true</span><br><span class="line">    pathOverride: &quot;&quot;</span><br><span class="line">  scope:</span><br><span class="line">    enabled: false</span><br><span class="line">  tcp:</span><br><span class="line">    annotations: &#123;&#125;</span><br><span class="line">  udp:</span><br><span class="line">    annotations: &#123;&#125;</span><br><span class="line">  maxmindLicenseKey: &quot;&quot;</span><br><span class="line">  extraArgs: &#123;&#125;</span><br><span class="line">  extraEnvs: []</span><br><span class="line">  kind: DaemonSet  #修改</span><br><span class="line">  annotations: &#123;&#125;</span><br><span class="line">  labels: &#123;&#125;</span><br><span class="line">  updateStrategy: &#123;&#125;</span><br><span class="line">  minReadySeconds: 0</span><br><span class="line">  tolerations: []</span><br><span class="line">  affinity: &#123;&#125;</span><br><span class="line">  topologySpreadConstraints: []</span><br><span class="line">  terminationGracePeriodSeconds: 300</span><br><span class="line">  nodeSelector:</span><br><span class="line">    kubernetes.io/os: linux</span><br><span class="line">    ingress: &quot;true&quot; #修改</span><br><span class="line">  livenessProbe:</span><br><span class="line">    failureThreshold: 5</span><br><span class="line">    initialDelaySeconds: 10</span><br><span class="line">    periodSeconds: 10</span><br><span class="line">    successThreshold: 1</span><br><span class="line">    timeoutSeconds: 1</span><br><span class="line">    port: 10254</span><br><span class="line">  readinessProbe:</span><br><span class="line">    failureThreshold: 3</span><br><span class="line">    initialDelaySeconds: 10</span><br><span class="line">    periodSeconds: 10</span><br><span class="line">    successThreshold: 1</span><br><span class="line">    timeoutSeconds: 1</span><br><span class="line">    port: 10254</span><br><span class="line">  healthCheckPath: &quot;/healthz&quot;</span><br><span class="line">  podAnnotations: &#123;&#125;</span><br><span class="line">  replicaCount: 1</span><br><span class="line">  minAvailable: 1</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      cpu: 100m</span><br><span class="line">      memory: 90Mi</span><br><span class="line">  autoscaling:</span><br><span class="line">    enabled: false</span><br><span class="line">    minReplicas: 1</span><br><span class="line">    maxReplicas: 11</span><br><span class="line">    targetCPUUtilizationPercentage: 50</span><br><span class="line">    targetMemoryUtilizationPercentage: 50</span><br><span class="line">  autoscalingTemplate: []</span><br><span class="line">  keda:</span><br><span class="line">    apiVersion: &quot;keda.sh/v1alpha1&quot;</span><br><span class="line">    enabled: false</span><br><span class="line">    minReplicas: 1</span><br><span class="line">    maxReplicas: 11</span><br><span class="line">    pollingInterval: 30</span><br><span class="line">    cooldownPeriod: 300</span><br><span class="line">    restoreToOriginalReplicaCount: false</span><br><span class="line">    triggers: []</span><br><span class="line">    behavior: &#123;&#125;</span><br><span class="line">  enableMimalloc: true</span><br><span class="line">  customTemplate:</span><br><span class="line">    configMapName: &quot;&quot;</span><br><span class="line">    configMapKey: &quot;&quot;</span><br><span class="line">  service:</span><br><span class="line">    enabled: true</span><br><span class="line">    annotations: &#123;&#125;</span><br><span class="line">    labels: &#123;&#125;</span><br><span class="line">    externalIPs: []</span><br><span class="line">    loadBalancerSourceRanges: []</span><br><span class="line">    enableHttp: true</span><br><span class="line">    enableHttps: true</span><br><span class="line">    ports:</span><br><span class="line">      http: 80</span><br><span class="line">      https: 443</span><br><span class="line">    targetPorts:</span><br><span class="line">      http: http</span><br><span class="line">      https: https</span><br><span class="line">    type: ClusterIP  #修改</span><br><span class="line">    nodePorts:</span><br><span class="line">      http: &quot;&quot;</span><br><span class="line">      https: &quot;&quot;</span><br><span class="line">      tcp: &#123;&#125;</span><br><span class="line">      udp: &#123;&#125;</span><br><span class="line">    internal:</span><br><span class="line">      enabled: false</span><br><span class="line">      annotations: &#123;&#125;</span><br><span class="line">      loadBalancerSourceRanges: []</span><br><span class="line">  extraContainers: []</span><br><span class="line">  extraVolumeMounts: []</span><br><span class="line">  extraVolumes: []</span><br><span class="line">  extraInitContainers: []</span><br><span class="line">  admissionWebhooks:</span><br><span class="line">    annotations: &#123;&#125;</span><br><span class="line">    enabled: true</span><br><span class="line">    failurePolicy: Fail</span><br><span class="line">    port: 8443</span><br><span class="line">    certificate: &quot;/usr/local/certificates/cert&quot;</span><br><span class="line">    key: &quot;/usr/local/certificates/key&quot;</span><br><span class="line">    namespaceSelector: &#123;&#125;</span><br><span class="line">    objectSelector: &#123;&#125;</span><br><span class="line">    service:</span><br><span class="line">      annotations: &#123;&#125;</span><br><span class="line">      externalIPs: []</span><br><span class="line">      loadBalancerSourceRanges: []</span><br><span class="line">      servicePort: 443</span><br><span class="line">      type: ClusterIP</span><br><span class="line">    patch:</span><br><span class="line">      enabled: true</span><br><span class="line">      image:</span><br><span class="line">        repository: registry.cn-beijing.aliyuncs.com/dotbalo/kube-webhook-certgen #修改</span><br><span class="line">        tag: v1.3.0</span><br><span class="line">        pullPolicy: IfNotPresent</span><br><span class="line">      priorityClassName: &quot;&quot;</span><br><span class="line">      podAnnotations: &#123;&#125;</span><br><span class="line">      nodeSelector: &#123;&#125;</span><br><span class="line">      tolerations: []</span><br><span class="line">      runAsUser: 2000</span><br><span class="line">  metrics:</span><br><span class="line">    port: 10254</span><br><span class="line">    enabled: false</span><br><span class="line">    service:</span><br><span class="line">      annotations: &#123;&#125;</span><br><span class="line">      externalIPs: []</span><br><span class="line">      loadBalancerSourceRanges: []</span><br><span class="line">      servicePort: 9913</span><br><span class="line">      type: ClusterIP</span><br><span class="line">    serviceMonitor:</span><br><span class="line">      enabled: false</span><br><span class="line">      additionalLabels: &#123;&#125;</span><br><span class="line">      namespace: &quot;&quot;</span><br><span class="line">      namespaceSelector: &#123;&#125;</span><br><span class="line">      scrapeInterval: 30s</span><br><span class="line">      targetLabels: []</span><br><span class="line">      metricRelabelings: []</span><br><span class="line">    prometheusRule:</span><br><span class="line">      enabled: false</span><br><span class="line">      additionalLabels: &#123;&#125;</span><br><span class="line">      rules: []</span><br><span class="line">  lifecycle:</span><br><span class="line">    preStop:</span><br><span class="line">      exec:</span><br><span class="line">        command:</span><br><span class="line">          - /wait-shutdown</span><br><span class="line">  priorityClassName: &quot;&quot;</span><br><span class="line">revisionHistoryLimit: 10</span><br><span class="line">defaultBackend:</span><br><span class="line">  enabled: false</span><br><span class="line">  name: defaultbackend</span><br><span class="line">  image:</span><br><span class="line">    repository: k8s.gcr.io/defaultbackend-amd64</span><br><span class="line">    tag: &quot;1.5&quot;</span><br><span class="line">    pullPolicy: IfNotPresent</span><br><span class="line">    runAsUser: 65534</span><br><span class="line">    runAsNonRoot: true</span><br><span class="line">    readOnlyRootFilesystem: true</span><br><span class="line">    allowPrivilegeEscalation: false</span><br><span class="line">  extraArgs: &#123;&#125;</span><br><span class="line">  serviceAccount:</span><br><span class="line">    create: true</span><br><span class="line">    name:</span><br><span class="line">  extraEnvs: []</span><br><span class="line">  port: 8080</span><br><span class="line">  livenessProbe:</span><br><span class="line">    failureThreshold: 3</span><br><span class="line">    initialDelaySeconds: 30</span><br><span class="line">    periodSeconds: 10</span><br><span class="line">    successThreshold: 1</span><br><span class="line">    timeoutSeconds: 5</span><br><span class="line">  readinessProbe:</span><br><span class="line">    failureThreshold: 6</span><br><span class="line">    initialDelaySeconds: 0</span><br><span class="line">    periodSeconds: 5</span><br><span class="line">    successThreshold: 1</span><br><span class="line">    timeoutSeconds: 5</span><br><span class="line">  tolerations: []</span><br><span class="line">  affinity: &#123;&#125;</span><br><span class="line">  podSecurityContext: &#123;&#125;</span><br><span class="line">  podLabels: &#123;&#125;</span><br><span class="line">  nodeSelector: &#123;&#125;</span><br><span class="line">  podAnnotations: &#123;&#125;</span><br><span class="line">  replicaCount: 1</span><br><span class="line">  minAvailable: 1</span><br><span class="line">  resources: &#123;&#125;</span><br><span class="line">  autoscaling:</span><br><span class="line">    enabled: false</span><br><span class="line">    minReplicas: 1</span><br><span class="line">    maxReplicas: 2</span><br><span class="line">    targetCPUUtilizationPercentage: 50</span><br><span class="line">    targetMemoryUtilizationPercentage: 50</span><br><span class="line">  service:</span><br><span class="line">    annotations: &#123;&#125;</span><br><span class="line">    externalIPs: []</span><br><span class="line">    loadBalancerSourceRanges: []</span><br><span class="line">    servicePort: 80</span><br><span class="line">    type: ClusterIP</span><br><span class="line">  priorityClassName: &quot;&quot;</span><br><span class="line">rbac:</span><br><span class="line">  create: true</span><br><span class="line">  scope: false</span><br><span class="line">podSecurityPolicy:</span><br><span class="line">  enabled: false</span><br><span class="line">serviceAccount:</span><br><span class="line">  create: true</span><br><span class="line">  name:</span><br><span class="line">imagePullSecrets: []</span><br><span class="line">tcp: &#123;&#125;</span><br><span class="line">udp: &#123;&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">5、部署ingress，给需要部署ingress的节点上打标签，这样就能指定要部署的节点了</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl label node k8s-master03 ingress=true</span><br><span class="line">node/k8s-master03 labeled</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建一个ns</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl create ns ingress-nginx</span><br><span class="line">namespace/ingress-nginx created</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">部署ingress</span></span><br><span class="line">[root@k8s-master01 ingress-nginx]# helm install ingress-nginx -n ingress-nginx .</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看刚刚构建的ingress</span></span><br><span class="line">[root@k8s-master01 ingress-nginx]# kubectl get  pod -n ingress-nginx </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ingress扩容与缩容，只需要给想要扩容的节点加标签就行，缩容就把节点标签去除即可</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl label node k8s-master02 ingress=true</span><br><span class="line">node/k8s-master02 labeled</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 ~]# kubectl label node k8s-master03 ingress-</span><br><span class="line">node/k8s-master03 labeled</span><br></pre></td></tr></table></figure>

<h4 id="2-3、Ingress入门使用"><a href="#2-3、Ingress入门使用" class="headerlink" title="2.3、Ingress入门使用"></a>2.3、Ingress入门使用</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建一个ingress</span></span><br><span class="line">cat &gt; ingress.yaml &lt;&lt; EFO</span><br><span class="line">apiVersion: networking.k8s.io/v1beta1 # networking.k8s.io/v1 / extensions/v1beta1 </span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;</span><br><span class="line">  name: example</span><br><span class="line">spec:</span><br><span class="line">  rules: # 一个Ingress可以配置多个rules</span><br><span class="line">  - host: foo.bar.com # 域名配置，可以不写，匹配*， *.bar.com</span><br><span class="line">    http:</span><br><span class="line">      paths: # 相当于nginx的location配合，同一个host可以配置多个path / /abc</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: nginx-svc </span><br><span class="line">          servicePort: 80</span><br><span class="line">        path: /</span><br><span class="line">EFO</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl create -f ingress.yaml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建一个多域名ingress</span></span><br><span class="line">cat ingress-mulDomain.yaml </span><br><span class="line">apiVersion: networking.k8s.io/v1beta1 # networking.k8s.io/v1 / extensions/v1beta1 </span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;</span><br><span class="line">  name: example</span><br><span class="line">spec:</span><br><span class="line">  rules: # 一个Ingress可以配置多个rules</span><br><span class="line">  - host: foo.bar.com # 域名配置，可以不写，匹配*， *.bar.com</span><br><span class="line">    http:</span><br><span class="line">      paths: # 相当于nginx的location配合，同一个host可以配置多个path / /abc</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: nginx-svc </span><br><span class="line">          servicePort: 80</span><br><span class="line">        path: /</span><br><span class="line">  - host: foo2.bar.com # 域名配置，可以不写，匹配*， *.bar.com</span><br><span class="line">    http:</span><br><span class="line">      paths: # 相当于nginx的location配合，同一个host可以配置多个path / /abc</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: nginx-svc-external</span><br><span class="line">          servicePort: 80</span><br><span class="line">        path: /</span><br></pre></td></tr></table></figure>





<p>ConfigMap</p>
<p>一般用ConfigMap去管理一些配置文件，或者一些大量的环境变量信息。</p>
<p>ConfigMap将配置和Pod分开，有一个nginx，nginx.conf -&gt; configmap。更易于配置文件的更改和管理。</p>
<p>Secret：Secret更倾向于存储和共享敏感、加密的配置信息。</p>
<p>ConfigMap中文地址：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-pod-configmap/">https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-pod-configmap/</a></p>
<p>生成special-config的configmap</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap special-config --from-literal=special.how=very</span><br></pre></td></tr></table></figure>


<p>test-env-pod.yaml</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: dapi-test-pod</span><br><span class="line">spec:</span><br><span class="line">  nodeName: k8s-node01</span><br><span class="line">  containers:</span><br><span class="line">    - name: test-container</span><br><span class="line">      image: busybox:1.28</span><br><span class="line">      imagePullPolicy: IfNotPresent</span><br><span class="line">      <span class="built_in">command</span>: [ <span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;env&quot;</span> ]</span><br><span class="line">      envFrom:</span><br><span class="line">      - configMapRef:</span><br><span class="line">          name: special-config</span><br><span class="line">      <span class="built_in">env</span>:</span><br><span class="line">        <span class="comment"># Define the environment variable</span></span><br><span class="line">        <span class="comment"># - name: SPECIAL_LEVEL_KEY</span></span><br><span class="line">        <span class="comment">#   valueFrom:</span></span><br><span class="line">        <span class="comment">#     configMapKeyRef:</span></span><br><span class="line">        <span class="comment">#       # The ConfigMap containing the value you want to assign to SPECIAL_LEVEL_KEY</span></span><br><span class="line">        <span class="comment">#       name: special-config</span></span><br><span class="line">        <span class="comment">#       # Specify the key associated with the value</span></span><br><span class="line">        <span class="comment">#       key: special.how</span></span><br><span class="line">        - name: <span class="built_in">test</span></span><br><span class="line">          value: test-value</span><br><span class="line">        - name: mysqlHostAddress</span><br><span class="line">          value: 10.10.10.10</span><br><span class="line">        - name: mysqlPort</span><br><span class="line">          value: <span class="string">&quot;3306&quot;</span> <span class="comment"># only string</span></span><br><span class="line">  restartPolicy: Never</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master-lb</span> <span class="string">~</span>]<span class="comment"># kubectl apply -f test-env-pod.yaml </span></span><br><span class="line"><span class="string">pod/dapi-test-pod</span> <span class="string">created</span></span><br><span class="line">[<span class="string">root@k8s-master-lb</span> <span class="string">~</span>]<span class="comment"># kubectl get pods</span></span><br><span class="line"><span class="string">NAME</span>                     <span class="string">READY</span>   <span class="string">STATUS</span>      <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">busybox</span>                  <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>     <span class="number">31</span>         <span class="string">15d</span></span><br><span class="line"><span class="string">dapi-test-pod</span>            <span class="number">0</span><span class="string">/1</span>     <span class="string">Completed</span>   <span class="number">0</span>          <span class="string">4s</span></span><br><span class="line"><span class="string">nginx-66bbc9fdc5-mbqkf</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>     <span class="number">4</span>          <span class="string">16d</span></span><br><span class="line"><span class="string">nginx-66bbc9fdc5-x7vkl</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>     <span class="number">2</span>          <span class="string">16d</span></span><br><span class="line"><span class="string">web-0</span>                    <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>     <span class="number">2</span>          <span class="string">15d</span></span><br><span class="line"><span class="string">web-1</span>                    <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>     <span class="number">4</span>          <span class="string">15d</span></span><br><span class="line"><span class="string">web-2</span>                    <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>     <span class="number">4</span>          <span class="string">15d</span></span><br><span class="line">[<span class="string">root@k8s-master-lb</span> <span class="string">~</span>]<span class="comment"># kubectl logs -f dapi-test-pod</span></span><br><span class="line"><span class="string">mysqlPort=3306</span></span><br><span class="line"><span class="string">KUBERNETES_SERVICE_PORT=443</span></span><br><span class="line"><span class="string">KUBERNETES_PORT=tcp://10.96.0.1:443</span></span><br><span class="line"><span class="string">mysqlHostAddress=10.10.10.10</span></span><br><span class="line"><span class="string">test=test-value</span></span><br><span class="line"><span class="string">HOSTNAME=dapi-test-pod</span></span><br><span class="line"><span class="string">SHLVL=1</span></span><br><span class="line"><span class="string">HOME=/root</span></span><br><span class="line"><span class="string">KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1</span></span><br><span class="line"><span class="string">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span></span><br><span class="line"><span class="string">KUBERNETES_PORT_443_TCP_PORT=443</span></span><br><span class="line"><span class="string">KUBERNETES_PORT_443_TCP_PROTO=tcp</span></span><br><span class="line"><span class="string">KUBERNETES_SERVICE_PORT_HTTPS=443</span></span><br><span class="line"><span class="string">KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443</span></span><br><span class="line"><span class="string">special.how=very</span></span><br><span class="line"><span class="string">KUBERNETES_SERVICE_HOST=10.96.0.1</span></span><br><span class="line"><span class="string">PWD=/</span></span><br><span class="line">[<span class="string">root@k8s-master-lb</span> <span class="string">~</span>]<span class="comment"># </span></span><br></pre></td></tr></table></figure>


<p>把ConfigMap挂载到容器中</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master-lb</span> <span class="string">~</span>]<span class="comment"># cat test-env-pod.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dapi-test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">k8s-node01</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.28</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 3600&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">/mnt</span></span><br><span class="line">      <span class="attr">envFrom:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="comment"># Define the environment variable</span></span><br><span class="line">        <span class="comment"># - name: SPECIAL_LEVEL_KEY</span></span><br><span class="line">        <span class="comment">#   valueFrom:</span></span><br><span class="line">        <span class="comment">#     configMapKeyRef:</span></span><br><span class="line">        <span class="comment">#       # The ConfigMap containing the value you want to assign to SPECIAL_LEVEL_KEY</span></span><br><span class="line">        <span class="comment">#       name: special-config</span></span><br><span class="line">        <span class="comment">#       # Specify the key associated with the value</span></span><br><span class="line">        <span class="comment">#       key: special.how</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">test-value</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysqlHostAddress</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysqlPort</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;3306&quot;</span> <span class="comment"># only string</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">      <span class="attr">configMap:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">[<span class="string">root@k8s-master-lb</span> <span class="string">~</span>]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>复制代码<br>把ConfigMap挂载到容器中</p>
<h1 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h1><p>Secret用来保存敏感信息的，比如密码、令牌或者key、Redis、MySQL密码。</p>
<p>Secret中文文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/configuration/secret/">https://kubernetes.io/zh/docs/concepts/configuration/secret/</a></p>
<p>Secret介绍地址：kubernetes.io&#x2F;docs&#x2F;concep…</p>
<p>$ * \ 特殊字符单引号无需转义</p>
<p>ImagePullSecret：Pod拉取私有镜像仓库时使用的账号密码，里面的帐号信息，会传递给kubelet，然后kubelet就可以拉去有密码的仓库里面的镜像。</p>
<p>创建一个docker registry的secret</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master-lb ~]<span class="comment"># kubectl create secret docker-registry docker-secret2 --docker-server=hub.docker.com --docker-username=DOCKER_USER --docker-password=DOCKER_PASSWORD --docker-email=DOCKER_EMAIL</span></span><br><span class="line">secret/docker-secret2 created</span><br></pre></td></tr></table></figure>

<p>test-env-pod.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dapi-test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">k8s-node01</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-secret2</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.28</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 3600&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">/mnt</span></span><br><span class="line">      <span class="attr">envFrom:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="comment"># Define the environment variable</span></span><br><span class="line">        <span class="comment"># - name: SPECIAL_LEVEL_KEY</span></span><br><span class="line">        <span class="comment">#   valueFrom:</span></span><br><span class="line">        <span class="comment">#     configMapKeyRef:</span></span><br><span class="line">        <span class="comment">#       # The ConfigMap containing the value you want to assign to SPECIAL_LEVEL_KEY</span></span><br><span class="line">        <span class="comment">#       name: special-config</span></span><br><span class="line">        <span class="comment">#       # Specify the key associated with the value</span></span><br><span class="line">        <span class="comment">#       key: special.how</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">test-value</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysqlHostAddress</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysqlPort</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;3306&quot;</span> <span class="comment"># only string</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">      <span class="attr">configMap:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">special-config</span></span><br></pre></td></tr></table></figure>

<p>subPath解决目录覆盖的问题</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dapi-test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">k8s-node01</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-secret2</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.28</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 3600&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">subPath:</span> <span class="string">etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="attr">envFrom:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="comment"># Define the environment variable</span></span><br><span class="line">        <span class="comment"># - name: SPECIAL_LEVEL_KEY</span></span><br><span class="line">        <span class="comment">#   valueFrom:</span></span><br><span class="line">        <span class="comment">#     configMapKeyRef:</span></span><br><span class="line">        <span class="comment">#       # The ConfigMap containing the value you want to assign to SPECIAL_LEVEL_KEY</span></span><br><span class="line">        <span class="comment">#       name: special-config</span></span><br><span class="line">        <span class="comment">#       # Specify the key associated with the value</span></span><br><span class="line">        <span class="comment">#       key: special.how</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">test-value</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysqlHostAddress</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysqlPort</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;3306&quot;</span> <span class="comment"># only string</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">        <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">        <span class="attr">items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nginx.conf</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">etc/nginx/nginx.conf</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx-conf</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config-volume</span></span><br></pre></td></tr></table></figure>

<p>ConfigMap和Secret如果是以subPath 的形式挂载的,那么Pod是不会感知到ConfigMap和Secret的更新的。</p>
<p>如果Pod的变量来自于ConfiglMap和Secret中定义的内容，那么ConfiglMap和Secret更新后，也不会更新 Pod中的变量。</p>
<p>解决办法</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dapi-test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">k8s-node01</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-secret2</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.28</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 3600&quot;</span> ]</span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">subPath:</span> <span class="string">etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/mnt/</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">config-volume-non-subpath</span></span><br><span class="line">      <span class="attr">envFrom:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">special-config</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="comment"># Define the environment variable</span></span><br><span class="line">        <span class="comment"># - name: SPECIAL_LEVEL_KEY</span></span><br><span class="line">        <span class="comment">#   valueFrom:</span></span><br><span class="line">        <span class="comment">#     configMapKeyRef:</span></span><br><span class="line">        <span class="comment">#       # The ConfigMap containing the value you want to assign to SPECIAL_LEVEL_KEY</span></span><br><span class="line">        <span class="comment">#       name: special-config</span></span><br><span class="line">        <span class="comment">#       # Specify the key associated with the value</span></span><br><span class="line">        <span class="comment">#       key: special.how</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">test-value</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysqlHostAddress</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.10</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysqlPort</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;3306&quot;</span> <span class="comment"># only string</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">        <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">        <span class="attr">items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nginx.conf</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">etc/nginx/nginx.conf</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx-conf</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">        <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx-conf</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config-volume-non-subpath</span></span><br></pre></td></tr></table></figure>

<p>postStart：容器启动之前执行的命令</p>
<p>preStop：容器停止之前执行的命令</p>
<p>热更新ConfigMap或Secret：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create cm nginx-conf --from-file=nginx.conf --dry-run -oyaml | kubectl replace -f-</span><br></pre></td></tr></table></figure>

<p>immutable：在ConfigMap和Secret的最后加上如下内容，则不再可以edit该ConfigMap或Secret</p>
<h1 id="Volumes"><a href="#Volumes" class="headerlink" title="Volumes"></a>Volumes</h1><p>Container（容器）中的磁盘文件是短暂的，当容器崩溃时，kubelet会重新启动容器，但最初的文件将丢失，Container会以最干净的状态启动。另外，当一个Pod运行多个Container时，各个容器可能需要共享一些文件。Kubernetes Volume可以解决这两个问题。</p>
<p>一些需要持久化数据的程序才会用到Volumes，或者一些需要共享数据的容器需要volumes。</p>
<p>Redis-Cluster：nodes.conf</p>
<p>日志收集的需求：需要在应用程序的容器连加一个sidecar，这个容器是一个收集日志的容器，比如filebeat，它通过volumes共享应用程序的日志文件目录。</p>
<p>Volumes：官方文档 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/volumes/">https://kubernetes.io/docs/concepts/storage/volumes/</a></p>
<p>背景<br>Docker也有卷的概念，但是在Docker中卷只是磁盘上火另一个Container中的目录，其生命周期不受管理。虽然目前Docker已经提供了卷驱动程序，但是功能非常有限，例如从Dokcer 1.7版本开始，每个Container只允许一个卷驱动程序，并且无法将参数传递给卷。</p>
<p>另一方面，Kubernetes卷具有明确的生命周期，与使用它的Pod相同。因此，在Kubernetes中的卷可以比Pod中运行的任何Container都长，并且可以在Container重启或者销毁之后保留数据。Kubernetes支持多种类型的卷，Pod可以同时使用任意数量的卷。</p>
<p>从本质上讲，卷只是一个目录，可能包含一些数据，Pod中的容器可以访问它。要使用卷Pod需要通过.spec.volumes字段指定为Pod提供的卷，以及使用.spec.containers.volumeMounts字段指定卷挂载的目录。从容器中的进程可以看到由Docker镜像和卷组成的文件系统视图，卷无法挂载其他卷或具有到其他卷的硬链接，Pod中的每个Container必须独立指定每个卷的挂载位置。</p>
<p>卷的类型<br>Kubernetes支持的卷的类型有很多，以下为常用的卷。</p>
<p>（1）awsElasticBlockStore（EBS）</p>
<p>awsElasticBlockStore卷挂载一个AWS EBS Volume到Pod中，与emptyDir卷不同的是，当移除Pod时EBS卷的内容不会被删除，这意味着可以将数据预先放置在EBS卷中，并且可以在Pod之间切换该数据。</p>
<p>使用awsElasticBlockStore卷的限制：</p>
<ul>
<li>运行Pod的节点必须是AWS EC2实例。</li>
<li>AWS EC2实例需要和EBS卷位于同一区域和可用区域。</li>
<li>EBS仅支持挂载卷的单个EC2实例。</li>
</ul>
<p>在将Pod与EBS卷一起使用之前，需要先创建EBS卷，确保该卷的区域与集群的区域匹配，并检查size和EBS卷类型是否合理：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws ec2 create-volume --availability-zone=eu-west-1a --size=10 --volume-type=gp2</span><br></pre></td></tr></table></figure>



<h3 id="emptyDir"><a href="#emptyDir" class="headerlink" title="emptyDir"></a>emptyDir</h3><p>和上述volume不同的是，如果删除Pod，emptyDir卷中的数据也将被删除，一般emptyDir卷用于Pod中的不同Container共享数据。它可以被挂载到相同或不同的路径上。</p>
<p>默认情况下，emptyDir卷支持节点上的任何介质，可能是SSD、磁盘或网络存储，具体取决于自身的环境。可以将emptyDir.medium字段设置为Memory，让Kubernetes使用tmpfs（内存支持的文件系统），虽然tmpfs非常快，但是tmpfs在节点重启时，数据同样会被清除，并且设置的大小会被计入到Container的内存限制当中。</p>
<p>使用emptyDir卷的示例，直接指定emptyDir为{}即可：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">k8s.gcr.io/test-webserver</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/cache</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cache-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cache-volume</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>



<h3 id="hostPath"><a href="#hostPath" class="headerlink" title="hostPath"></a>hostPath</h3><p>hostPath卷可将节点上的文件或目录挂载到Pod上，用于Pod自定义日志输出或访问Docker内部的容器等。</p>
<p>使用hostPath卷的示例。将主机的&#x2F;data目录挂载到Pod的&#x2F;test-pd目录：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">k8s.gcr.io/test-webserver</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/test-pd</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="comment"># directory location on host</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data</span></span><br><span class="line">      <span class="comment"># this field is optional</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Directory</span></span><br></pre></td></tr></table></figure>

<p>hostPath卷常用的type（类型）如下：</p>
<ul>
<li>type为空字符串：默认选项，意味着挂载hostPath卷之前不会执行任何检查。</li>
<li>DirectoryOrCreate：如果给定的path不存在任何东西，那么将根据需要创建一个权限为0755的空目录，和Kubelet具有相同的组和权限。</li>
<li>Directory：目录必须存在于给定的路径下。</li>
<li>FileOrCreate：如果给定的路径不存储任何内容，则会根据需要创建一个空文件，权限设置为0644，和Kubelet具有相同的组和所有权。</li>
<li>File：文件，必须存在于给定路径中。</li>
<li>Socket：UNIX套接字，必须存在于给定路径中。</li>
<li>CharDevice：字符设备，必须存在于给定路径中。</li>
<li>BlockDevice：块设备，必须存在于给定路径中。</li>
</ul>
<h3 id="NFS"><a href="#NFS" class="headerlink" title="NFS"></a>NFS</h3><p>Exporter配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install nfs-utils -y</span><br><span class="line"></span><br><span class="line">vi /etc/exports</span><br><span class="line">/data/nfs/ 192.168.0.24(rw,<span class="built_in">sync</span>,no_subtree_check,no_root_squash)</span><br></pre></td></tr></table></figure>









<h3 id="一、PV、PVC"><a href="#一、PV、PVC" class="headerlink" title="一、PV、PVC"></a>一、PV、PVC</h3><h5 id="一些概念："><a href="#一些概念：" class="headerlink" title="一些概念："></a>一些概念：</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">Volume：NFS、CEPH、GFS</span><br><span class="line">PersistentVolume：NFS、CEPG/GFS</span><br><span class="line"></span><br><span class="line">PV、PVC</span><br><span class="line">PV：由k8s配置的存储，PV同样是集群的一类资源，yaml。</span><br><span class="line"></span><br><span class="line">PVC：对PV的申请，</span><br><span class="line">PersistentVolumeClaim</span><br><span class="line"></span><br><span class="line">PV文档：https://kubernetes.io/docs/concepts/storage/persistent-volumes/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Nfs类型的PV：</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: pv0003</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 5Gi</span><br><span class="line">  volumeMode: Filesystem</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br><span class="line">  storageClassName: slow</span><br><span class="line">  mountOptions:</span><br><span class="line">    - hard</span><br><span class="line">    - nfsvers=4.1</span><br><span class="line">  nfs:</span><br><span class="line">    path: /tmp</span><br><span class="line">    server: 172.17.0.2</span><br><span class="line"></span><br><span class="line">persistentVolumeReclaimPolicy：#类型</span><br><span class="line">	Recycle: 回收，rm -rf</span><br><span class="line">		Deployment -&gt; PVC  PV, Recycle。</span><br><span class="line">	Retain：保留。</span><br><span class="line">	Delete：PVC –-&gt; PV,删除PVC后PV也会被删掉，这一类的PV，需要支持删除的功能，动态存储默认方式。</span><br><span class="line"></span><br><span class="line">Capacity：PV的容量。</span><br><span class="line">volumeMode：挂载的类型，Filesystem，block</span><br><span class="line"></span><br><span class="line">accessModes：这个的PV访问模式：</span><br><span class="line">	ReadWriteOnce：RWO，可以被单节点以读写的模式挂载。</span><br><span class="line">	ReadWriteMany：RWX，可以被多节点以读写的形式挂载。</span><br><span class="line">	ReadOnlyMany：ROX，可以被多个节点以只读的形式挂载。</span><br><span class="line">storageClassName：PV的类，可以说是一个类名，PVC和PV的这个名字一样，才能被绑定。</span><br><span class="line"></span><br><span class="line">Pv的状态：</span><br><span class="line">	Available：空闲的PV，没有被任何PVC绑定。</span><br><span class="line">	Bound：已经被PVC绑定</span><br><span class="line">	Released：PVC被删除，但是资源未被重新使用</span><br><span class="line">	Failed：自动回收失败。</span><br></pre></td></tr></table></figure>

<h3 id="二、创建一个NFS的PV"><a href="#二、创建一个NFS的PV" class="headerlink" title="二、创建一个NFS的PV"></a>二、创建一个NFS的PV</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 app]# cat nfs-pv.yaml                  </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: pv0001</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 5Gi   # 定义内存大小，PVC的要比这个小</span><br><span class="line">  volumeMode: Filesystem  # 文件系统类型</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle  # 策略上面有介绍</span><br><span class="line">  storageClassName: nfs-slow   # 这个名字是PVC创建的时候要对应的名字</span><br><span class="line">  mountOptions:</span><br><span class="line">    - hard</span><br><span class="line">    - nfsvers=4.1</span><br><span class="line">  nfs:   #对应上nfs服务器的 ip 共享的文件夹</span><br><span class="line">    path: /data/nfs       </span><br><span class="line">    server: 192.168.1.104</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CREATE pv</span></span><br><span class="line">[root@k8s-master01 app]# kubectl create -f nfs-pv.yaml </span><br><span class="line">persistentvolume/pv0001 created</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 查看PV</span></span><br><span class="line">[root@k8s-master01 app]# kubectl get pv</span><br><span class="line">NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE</span><br><span class="line">pv0001   5Gi        RWO            Recycle          Available           nfs-slow                2m3s</span><br></pre></td></tr></table></figure>

<h3 id="三、创建一个PVC"><a href="#三、创建一个PVC" class="headerlink" title="三、创建一个PVC"></a>三、创建一个PVC</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">绑定到指定类型的PV</span></span><br><span class="line">[root@k8s-master01 app]# cat test-pvc.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: myclaim   # PVC的名字，可自取</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  volumeMode: Filesystem</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 2Gi</span><br><span class="line">  storageClassName: nfs-slow  # 名字要对应上想绑定的PV上</span><br><span class="line"><span class="meta prompt_">  </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">create PVC</span></span><br><span class="line">[root@k8s-master01 app]# kubectl create -f  test-pvc.yaml  </span><br><span class="line">persistentvolumeclaim/myclaim created</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看PVC</span></span><br><span class="line">[root@k8s-master01 app]# kubectl get pvc</span><br><span class="line">NAME      STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">myclaim   Bound    pv0001   5Gi        RWX            nfs-slow       34s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">再次查看PV，可看到状态已经发生改变</span></span><br><span class="line">[root@k8s-master01 app]# kubectl get pv</span><br><span class="line">NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM             STORAGECLASS   REASON   AGE</span><br><span class="line">pv0001   5Gi        RWX            Recycle          Bound    default/myclaim   nfs-slow                13m</span><br></pre></td></tr></table></figure>

<h3 id="四、更改deployment使用PVC类型的volume"><a href="#四、更改deployment使用PVC类型的volume" class="headerlink" title="四、更改deployment使用PVC类型的volume"></a>四、更改deployment使用PVC类型的volume</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更改后的yaml，在对应位置加上以下参数调用PVC</span></span><br><span class="line"><span class="attr">volumeMounts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/opt/pvc</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypd</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mypd</span></span><br><span class="line">     <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">       <span class="attr">claimName:</span> <span class="string">myclaim</span></span><br><span class="line">       </span><br><span class="line"><span class="comment"># 然后进入容器查看是否挂载成功</span></span><br><span class="line">[<span class="string">root@k8s-master01</span> <span class="string">app</span>]<span class="comment"># kubectl exec -it nginx-5bb6d88dfb-w78k8 -c nginx2 -- bash</span></span><br><span class="line"><span class="string">root@nginx-5bb6d88dfb-w78k8:/#</span> <span class="string">df</span> <span class="string">-h</span></span><br><span class="line"><span class="string">Filesystem</span>               <span class="string">Size</span>  <span class="string">Used</span> <span class="string">Avail</span> <span class="string">Use%</span> <span class="string">Mounted</span> <span class="string">on</span></span><br><span class="line"><span class="string">overlay</span>                   <span class="string">37G</span>  <span class="number">4.</span><span class="string">3G</span>   <span class="string">33G</span>  <span class="number">12</span><span class="string">%</span> <span class="string">/</span></span><br><span class="line"><span class="string">tmpfs</span>                     <span class="string">64M</span>     <span class="number">0</span>   <span class="string">64M</span>   <span class="number">0</span><span class="string">%</span> <span class="string">/dev</span></span><br><span class="line"><span class="string">tmpfs</span>                    <span class="string">985M</span>     <span class="number">0</span>  <span class="string">985M</span>   <span class="number">0</span><span class="string">%</span> <span class="string">/sys/fs/cgroup</span></span><br><span class="line"><span class="string">/dev/mapper/centos-root</span>   <span class="string">37G</span>  <span class="number">4.</span><span class="string">3G</span>   <span class="string">33G</span>  <span class="number">12</span><span class="string">%</span> <span class="string">/mnt</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.104</span><span class="string">:/data/nfs</span>   <span class="string">37G</span>  <span class="number">3.</span><span class="string">0G</span>   <span class="string">35G</span>   <span class="number">9</span><span class="string">%</span> <span class="string">/opt/pvc</span>   <span class="comment"># 这就是刚刚挂载的PVC</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件能共享</span></span><br><span class="line"><span class="string">root@nginx-5bb6d88dfb-w78k8:/opt/pvc#</span> <span class="string">ls</span> </span><br><span class="line"><span class="string">pvc</span>  <span class="string">qqq</span>  <span class="string">test</span></span><br><span class="line"><span class="string">root@nginx-5bb6d88dfb-w78k8:/opt/pvc#</span> <span class="string">echo</span> <span class="number">11</span> <span class="string">&gt;</span> <span class="string">test</span> </span><br><span class="line"><span class="string">root@nginx-5bb6d88dfb-w78k8:/opt/pvc#</span> <span class="string">cat</span> <span class="string">test</span>       </span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="string">很多情况下：</span></span><br><span class="line">	<span class="string">创建PVC之后，一直绑定不上PV（Pending）：</span></span><br><span class="line">		<span class="number">1</span><span class="string">.</span>	<span class="string">PVC的空间申请大小大于PV的大小</span></span><br><span class="line">		<span class="number">2</span><span class="string">.</span>	<span class="string">PVC的StorageClassName没有和PV的一致</span></span><br><span class="line">		<span class="number">3</span><span class="string">.</span>	<span class="string">PVC的accessModes和PV的不一致</span></span><br><span class="line"></span><br><span class="line">	<span class="string">创建挂载了PVC的Pod之后，一直处于Pending状态：</span></span><br><span class="line">		<span class="number">1</span><span class="string">.</span>	<span class="string">PVC没有被创建成功，或者被创建</span></span><br><span class="line">		<span class="number">2</span><span class="string">.</span>	<span class="string">PVC和Pod不在同一个Namespace</span></span><br><span class="line"></span><br><span class="line"><span class="string">删除PVC后→k8s会创建一个用于回收的Pod→根据PV的回收策略进行pv的回收→回收完以后PV的状态就会变成可被绑定的状态也就是空闲状态→其他的Pending状态的PVC如果匹配到了这个PV，他就能和这个PV进行绑定。</span></span><br></pre></td></tr></table></figure>







<p>CronJob：</p>
<ul>
<li><p>在k8s里面运行周期性的计划任务，同crontab（linux）。</p>
</li>
<li><p>分时日月周</p>
</li>
<li><p>你的计划任务可能需要调用应用的接口。</p>
</li>
<li><p>你的计划任务可能需要依赖某些环境。</p>
</li>
<li><p>php xxx，直接用php项目的镜像进行执行计划任务。</p>
</li>
<li><p>php-wordpress:v1.0.1</p>
</li>
<li><p>CronJob被调用的时间，是用的controller-manager的时间。</p>
</li>
<li><p>创建一个CronJob（新版kubectl无此命令，需要使用yaml创建）</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run hello --schedule=<span class="string">&quot;*/2 * * * *&quot;</span> --restart=OnFailure --image=nginx --image-pull-policy=IfNotPresent -- /bin/sh -c <span class="string">&quot;date&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>concurrencyPolicy：并发调度策略：Allow允许同时运行多个任务。Forbid：不允许并发执行。Replace：替换之前的任务。</li>
<li>failedJobHistoryLimit：保留失败的任务数。</li>
<li>schedule：调度的策略 分时日月周</li>
<li>successfulJobHistoryLimit：成功的Job保留的次数</li>
<li>suspend：挂起，true，cronjob不会被执行</li>
<li>startingDeadlineSeconds：失败之后多长时间后再次被调用</li>
</ul>
<h3 id="CronJob介绍"><a href="#CronJob介绍" class="headerlink" title="CronJob介绍"></a>CronJob介绍</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">可以利用 CronJobs 执行基于时间调度的任务。这些自动化任务和 Linux 或者 Unix 系统的 Cron 任务类似</span><br><span class="line">CronJobs在创建周期性以及重复性的任务时很有帮助，例如执行备份操作或者发送邮件。CronJobs 也可以在特定时间调度单个任务，例如你想调度低活跃周期的任务。</span><br></pre></td></tr></table></figure>

<h3 id="二、创建一个Job"><a href="#二、创建一个Job" class="headerlink" title="二、创建一个Job"></a>二、创建一个Job</h3><h4 id="2-1、yaml文件创建"><a href="#2-1、yaml文件创建" class="headerlink" title="2.1、yaml文件创建"></a>2.1、yaml文件创建</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master01</span> <span class="string">app</span>]<span class="comment"># cat  cronjob.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&quot;*/1 * * * *&quot;</span></span><br><span class="line">  <span class="attr">jobTemplate:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hello</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">busybox:1.28</span></span><br><span class="line">            <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">            <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">date;</span> <span class="string">echo</span> <span class="string">Hello</span> <span class="string">from</span> <span class="string">the</span> <span class="string">Kubernetes</span> <span class="string">cluster</span></span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建job</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">-f</span> <span class="string">cronjob.yaml</span> </span><br></pre></td></tr></table></figure>

<h4 id="2-2、查看job"><a href="#2-2、查看job" class="headerlink" title="2.2、查看job"></a>2.2、查看job</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 app]# kubectl get jobs --watch</span><br><span class="line">NAME               COMPLETIONS   DURATION   AGE</span><br><span class="line">hello-1609167960   0/1           7m44s      7m44s</span><br><span class="line">hello-1609168020   0/1           6m42s      6m42s</span><br><span class="line">hello-1609168080   0/1           5m41s      5m41s</span><br><span class="line">hello-1609168140   0/1           4m50s      4m50s</span><br><span class="line">hello-1609168200   0/1           3m49s      3m49s</span><br><span class="line">hello-1609168260   1/1           21s        2m48s</span><br><span class="line">hello-1609168320   1/1           2s         107s</span><br><span class="line">hello-1609168380   1/1           3s         46s</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 app]# kubectl get cronjob hello</span><br><span class="line">NAME    SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE</span><br><span class="line">hello   */1 * * * *   False     6        4s              8m20s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除</span></span><br><span class="line">[root@k8s-master01 app]# kubectl delete cronjob hello</span><br><span class="line">cronjob.batch &quot;hello&quot; deleted</span><br></pre></td></tr></table></figure>

<h4 id="2-3、yaml文件参数介绍"><a href="#2-3、yaml文件参数介绍" class="headerlink" title="2.3、yaml文件参数介绍"></a>2.3、yaml文件参数介绍</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cj hello -oyaml</span><br><span class="line">apiVersion: batch/v1beta1</span><br><span class="line">kind: CronJob</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    run: hello</span><br><span class="line">  name: hello</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  concurrencyPolicy: Allow #并发调度策略：Allow运行同时运行过个任务。</span><br><span class="line">								# Forbid：不运行并发执行。</span><br><span class="line">								# Replace：替换之前的任务</span><br><span class="line">  failedJobsHistoryLimit: 1 # 保留失败的任务数。</span><br><span class="line">  jobTemplate:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">    spec:</span><br><span class="line">      template:</span><br><span class="line">        metadata:</span><br><span class="line">          creationTimestamp: null</span><br><span class="line">          labels:</span><br><span class="line">            run: hello</span><br><span class="line">        spec:</span><br><span class="line">          containers:</span><br><span class="line">          - args:</span><br><span class="line">            - /bin/sh</span><br><span class="line">            - -c</span><br><span class="line">            - date</span><br><span class="line">            image: nginx</span><br><span class="line">            imagePullPolicy: IfNotPresent</span><br><span class="line">            name: hello</span><br><span class="line">            resources: &#123;&#125;</span><br><span class="line">            terminationMessagePath: /dev/termination-log</span><br><span class="line">            terminationMessagePolicy: File</span><br><span class="line">          dnsPolicy: ClusterFirst</span><br><span class="line">          restartPolicy: OnFailure</span><br><span class="line">          schedulerName: default-scheduler</span><br><span class="line">          securityContext: &#123;&#125;</span><br><span class="line">          terminationGracePeriodSeconds: 30</span><br><span class="line">  schedule: &#x27;*/1 * * * *&#x27;  #调度的策略 分时日月周</span><br><span class="line">  startingDeadlineSeconds: 30 # 如果30秒内失败了，一直重新调用，直到成功为止</span><br><span class="line">  successfulJobsHistoryLimit: 3 # 成功的Job保留的次数</span><br><span class="line">  suspend: false # 挂起，true：cronjob不会被执行。</span><br><span class="line">status: &#123;&#125;</span><br></pre></td></tr></table></figure>







<p>Taint&amp;Toleration</p>
<ol>
<li>在不同的机房</li>
<li>在不同的城市</li>
<li>有着不一样配置<ol>
<li>GPU服务器</li>
<li>纯固态硬盘的服务器</li>
</ol>
</li>
</ol>
<p>NodeSelect：</p>
<ol>
<li>gpu-server: true</li>
<li>ssd-server: true</li>
<li>normal-server: true</li>
</ol>
<p>污点和容忍的理念：</p>
<ul>
<li>Taint在一类服务器上打上污点，让不能容忍这个污点的Pod不能部署在打了污点的服务器上。</li>
<li>Master节点不应该部署系统Pod之外的任何Pod。</li>
<li>每个节点可以打很多个污点。</li>
</ul>
<p>GPU：gpu-server: true</p>
<p>给一个节点打一个污点</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node k8s-master01 master-test=<span class="built_in">test</span>:NoSchedule</span><br></pre></td></tr></table></figure>

<ul>
<li>NoSchedule：禁止调度</li>
<li>NoExectute：如果不符合这个污点，会立马被驱逐</li>
<li>PreferNoSchedule：尽量避免将Pod调度到指定的节点上</li>
</ul>
<p>给Pod添加容忍，必须key、value、effect同时匹配才生效</p>
<p>NoSchedule：禁止调度<br>NoExectute：如果不符合这个污点，会立马被驱逐<br>PreferNoSchedule：尽量避免将Pod调度到指定的节点上<br>给Pod添加容忍，必须key、value、effect同时匹配才生效</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">master-test</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">Equal</span></span><br></pre></td></tr></table></figure>

<p>Node节点有多个Taint，每个Taint都需要容忍才能部署上去。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">master-test</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">master-test</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">master-test</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">Equal</span></span><br><span class="line">  <span class="attr">tolerationSeconds:</span> <span class="number">60</span></span><br></pre></td></tr></table></figure>


<p>node.kubernetes.io&#x2F;not-ready：节点没有准备好，Ready不为true</p>
<p>node.kubernetes.io&#x2F;unreachable：节点控制器无法触及节点，对应节点状态ready值为Unknown</p>
<p>node.kubernetes.io&#x2F;out-of-disk：磁盘空间不足</p>
<p>node.kubernetes.io&#x2F;memory-pressure：节点存在内存压力</p>
<p>node.kubernetes.io&#x2F;disk-pressure：节点磁盘存在压力</p>
<p>node.kubernetes.io&#x2F;network-unavailable：节点不可被调度</p>
<h3 id="一、什么是Taint和Toleration"><a href="#一、什么是Taint和Toleration" class="headerlink" title="一、什么是Taint和Toleration"></a>一、什么是Taint和Toleration</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">所谓污点就是故意给某个节点服务器上设置个污点参数，那么你就能让生成pod的时候使用相应的参数去避开有污点参数的node服务器。而容忍呢，就是当资源不够用的时候，即使这个node服务器上有污点，那么只要pod的yaml配置文件中写了容忍参数，最终pod还是会容忍的生成在该污点服务器上。默认master节点是NoSchedule</span><br></pre></td></tr></table></figure>

<h3 id="二、Taint（污点）"><a href="#二、Taint（污点）" class="headerlink" title="二、Taint（污点）"></a>二、Taint（污点）</h3><h4 id="2-1、污点-Taint-的组成"><a href="#2-1、污点-Taint-的组成" class="headerlink" title="2.1、污点(Taint)的组成"></a>2.1、污点(Taint)的组成</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">使用kubectl taint命令可以给某个Node节点设置污点，Node被设置上污点之后就和Pod之间存在了一种相斥的关系，可以让Node拒绝Pod的调度执行，甚至将Node已经存在的Pod驱逐出去。key=value:effect</span><br></pre></td></tr></table></figure>

<p>每个污点有一个key和value作为污点的标签，其中value可以为空，effect描述污点的作用。当前taint effect支持如下三个选项：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NoSchedule：表示k8s将不会将Pod调度到具有该污点的Node上</span><br><span class="line"></span><br><span class="line">PreferNoSchedule：表示k8s将尽量避免将Pod调度到具有该污点的Node上</span><br><span class="line"></span><br><span class="line">NoExecute：表示k8s将不会将Pod调度到具有该污点的Node上，同时会将Node上已经存在的Pod驱逐出去</span><br></pre></td></tr></table></figure>

<h4 id="2-2、查看某个节点的Taint配置情况"><a href="#2-2、查看某个节点的Taint配置情况" class="headerlink" title="2.2、查看某个节点的Taint配置情况"></a>2.2、查看某个节点的Taint配置情况</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1、查看所有node情况</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl get node</span><br><span class="line">NAME           STATUS   ROLES    AGE     VERSION</span><br><span class="line">k8s-master01   Ready    matser   7d19h   v1.20.0</span><br><span class="line">k8s-master02   Ready    &lt;none&gt;   7d19h   v1.20.0</span><br><span class="line">k8s-master03   Ready    &lt;none&gt;   7d19h   v1.20.0</span><br><span class="line">k8s-node01     Ready    &lt;none&gt;   7d19h   v1.20.0</span><br><span class="line">k8s-node02     Ready    &lt;none&gt;   7d19h   v1.20.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2、查看某个节点的Taint信息(kubectl describe node nodename)</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl describe node k8s-node01  (内容太多不贴全了)</span><br><span class="line">Name:               k8s-node01</span><br><span class="line">Roles:              &lt;none&gt;</span><br><span class="line">Labels:             beta.kubernetes.io/arch=amd64</span><br><span class="line">                    beta.kubernetes.io/os=linux</span><br><span class="line">                    disktype=ssd</span><br><span class="line">                    kubernetes.io/arch=amd64</span><br><span class="line">                    kubernetes.io/hostname=k8s-node01</span><br><span class="line">                    kubernetes.io/os=linux</span><br><span class="line">                    node.kubernetes.io/node=</span><br><span class="line">Annotations:        node.alpha.kubernetes.io/ttl: 0</span><br><span class="line">                    volumes.kubernetes.io/controller-managed-attach-detach: true</span><br><span class="line">CreationTimestamp:  Mon, 21 Dec 2020 05:13:32 +0800</span><br><span class="line">Taints:             &lt;none&gt;   # 关注这个地方即可 ---没有设置过污点的节点属性中的参数是这样的Taints:     &lt;none&gt;</span><br><span class="line">Unschedulable:      false</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">添加 尽量不调度 PreferNoSchedule</span> </span><br><span class="line">kubectl taint nodes k8s-master02 node-role.kubernetes.io/master:PreferNoSchedule</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">去除污点NoSchedule，最后一个<span class="string">&quot;-&quot;</span>代表删除</span></span><br><span class="line">kubectl taint nodes k8s-master02 node-role.kubernetes.io/master:NoSchedule-</span><br></pre></td></tr></table></figure>

<h4 id="2-3、给某个节点服务器打上污点标签"><a href="#2-3、给某个节点服务器打上污点标签" class="headerlink" title="2.3、给某个节点服务器打上污点标签"></a>2.3、给某个节点服务器打上污点标签</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1、先看一下当前pod都分布到哪些节点上</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl get pod -owide </span><br><span class="line">NAME                        READY   STATUS  RESTARTS     AGE     IP                NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-btl2c                 1/1     Running   3          6d      172.162.195.26    k8s-master03   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-c9qf5                 1/1     Running   3          6d      172.161.125.27    k8s-node01     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-pl9gs                 1/1     Running   3          6d      172.169.92.103    k8s-master02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2、给节点k8s-node01服务器打上污点标签NoExecute</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl taint nodes k8s-node01 check=xtaint:NoExecute</span><br><span class="line">`注释：</span><br><span class="line"><span class="meta prompt_">check-------&gt;</span><span class="language-bash">键</span> </span><br><span class="line">value: &quot;xtaint&quot;-----------&gt;容忍的键对应的键值</span><br><span class="line">&quot;NoExecute&quot;-----------&gt;容忍的键对应的影响效果effect</span><br><span class="line">`</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3、再次查看pod，发现k8s-node01节点上的nginx-c9qf5容器正在被删除，再过一会，就被彻底删除了，这正是我们想要的效果！</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl get pod -owide</span><br><span class="line">NAME             READY   STATUS        AGE   IP            NODE       NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-c9qf5      1/1     Terminating   6d  172.161.125.27  k8s-node01  &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h4 id="2-4、删除某个节点上的设置的污点"><a href="#2-4、删除某个节点上的设置的污点" class="headerlink" title="2.4、删除某个节点上的设置的污点"></a>2.4、删除某个节点上的设置的污点</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">跟删除标签的方式有点类似，在后面加个 <span class="string">&quot;-&quot;</span></span></span><br><span class="line">[root@k8s-master01 ~]# kubectl taint nodes k8s-node01 check=xtaint:NoExecute-</span><br><span class="line">node/k8s-node01 untainted</span><br><span class="line"></span><br><span class="line">&quot;</span><br><span class="line"> Taints: 		test=xtaint:NoExecute</span><br><span class="line">			 	check=xtaint:NoSchedule</span><br><span class="line"> 				test=xtaint:NoSchedule</span><br><span class="line">&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">以上的Taints这样删，必须得带个<span class="string">&quot;-&quot;</span></span></span><br><span class="line">kubectl taint nodes k8s-node02 test=xtaint:NoExecute-</span><br><span class="line">kubectl taint nodes k8s-node02 check=xtaint:NoSchedule-</span><br><span class="line">kubectl taint nodes k8s-node02 test=xtaint:NoSchedule-</span><br></pre></td></tr></table></figure>

<h3 id="三、Toleration（容忍）"><a href="#三、Toleration（容忍）" class="headerlink" title="三、Toleration（容忍）"></a>三、Toleration（容忍）</h3><h4 id="3-1、现在k8s-node02节点上打上一个NoSchedule"><a href="#3-1、现在k8s-node02节点上打上一个NoSchedule" class="headerlink" title="3.1、现在k8s-node02节点上打上一个NoSchedule"></a>3.1、现在k8s-node02节点上打上一个NoSchedule</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">打上NoExecute，k8s-node02、k8s-master01、k8s-master02节点上的pod都会自动被删除</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl taint nodes k8s-node02 test=xtaint:NoExecute</span><br><span class="line">node/k8s-node02 tainted</span><br></pre></td></tr></table></figure>

<h4 id="3-2、创建一个包含有容忍toleration的配置文件"><a href="#3-2、创建一个包含有容忍toleration的配置文件" class="headerlink" title="3.2、创建一个包含有容忍toleration的配置文件"></a>3.2、创建一个包含有容忍toleration的配置文件</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">test-taint-pod.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EFO</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.5.2</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;check&quot;</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;xtaint&quot;</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">&quot;NoExecute&quot;</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">3600</span></span><br><span class="line"><span class="string">EFO</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create Pod</span></span><br><span class="line">[<span class="string">root@k8s-master01</span> <span class="string">app</span>]<span class="comment"># kubectl create -f test-taint-pod.yaml </span></span><br><span class="line"><span class="string">pod/nginx</span> <span class="string">created</span></span><br></pre></td></tr></table></figure>

<p>参数解释</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tolerations:-----------&gt;容忍</span><br><span class="line">- key: &quot;check&quot; -----------&gt;容忍的键</span><br><span class="line">operator: &quot;Equal&quot;-----------&gt;操作符&quot;等于&quot;</span><br><span class="line">value: &quot;xtaint&quot;-----------&gt;容忍的键对应的键值</span><br><span class="line">effect: &quot;NoExecute&quot;-----------&gt;容忍的键对应的影响效果</span><br><span class="line">tolerationSeconds: 3600-----------&gt;容忍3600秒。本pod配置文件中有这个参数了，然后再给本服务器设置污点NoExecute，那么这个pod也不会像普通pod那样立即被驱逐，而是再等上3600秒才被删除。</span><br></pre></td></tr></table></figure>

<h4 id="3-2、toleration配置方式"><a href="#3-2、toleration配置方式" class="headerlink" title="3.2、toleration配置方式"></a>3.2、toleration配置方式</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">方式一：</span><br><span class="line">tolerations:</span><br><span class="line">- key: &quot;key&quot;</span><br><span class="line">  operator: &quot;Equal&quot;</span><br><span class="line">  value: &quot;value&quot;</span><br><span class="line">  effect: &quot;NoSchedule&quot;</span><br><span class="line">方式二：</span><br><span class="line">tolerations:</span><br><span class="line">- key: &quot;key&quot;</span><br><span class="line">  operator: &quot;Exists&quot;</span><br><span class="line">  effect: &quot;NoSchedule&quot;</span><br><span class="line">  </span><br><span class="line">   一个Toleration和一个Taint相匹配是指它们有一样的key和effect，并且如果operator是Exists（此时toleration不指定value）或者operator是Equal，则它们的value应该相等。</span><br><span class="line">注意两种情况：</span><br><span class="line"></span><br><span class="line">    如果一个Toleration的key为空且operator为Exists，表示这个Toleration与任意的key、value和effect都匹配，即这个Toleration能容忍任意的Taint：</span><br><span class="line">tolerations:</span><br><span class="line">- operator: &quot;Exists&quot;</span><br><span class="line"></span><br><span class="line">    如果一个Toleration的effect为空，则key与之相同的相匹配的Taint的effect可以是任意值：</span><br><span class="line">tolerations:</span><br><span class="line">- key: &quot;key&quot;</span><br><span class="line">  operator: &quot;Exists&quot;</span><br><span class="line">  </span><br><span class="line">   上述例子使用到effect的一个值NoSchedule，也可以使用PreferNoSchedule，该值定义尽量避免将Pod调度到存在其不能容忍的Taint的节点上，但并不是强制的。effect的值还可以设置为NoExecute。</span><br><span class="line">   Kubernetes会自动给Pod添加一个key为node.kubernetes.io/not-ready的Toleration并配置tolerationSeconds=300，同样也会给Pod添加一个key为node.kubernetes.io/unreachable的Toleration并配置tolerationSeconds=300，除非用户自定义了上述key，否则会采用这个默认设置。</span><br><span class="line">   一个使用了很多本地状态的应用程序在网络断开时，仍然希望停留在当前节点上运行一段时间，愿意等待网络恢复以避免被驱逐。在这种情况下，Pod的Toleration可以这样配置：</span><br><span class="line">tolerations:</span><br><span class="line">- key: &quot;node.alpha.kubernetes.io/unreachable&quot;</span><br><span class="line">  operator: &quot;Exists&quot;</span><br><span class="line">  effect: &quot;NoExecute&quot;</span><br><span class="line">  tolerationSeconds: 6000</span><br></pre></td></tr></table></figure>















<p>初始化容器：在应用容器启动之前做的一些初始化操作</p>
<p>postStart：在容器启动之前做一些操作。不能保证在你的container的EntryPoint之前运行</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 10&quot;</span>]</span><br><span class="line">    <span class="attr">name:</span> <span class="string">init1</span></span><br></pre></td></tr></table></figure>







<h3 id="一、什么是Init-Container"><a href="#一、什么是Init-Container" class="headerlink" title="一、什么是Init Container"></a>一、什么是Init Container</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Init Container就是用来做初始化工作的容器，可以是一个或者多个，如果有多个的话，这些容器会按定义的顺序依次执行，只有所有的Init Container执行完后，主容器才会被启动。我们知道一个Pod里面的所有容器是共享数据卷和网络命名空间的，所以Init Container里面产生的数据可以被主容器使用到的。</span><br><span class="line"></span><br><span class="line">Init Container与应用容器本质上是一样的，但他们是仅运行一次就结束的任务，并且必须在成功执行完后，系统才能继续执行下一个容器</span><br></pre></td></tr></table></figure>

<h3 id="二、Init-Container应用场景"><a href="#二、Init-Container应用场景" class="headerlink" title="二、Init Container应用场景"></a>二、Init Container应用场景</h3><ul>
<li>等待其他量关联组件正确运行（例如solr启动先依赖zookeeper）</li>
<li>基于环境变量或配置模板生成配置文件</li>
<li>从远程数据库获取本地所需配置，或者将吱声注册到某个中央数据库中</li>
<li>下载相关依赖包，或者对系统进行一些预配置操作（可以用python或者bash对系统做初始化操作）</li>
</ul>
<h3 id="三、初始容器使用"><a href="#三、初始容器使用" class="headerlink" title="三、初始容器使用"></a>三、初始容器使用</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">myapp.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EFO</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;echo The app is running! &amp;&amp; sleep 3600&#x27;</span>]</span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-myservice</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;until nslookup myservice; do echo waiting for myservice; sleep 2; done;&#x27;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-mydb</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;until nslookup mydb; do echo waiting for mydb; sleep 2; done;&#x27;</span>]</span><br><span class="line"><span class="string">EFO</span></span><br></pre></td></tr></table></figure>

<p>以上pod定义包含两个初始容器,第一个等待<code>myservice</code>服务可用,第二个等待<code>mydb</code>服务可用,这两个pod执行完成,应用容器开始执行</p>
<p>下面是<code>myservice</code>和<code>mydb</code>两个服务的yaml文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">services.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EFO</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myservice</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9376</span></span><br><span class="line"><span class="string">EFO</span></span><br><span class="line"><span class="comment">#------------------------#</span></span><br><span class="line"><span class="string">cat</span> <span class="string">&gt;</span> <span class="string">mydb.yaml</span> <span class="string">&lt;&lt;</span> <span class="string">EFO</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mydb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9377</span></span><br><span class="line"><span class="string">EFO</span></span><br></pre></td></tr></table></figure>

<p>分别构建这些pod、service：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1、首先构建myapp这个pod、</span></span><br><span class="line">[root@k8s-master01 app]# kubectl create -f myapp.yaml</span><br><span class="line">pod/myapp-pod created</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2、查看状态，现在是不会创建成功的因为那2个servicer没初始化</span></span><br><span class="line">[root@k8s-master01 app]# kubectl get  -f myapp.yaml</span><br><span class="line">NAME        READY   STATUS                  RESTARTS   AGE</span><br><span class="line">myapp-pod   0/1     Init:ImagePullBackOff   0          11s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3、构建那2个servier</span></span><br><span class="line">[root@k8s-master01 app]# kubectl create -f services.yaml</span><br><span class="line">service/myservice created</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 app]# kubectl create -f mydb.yaml </span><br><span class="line">service/mydb created</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4、查看这2个svc</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl get  svc</span><br><span class="line">NAME           TYPE           CLUSTER-IP       EXTERNAL-IP     PORT(S)   AGE</span><br><span class="line">mydb           ClusterIP      10.96.15.77      &lt;none&gt;          80/TCP    38s</span><br><span class="line">myservice      ClusterIP      10.101.111.161   &lt;none&gt;          80/TCP    52s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">5、查看pod是否构建完成，可以看到已经构建完成。</span></span><br><span class="line">[root@k8s-master01 app]# kubectl get -f myapp.yaml</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp-pod   1/1     Running   0          4m46s</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这样查看也可以</span></span><br><span class="line">[root@k8s-master01 app]# kubectl get pod</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">myapp-pod                   1/1     Running   0          6m46s</span><br></pre></td></tr></table></figure>

<p>学习于：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/tylerzhou/p/11007430.html">https://www.cnblogs.com/tylerzhou/p/11007430.html</a></p>
<h2 id="Affinity"><a href="#Affinity" class="headerlink" title="Affinity"></a>Affinity</h2><p>NodeAffinity：节点亲和力</p>
<ul>
<li>RequiredDuringSchedulingIgnoredDuringExecution：硬亲和力，既支持必须部署在指定的节点上，也支持必须不部署在指定的节点上。</li>
<li>PreferredDuringSchedulingIgnoredDuringExecution：软亲和力，尽量部署在满足条件的节点上，或者是尽量不要部署在被匹配的节点。</li>
</ul>
<p>PodAffinity：Pod亲和力</p>
<ul>
<li>A应用B应用C应用，将A应用根据某种策略尽量或者部署在一块。Label<ul>
<li>A：app&#x3D;a B：app&#x3D;b</li>
<li>RequiredDuringSchedulingIgnoredDuringExecution：将A应用和B应用部署在一块</li>
<li>PreferredDuringSchedulingIgnoredDuringExecution：尽量将A应用和B应用部署在一块</li>
</ul>
</li>
</ul>
<p>PodAntiAffinity：Pod反亲和力</p>
<ul>
<li>A应用B应用C应用，将A应用根据某种策略尽量或不部署在一块。Label<ul>
<li>RequiredDuringSchedulingIgnoredDuringExecution：不要将A应用与与之匹配的应用部署在一块</li>
<li>PreferredDuringSchedulingIgnoredDuringExecution：尽量。。。</li>
</ul>
</li>
</ul>
<p>给节点打上label</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node k8s-node01 kubernetes.io/e2e-az-name=e2e-az1</span><br><span class="line">kubectl label node k8s-node02 kubernetes.io/e2e-az-name=e2e-az2</span><br><span class="line">kubectl label node k8s-node01 another-node-label-key=another-node-label-value</span><br><span class="line">kubectl label node k8s-master01 another-node-label-key=another-node-label-value</span><br></pre></td></tr></table></figure>

<p>编辑Deployment</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/e2e-az-name</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">e2e-az1</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">e2e-az2</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">preference:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">another-node-label-key</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">another-node-label-value</span></span><br></pre></td></tr></table></figure>

<p>In：部署在满足多个条件的节点上</p>
<p>NotIn：不要部署在满足这些条件的节点上</p>
<p>Exists：部署在具有某个存在key为指定的值的Node节点上</p>
<p>DoesNotExist：和Exists相反</p>
<p>Gt：大于指定的条件（条件为number，不能为string）</p>
<p>Lt：小于指定的条件</p>
<p>编辑Deployment，修改pod亲和性</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">podAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">region</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">beijing</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br></pre></td></tr></table></figure>

<p>编辑Deployment，修改namspace的pod亲和性</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="comment"># 把demo-nginx和kube-system namespace下的符合label为k8s-app=calico-kube-controllers的Pod部署在同一个节点上（拓扑域）</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">podAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">k8s-app</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">calico-kube-controllers</span></span><br><span class="line">        <span class="comment"># 如果写了namespace的字段，但是留空，它是匹配所有namespace下的指定label的Pod，如果写了namespace并且制定了值，就是匹配指定namespace下的指定label的Pod。</span></span><br><span class="line">        <span class="comment"># 如果没有写namespace，匹配当前namespace</span></span><br><span class="line">        <span class="attr">namespaces:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">kube-system</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br></pre></td></tr></table></figure>

<p>topologyKey：拓扑域，首先说明一点，不同的key不同的value是属于不同的拓扑域。</p>
<p>kube-system-&gt;k8s-app&#x3D;calico-kube-controllers</p>
<p>拓扑域划分演示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">label</span> <span class="string">node</span> <span class="string">k8s-master01</span> <span class="string">k8s-node01</span> <span class="string">jigui=1</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">label</span> <span class="string">node</span> <span class="string">k8s-master02</span> <span class="string">k8s-node02</span> <span class="string">jigui=2</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">label</span> <span class="string">node</span> <span class="string">k8s-master03</span> <span class="string">jigui=3</span></span><br><span class="line"> </span><br><span class="line"><span class="string">kubectl</span> <span class="string">edit</span> <span class="string">deploy</span> <span class="string">demo-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">podAntiAffinity:</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoreDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">demo-nginx</span></span><br><span class="line">       <span class="attr">topologyKey:</span> <span class="string">jigui</span></span><br></pre></td></tr></table></figure>

<p>扩展到4个pod，其中3个可以找到部署节点，最后一个处于pending状态，因为配置了3个拓扑域，最后一个找不到部署节点</p>
<p>配置为软亲和力</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">podAntiAffinity:</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoreDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">podAffinityTerm:</span></span><br><span class="line">          <span class="attr">labelSelector:</span></span><br><span class="line">            <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">              <span class="attr">values:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">demo-nginx</span></span><br><span class="line">          <span class="attr">topologyKey:</span> <span class="string">jigui</span></span><br></pre></td></tr></table></figure>







<p>临时容器：1.16+以上默认支持。</p>
<p>在原有的Pod上，添加一个临时的Container，这个Container可以包含我们排查问题所有的工具，netstat、ps、top、jstat、jmap。</p>
<p>vim &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;kubelet.service.d&#x2F;10-kubelet.conf</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">--feature-gates=<span class="string">&quot;EphemeralContainers=true&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubelet -h |grep EphemeralContainers</span><br></pre></td></tr></table></figure>



<p>vim &#x2F;etc&#x2F;kubernetes&#x2F;kubelet-conf.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Feature Gates:</span></span><br><span class="line">  <span class="attr">EphemeralContainers:</span> <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="string">systemctl</span> <span class="string">daemon-reload</span></span><br><span class="line">  <span class="string">systemctl</span> <span class="string">restart</span> <span class="string">kubelet</span></span><br><span class="line">  <span class="string">systemctl</span> <span class="string">status</span> <span class="string">kubelet</span></span><br></pre></td></tr></table></figure>





<p>vim &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-proxy.service</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">...</span><br><span class="line">  --feature-gates=EphemeralContainers=<span class="literal">true</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  systemctl daemon-reload</span><br><span class="line">  systemctl restart kube-proxy</span><br></pre></td></tr></table></figure>





<p>vim &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-apiserver.service</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">...</span><br><span class="line">  --feature-gates=EphemeralContainers=<span class="literal">true</span> \</span><br></pre></td></tr></table></figure>







<p>vim &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-controller-manager.service</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">...</span><br><span class="line">  --feature-gates=EphemeralContainers=<span class="literal">true</span> \</span><br></pre></td></tr></table></figure>







<p>vim &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kube-scheduler.service</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">...</span><br><span class="line">  --feature-gates=EphemeralContainers=<span class="literal">true</span> \</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  systemctl daemon-reload</span><br><span class="line">  systemctl restart kube-apiserver kube-controller-manager kube-scheduler</span><br></pre></td></tr></table></figure>







<p>vim ec.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;EphemeralContainers&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;demo-nginx-7987dc97bf-4sqpl&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ephemeralContainers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;sh&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;busybox:1.28&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;imagePullPolicy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;IfNotPresent&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;debugger&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;stdin&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tty&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;terminationMessagePolicy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;File&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl replace --raw /api/v1/namespaces/default/pods/demo-nginx-7987dc97bf-4sqpl/ephemeralcontainers -f ec.json</span><br><span class="line"></span><br><span class="line">kubectl <span class="built_in">exec</span> -it demo-nginx-7987dc97bf-4sqpl -c debugger -n kube-system -- sh</span><br></pre></td></tr></table></figure>

<p>DaemonSet需要单独配置：shareProcessNamespace，Deployment不需要单独配置。</p>
<h2 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h2><p>基于角色的访问控制，Role Based Access Control。它是一种基于企业内个人角色来管理一些资源的访问方法。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master-lb ~]<span class="comment"># more /usr/lib/systemd/system/kube-apiserver.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \</span><br><span class="line">      --v=2 \</span><br><span class="line">      --logtostderr=<span class="literal">true</span> \</span><br><span class="line">      --allow-privileged=<span class="literal">true</span> \</span><br><span class="line">      --bind-address=0.0.0.0 \</span><br><span class="line">      --secure-port=6443 \</span><br><span class="line">      --insecure-port=0 \</span><br><span class="line">      --advertise-address=192.168.1.107 \</span><br><span class="line">      --service-cluster-ip-range=10.96.0.0/12 \</span><br><span class="line">      --service-node-port-range=30000-32767 \</span><br><span class="line">      --etcd-servers=https://192.168.1.107:2379,https://192.168.1.108:2379,https://192.168.1.109:2379 \</span><br><span class="line">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \</span><br><span class="line">      --etcd-certfile=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">      --client-ca-file=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem \</span><br><span class="line">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem \</span><br><span class="line">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem \</span><br><span class="line">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem \</span><br><span class="line">      --service-account-key-file=/etc/kubernetes/pki/sa.pub \</span><br><span class="line">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key \</span><br><span class="line">      --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span><br><span class="line">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \</span><br><span class="line">      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota \</span><br><span class="line">      --authorization-mode=Node,RBAC \</span><br><span class="line">      --enable-bootstrap-token-auth=<span class="literal">true</span> \</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \</span><br><span class="line">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem \</span><br><span class="line">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem \</span><br><span class="line">      --requestheader-allowed-names=aggregator \</span><br><span class="line">      --requestheader-extra-headers-prefix=X-Remote-Group \</span><br><span class="line">      --requestheader-username-headers=X-Remote-User</span><br><span class="line">      <span class="comment"># --token-auth-file=/etc/kubernetes/token.csv</span></span><br><span class="line"> </span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"> </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">[root@k8s-master-lb ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<p>Jenkins使用基于角色的用户权限管理。</p>
<p>RBAC：4种顶级资源，Role、ClusterRole、RoleBinding、ClusterRoleBinding。</p>
<p>Role：角色，包含一组权限的规则。没有拒绝规则，只是附加允许。Namespace隔离，只作用于命名空间内。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master-lb</span> <span class="string">~</span>]<span class="comment"># kubectl get role -n ingress-nginx ingress-nginx -oyaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-08-20T04:59:54Z&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.40</span><span class="number">.2</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">ingress-nginx-3.6.0</span></span><br><span class="line">  <span class="attr">managedFields:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line">    <span class="attr">fieldsType:</span> <span class="string">FieldsV1</span></span><br><span class="line">    <span class="attr">fieldsV1:</span></span><br><span class="line">      <span class="attr">f:metadata:</span></span><br><span class="line">        <span class="attr">f:labels:</span></span><br><span class="line">          <span class="string">.:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">f:app.kubernetes.io/component:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">f:app.kubernetes.io/instance:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">f:app.kubernetes.io/managed-by:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">f:app.kubernetes.io/name:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">f:app.kubernetes.io/version:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">f:helm.sh/chart:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">f:rules:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">manager:</span> <span class="string">Go-http-client</span></span><br><span class="line">    <span class="attr">operation:</span> <span class="string">Update</span></span><br><span class="line">    <span class="attr">time:</span> <span class="string">&quot;2022-08-20T04:59:54Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;461437&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">b46670cc-21ac-4e7d-88bb-0cb14d815baa</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networking.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networking.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingresses/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networking.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingressclasses</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resourceNames:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingress-controller-leader-nginx</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">events</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line">[<span class="string">root@k8s-master-lb</span> <span class="string">~</span>]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<p>ClusterRole：和Role的区别，Role是只作用于命名空间内，作用于整个集群。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master-lb</span> <span class="string">~</span>]<span class="comment"># kubectl get clusterrole view -oyaml</span></span><br><span class="line"><span class="attr">aggregationRule:</span></span><br><span class="line">  <span class="attr">clusterRoleSelectors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">rbac.authorization.k8s.io/aggregate-to-view:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">rbac.authorization.kubernetes.io/autoupdate:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-06-21T13:12:31Z&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">kubernetes.io/bootstrapping:</span> <span class="string">rbac-defaults</span></span><br><span class="line">    <span class="attr">rbac.authorization.k8s.io/aggregate-to-edit:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">managedFields:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line">    <span class="attr">fieldsType:</span> <span class="string">FieldsV1</span></span><br><span class="line">    <span class="attr">fieldsV1:</span></span><br><span class="line">      <span class="attr">f:aggregationRule:</span></span><br><span class="line">        <span class="string">.:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">f:clusterRoleSelectors:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">f:metadata:</span></span><br><span class="line">        <span class="attr">f:annotations:</span></span><br><span class="line">          <span class="string">.:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">f:rbac.authorization.kubernetes.io/autoupdate:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">f:labels:</span></span><br><span class="line">          <span class="string">.:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">f:kubernetes.io/bootstrapping:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">f:rbac.authorization.k8s.io/aggregate-to-edit:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">manager:</span> <span class="string">kube-apiserver</span></span><br><span class="line">    <span class="attr">operation:</span> <span class="string">Update</span></span><br><span class="line">    <span class="attr">time:</span> <span class="string">&quot;2022-06-21T13:12:31Z&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line">    <span class="attr">fieldsType:</span> <span class="string">FieldsV1</span></span><br><span class="line">    <span class="attr">fieldsV1:</span></span><br><span class="line">      <span class="attr">f:rules:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">manager:</span> <span class="string">kube-controller-manager</span></span><br><span class="line">    <span class="attr">operation:</span> <span class="string">Update</span></span><br><span class="line">    <span class="attr">time:</span> <span class="string">&quot;2022-06-21T13:16:31Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">view</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;34722&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="number">709188e2</span><span class="string">-dc10-4fce-8c36-66caba981ed5</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">persistentvolumeclaims</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">persistentvolumeclaims/status</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicationcontrollers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicationcontrollers/scale</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">serviceaccounts</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">bindings</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">events</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">limitranges</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">namespaces/status</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods/log</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods/status</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicationcontrollers/status</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">resourcequotas</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">resourcequotas/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apps</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">controllerrevisions</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">daemonsets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">daemonsets/status</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deployments</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deployments/scale</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deployments/status</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicasets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicasets/scale</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicasets/status</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">statefulsets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">statefulsets/scale</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">statefulsets/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">autoscaling</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">horizontalpodautoscalers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">horizontalpodautoscalers/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">batch</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cronjobs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cronjobs/status</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">jobs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">jobs/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">daemonsets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">daemonsets/status</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deployments</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deployments/scale</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deployments/status</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingresses/status</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networkpolicies</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicasets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicasets/scale</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicasets/status</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">replicationcontrollers/scale</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">policy</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">poddisruptionbudgets</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">poddisruptionbudgets/status</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networking.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingresses/status</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">networkpolicies</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">metrics.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">[<span class="string">root@k8s-master-lb</span> <span class="string">~</span>]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<p>RoleBinding：作用于命名空间内，将ClusterRole或者Role绑定到User、Group、ServiceAccount。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master-lb</span> <span class="string">~</span>]<span class="comment"># kubectl get rolebinding ingress-nginx -n ingress-nginx -oyaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-08-20T04:59:54Z&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">Helm</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.40</span><span class="number">.2</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">ingress-nginx-3.6.0</span></span><br><span class="line">  <span class="attr">managedFields:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line">    <span class="attr">fieldsType:</span> <span class="string">FieldsV1</span></span><br><span class="line">    <span class="attr">fieldsV1:</span></span><br><span class="line">      <span class="attr">f:metadata:</span></span><br><span class="line">        <span class="attr">f:labels:</span></span><br><span class="line">          <span class="string">.:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">f:app.kubernetes.io/component:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">f:app.kubernetes.io/instance:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">f:app.kubernetes.io/managed-by:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">f:app.kubernetes.io/name:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">f:app.kubernetes.io/version:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">f:helm.sh/chart:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">f:roleRef:</span></span><br><span class="line">        <span class="attr">f:apiGroup:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">f:kind:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">f:name:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">f:subjects:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">manager:</span> <span class="string">Go-http-client</span></span><br><span class="line">    <span class="attr">operation:</span> <span class="string">Update</span></span><br><span class="line">    <span class="attr">time:</span> <span class="string">&quot;2022-08-20T04:59:54Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;461438&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">1633ad2d-b46b-4212-ab8d-1c19a7ec35ca</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span></span><br><span class="line">[<span class="string">root@k8s-master-lb</span> <span class="string">~</span>]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<p>ClusterRolebinding：作用于整个集群。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master-lb</span> <span class="string">~</span>]<span class="comment"># kubectl get clusterrolebinding admin-user -oyaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">rbac.authorization.kubernetes.io/autoupdate:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-06-22T06:25:56Z&quot;</span></span><br><span class="line">  <span class="attr">managedFields:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line">    <span class="attr">fieldsType:</span> <span class="string">FieldsV1</span></span><br><span class="line">    <span class="attr">fieldsV1:</span></span><br><span class="line">      <span class="attr">f:metadata:</span></span><br><span class="line">        <span class="attr">f:annotations:</span></span><br><span class="line">          <span class="string">.:</span> &#123;&#125;</span><br><span class="line">          <span class="attr">f:rbac.authorization.kubernetes.io/autoupdate:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">f:roleRef:</span></span><br><span class="line">        <span class="attr">f:apiGroup:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">f:kind:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">f:name:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">f:subjects:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">manager:</span> <span class="string">kubectl-create</span></span><br><span class="line">    <span class="attr">operation:</span> <span class="string">Update</span></span><br><span class="line">    <span class="attr">time:</span> <span class="string">&quot;2022-06-22T06:25:56Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;35909&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">d4e47393-e698-4405-9bb1-823a6814f7dd</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">[<span class="string">root@k8s-master-lb</span> <span class="string">~</span>]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<p>kind分类：ServiceAccount、User、Group。</p>
<p>–basic-auth-file：格式为’password’,’username’,’group1,group2’</p>
<p>参考文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">https://kubernetes.io/docs/reference/access-authn-authz/rbac/</a></p>
<p>\</p>
<p>基于用户名密码实现不同用户有不同的权限</p>
<p>基于ServiceAccount实现不同的SA有不同的权限</p>
<h3 id="一、什么是RBAC？"><a href="#一、什么是RBAC？" class="headerlink" title="一、什么是RBAC？"></a>一、什么是RBAC？</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/hsyw/p/14209406.html">https://www.cnblogs.com/hsyw/p/14209406.html</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Role-based access control(RBAC)基于企业内个人用户属于角色来访问计算和网络的常规访问控制方法。</span><br><span class="line">简单理解为权限与角色关联，用户通过成为角色的成员来得到角色的权限。K8S的RBAC使用rbac.authorization.k8s.io/v1 API组驱动认证决策，准许管理员通过API动态配置策略。为了启用RBAC，需要在apiserver启动参数添加--authorization-mode=RBAC。目前支持RBAC,ABAC(基于属性的访问控制)，Node（默认node和apiserver就是采用这种模式）,Webhook。</span><br></pre></td></tr></table></figure>

<h3 id="二、RBAC分类介绍（API-对象）"><a href="#二、RBAC分类介绍（API-对象）" class="headerlink" title="二、RBAC分类介绍（API 对象）"></a>二、RBAC分类介绍（API 对象）</h3><h4 id="2-1、RBAC有4种顶级资源"><a href="#2-1、RBAC有4种顶级资源" class="headerlink" title="2.1、RBAC有4种顶级资源"></a>2.1、RBAC有4种顶级资源</h4><ul>
<li>Role</li>
<li>ClusterRole</li>
<li>RoleBinding</li>
<li>ClusterRoleBinding</li>
</ul>
<h4 id="2-2、资源介绍"><a href="#2-2、资源介绍" class="headerlink" title="2.2、资源介绍"></a>2.2、资源介绍</h4><p><strong>Role</strong>：角色，包含一组权限的规则。没有拒绝规则，只是附加允许。Namespace隔离，只作用于命名空间内！</p>
<p><strong>ClusterRole</strong>：集群角色，和Role一样。和Role的区别，Role是只作用于命名空间内，ClusterRole作用于整个集群！</p>
<p><strong>RoleBinding</strong>：作用于命令空间内，将ClusterRole或者Role绑定到User、Group、ServiceAccount！</p>
<p><strong>ClusterRoleBinding</strong>：作用于整个集群。</p>
<p><strong>中文官方文档</strong>：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/">https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/</a></p>
<h3 id="三、示例"><a href="#三、示例" class="headerlink" title="三、示例"></a>三、示例</h3><h4 id="3-1、Role-示例"><a href="#3-1、Role-示例" class="headerlink" title="3.1、Role 示例"></a>3.1、Role 示例</h4><p>Role 总是用来在某个名字空间内设置访问权限；在你创建 Role 时，你必须指定该 Role 所属的名字空间</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>] <span class="comment"># &quot;&quot; 标明 core API 组</span></span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="3-2、ClusterRole-示例"><a href="#3-2、ClusterRole-示例" class="headerlink" title="3.2、ClusterRole 示例"></a>3.2、ClusterRole 示例</h4><p>ClusterRole 有若干用法。你可以用它来：</p>
<ol>
<li>定义对某名字空间域对象的访问权限，并将在各个名字空间内完成授权；</li>
<li>为名字空间作用域的对象设置访问权限，并跨所有名字空间执行授权；</li>
<li>为集群作用域的资源定义访问权限。</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># &quot;namespace&quot; 被忽略，因为 ClusterRoles 不受名字空间限制</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="comment"># 在 HTTP 层面，用来访问 Secret 对象的资源的名称为 &quot;secrets&quot;</span></span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="3-3、RoleBinding-示例"><a href="#3-3、RoleBinding-示例" class="headerlink" title="3.3、RoleBinding 示例"></a>3.3、RoleBinding 示例</h4><p>下面的例子中的 RoleBinding 将 “pod-reader” Role 授予在 “default” 名字空间中的用户 “jane”。 这样，用户 “jane” 就具有了读取 “default” 名字空间中 pods 的权限。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="comment"># 此角色绑定允许 &quot;jane&quot; 读取 &quot;default&quot; 名字空间中的 Pods</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-pods</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="comment"># 你可以指定不止一个“subject（主体）”</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span> <span class="comment"># 这里可以是User,Group,ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jane</span> <span class="comment"># &quot;name&quot; 是不区分大小写的</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="comment"># &quot;roleRef&quot; 指定与某 Role 或 ClusterRole 的绑定关系</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span> <span class="comment"># 此字段必须是 Role 或 ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-reader</span>     <span class="comment"># 此字段必须与你要绑定的 Role 或 ClusterRole 的名称匹配</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<h5 id="3-3-1、RoleBinding-引用-ClusterRole"><a href="#3-3-1、RoleBinding-引用-ClusterRole" class="headerlink" title="3.3.1、RoleBinding 引用 ClusterRole"></a>3.3.1、RoleBinding 引用 ClusterRole</h5><p>RoleBinding 也可以引用 ClusterRole，以将对应 ClusterRole 中定义的访问权限授予 RoleBinding 所在名字空间的资源。这种引用使得你可以跨整个集群定义一组通用的角色， 之后在多个名字空间中复用！</p>
<p>下面的例子中的 RoleBinding，将”secret-reader” ClusterRole授予在”development” namespace中的用户”dave”。这样，用户 “dave” 就具有了读取 “development” 名字空间中 pods 的权限。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="comment"># 此角色绑定使得用户 &quot;dave&quot; 能够读取 &quot;default&quot; 名字空间中的 Secrets</span></span><br><span class="line"><span class="comment"># 你需要一个名为 &quot;secret-reader&quot; 的 ClusterRole</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-secrets</span></span><br><span class="line">  <span class="comment"># RoleBinding 的名字空间决定了访问权限的授予范围。</span></span><br><span class="line">  <span class="comment"># 这里仅授权在 &quot;development&quot; 名字空间内的访问权限。</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">development</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dave</span> <span class="comment"># &#x27;name&#x27; 是不区分大小写的</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<h4 id="3-4、ClusterRoleBinding-示例"><a href="#3-4、ClusterRoleBinding-示例" class="headerlink" title="3.4、ClusterRoleBinding 示例"></a>3.4、ClusterRoleBinding 示例</h4><p>要跨整个集群完成访问权限的授予，你可以使用一个 ClusterRoleBinding。 下面的 ClusterRoleBinding 允许 “manager” 组内的所有用户访问任何名字空间中的 Secrets。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="comment"># 此集群角色绑定允许 “manager” 组中的任何人访问任何名字空间中的 secrets</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-secrets-global</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">manager</span> <span class="comment"># &#x27;name&#x27; 是不区分大小写的</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<p> 创建了绑定之后，你不能再修改绑定对象所引用的 Role 或 ClusterRole。 试图改变绑定对象的 <code>roleRef</code> 将导致合法性检查错误。 如果你想要改变现有绑定对象中 <code>roleRef</code> 字段的内容，必须删除重新创建绑定对象。</p>
<p><strong>这种限制有两个主要原因：</strong></p>
<ol>
<li>针对不同角色的绑定是完全不一样的绑定。要求通过删除&#x2F;重建绑定来更改 <code>roleRef</code>, 这样可以确保要赋予绑定的所有主体会被授予新的角色（而不是在允许修改 <code>roleRef</code> 的情况下导致所有现有主体胃镜验证即被授予新角色对应的权限）。</li>
<li>将 <code>roleRef</code> 设置为不可以改变，这使得可以为用户授予对现有绑定对象的 <code>update</code> 权限， 这样可以让他们管理主体列表，同时不能更改被授予这些主体的角色。</li>
</ol>
<p>命令 <code>kubectl auth reconcile</code> 可以创建或者更新包含 RBAC 对象的清单文件， 并且在必要的情况下删除和重新创建绑定对象，以改变所引用的角色</p>
<h4 id="3-5、聚合的-ClusterRole"><a href="#3-5、聚合的-ClusterRole" class="headerlink" title="3.5、聚合的 ClusterRole"></a>3.5、聚合的 ClusterRole</h4><p>下面是一个聚合 ClusterRole 的示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">aggregationRule:</span></span><br><span class="line">  <span class="attr">clusterRoleSelectors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">rbac.example.com/aggregate-to-monitoring:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">rules:</span> [] <span class="comment"># 控制面自动填充这里的规则</span></span><br><span class="line"></span><br><span class="line"><span class="string">-------</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">monitoring-endpoints</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">rbac.example.com/aggregate-to-monitoring:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="comment"># 当你创建 &quot;monitoring-endpoints&quot; ClusterRole 时，</span></span><br><span class="line"><span class="comment"># 下面的规则会被添加到 &quot;monitoring&quot; ClusterRole 中</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;services&quot;</span>, <span class="string">&quot;endpoints&quot;</span>, <span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>下面的 ClusterRoles 让默认角色 “admin” 和 “edit” 拥有管理自定义资源 “CronTabs” 的权限， “view” 角色对 CronTab 资源拥有读操作权限。 你可以假定 CronTab 对象在 API 服务器所看到的 URL 中被命名为 <code>&quot;crontabs&quot;</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">aggregate-cron-tabs-edit</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="comment"># 添加以下权限到默认角色 &quot;admin&quot; 和 &quot;edit&quot; 中</span></span><br><span class="line">    <span class="attr">rbac.authorization.k8s.io/aggregate-to-admin:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">rbac.authorization.k8s.io/aggregate-to-edit:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;stable.example.com&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;crontabs&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">aggregate-cron-tabs-view</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="comment"># 添加以下权限到 &quot;view&quot; 默认角色中</span></span><br><span class="line">    <span class="attr">rbac.authorization.k8s.io/aggregate-to-view:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;stable.example.com&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;crontabs&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br></pre></td></tr></table></figure>









<p>安装一键式k8s资源平台Ratel到k8s集群中</p>
<p><a target="_blank" rel="noopener" href="https://github.com/dotbalo/ratel-doc/blob/master/cluster/Install.md">https://github.com/dotbalo/ratel-doc/blob/master/cluster/Install.md</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://mo-li001.github.io">壹拾陆</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://mo-li001.github.io/posts/e029aafa.html">https://mo-li001.github.io/posts/e029aafa.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mo-li001.github.io" target="_blank">壹拾陆</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/5d473c35.html"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">第二章· Redis管理实战</div></div></a></div><div class="next-post pull-right"><a href="/posts/b35c2eb5.html"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">维修</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/abc41134.html" title="没写好"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">没写好</div></div></a></div><div><a href="/posts/9f353bc9.html" title="Devops"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Devops</div></div></a></div><div><a href="/posts/f5f9fa9b.html" title="Docker"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Docker</div></div></a></div><div><a href="/posts/34d20e28.html" title="ELK"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">ELK</div></div></a></div><div><a href="/posts/8005.html" title="ELK快速部署"><img class="cover" src="https://tuchuangs.com/imgs/2022/09/18/074f3836d4f471b8.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">ELK快速部署</div></div></a></div><div><a href="/posts/9bdc030a.html" title="HAproxy"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">HAproxy</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202209182232723.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">壹拾陆</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">96</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mo-li001/"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">个人笔记</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85k8s"><span class="toc-text">二进制安装k8s</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E5%8D%87%E7%BA%A7"><span class="toc-text">内核升级</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%BB%84%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-text">基本组件安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker%E5%AE%89%E8%A3%85"><span class="toc-text">Docker安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#K8s-%E5%8F%8A-etcd-%E5%AE%89%E8%A3%85"><span class="toc-text">K8s 及 etcd 安装</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6"><span class="toc-text">生成证书</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes%E7%B3%BB%E7%BB%9F%E7%BB%84%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="toc-text">Kubernetes系统组件配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#etcd-%E9%85%8D%E7%BD%AE"><span class="toc-text">etcd 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Master01"><span class="toc-text">Master01</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Master02"><span class="toc-text">Master02</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Master03"><span class="toc-text">Master03</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAService"><span class="toc-text">创建Service</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="toc-text">高可用配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Master01-keepalived"><span class="toc-text">Master01 keepalived</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Master02-keepalived"><span class="toc-text">Master02 keepalived</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Master03-keepalived"><span class="toc-text">Master03 keepalived</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5%E9%85%8D%E7%BD%AE"><span class="toc-text">健康检查配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes%E7%BB%84%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="toc-text">Kubernetes组件配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Apiserver"><span class="toc-text">Apiserver</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Master01%E9%85%8D%E7%BD%AE"><span class="toc-text">Master01配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Master02-%E9%85%8D%E7%BD%AE"><span class="toc-text">Master02 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Master03-%E9%85%8D%E7%BD%AE"><span class="toc-text">Master03 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8apiserver"><span class="toc-text">启动apiserver</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ControllerManager"><span class="toc-text">ControllerManager</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Scheduler"><span class="toc-text">Scheduler</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TLS-Bootstrapping-%E9%85%8D%E7%BD%AE"><span class="toc-text">TLS Bootstrapping 配置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Node%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="toc-text">Node节点配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E8%AF%81%E4%B9%A6"><span class="toc-text">复制证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kubelet%E9%85%8D%E7%BD%AE"><span class="toc-text">Kubelet配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kube-proxy%E9%85%8D%E7%BD%AE"><span class="toc-text">kube-proxy配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Calico"><span class="toc-text">安装Calico</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85CoreDNS"><span class="toc-text">安装CoreDNS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%AF%B9%E5%BA%94%E7%89%88%E6%9C%AC%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="toc-text">安装对应版本（推荐）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%9C%80%E6%96%B0%E7%89%88CoreDNS"><span class="toc-text">安装最新版CoreDNS</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Metrics-Server"><span class="toc-text">安装Metrics Server</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E9%AA%8C%E8%AF%81"><span class="toc-text">集群验证</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85dashboard"><span class="toc-text">安装dashboard</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Dashboard%E9%83%A8%E7%BD%B2"><span class="toc-text">Dashboard部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%ACdashboard"><span class="toc-text">安装指定版本dashboard</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%9C%80%E6%96%B0%E7%89%88"><span class="toc-text">安装最新版</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BB%E5%BD%95dashboard"><span class="toc-text">登录dashboard</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%85%B3%E9%94%AE%E6%80%A7%E9%85%8D%E7%BD%AE"><span class="toc-text">生产环境关键性配置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Docker%E5%9F%BA%E7%A1%80"><span class="toc-text">Docker基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker%E5%91%BD%E4%BB%A4"><span class="toc-text">Docker命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8Kubernetes%EF%BC%9F"><span class="toc-text">为什么要用Kubernetes？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#K8s%E6%8E%A7%E5%88%B6%E8%8A%82%E7%82%B9-Master%E6%A6%82%E5%BF%B5"><span class="toc-text">K8s控制节点-Master概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Master-%E8%8A%82%E7%82%B9%EF%BC%9A%E6%95%B4%E4%B8%AA%E9%9B%86%E7%BE%A4%E7%9A%84%E6%8E%A7%E5%88%B6%E4%B8%AD%E6%9E%A2"><span class="toc-text">Master 节点：整个集群的控制中枢</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E4%BB%80%E4%B9%88%E6%98%AFPod%EF%BC%9F"><span class="toc-text">1.1 什么是Pod？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%BC%95%E5%85%A5Pod"><span class="toc-text">1.2 为什么要引入Pod?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-Pod%E6%8E%A2%E9%92%88"><span class="toc-text">1.3 Pod探针</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#StartupProbe"><span class="toc-text">StartupProbe</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LivenessProbe"><span class="toc-text">LivenessProbe</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ReadinessProbe"><span class="toc-text">ReadinessProbe</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-Pod%E6%8E%A2%E9%92%88%E7%9A%84%E6%A3%80%E6%B5%8B%E6%96%B9%E5%BC%8F"><span class="toc-text">1.4 Pod探针的检测方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ExecAction"><span class="toc-text">ExecAction</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TCPSocketAction"><span class="toc-text">TCPSocketAction</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTPGetAction"><span class="toc-text">HTTPGetAction</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-%E6%8E%A2%E9%92%88%E6%A3%80%E6%9F%A5%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE"><span class="toc-text">1.5 探针检查参数配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%B6%E5%AE%95%E6%9C%BA%E5%BF%85%E5%A4%87%E7%9F%A5%E8%AF%86%EF%BC%9APreStop%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">零宕机必备知识：PreStop的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Replication-Controller%E5%92%8CReplicaSet"><span class="toc-text">Replication Controller和ReplicaSet</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Replication-Controller"><span class="toc-text">Replication Controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReplicaSet"><span class="toc-text">ReplicaSet</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E7%8A%B6%E6%80%81%E6%9C%8D%E5%8A%A1Deployment%E6%A6%82%E5%BF%B5"><span class="toc-text">无状态服务Deployment概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deployment%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-text">Deployment的创建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deployment%E7%9A%84%E6%9B%B4%E6%96%B0"><span class="toc-text">Deployment的更新</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deployment%E7%9A%84%E5%9B%9E%E6%BB%9A"><span class="toc-text">Deployment的回滚</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deployment%E6%89%A9%E5%AE%B9%E5%92%8C%E7%BC%A9%E5%AE%B9"><span class="toc-text">Deployment扩容和缩容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deployment%E6%9B%B4%E6%96%B0%E6%9A%82%E5%81%9C%E5%92%8C%E6%81%A2%E5%A4%8D"><span class="toc-text">Deployment更新暂停和恢复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deployment%E6%9B%B4%E6%96%B0%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text">Deployment更新注意事项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E7%8A%B6%E6%80%81%E5%BA%94%E7%94%A8%E7%AE%A1%E7%90%86StatefulSet%E6%A6%82%E5%BF%B5"><span class="toc-text">有状态应用管理StatefulSet概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#StatefulSet%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-text">StatefulSet的基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StatefulSet%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text">StatefulSet注意事项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAStatefulSet%E5%BA%94%E7%94%A8"><span class="toc-text">创建一个StatefulSet应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AAStatefulSet%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6"><span class="toc-text">定义一个StatefulSet资源文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAStatefulSet"><span class="toc-text">创建一个StatefulSet</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#StatefulSet%E6%89%A9%E5%AE%B9%E7%BC%A9%E5%AE%B9"><span class="toc-text">StatefulSet扩容缩容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#StatefulSet%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5"><span class="toc-text">StatefulSet更新策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RollingUpdate"><span class="toc-text">RollingUpdate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OnDelete"><span class="toc-text">OnDelete</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#StatefulSet%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83"><span class="toc-text">StatefulSet灰度发布</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#StatefulSet%E7%BA%A7%E8%81%94%E5%88%A0%E9%99%A4%E5%92%8C%E9%9D%9E%E7%BA%A7%E8%81%94%E5%88%A0%E9%99%A4"><span class="toc-text">StatefulSet级联删除和非级联删除</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B%E6%9C%8D%E5%8A%A1DaemonSet"><span class="toc-text">守护进程服务DaemonSet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DaemonSet%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">DaemonSet的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DaemonSet%E7%9A%84%E6%9B%B4%E6%96%B0%E5%92%8C%E5%9B%9E%E6%BB%9A"><span class="toc-text">DaemonSet的更新和回滚</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Label-amp-Selector"><span class="toc-text">Label&amp;Selector</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Label"><span class="toc-text">Label</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Selector"><span class="toc-text">Selector</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFHPA%EF%BC%9F"><span class="toc-text">什么是HPA？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E6%89%A9%E7%BC%A9%E5%AE%B9HPA%E5%AE%9E%E8%B7%B5"><span class="toc-text">自动扩缩容HPA实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFService%EF%BC%9F"><span class="toc-text">什么是Service？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84Service"><span class="toc-text">创建一个简单的Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Service%E4%BB%A3%E7%90%86k8s%E5%A4%96%E9%83%A8%E5%BA%94%E7%94%A8"><span class="toc-text">使用Service代理k8s外部应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E4%BD%BF%E7%94%A8Service%E5%8F%8D%E4%BB%A3%E5%9F%9F%E5%90%8D"><span class="toc-text">四、使用Service反代域名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SVC%E7%B1%BB%E5%9E%8B"><span class="toc-text">SVC类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFIngress%EF%BC%9F"><span class="toc-text">一、什么是Ingress？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Ingress%E5%AE%89%E8%A3%85"><span class="toc-text">二、Ingress安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1%E3%80%81%E9%A6%96%E5%85%88%E5%AE%89%E8%A3%85helm%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7"><span class="toc-text">2.1、首先安装helm管理工具</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2%E3%80%81%E4%BD%BF%E7%94%A8helm%E5%AE%89%E8%A3%85ingress"><span class="toc-text">2.2、使用helm安装ingress</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3%E3%80%81Ingress%E5%85%A5%E9%97%A8%E4%BD%BF%E7%94%A8"><span class="toc-text">2.3、Ingress入门使用</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Secret"><span class="toc-text">Secret</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Volumes"><span class="toc-text">Volumes</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#emptyDir"><span class="toc-text">emptyDir</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hostPath"><span class="toc-text">hostPath</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NFS"><span class="toc-text">NFS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81PV%E3%80%81PVC"><span class="toc-text">一、PV、PVC</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E6%A6%82%E5%BF%B5%EF%BC%9A"><span class="toc-text">一些概念：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AANFS%E7%9A%84PV"><span class="toc-text">二、创建一个NFS的PV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAPVC"><span class="toc-text">三、创建一个PVC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%9B%B4%E6%94%B9deployment%E4%BD%BF%E7%94%A8PVC%E7%B1%BB%E5%9E%8B%E7%9A%84volume"><span class="toc-text">四、更改deployment使用PVC类型的volume</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CronJob%E4%BB%8B%E7%BB%8D"><span class="toc-text">CronJob介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAJob"><span class="toc-text">二、创建一个Job</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1%E3%80%81yaml%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA"><span class="toc-text">2.1、yaml文件创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2%E3%80%81%E6%9F%A5%E7%9C%8Bjob"><span class="toc-text">2.2、查看job</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3%E3%80%81yaml%E6%96%87%E4%BB%B6%E5%8F%82%E6%95%B0%E4%BB%8B%E7%BB%8D"><span class="toc-text">2.3、yaml文件参数介绍</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFTaint%E5%92%8CToleration"><span class="toc-text">一、什么是Taint和Toleration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Taint%EF%BC%88%E6%B1%A1%E7%82%B9%EF%BC%89"><span class="toc-text">二、Taint（污点）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1%E3%80%81%E6%B1%A1%E7%82%B9-Taint-%E7%9A%84%E7%BB%84%E6%88%90"><span class="toc-text">2.1、污点(Taint)的组成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2%E3%80%81%E6%9F%A5%E7%9C%8B%E6%9F%90%E4%B8%AA%E8%8A%82%E7%82%B9%E7%9A%84Taint%E9%85%8D%E7%BD%AE%E6%83%85%E5%86%B5"><span class="toc-text">2.2、查看某个节点的Taint配置情况</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3%E3%80%81%E7%BB%99%E6%9F%90%E4%B8%AA%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%89%93%E4%B8%8A%E6%B1%A1%E7%82%B9%E6%A0%87%E7%AD%BE"><span class="toc-text">2.3、给某个节点服务器打上污点标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4%E3%80%81%E5%88%A0%E9%99%A4%E6%9F%90%E4%B8%AA%E8%8A%82%E7%82%B9%E4%B8%8A%E7%9A%84%E8%AE%BE%E7%BD%AE%E7%9A%84%E6%B1%A1%E7%82%B9"><span class="toc-text">2.4、删除某个节点上的设置的污点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81Toleration%EF%BC%88%E5%AE%B9%E5%BF%8D%EF%BC%89"><span class="toc-text">三、Toleration（容忍）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1%E3%80%81%E7%8E%B0%E5%9C%A8k8s-node02%E8%8A%82%E7%82%B9%E4%B8%8A%E6%89%93%E4%B8%8A%E4%B8%80%E4%B8%AANoSchedule"><span class="toc-text">3.1、现在k8s-node02节点上打上一个NoSchedule</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2%E3%80%81%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8C%85%E5%90%AB%E6%9C%89%E5%AE%B9%E5%BF%8Dtoleration%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">3.2、创建一个包含有容忍toleration的配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2%E3%80%81toleration%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="toc-text">3.2、toleration配置方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFInit-Container"><span class="toc-text">一、什么是Init Container</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Init-Container%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">二、Init Container应用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%88%9D%E5%A7%8B%E5%AE%B9%E5%99%A8%E4%BD%BF%E7%94%A8"><span class="toc-text">三、初始容器使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Affinity"><span class="toc-text">Affinity</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RBAC"><span class="toc-text">RBAC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFRBAC%EF%BC%9F"><span class="toc-text">一、什么是RBAC？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81RBAC%E5%88%86%E7%B1%BB%E4%BB%8B%E7%BB%8D%EF%BC%88API-%E5%AF%B9%E8%B1%A1%EF%BC%89"><span class="toc-text">二、RBAC分类介绍（API 对象）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1%E3%80%81RBAC%E6%9C%894%E7%A7%8D%E9%A1%B6%E7%BA%A7%E8%B5%84%E6%BA%90"><span class="toc-text">2.1、RBAC有4种顶级资源</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2%E3%80%81%E8%B5%84%E6%BA%90%E4%BB%8B%E7%BB%8D"><span class="toc-text">2.2、资源介绍</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E7%A4%BA%E4%BE%8B"><span class="toc-text">三、示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1%E3%80%81Role-%E7%A4%BA%E4%BE%8B"><span class="toc-text">3.1、Role 示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2%E3%80%81ClusterRole-%E7%A4%BA%E4%BE%8B"><span class="toc-text">3.2、ClusterRole 示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3%E3%80%81RoleBinding-%E7%A4%BA%E4%BE%8B"><span class="toc-text">3.3、RoleBinding 示例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-1%E3%80%81RoleBinding-%E5%BC%95%E7%94%A8-ClusterRole"><span class="toc-text">3.3.1、RoleBinding 引用 ClusterRole</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4%E3%80%81ClusterRoleBinding-%E7%A4%BA%E4%BE%8B"><span class="toc-text">3.4、ClusterRoleBinding 示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-5%E3%80%81%E8%81%9A%E5%90%88%E7%9A%84-ClusterRole"><span class="toc-text">3.5、聚合的 ClusterRole</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/99081826.html" title="很强，3万字把华为HCIA知识点全部总结了！">很强，3万字把华为HCIA知识点全部总结了！</a><time datetime="2022-12-05T05:17:54.876Z" title="发表于 2022-12-05 13:17:54">2022-12-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/b0318225.html" title="浪潮服务器通过DHCP获取地址进入IPMI，BMC管理后台的方法，可实现远程安装系统、温度运行状态监测、风扇转速调整、远程开关机、KVM控制台显示器等功能">浪潮服务器通过DHCP获取地址进入IPMI，BMC管理后台的方法，可实现远程安装系统、温度运行状态监测、风扇转速调整、远程开关机、KVM控制台显示器等功能</a><time datetime="2022-12-05T05:17:54.860Z" title="发表于 2022-12-05 13:17:54">2022-12-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/f962716d.html" title="使用system-config-kickstart生成kickstart文件">使用system-config-kickstart生成kickstart文件</a><time datetime="2022-12-05T05:17:54.860Z" title="发表于 2022-12-05 13:17:54">2022-12-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/12ac960a.html" title="Linux高级篇--使用system-config-kickstart工具制作kickstart应答文件">Linux高级篇--使用system-config-kickstart工具制作kickstart应答文件</a><time datetime="2022-12-05T05:17:54.845Z" title="发表于 2022-12-05 13:17:54">2022-12-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/cefcf133.html" title="zabbix5.0 percona_mysql_template模板文件">zabbix5.0 percona_mysql_template模板文件</a><time datetime="2022-12-05T05:17:54.845Z" title="发表于 2022-12-05 13:17:54">2022-12-05</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By 壹拾陆</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>