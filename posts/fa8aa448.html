<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>k8s-devops | 壹拾陆</title><meta name="keywords" content="Linux"><meta name="author" content="壹拾陆"><meta name="copyright" content="壹拾陆"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1MB4y1Q7yR?p&#x3D;13&amp;spm_id_from&#x3D;pageDriver&amp;vd_source&#x3D;629395ac7befa1625191c3f496068941 k8s-devops 下载repo文件 123wget -O &#x2F;etc&#x2F;yum.repos.d&#x2F;docker-ce.repo https:&#x2F;&#x2F;mirror">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s-devops">
<meta property="og:url" content="https://mo-li001.github.io/posts/fa8aa448.html">
<meta property="og:site_name" content="壹拾陆">
<meta property="og:description" content="https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1MB4y1Q7yR?p&#x3D;13&amp;spm_id_from&#x3D;pageDriver&amp;vd_source&#x3D;629395ac7befa1625191c3f496068941 k8s-devops 下载repo文件 123wget -O &#x2F;etc&#x2F;yum.repos.d&#x2F;docker-ce.repo https:&#x2F;&#x2F;mirror">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-08-31T12:41:14.000Z">
<meta property="article:modified_time" content="2023-02-07T06:56:08.006Z">
<meta property="article:author" content="壹拾陆">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://mo-li001.github.io/posts/fa8aa448"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'k8s-devops',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-02-07 14:56:08'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202209182232723.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">68</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">壹拾陆</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">k8s-devops</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-31T12:41:14.000Z" title="发表于 2022-08-31 20:41:14">2022-08-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-02-07T06:56:08.006Z" title="更新于 2023-02-07 14:56:08">2023-02-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="k8s-devops"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1MB4y1Q7yR?p=13&amp;spm_id_from=pageDriver&amp;vd_source=629395ac7befa1625191c3f496068941">https://www.bilibili.com/video/BV1MB4y1Q7yR?p=13&amp;spm_id_from=pageDriver&amp;vd_source=629395ac7befa1625191c3f496068941</a></p>
<p>k8s-devops</p>
<p>下载repo文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">把软件仓库地址替换为 TUNA:</span><br><span class="line">sed -i &#x27;s#download.docker.com#mirrors.tuna.tsinghua.edu.cn/docker-ce#g&#x27; /etc/yum.repos.d/docker-ce.repo</span><br></pre></td></tr></table></figure>

<p>安装:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install docker-ce docker-compose -y</span><br></pre></td></tr></table></figure>

<p>查看docker和docker-compose版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker version</span><br><span class="line">docker-compose version</span><br></pre></td></tr></table></figure>



<p>拉取GitLab镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull gitlab/gitlab-ce:latest</span><br></pre></td></tr></table></figure>



<p>准备docker-compose.yml文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@git ~]# cd /opt/gitlab_docker/</span><br><span class="line">[root@git gitlab_docker]# vim docker-compose.yml</span><br><span class="line">version: &#x27;3.1&#x27;</span><br><span class="line">services:</span><br><span class="line">  gitlab:</span><br><span class="line">    image: &#x27;gitlab/gitlab-ce:latest&#x27;</span><br><span class="line">    container_name: gitlab</span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">      GITLAB_OMNIBUS_CONFIG: |</span><br><span class="line">        external_url &#x27;http://10.0.0.111:8929&#x27;</span><br><span class="line">        gitlab_rails[&#x27;gitlab_shell_ssh_port&#x27;] = 2224</span><br><span class="line">    ports:</span><br><span class="line">      - &#x27;8929:8929&#x27;</span><br><span class="line">      - &#x27;2224:2224&#x27;</span><br><span class="line">    volumes:</span><br><span class="line">      - &#x27;./config:/etc/gitlab&#x27;</span><br><span class="line">      - &#x27;./logs:/var/log/gitlab&#x27;</span><br><span class="line">      - &#x27;./data:/var/opt/gitlab&#x27;</span><br></pre></td></tr></table></figure>

<p>启动容器（需要稍等一小会……）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>查看日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@git ~]# docker-compose logs -f</span><br></pre></td></tr></table></figure>



<p>浏览器访问10.0.0.113:8929</p>
<p>查看root用户初始密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it gitlab cat /etc/gitlab/initial_root_password</span><br></pre></td></tr></table></figure>

<p>初始密码<code>Password: ng81mw/eI3AA8vmN87muKrWAsLalHeJE8nLDW9pHCBk=</code>，用户名root</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@git gitlab_docker]# docker exec -it gitlab cat /etc/gitlab/initial_root_password</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">WARNING: This value is valid only <span class="keyword">in</span> the following conditions</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">         1. If provided manually (either via `GITLAB_ROOT_PASSWORD` environment variable or via `gitlab_rails[<span class="string">&#x27;initial_root_password&#x27;</span>]` setting <span class="keyword">in</span> `gitlab.rb`, it was provided before database was seeded <span class="keyword">for</span> the first time (usually, the first reconfigure run).</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">         2. Password hasn<span class="string">&#x27;t been changed manually, either via UI or via command line.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash">#          If the password shown here doesn&#x27;</span>t work, you must reset the admin password following https://docs.gitlab.com/ee/security/reset_user_password.html<span class="comment">#reset-your-root-password.</span></span></span><br><span class="line"></span><br><span class="line">Password: ng81mw/eI3AA8vmN87muKrWAsLalHeJE8nLDW9pHCBk=</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">NOTE: This file will be automatically deleted <span class="keyword">in</span> the first reconfigure run after 24 hours.</span></span><br></pre></td></tr></table></figure>





<p>下载jdk</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdk-8u231-linux-x64.tar.gz</span><br></pre></td></tr></table></figure>

<p>下载Maven</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://dlcdn.apache.org/maven/maven-3/3.8.6/binaries/apache-maven-3.8.6-bin.tar.gz</span><br></pre></td></tr></table></figure>



<p>安装jdk</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]# tar -zxvf jdk-8u231-linux-x64.tar.gz -C /usr/local/</span><br></pre></td></tr></table></figure>

<p>安装Maven</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]# tar -zxvf apache-maven-3.8.6-bin.tar.gz -C /usr/local/</span><br></pre></td></tr></table></figure>

<p>目录改名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]# cd /usr/local/</span><br><span class="line">[root@jenkins local]# mv jdk1.8.0_231 jdk</span><br><span class="line">[root@jenkins local]# mv apache-maven-3.8.6 maven</span><br></pre></td></tr></table></figure>



<p>配置阿里云maven仓库地址</p>
<pre><code>[root@jenkins conf]# vim /usr/local/maven/conf/settings.xml
159      &lt;mirror&gt;
160        &lt;id&gt;AliRepo-aliyun&lt;/id&gt;
161        &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;
162        &lt;name&gt;Mirror Name for the Alirepo.&lt;/name&gt;
163        &lt;url&gt;https://maven.aliyun.com/repository/public&lt;/url&gt;
164      &lt;/mirror&gt;
</code></pre>
<p>maven配置settings.xml指定默认java8版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins conf]# vim /usr/local/maven/conf/settings.xml</span><br><span class="line">253   &lt;profile&gt;</span><br><span class="line">254     &lt;id&gt;jdk8&lt;/id&gt;</span><br><span class="line">255     &lt;activation&gt;</span><br><span class="line">256         &lt;activeByDefault&gt;true&lt;/activeByDefault&gt;</span><br><span class="line">257         &lt;jdk&gt;1.8&lt;/jdk&gt;</span><br><span class="line">258     &lt;/activation&gt;</span><br><span class="line">259     &lt;properties&gt;</span><br><span class="line">260         &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;</span><br><span class="line">261         &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;</span><br><span class="line">262         &lt;maven.compiler.compilerVersion&gt;1.8&lt;/maven.compiler.compilerVersion&gt;</span><br><span class="line">263     &lt;/properties&gt;</span><br><span class="line">264   &lt;/profile&gt;</span><br><span class="line"># 开启插件 id：jdk8</span><br><span class="line">275   &lt;activeProfiles&gt;</span><br><span class="line">276     &lt;activeProfile&gt;jdk8&lt;/activeProfile&gt;</span><br><span class="line">277   &lt;/activeProfiles&gt;</span><br></pre></td></tr></table></figure>



<p>5.2 Jenkins安装</p>
<p>拉取Jenkins镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull jenkins/jenkins:2.319.1-lts</span><br></pre></td></tr></table></figure>

<p>编写docker-compose.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]# mkdir -p /usr/local/docker/jenkins_docker</span><br><span class="line">[root@jenkins ~]# cd /usr/local/docker/jenkins_docker</span><br><span class="line">[root@jenkins jenkins_docker]# vim docker-compose.yml</span><br><span class="line">version: &quot;3.1&quot;</span><br><span class="line">services:</span><br><span class="line">  jenkins:</span><br><span class="line">    image: jenkins/jenkins:2.319.1-lts</span><br><span class="line">    container_name: jenkins</span><br><span class="line">    ports:</span><br><span class="line">      - 8080:8080</span><br><span class="line">      - 50000:50000</span><br><span class="line">    volumes:</span><br><span class="line">      - ./data/:/var/jenkins_home/</span><br><span class="line">[root@jenkins jenkins_docker]# docker-compose up -d</span><br><span class="line"></span><br><span class="line"># 查看日志报错提示没有权限</span><br><span class="line">[root@jenkins jenkins_docker]# docker logs -f jenkins</span><br><span class="line">touch: cannot touch &#x27;/var/jenkins_home/copy_reference_file.log&#x27;: Permission denied</span><br><span class="line">Can not write to /var/jenkins_home/copy_reference_file.log. Wrong volume permissions?</span><br><span class="line">[root@jenkins jenkins_docker]# ls</span><br><span class="line">data  docker-compose.yml</span><br><span class="line"># 给data目录加权</span><br><span class="line">[root@jenkins jenkins_docker]# chmod -R 777 data</span><br><span class="line"># 重新启动</span><br><span class="line">[root@jenkins jenkins_docker]# docker-compose restart</span><br><span class="line"># 查看日志正常运行 密码:6dedaed105f5493eae7da8bc93978519</span><br><span class="line">[root@jenkins jenkins_docker]# docker logs -f jenkins</span><br><span class="line">Jenkins initial setup is required. An admin user has been created and a password generated.</span><br><span class="line">Please use the following password to proceed to installation:</span><br><span class="line"></span><br><span class="line">6dedaed105f5493eae7da8bc93978519</span><br><span class="line"></span><br><span class="line">This may also be found at: /var/jenkins_home/secrets/initialAdminPassword</span><br></pre></td></tr></table></figure>

<p>浏览器访问10.0.0.112:8080，并解锁 Jenkins</p>
<p>创建第一个管理员用户</p>
<p>用户名: root</p>
<p>密码: root</p>
<p>确认密码: root</p>
<p>全名: root</p>
<p>电子邮件地址: <code>root@root.com</code></p>
<p>报错 重启systemctl restart docker即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins jenkins_docker]# docker-compose up -d</span><br><span class="line">Starting jenkins ... error</span><br><span class="line"></span><br><span class="line">ERROR: for jenkins  Cannot start service jenkins: driver failed programming external connectivity on endpoint jenkins (1c3bbacf2bbcf57a9a7745c7a45e6b6f7ac5e74111d08c1685ce704a79fd5cd9): Error starting userland proxy: listen tcp4 0.0.0.0:50000: bind: address already in use</span><br><span class="line"></span><br><span class="line">ERROR: for jenkins  Cannot start service jenkins: driver failed programming external connectivity on endpoint jenkins (1c3bbacf2bbcf57a9a7745c7a45e6b6f7ac5e74111d08c1685ce704a79fd5cd9): Error starting userland proxy: listen tcp4 0.0.0.0:50000: bind: address already in use</span><br><span class="line">ERROR: Encountered errors while bringing up the project.</span><br></pre></td></tr></table></figure>



<p><strong>安装插件</strong></p>
<p>Manage Jenkins —&gt; Manage Plugins —&gt; 可选插件</p>
<p>Git Parameter</p>
<p>Publish Over SSH</p>
<p>将jdk和maven移动到 jenkins的数据目录data</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins data]# mv /usr/local/jdk/ /usr/local/docker/jenkins_docker/data/</span><br><span class="line">[root@jenkins data]# mv /usr/local/maven/ /usr/local/docker/jenkins_docker/data/</span><br></pre></td></tr></table></figure>

<p>Manage Jenkins —&gt; Global Tool Configuration</p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210191946692.png" alt="image-20221019194557463"></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210191946596.png" alt="image-20221019194628458"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins jenkins_docker]# mkdir /usr/local/test</span><br></pre></td></tr></table></figure>

<p>Manage Jenkins —&gt; Configure System</p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210191946440.png" alt="image-20221019194655296"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/test&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello Jenkins!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;3.1&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  mytest:</span><br><span class="line">    build:</span><br><span class="line">      context: ./</span><br><span class="line">      dockerfile: Dockerfile</span><br><span class="line">    image: mytest:v1.<span class="number">0.0</span></span><br><span class="line">    container_name: mytest</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="number">8081</span>:<span class="number">8080</span></span><br></pre></td></tr></table></figure>



<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> daocloud.io/library/java:<span class="number">8</span>u40-jdk</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> mytest.jar /usr/local/</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /usr/local</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> java -jar mytest.jar &amp;&amp; <span class="built_in">tail</span> -F /var/log/messages</span></span><br></pre></td></tr></table></figure>



<p>Exec command</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/test/docker</span><br><span class="line">mv ../target/*jar ./</span><br><span class="line">docker-compose down</span><br><span class="line">docker-compose up -d --build</span><br><span class="line">docker image prune -f</span><br></pre></td></tr></table></figure>

<p><code>docker image prune -f</code> 删除 REPOSITORY 为 <none> 的镜像</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]<span class="comment"># docker pull postgres</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># docker pull sonarqube:8.9.6-community</span></span><br><span class="line">[root@jenkins ~]<span class="comment"># cd /usr/local/docker/</span></span><br><span class="line">[root@jenkins docker]<span class="comment"># mkdir sonarqube_docker</span></span><br><span class="line">[root@jenkins docker]<span class="comment"># cd sonarqube_docker/</span></span><br><span class="line">[root@jenkins sonarqube_docker]<span class="comment"># vim docker-compose.yml</span></span><br><span class="line">[root@jenkins sonarqube_docker]<span class="comment"># cat docker-compose.yml</span></span><br><span class="line">version: <span class="string">&#x27;3.1&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  db:</span><br><span class="line">    image: postgres</span><br><span class="line">    container_name: db</span><br><span class="line">    ports:</span><br><span class="line">      - 5432:5432</span><br><span class="line">    networks:</span><br><span class="line">      - sonarnet</span><br><span class="line">    environment:</span><br><span class="line">      POSTGRES_USER: sonar</span><br><span class="line">      POSTGRES_PASSWORD: sonar</span><br><span class="line">    sonarqube:</span><br><span class="line">      image: sonarqube:8.9.6-community</span><br><span class="line">      container_name: sonarqube</span><br><span class="line">      depends_on:</span><br><span class="line">        - db</span><br><span class="line">      ports:</span><br><span class="line">        - 9000:9000</span><br><span class="line">      networks:</span><br><span class="line">        - sonarnet</span><br><span class="line">      environment:</span><br><span class="line">        SONAR_JDBC_URL: jdbc:postgresql://db:5432/sonar</span><br><span class="line">        SONAR_JDBC_USERNAME: sonar</span><br><span class="line">        SONAR_JDBC_PASSWORD: sonar</span><br><span class="line">networks:</span><br><span class="line">  sonarnet:</span><br><span class="line">    driver: bridge</span><br><span class="line">[root@jenkins sonarqube_docker]<span class="comment"># docker-compose up -d</span></span><br></pre></td></tr></table></figure>





<p>报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins sonarqube_docker]# docker logs -f sonarqube</span><br><span class="line">ERROR: [1] bootstrap checks failed. You must address the points described in the following [1] lines before starting Elasticsearch.</span><br><span class="line">bootstrap check failure [1] of [1]: max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]</span><br><span class="line">ERROR: Elasticsearch did not exit normally - check the logs at /opt/sonarqube/logs/sonarqube.log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@jenkins sonarqube_docker]# vim /etc/sysctl.conf</span><br><span class="line">vm.max_map_count=262144</span><br><span class="line">[root@jenkins sonarqube_docker]# sysctl -p</span><br><span class="line">[root@jenkins sonarqube_docker]# docker-compose up -d</span><br></pre></td></tr></table></figure>



<p>浏览器访问10.0.0.112:9000，默认用户名：admin，密码：admin，密码改为了123456</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins data]# vim /usr/local/docker/jenkins_docker/data/maven/conf/settings.xml </span><br><span class="line">265   &lt;profile&gt;</span><br><span class="line">266      &lt;id&gt;sonar&lt;/id&gt;</span><br><span class="line">267      &lt;activation&gt;</span><br><span class="line">268          &lt;activByDefault&gt;true&lt;/activByDefault&gt;</span><br><span class="line">269      &lt;/activation&gt;</span><br><span class="line">270      &lt;properties&gt;</span><br><span class="line">271          &lt;sonar.login&gt;admin&lt;/sonar.login&gt;</span><br><span class="line">272          &lt;sonar.password&gt;123456&lt;/sonar.password&gt;</span><br><span class="line">273          &lt;sonar.host.url&gt;http://10.0.0.112:9000&lt;/sonar.host.url&gt;</span><br><span class="line">274      &lt;/properties&gt;</span><br><span class="line">275   &lt;/profile&gt;</span><br><span class="line">...</span><br><span class="line">286   &lt;activeProfiles&gt;</span><br><span class="line">287     &lt;activeProfile&gt;jdk8&lt;/activeProfile&gt;</span><br><span class="line">288     &lt;activeProfile&gt;sonar&lt;/activeProfile&gt;</span><br><span class="line">289   &lt;/activeProfiles&gt;</span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://www.sonarqube.org/downloads/">https://www.sonarqube.org/downloads/</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.sonarqube.org/latest/analysis/scan/sonarscanner/">https://docs.sonarqube.org/latest/analysis/scan/sonarscanner/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]# wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.6.0.2311-linux.zip</span><br><span class="line">[root@jenkins ~]# unzip sonar-scanner-cli-4.6.0.2311-linux.zip</span><br><span class="line">[root@jenkins ~]# mv sonar-scanner-4.6.0.2311-linux/ sonar-scanner</span><br><span class="line">[root@jenkins data]# mv ~/sonar-scanner /usr/local/docker/jenkins_docker/data/</span><br><span class="line">[root@jenkins conf]# vim /usr/local/docker/jenkins_docker/data/sonar-scanner/conf/sonar-scanner.properties</span><br><span class="line">5 sonar.host.url=http://10.0.0.112:9000</span><br><span class="line">.....</span><br><span class="line">8 sonar.sourceEncoding=UTF-8</span><br></pre></td></tr></table></figure>

<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210201320244.png" alt="image-20221020120039276"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins mytest]# /usr/local/docker/jenkins_docker/data/sonar-scanner/bin/sonar-scanner -Dsoanr.sources=./ -Dsonar.projectname=linux-test -Dsonar.login=a3a411a960c53cf6a503247efe78131bc571970e -Dsonar.projectKey=linux-test -Dsonar.java.binaries=./target/</span><br></pre></td></tr></table></figure>





<p>Jenkins安装插件</p>
<p>sonarqube</p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210201320312.png" alt="image-20221020131630617"></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210201318899.png" alt="image-20221020131842781"></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210201319348.png" alt="image-20221020131952239"></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210201321994.png" alt="image-20221020132153871"></p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210201326494.png" alt="image-20221020132626350"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sonar.projectname=$&#123;JOB_NAME&#125;</span><br><span class="line">sonar.projectKey=$&#123;JOB_NAME&#125;</span><br><span class="line">sonar.source=./</span><br><span class="line">sonar.java.binaries=target</span><br></pre></td></tr></table></figure>





<p>报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">....</span><br><span class="line">Caused by: java.io.FileNotFoundException: /var/jenkins_home/workspace/mytest/.scannerwork/.sonar_lock (Permission denied)</span><br><span class="line">...</span><br><span class="line">ERROR: </span><br><span class="line">ERROR: Re-run SonarScanner using the -X switch to enable full debug logging.</span><br><span class="line">ERROR: SonarQube scanner exited with non-zero code: 1</span><br><span class="line">SSH: Current build result is [FAILURE], not going to run.</span><br><span class="line">Finished: FAILURE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@jenkins mytest]# cd /usr/local/docker/jenkins_docker/data/workspace/mytest</span><br><span class="line">[root@jenkins mytest]# ls -a</span><br><span class="line">.  ..  docker  .git  .gitignore  pom.xml  .scannerwork  src  target</span><br><span class="line">[root@jenkins mytest]# rm -rf .scannerwork/</span><br><span class="line"></span><br><span class="line">重新构建</span><br></pre></td></tr></table></figure>





<p>安装harbor</p>
<p><a target="_blank" rel="noopener" href="https://goharbor.io/">https://goharbor.io/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/goharbor/harbor/releases/tag/v2.3.4">https://github.com/goharbor/harbor/releases/tag/v2.3.4</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]# tar -zxvf harbor-offline-installer-v2.3.4.tgz -C /usr/local/</span><br><span class="line">[root@jenkins ~]# cd /usr/local/harbor/</span><br><span class="line">[root@jenkins harbor]# ls</span><br><span class="line">common.sh  harbor.v2.3.4.tar.gz  harbor.yml.tmpl  install.sh  LICENSE  prepare</span><br><span class="line">[root@jenkins harbor]# cp harbor.yml.tmpl harbor.yml</span><br><span class="line">[root@jenkins harbor]# vim harbor.yml</span><br><span class="line">hostname: 10.0.0.112</span><br><span class="line">#https:</span><br><span class="line">  #port: 443</span><br><span class="line">harbor_admin_password: Harbor12345  #默认密码</span><br><span class="line">[root@jenkins harbor]# ./install.sh</span><br></pre></td></tr></table></figure>

<p>浏览器访问10.0.0.112</p>
<p>上传镜像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins harbor]# vi /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;insecure-registries&quot;: [&quot;10.0.0.112:80&quot;]</span><br><span class="line">&#125;</span><br><span class="line">[root@jenkins harbor]# docker tag a44ecc7ae6e9 10.0.0.112:80/repo/mytest:v1.0.0</span><br><span class="line">[root@jenkins harbor]# docker images</span><br><span class="line">REPOSITORY                      TAG               IMAGE ID       CREATED         SIZE</span><br><span class="line">mytest                          v1.0.0            a44ecc7ae6e9   4 hours ago     833MB</span><br><span class="line">10.0.0.112:80/repo/mytest       v1.0.0            a44ecc7ae6e9   4 hours ago     833MB</span><br><span class="line"></span><br><span class="line">#报错</span><br><span class="line">[root@jenkins harbor]# docker push 10.0.0.112:80/repo/mytest:v1.0.0</span><br><span class="line">The push refers to repository [10.0.0.112:80/repo/mytest]</span><br><span class="line">Get &quot;https://10.0.0.112:80/v2/&quot;: http: server gave HTTP response to HTTPS client</span><br><span class="line">[root@jenkins harbor]# systemctl restart docker</span><br><span class="line"></span><br><span class="line">#报错</span><br><span class="line">[root@jenkins harbor]# docker push 10.0.0.112:80/repo/mytest:v1.0.0</span><br><span class="line">The push refers to repository [10.0.0.112:80/repo/mytest]</span><br><span class="line">...</span><br><span class="line">unauthorized: unauthorized to access repository: repo/mytest, action: push: unauthorized to access repository: repo/mytest, action: push</span><br><span class="line">#登录</span><br><span class="line">[root@jenkins harbor]# docker login -u admin -p Harbor12345 10.0.0.112:80</span><br><span class="line">WARNING! Using --password via the CLI is insecure. Use --password-stdin.</span><br><span class="line">WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line">#再次推送</span><br><span class="line">[root@jenkins harbor]# docker push 10.0.0.112:80/repo/mytest:v1.0.0</span><br><span class="line"></span><br><span class="line">#删除原本镜像</span><br><span class="line">[root@jenkins harbor]# docker rmi -f a44ecc7ae6e9</span><br><span class="line"></span><br><span class="line">#拉取</span><br><span class="line">[root@jenkins harbor]# docker pull 10.0.0.112:80/repo/mytest:v1.0.0</span><br></pre></td></tr></table></figure>





<p>配置docker</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins run]# cd /var/run/</span><br><span class="line">[root@jenkins run]# chown root:root docker.sock</span><br><span class="line">[root@jenkins run]# chmod o+rw docker.sock</span><br><span class="line">srw-rw-rw-  1 root   root      0 10月 19 17:46 docker.sock</span><br><span class="line"></span><br><span class="line">[root@jenkins jenkins_docker]# vim docker-compose.yml</span><br><span class="line"></span><br><span class="line">version: &quot;3.1&quot;</span><br><span class="line">services:</span><br><span class="line">  jenkins:</span><br><span class="line">    image: jenkins/jenkins:2.319.1-lts</span><br><span class="line">    container_name: jenkins</span><br><span class="line">    ports:</span><br><span class="line">      - 8080:8080</span><br><span class="line">      - 50000:50000</span><br><span class="line">    volumes:</span><br><span class="line">      - ./data/:/var/jenkins_home/</span><br><span class="line">      - /var/run/docker.sock:/var/run/docker.sock</span><br><span class="line">      - /usr/bin/docker:/usr/bin/docker</span><br><span class="line">      - /etc/docker/daemon.json:/etc/docker/daemon.json</span><br></pre></td></tr></table></figure>







<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mv target/*.jar docker/</span><br><span class="line">docker build -t mytest:$tag docker/</span><br><span class="line">docker login -u admin -p Harbor12345 10.0.0.112:80</span><br><span class="line">docker tag mytest:$tag 10.0.0.112:80/repo/mytest:$tag</span><br><span class="line">docker push 10.0.0.112:80/repo/mytest:$tag</span><br></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins run]# docker images</span><br><span class="line">REPOSITORY                      TAG               IMAGE ID       CREATED          SIZE</span><br><span class="line">mytest                          v3.0.0            8fb57de612a9   13 seconds ago   833MB</span><br></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins ~]# vim deploy.sh</span><br><span class="line">horbar_addr=$1</span><br><span class="line">horbar_repo=$2</span><br><span class="line">project=$3</span><br><span class="line">version=$4</span><br><span class="line">container_port=$5</span><br><span class="line">host_port=$6</span><br><span class="line"></span><br><span class="line">imageName=$horbar_addr/$horbar_repo/$project:$version</span><br><span class="line"></span><br><span class="line">echo $imageName</span><br><span class="line"></span><br><span class="line">containerId=`docker ps -a | grep $&#123;project&#125; | awk &#x27;&#123;print $1&#125;&#x27;`</span><br><span class="line"></span><br><span class="line">echo $containerId</span><br><span class="line"></span><br><span class="line">if [ &quot;$containerId&quot; != &quot;&quot; ] ; then</span><br><span class="line">  docker stop $containerId</span><br><span class="line">  docker rm $containerId</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">tag=`docker images | grep $&#123;project&#125; | awk &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line"></span><br><span class="line">echo $tag</span><br><span class="line"></span><br><span class="line">if [[ &quot;$tag&quot; =~ &quot;$version&quot; ]] ; then</span><br><span class="line">  docker rmi -f $imageName</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">docker login -u admin -p Harbor12345 $horbar_addr</span><br><span class="line"></span><br><span class="line">docker pull $imageName</span><br><span class="line"></span><br><span class="line">docker run -d -p $host_port:$container_port --name $project $imageName</span><br><span class="line"></span><br><span class="line">echo &quot;SUCCESS&quot;</span><br><span class="line"></span><br><span class="line">[root@jenkins ~]# chmod a+x deploy.sh</span><br><span class="line">[root@jenkins ~]# ./deploy.sh 10.0.0.112:80 repo mytest v3.0.0 8081</span><br><span class="line">10.0.0.112:80/repo/mytest:v3.0.0</span><br><span class="line"></span><br><span class="line">v3.0.0 v3.0.0 v2.0.0 v1.0.0</span><br><span class="line">Untagged: 10.0.0.112:80/repo/mytest:v3.0.0</span><br><span class="line">Untagged: 10.0.0.112:80/repo/mytest@sha256:6b779c542cc0ee59b59d044d92483871f0f9b5a1c95f5db768af235009640183</span><br><span class="line">WARNING! Using --password via the CLI is insecure. Use --password-stdin.</span><br><span class="line">WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line">v3.0.0: Pulling from repo/mytest</span><br><span class="line">Digest: sha256:6b779c542cc0ee59b59d044d92483871f0f9b5a1c95f5db768af235009640183</span><br><span class="line">Status: Downloaded newer image for 10.0.0.112:80/repo/mytest:v3.0.0</span><br><span class="line">10.0.0.112:80/repo/mytest:v3.0.0</span><br><span class="line">9faefa7d809dc69f1e06131246f70c540996ca83053396fd54b0ec1daa22a1ca</span><br><span class="line">SUCCESS</span><br><span class="line"></span><br><span class="line">[root@jenkins ~]# mv deploy.sh /usr/bin/</span><br></pre></td></tr></table></figure>









<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 所有的脚本命令都放在pipeline中</span></span><br><span class="line">pipeline <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// 指定任务再哪个集群节点中执行</span></span><br><span class="line">    agent any</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 声明全局变量，方便后面使用</span></span><br><span class="line">    environment <span class="punctuation">&#123;</span></span><br><span class="line">        key = &#x27;value&#x27;</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    stages <span class="punctuation">&#123;</span></span><br><span class="line">        stage(&#x27;拉取git仓库代码&#x27;) <span class="punctuation">&#123;</span></span><br><span class="line">            steps <span class="punctuation">&#123;</span></span><br><span class="line">                echo &#x27;拉取git仓库代码 - SUCCESS&#x27;</span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        stage(&#x27;通过maven构建项目&#x27;) <span class="punctuation">&#123;</span></span><br><span class="line">            steps <span class="punctuation">&#123;</span></span><br><span class="line">                echo &#x27;通过maven构建项目 - SUCCESS&#x27;</span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        stage(&#x27;通过SonarQube做代码质量检测&#x27;) <span class="punctuation">&#123;</span></span><br><span class="line">            steps <span class="punctuation">&#123;</span></span><br><span class="line">                echo &#x27;通过SonarQube做代码质量检测 - SUCCESS&#x27;</span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        stage(&#x27;通过Docker制作自定义镜像&#x27;) <span class="punctuation">&#123;</span></span><br><span class="line">            steps <span class="punctuation">&#123;</span></span><br><span class="line">                echo &#x27;通过Docker制作自定义镜像 - SUCCESS&#x27;</span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        stage(&#x27;将自定义镜像推送到Harbor&#x27;) <span class="punctuation">&#123;</span></span><br><span class="line">            steps <span class="punctuation">&#123;</span></span><br><span class="line">                echo &#x27;将自定义镜像推送到Harbor - SUCCESS&#x27;</span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        stage(&#x27;通过Publish Over SSH通知目标服务器&#x27;) <span class="punctuation">&#123;</span></span><br><span class="line">            steps <span class="punctuation">&#123;</span></span><br><span class="line">                echo &#x27;通过Publish Over SSH通知目标服务器 - SUCCESS&#x27;</span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>







<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/jenkins_home/sonar-scanner/bin/sonar-scanner -Dsonar.source=./ -Dsonar.projectname=$(JOB_NAME) -Dsonar.projectKey=$(JOB_NAME) -Dsonar.java.binaries=./target/ -Dsonar.login=76c8e00a7e2330dba53530cbf932b2e3e2eb2968</span><br></pre></td></tr></table></figure>





<h2 id="29-pipeline-构建后钉钉通知消息"><a href="#29-pipeline-构建后钉钉通知消息" class="headerlink" title="29.pipeline-构建后钉钉通知消息"></a>29.pipeline-构建后钉钉通知消息</h2><p>DingTalk</p>
<p>钉钉 Jenkins 插件 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://oapi.dingtalk.com/robot/send?access_token=5291d46e281e79017403c15ccb921323da55f46508bf5f4a84e693284a4a63d9</span><br></pre></td></tr></table></figure>









<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">// 所有的脚本命令都放在pipeline中</span><br><span class="line">pipeline &#123;</span><br><span class="line">    // 指定任务再哪个集群节点中执行</span><br><span class="line">    agent any</span><br><span class="line"></span><br><span class="line">    // 声明全局变量，方便后面使用</span><br><span class="line">    environment &#123;</span><br><span class="line">        harborUser = &#x27;admin&#x27;</span><br><span class="line">        harborPasswd = &#x27;Harbor12345&#x27;</span><br><span class="line">        harborAddress = &#x27;10.0.0.112:80&#x27;</span><br><span class="line">        harborRepo = &#x27;repo&#x27;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;拉取git仓库代码&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                checkout([$class: &#x27;GitSCM&#x27;, branches: [[name: &#x27;*/master&#x27;]], extensions: [], userRemoteConfigs: [[credentialsId: &#x27;9e274219-f3b7-4ce4-a23b-c0ed3141e693&#x27;, url: &#x27;http://10.0.0.113:8929/gitlab-instance-b56ddcfc/mytest.git&#x27;]]])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;通过maven构建项目&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh &#x27;/var/jenkins_home/maven/bin/mvn clean package -DskipTests&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;通过SonarQube做代码质量检测&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh &#x27;/var/jenkins_home/sonar-scanner/bin/sonar-scanner -Dsonar.source=./ -Dsonar.projectname=$&#123;JOB_NAME&#125; -Dsonar.projectKey=$&#123;JOB_NAME&#125; -Dsonar.java.binaries=./target/ -Dsonar.login=76c8e00a7e2330dba53530cbf932b2e3e2eb2968&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;通过Docker制作自定义镜像&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh &#x27;&#x27;&#x27;mv ./target/*.jar ./docker/</span><br><span class="line">docker build -t $&#123;JOB_NAME&#125;:$&#123;tag&#125; ./docker/&#x27;&#x27;&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;将自定义镜像推送到Harbor&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh &#x27;&#x27;&#x27;docker login -u $&#123;harborUser&#125; -p $&#123;harborPasswd&#125; $&#123;harborAddress&#125;</span><br><span class="line">docker tag $&#123;JOB_NAME&#125;:$&#123;tag&#125; $&#123;harborAddress&#125;/$&#123;harborRepo&#125;/$&#123;JOB_NAME&#125;:$&#123;tag&#125;</span><br><span class="line">docker push $&#123;harborAddress&#125;/$&#123;harborRepo&#125;/$&#123;JOB_NAME&#125;:$&#123;tag&#125;&#x27;&#x27;&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;通过Publish Over SSH通知目标服务器&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sshPublisher(publishers: [sshPublisherDesc(configName: &#x27;test&#x27;, transfers: [sshTransfer(cleanRemote: false, excludes: &#x27;&#x27;, execCommand: &quot;deploy.sh $harborAddress $harborRepo $JOB_NAME $tag $container_port $host_port&quot;, execTimeout: 120000, flatten: false, makeEmptyDirs: false, noDefaultExcludes: false, patternSeparator: &#x27;[, ]+&#x27;, remoteDirectory: &#x27;&#x27;, remoteDirectorySDF: false, removePrefix: &#x27;&#x27;, sourceFiles: &#x27;&#x27;)], usePromotionTimestamp: false, useWorkspaceInPromotion: false, verbose: false)])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    post &#123;</span><br><span class="line">        success &#123;</span><br><span class="line">            dingtalk(</span><br><span class="line">                robot: &#x27;Jenikins-DingDing&#x27;,</span><br><span class="line">                type: &#x27;MARKDOWN&#x27;,</span><br><span class="line">                title: &#x27;success: $&#123;JOB_NAME&#125;&#x27;,</span><br><span class="line">                text: [&quot;- 成功构建: $&#123;JOB_NAME&#125;! \n- 版本: $&#123;tag&#125; \n- 持续时间: $&#123;currentBuild.durationString&#125;&quot;]</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">        failure &#123;</span><br><span class="line">            dingtalk(</span><br><span class="line">                robot: &#x27;Jenikins-DingDing&#x27;,</span><br><span class="line">                type: &#x27;MARKDOWN&#x27;,</span><br><span class="line">                title: &#x27;success: $&#123;JOB_NAME&#125;&#x27;,</span><br><span class="line">                text: [&quot;- 构建失败: $&#123;JOB_NAME&#125;! \n- 版本: $&#123;tag&#125; \n- 持续时间: $&#123;currentBuild.durationString&#125;&quot;]</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="使用kubeadm安装kubernetes-v1-19-x"><a href="#使用kubeadm安装kubernetes-v1-19-x" class="headerlink" title="使用kubeadm安装kubernetes_v1.19.x"></a><a target="_blank" rel="noopener" href="https://kuboard.cn/install/history-k8s/install-k8s-1.19.x.html">使用kubeadm安装kubernetes_v1.19.x</a></h1><h2 id="检查-centos-x2F-hostname"><a href="#检查-centos-x2F-hostname" class="headerlink" title="检查 centos &#x2F; hostname"></a>检查 centos &#x2F; hostname</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 master 节点和 worker 节点都要执行</span></span><br><span class="line"><span class="built_in">cat</span> /etc/redhat-release</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此处 hostname 的输出将会是该机器在 Kubernetes 集群中的节点名字</span></span><br><span class="line"><span class="comment"># 不能使用 localhost 作为节点的名字</span></span><br><span class="line">hostname</span><br><span class="line"></span><br><span class="line"><span class="comment"># 请使用 lscpu 命令，核对 CPU 信息</span></span><br><span class="line"><span class="comment"># Architecture: x86_64    本安装文档不支持 arm 架构</span></span><br><span class="line"><span class="comment"># CPU(s):       2         CPU 内核数量不能低于 2</span></span><br><span class="line">lscpu</span><br></pre></td></tr></table></figure>



<blockquote>
<p>修改 hostname</p>
<p>如果您需要修改 hostname，可执行如下指令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改 hostname</span></span><br><span class="line">hostnamectl set-hostname your-new-host-name</span><br><span class="line"><span class="comment"># 查看修改结果</span></span><br><span class="line">hostnamectl status</span><br><span class="line"><span class="comment"># 设置 hostname 解析</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;127.0.0.1   <span class="subst">$(hostname)</span>&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
</blockquote>
<p>master</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname  k8sMaster</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;127.0.0.1   <span class="subst">$(hostname)</span>&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<p>worker</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname  k8sWorker</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;127.0.0.1   <span class="subst">$(hostname)</span>&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>



<h2 id="安装docker及kubelet"><a href="#安装docker及kubelet" class="headerlink" title="安装docker及kubelet"></a>安装docker及kubelet</h2><p>master</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> REGISTRY_MIRROR=https://registry.cn-hangzhou.aliyuncs.com</span><br><span class="line">curl -sSL https://kuboard.cn/install-script/v1.19.x/install_kubelet.sh | sh -s 1.19.5</span><br></pre></td></tr></table></figure>

<p>worker</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> REGISTRY_MIRROR=https://registry.cn-hangzhou.aliyuncs.com</span><br><span class="line">curl -sSL https://kuboard.cn/install-script/v1.19.x/install_kubelet.sh | sh -s 1.19.5</span><br></pre></td></tr></table></figure>



<h2 id="初始化-master-节点"><a href="#初始化-master-节点" class="headerlink" title="初始化 master 节点"></a>初始化 master 节点</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在 master 节点执行</span></span><br><span class="line"><span class="comment"># 替换 x.x.x.x 为 master 节点实际 IP（请使用内网 IP）</span></span><br><span class="line"><span class="comment"># export 命令只在当前 shell 会话中有效，开启新的 shell 窗口后，如果要继续安装过程，请重新执行此处的 export 命令</span></span><br><span class="line"><span class="built_in">export</span> MASTER_IP=10.0.0.113</span><br><span class="line"><span class="comment"># 替换 apiserver.demo 为 您想要的 dnsName</span></span><br><span class="line"><span class="built_in">export</span> APISERVER_NAME=mashibing.com</span><br><span class="line"><span class="comment"># Kubernetes 容器组所在的网段，该网段安装完成后，由 kubernetes 创建，事先并不存在于您的物理网络中</span></span><br><span class="line"><span class="built_in">export</span> POD_SUBNET=10.100.0.1/16</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;MASTER_IP&#125;</span>    <span class="variable">$&#123;APISERVER_NAME&#125;</span>&quot;</span> &gt;&gt; /etc/hosts</span><br><span class="line">curl -sSL https://kuboard.cn/install-script/v1.19.x/init_master.sh | sh -s 1.19.5</span><br></pre></td></tr></table></figure>



<p><strong>检查 master 初始化结果</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在 master 节点执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行如下命令，等待 3-10 分钟，直到所有的容器组处于 Running 状态</span></span><br><span class="line">watch kubectl get pod -n kube-system -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 master 节点初始化结果</span></span><br><span class="line">kubectl get nodes -o wide</span><br></pre></td></tr></table></figure>



<h2 id="初始化-worker节点"><a href="#初始化-worker节点" class="headerlink" title="初始化 worker节点"></a>初始化 worker节点</h2><h3 id="获得-join命令参数"><a href="#获得-join命令参数" class="headerlink" title="获得 join命令参数"></a>获得 join命令参数</h3><p><strong>在 master 节点上执行</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在 master 节点执行</span></span><br><span class="line">kubeadm token create --print-join-command </span><br></pre></td></tr></table></figure>

<p>可获取kubeadm join 命令及参数，如下所示</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubeadm token create 命令的输出</span></span><br><span class="line">kubeadm <span class="built_in">join</span> apiserver.demo:6443 --token mpfjma.4vjjg8flqihor4vt     --discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>有效时间</p>
<p>该 token 的有效时间为 2 个小时，2小时内，您可以使用此 token 初始化任意数量的 worker 节点。</p>
</blockquote>
<h3 id="初始化worker"><a href="#初始化worker" class="headerlink" title="初始化worker"></a>初始化worker</h3><p><strong>针对所有的 worker 节点执行</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在 worker 节点执行</span></span><br><span class="line"><span class="comment"># 替换 x.x.x.x 为 master 节点的内网 IP</span></span><br><span class="line"><span class="built_in">export</span> MASTER_IP=10.0.0.113</span><br><span class="line"><span class="comment"># 替换 apiserver.demo 为初始化 master 节点时所使用的 APISERVER_NAME</span></span><br><span class="line"><span class="built_in">export</span> APISERVER_NAME=mashibing.com</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;MASTER_IP&#125;</span>    <span class="variable">$&#123;APISERVER_NAME&#125;</span>&quot;</span> &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 替换为 master 节点上 kubeadm token create 命令的输出</span></span><br><span class="line">kubeadm <span class="built_in">join</span> apiserver.demo:6443 --token mpfjma.4vjjg8flqihor4vt     --discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303</span><br></pre></td></tr></table></figure>



<h3 id="检查初始化结果"><a href="#检查初始化结果" class="headerlink" title="检查初始化结果"></a>检查初始化结果</h3><p>在 master 节点上执行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在 master 节点执行</span></span><br><span class="line">kubectl get nodes -o wide</span><br></pre></td></tr></table></figure>

<p>输出结果如下所示：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@demo-master-a-1 ~]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME     STATUS   ROLES    AGE     VERSION</span><br><span class="line">demo-master-a-1   Ready    master   5m3s    v1.19.x</span><br><span class="line">demo-worker-a-1   Ready    &lt;none&gt;   2m26s   v1.19.x</span><br><span class="line">demo-worker-a-2   Ready    &lt;none&gt;   3m56s   v1.19.x</span><br></pre></td></tr></table></figure>







<h1 id="安装-Kuboard-v3-kubernetes"><a href="#安装-Kuboard-v3-kubernetes" class="headerlink" title="安装 Kuboard v3 - kubernetes"></a>安装 Kuboard v3 - kubernetes</h1><p>执行 Kuboard v3 在 K8S 中的安装</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://addons.kuboard.cn/kuboard/kuboard-v3-swr.yaml</span><br></pre></td></tr></table></figure>

<p>执行指令 <code>watch kubectl get pods -n kuboard</code>，等待 kuboard 名称空间中所有的 Pod 就绪</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># kubectl get pods -n kuboard</span></span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">kuboard-agent-2-65bc84c86c-r7tc4   1/1     Running   2          28s</span><br><span class="line">kuboard-etcd-fh9rp                 1/1     Running   0          67s</span><br><span class="line">kuboard-v3-645bdffbf6-sbdxb        1/1     Running   0          67s</span><br></pre></td></tr></table></figure>



<h3 id="访问-Kuboard"><a href="#访问-Kuboard" class="headerlink" title="访问 Kuboard"></a>访问 Kuboard</h3><ul>
<li>在浏览器中打开链接 <code>http://10.0.0.113:30080</code></li>
<li>输入初始用户名和密码，并登录<ul>
<li>用户名： <code>admin</code></li>
<li>密码： <code>Kuboard123</code></li>
</ul>
</li>
</ul>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210212129185.png" alt="image-20221021212913945"></p>
<p>创建命名空间test</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]<span class="comment"># kubectl create namespace test</span></span><br><span class="line">namespace/test created</span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl get namespace</span></span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   9m50s</span><br><span class="line">kube-node-lease   Active   9m51s</span><br><span class="line">kube-public       Active   9m51s</span><br><span class="line">kube-system       Active   9m51s</span><br><span class="line">kuboard           Active   5m36s</span><br><span class="line"><span class="built_in">test</span>              Active   2s</span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl delete namespace test</span></span><br><span class="line">namespace <span class="string">&quot;test&quot;</span> deleted</span><br></pre></td></tr></table></figure>

<p>用yaml语法文件创建test命名空间</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]<span class="comment"># vim namespace-test.yml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl apply -f namespace-test.yml </span></span><br><span class="line">namespace/test created</span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl get namespace</span></span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   14m</span><br><span class="line">kube-node-lease   Active   14m</span><br><span class="line">kube-public       Active   14m</span><br><span class="line">kube-system       Active   14m</span><br><span class="line">kuboard           Active   9m51s</span><br><span class="line"><span class="built_in">test</span>              Active   75s</span><br></pre></td></tr></table></figure>

<p>查看全部pods，不管命名空间</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]<span class="comment"># kubectl get pods -A</span></span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   calico-kube-controllers-6c89d944d5-sr724   1/1     Running   0          19m</span><br><span class="line">kube-system   calico-node-42lml                          1/1     Running   0          19m</span><br><span class="line">kube-system   calico-node-t9tqq                          1/1     Running   0          16m</span><br><span class="line">kube-system   coredns-59c898cd69-lrn85                   1/1     Running   0          19m</span><br><span class="line">kube-system   coredns-59c898cd69-m7pgp                   1/1     Running   0          19m</span><br><span class="line">kube-system   etcd-k8smaster                             1/1     Running   0          19m</span><br><span class="line">kube-system   kube-apiserver-k8smaster                   1/1     Running   0          19m</span><br><span class="line">kube-system   kube-controller-manager-k8smaster          1/1     Running   0          19m</span><br><span class="line">kube-system   kube-proxy-9sx8r                           1/1     Running   0          16m</span><br><span class="line">kube-system   kube-proxy-cz9gq                           1/1     Running   0          19m</span><br><span class="line">kube-system   kube-scheduler-k8smaster                   1/1     Running   0          19m</span><br><span class="line">kuboard       kuboard-agent-2-5d64598975-v869s           1/1     Running   0          14m</span><br><span class="line">kuboard       kuboard-agent-9887449fc-fgw2m              1/1     Running   0          14m</span><br><span class="line">kuboard       kuboard-etcd-ltfdv                         1/1     Running   0          15m</span><br><span class="line">kuboard       kuboard-v3-79797c7b84-px8lv                1/1     Running   0          15m</span><br></pre></td></tr></table></figure>

<p>创建nginx的pod</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]<span class="comment"># kubectl run nginx --image=nginx:latest</span></span><br><span class="line">pod/nginx created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看默认命名空间下的pod</span></span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl get pod -n default</span></span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx   1/1     Running   0          76s</span><br></pre></td></tr></table></figure>

<p>查看pod的详细信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]<span class="comment"># kubectl describe pod nginx</span></span><br><span class="line">Name:         nginx</span><br><span class="line">Namespace:    default</span><br><span class="line">Priority:     0</span><br><span class="line">Node:         k8sworker/10.0.0.114</span><br><span class="line">Start Time:   Fri, 21 Oct 2022 21:43:31 +0800</span><br><span class="line">Labels:       run=nginx</span><br><span class="line">Annotations:  cni.projectcalico.org/podIP: 10.100.162.193/32</span><br><span class="line">              cni.projectcalico.org/podIPs: 10.100.162.193/32</span><br><span class="line">Status:       Running</span><br><span class="line">IP:           10.100.162.193</span><br><span class="line">IPs:</span><br><span class="line">  IP:  10.100.162.193</span><br><span class="line">Containers:</span><br><span class="line">  nginx:</span><br><span class="line">    Container ID:   docker://300a948ddf492aa1ded88537e1679dac078bc5230719587b42fac2ed6bababe1</span><br><span class="line">    Image:          nginx:latest</span><br><span class="line">    Image ID:       docker-pullable://nginx@sha256:5ffb682b98b0362b66754387e86b0cd31a5cb7123e49e7f6f6617690900d20b2</span><br><span class="line">    Port:           &lt;none&gt;</span><br><span class="line">    Host Port:      &lt;none&gt;</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Fri, 21 Oct 2022 21:44:08 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:    &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-bxlrq (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True </span><br><span class="line">  Ready             True </span><br><span class="line">  ContainersReady   True </span><br><span class="line">  PodScheduled      True </span><br><span class="line">Volumes:</span><br><span class="line">  default-token-bxlrq:</span><br><span class="line">    Type:        Secret (a volume populated by a Secret)</span><br><span class="line">    SecretName:  default-token-bxlrq</span><br><span class="line">    Optional:    <span class="literal">false</span></span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute op=Exists <span class="keyword">for</span> 300s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute op=Exists <span class="keyword">for</span> 300s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age    From               Message</span><br><span class="line">  ----    ------     ----   ----               -------</span><br><span class="line">  Normal  Scheduled  2m20s  default-scheduler  Successfully assigned default/nginx to k8sworker</span><br><span class="line">  Normal  Pulling    2m19s  kubelet            Pulling image <span class="string">&quot;nginx:latest&quot;</span></span><br><span class="line">  Normal  Pulled     103s   kubelet            Successfully pulled image <span class="string">&quot;nginx:latest&quot;</span> <span class="keyword">in</span> 35.411676347s</span><br><span class="line">  Normal  Created    103s   kubelet            Created container nginx</span><br><span class="line">  Normal  Started    103s   kubelet            Started container nginx</span><br></pre></td></tr></table></figure>



<p>DaoCloud镜像市场：<a target="_blank" rel="noopener" href="http://hub.daocloud.io/">http://hub.daocloud.io/</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]<span class="comment"># kubectl delete pod nginx -n default</span></span><br><span class="line">pod <span class="string">&quot;nginx&quot;</span> deleted</span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl run nginx --image=daocloud.io/library/nginx:1.9.1 -n test</span></span><br><span class="line">pod/nginx created</span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl get pod -n test</span></span><br><span class="line">NAME    READY   STATUS             RESTARTS   AGE</span><br><span class="line">nginx   0/1     ImagePullBackOff   0          36s</span><br></pre></td></tr></table></figure>



<p>查看nginx的pod的日志</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]<span class="comment"># kubeclt logs -f nginx -n test</span></span><br></pre></td></tr></table></figure>



<p>进入到nginx的pod</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]<span class="comment"># kubectl exec -it nginx -n test -- bash</span></span><br></pre></td></tr></table></figure>



<p>配置pod-nginx.yml</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]<span class="comment"># vim pod-nginx.yml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-yml</span><br><span class="line">  namespace: <span class="built_in">test</span></span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx:latest</span><br><span class="line">    name: nginx-yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过yml文件启动pod</span></span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl apply -f pod-nginx.yml </span></span><br><span class="line">pod/nginx-yml created</span><br><span class="line"><span class="comment"># 查看test命名空间下的pod</span></span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl get pod -n test</span></span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx       1/1     Running   0          15m</span><br><span class="line">nginx-yml   1/1     Running   0          27s</span><br><span class="line"><span class="comment"># 查看pod详细信息</span></span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl describe pod nginx-yml -n test</span></span><br><span class="line"><span class="comment"># 删除pod</span></span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl delete -f pod-nginx.yml </span></span><br><span class="line">pod <span class="string">&quot;nginx-yml&quot;</span> deleted</span><br></pre></td></tr></table></figure>



<p>编写pod-nginx-tomcat.yml</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]<span class="comment"># vim pod-nginx-tomcat.yml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-tomcat</span><br><span class="line">  namespace: <span class="built_in">test</span></span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: nginx:latest</span><br><span class="line">    name: nginx</span><br><span class="line">  - image: tomcat:latest</span><br><span class="line">    name: tomcat</span><br><span class="line"></span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl apply -f pod-nginx-tomcat.yml </span></span><br><span class="line">pod/nginx-tomcat created</span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl describe pod nginx-tomcat -n test</span></span><br></pre></td></tr></table></figure>



<p>创建deployment</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建deployment</span></span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl create deployment deploy-nginx --image=nginx:latest</span></span><br><span class="line">deployment.apps/deploy-nginx created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看deployment</span></span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl get deploy</span></span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deploy-nginx   1/1     1            1           28s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除deployment</span></span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl delete deployment deploy-nginx</span></span><br><span class="line">deployment.apps <span class="string">&quot;deploy-nginx&quot;</span> deleted</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建deployment在test命名空间下</span></span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl create deployment deploy-nginx -n test --image=nginx:latest </span></span><br><span class="line">deployment.apps/deploy-nginx created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看test命名空间下deployment</span></span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl get deploy -n test</span></span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deploy-nginx   1/1     1            1           82s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除test命名空间下deployment</span></span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl delete deployment deploy-nginx -n test</span></span><br><span class="line">deployment.apps <span class="string">&quot;deploy-nginx&quot;</span> deleted</span><br></pre></td></tr></table></figure>



<h2 id="创建-Deployment"><a href="#创建-Deployment" class="headerlink" title="创建 Deployment"></a>创建 Deployment</h2><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/">https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]<span class="comment"># vim deployment-nginx.yml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  namespace: <span class="built_in">test</span></span><br><span class="line">  name: nginx-deployment</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:latest</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line"></span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl apply -f deployment-nginx.yml </span></span><br><span class="line">deployment.apps/nginx-deployment create</span><br></pre></td></tr></table></figure>



<p>Service操作</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定expose暴露的deploymen，--port指定外部端口，--target-port指定内部端口</span></span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl expose deployment nginx-deployment --port=8888 --target-port=80 -n test</span></span><br><span class="line">service/nginx-deployment exposed</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看test命名空间下的对外暴露的service</span></span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl get service -n test</span></span><br><span class="line">NAME               TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">nginx-deployment   ClusterIP   10.96.69.106   &lt;none&gt;        8888/TCP   26s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过web进入到nginx-deployment的容器修改nginx文件</span></span><br><span class="line"><span class="built_in">cd</span> /usr/share/nginx/html/</span><br><span class="line"><span class="built_in">echo</span> 1111 &gt; index.html</span><br><span class="line"><span class="built_in">cd</span> /usr/share/nginx/html/</span><br><span class="line"><span class="built_in">echo</span> 2222 &gt; index.html</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试页面,service提供负载均衡</span></span><br><span class="line">[root@k8smaster ~]<span class="comment"># curl 10.96.69.106:8888</span></span><br><span class="line">1111</span><br><span class="line">[root@k8smaster ~]<span class="comment"># curl 10.96.69.106:8888</span></span><br><span class="line">2222</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除service</span></span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl delete service nginx-deployment -n test</span></span><br><span class="line">service <span class="string">&quot;nginx-deployment&quot;</span> deleted</span><br></pre></td></tr></table></figure>



<p>创建外部访问端口–type&#x3D;NodePort</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]<span class="comment"># kubectl expose deployment nginx-deployment --port=8888 --target-port=80 -n test --type=NodePort</span></span><br><span class="line">service/nginx-deployment exposed</span><br><span class="line"></span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl get service -n test</span></span><br><span class="line">NAME               TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">nginx-deployment   NodePort   10.96.51.105   &lt;none&gt;        8888:30822/TCP   23s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 浏览器访问k8smaster的ip地址10.0.0.113:30822</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过Kuboard删除service和deployment</span></span><br></pre></td></tr></table></figure>



<p>修改deployment-nginx.yml文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]<span class="comment"># vim deployment-nginx.yml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  namespace: <span class="built_in">test</span></span><br><span class="line">  name: nginx-deployment</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-deployment</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:latest</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  namespace: <span class="built_in">test</span></span><br><span class="line">  name: nginx-deployment</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-deployment</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8888</span><br><span class="line">    targetPort: 80</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line"></span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl apply -f deployment-nginx.yml </span></span><br><span class="line">deployment.apps/nginx-deployment unchanged</span><br><span class="line">service/nginx-deployment created</span><br><span class="line"></span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl delete -f deployment-nginx.yml </span></span><br><span class="line">deployment.apps <span class="string">&quot;nginx-deployment&quot;</span> deleted</span><br><span class="line">service <span class="string">&quot;nginx-deployment&quot;</span> deleted</span><br></pre></td></tr></table></figure>



<p>通过Kuboard安装IngressClass</p>
<p><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202210212326034.png" alt="image-20221021232653711"></p>
<p>修改deployment-nginx.yml </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]<span class="comment"># vim deployment-nginx.yml </span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  namespace: <span class="built_in">test</span></span><br><span class="line">  name: nginx-deployment</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-deployment</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:latest</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  namespace: <span class="built_in">test</span></span><br><span class="line">  name: nginx-deployment</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-deployment</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8888</span><br><span class="line">    targetPort: 80</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  namespace: <span class="built_in">test</span></span><br><span class="line">  name: nginx-ingress</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: ingress</span><br><span class="line">  rules:</span><br><span class="line">  - host: mashibing.nginx.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: nginx-deployment</span><br><span class="line">            port:</span><br><span class="line">              number: 8888</span><br><span class="line"></span><br><span class="line">[root@k8smaster ~]<span class="comment"># kubectl apply -f deployment-nginx.yml </span></span><br><span class="line">deployment.apps/nginx-deployment created</span><br><span class="line">service/nginx-deployment created</span><br><span class="line">ingress.networking.k8s.io/nginx-ingress created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改C:\WINDOWS\System32\drivers\etc\hosts文件,添加10.0.0.113 mashibing.nginx.com</span></span><br><span class="line"><span class="comment"># 浏览器访问http://mashibing.nginx.com:30370/</span></span><br><span class="line"><span class="comment"># 浏览器访问http://10.0.0.113:30370/</span></span><br></pre></td></tr></table></figure>



<p>编写pijpeline.yml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]# vim pipeline.yml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  namespace: test</span><br><span class="line">  name: pipeline</span><br><span class="line">  labels:</span><br><span class="line">    app: pipeline</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: pipeline</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: pipeline</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: pipeline</span><br><span class="line">        image: 10.0.0.112:80/repo/pipeline:v4.0.0</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  namespace: test</span><br><span class="line">  labels:</span><br><span class="line">    app: pipeline</span><br><span class="line">  name: pipeline</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: pipeline</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8081</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  type: NodePort</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  namespace: test</span><br><span class="line">  name: pipeline</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: ingress</span><br><span class="line">  rules:</span><br><span class="line">  - host: mashibing.pipeline.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: pipeline</span><br><span class="line">            port:</span><br><span class="line">              number: 8081</span><br></pre></td></tr></table></figure>



<p>k8smaster配置daemon.json</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]<span class="comment"># vim /etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://registry.cn-hangzhou.aliyuncs.com&quot;</span>],</span><br><span class="line">  <span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;10.0.0.112:80&quot;</span>],  <span class="comment">#添加</span></span><br><span class="line">  <span class="string">&quot;exec-opts&quot;</span>: [<span class="string">&quot;native.cgroupdriver=systemd&quot;</span>],</span><br><span class="line">  <span class="string">&quot;log-driver&quot;</span>: <span class="string">&quot;json-file&quot;</span>,</span><br><span class="line">  <span class="string">&quot;log-opts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;max-size&quot;</span>: <span class="string">&quot;100m&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;storage-driver&quot;</span>: <span class="string">&quot;overlay2&quot;</span>,</span><br><span class="line">  <span class="string">&quot;storage-opts&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;overlay2.override_kernel_check=true&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">[root@k8smaster ~]<span class="comment"># systemctl restart docker</span></span><br></pre></td></tr></table></figure>



<p>k8sworker配置daemon.json</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@k8sworker ~]<span class="comment"># vim /etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://registry.cn-hangzhou.aliyuncs.com&quot;</span>],</span><br><span class="line">  <span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;10.0.0.112:80&quot;</span>],</span><br><span class="line">  <span class="string">&quot;exec-opts&quot;</span>: [<span class="string">&quot;native.cgroupdriver=systemd&quot;</span>],</span><br><span class="line">  <span class="string">&quot;log-driver&quot;</span>: <span class="string">&quot;json-file&quot;</span>,</span><br><span class="line">  <span class="string">&quot;log-opts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;max-size&quot;</span>: <span class="string">&quot;100m&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;storage-driver&quot;</span>: <span class="string">&quot;overlay2&quot;</span>,</span><br><span class="line">  <span class="string">&quot;storage-opts&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;overlay2.override_kernel_check=true&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">[root@k8sworker ~]<span class="comment"># systemctl restart docker</span></span><br></pre></td></tr></table></figure>

<p><img src="C:/Users/y/AppData/Roaming/Typora/typora-user-images/image-20221022104711601.png" alt="image-20221022104711601"></p>
<p>测试</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]<span class="comment"># docker login 10.0.0.112:80/ -u admin -p Harbor12345</span></span><br><span class="line">WARNING! Using --password via the CLI is insecure. Use --password-stdin.</span><br><span class="line">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/<span class="comment">#credentials-store</span></span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></figure>



<p><img src="/images/%E4%BD%BF%E7%94%A8kubeadm%E5%AE%89%E8%A3%85kubernetes_v1.19.x.assest/image-20221022123400995.png" alt="image-20221022123400995"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]# mkdir /usr/local/k8s</span><br></pre></td></tr></table></figure>





<p>流水线语法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sshPublisher(publishers: [sshPublisherDesc(configName: &#x27;k8s&#x27;, transfers: [sshTransfer(cleanRemote: false, excludes: &#x27;&#x27;, execCommand: &#x27;&#x27;, execTimeout: 120000, flatten: false, makeEmptyDirs: false, noDefaultExcludes: false, patternSeparator: &#x27;[, ]+&#x27;, remoteDirectory: &#x27;&#x27;, remoteDirectorySDF: false, removePrefix: &#x27;&#x27;, sourceFiles: &#x27;pipeline.yml&#x27;)], usePromotionTimestamp: false, useWorkspaceInPromotion: false, verbose: false)])</span><br></pre></td></tr></table></figure>



<p>报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+ mv ./target/mytest.jar ./docker/</span><br><span class="line">+ docker build -t pipeline:v5.0.0 ./docker/</span><br><span class="line">Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Post &quot;http://%2Fvar%2Frun%2Fdocker.sock/v1.24/build?buildargs=%7B%7D&amp;cachefrom=%5B%5D&amp;cgroupparent=&amp;cpuperiod=0&amp;cpuquota=0&amp;cpusetcpus=&amp;cpusetmems=&amp;cpushares=0&amp;dockerfile=Dockerfile&amp;labels=%7B%7D&amp;memory=0&amp;memswap=0&amp;networkmode=default&amp;rm=1&amp;shmsize=0&amp;t=pipeline%3Av5.0.0&amp;target=&amp;ulimits=null&amp;version=1&quot;: dial unix /var/run/docker.sock: connect: permission denied</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@jenkins run]# cd /var/run/</span><br><span class="line">[root@jenkins run]# chown root:root docker.sock</span><br><span class="line">[root@jenkins run]# chmod o+rw docker.sock</span><br><span class="line">srw-rw-rw-  1 root   root      0 10月 19 17:46 docker.sock</span><br></pre></td></tr></table></figure>





<p>生成ssh密钥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@jenkins sonarqube_docker]# docker exec -it jenkins bash</span><br><span class="line">jenkins@32ed8decc415:~$ ssh-keygen</span><br><span class="line">jenkins@32ed8decc415:~/.ssh$ ls</span><br><span class="line">id_rsa	id_rsa.pub</span><br><span class="line">jenkins@32ed8decc415:~/.ssh$ cat id_rsa.pub </span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC7rqjJ6t9VmAwVATDNLxEjlTsrZRNDJxfHo20GmJ6702x06XdMeolDeDM7vXsX8QrdY6NMSRiO0IBho5ocjf+nTDKdEIadcsMp+CowXtiTxv/hVnL7KWg1alPzduVYyqLIy3KQ1W3HpBj0NILVERJYIaAlF31X7GG3db2GFqGkavZ3a02fZ4rOEDyme0hFjLkPbcvIwiibofh3Cstj7u8H/RTnEEq7C9BQn08OgRftC580IG/N7OlOnjzt4IdwMjgv7au3271qEnBPAEYaWgz513hPHKxKyZUATUb9fKmHadC50futTnEPV9PwKiLKVX3qUqCbMBWjGJM4Pz1BSOP6Hmvw90DCejIDwQm3+O1C6YtQn773g7iy7X6qGrnppRHABBmMIONdyl0tQFjy8RywJa7TWH1gBeEbTD45RWMt242sSsG7PpNOQcqgoV126cWUR4hVybHHCfhG08tELTh9aNduejFa+s3xyY2RT0Lrn6fUQOljTOLI/luokVmUAUs= jenkins@32ed8decc415</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8smaster ~]# mkdir .ssh</span><br><span class="line">[root@k8smaster ~]# cd .ssh/</span><br><span class="line">[root@k8smaster .ssh]# touch authorized_keys</span><br><span class="line">[root@k8smaster .ssh]# vim authorized_keys</span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC7rqjJ6t9VmAwVATDNLxEjlTsrZRNDJxfHo20GmJ6702x06XdMeolDeDM7vXsX8QrdY6NMSRiO0IBho5ocjf+nTDKdEIadcsMp+CowXtiTxv/hVnL7KWg1alPzduVYyqLIy3KQ1W3HpBj0NILVERJYIaAlF31X7GG3db2GFqGkavZ3a02fZ4rOEDyme0hFjLkPbcvIwiibofh3Cstj7u8H/RTnEEq7C9BQn08OgRftC580IG/N7OlOnjzt4IdwMjgv7au3271qEnBPAEYaWgz513hPHKxKyZUATUb9fKmHadC50futTnEPV9PwKiLKVX3qUqCbMBWjGJM4Pz1BSOP6Hmvw90DCejIDwQm3+O1C6YtQn773g7iy7X6qGrnppRHABBmMIONdyl0tQFjy8RywJa7TWH1gBeEbTD45RWMt242sSsG7PpNOQcqgoV126cWUR4hVybHHCfhG08tELTh9aNduejFa+s3xyY2RT0Lrn6fUQOljTOLI/luokVmUAUs= jenkins@32ed8decc415</span><br><span class="line"></span><br></pre></td></tr></table></figure>









<p>gitlab报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hook executed successfully but returned HTTP 403 &lt;html&gt; &lt;head&gt; &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html;charset=utf-8&quot;/&gt; &lt;title&gt;Error 403 anonymous is missing the Job/Build permission&lt;/title&gt; &lt;/head&gt; &lt;body&gt;&lt;h2&gt;HTTP ERROR 403 anonymous is missing the Job/Build permission&lt;/h2&gt; &lt;table&gt; &lt;tr&gt;&lt;th&gt;URI:&lt;/th&gt;&lt;td&gt;/project/pipeline&lt;/td&gt;&lt;/tr&gt; &lt;tr&gt;&lt;th&gt;STATUS:&lt;/th&gt;&lt;td&gt;403&lt;/td&gt;&lt;/tr&gt; &lt;tr&gt;&lt;th&gt;MESSAGE:&lt;/th&gt;&lt;td&gt;anonymous is missing the Job/Build permission&lt;/td&gt;&lt;/tr&gt; &lt;tr&gt;&lt;th&gt;SERVLET:&lt;/th&gt;&lt;td&gt;Stapler&lt;/td&gt;&lt;/tr&gt; &lt;/table&gt; &lt;hr&gt;&lt;a href=&quot;https://eclipse.org/jetty&quot;&gt;Powered by Jetty:// 9.4.43.v20210629&lt;/a&gt;&lt;hr/&gt; &lt;/body&gt; &lt;/html&gt;</span><br></pre></td></tr></table></figure>











<p><strong>Jenkinsfile</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">// 所有的脚本命令都放在pipeline中</span><br><span class="line">pipeline &#123;</span><br><span class="line">    // 指定任务再哪个集群节点中执行</span><br><span class="line">    agent any</span><br><span class="line"></span><br><span class="line">    // 声明全局变量，方便后面使用</span><br><span class="line">    environment &#123;</span><br><span class="line">        harborUser = &#x27;admin&#x27;</span><br><span class="line">        harborPasswd = &#x27;Harbor12345&#x27;</span><br><span class="line">        harborAddress = &#x27;10.0.0.112:80&#x27;</span><br><span class="line">        harborRepo = &#x27;repo&#x27;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;拉取git仓库代码&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                checkout([$class: &#x27;GitSCM&#x27;, branches: [[name: &#x27;*/master&#x27;]], extensions: [], userRemoteConfigs: [[credentialsId: &#x27;9e274219-f3b7-4ce4-a23b-c0ed3141e693&#x27;, url: &#x27;http://10.0.0.111:8929/gitlab-instance-b56ddcfc/mytest.git&#x27;]]])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;通过maven构建项目&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh &#x27;/var/jenkins_home/maven/bin/mvn clean package -DskipTests&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;通过SonarQube做代码质量检测&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh &#x27;/var/jenkins_home/sonar-scanner/bin/sonar-scanner -Dsonar.source=./ -Dsonar.projectname=$&#123;JOB_NAME&#125; -Dsonar.projectKey=$&#123;JOB_NAME&#125; -Dsonar.java.binaries=./target/ -Dsonar.login=76c8e00a7e2330dba53530cbf932b2e3e2eb2968&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;通过Docker制作自定义镜像&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh &#x27;&#x27;&#x27;mv ./target/*.jar ./docker/</span><br><span class="line">docker build -t $&#123;JOB_NAME&#125;:$&#123;tag&#125; ./docker/&#x27;&#x27;&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;将自定义镜像推送到Harbor&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh &#x27;&#x27;&#x27;docker login -u $&#123;harborUser&#125; -p $&#123;harborPasswd&#125; $&#123;harborAddress&#125;</span><br><span class="line">docker tag $&#123;JOB_NAME&#125;:$&#123;tag&#125; $&#123;harborAddress&#125;/$&#123;harborRepo&#125;/$&#123;JOB_NAME&#125;:$&#123;tag&#125;</span><br><span class="line">docker push $&#123;harborAddress&#125;/$&#123;harborRepo&#125;/$&#123;JOB_NAME&#125;:$&#123;tag&#125;&#x27;&#x27;&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;将yml文件传到k8s-master上&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sshPublisher(publishers: [sshPublisherDesc(configName: &#x27;k8s&#x27;, transfers: [sshTransfer(cleanRemote: false, excludes: &#x27;&#x27;, execCommand: &#x27;&#x27;, execTimeout: 120000, flatten: false, makeEmptyDirs: false, noDefaultExcludes: false, patternSeparator: &#x27;[, ]+&#x27;, remoteDirectory: &#x27;&#x27;, remoteDirectorySDF: false, removePrefix: &#x27;&#x27;, sourceFiles: &#x27;pipeline.yml&#x27;)], usePromotionTimestamp: false, useWorkspaceInPromotion: false, verbose: false)])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;远程执行k8s-master的kubectl命令&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh &#x27;ssh root@10.0.0.113 kubectl apply -f /usr/local/k8s/pipeline.yml&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    post &#123;</span><br><span class="line">        success &#123;</span><br><span class="line">            dingtalk(</span><br><span class="line">                robot: &#x27;Jenikins-DingDing&#x27;,</span><br><span class="line">                type: &#x27;MARKDOWN&#x27;,</span><br><span class="line">                title: &#x27;success: $&#123;JOB_NAME&#125;&#x27;,</span><br><span class="line">                text: [&quot;- 成功构建: $&#123;JOB_NAME&#125;! \n- 版本: $&#123;tag&#125; \n- 持续时间: $&#123;currentBuild.durationString&#125;&quot;]</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">        failure &#123;</span><br><span class="line">            dingtalk(</span><br><span class="line">                robot: &#x27;Jenikins-DingDing&#x27;,</span><br><span class="line">                type: &#x27;MARKDOWN&#x27;,</span><br><span class="line">                title: &#x27;success: $&#123;JOB_NAME&#125;&#x27;,</span><br><span class="line">                text: [&quot;- 构建失败: $&#123;JOB_NAME&#125;! \n- 版本: $&#123;tag&#125; \n- 持续时间: $&#123;currentBuild.durationString&#125;&quot;]</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>pipeline.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  namespace: test</span><br><span class="line">  name: pipeline</span><br><span class="line">  labels:</span><br><span class="line">    app: pipeline</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: pipeline</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: pipeline</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: pipeline</span><br><span class="line">        image: 10.0.0.112:80/repo/pipeline:v6.0.0</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  namespace: test</span><br><span class="line">  labels:</span><br><span class="line">    app: pipeline</span><br><span class="line">  name: pipeline</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: pipeline</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8081</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  type: NodePort</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  namespace: test</span><br><span class="line">  name: pipeline</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: ingress</span><br><span class="line">  rules:</span><br><span class="line">  - host: mashibing.pipeline.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: pipeline</span><br><span class="line">            port:</span><br><span class="line">              number: 8081</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://mo-li001.github.io">壹拾陆</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://mo-li001.github.io/posts/fa8aa448.html">https://mo-li001.github.io/posts/fa8aa448.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mo-li001.github.io" target="_blank">壹拾陆</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/fc24f34b.html"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">linux2</div></div></a></div><div class="next-post pull-right"><a href="/posts/47171.html"><img class="next-cover" src="https://tuchuangs.com/imgs/2022/09/18/074f3836d4f471b8.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">linux三剑客</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/9f353bc9.html" title="Devops"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Devops</div></div></a></div><div><a href="/posts/f5f9fa9b.html" title="Docker"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Docker</div></div></a></div><div><a href="/posts/34d20e28.html" title="ELK"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">ELK</div></div></a></div><div><a href="/posts/8005.html" title="ELK快速部署"><img class="cover" src="https://tuchuangs.com/imgs/2022/09/18/074f3836d4f471b8.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">ELK快速部署</div></div></a></div><div><a href="/posts/9bdc030a.html" title="HAproxy"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">HAproxy</div></div></a></div><div><a href="/posts/a71433d.html" title="Ansible"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Ansible</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202209182232723.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">壹拾陆</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">68</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mo-li001/"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">个人笔记</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#29-pipeline-%E6%9E%84%E5%BB%BA%E5%90%8E%E9%92%89%E9%92%89%E9%80%9A%E7%9F%A5%E6%B6%88%E6%81%AF"><span class="toc-text">29.pipeline-构建后钉钉通知消息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8kubeadm%E5%AE%89%E8%A3%85kubernetes-v1-19-x"><span class="toc-text">使用kubeadm安装kubernetes_v1.19.x</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5-centos-x2F-hostname"><span class="toc-text">检查 centos &#x2F; hostname</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85docker%E5%8F%8Akubelet"><span class="toc-text">安装docker及kubelet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-master-%E8%8A%82%E7%82%B9"><span class="toc-text">初始化 master 节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-worker%E8%8A%82%E7%82%B9"><span class="toc-text">初始化 worker节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%BE%97-join%E5%91%BD%E4%BB%A4%E5%8F%82%E6%95%B0"><span class="toc-text">获得 join命令参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96worker"><span class="toc-text">初始化worker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E5%88%9D%E5%A7%8B%E5%8C%96%E7%BB%93%E6%9E%9C"><span class="toc-text">检查初始化结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-Kuboard-v3-kubernetes"><span class="toc-text">安装 Kuboard v3 - kubernetes</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE-Kuboard"><span class="toc-text">访问 Kuboard</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Deployment"><span class="toc-text">创建 Deployment</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/90f47a19.html" title="自动化装机">自动化装机</a><time datetime="2023-02-02T12:41:14.000Z" title="发表于 2023-02-02 20:41:14">2023-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/64202.html" title="linux">linux</a><time datetime="2023-02-02T12:41:14.000Z" title="发表于 2023-02-02 20:41:14">2023-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/8fb4d8df.html" title="zabbix">zabbix</a><time datetime="2023-02-02T01:43:57.000Z" title="发表于 2023-02-02 09:43:57">2023-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/8d6735b8.html" title="超经典SQL练习题，做完这些你的ＳＱＬ就过关了">超经典SQL练习题，做完这些你的ＳＱＬ就过关了</a><time datetime="2023-02-02T01:43:57.000Z" title="发表于 2023-02-02 09:43:57">2023-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/39d18a59.html" title="Mermaid绘图">Mermaid绘图</a><time datetime="2023-01-11T12:41:14.000Z" title="发表于 2023-01-11 20:41:14">2023-01-11</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 壹拾陆</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>