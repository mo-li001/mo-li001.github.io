<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>linux | 壹拾陆</title><meta name="keywords" content="Linux"><meta name="author" content="壹拾陆"><meta name="copyright" content="壹拾陆"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="yum -y install bash-completion  命令补全 yum install lrzsz		安装rz命令 rz：					从本地上传文件至服务器 sz filename：			从服务器下载文件至本地 yum clean all  			清理yum缓存 yum makecache  		将服务器软件包信息缓存至本地，提高搜索安装效率 yum update  			更新yum ec">
<meta property="og:type" content="article">
<meta property="og:title" content="linux">
<meta property="og:url" content="https://mo-li001.github.io/posts/64202.html">
<meta property="og:site_name" content="壹拾陆">
<meta property="og:description" content="yum -y install bash-completion  命令补全 yum install lrzsz		安装rz命令 rz：					从本地上传文件至服务器 sz filename：			从服务器下载文件至本地 yum clean all  			清理yum缓存 yum makecache  		将服务器软件包信息缓存至本地，提高搜索安装效率 yum update  			更新yum ec">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tuchuangs.com/imgs/2022/09/18/074f3836d4f471b8.jpg">
<meta property="article:published_time" content="2023-02-02T12:41:14.000Z">
<meta property="article:modified_time" content="2023-02-07T06:34:23.000Z">
<meta property="article:author" content="壹拾陆">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tuchuangs.com/imgs/2022/09/18/074f3836d4f471b8.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://mo-li001.github.io/posts/64202"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'linux',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-02-07 14:34:23'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202209182232723.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">68</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://tuchuangs.com/imgs/2022/09/18/074f3836d4f471b8.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">壹拾陆</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">linux</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-02-02T12:41:14.000Z" title="发表于 2023-02-02 20:41:14">2023-02-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-02-07T06:34:23.000Z" title="更新于 2023-02-07 14:34:23">2023-02-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="linux"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>yum -y install bash-completion  命令补全</p>
<p>yum install lrzsz		安装rz命令</p>
<p>rz：					从本地上传文件至服务器</p>
<p>sz filename：			从服务器下载文件至本地</p>
<p>yum clean all  			清理yum缓存</p>
<p>yum makecache  		将服务器软件包信息缓存至本地，提高搜索安装效率</p>
<p>yum update  			更新yum</p>
<p>echo $RANDOM  生成随机数</p>
<p>echo $RANDOM|md5sum |cut -c 5-12  生成随机数</p>
<p>备份默认yum源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</span><br></pre></td></tr></table></figure>

<p>更换yum源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br></pre></td></tr></table></figure>

<p>添加EPEL</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br></pre></td></tr></table></figure>



<p>停掉NetworkManager</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop NetworkManager &amp;&amp; systemctl disable NetworkManager</span><br></pre></td></tr></table></figure>

<p>service NetworkManager stop<br>chkconfig NetworkManager off</p>
<p>修改dns</p>
<p>&#x2F;etc&#x2F;resolv.conf</p>
<p>1.关闭防火墙：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure>

<p>2.关闭selinux:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#x27;s/enforcing/disabled/&#x27; /etc/selinux/config</span><br><span class="line">setenforce 0</span><br></pre></td></tr></table></figure>

<p>3.关闭swap:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a 临时</span><br><span class="line">vim /etc/fstab 永久</span><br></pre></td></tr></table></figure>



<p>查找netstat命令所属的依赖包依赖包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum provides netstat</span><br></pre></td></tr></table></figure>

<p>netstat命令的安装包为net-tools</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install net-tools</span><br></pre></td></tr></table></figure>



<p>查看端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -lntup</span><br></pre></td></tr></table></figure>



<h2 id="英文单词表"><a href="#英文单词表" class="headerlink" title="英文单词表"></a><strong>英文单词表</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">55.Active      	激活的 活动的</span><br><span class="line">56.inactive    	未激活状态 关闭状态</span><br><span class="line">57.dead        	死亡</span><br><span class="line">58.interactive 	交互方式 uninteractive  非交互</span><br><span class="line">59.random       随机</span><br><span class="line">60.compressed   压缩</span><br><span class="line">61.cp:target &#x27;/oldboy/oldboy10.txt&#x27;is not a directory</span><br><span class="line">       指定         目录文件              不是一个目录</span><br><span class="line">62.wildcard    	通配符号</span><br><span class="line">63.row         	表示行</span><br><span class="line">64.Operation not permitted  操作不被允许</span><br><span class="line">65.deny  		阻止 拒绝</span><br><span class="line">66.reject  		拒绝</span><br><span class="line">67.debug  		进入调试模式</span><br></pre></td></tr></table></figure>

<h2 id="命令汇总表"><a href="#命令汇总表" class="headerlink" title="命令汇总表"></a><strong>命令汇总表</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">yum reinstall -y xxx</span><br><span class="line">23.rpm  安装软件（不能解决软件依赖关系）</span><br><span class="line">rpm-ivh</span><br><span class="line">rpm-ga</span><br><span class="line">rpm-ql</span><br><span class="line">rpm-e</span><br><span class="line">rpm-qf  找寻文件属于哪个软件包 </span><br><span class="line">23.Failed  失败了</span><br><span class="line">24.grep三剑客命令过滤文本信息</span><br><span class="line">  -A 显示搜索信息的后几行</span><br><span class="line">  -B 显示搜索信息的前几行</span><br><span class="line">  -c 显示搜索信息的前后几行</span><br><span class="line">  -n 显示搜索信息的行号内容</span><br><span class="line">  -v 对搜索信息进行排除显示排除后的其余信息</span><br><span class="line">  -E 识别扩展正则信息egrep</span><br><span class="line">  -o 显示过滤的过程只显示过滤的信息</span><br><span class="line">  -i 过滤信息时忽略大小写</span><br><span class="line">  -w 按照单词信息进行过滤</span><br><span class="line">    grep -w &quot;old&quot;oldboy.txt</span><br><span class="line">    old boy</span><br><span class="line">  -c 统计过滤出来的多少行信息</span><br><span class="line">  sed  三剑客命令取出行的信息修改替换文件内容</span><br><span class="line">  -n  取消默认输出</span><br><span class="line">  //p  打印输出内容</span><br><span class="line">  s///g  搜索信息，并进行全局替换</span><br><span class="line">  -i  真正编辑修改文件内容</span><br><span class="line">35.which  查看命令绝对路径信息</span><br><span class="line">   which  命令信息</span><br><span class="line">36.tree  显示目录结构以树状形式显示</span><br><span class="line">   tree -L 1  显示目录指定层级信息</span><br><span class="line">   tree -d  只显示目录下面指定目录信息</span><br><span class="line">37.file  显示普通文件的类型信息</span><br><span class="line">38.find        搜索数据信息</span><br><span class="line">   -type       指定文件类型</span><br><span class="line">   -name       指定文件名称</span><br><span class="line">   -iname      指定文件名称（忽略大小写）</span><br><span class="line">   -size       指定文件大小</span><br><span class="line">   -maxdepth   指定搜索文件目录深度</span><br><span class="line">   -a          多个查询条件采用并且关系（默认）</span><br><span class="line">   -o          多个查询条件采用或者关系</span><br><span class="line">39.tar  压缩和解压数据信息</span><br><span class="line">z       指定gzp压缩</span><br><span class="line">c       创建压缩包</span><br><span class="line">v       显示压缩过程</span><br><span class="line">f       参数后而跟上压缩文件</span><br><span class="line">t       列表显示压缩包中的数据信息</span><br><span class="line">x       解压数据包</span><br><span class="line"></span><br><span class="line">快捷方式总结</span><br><span class="line">ctrl + c cancel  中断或停止命令的执行过程</span><br><span class="line">esc + .          调用上一个命令最后一个参数信息</span><br></pre></td></tr></table></figure>

<h2 id="day09-操作系统目录结构笔记"><a href="#day09-操作系统目录结构笔记" class="headerlink" title="day09-操作系统目录结构笔记"></a><strong>day09-操作系统目录结构笔记</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">KDUMP功能（默认是开启） </span><br><span class="line">需要进行关闭功能 </span><br><span class="line">说明：当系统出现崩溃时，即时将内存中的数据转移到硬盘 </span><br><span class="line">安全配置 不等价于 防火墙 </span><br><span class="line">建议：尽量将安全服务关闭（安全服务不了解时） </span><br><span class="line"></span><br><span class="line">系统分区说明 </span><br><span class="line">standard parition	标准分区 </span><br><span class="line">LVM	特殊分区	进行分区动态扩容/缩容 </span><br><span class="line">/boot	启动分区	保存和系统启动相关的文件 </span><br><span class="line">swap	交换分区	临时将硬盘的多余容量变为内存使用  内存&lt;8G  swap分区大小==1.5倍内存容量  1G swap=1.5G </span><br><span class="line">/		根分区	将剩余容量都给根==C盘 数据比较重要的场景 </span><br><span class="line">/boot	200M swap	1G 2G 1.5倍 </span><br><span class="line">/data	剩余空间 </span><br><span class="line"></span><br><span class="line">作业： 01.如何利用救援模式破解系统密码 </span><br><span class="line"></span><br><span class="line">00.课程回顾  </span><br><span class="line">1)虚拟软件功能说明    </span><br><span class="line">    网络功能设置进行说明    </span><br><span class="line">    a 虚拟网卡的模式（桥接模式 nat模式 仅主机模式）   </span><br><span class="line">    结论：安全性 vs 操作管理方便性 总是相对    </span><br><span class="line">    一些特殊功能说明    </span><br><span class="line">    a 虚拟主机的挂起功能    </span><br><span class="line">    b 虚拟主机的快照功能（相当于月光宝盒作用）      </span><br><span class="line">    rm -rf /  </span><br><span class="line">2)系统安装详述    </span><br><span class="line">    a 救援模式如何使用    </span><br><span class="line">    b 别忘了修改网卡名称ens33 net.ifnames=0 biosdevname=0    </span><br><span class="line">    c 如何进行磁盘分区    </span><br><span class="line">    通用分区方案    </span><br><span class="line">    数据比较重要分区方案    </span><br><span class="line">    灵活的分区方案    </span><br><span class="line">    swap 交换分区 将硬盘空间临时充当内存使用  </span><br><span class="line">3)远程连接软件说明(xshell)    </span><br><span class="line">    a.初始化配置过程    </span><br><span class="line">    b.连接配置过程 </span><br><span class="line"></span><br><span class="line">/dev/第一个分区：/boot </span><br><span class="line">/dev/第三个分区：/ </span><br><span class="line"></span><br><span class="line">[root@oldboysh03 ~]cat /etc/fstab </span><br><span class="line">UUID=afdf5e79-b550-4671-b73d-54d1fa5bc77e</span><br><span class="line">/		xfs		defaults		0  0 </span><br><span class="line"></span><br><span class="line">UUID=93202ef4-1864-4437-95a3-001402f74ae9</span><br><span class="line">/boot		xfs		defaults		0  0 </span><br><span class="line"></span><br><span class="line">/dev/cdrom</span><br><span class="line">/mnt		xfs		defaults		0  0 </span><br><span class="line"></span><br><span class="line">UUID=ec09add0-6828-43b6-8649-2b836c59dfcb</span><br><span class="line">swap		swap		defaults		0  0 </span><br><span class="line"></span><br><span class="line">[root@oldboysh03 ~]blkid </span><br><span class="line">/dev/sda1: UUID=&quot;93202ef4-1864-4437-95a3-001402f74ae9&quot; TYPE=&quot;xfs&quot; </span><br><span class="line">/dev/sda2: UUID=&quot;ec09add0-6828-43b6-8649-2b836c59dfcb&quot; TYPE=&quot;swap&quot; </span><br><span class="line">/dev/sda3: UUID=&quot;afdf5e79-b550-4671-b73d-54dlfa5bc77e&quot; TYPE=&quot;xfs&quot;  </span><br><span class="line">/dev/sr0: UUID=&quot;2018-05-03-20-55-23-00&quot; LABEL=&quot;CentOS 7 x86_64&quot; TYPE=&quot;iso9660&quot; PTTYPE=&quot;dos&quot; </span><br><span class="line">总结：实现磁盘存储设备，挂我操作水久生效，开机自动加载挂载信息 </span><br><span class="line"></span><br><span class="line">b /etc/rc.local </span><br><span class="line">cp /etc/sysconfig/network-scripts/ifcfg-eth0 /tmp/ifcfg-eth0.bak 开机自动备份 </span><br><span class="line">系统正常加载启动 --- 读取 rc.local 文件 --- 文件主要保存命令信息 --- 执行文件中的命令 --- 系统启动成功 </span><br><span class="line">cp /etc/sysconfig/network-scripts,/ifcfg-eth0 /tmp/ifcfg-eth0.bak 放置到 /etc/rc.local 文件中 </span><br><span class="line">echo &quot;cp /etc/sysconfig/network-scripts/ifcfg-eth0 /tmp/ifcfg-eth0.bak&quot; &gt;&gt; /etc/rc.local </span><br><span class="line">centos6：按照以上说明进行操作即可 </span><br><span class="line">centos7：chmod +x /etc/rc.d/rc.local </span><br><span class="line"></span><br><span class="line">A系统启动：网路服务运丁安全服务运行仔储服务运行	01 </span><br><span class="line">B系统启动：安全服务运行存储服务运行				02 </span><br><span class="line">C系统启动：存储服务运行						03 </span><br><span class="line">三种系统：运行启动级别不一样</span><br><span class="line"></span><br><span class="line">centos6 </span><br><span class="line">0	关机级别(init 0) </span><br><span class="line">1	单用户模式（重置用户密码信息root修复系统）  救援模式 </span><br><span class="line">2	多用户模式NFS网络存储服务（没有网络服务） </span><br><span class="line">3	多用户模式（命令行模式） </span><br><span class="line">4	未知  未使用 </span><br><span class="line">5	图形化界面模式(init5) </span><br><span class="line">6	重启级别 </span><br><span class="line"></span><br><span class="line">作业： 01.在centos7如何利用单用户模式修改密码</span><br></pre></td></tr></table></figure>

<h2 id="day13-操作系统知识"><a href="#day13-操作系统知识" class="headerlink" title="day13-操作系统知识"></a><strong>day13-操作系统知识</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/etc/profile	环境变量	别名功能 </span><br><span class="line">系统别名功能设置技能 </span><br><span class="line">别名就是一些复杂命令小名	昵称 </span><br><span class="line"></span><br><span class="line">ls -l → ll  别名 </span><br><span class="line">1)如何查看别名设置 </span><br><span class="line">alias  别名 </span><br><span class="line">alias cp=&#x27;cp -i&#x27; </span><br><span class="line">alias mv=&#x27;mv -i&#x27; </span><br><span class="line">alias rm=&#x27;rm -i&#x27; </span><br><span class="line">-i  如要人为交互，有提示信息 </span><br><span class="line">问题：如何非交互的覆盖原有信息 </span><br><span class="line">1. \cp /tmp/oldboy.txt /oldboy/		--取消别名功能 </span><br><span class="line">2.采用命令绝对路径方式 </span><br><span class="line"><span class="meta prompt_">[root@02~]#</span><span class="language-bash"><span class="comment"># 查看一个命令到底在哪个绝对路径中</span></span> </span><br><span class="line">[root@02 ~]# which cp </span><br><span class="line">alias cp=&#x27;cp -i&#x27;</span><br><span class="line">	/usr/bin/cp </span><br><span class="line">[root@02 ~]# ll /usr/bin/cp </span><br><span class="line">-rwxr-xr-x.1 root root 155176 Apr 11 2018 /usr/bin/cp </span><br><span class="line">[root@02 ~]# /usr/bin/cp /tmp/oldboy.txt /oldboy</span><br></pre></td></tr></table></figure>

<h2 id="day14-操作系统知识文件属性"><a href="#day14-操作系统知识文件属性" class="headerlink" title="day14-操作系统知识文件属性"></a><strong>day14-操作系统知识文件属性</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">00.课程回项  </span><br><span class="line">1)课程知识体系总结回顿  </span><br><span class="line">2)课程知识体系扩展说明  </span><br><span class="line">3)文件属性介绍 </span><br><span class="line">01.文件属性介绍说明  </span><br><span class="line">[root@oldboysh03 ~]# ls -Lhi /etc/  </span><br><span class="line">total 1.1M </span><br><span class="line">67683849 drwxr-xr-x.   3   root  root  101    Nov   30 12:13   abrt </span><br><span class="line">67595302 -w-r--r--.    1   root  root   16    Nov   30 12:19   adjtime </span><br><span class="line">67145543 -w-r-r--.    1   root  root   1.5K  Jun    7  2013   aliases </span><br><span class="line">67108933 -w-r--r--.   1   root  root   12K   Nov   30 12:25   aliases.db </span><br><span class="line">67137919 dwxr-xr-x.   2   root  root   236   Nov   30 12:14   alternatives </span><br><span class="line">67652582 -W-&quot;&quot;&quot;&quot;=&quot;,   1   root  root   541   Apr    11 2018   anacrontab </span><br><span class="line">67437081 -w-r--r--.   1   root  root    55   Apr    11 2018   asound.conf </span><br><span class="line">67771118 dwxr-X---.   3   root  root    43   Nov   30 12:14   audisp </span><br><span class="line">201849886 drwxr-x---. 3   root root     83   Nov   30 12:25   audit </span><br><span class="line">01        02          03   04   05      06           07         08 </span><br><span class="line">01.文件索引节点信息 inode </span><br><span class="line">02.文件类型 文件权限信息 </span><br><span class="line">03.硬链接数 </span><br><span class="line">04.所属用户信息 </span><br><span class="line">05.所属用户组信息 </span><br><span class="line">06.文件大小 </span><br><span class="line">07.文件最后一次修改时间 </span><br><span class="line">08.文件名称（不属于属性信息） </span><br><span class="line"></span><br><span class="line">1)文件类型文件权限 </span><br><span class="line">文件类型： </span><br><span class="line">windows系统中：根据文件扩展名称信息，决定文件类型 </span><br><span class="line">linux系统中：系统的文件类型和文件扩展名没有半毛钱关系 </span><br><span class="line"></span><br><span class="line">linux系统文件类型分类 </span><br><span class="line">d  directory  目录类型的文件 </span><br><span class="line">-  file       普通类型的文件 </span><br><span class="line">l  softlink   连接类型的文件 </span><br><span class="line">c  character  字符类型的文件（会源源不断的产生字符信息）               </span><br><span class="line">				/dev/random/dev/zero(磁盘管理)/dev/nuLL(系统黑洞) </span><br><span class="line">企业案例：如何生成随机数信息 </span><br><span class="line">[tr -cd &#x27;0-9a-zA-Z&#x27;&lt;/dev/urandom|head -c 6 </span><br><span class="line">QYO7Rn[rootdoldboysh03 ~]# tr -cd &#x27;0-9a-zA-Z&#x27;&lt;/dev/urandom|head -c 6 </span><br><span class="line">meA3WM[root@oldboysh03 ~]# tr -cd &#x27;0-9a-zA-Z&#x27;&lt;/dev/urandom|head -c 6 </span><br><span class="line">LbgdrI[root@oldboysh03 ~]# tr -cd &#x27;0-9a-zA-Z&#x27;&lt;/dev/urandom|head -c 6 </span><br><span class="line">3FHcrM[rootdoldboysh03 ~]# tr -cd &#x27;0-9a-zA-Z&#x27;&lt;/dev/urandom|head -c 6 </span><br><span class="line">NwAaLB [root@oldboysh03 ~]# tr -cd &#x27;0-9a-zA-Z&#x27;&lt;/dev/urandom|head -c 6 </span><br><span class="line">b  block   块设备类型的文件  设备文件 </span><br><span class="line">s  socket  和网络接口通讯相关（开发 网络编程） </span><br><span class="line">p  pip     管道文件 </span><br><span class="line"></span><br><span class="line">在普通文件类型中对文件又做了细分 </span><br><span class="line">01.普通文本文件 </span><br><span class="line">02.特殊命令文件（二进制文件） </span><br><span class="line">03.特殊压缩文件（数据类型文件） </span><br><span class="line">[root@oldboysh03 /oldboy]# file oldboy.txt  --- 获取普通文件的类型信息 </span><br><span class="line">oldboy.txt:ASCII text </span><br><span class="line"></span><br><span class="line">Lnux系统中一切皆文件 </span><br><span class="line">和文件相关的命令 </span><br><span class="line">a 显示文件信息类型命令 file  </span><br><span class="line">	[root@oldboysh03 /oldboy]#file oldboy.txt  ---  获取普通文件的类型信息  </span><br><span class="line">	oldboy.txt:ASCII text </span><br><span class="line">b 显示命令绝对路径信息which  </span><br><span class="line">    [root@oldboysh03 /oldboy]#which file  </span><br><span class="line">    /usr/bin/file  </span><br><span class="line">    [root@oldboysh03 /oldboy]#which cp  </span><br><span class="line">    alias cp=&#x27;cp -i&#x27;   </span><br><span class="line">    /usr/bin/cp  </span><br><span class="line">    [root@oldboysh03 /oldboy]#alias which  </span><br><span class="line">    alias which=&#x27;alias </span><br><span class="line">    /usr/bin/which --tty-only --read-alias --show-dot --show-tilde&#x27;  </span><br><span class="line">    [rootdoldboysh03 /oldboy]#\\which cp   </span><br><span class="line">    /usr/bin/cp </span><br><span class="line">作业： </span><br><span class="line">01.如何生成随机数(shell脚木) </span><br><span class="line"></span><br><span class="line">压缩数据的命令 tar </span><br><span class="line">语法：tar 参数信息 压缩包信息（箱子） 物品01（数据信息） 物品02（数据信息） </span><br><span class="line"></span><br><span class="line">如何进行压缩数据：压缩/oldboy /etc/hosts/etc/selinux/config → /oldboy/oldboy.tar.gz </span><br><span class="line">tar zcvf /oldboy/oldboy.tar.gz /oldboy /etc/hosts /etc/selinux/config </span><br><span class="line">z 利用gzp方式进行压缩数据 rar zip </span><br><span class="line">c 创建压缩包 create </span><br><span class="line">v 详细执行操作过程 verbose </span><br><span class="line">f 指定需要压缩的文件信息file </span><br><span class="line">===================================================== </span><br><span class="line">tar:/oldboy:file changed as we read it </span><br><span class="line">目录中的数据可能在占用再看目录中的信息 </span><br><span class="line">01.请不再在相应目录下进行压缩   尽量在要压缩数据的上一级目录进行打包 </span><br><span class="line">02.采用相对路径进行打包压缩   tar zcvf /oldboy/system.tar.gz ./etc/ ./var/log </span><br><span class="line">===================================================== </span><br><span class="line"></span><br><span class="line">如何检查确认压缩数据： </span><br><span class="line">tar tf /oldboy/oldboy.tar.gz </span><br><span class="line">t 列表显示压缩包中的内容 </span><br><span class="line">解压数据文件 </span><br><span class="line">tar xf /oldboy/oldboy.tar.gz </span><br><span class="line">x extract 解压缩数据包 </span><br><span class="line"></span><br><span class="line">drwxr-xr-x. 5 root root 316 Dec 17 11:16 o1dboy01 </span><br><span class="line">-rw-r--r--. 1 root root   4 Dec 17 09:49 oldboy.mp4 </span><br><span class="line"></span><br><span class="line">rwxr-xr-x9位信息表示文件权限 </span><br><span class="line">文件权限有哪些 </span><br><span class="line">是否可以读取文件：cat file      ---&gt; r read    	数值4 </span><br><span class="line">是否可以写入文件：echo vim sed  ---&gt; w write   	数值2 </span><br><span class="line">是否可以执行文件：sh python     ---&gt; x execute 	数值1 </span><br><span class="line">文件没有相应权限：没有权限       ---&gt; - 空了    	数值0 </span><br><span class="line"></span><br><span class="line">rwx r-x --x -w- </span><br><span class="line">7    5   1   2 </span><br><span class="line">权限每三位为一组： </span><br><span class="line">第一位：只表示是否有读权限 </span><br><span class="line">第二位：只表示是否有写权限 </span><br><span class="line">第三位：贝表示是否有执行权限 **** </span><br><span class="line"></span><br><span class="line">rwxr-xr-x  9位信息表示文件权限 </span><br><span class="line"></span><br><span class="line">对一个文件说，可以有很多人管理 </span><br><span class="line">文件（你）  文件的所属用户信息-属主信息（父母教育你）  由9位权限位的前3位决定属主权限            </span><br><span class="line">			属主信息：一般创建文件的用户就是文件的属主信息             </span><br><span class="line">文件（你）  文件的所属用户组信息-属组信息（亲人）   由9位权限位的中间3位决定属组权限 文件（你）  文件的其他用户信息（福壁老王）         由9位权限位的后3位决定其他用户权限 </span><br><span class="line"></span><br><span class="line">rwxr-xr-x 请问属主有什么权限 属组有什么权限 其他用户有什么权限              </span><br><span class="line">			读写执行         读执行       读执行</span><br></pre></td></tr></table></figure>

<h2 id="day16-操作系统知识正则符合"><a href="#day16-操作系统知识正则符合" class="headerlink" title="day16-操作系统知识正则符合"></a><strong>day16-操作系统知识正则符合</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">oLdboy01 oldboy02 oldboy03 </span><br><span class="line">[root@oldboysh03-znb oldboy]# xargs -nl &lt;oldboy.txt </span><br><span class="line">oldboy01 </span><br><span class="line">oldboy02 </span><br><span class="line">oldboy03 </span><br><span class="line">[root@oldboysh03-znb oldboy]# xargs -n2 &lt;oldboy.txt </span><br><span class="line">oldboy01 oldboy02 </span><br><span class="line">oldboy03 </span><br><span class="line"></span><br><span class="line">批量删除文件 </span><br><span class="line">find /oldboy/ -type f -name &quot;*.txt&quot;|xargs rm </span><br><span class="line">find /oldboy/ -type f -name &quot;*.txt&quot; -exec rm -f &#123;&#125; \; </span><br><span class="line">find /oldboy/ -type f -name &quot;*.txt&quot; -delete </span><br><span class="line"></span><br><span class="line">批量备份文件 </span><br><span class="line">find /oldboy/ -type f -name &quot;*.txt&quot;|xargs -i cp -a &#123;&#125; /oldgirl </span><br><span class="line">find /oldboy/ -type f -name &quot;*.txt&quot;|xargs cp -a -t /oldgirl </span><br><span class="line">find /oldboy/ -type f -name &quot;*.txt&quot; -exec cp -a &#123;&#125; /oldgirl \; </span><br><span class="line"></span><br><span class="line">批量移动文件 </span><br><span class="line"></span><br><span class="line">井号符号：# </span><br><span class="line"></span><br><span class="line">02.花括号 &#123;&#125; 输出序列 </span><br><span class="line">输出数值连续序列：echo &#123;01..100&#125; </span><br><span class="line">输出字母连续序列：echo &#123;a..z&#125; </span><br><span class="line">输出不连续的序列：echo&#123;01.100.2&#125;echo&#123;01,03,08) </span><br><span class="line">输出组合序列：echo&#123;a,b&#125;&#123;a,b&#125; </span><br><span class="line">快速备份文件方式： </span><br><span class="line">[root@oldboysh03-znb oldboy]#echo A&#123;A,B&#125; </span><br><span class="line">AA AB </span><br><span class="line">[root@oldboysh03-znb oldboy]#echo A&#123;,B&#125; </span><br><span class="line">A AB </span><br><span class="line">[root@oldboysh03-znb oldboy]# echo oldboy.txt&#123;,.bak&#125; </span><br><span class="line">oldboy.txt oldboy.txt.bak </span><br><span class="line">[root@oldboysh03-znb oldboy]# cp oldboy.txt&#123;,.bak&#125; </span><br><span class="line">[rootdoldboysh03-znb oldboy]# ll oldboy.txt* </span><br><span class="line">-rw-r--r--. 1 root root 9 Dec 19 00:59 oldboy.txt </span><br><span class="line">-rw-r--r--. 1 root root 9 Dec 19 02:17 oldboy.txt.bak </span><br><span class="line"></span><br><span class="line">作业： </span><br><span class="line">01.时间同步服务chronyd如何使用？ </span><br><span class="line">02.find命令如何按分钟找寻数据 3分钟前生成数据</span><br></pre></td></tr></table></figure>

<h2 id="day17-操作系统知识正则符合"><a href="#day17-操作系统知识正则符合" class="headerlink" title="day17-操作系统知识正则符合"></a><strong>day17-操作系统知识正则符合</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">c 如果有文件被进程占用，删除文件，磁盘空间不会被释放  </span><br><span class="line">	1)服务进行重启  </span><br><span class="line">	2)清空文件数据信息&gt; </span><br><span class="line">2)正则符号  </span><br><span class="line">    系统特殊符号  </span><br><span class="line">    系统通配符号 </span><br><span class="line">01.正则符号  </span><br><span class="line">    概念说明：用于查找文件中的指定数据信息  </span><br><span class="line">    符号分类：  </span><br><span class="line">        基础正则表达式 BRE grep sed awk  </span><br><span class="line">        扩展正则表达式 ERE grep -E /egrep sed -r awk    </span><br><span class="line"></span><br><span class="line">正则符号使用注意事项： </span><br><span class="line">    ① 按照每行信息进行过滤处理 sed awk  </span><br><span class="line">    ② 注意正则表达符号禁止中文  </span><br><span class="line">    ③ 附上颜色信息进行正则过滤   </span><br><span class="line"></span><br><span class="line">终极目标： </span><br><span class="line">赵 110105199003065412 </span><br><span class="line">钱 120107198006077652 </span><br><span class="line">孙 310107198006077652 </span><br><span class="line">李 120109198006077652 </span><br><span class="line">周 120107198006077652 </span><br><span class="line">冯 oldboy </span><br><span class="line">吴 12010719800607765X </span><br><span class="line">楚 oldgirl </span><br><span class="line">郑 120107198006077652 </span><br><span class="line">王 120107198006077652 </span><br><span class="line"></span><br><span class="line">1)尖角符号：  </span><br><span class="line">说明：以什么什么信息开头的内容  </span><br><span class="line">以m字母开头的行  </span><br><span class="line">[root@oldboysh03-znb oldboy]#grep &quot;^m&quot; /oldboy/oldboy.txt  </span><br><span class="line">my blog is http://oldboy.blog.51cto.com  </span><br><span class="line">my qq num is 49000448.  </span><br><span class="line">my god ,i am not oldbey,but OLDBOY! </span><br><span class="line">2)关元符号：$  </span><br><span class="line">    说明：以什么什么信息结尾的内容  </span><br><span class="line">    以m字母结尾的行  </span><br><span class="line">    [root oldboysh03-znb oldboy]#grep &quot;m$&quot;/oldboy/oldboy.txt  </span><br><span class="line">    my blog is http://oldboy.blog.51cto.com  </span><br><span class="line">    ps:如何检查文件每行结尾是否有空格  </span><br><span class="line">    01.cat -A oldboy.txt  </span><br><span class="line">    02.vim底行模式输入：set list  </span><br><span class="line">    以m开始 以m结尾的行都找出米  </span><br><span class="line">    [root@oldboysh03-znb oldboy]#grep &quot;^m.*m$&quot; /oldboy/oldboy.txt  </span><br><span class="line">    my blog is http://oldboy.blog.51cto.com  </span><br><span class="line">    如何找出文件中空行信息  </span><br><span class="line">    grep &quot;s&quot;/oldboy/oldboy.txt </span><br><span class="line">3)点号符号：.  </span><br><span class="line">	说明：任意一个且只有一个</span><br></pre></td></tr></table></figure>

<h2 id="day22-操作系统定时任务篇-P260"><a href="#day22-操作系统定时任务篇-P260" class="headerlink" title="day22-操作系统定时任务篇 P260"></a><strong>day22-操作系统定时任务篇 P260</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line">01.定时任务服务介绍  </span><br><span class="line">	什么是定时任务：闹钟(5：30-6：00·6：15~6：20·6：25)                 </span><br><span class="line">					按照时间周期 进行自动操作  </span><br><span class="line">                    </span><br><span class="line">02.系统实现定时完成任务的方法  </span><br><span class="line">	01.定时任务软件：cronie(*)  #重点介绍cronie    </span><br><span class="line">    [rootdoldboysh03 /]# rpm -qa cronie    </span><br><span class="line">    cronie-1.4.11-19.el7.x8664    </span><br><span class="line">    [rootdoldboysh03 /]# rpm -qf crond    </span><br><span class="line">    error:file /crond:No such file or directory    </span><br><span class="line">    [root@oldboysh03 /]# rpm -qf `which crond`  #显示命令文件的绝对路径    </span><br><span class="line">    cronie-1.4.11-19.el7.x866      </span><br><span class="line"></span><br><span class="line">02.定时任务软件：atd    </span><br><span class="line">	定时任务只执行一次      </span><br><span class="line"></span><br><span class="line">03.定时任务软件：anacron    </span><br><span class="line">	只是适合非24小时运行的服务器     </span><br><span class="line"></span><br><span class="line">03.系统定时任务实现类型 </span><br><span class="line">	01.系统默认设置好的定时任务    </span><br><span class="line">		日志文件进行切割处理 logrotate </span><br><span class="line"></span><br><span class="line">        mv xx.log x×.log-20181203    </span><br><span class="line">        mv xx.log xx.log-20181204        </span><br><span class="line"></span><br><span class="line">4个重要定时任务目录    </span><br><span class="line">    控制定时任务目录：/etc/cron.hourly    </span><br><span class="line">    控制定时任务目录：/etc/cron.daily    </span><br><span class="line">    控制定时任务目录：/etc/cron.weekly    </span><br><span class="line">    控制定时任务目录：/etc/cron.monthly     </span><br><span class="line"></span><br><span class="line">    /etc/cron.deny  --- 阻止哪些用户不能使用系统自带定时任务服务    </span><br><span class="line">    /etc/contab     ---  定时任务参考文件     </span><br><span class="line"></span><br><span class="line">02.需要用户自己定义设置的定时任务    </span><br><span class="line">    定时任务配置：一个命令 一个文件    </span><br><span class="line">    一个命令：crontab  --  设置 或 查看定时任务信息的命令     </span><br><span class="line">    -u &lt;user&gt;  define user    -- 定义以什么用户省份进行定时任务设定     </span><br><span class="line">    -e         edit user&#x27;s crontab    -- 编写定时任务配置文件 crond table     </span><br><span class="line">    -l         list user&#x27;s crontab    -- 显示定时任务配置文件信息     </span><br><span class="line">    -r         delete user&#x27;s crontab    -- （一定不要使用） -r oldboy     </span><br><span class="line">    -i         prompt before deleting    --在执行命令之前提示 cp -i  mv -i  rm -i  同理     </span><br><span class="line">    -n &lt;host&gt;  set host in cluster to run users&#x27; crontabs     </span><br><span class="line">    -c         get host in cluster to run users&#x27; crontabs     </span><br><span class="line">    -s         selinux context     </span><br><span class="line">    -x &lt;mask&gt;  enable debugging          </span><br><span class="line"></span><br><span class="line">	-个文件：/var/spool/cron/root </span><br><span class="line"></span><br><span class="line">04.系统自带的cronie定时任务服务    </span><br><span class="line">    服务是否正常运行：    </span><br><span class="line">    systemctl status crond.service    </span><br><span class="line">    systemctl is-active crond.service        </span><br><span class="line"></span><br><span class="line">服务是否设置开机自启动：    </span><br><span class="line">    systemctl status crond.service    </span><br><span class="line">    systemctl is-enabled crond.service        </span><br><span class="line"></span><br><span class="line">检查服务进程    </span><br><span class="line">[root@VM-20-4-centos ~]# ps -ef|grep crond    </span><br><span class="line">root      1382     1  0  2021 ?        00:00:52 /usr/sbin/crond -n    </span><br><span class="line">root      9017  5552  0 16:40 pts/1    00:00:00 grep --color=auto crond    </span><br><span class="line">[root@VM-20-4-centos ~]# ps -ef|grep crond|grep -v grep    </span><br><span class="line">root      1382     1  0  2021 ?        00:00:52 /usr/sbin/crond -n    [root@VM-20-4-centos ~]# ps -ef|grep [c]rond    </span><br><span class="line">root      1382     1  0  2021 ?        00:00:52 /usr/sbin/crond -n         </span><br><span class="line"></span><br><span class="line">编写定时任务：crontab-e  有语法检查功能 == vim /var/spool/cron/root    </span><br><span class="line">定时任务配置文件如何编写    </span><br><span class="line">官方解释说明    </span><br><span class="line">[root@VM-20-4-centos ~]# cat /etc/crontab     </span><br><span class="line">SHELL=/bin/bash    </span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin    </span><br><span class="line">MAILTO=root     </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">For details see man 4 crontabs</span>     </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Example of job definition:</span>    </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">.---------------- minute (0 - 59)</span>    </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">|  .------------- hour (0 - 23)</span>    </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">|  |  .---------- day of month (1 - 31)</span>    </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">|  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...</span>    </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">|  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat    <span class="comment"># |  |  |  |  |    # *  *  *  *  * user-name  command to be executed</span></span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">测验： </span><br><span class="line">01.每天晚上12：30 需要上床睡觉 </span><br><span class="line">答：30 00 * * * </span><br><span class="line">02.每天晚上两点 需要起来上侧所 </span><br><span class="line">答：00 02 * * * </span><br><span class="line">03.每周三每月5号 需要进行数据备份    </span><br><span class="line">    黄历  05日  周三  亲热    </span><br><span class="line">    强调说明：在设置定时任务的时候，日期 和周 不能同时出现        </span><br><span class="line"></span><br><span class="line">[root@VM-20-4-centos ~]# crontab -e    </span><br><span class="line">crontab: no changes made to crontab    </span><br><span class="line">[root@VM-20-4-centos ~]# crontab -l    </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">secu-tcs-agent monitor, install at Mon Dec 13 00:25:07 CST 2021</span>    </span><br><span class="line">* * * * * /usr/local/sa/agent/secu-tcs-agent-mon-safe.sh &gt; /dev/null 2&gt;&amp;1    </span><br><span class="line">*/5 * * * * flock -xn /tmp/stargate.lock -c &#x27;/usr/local/qcloud/stargate/admin/start.sh &gt; /dev/null 2&gt;&amp;1 &amp;&#x27;    </span><br><span class="line">[root@VM-20-4-centos ~]# cat /var/spool/cron/root    </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">secu-tcs-agent monitor, install at Mon Dec 13 00:25:07 CST 2021</span>    </span><br><span class="line">* * * * * /usr/local/sa/agent/secu-tcs-agent-mon-safe.sh &gt; /dev/null 2&gt;&amp;1    </span><br><span class="line">*/5 * * * * flock -xn /tmp/stargate.lock -c &#x27;/usr/local/qcloud/stargate/admin/start.sh &gt; /dev/null 2&gt;&amp;1 &amp;&#x27; </span><br><span class="line"></span><br><span class="line">05.系统自带的cronie定时任务重要文件信息    </span><br><span class="line">1)/var/spool/cron/root    </span><br><span class="line">2)/var/log/cron    日志文件    </span><br><span class="line">Jan  1 07:20:01 VM-20-4-centos CROND[21680]: (root) CMD (/usr/local/sa/agent/secu-tcs-agent-mon-safe.sh &gt; /dev/null 2&gt;&amp;1)    </span><br><span class="line">Jan  1 07:20:01 VM-20-4-centos CROND[21678]: (root) CMD (flock -xn /tmp/stargate.lock -c &#x27;/usr/local/qcloud/stargate/admin/start.sh &gt; /dev/null 2&gt;&amp;1 &amp;&#x27;)    </span><br><span class="line">Jan  1 07:21:01 VM-20-4-centos CROND[21866]: (root) CMD (/usr/local/sa/agent/secu-tcs-agent-mon-safe.sh &gt; /dev/null 2&gt;&amp;1)    </span><br><span class="line">Jan  1 07:21:01 VM-20-4-centos CROND[21867]: (root) CMD (flock -xn /tmp/stargate.lock -c &#x27;/usr/local/qcloud/stargate/admin/start.sh &gt; /dev/null 2&gt;&amp;1 &amp;&#x27;)    </span><br><span class="line">Jan  1 07:22:01 VM-20-4-centos CROND[22054]: (root) CMD (/usr/local/sa/agent/secu-tcs-agent-mon-safe.sh &gt; /dev/null 2&gt;&amp;1)         </span><br><span class="line">     01列          02列          03列          04列     05列    </span><br><span class="line">04列：加载什么用户设置的定时任务    </span><br><span class="line">05列：执行什么定时任务</span><br><span class="line"></span><br><span class="line">06.编写定时任务技巧  </span><br><span class="line">	a 定时任务配置文件中的符号信息    </span><br><span class="line">	*  每XXX 每分钟 每小时 每天 每月 每周03    </span><br><span class="line">	/10 每隔什么 每隔10分钟    </span><br><span class="line">	-    时间的范围  00 12-16 * * *    </span><br><span class="line">	,    不连续的时间范围  00 12,15,18  </span><br><span class="line">	*/10  */10 * * * </span><br><span class="line">12:00 </span><br><span class="line">12:10 操作？？ </span><br><span class="line">需求：每隔一个小时 xx </span><br><span class="line">* */1 * * * </span><br><span class="line">11:00 12:00 12:01 12:02 12:03 12:59 13:00 </span><br><span class="line">* * * * * </span><br><span class="line"></span><br><span class="line">强调说明：/ - , </span><br><span class="line">这些符号出现的时候 </span><br><span class="line">如果出现在小时  尽量分钟要有具体设置默认* </span><br><span class="line">如果出现在天  尽量小时和分钟都要有具体设置 </span><br><span class="line"></span><br><span class="line">07.定时任务测试练习  </span><br><span class="line">    01.按照时间信息备份数据 备份到/backup  备份的文件/etc/hosts    </span><br><span class="line">    每隔5个小时进行备份        </span><br><span class="line"></span><br><span class="line">    00 */5 * * * cp /etc/hosts /backup/hosts_`date +%F`.txt      </span><br><span class="line"></span><br><span class="line">定时设置的注意事项：  </span><br><span class="line">01.在定时任务中不能识别一些特殊的符号信息  --- 利用脚本编写定时任务  </span><br><span class="line">02.一些文件路径，要编写为绝对路径信息  </span><br><span class="line">03.一些执行命令，在定时任务中出现的时候，也尽量用绝对路径    定时任务运行的时候，识别的环境变量信息$PATH=/usr/bin:/bin  </span><br><span class="line">04.定时任务每个信息前面，要有注释说明  </span><br><span class="line">05.当操作的命令任务，需要超过两个命令才能完成的时候，尽量编写脚本  </span><br><span class="line">06.在定时任务中，每个任务的结尾最后加上 &amp;&gt;/dev/nuLl 避免磁盘空间被占用  </span><br><span class="line">07.让一些命令操作不要产生输出信息      </span><br><span class="line">	tar zcf /backup/backup.tar.gz /etc/  --- 尽量不要加上 -v参数 尽量在要压缩数据上一级目录进行打包压缩（相对路径方式）   </span><br><span class="line">	</span><br><span class="line">You have mail in /var/spool/mail/root  </span><br><span class="line">为什么生成这个信息：是由一个邮件服务控制postfix   </span><br><span class="line"></span><br><span class="line">解决问题：  </span><br><span class="line">关闭postfix服务   </span><br><span class="line"></span><br><span class="line">邮件信息就会保存在/var/spool/postfix/maildrop/  </span><br><span class="line">生成文件时大量小文件(关闭postfix服务后)  </span><br><span class="line">为什么会产生邮件信息：  </span><br><span class="line">定时任务操作错误 操作失败 会产生错误邮件信息   </span><br><span class="line"></span><br><span class="line">08.定时任务编写规范  </span><br><span class="line">    a 直接在定时任务中书写命令    </span><br><span class="line">    编写时间同步的定时任务    </span><br><span class="line">    yum install -y ntp    </span><br><span class="line">    ntpdate ntpl.aliyun.com      </span><br><span class="line"></span><br><span class="line">第一个历程：测试定时任务中的执行命令    </span><br><span class="line">ntpdate ntpl.aliyun.com    </span><br><span class="line">28 Dec 15:14:37 ntpdate[86525]:step time server 120.25.115.20 offset -16927.642221 sec     </span><br><span class="line"></span><br><span class="line">第二个历程：编写定时任务信息    </span><br><span class="line">crontab -e    </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">crond-01 <span class="built_in">sync</span> time info</span>    </span><br><span class="line">*/10 * * * * /usr/sbin/ntpdate ntpl.aliyun.com &amp;&gt;/dev/null     </span><br><span class="line"></span><br><span class="line">第三个历程：检查定时任务效果    </span><br><span class="line">a 调整时间信息，让时间过得快一点  12:00 -- 调整  12：05 -- 12：10    </span><br><span class="line">b 调整配置文件中的时间      * * * * *     </span><br><span class="line"></span><br><span class="line">第四个历程：排查故障    </span><br><span class="line">关注日志信息信息/var/log/cron    </span><br><span class="line"></span><br><span class="line">b 直接在定时任务中调用脚本    </span><br><span class="line">第一个历程：测试定时执行脚本    </span><br><span class="line">/bin/sh /server/scripts/test.sh    </span><br><span class="line">/bin/sh -x /server/scripts/test.sh    ---  显示脚本执行过程        </span><br><span class="line"></span><br><span class="line">第二个历程：编写定时任务信息    </span><br><span class="line">crontab -e    </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">crond-01 <span class="built_in">sync</span> time info</span>        </span><br><span class="line">*/10 * * * * /bin/sh /server/scripts/test.sh 1&gt;/tmp/run.info 2&gt;/dev/null    </span><br><span class="line"></span><br><span class="line">第三个历程：检查定时任务效果    </span><br><span class="line">a 调整时间信息，让时间过得快一点  12:00 -- 调整  12：05 -- 12：10    </span><br><span class="line">b 调整配置文件中的时间      * * * * *        </span><br><span class="line"></span><br><span class="line">第四个历程：排查故障    </span><br><span class="line">关注日志信息信息/var/log/cron </span><br><span class="line"></span><br><span class="line">扩展作业： </span><br><span class="line">01.自行研究Logrotate服务配置应用方式 /var/log/oldboy.log </span><br><span class="line">02.正确输出信息，会不会发送邮件 </span><br><span class="line">03.按照时间信息定时切割日志  </span><br><span class="line">    1)每天晚上12点30切割日志  /var/log/secure-20181228  </span><br><span class="line">    2)需要在生成新的secure日志信息  </span><br><span class="line">    3)对切割好的日志进行压缩备份</span><br></pre></td></tr></table></figure>

<p><strong>定时任务语法规范示意图</strong></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard.png" alt="img"></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647566829756.png" alt="img"></p>
<ul>
<li><p>01.确认定时任务服务是否正在运行</p>
</li>
<li><ul>
<li>ps-ef|grep crond</li>
<li>&#x2F;etc&#x2F;init.d&#x2F;crond status</li>
</ul>
</li>
<li><p>02.确认定制任务服务是否开机启动</p>
</li>
<li><ul>
<li>chkconfig|grep crond</li>
<li>chkconfig –list crond</li>
</ul>
</li>
<li><p>系统当前可以使用定时任务 系统重启后也可以继续使用</p>
</li>
<li><p>01.配置定时任务服务(crontab-e)</p>
</li>
<li><ul>
<li><p>等价于使用vim命令编辑定时任务配置文件</p>
</li>
<li><ul>
<li>管理用户：vi &#x2F;var&#x2F;spool&#x2F;cron&#x2F;root</li>
<li>普通用户：vi &#x2F;var&#x2F;spool&#x2F;cron&#x2F;oldboy</li>
</ul>
</li>
</ul>
</li>
<li><p>02.查看定时任务信息(crontab-l)</p>
</li>
<li><ul>
<li>等价于使用cat命令查看定时任务配置文件</li>
<li>cat &#x2F;var&#x2F;spool&#x2F;cron&#x2F;root</li>
</ul>
</li>
<li><p>03.定时任务命令作用</p>
</li>
<li><ul>
<li>1.定时任务命令有语法检查功能，配置文件格式不对会报错</li>
<li>2.定时任务命令使用时方便简单</li>
</ul>
</li>
<li><p>03.定时任务相关文件</p>
</li>
<li><ul>
<li><p>1.定时任务服务配置文件所在目录（重点记忆）</p>
</li>
<li><ul>
<li>var&#x2F;spool&#x2F;cron</li>
</ul>
</li>
<li><p>2.定时任务服务运行记录日志文件（重点记忆）</p>
</li>
<li><ul>
<li>&#x2F;var&#x2F;log&#x2F;cron</li>
</ul>
</li>
<li><p>日志文件信息如何查看</p>
</li>
<li><ul>
<li><p>日志查看命令</p>
</li>
<li><ul>
<li>1.head&#x2F;tail</li>
<li>2.tail&#x2F;tail -f</li>
<li>3.grep&#x2F;egrep</li>
<li>4.less</li>
<li>5.more</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><p>3.定时任务服务禁止用户运行名单（了解即可）</p>
</li>
<li><ul>
<li>&#x2F;etc&#x2F;cron.deny(定时任务黑名单)</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>定时任务重点知识总结</strong></p>
<ul>
<li><p>01.定时任务的9句劝告</p>
</li>
<li><ul>
<li><p>①.定时任务规规则之前加注释</p>
</li>
<li><ul>
<li>表示定时任务在干什么</li>
</ul>
</li>
<li><p>②.使用脚本替代命令执行定时任务</p>
</li>
<li><ul>
<li>超过两条命令，就用脚本</li>
<li>脚本相当于命令的合集</li>
</ul>
</li>
<li><p>③.定时任务中date命令%百分号</p>
</li>
<li><ul>
<li>* * * * * date +%F%T &gt;&gt;&#x2F;oldboy&#x2F;time.txt 2&gt;&amp;1</li>
</ul>
</li>
<li><p>④.运行脚本一定要用&#x2F;bin&#x2F;sh</p>
</li>
<li><ul>
<li>因为默认脚本没有执行权限</li>
</ul>
</li>
<li><p>⑤.定时任务中-命令或脚本结果(正确及错误)定向到黑洞(&gt;&#x2F;dev&#x2F;null 2&gt;&amp;1)或追加到文件中 &gt;&gt; &#x2F;tmp&#x2F;oldboy.txt 2&gt;&amp;1</p>
</li>
<li><p>⑥.避免不必要的程序及命令输出</p>
</li>
<li><p>⑦.打包压缩使用相对路径（切到目标目录的上一级打包目标）</p>
</li>
<li><p>⑧.定时任务脚本中的程序文件，尽量用绝对路径</p>
</li>
<li><p>⑨.系统与命令位置有关的环境变量问题</p>
</li>
<li><ul>
<li>$PATH &#x3D; &#x2F;usr&#x2F;bin:&#x2F;bin</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="day23-操作系统磁盘管理说明-P275"><a href="#day23-操作系统磁盘管理说明-P275" class="headerlink" title="day23-操作系统磁盘管理说明 P275"></a><strong>day23-操作系统磁盘管理说明 P275</strong></h2><h2 id="day25-rsync"><a href="#day25-rsync" class="headerlink" title="day25-rsync"></a><strong>day25-rsync</strong></h2><p>ucloud</p>
<p>阿里云</p>
<p>腾讯云</p>
<p>青云</p>
<p>1.为什么要做备份？</p>
<p>​	数据非常的重要</p>
<p>​	保证数据不丢失</p>
<p>​	便于快速的恢复</p>
<p>2.能不能不做备份？</p>
<p>​	可以，对于不是特别重要的数据可以</p>
<p>3.备份怎么做？</p>
<p>​	完全备份，全备，效率低下。</p>
<p>​	增量备份，增备，效率较高。</p>
<p>4.用什么工具做备份？</p>
<p>​	scp  网络之间的拷贝，全量拷贝的方式（ssh协议）</p>
<p>​	rsync  远程同步（增量）</p>
<p>rsync是一款开源的备份工具，</p>
<p>可以在不同主机之间进行同步，</p>
<p>可实现全量备份与增量备份，因此非常适合用于架构集中式备份或异地备份等应用。</p>
<p>备份的方式</p>
<p>​    完全备份，每次都进行全部备份（效率低下，占用空间）</p>
<p>​    增量备份，仅备份客户端与服务端差异的部分（提高备份效率，节省空间，适合异地备份）</p>
<p>rsync数据的同步模式</p>
<p>​    推送：本地将数据上传至备份服务器上（上传）</p>
<p>​    拉取：备份服务器获取本地服务器的数据（下载）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">rsync的数据传输方式 </span><br><span class="line">本地传输（类似于使用cp命令）  </span><br><span class="line">远程传输（通过网络传输a--&gt;b）  </span><br><span class="line">守护进程（运行一个服务一直在后台）          </span><br><span class="line">		命令   选项       源文件 目标文件  </span><br><span class="line">Local: rsync [OPTION...] SRC... [DEST]  </span><br><span class="line">rsync -avz ./anaconda-ks.cfg /opt/      </span><br><span class="line"></span><br><span class="line">Access via remote shell:     </span><br><span class="line">拉取 Pull: rsync [OPTION...] [USER@]HOST:SRC... [DEST]     </span><br><span class="line">推送 Push: rsync [OPTION...] SRC... [USER@]HOST:DEST       </span><br><span class="line"></span><br><span class="line">推送方式：    </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#nfs-----&gt;推送方</span></span>    </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#backup--&gt;接收方</span></span>            </span><br><span class="line"></span><br><span class="line">[root@nfs ~]# rsync -avz /etc/passwd root@172.16.1.41:/tmp    </span><br><span class="line">将本地的/etc/passwd文件，推送到172.16.1.41服务器的tmp目录下，使用的是41的root用户身份  </span><br><span class="line">拉取方式：    </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#nfs-----&gt;拉取方</span></span>    </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#backup--&gt;备份源</span></span>    </span><br><span class="line">[root@nfs ~]# rsync -avz root@172.16.1.41:/etc/services ./    </span><br><span class="line">本地nfs服务器下载172.16.1.41服务器/etc/services这个文件，至本地当前目录下，使用的是41的系统用户root身份    </span><br><span class="line">Rsync借助SSH协议同步数据存在的缺陷（临时发送数据）      </span><br><span class="line">1.使用系统用户（不安全）      </span><br><span class="line">2.使用普通用户（会导致权限不足情况）     </span><br><span class="line"></span><br><span class="line">Access via rsync daemon:     </span><br><span class="line">下载 Pull: rsync [OPTION..…] [USER@]HOST::SRC... [DEST]            </span><br><span class="line">	rsync [OPTION...] rsync://[USER@]HOST[:POR]/SRC... [DEST]     </span><br><span class="line">上传 Push: rsync [OPTION...] SRC... [USER@]HOST::DEST            </span><br><span class="line">	rsync [OPTION...] SRC... rsync://[USER@]HOST[:PORT]/DEST </span><br><span class="line"></span><br><span class="line">---配置详解 </span><br><span class="line">[root@backup ~]# vim /etc/rsyncd.conf </span><br><span class="line">uid = rsync    #运行进程的用户 </span><br><span class="line">gid = rsync    #运行进程的用户组 </span><br><span class="line">port = 873    #监听端口 </span><br><span class="line">fake super = yes    #无需让rsync以root身份运行，允许接收文件的完整属性 </span><br><span class="line">use chroot = no    #禁锢推送的数据至某个目录，不允许跳出该目录 </span><br><span class="line">max connections = 200    #最大连接数 timeout = 600    #超时时间 </span><br><span class="line">ignore errors    #忽略错误信息 </span><br><span class="line">read only =false    #对备份数据可读写 </span><br><span class="line">list = false    #不允许查看模块信息 </span><br><span class="line">auth users = rsync_backup    #定义虚拟用户，作为连接认证用户 </span><br><span class="line">secrets file=/etc/rsync.passwd    #定义rsync服务用户连接认证密码文件路径 </span><br><span class="line"></span><br><span class="line">[backup]    #定义模块信息 </span><br><span class="line">comment = commit    #模块注释信息 </span><br><span class="line">path = /backup    #定义接收备份数据目录 </span><br><span class="line"></span><br><span class="line">创建rsync进程启动时需要使用的用户 </span><br><span class="line">[root@backup ~]# useradd rsync -M -s /sbin/nologin </span><br><span class="line">[root@backup ~]# id rsync uid=1000(rsync) gid=1000(rsync) groups=1000(rsync) </span><br><span class="line"></span><br><span class="line">创建密码文件，在密码文件中写入对应的虚拟用户以及虚拟用户的密码 </span><br><span class="line">/etc/rsync.passwd---》rsync虚拟用户以及rsync虚拟用户的密码 </span><br><span class="line">[root@backup ~]# echo &quot;rsync_backup:123456&quot; &gt; /etc/rsync.passwd </span><br><span class="line">[root@backup ~]# chmod 600 /etc/rsync.passwd </span><br><span class="line"></span><br><span class="line">创建存储备份数据的目录，并进行授权 </span><br><span class="line">[root@backup ~]# mkdir /backup </span><br><span class="line">[root@backup ~]# chown -R rsync.rsync /backup/  </span><br><span class="line"></span><br><span class="line">启动rsync服务并加入开机自启动 </span><br><span class="line">[root@backup ~]# systemctl start rsyncd.service </span><br><span class="line">[root@backup ~]# systemctl enable rsyncd </span><br><span class="line"></span><br><span class="line">检查rsync的873端口是否存在 </span><br><span class="line">[root@backup ~]# netstat -lntp </span><br><span class="line">Active Internet connections (only servers) </span><br><span class="line">Proto Recv-Q Send-Q Local Address  Foreign Address   State    PID/Program name </span><br><span class="line">tcp       O       0 0.0.0.0:873    0.0.0.0:*         LISTEN    11129/rsync </span><br><span class="line"></span><br><span class="line">客户端测试    </span><br><span class="line">Access via rsync daemon:     </span><br><span class="line">下载 Pull: rsync [OPTION..…] [USER@]HOST::SRC... [DEST]            </span><br><span class="line">	rsync [OPTION...] rsync://[USER@]HOST[:POR]/SRC... [DEST]     </span><br><span class="line">上传 Push: rsync [OPTION...] SRC... [USER@]HOST::DEST            </span><br><span class="line">	rsync [OPTION...] SRC... rsync://[USER@]HOST[:PORT]/DEST                 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@nfs ~]# rsync -avz --delete /root rsync_backup@172.16.1.41::backup #</span><br><span class="line"></span><br><span class="line">拉取方式实现无差异，以服务端为准，服务端有什么客户端就有什么 </span><br><span class="line">[root@nfs ~]# rsync -avz --delete rsync_backup@172.16.1.41::backup /opt/ </span><br><span class="line"></span><br><span class="line">对传输时候进行限速： </span><br><span class="line"><span class="meta prompt_">[root@nfs~]# </span><span class="language-bash"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=./size.disk bs=1M count=500  生成大文件</span> </span><br><span class="line"></span><br><span class="line">限制传输的速率为1MB，实际上占用的带宽时8MB </span><br><span class="line">[root@nfs ~]# rsync -avzP --bwlimit=1 ./size.disk rsync_backup@172.16.1.41::backup </span><br><span class="line">Password: </span><br><span class="line">sending incremental file list </span><br><span class="line">size.disk  </span><br><span class="line">	118,358,016  22%  1.01MB/s  0:06:33   </span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">rsync参数：avz </span><br><span class="line">-a #归档模式传输，等于-tropgDl </span><br><span class="line">-v  #详细模式输出，打印速率，文件数量等 </span><br><span class="line">-z  #传输时进行压缩以提高效率 </span><br><span class="line">-r  #递归传输目录及子目录，即目录下得所有目录都同样传输。 </span><br><span class="line">-t  #保持文件时间信息 </span><br><span class="line">-o  #保持文件属主信息 </span><br><span class="line">-p  #保持文件权限 </span><br><span class="line">-g  #保持文件属组信息 </span><br><span class="line">-l  #保留软连接 </span><br><span class="line">-p  #显示同步的过程及传输时的进度等信息 </span><br><span class="line">-D  #保持设备文件信息 </span><br><span class="line">-L  #保留软连接指向的目标文件 </span><br><span class="line">-e  #使用的信道协议，指定替代rsh的shel1程序 </span><br><span class="line">--excLude=PATTERN    #指定排除不需要传输的文件模式 </span><br><span class="line">--exclude-from=file    #文件名所在的目录文件 </span><br><span class="line">--bwlimit=100    #限速传输 </span><br><span class="line">--partial    #断点续传 </span><br><span class="line">--delete    #让目标目录和源目录数据保持一致</span><br></pre></td></tr></table></figure>



<p><strong>Rsync远程同步</strong></p>
<ul>
<li><p>为什么要做备份？</p>
</li>
<li><ul>
<li>数据非常的重要</li>
<li>保证数据不丢失</li>
<li>便于快速的恢复</li>
</ul>
</li>
<li><p>2.能不能不做备份？</p>
</li>
<li><ul>
<li>不重要的数据可以不考虑</li>
</ul>
</li>
<li><p>Rsync能做什么？</p>
</li>
<li><ul>
<li>实现不同主机之间同步数据</li>
</ul>
</li>
<li><p>Rsync传输模式</p>
</li>
<li><ul>
<li>推送数据方式 push</li>
<li>拉取数据方式 pull</li>
</ul>
</li>
<li><p>Rsync使用场景</p>
</li>
<li><ul>
<li>集中式备份</li>
<li>异地备份</li>
</ul>
</li>
<li><p>Rsync传输模式</p>
</li>
<li><ul>
<li>本地传输（不推荐）</li>
<li>远程传输（不安全）</li>
<li>守护进程（强烈推荐）</li>
</ul>
</li>
<li><p>Rsync守护进程</p>
</li>
<li><ul>
<li><p>安装</p>
</li>
<li><p>配置</p>
</li>
<li><ul>
<li>根据配置文件提供的内容进行修改</li>
<li>根据配置文件准备相应的环境</li>
</ul>
</li>
<li><p>启动</p>
</li>
</ul>
</li>
<li><p>Rsync其他选项</p>
</li>
<li><ul>
<li>–delete  强制一致</li>
<li>—bwlimit  限速</li>
<li>-avz  属性相关</li>
<li>-P  显示传输的速率</li>
<li>–password-file 客户端指定密码文件</li>
</ul>
</li>
</ul>
<h2 id="day26-rsync-2"><a href="#day26-rsync-2" class="headerlink" title="day26-rsync-2"></a><strong>day26-rsync-2</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">3.我要备份到哪？</span><br><span class="line">  rsync备份服务器  172.16.1.41</span><br><span class="line"></span><br><span class="line">----------------</span><br><span class="line">1.创建对应的目录</span><br><span class="line">    hostname</span><br><span class="line">    ifconfig ethl|awk &#x27;NR==2 &#123;print $2&#125;&#x27;</span><br><span class="line">    date +%F</span><br><span class="line">mkdir -p /backup/$(hostname)_$(ifconfig eth1|awk &#x27;NR==2 &#123;print $2&#125;&#x27;)_$(date +%F)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">客户端脚本的位置</span><br><span class="line">                     #批量修改时间。并执行脚本，产生数据文件</span><br><span class="line">[root@nfs ~]# for i in &#123;1..30&#125;;do date -s 2018/12/$i;sh /server/scripts/client_push_data.sh ;done</span><br><span class="line">[root@nfs ~]# cat /server/scripts/client_push_data.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.定义变量</span></span><br><span class="line">SRC=/backup</span><br><span class="line">HOST=$(hostname)</span><br><span class="line">ADDR=$(ifconfig eth1|awk &#x27;NR==2 &#123;print $2&#125;&#x27;)</span><br><span class="line">DATE=$(date +%F)</span><br><span class="line">DEST=$&#123;HOST&#125;_$&#123;ADDR&#125;_$&#123;DATE&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.创建目录</span></span><br><span class="line">[ -d $SRC/$DEST ] || mkdir -p $SRC/$DEST</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.备份文件</span></span><br><span class="line">cd / &amp;&amp; \</span><br><span class="line">[ -f $SRC/$DEST/sys.tar.gz ] || tar czf $SRC/$DEST/sys.tar.gz etc/fstab etc/passwd &amp;&amp;\</span><br><span class="line">[ -f $SRC/$DEST/other.tar.gz ] || tar czf $SRC/$DEST/other.tar.gz var/spool/cron/ server/scripts &amp;&amp; \</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4.使用md5打标记</span></span><br><span class="line">[ -f $SRC/$DEST/flag_$DATE ] || md5sum $SRC/$DEST/*.tar.gz &gt; $SRC/$DEST/flag_$DATE</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4.本地推送到备份服务器</span></span><br><span class="line">export RSYNC_PASSWORD=123456</span><br><span class="line">rsync -avz $SRC/$DEST rsync_backup@172.16.1.41::backup</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5.保留本地最近7天的数据</span></span><br><span class="line">find $SRC/ -type d -mtime +7|xargs rm -rf</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">服务端操作如下：</span><br><span class="line"></span><br><span class="line">1.配置邮件</span><br><span class="line">[root@backup ~]# yum install mailx -y</span><br><span class="line">[root@backup ~]# vim /etc/mail.rc</span><br><span class="line">set from=123@qq.com</span><br><span class="line">set smtp=smtps://smtp.qq.com:465</span><br><span class="line">set smtp-auth-user=123@qq.com</span><br><span class="line">set smtp-auth-password=xxxxxx</span><br><span class="line">set smtp-auth=login</span><br><span class="line">set ssl-verify=ignore</span><br><span class="line">set nss-config-dir=/etc/pki/nssdb/</span><br><span class="line"></span><br><span class="line">2.验证能否成功的发送邮件</span><br><span class="line">[root@backup ~]# mkdir /server/scripts -p</span><br><span class="line">[root@backup ~]# cat /server/scripts/check_client_data.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.定义变量</span></span><br><span class="line">SRC=/backup</span><br><span class="line">DATE=$(date +%F)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.保留最近180天的数据</span></span><br><span class="line">find $SRC/ -type d -mtime +180|xargs rm -rf</span><br><span class="line"></span><br><span class="line">最后进行整体测试：</span><br><span class="line">  1.删除客户端的整个目录</span><br><span class="line">  2.删除服务端/backup下面的所有内容</span><br><span class="line">  3.编写定时任务测试【在修改客户端每天凌晨1点，服务端每天凌晨5点】</span><br><span class="line"></span><br><span class="line">如何扩展备份多台服务器：</span><br><span class="line">[root@web01 ~]# rsync -avz root@172.16.1.31:/server /</span><br><span class="line">[root@webe1 ~]# sh /server/scripts/client_push_data.sh</span><br><span class="line"></span><br><span class="line">下午作业：</span><br><span class="line">  备份3台客户端的数据至服务端</span><br><span class="line">  服务端进行校验，校验要有邮件通知</span><br><span class="line">  </span><br><span class="line">本周作业：</span><br><span class="line">  录视频（要有声音）：</span><br><span class="line">    1.综合架构</span><br><span class="line">    2.全网备份3台机器-&gt;备份服务器</span><br><span class="line">    </span><br><span class="line">  操作不要超过30分钟</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="day27-nfs"><a href="#day27-nfs" class="headerlink" title="day27-nfs"></a><strong>day27-nfs</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">  临时</span><br><span class="line">  周期性任务</span><br><span class="line">  </span><br><span class="line">保证客户端与服务端数据一致？</span><br><span class="line">  --delete参数</span><br><span class="line">  </span><br><span class="line">限制推送传输的速率？</span><br><span class="line">  --bwlimit  限速</span><br><span class="line">  -P  显示速率</span><br><span class="line">  </span><br><span class="line">rsync守护进程配置?</span><br><span class="line">  安装</span><br><span class="line">  配置</span><br><span class="line">  启动</span><br><span class="line">  </span><br><span class="line">rsync进程运行的用户和rsync_backup虚拟用户区别？</span><br><span class="line">  rsync_backup：用于提供给客户端远程连接</span><br><span class="line">  rsync：是否往本地服务器写入客户端推送过来的数据</span><br><span class="line"></span><br><span class="line">[root@nfs ~]# telnet 172.16.1.41 873</span><br><span class="line">Trying 172.16.1.41...</span><br><span class="line">telnet: connect to address 172.16.1.41: Connection refused  #端口不可达</span><br><span class="line"></span><br><span class="line">[root@nfs ~]# telnet 172.16.1.41 873</span><br><span class="line">Trying 172.16.1.41...</span><br><span class="line">telnet: connect to address 172.16.1.41: No route to host  #防火墙拦截</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当rsync服务端没有创建数据存放的目录时，则会出现如下提示</span></span><br><span class="line">[root@nfs ~]# sh /server/scripts/client_push_data.sh</span><br><span class="line">@ERROR: chdir failed</span><br><span class="line">rsync error: error starting client-server protocol (code 5) at main.c(1648) [sender=3.1.2]</span><br><span class="line"></span><br><span class="line">2019/01/07 08:57:33 [1272] rsync: chdir /backup failed</span><br><span class="line">: No such file or directory (2)</span><br><span class="line"></span><br><span class="line">NFS是Network File System的缩写及网络文件系统。NFS主要功能是通过局域网络让不同的主机系统之间可以共享文件或目录。</span><br><span class="line">NFS系统和Windows网络共享、网络驱动器类似，只不过windows用于局域网，NFS用于企业集群架构中</span><br><span class="line">如果是大型网站，会用到更复杂的分布式文件系统FastDFS（音频、小说、视频），glusterfs（iso镜像），HDFS</span><br><span class="line">NFS（图片、）解决共享前端web共享</span><br><span class="line"></span><br><span class="line">nfs</span><br><span class="line">解决前端web静态资源的共享</span><br><span class="line">解决前端web静态资源一致性</span><br><span class="line">解决前端web磁盘空间的浪费</span><br><span class="line"></span><br><span class="line">并不能解决网站访问的延时，如果想解决访问延时：</span><br><span class="line"></span><br><span class="line">静态资源---&gt;CDN</span><br><span class="line"></span><br><span class="line">本地文件操作方式</span><br><span class="line">1.当用户执行mkdir命令，该命令会调用shell解释器翻译给内核。</span><br><span class="line">2.内核解析完成后会驱动对应的硬件设备，完成相应的操作。</span><br><span class="line"></span><br><span class="line">程序</span><br><span class="line">进程</span><br><span class="line">线程</span><br><span class="line">NFS实现原理（需要先了解[程序|进程|线程]）</span><br><span class="line">  1.用户进程访问NFS客户端，使用不同的函数对数据进行处理</span><br><span class="line">  2.NFS客户端通过TCP/IP的方式传递给NFS服务端。</span><br><span class="line">  3.NFS服务端接收到请求后，会先调用portmap进程进行端口映射。</span><br><span class="line">  4.nfsd进程用于判断NFS客户端是否拥有权限连接NFS服务端。</span><br><span class="line">  5.Rpc.mount进程判断客户端是否有对应的权限进行验证。</span><br><span class="line">  6.idmap进程实现用户映射和压缩</span><br><span class="line">  7.最后NFS服务端会将对应请求的函数转换为本地能识别的命令，传递至内核，由内核驱动硬件。</span><br><span class="line">  </span><br><span class="line">  注意：rpc是一个远程过程调用，那么使用nfs必须有rpc服务</span><br><span class="line"></span><br><span class="line">nfs</span><br><span class="line">  安装</span><br><span class="line">    [root@nfs ~]# yum install nfs-utils -y</span><br><span class="line">  配置</span><br><span class="line">    [root@nfs ~]# cat /etc/exports</span><br><span class="line">    /data 172.16.1.0/24(rw,sync,all_squash)</span><br><span class="line">  授权  </span><br><span class="line">    [root@nfs ~]# mkdir /data</span><br><span class="line">    [root@nfs01 ~]# chown -R nfsnobody.nfsnobody /data/</span><br><span class="line"></span><br><span class="line">  启动</span><br><span class="line">    [root@nfs ~]# systemctl start nfs-server</span><br><span class="line">    [root@nfs ~]# systemctl enable nfs-server</span><br><span class="line">    </span><br><span class="line">  检查</span><br><span class="line">    [root@nfs ~]# cat /var/lib/nfs/etab</span><br><span class="line">    /data  172.16.1.0/24(rw,sync,wdelay,hide,nocrossmnt,secure,root_squash,all_squash,no_subtree_check,secure_locks,ac</span><br><span class="line"></span><br><span class="line">客户端操作</span><br><span class="line">  安装</span><br><span class="line">    [root@nfs~]# yum install nfs-utils -y  #rpc软件包、showmount命令</span><br><span class="line">  检查nfs是否有共享的内容</span><br><span class="line">    [root@web01 ~]# showmount -e 172.16.1.31</span><br><span class="line">    Export list for 172.16.1.31:</span><br><span class="line">    /data 172.16.1.0/24</span><br><span class="line"></span><br><span class="line">挂载</span><br><span class="line">[root@web01 ~]# mount -t nfs 172.16.1.31:/data /opt</span><br><span class="line"><span class="meta prompt_">[root@web01~]# </span><span class="language-bash">df-h</span></span><br><span class="line">Filesystem  Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda3    99G  1.2G   98G   2%   /</span><br><span class="line">devtmpfs    477M     0  477M   0%   /dev</span><br><span class="line">tmpfs       488M     0  488M   0%   /dev/shm</span><br><span class="line">tmpfs       488M  7.7M  480M   2%   /run</span><br><span class="line">tmpfs       488M     0  488M   0%  /sys/fs/cgroup</span><br><span class="line">/dev/sdal   197M  102M   96M  52%  /boot</span><br><span class="line">tmpfs        98M     0   98M</span><br><span class="line">172.16.1.31:/data  99G  1.8G 98G 2% /opt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sample /etc/exports file</span></span><br><span class="line">  共享的目录     共享给谁（共享的参数）</span><br><span class="line">    /             master(rw) trusty(rw,no_root_squash)</span><br><span class="line">    /projects     proj*.local.domain(rw)</span><br><span class="line">    /usr          *.local.domain(ro) @trusted(rw)</span><br><span class="line">    /home/joe     pc001(rw,all_squash,anonuid=150,anongid=100)</span><br><span class="line">    /pub          *(ro,insecure,all_squash)</span><br><span class="line">    /srv/www      -sync,rw server @trusted @external(ro)</span><br><span class="line">    /foo          2001:db8:9:e54::/64(rw) 192.0.2.0/24(rw)</span><br><span class="line">    /build        buildhost[0-9].local.domain(rw)</span><br><span class="line"></span><br><span class="line">尝试写入数据测试</span><br><span class="line">[root@web01 opt]# pwd</span><br><span class="line">/opt</span><br><span class="line">[root@web01 opt]# touch file</span><br><span class="line">[root@web01 opt]# mkdir test</span><br><span class="line">[root@web01 opt]# ll</span><br><span class="line">total 0</span><br><span class="line">-rw-r--r-- 1 nfsnobody nfsnobody 0 Jan 7 10:37 file</span><br><span class="line">drwxr-xr-x 2 nfsnobody nfsnobody 6 Jan 7 10:37 test</span><br><span class="line"></span><br><span class="line">在客户端将nfs挂载信息写入/etc/fstab文件中</span><br><span class="line">172.16.1.31:/data    /opt    nfs   defaults 0 0</span><br><span class="line"></span><br><span class="line">mount -a  #验证fstab开机启动是否填写错误。</span><br><span class="line"></span><br><span class="line">nfs挂载：客户端当前的目录仅仅只是nfs服务端共享目录的一个入口文件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5.如果希望NFS文件共享服务能一直有效，则需要将其写入到fstab 文件中</span><br><span class="line">[root@nfs-client ~]# vim /etc/fstab</span><br><span class="line">172.16.1.31:/data /nfsdir nfs defaults 0 0</span><br><span class="line"></span><br><span class="line">6.如果不希望使用NFS共享，可进行卸载</span><br><span class="line">[root@nfs-client ~]# umount /nfsdir</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意：卸载的时候如果提示<span class="string">&quot;umount.nfs：/nfsdir:device is busy&quot;</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.切换至其他目录，然后在进行卸载。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.NFS Server宕机，强制卸载umount-lf /nfsdir</span></span><br></pre></td></tr></table></figure>

<h2 id="day30-http"><a href="#day30-http" class="headerlink" title="day30-http"></a><strong>day30-http</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">http1.1  长连接  仅一次tcp连接，可以发起多次http请求</span><br><span class="line">http2.0</span><br><span class="line">http3.0</span><br><span class="line"></span><br><span class="line">http请求</span><br><span class="line"></span><br><span class="line">Request URL: http://10.0.0.7/  #请求的URl地址</span><br><span class="line">Request Method: GET  #请求方法</span><br><span class="line">Status Code: 200 OK  #状态码</span><br><span class="line"></span><br><span class="line">Remote Address: 10.0.0.7:80  #请求的主机的地址和端口</span><br><span class="line">authority: www.xuliangwei.com  #认证的域名</span><br><span class="line">:method: GET  #请求方法</span><br><span class="line"></span><br><span class="line">:path: /  #请求的路径</span><br><span class="line">:scheme: https  #请求的协议 http https</span><br><span class="line">Accept: text/html  #请求的类型</span><br><span class="line">Accept-Encoding: gzip, deflate  #压缩</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9  #语言</span><br><span class="line">Cache-Control: no-cache  #缓存</span><br><span class="line"></span><br><span class="line">Connection: keep-alive  #保持连接长连接</span><br><span class="line">Host: 10.0.0.7  #请求域名</span><br><span class="line">Pragma: no-cache  #没有缓存</span><br><span class="line">User-Agent: Chrome/65.0.3325.181  #用户浏览器</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="day31-nginx-P359"><a href="#day31-nginx-P359" class="headerlink" title="day31-nginx P359"></a><strong>day31-nginx P359</strong></h2><p><strong>1.Nginx基本简述</strong></p>
<p><strong>Nginx是一个开源且高性能、可靠的Http Web服务、代理服务。</strong></p>
<p>开源：直接获取源代码</p>
<p>高性能：支持海量并发</p>
<p>可靠：服务稳定</p>
<p><strong>我们为什么选择Ngnx服务</strong></p>
<p><strong>Nginx非常轻量</strong></p>
<p>功能模快少（源代码仅保留邵tp与核心模块代码，其余不够核心代码会作为插件来安装）</p>
<p>代码模块化（易读，便于二次开发，对于开发人员非常友好）</p>
<p><strong>互联网么司都选择Nginx</strong></p>
<p>1.Nginx技术成熟，具备的功能是企业最常使用而且最需要的</p>
<p>2.适合当前主流架构趋势，微服务、云架构、中间层</p>
<p>3.统一技术栈，降低维护成本，降低技术更新成本。</p>
<p><strong>Nginx:采用Epooll网络模型，Apache采用Selecti摸型</strong></p>
<p>Select:当用户发起一次请求，selecti模型就会进行一次遍历扫描，从而导致性能低下。</p>
<p>Epool:当用户发起请求，epool模型会直接进行处理，效率高效，并无连接限制。</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647566840637.png" alt="img"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br></pre></td><td class="code"><pre><span class="line">开源的web服务器（静态资源）</span><br><span class="line">    nginx</span><br><span class="line">    apache</span><br><span class="line">    IIS</span><br><span class="line">    lighttpd</span><br><span class="line">    tengine</span><br><span class="line">    openresty</span><br><span class="line">    </span><br><span class="line">动态：</span><br><span class="line">    Tomcat</span><br><span class="line">    Jboos</span><br><span class="line">    resin</span><br><span class="line">            </span><br><span class="line">Nginx安装</span><br><span class="line">    yum方式(官方)</span><br><span class="line">    </span><br><span class="line">    [root@VM-20-4-centos yum.repos.d]# vim /etc/yum.repos.d/nginx.repo</span><br><span class="line">    [root@VM-20-4-centos yum.repos.d]# cat /etc/yum.repos.d/nginx.repo</span><br><span class="line">    [nginx]</span><br><span class="line">    name=nginx repo</span><br><span class="line">    baseurl=http://nginx.org/packages/centos/7/$basearch/</span><br><span class="line">    gpgcheck=0  #不校验软件包是否安全 [0|1]</span><br><span class="line">    enabled=1  #启用这个仓库</span><br><span class="line">    </span><br><span class="line">    [root@VM-20-4-centos ~]# yum install nginx -y</span><br><span class="line">    # 查看版本</span><br><span class="line">    [root@VM-20-4-centos ~]# nginx -v</span><br><span class="line">    nginx version: nginx/1.20.2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    源码编译安装</span><br><span class="line">    [root@VM-20-4-centos ~]# wget http://nginx.org/download/nginx-1.14.2.tar.gz</span><br><span class="line">    root@VM-20-4-centos ~]# tar xf nginx-1.14.2.tar.gz</span><br><span class="line">    [root@VM-20-4-centos ~]# cd nginx-1.14.2/</span><br><span class="line">    [root@VM-20-4-centos nginx-1.14.2]# ./configure --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt=&#x27;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC&#x27; --with-ld-opt=&#x27;-Wl,-z,relro -Wl,-z,now -pie&#x27;</span><br><span class="line">    [root@VM-20-4-centos nginx-1.14.2]# make &amp;&amp; make install</span><br><span class="line">    [root@VM-20-4-centos nginx-1.14.2]# echo $?  #结果返还为0就是正确（如何确认报错）</span><br><span class="line">    0</span><br><span class="line"></span><br><span class="line">目录结构</span><br><span class="line">[root@VM-20-4-centos nginx-1.14.2]# rpm -ql nginx</span><br><span class="line">[root@VM-20-4-centos nginx-1.14.2]# systemctl enable nginx</span><br><span class="line">[root@VM-20-4-centos nginx-1.14.2]# systemctl start nginx</span><br><span class="line"></span><br><span class="line">启动方式有两种：</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第一种方式一般源码编译的时候使用</span></span><br><span class="line">  nginx  启动</span><br><span class="line">  nginx -s stop  停止</span><br><span class="line">  nginx -s reload |restart  重载服务</span><br><span class="line">  </span><br><span class="line">  systemctl start nginx</span><br><span class="line">  systemctl restart nginx</span><br><span class="line">  systemctl stop nginx</span><br><span class="line"></span><br><span class="line">nginx配置文件</span><br><span class="line">[root@VM-20-4-centos ~]# cat /etc/nginx/nginx.conf </span><br><span class="line"></span><br><span class="line">-------------------核心模块</span><br><span class="line">user  nginx;    #nginx进程运行的用户</span><br><span class="line">worker_processes  auto;    #nginx工作的进程数量</span><br><span class="line"></span><br><span class="line">error_log  /var/log/nginx/error.log notice;    #nginx的错误日志【警告及其警告以上的都记录】</span><br><span class="line">pid        /var/run/nginx.pid;    #nginx进程运行后的进程id</span><br><span class="line">-------------------</span><br><span class="line"></span><br><span class="line">-------------------事件模块</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;    #一个work进程的最大连接数</span><br><span class="line">    use epool;    #使用epool网络模型</span><br><span class="line">&#125;</span><br><span class="line">-------------------</span><br><span class="line"></span><br><span class="line">-------------------http核心层模块</span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;    #包含资源类型文件</span><br><span class="line">    default_type  application/octet-stream;    #默认以下载方式传输给浏览器（前提是该资源在mimle.types中无法找到）</span><br><span class="line">    </span><br><span class="line">    # 日志格式定义</span><br><span class="line">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;    #访问日志</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;    #长连接超时事件</span><br><span class="line"></span><br><span class="line">    #gzip  on;    #是否开启压缩功能</span><br><span class="line"></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;    #包含哪个目录下面的*.conf文件</span><br><span class="line">    server &#123;    # 定义一个网站</span><br><span class="line">    listen       80;    #监听端口</span><br><span class="line">    server_name  localhost;    #域名</span><br><span class="line">    </span><br><span class="line">    #charset koi8-r;    #字符集</span><br><span class="line">    #access_log  /var/log/nginx/host.access.log  main;    #访问日志</span><br><span class="line"></span><br><span class="line">    location / &#123;     #位置</span><br><span class="line">        root   /usr/share/nginx/html;    #代码的主文件位置</span><br><span class="line">        index  index.html index.htm;    #服务端默认返回给用户的文件</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">-------------------</span><br><span class="line"></span><br><span class="line">http server location扩展了解项</span><br><span class="line">http&#123;&#125; 分层下允许有多个Server&#123;&#125;个层，一个Server&#123;&#125;层下又允许有多个Location</span><br><span class="line">http&#123;&#125; 个标签主要用来解决用户的请求与响应。</span><br><span class="line">server&#123;&#125; 标签主要用来响应具体的某一个网站。</span><br><span class="line">location&#123;&#125; 标签主要用于匹配网站具体URL路径。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Nginx搭建一个静态资源web服务器</span><br><span class="line"></span><br><span class="line">1.编写Nginx配置文件</span><br><span class="line">[root@VM-20-4-centos conf.d]# cat game.conf </span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name game.oldboy.com;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    root /code;</span><br><span class="line">    index index.html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">2.根据配置文件，创建目录，上传代码</span><br><span class="line">[root@web01 ~]# mkdir /code</span><br><span class="line">[root@web01 ~]# cd /code</span><br><span class="line">[root@web01 ~]# rz html5.zip</span><br><span class="line">[root@web01 code]# unzip html5.zip</span><br><span class="line">3.重载nginx服务</span><br><span class="line">[root@web01 code]# systemctl restart nginx  #立即重启</span><br><span class="line">[root@web01 code]# systemctl reload nginx  #平滑重启</span><br><span class="line"></span><br><span class="line">4.配置域名解析</span><br><span class="line">Windows: C:\WINDOWS\System32\drivers\etc</span><br><span class="line">                10.0.0.7        game.oldboy.com</span><br><span class="line"></span><br><span class="line">Mac  sudo   vim /etc/hosts</span><br><span class="line">                10.0.0.7        game.oldboy.com</span><br><span class="line"></span><br><span class="line">nginx虚拟主机</span><br><span class="line">Nginx配置虚拟主机有如下三种方式：</span><br><span class="line">方式一、基于主机多IP方式</span><br><span class="line">1.配置多网卡多IP的方式</span><br><span class="line">[root@web01 conf.d]# cat ip.conf </span><br><span class="line">server &#123;</span><br><span class="line">    listen 192.168.160.142:80;</span><br><span class="line">    server_name _;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">       root /code_ip_eth0;</span><br><span class="line">       index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 192.168.160.141:80;</span><br><span class="line">    server_name _;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">       root /code_ip_eth1;</span><br><span class="line">       index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">2.根据配置创建目录</span><br><span class="line">[root@web01 conf.d]# mkdir /code_ip_eth0</span><br><span class="line">[root@web01 conf.d]# echo &quot;Eth1&quot; &gt; /code_ip_eth0/index.html</span><br><span class="line">[root@web01 conf.d]# mkdir /code_ip_eth1</span><br><span class="line">[root@web01 conf.d]# echo &quot;Eth1&quot; &gt; /code_ip_eth1/index.html</span><br><span class="line"></span><br><span class="line">3.重启nginx服务</span><br><span class="line">[root@web01 conf.d]# systemctl restart nginx</span><br><span class="line"></span><br><span class="line">4.使用curl命令测试</span><br><span class="line">[root@web01 conf.d]# curl 192.168.160.141</span><br><span class="line">Eth1</span><br><span class="line">[root@web01 conf.d]# curl 192.168.160.142</span><br><span class="line">Eth0</span><br><span class="line"></span><br><span class="line">1.配置单网卡多IP的方式</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">添加一个IP</span></span><br><span class="line">[root@web91 ~]#ip addr add 10.0.0.11/24 dev eth0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">虚拟机配置方案</span></span><br><span class="line">[root@web01 ~]# cat /etc/nginx/conf.d/addr1.conf</span><br><span class="line">server &#123;</span><br><span class="line">    ...</span><br><span class="line">    listen 10.0.0.10:80;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">[root@web01 ~]# cat /etc/nginx/conf.d/addr2.conf</span><br><span class="line">server &#123;</span><br><span class="line">    ...</span><br><span class="line">    listen 10.0.0.11:80;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">方式二、基于端口的配置方式（一般企业内部使用）</span><br><span class="line">1.配置多端口的虚拟主机</span><br><span class="line">[root@web01 conf.d]# vim port.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 81;</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">      root /code_81;</span><br><span class="line">      index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 82;</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">      root /code_82;</span><br><span class="line">      index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">2.根据配置文件创建所需的目录</span><br><span class="line">[root@web01 conf.d]# mkdir /code_8&#123;1..2&#125;</span><br><span class="line">[root@web01 conf.d]# echo &quot;81&quot; &gt; /code_81/index.html</span><br><span class="line">[root@web01 conf.d]# echo &quot;82&quot; &gt; /code_82/index.html</span><br><span class="line"></span><br><span class="line">3.检查语法并重启服务</span><br><span class="line">[root@web01 conf.d]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@web01 conf.d]# systemctl restart nginx</span><br><span class="line"></span><br><span class="line">4.如何去访问</span><br><span class="line">http://192.168.160.141:81/</span><br><span class="line">http://192.168.160.141:82/</span><br><span class="line"></span><br><span class="line">方式三、基于多个hosts名称方式（多域名方式）</span><br><span class="line">1.准备多虚拟主机配置文件</span><br><span class="line">[root@web01 conf.d]# vim test1.oldboy.com.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test1.oldboy.com;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code/test1;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@web01 conf.d]# cp test1.oldboy.com.conf  test2.oldboy.com.conf </span><br><span class="line">[root@web01 conf.d]# vim test2.oldboy.com.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test2.oldboy.com;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code/test2;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">2.根据配置文件创建对应的目录</span><br><span class="line">[root@web01 conf.d]# mkdir /code/test&#123;1..2&#125; -p</span><br><span class="line">[root@web01 conf.d]# echo &quot;test1_server&quot; &gt; /code/test1/index.html</span><br><span class="line">[root@web01 conf.d]# echo &quot;test2_server&quot; &gt; /code/test2/index.html</span><br><span class="line">[root@web01 conf.d]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@web01 conf.d]# systemctl restart nginx</span><br><span class="line"></span><br><span class="line">3.配置域名解析</span><br><span class="line">192.168.160.141  test1.oldboy.com</span><br><span class="line">192.168.160.141  test2.oldboy.com</span><br><span class="line"></span><br><span class="line">4.通过浏览器访问该网站</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">nginx自查</span><br><span class="line">1.修改完配置记得使用 nginx -t 检查语法</span><br><span class="line">2.如果没有检查语法，直接重载导致报错。systemctl status nginx -l 查看错误信息</span><br><span class="line"></span><br><span class="line">nginx日志</span><br><span class="line">    访问日志：</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name code.oldboy.com;</span><br><span class="line">    </span><br><span class="line">    #将当前的server网站的访问日志记录至应的目录，使用main格式</span><br><span class="line">    access_log /var/log/nginx/code.oldboy.com.log main;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    #当有人请求改favicon.ico时，不记录日志</span><br><span class="line">    location /favicon.ico &#123;</span><br><span class="line">        access_log off;</span><br><span class="line">        return 200;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">错误日志</span><br><span class="line">    tail -f /var/log/nginx/error.log</span><br><span class="line"></span><br><span class="line">6.日志切割logrotate</span><br><span class="line">[root@nginx conf.d]# cat /etc/logrotate.d/nginx</span><br><span class="line">/var/log/nginx/*.log &#123;</span><br><span class="line">    daily  #每天切割日志</span><br><span class="line">    missingok  #日志丢失忽略</span><br><span class="line">    rotate 52  #日志保留52天</span><br><span class="line">    compress  #日志文件压缩</span><br><span class="line">    delaycompress  #延迟压缩日志</span><br><span class="line">    notifempty  #不切割空文件</span><br><span class="line">    create 640 nginx adm  #日志文件权限</span><br><span class="line">    sharedscripts</span><br><span class="line">    postrotate  #切割日志执行的命令</span><br><span class="line">        if [ -f /var/run/nginx.pid ]; then</span><br><span class="line">            kill -USR1 &#x27;cat /var/run/nginx.pid</span><br><span class="line">        fi</span><br><span class="line">        endscript</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">7.日志切割后的效果</span><br><span class="line">[root@web01 ~]# ll /var/log/nginx/</span><br><span class="line">总用量 252</span><br><span class="line">-rw-r-----  1 nginx adm    1001 3月   8 08:37 access.log</span><br><span class="line">-rw-r-----. 1 nginx adm  107273 3月   7 15:01 access.log-20220308</span><br><span class="line">-rw-r-----  1 nginx adm    2106 3月   8 13:26 error.log</span><br><span class="line">-rw-r-----. 1 nginx adm  132534 3月   8 03:29 error.log-20220308</span><br><span class="line">-rw-r--r--  1 root  root   2395 3月   8 13:26 test1.log</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647566845876.png" alt="img"></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647566850421.png" alt="img"></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647566854958.png" alt="img"></p>
<p><strong>3.Nginx默认配置</strong></p>
<p>Nginx主配置文件&#x2F;etc&#x2F;nginx&#x2F;nginx.conf是一个纯文本类型的文件，整个配置文件是以区块的形式组织的。</p>
<p>一般，每个区块以一对大括号{}来表示开始与结束。</p>
<p>Nginx主配置文件整体分为三块进行学习，分别是CoreModule(核心模块），EventModule(事件驱动模块)，HttpCoreModule(http内核模块)</p>
<p>CoreModule 核心模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user www;    #Nginx进程所使用的用户</span><br><span class="line">worker_processes 1;    #Nginx运行的work进程数量（建议与CPU数量一致或auto)</span><br><span class="line">error_log/log/nginx/error.log    #Nginx错误日志存放路径</span><br><span class="line">pid /var/run/nginx.pid    #Nginx服务运行后产生的pid进程号</span><br></pre></td></tr></table></figure>



<p>events事件模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">    worker_connections 25535;    #每个worker进程支持的最大连接数</span><br><span class="line">    use epoll;    #事件驱动模型，epoll默认</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>http 内核模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">http&#123;    #http层开始</span><br><span class="line">...</span><br><span class="line">    #使用server配置网站，每个Server(&#125;代表一个网站（简称虚拟主机)</span><br><span class="line">    &#x27;server&#x27;&#123;</span><br><span class="line">    listen 80;    #监听端口，默认80</span><br><span class="line">    server_name bgx.com;#提供的域名</span><br><span class="line">    access_log access.log;#该网站的访问日志</span><br><span class="line">    #控制网站访问路径</span><br><span class="line">    &#x27;location&#x27; / &#123;</span><br><span class="line">    root /usr/share/nginx/html;  #存放网站源代码的位置</span><br><span class="line">    index index.html index.htm;  #默认返回网站的文件</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第二个虚拟主机配置</span></span><br><span class="line">    &#x27;server&#x27;&#123;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">include/etc/nginx/conf.d/*.conf;  #包含/etc/nginx/conf.d/目录下所有以.conf结尾的文件</span><br><span class="line"></span><br><span class="line">&#125;  #http层结束</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>http server location扩展了解项</strong></p>
<p>http{} 分层下允许有多个Server{}个层，一个Server{}层下又允许有多个Location</p>
<p>http{} 个标签主要用来解决用户的请求与响应。</p>
<p>server{} 标签主要用来响应具体的某一个网站。</p>
<p>location{} 标签主要用于匹配网站具体URL路径。</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647566857455.png" alt="img"></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647566858797.png" alt="img"></p>
<p><strong>6.Nginx日志管理</strong></p>
<p>Nginx有非常灵活的日志记录模式，每个级别的配置可以有各自独立的访问日志。日志格式通过log_format命令定义格式。</p>
<p><strong>1.log_format定义日志格式语法</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置语法：包括：error.log access.log</span></span><br><span class="line">Syntax: log_format name [escape=default|json] string ...;</span><br><span class="line">Default: log_format combined &quot;...&quot;;</span><br><span class="line">Context: http</span><br></pre></td></tr></table></figure>

<p><strong>2.默认Nginx定义语法格式如下</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">log_format main &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                 &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                 &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br></pre></td></tr></table></figure>

<p><strong>3.Nginx 日志格式允许包含的内置变量</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$</span><span class="language-bash">remote_addr  <span class="comment">#记录客户端IP地址</span></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">remote_user  <span class="comment">#记录客户端用户名</span></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">time_local  <span class="comment">#记录通用的本地时间</span></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">time_iso8601  <span class="comment">#记录IS08601标准格式下的本地时间</span></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">request  <span class="comment">#记录请求的方法以及请求的http协议</span></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">status  <span class="comment">#记录请求状态码（用于定位错误信息）</span></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">body_bytes_sent  <span class="comment">#发送给客户端的资源字节数，不包括响应头的大小</span></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">bytes_sent  <span class="comment">#发送给客户端的总字节数</span></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">msec  <span class="comment">#日志写入时间。单位为秒，精度是毫秒。</span></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">http_referer  <span class="comment">#记录从哪个页面链接访问过来的</span></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">http_user_agent  <span class="comment">#记录客户端浏览器相关信息</span></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">http_X_forwarded_for  <span class="comment">#记录客户端IP地址</span></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">request_length  <span class="comment">#请求的长度（包括请求行，请求头和请求正文）。</span></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">request_time  <span class="comment">#请求花费的时间，单位为秒，精度毫秒</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注：如果Nginx位于负载均衡器，nginx反向代理之后，web服务器无法直接获取到客户端真实的IP地址。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="variable">$remote_addr</span>获取的是反向代理的IP地址。反向代理服务器在转发请求的http头信息中，</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">增加X-Forwarded-For信息，用来记录客户端IP地址和客户端请求的服务器地址。</span></span><br></pre></td></tr></table></figure>

<p><strong>4. access_log 日志配置语法</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax: access_log path [format [buffer=size] [gzip[=level]] [flush=time] [if=condition]];</span><br><span class="line">access_log off;</span><br><span class="line">Default: access_log logs/access.log combined;</span><br><span class="line">Context: http, server, location, if in location, limit_except</span><br></pre></td></tr></table></figure>

<p><strong>5.Nginx Access 日志配置实践</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name code.oldboy.com;</span><br><span class="line">    </span><br><span class="line">    #将当前的server网站的访问日志记录至应的目录，使用main格式</span><br><span class="line">    access_log /var/log/nginx/code.oldboy.com.log main;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    #当有人请求改favicon.ico时，不记录日志</span><br><span class="line">    location /favicon.ico &#123;</span><br><span class="line">        access_log off;</span><br><span class="line">        return 200;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>6.日志切割logrotate</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx conf.d]# cat /etc/logrotate.d/nginx</span><br><span class="line">/var/log/nginx/*.log &#123;</span><br><span class="line">    daily  #每天切割日志</span><br><span class="line">    missingok  #日志丢失忽略</span><br><span class="line">    rotate 52  #日志保留52天</span><br><span class="line">    compress  #日志文件压缩</span><br><span class="line">    delaycompress  #延迟压缩日志</span><br><span class="line">    notifempty  #不切割空文件</span><br><span class="line">    create 640 nginx adm  #日志文件权限</span><br><span class="line">    sharedscripts</span><br><span class="line">    postrotate  #切割日志执行的命令</span><br><span class="line">        if [ -f /var/run/nginx.pid ]; then</span><br><span class="line">            kill -USR1 &#x27;cat /var/run/nginx.pid</span><br><span class="line">        fi</span><br><span class="line">        endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>7.日志切割后的效果</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]# ll /var/log/nginx/</span><br><span class="line">总用量 252</span><br><span class="line">-rw-r-----  1 nginx adm    1001 3月   8 08:37 access.log</span><br><span class="line">-rw-r-----. 1 nginx adm  107273 3月   7 15:01 access.log-20220308</span><br><span class="line">-rw-r-----  1 nginx adm    2106 3月   8 13:26 error.log</span><br><span class="line">-rw-r-----. 1 nginx adm  132534 3月   8 03:29 error.log-20220308</span><br><span class="line">-rw-r--r--  1 root  root   2395 3月   8 13:26 test1.log</span><br></pre></td></tr></table></figure>

<p>nginx</p>
<p>安装</p>
<p>yum</p>
<p>编译</p>
<p>配置</p>
<p>目录结构</p>
<p>配置文件</p>
<p>核心层</p>
<p>事件层</p>
<p>http层</p>
<p>启动</p>
<p>启动与停止两种方</p>
<p>nginx</p>
<p>systemctl</p>
<p>搭建静态游戏网页</p>
<p>nginx虚拟主机</p>
<p>多IP的虚拟主机</p>
<p>多端口虚拟主机</p>
<p>多域名虚拟主机</p>
<p>nginx排错（服务无法启动时需要使用到的命令）</p>
<p>nginx -t</p>
<p>systemctl status nginx -l</p>
<p>nginx日志（网站访问异常，需要提取日志进行分析）</p>
<p>log_format 定义日志变量</p>
<p>access_log 定义</p>
<p>access_log off</p>
<p>日志的作用域</p>
<p>errror_log</p>
<h2 id="day32-nginxmodule"><a href="#day32-nginxmodule" class="headerlink" title="day32-nginxmodule"></a><strong>day32-nginxmodule</strong></h2><p><strong>nfs</strong></p>
<p><strong>sersync</strong></p>
<p><strong>ssh</strong></p>
<p><strong>http</strong></p>
<p><strong>nginx</strong></p>
<p><strong>nginx  模块</strong></p>
<p><strong>lnmp  架构  wordpress  wecenter  edusoho</strong></p>
<p><strong>lnmp  拆分  数据库  存储</strong></p>
<p><strong>nginx  代理 负载均衡</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">1.目录索引</span><br><span class="line">[root@web01 module]# cat /etc/nginx/conf.d/autoindex.conf </span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name module.oldboy.com;</span><br><span class="line">  charset utf-8,gbk;</span><br><span class="line">  </span><br><span class="line">  location / &#123;</span><br><span class="line">    root /module;</span><br><span class="line">    autoindex on;</span><br><span class="line">    autoindex_exact_size off;</span><br><span class="line">    autoindex_localtime on;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">2.准备对应的目录，往目录中上传一点文件</span><br><span class="line">mkdir /module/&#123;centos,ubuntu,redhat&#125;/ -p</span><br><span class="line"></span><br><span class="line">3.检查语法并重新加载Nginx</span><br><span class="line">  nginx -t</span><br><span class="line">  systemctl restart nginx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第二种使用方式</span></span><br><span class="line">module.oldboy.com/download</span><br><span class="line"></span><br><span class="line">[root@web01 module]# cat /etc/nginx/conf.d/autoindex.conf </span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name module.oldboy.com;</span><br><span class="line">  charset utf-8,gbk;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    root /code;</span><br><span class="line">    index index.html index.htm;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  location /download &#123;</span><br><span class="line">    root /module;</span><br><span class="line">    autoindex on;</span><br><span class="line">    autoindex_exact_size off;</span><br><span class="line">    autoindex_localtime on;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nginx状态页面</span><br><span class="line">Active connections: 3 </span><br><span class="line">server accepts handled requests</span><br><span class="line">         4        4       4 </span><br><span class="line">Reading: 0 Writing: 1 Waiting: 2 </span><br><span class="line"></span><br><span class="line">Active connections  #当前活动客户端连接数，包括Waiting等待连接数。</span><br><span class="line">accepts  #已接受总的TCP连接数。</span><br><span class="line">handled  #已处理总的TCP连接数。</span><br><span class="line">requests  #客户端总的http请求数。</span><br><span class="line"></span><br><span class="line">Reading  #当前nginx读取请求头的连接数。</span><br><span class="line">Writing  #当前nginx将响应写回客户端的连接数。</span><br><span class="line">Waiting  #当前等待请求的空闲客户端连接数。</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意，一次TCP的连接，可以发起多次http的请求，如下参数可配置进行验证</span></span><br><span class="line">keepalive_timeout 0;  #类似于关闭长连接</span><br><span class="line">keepalive_timeout 65;  #65s没有活动则断开连接</span><br><span class="line"></span><br><span class="line">访问控制</span><br><span class="line">  基于来源的IP地址做限制</span><br><span class="line">  1.拒绝192.168.160.1来源IP访问，其他人允许。</span><br><span class="line">    location /nginx_status &#123;</span><br><span class="line">        stub_status;</span><br><span class="line">        deny 192.168.160.1/32;</span><br><span class="line">        allow all;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  2.允许192.168.160.1来源IP访问，其他人全部拒绝。</span><br><span class="line">    location /nginx_status &#123;</span><br><span class="line">        stub_status;</span><br><span class="line">        allow 192.168.160.1/32;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  3.实际配置监控Nginx状态时，仅允许该服务器的回环地址访问</span><br><span class="line">    location /nginx_status &#123;</span><br><span class="line">        stub_status;</span><br><span class="line">        allow 127.0.0.1;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">基于用户密码的身份验证</span><br><span class="line">  1.生成一个密码文件，密码文件的格式 name:password(加密）（建议使用htpasswd) openssl password</span><br><span class="line">  yum provides htpasswd 查询命令来源哪个包</span><br><span class="line">  [root@web01 module]# yum install httpd-tools -y</span><br><span class="line">  [root@web01 module]# htpasswd -c -b /etc/nginx/auth_conf oldboy oldboy</span><br><span class="line">  Adding password for user oldboy</span><br><span class="line">  [root@web01 module]# cat /etc/nginx/auth_conf </span><br><span class="line">  oldboy:$apr1$1P27vqfg$ATe2Au11Jdbw/6OsfqiJU.</span><br><span class="line">  </span><br><span class="line">  2.配置Nginx，限制对应的资源</span><br><span class="line">  location /download &#123;</span><br><span class="line">    root /module;</span><br><span class="line">    autoindex on;</span><br><span class="line">    autoindex_exact_size off;</span><br><span class="line">    autoindex_localtime on;</span><br><span class="line">    auth_basic &quot;Please Password!!!&quot;;</span><br><span class="line">    auth_basic_user_file /etc/nginx/auth_conf;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>1.Nginx目录索引</strong></p>
<p>ngx_http_autoindex_module模块处理以斜杠字符(‘&#x2F;‘)结尾的请求,并生成目录列表。</p>
<p>当ngx_http_index_nule模块找不到索引文件时，通常会将请求传递给模块。</p>
<p>1.指令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启用或禁用目录列表输出，on开启，off关闭。</span></span><br><span class="line">Syntax: autoindex on | off;</span><br><span class="line">Default:  autoindex off;</span><br><span class="line">Context:  http, server, location</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">指定是否应在目录列表中输出确切的文件大小，on显示字节，off显示大概单位。</span></span><br><span class="line">Syntax: autoindex_exact_size on | off;</span><br><span class="line">Default:  autoindex_exact_size on;</span><br><span class="line">Context:  http, server, location</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">指定目录列表中的时间是应以本地时区还是UTC输出。on本地时区，off UTC时间。</span></span><br><span class="line">Syntax: autoindex_localtime on | off;</span><br><span class="line">Default: autoindex_localtime off;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>

<p><strong>2.Nginx状态监控</strong></p>
<p>ngx_http_stub_status_module模块提供对基本状态信息的访问。</p>
<p>默认情况下不构建此模块，应使用–with-http_stub_status_module 配置参数启用它。</p>
<p>1.指令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: stub_status; </span><br><span class="line">Default: - </span><br><span class="line">Context: server, location</span><br></pre></td></tr></table></figure>

<p>3.此配置创建一个简单的网页，其基本状态数据可能如下所示：</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647566865278.png" alt="img"></p>
<p>4.提供以下状态信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Active connections  #当前活动客户端连接数，包括Waiting等待连接数。</span><br><span class="line">accepts  #已接受总的TCP连接数。</span><br><span class="line">handled  #已处理总的TCP连接数。</span><br><span class="line">requests  #客户端总的http请求数。</span><br><span class="line"></span><br><span class="line">Reading  #当前nginx读取请求头的连接数。</span><br><span class="line">Writing  #当前nginx将响应写回客户端的连接数。</span><br><span class="line">Waiting  #当前等待请求的空闲客户端连接数。</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意，一次TCP的连接，可以发起多次http的请求，如下参数可配置进行验证</span></span><br><span class="line">keepalive_timeout 0;  #类似于关闭长连接</span><br><span class="line">keepalive_timeout 65;  #65s没有活动则断开连接</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.Nginx访问控制</p>
<p>ngx_http_access_module模块允许限制对某些客户端地址的访问。</p>
<p>1.指令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">允许配置语法</span></span><br><span class="line">Syntax: allow address | CIDR | unix: | all;</span><br><span class="line">Default: -</span><br><span class="line">Context: http, server, location, limit_except</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">拒绝配置语法</span></span><br><span class="line">Syntax: deny address | CIDR | unix: | all;</span><br><span class="line">Default: -</span><br><span class="line">Context: http, server, location, limit_except</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.示例配置，拒绝指定的P访问该网站的&#x2F;nginx_status，其他IP全部允许访问</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@web ~]# cat /etc/nginx/conf.d/module.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name module.bgx.com;</span><br><span class="line">    </span><br><span class="line">    location /nginx_status &#123;</span><br><span class="line">        stub_status;</span><br><span class="line">        deny 10.0.0.1/32;  #拒绝指定的地址或地址段</span><br><span class="line">        allow all;  #允许所有的地址</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>4.Nginx访问限制</strong></p>
<p>经常会遇到这种情况，服务器流量异常，负载过大等等。对于大流量恶意的攻击访问，会带来带宽的浪费，服务器压力，影响业务，往往考虑对同一个ip的连接数，请求数、进行限制。</p>
<p>ngx_http_limit_conn_module模块用于限制定义key的连接数，特别是来自单个IP地址的连接数。</p>
<p>并非所有连接都被计算在内，仅当连接已经读取了整个请求头时才计算连接。</p>
<p>1.指令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Syntax: limit_conn_zone key zone=name:size;</span><br><span class="line">Default: -</span><br><span class="line">Context: http</span><br><span class="line">Syntax: limit_conn zone number;</span><br><span class="line">Default: -</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>

<p><strong>nginx连接限制</strong></p>
<p>2.设置共享内存区域和给定键值的最大允许连接数。超过此限制时，服务器将返回错误以回复请求</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">http标签段定义连接限制</span></span><br><span class="line">http&#123;&#125;</span><br><span class="line">    limit_conn_zone $binary_remote_addr zone=conn_zone:10m;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    #同一时刻只允许一个客户端连接</span><br><span class="line">    limit_conn conn_zone 1;</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>3）.使用ab工具进行压力测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@xuliangwei ~]# yum install -y httpd-tools</span><br><span class="line">[root@xuliangwei ~]# ab -n 20 -c 2 http://127.0.0.1/index.html</span><br></pre></td></tr></table></figure>

<p>4). nginx日志结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2022/03/08 21:13:48 [error] 8445#8445: *7 limiting requests, excess: 5.280 by zone &quot;req_zone&quot;, client: 192.168.160.1, server: test1.oldboy.com, request: &quot;GET / HTTP/1.1&quot;, host: &quot;test1.oldboy.com&quot;</span><br><span class="line">2022/03/08 21:13:48 [error] 8445#8445: *7 limiting requests, excess: 5.258 by zone &quot;req_zone&quot;, client: 192.168.160.1, server: test1.oldboy.com, request: &quot;GET /favicon.ico HTTP/1.1&quot;, host: &quot;test1.oldboy.com&quot;, referrer: &quot;http://test1.oldboy.com/&quot;</span><br></pre></td></tr></table></figure>

<p>1.指令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">模块名ngx_http_limit_req_module</span></span><br><span class="line">Syntax: limit_req_zone key zone=name:size rate=rate;</span><br><span class="line">Default: -</span><br><span class="line">Context: http</span><br><span class="line"></span><br><span class="line">Syntax: limit_req zoney number [burst=number] [nodelay];</span><br><span class="line">Default: -</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>

<p><strong>2.设置共享内存区域和请求的最大突发大小。过多的请求被延迟，直到它们的数量超过最大突发大小，在这种情况下请求以错误终止。默认情况下，最大突发大小等于零。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">http标签段定义请求限制，rate限制速率，限制一秒钟最多一个IP请求</span></span><br><span class="line">http &#123;</span><br><span class="line">    limit_req_zone $binary_remote_addr zone=req_zone:10m rate=1r/s;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name module.bgx.com;</span><br><span class="line">    #1r/s只接收一个请求，其余请求拒绝处理并返回错误码给客户端</span><br><span class="line">    #limit_req zone=req_zone;</span><br><span class="line">    </span><br><span class="line">    #请求超过1r/s，剩下的将被延迟处理，请求数超过burst定义的数量，多余的请求返回503</span><br><span class="line">    limit_req zone=req_zone burst=3 nodelay;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">1.定义限制的key（基于什么来做限制，IP地址）</span><br><span class="line">[root@web01 conf.d]# cat test1.oldboy.com.conf </span><br><span class="line">limit_req_zone $binary_remote_addr zone=req_zone:10m rate=1r/s; #定义限制</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test1.oldboy.com;</span><br><span class="line">    access_log /var/log/nginx/test1.log main;</span><br><span class="line">    limit_req zone=req_zone burst=5 nodelay;  # burst=5延迟处理5个请求 nodelay其它全部拒绝</span><br><span class="line">    limit_req_status 412;  #定义返回状态码412</span><br><span class="line">    error_page 412 /err.html; #定义412 返回的页面  这个文件必须存在/code/test/err.html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code/test1;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">2.填写hosts域名解析</span><br><span class="line">[root@web01 conf.d]# echo &quot;192.168.160.145 test1.oldboy.com&quot; &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line">3.进行简单的压力测试</span><br><span class="line">[root@web01 conf.d]# ab -n 50 -c 20 http://test1.oldboy.com/index.html</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>Nginx连接限制没有请求限制有效？</strong></p>
<p>我们先来回顾一下http协议的连接与请求，首先HTTP是建立在TCP基础之上，在完成HTTP请求需要先建立TCP三次握手（称为TCP连接），在连接的基础上在完成HTTP的请求。</p>
<p>所以多个HTTP请求可以建立在一次TCP连接之上，那么我们对请求的精度限制，当然比对一个连接的限制会更加的有效，因为同一时刻只允许一个TCP连接进入，但是同一时刻多个HTTP请求可以通过一个TCP连接进入。所以针对HTTP的请求限制才是比较优的解决方案。</p>
<p><strong>6.Nginx Location</strong></p>
<p><strong>使用Nginx Location 可以控制访问网站的路径,但一个server 可以有多个location 配置，多个location的优先级该如何区分</strong></p>
<p><strong>1.Location 语法示例</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">location [=|^~|~|~*|!~|!~*|/] /uri/ &#123; ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">匹配符   匹配规则                  优先级</span><br><span class="line">=        精确匹配                   1</span><br><span class="line">^~       以某个字符串开头            2</span><br><span class="line">~        区分大小写的正则匹配        3</span><br><span class="line">~*       不区分大小写的正则匹配       4</span><br><span class="line">!~       区分大小写不匹配的正则       5</span><br><span class="line">!~*     不区分大小写不匹配的正则      6</span><br><span class="line">/       通用匹配，任何请求都会匹配到   7</span><br></pre></td></tr></table></figure>

<p>2.Location语法优先级排列</p>
<table>
<thead>
<tr>
<th><strong>匹配符</strong></th>
<th><strong>匹配规则</strong></th>
<th><strong>优先级</strong></th>
</tr>
</thead>
<tbody><tr>
<td>&#x3D;</td>
<td>精确匹配</td>
<td>1</td>
</tr>
<tr>
<td>^~</td>
<td>以某个字符串开头</td>
<td>2</td>
</tr>
<tr>
<td>~</td>
<td>区分大小写的正则匹配</td>
<td>3</td>
</tr>
<tr>
<td>~*</td>
<td>不区分大小写的正则匹配</td>
<td>4</td>
</tr>
<tr>
<td>!~</td>
<td>区分大小写不匹配的正则</td>
<td>5</td>
</tr>
<tr>
<td>!~*</td>
<td>不区分大小写不匹配的正则</td>
<td>6</td>
</tr>
<tr>
<td>&#x2F;</td>
<td>通用匹配，任何请求都会匹配到</td>
<td>7</td>
</tr>
</tbody></table>
<p><strong>3.配置网站验证Location优先级</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx conf.d]# cat testserver.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name bgx.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        default_type text/html;</span><br><span class="line">        return 200 &quot;location /&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    location =/ &#123;</span><br><span class="line">        default_type text/html;</span><br><span class="line">        return 200 &quot;lowation =/&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    location / &#123;</span><br><span class="line">        defa type text/html;</span><br><span class="line">        return 200 &quot;location ~/&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">location ^~ / &#123;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   default_type text/html;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   <span class="built_in">return</span> 200 <span class="string">&quot;location ^~&quot;</span>;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4.测试 Location效果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">优先级最高符号=</span></span><br><span class="line">[root@Nginx conf.d]# curl bgx.com</span><br><span class="line">location =/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注释掉精确匹配=，重后Nginx</span></span><br><span class="line">[root@Nginx ~]# curl bgx.com</span><br><span class="line">location ~/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注释掉~，重启Nginx</span></span><br><span class="line">[root@Nginx ~]# curl bgx.com</span><br><span class="line">location /</span><br></pre></td></tr></table></figure>

<p>5.Locaiton应用场景</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">通用匹配，任何请求都会匹配到</span></span><br><span class="line">location / &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">严格区分大小写，四配以.php结尾的都走这个location</span></span><br><span class="line">location ~ \.php$ &#123;</span><br><span class="line">       ... </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">严格区分大小写，匹配以.jsp结属的都走这个location</span></span><br><span class="line">location ~ \.jsp$ &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">不区分大小写匹配，只要用户访问.jpg,gij,png,js,css 都走这条location</span></span><br><span class="line">location ~* .*\.(jpg|gif|png|js|css)$ &#123;</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">不区分大小写匹配</span></span><br><span class="line">location ~* &quot;\.(sql|bak|tgz|tar.gz|.git)$&quot; &#123;</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nginx目录索引 --&gt;autoindex</span><br><span class="line">    资源下载</span><br><span class="line">    本地yum仓库</span><br><span class="line">nginx状态模块 --&gt;stub_status</span><br><span class="line">    --with_http_stub_status</span><br><span class="line">    活跃连接</span><br><span class="line">    keepalive_time</span><br><span class="line">nginx访问控制</span><br><span class="line">    基于来源的IP地址限制  → allow deny</span><br><span class="line">    基于用户名和密码限制  → basic_auth</span><br><span class="line">nginx访问限制</span><br><span class="line">    连接  limit_conn</span><br><span class="line">    请求  limit_req</span><br><span class="line">nginx location</span><br><span class="line">    优先级</span><br><span class="line">    语法示例</span><br></pre></td></tr></table></figure>

<h2 id="day31-lnmp-P388"><a href="#day31-lnmp-P388" class="headerlink" title="day31-lnmp P388"></a><strong>day31-lnmp P388</strong></h2><p>官方模块</p>
<p>autoindex</p>
<p>basic_auth</p>
<p>allow</p>
<p>deny</p>
<p>stub status</p>
<p>limit_conn</p>
<p>limit_req</p>
<p>location</p>
<p>第三方</p>
<p>LNMP wordpress wecenter</p>
<p><strong>1.LNMP架构概述</strong></p>
<p><strong>1.什么是LNMP</strong></p>
<p>LNMP是一套技术的组合，L&#x3D;Linux、N&#x3D;Nginx、M<del>&#x3D;MySQL、P</del>&#x3D;PHP</p>
<p>2.LNMP架构是如何工作的</p>
<p>首先Nginx服务是不能处理动态请求，那么当用户发起动态请求时，Nginx又是如何进行处理的。</p>
<p>当用户发起http请求，请求会被Nginx处理，如果是静态资源请求Nginx则直接返回，如果是动态请求Nginx则通过fastcgi协议转交给后端的PHP程序处理，具体如下图所示</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647566874634.png" alt="img"></p>
<p>3.Nginx与Fast-CGl详细工作流程如下图所示</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\85854642128544febdf18844ebb8bc15.jpg" alt="img"></p>
<p>1.用户通过http协议发起请求，请求会先抵达LNMP架构中的Nginx</p>
<p>2.Nginx会根据用户的请求进行Location规则匹配</p>
<p>3.Location如果匹配到请求是静态，则由Nginx读取本地直接返回</p>
<p>4.Location如果匹配到请求是动态，则由Nginx将请求转发给fastcgi协议</p>
<p>5.fastgi收到后会将请求交给php-fpm管理进程，php-fpm管理进程接收到后会调用具体的工作进程warrap</p>
<p>6.warrap进程会调用php程序进行解析，如果只是解析代码，php直接返回</p>
<p>7.如果有查询数据库操作，则由php连接数据库(（用户密码IP）发起查询的操作</p>
<p>8.最终数据由mysql-&gt;php-&gt;php-fpm-&gt;fastcgi-&gt;nginx-&gt;http-&gt;user</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]# cat /etc/yum.repos.d/nginx.repo</span><br><span class="line">[nginx]</span><br><span class="line">name=nginx repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/7/$basearch/</span><br><span class="line">gpgcheck=o</span><br><span class="line">enabled=1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装Nginx</span></span><br><span class="line">[root@nginx ~]# yum install nginx -y</span><br><span class="line"></span><br><span class="line">2.安装php7.1</span><br><span class="line">[root@nginx ~]# yum remove php-mysql-5.4 php php-fpm php-common</span><br><span class="line">[root@nginx ~]# cat /etc/yum.repos.d/php.repo</span><br><span class="line">[php]</span><br><span class="line">name = php Repository</span><br><span class="line">baseurl = http://us-east.repo.webtatic.com/yum/el7/x86_64/</span><br><span class="line">gpgcheck = 0</span><br><span class="line"></span><br><span class="line">[root@nginx ~]# yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb</span><br><span class="line"></span><br><span class="line">3.安装Mariadb数据库</span><br><span class="line">[root@nginx ~]# yum install mariadb-server mariadb -y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4.配置nginx与php集成</span><br><span class="line">[root@web01 conf.d]# cat php.conf </span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name php.oldboy.com;</span><br><span class="line">    root /code;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        index index.php index.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5.重载</span><br><span class="line">[root@web01 conf.d]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@web01 conf.d]# systemctl restart nginx</span><br><span class="line">[root@web01 conf.d]# </span><br><span class="line"></span><br><span class="line">6.启动php-fpm，并加入开机自启</span><br><span class="line">[root@web01 conf.d]# systemctl start php-fpm</span><br><span class="line">[root@web01 conf.d]# systemctl enable php-fpm</span><br><span class="line"></span><br><span class="line">7.准备一个php文件，测试nginx与php是否集成成功</span><br><span class="line">[root@web01 conf.d]# cat /code/page.php </span><br><span class="line">&lt;?php</span><br><span class="line">        phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">8.启动数据库</span><br><span class="line">[root@web01 ~]# systemctl start mariadb</span><br><span class="line">[root@web01 ~]# systemctl enable mariadb</span><br><span class="line">[root@web01 ~]# mysqladmin password &#x27;Bgx123.com&#x27;  #配置密码（默认mysql是空密码）</span><br><span class="line">[root@web01 ~]# mysql -uroot -pBgx123.com  #使用账号和密码登录mysql</span><br><span class="line"></span><br><span class="line">9.准备一个php文件，测试能否正常连接数据库</span><br><span class="line">[root@nginx ~]# cat /code/mysqli.php</span><br><span class="line">    &lt;?php</span><br><span class="line">        $servername = &quot;localhost&quot;;</span><br><span class="line">        $username = &quot;root&quot;;</span><br><span class="line">        $password = &quot;Bgx123.com&quot;;</span><br><span class="line"></span><br><span class="line">        //创建连接</span><br><span class="line">        $conn = mysqli_connect($servername, $username, $password);</span><br><span class="line"></span><br><span class="line">        //检测连接</span><br><span class="line">        if (!$conn) &#123;</span><br><span class="line">            die(&quot;Connection failed: &quot; . mysqli_connect_error());</span><br><span class="line">        &#125;</span><br><span class="line">        echo &quot;php连接MySQL数据库成功&quot;;</span><br><span class="line">        ?&gt;</span><br><span class="line"></span><br><span class="line">10.部署wordpress</span><br><span class="line">[root@web01 conf.d]# cat blog.oldboy.com.conf </span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name blog.oldboy.com;</span><br><span class="line">    root /code/wordpress;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        index index.php index.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">11.根据nginx中定义的内容，创建站点目录并且进行授权</span><br><span class="line">[root@web01 conf.d]# mkdir /code</span><br><span class="line">[root@web01 conf.d]# cd /code</span><br><span class="line">[root@web01 code]# wget https://cn.wordpress.org/latest-zh_CN.tar.gz</span><br><span class="line">[root@web01 code]# tar xf latest-zh_CN.tar.gz</span><br><span class="line"></span><br><span class="line">12.修改nginx与php-fpm的运行用户为www，并授权代码属主和属组都为www</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">注意：如果没有该用户，启动一定会报错</span></span><br><span class="line">[root@web01 code]# groupadd -g 666 www</span><br><span class="line">[root@web01 code]# useradd -u666 -g666 www</span><br><span class="line"></span><br><span class="line">修改nginx与php-fpm管理进程，的运行身份为www</span><br><span class="line">[root@web01 code]# sed -i &#x27;/^user /c user www;&#x27; /etc/nginx/nginx.conf </span><br><span class="line">[root@web01 code]# sed -i &#x27;/^user/c user = www&#x27; /etc/php-fpm.d/www.conf </span><br><span class="line">[root@web01 code]# sed -i &#x27;/^group/c group = www&#x27; /etc/php-fpm.d/www.conf </span><br><span class="line"></span><br><span class="line">一定要重启才生效</span><br><span class="line">[root@web01 code]# systemctl restart nginx</span><br><span class="line">[root@web01 code]# systemctl restart php-fpm</span><br><span class="line"></span><br><span class="line">最后授权代码为www</span><br><span class="line">[root@web01 code]# chown -R www.www /code/wordpress/</span><br><span class="line"></span><br><span class="line">13.创建数据库</span><br><span class="line">MariaDB [(none)]&gt; create database wordpress;  #创建一个库，名称叫wordpress</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; show databases;  #查询该台数据库服务有多少个库</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test               |</span><br><span class="line">| wordpress          |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">14.解决nginx上传文件大小限制</span><br><span class="line">[root@web01 code]# cat /etc/nginx/conf.d/blog.oldboy.com.conf </span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name blog.oldboy.com;</span><br><span class="line">    root /code/wordpress;</span><br><span class="line">    client_max_body_size 100m;  #默认nginx仅支持上传1m大小的文件</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        index index.php index.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@web01 code]# systemctl restart nginx</span><br><span class="line"></span><br><span class="line">wecenter知乎</span><br><span class="line">[root@web01 conf.d]# vim zh.oldboy.com.conf </span><br><span class="line">[root@web01 conf.d]# cat zh.oldboy.com.conf </span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name zh.oldboy.com;</span><br><span class="line">    root /code/zh;</span><br><span class="line">    client_max_body_size 100m;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        index index.php index.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">2.下载软件</span><br><span class="line">[root@web01 code]# rz -E WeCenter_3-2-1-master.zip</span><br><span class="line">[root@web01 code]# unzip WeCenter_3-2-1-master.zip</span><br><span class="line">[root@web01 code]# mv WeCenter_3-2-1-master zh</span><br><span class="line">[root@web01 code]# chown -R www.www zh/</span><br><span class="line">[root@web01 code]# systemctl restart nginx</span><br><span class="line">[root@web01 code]# mysql -uroot -pBgx123.com</span><br><span class="line">MariaDB [(none)]&gt; create database zh;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test               |</span><br><span class="line">| wordpress          |</span><br><span class="line">| zh                 |</span><br><span class="line">+--------------------+</span><br><span class="line">6 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edusoho</span><br><span class="line">1.配置nginx</span><br><span class="line">[root@web01 code]# vim /etc/nginx/conf.d/edu.oldboy.com.conf  # 使用edu.conf配置文件</span><br><span class="line"></span><br><span class="line">2.下载软件，并且授权</span><br><span class="line">[root@web01 code]# wget http://download.edusoho.com/edusoho-8.2.17.tar.gz</span><br><span class="line">[root@web01 code]# tar xf edusoho-8.2.17.tar.gz</span><br><span class="line">[root@web01 code]# chown -R www.www edusoho</span><br><span class="line"></span><br><span class="line">3.调整php的上传大小</span><br><span class="line">[root@web01 code]# vim /etc/php.ini </span><br><span class="line">upload_max_filesize = 2M → 200M</span><br><span class="line">post_max_size = 8M → 200M</span><br><span class="line">[root@web01 code]# systemctl restart php-fpm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">phpmyadmin  https://www.phpmyadmin.net/</span><br><span class="line">zblog  https://www.zblogcn.com/</span><br><span class="line">discuz  算了吧</span><br><span class="line">wordpress  https://cn.wordpress.org/</span><br><span class="line">wecenter  https://wenda.wecenter.com/timeline/</span><br><span class="line">edusohu  https://www.edusoho.com/open/show</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>wget -o &#x2F;etc&#x2F;yum.repos.d&#x2F;epel.repo <a target="_blank" rel="noopener" href="http://mirrors.aliyun.com/repo/epel-7.repo">http://mirrors.aliyun.com/repo/epel-7.repo</a></p>
<p>edu.conf (edusohu)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">edu.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name edu.oldboy.com;</span><br><span class="line">    root /code/edusoho/web;</span><br><span class="line">    client_max_body_size 200m;</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">        index app.php;</span><br><span class="line">        try_files $uri @rewriteapp;</span><br><span class="line">    &#125;</span><br><span class="line">    location @rewriteapp &#123;</span><br><span class="line">        rewrite ^(.*)$ /app.php/$1 last;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    location ~ ^/udisk &#123;</span><br><span class="line">        internal;</span><br><span class="line">        root /code/edusoho/app/data/;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">location ~ ^/(app|app_dev)\.php(/|$) &#123;</span><br><span class="line">    fastcgi_pass  127.0.0.1:9000;</span><br><span class="line">    fastcgi_split_path_info ^(.+\.php)(/.*)$;</span><br><span class="line">    include fastcgi_params;</span><br><span class="line">    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">    fastcgi_param HTTPS  off;</span><br><span class="line">    fastcgi_param HTTP_X-Sendfile-Type X-Accel-Redirect;</span><br><span class="line">    fastcgi_param HTTP_X-Accel-Mapping /udisk=/code/edusoho/app/data/udisk;</span><br><span class="line">    fastcgi_buffer_size 128k;</span><br><span class="line">    fastcgi_buffers 8 128k;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置设置图片格式文件</span></span><br><span class="line">location ~* \.(jpg|jpeg|gif|png|ico|swf)$ &#123;</span><br><span class="line">    #过期时间为3年</span><br><span class="line">    expires 3y;</span><br><span class="line">    #关闭日志记录</span><br><span class="line">    access_log off;</span><br><span class="line">    #关闭gzip压缩，减少CPU消耗，因为图片的压缩率不高。</span><br><span class="line">    gzip off;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置css/js文件</span></span><br><span class="line">location ~* \.(css|js)$ &#123;</span><br><span class="line">    access_log off;</span><br><span class="line">    expires 3y;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">禁止用户上传目录下所有.php文件的访问，提高安全性</span></span><br><span class="line">location ~ ^/files/.*\.(php|php5)$ &#123;</span><br><span class="line">    deny all;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">以下配置允许运行，php的程序，方便于其他第三方系统的集成。</span></span><br><span class="line">location ~ \.php$ &#123;</span><br><span class="line">    fastcgi_pass  127.0.0.1:9000;</span><br><span class="line">    fastcgi_split_path_info ^(.+\.php)(/.*)$;</span><br><span class="line">    include fastcgi_params;</span><br><span class="line">    fastcgi_param SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">    fastcgi_param HTTPS  off;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>2.LNMP架构环境部署</strong></p>
<p>1）使用官方仓库安装Nginx</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]# cat /etc/yum.repos.d/nginx.repo</span><br><span class="line">[nginx]</span><br><span class="line">name=nginx repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/7/$basearch/</span><br><span class="line">gpgcheck=o</span><br><span class="line">enabled=1</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装Nginx</span></span><br><span class="line">[root@nginx ~]# yum install nginx -y</span><br></pre></td></tr></table></figure>

<p>2）启动Nginx，并将Nginx加入开机自启</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]# systemctl start nginx </span><br><span class="line">[root@nginx ~]# systemctl enable nginx</span><br></pre></td></tr></table></figure>

<p>3）使用第三方扩展源安装php7.1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm</span></span><br><span class="line"></span><br><span class="line">[root@nginx ~]# yum remove php-mysql-5.4 php php-fpm php-common</span><br><span class="line">[root@nginx ~]# cat /etc/yumIrepos.d/php.repo</span><br><span class="line">[php]</span><br><span class="line">name = php Repository</span><br><span class="line">baseurl = http://us-east.repo.webtatic.com/yum/el7/x86_64/</span><br><span class="line">gpgcheck = 0</span><br><span class="line"></span><br><span class="line">[root@nginx ~]# yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3）配置php-fpm用户与Nginx的运行用户保持一致</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]# sed -i &#x27;/^user/c user =www&#x27; /etc/php-fpm.d/www.conf </span><br><span class="line">[root@nginx ~]# sed -i &#x27;/^group/c group = www&#x27; /etc/php-fpm.d/www.conf</span><br></pre></td></tr></table></figure>

<p>4）启动php-fpm，并将其加入开机自启</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]# systemctl start php-fpm </span><br><span class="line">[root@nginx ~]# systemctl enable php-fpm</span><br></pre></td></tr></table></figure>

<p>5)安装Mariadb数据库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]# yum install mariadb-server mariadb -y</span><br></pre></td></tr></table></figure>

<p>6)启动Mariadb数据库,并加入开机自动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]# systemctl start mariadb </span><br><span class="line">[root@nginx ~]# systemctl enable mariadb</span><br></pre></td></tr></table></figure>

<p>7）给Mariadb配置登陆密码，并是新密码进行登录数据库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]# mysqladmin password &#x27;Bgx123.com&#x27; </span><br><span class="line">[root@nginx ～]# mysql -uroot -pBgx123.com</span><br></pre></td></tr></table></figure>

<p><strong>2.LNMP架构环境配置</strong></p>
<p>在将Nginx与PHP集成过程中，需要先了解Fastcgi代理配置语法</p>
<p>1.设置fastcgi服务器的地址，该地址可以指定为域名或P地址，以及端口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Syntax: fastcgi_pass address;</span><br><span class="line">Default: -</span><br><span class="line">Context: location, if in location</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">语法示例</span></span><br><span class="line">fastcgi_pass localhost:9000;</span><br><span class="line">fastcgi_pass unix:/tmp/fastcgi.socket;</span><br></pre></td></tr></table></figure>

<p>2.设置fastcgi默认的首页文件，需要结合fastcgi_param一起设置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: fastcgi_index name;</span><br><span class="line">Default: -</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>

<p>3.通过fastcgi_param设置变量，并将设置的变量传递到后端的fastcgi服务器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Syntax: fastcgi_param parameter value [if_not_empty];</span><br><span class="line">Default: -</span><br><span class="line">Context: http, server, location</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">语法示例</span></span><br><span class="line">fastcgi_index index.php;</span><br><span class="line">fastcgi param SCRIPT FILENAME /code$fastcgi_script_name;</span><br></pre></td></tr></table></figure>

<p>4.通过图形方式展示fastcgi_index与fastcgi_param作用</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647566882690.png" alt="img"></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\b3cb14b3d81b4239b8a88f4f0e82d6d8.jpg" alt="img"></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647566886354.png" alt="img"></p>
<p>5.最终Nginx连接Fastcgi服务器配置如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]# cat /etc/nginx/conf.d/php.conf</span><br><span class="line">server &#123;</span><br><span class="line">    server_name php.oldboy.com;</span><br><span class="line">    listen 80;</span><br><span class="line">    root /code;</span><br><span class="line">    index index.php index.html;</span><br><span class="line">    </span><br><span class="line">    location  ~ \.php$ &#123;</span><br><span class="line">        root /code;</span><br><span class="line">        fastcgi_pass  127.0.0.1:9000;</span><br><span class="line">        fastcgi_index index.php;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">        include  fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>6.在&#x2F;code目录下创建info.php文件，测试能否通过浏览器访问，访问成功如下图</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]# cat /code/info.php</span><br><span class="line">&lt;?php</span><br><span class="line">        phpinfo();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="D:\文件管理\Typora\images\linux.assest\eb00fa9eaad446bcb68d78a5bf69e00a.jpg" alt="img"></p>
<p>8最后通过浏览器访问&#x2F;mysqli.php文件，如成功访问如下图</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647566894307.png" alt="img"></p>
<h2 id="day34-lnmp-拆分-P398"><a href="#day34-lnmp-拆分-P398" class="headerlink" title="day34-lnmp-拆分 P398"></a><strong>day34-lnmp-拆分 P398</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">1.lnmp架构，实现原理？</span><br><span class="line">    blog.oldboy.com/test.png</span><br><span class="line">    blog.oldboy.com/page.php</span><br><span class="line">    </span><br><span class="line">    nginx --&gt; fastcgi --&gt; php-fpm</span><br><span class="line">        fastcgi_pass address:port;</span><br><span class="line">                        10.0.0.8:9000;</span><br><span class="line">                        unix:/tmp/php.socket</span><br><span class="line"></span><br><span class="line">2.如果关闭后端的php则会出现502错误?</span><br><span class="line"></span><br><span class="line">3.nginx+php与apache+php的区别是什么?</span><br><span class="line">nginx是以fastcgi协议调用的php</span><br><span class="line">apache是以模块的方式加载的php</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">wordpress</span><br><span class="line">zblog</span><br><span class="line">phpmyadmin</span><br><span class="line">edusoho</span><br><span class="line">wecenter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">拆分数据库</span><br><span class="line">4.数据库拆分环境规划</span><br><span class="line">主机名称  应用环境   外网地址   内网地址</span><br><span class="line">web01    nginx+php  10.0.0.7  172.16.1.7</span><br><span class="line">db01     mysql                172.16.1.51</span><br><span class="line"></span><br><span class="line">1.备份192.168.160.149上mysql的数据</span><br><span class="line">root@web01 ~]# mysqldump -uroot -p&#x27;Bgx123.com&#x27; --all-databases --single-transaction &gt; mysql-all.sql</span><br><span class="line"></span><br><span class="line">2.传输192.168.160.149的备份数据至192.168.160.151的服务器上</span><br><span class="line">[root@web01 ~]# scp mysql-all.sql root@192.168.160.151:/tmp</span><br><span class="line"></span><br><span class="line">3.需要先在192.168.160.151服务器上安装mysql服务，然后使用mysql命令进行还原。</span><br><span class="line">[root@localhost ~]# hostnamectl set-hostname db01  #更改主机名</span><br><span class="line">[root@localhost ~]# hostname db01  #更改主机名</span><br><span class="line">[root@db01 ~]# yum install mariadb-server mariadb -y</span><br><span class="line">[root@db01 ~]# systemctl enable mariadb</span><br><span class="line">[root@db01 ~]# systemctl start mariadb</span><br><span class="line">[root@db01 tmp]# mysql &lt;/tmp/mysql-all.sql </span><br><span class="line">[root@db01 tmp]# systemctl restart mariadb</span><br><span class="line">[root@db01 tmp]# mysql</span><br><span class="line">ERROR 1045 (28000): Access denied for user &#x27;root&#x27;@&#x27;localhost&#x27; (using password: NO)</span><br><span class="line">[root@db01 tmp]# mysql -uroot -pBgx123.com</span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| edusoho            |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test               |</span><br><span class="line">| wordpress          |</span><br><span class="line">| zh                 |</span><br><span class="line">+--------------------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">4.将web程序连接的本地数据库修改到远程数据库上。</span><br><span class="line">  1）先在本地192.168.160.149服务器上停止本地的数据库</span><br><span class="line">  [root@web01 ~]# systemctl disable mariadb</span><br><span class="line">  [root@web01 ~]# systemctl stop mariadb</span><br><span class="line">  2）在192.168.160.151的服务器上授权远程主机能够能连接mysql数据库</span><br><span class="line">  [root@db01 tmp]# mysql -uroot -pBgx123.com</span><br><span class="line">  MariaDB [(none)]&gt; grant all privileges on *.* to oldboy@&#x27;%&#x27; identified by &#x27;Bgx123.com&#x27;;</span><br><span class="line"></span><br><span class="line">3）在192.168.160.149服务器上测试远程账户能否连接192.168.160.151的数据库</span><br><span class="line">[root@web01 wordpress]# yum install mariadb -y</span><br><span class="line">[root@web01 wordpress]# mysql -h 192.168.160.151 -uoldboy -pBgx123.com</span><br><span class="line">MariaDB [(none)]&gt; </span><br><span class="line"></span><br><span class="line">4）在172.16.1.7服务器上修改web程序连接数据库的配置文件</span><br><span class="line">[root@web01 wordpress]# vim /code/wordpress/wp-config.php </span><br><span class="line">// ** MySQL 设置 - 具体信息来自您正在使用的主机 ** //</span><br><span class="line">/** WordPress数据库的名称 */</span><br><span class="line">define( &#x27;DB_NAME&#x27;, &#x27;wordpress&#x27; );</span><br><span class="line"></span><br><span class="line">/** MySQL数据库用户名 */</span><br><span class="line">define( &#x27;DB_USER&#x27;, &#x27;oldboy&#x27; );  #root替换成oldboy</span><br><span class="line"></span><br><span class="line">/** MySQL数据库密码 */</span><br><span class="line">define( &#x27;DB_PASSWORD&#x27;, &#x27;Bgx123.com&#x27; );</span><br><span class="line"></span><br><span class="line">/** MySQL主机 */</span><br><span class="line">define( &#x27;DB_HOST&#x27;, &#x27;192.168.160.151&#x27; );   #localhost替换成192.168.160.151</span><br><span class="line"></span><br><span class="line">5.拆分172.16.1.7wecenter连接远程172.16.1.51数据库信息</span><br><span class="line">[root@web01 zh]# grep -R &quot;Bgx123.com&quot; *</span><br><span class="line">system/config/database.php:  &#x27;password&#x27; =&gt; &#x27;Bgx123.com&#x27;,</span><br><span class="line">[root@web01 zh]# vim /code/zh/system/config/database.php</span><br><span class="line"><span class="meta prompt_">  $</span><span class="language-bash">config[<span class="string">&#x27;driver&#x27;</span>] = <span class="string">&#x27;MySQLi&#x27;</span>;^M</span></span><br><span class="line"><span class="meta prompt_">  $</span><span class="language-bash">config[<span class="string">&#x27;master&#x27;</span>] = array (</span></span><br><span class="line">    &#x27;charset&#x27; =&gt; &#x27;utf8&#x27;,</span><br><span class="line">    &#x27;host&#x27; =&gt; &#x27;192.168.160.151&#x27;,</span><br><span class="line">    &#x27;username&#x27; =&gt; &#x27;oldboy&#x27;,</span><br><span class="line">    &#x27;password&#x27; =&gt; &#x27;Bgx123.com&#x27;,</span><br><span class="line">    &#x27;dbname&#x27; =&gt; &#x27;zh&#x27;,</span><br><span class="line">  );^M</span><br><span class="line"></span><br><span class="line">6.拆分172.16.1.7 edusoho连接远程172.16.1.51数据库信息</span><br><span class="line">[root@web01 edusoho]# grep -R &quot;Bgx123.com&quot; *</span><br><span class="line">[root@web01 edusoho]# vim /code/edusoho/app/config/parameters.yml </span><br><span class="line">    database_driver: pdo_mysql</span><br><span class="line">    database_host: 192.168.160.151</span><br><span class="line">    database_port: 3306</span><br><span class="line">    database_name: edusoho</span><br><span class="line">    database_user: oldboy</span><br><span class="line">    database_password: &#x27;Bgx123.com&#x27;</span><br><span class="line">[root@web01 edusoho]# rm -rf /code/edusoho/app/cache/*  #必须清除缓存</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">扩展多台web</span><br><span class="line">  1.统一环境</span><br><span class="line">    0)准备对应的www用户</span><br><span class="line">        [root@web02 ~]# groupadd -g666 www</span><br><span class="line">        [root@web02 ~]# useradd -u666 -g666 www</span><br><span class="line"></span><br><span class="line">    1）安装web01上面的yum仓库</span><br><span class="line">        [root@web02 ~]# scp root@192.168.160.149:/etc/yum.repos.d/* /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line">    2）安装php</span><br><span class="line">        yum -y install nginx php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb</span><br><span class="line">        </span><br><span class="line">  2.统一配置（同步web01上面的配置到web02）</span><br><span class="line">    1)同步nginx</span><br><span class="line">    [root@web02 ~]# scp -rp root@192.168.160.149:/etc/nginx/ /etc/nginx/</span><br><span class="line">    [root@web02 ~]# rsync -avz root@192.168.160.149:/etc/nginx/ /etc/nginx/</span><br><span class="line">    [root@web02 ~]# nginx -t</span><br><span class="line">    [root@web02 ~]# systemctl enable nginx</span><br><span class="line">    [root@web02 ~]# systemctl start nginx</span><br><span class="line">    </span><br><span class="line">    2）同步php（/etc/php-fpm.conf /etc/php-rpm.d /etc/php.ini）</span><br><span class="line">    [root@web02 ~]# rsync -avz --delete root@192.168.160.149:/etc/php* /etc/</span><br><span class="line">    [root@web02 ~]# systemctl enable php-fpm</span><br><span class="line">    [root@web02 ~]# systemctl start php-fpm</span><br><span class="line"></span><br><span class="line">  3.统一代码</span><br><span class="line">      [root@web01 ~]# tar czf code.tar.gz /code  #在web01上打包站点</span><br><span class="line">      [root@web01 ~]# scp code.tar.gz root@192.168.160.159:/tmp  #在web01上将打包好的代码发送给web02</span><br><span class="line">      [root@web02 tmp]# tar xf /tmp/code.tar.gz -C /  #在web02上进行解压，并解压到/目录下</span><br><span class="line">      </span><br><span class="line">  4.配置解析，进行访问</span><br><span class="line">  P401</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>无法访问web站点，排错</p>
<p>systemctl status firewalld  查看firewalld防火墙状态</p>
<p>systemctl stop firewalld 关闭firewalld防火墙</p>
<p>systemctl disable firewalld 关闭开机启动</p>
<p>getenforce 查看SELinux状态</p>
<p>setenforce 0 关闭SELinux</p>
<p>vim &#x2F;etc&#x2F;selinux&#x2F;config </p>
<p>SELINUX&#x3D;permissive   #修改此参数  修改为disable</p>
<p><strong>7.拆分数据库至至独立服务器</strong></p>
<p><strong>1.为什么要进行数据库的拆分</strong></p>
<p>由于单台服务器运行LNMP架构会导致网站访问缓慢，当内存被吃满时，很容易导致系统出现oom，从而kill掉MySQL数据库，所以需要将web和数据库进行独立部署。</p>
<p><strong>2.数据库拆分后解决了什么问题</strong></p>
<p>1.缓解web网站的压力</p>
<p>2.增强数据库读写性能</p>
<p>3.提高用户访问的速度</p>
<p><strong>3.数据库拆分架构演变过程，如下图所示</strong></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\d687245f04b346238cbe26db0d4fddaf.jpg" alt="img"></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\65f8fb2407b94047a1360fa8c3372ba2.jpg" alt="img"></p>
<p><strong>4.数据库拆分环境规划</strong></p>
<table>
<thead>
<tr>
<th><strong>主机名称</strong></th>
<th><strong>应用环境</strong></th>
<th><strong>外网地址</strong></th>
<th><strong>内网地址</strong></th>
</tr>
</thead>
<tbody><tr>
<td>web01</td>
<td>nginx+php</td>
<td>10.0.0.7</td>
<td>172.16.1.7</td>
</tr>
<tr>
<td>db01</td>
<td>mysql</td>
<td></td>
<td>172.16.1.51</td>
</tr>
</tbody></table>
<p><strong>5.数据库拆分架构详细步骤</strong></p>
<p>1.web01网站服务器操作如下</p>
<p>1)备份web01上的数据库，Bgx123.com是数据库密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]# mysqldump -uroot -p&#x27;Bgx123.com&#x27; --all-databases --single-transaction &gt; mysql-all.sql</span><br></pre></td></tr></table></figure>

<p><strong>8.扩展多台相同的Web服务器</strong></p>
<p><strong>1.为什么要扩展多台web节点</strong></p>
<p>单台web服务器能抗住的访问量是有限的，配置多台web服务器能提升更高的访问速度。</p>
<p><strong>2.扩展多台web解决了什么问题</strong></p>
<p>1.单台web节点如果故障，会导致业务down机</p>
<p>2.多台web节点能保证业务的持续稳定，扩展性高</p>
<p>3.多台web节点能有效的提升用户访问网站的速度</p>
<p><strong>3.多台web节点技术架构组成，如下图所示</strong></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\b731449103844523b577f05aa98ad0c1.jpg" alt="img"></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\aa955389440f441fa8193effd0d996a2.jpg" alt="img"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">共享多台web的静态资源</span><br><span class="line">  1.准备172.16.1.31共享存储服务器，规划目录，配置好权限</span><br><span class="line">    0)创建用户</span><br><span class="line">         [root@nfs ~]# groupadd -g666 www</span><br><span class="line">         [root@nfs ~]# useradd -u666 -g666 www</span><br><span class="line"></span><br><span class="line">    1）安装</span><br><span class="line">         [root@nfs ~]# yum install nfs-utils -y</span><br><span class="line">    2）配置</span><br><span class="line">        [root@nfs01 ~]# cat /etc/exports</span><br><span class="line">        /data/blog  192.168.160.0/24(rw,sync,all_squash,anonuid=666,anongid=666)</span><br><span class="line">        /data/zh  192.168.160.0/24(rw,sync,all_squash,anonuid=666,anongid=666)</span><br><span class="line">        /data/edu  192.168.160.0/24(rw,sync,all_squash,anonuid=666,anongid=666)</span><br><span class="line"></span><br><span class="line">    3）根据配置，创建目录，准备用户，授权等等</span><br><span class="line">    [root@nfs01 data]# rm -rf /data/</span><br><span class="line">    [root@nfs01 data]# mkdir /data/&#123;blog,zh,edu&#125;</span><br><span class="line"></span><br><span class="line">    4）启动</span><br><span class="line">         [root@nfs ~]# systemctl start nfs-server</span><br><span class="line">         [root@nfs ~]# systemctl enable nfs-server</span><br><span class="line">  </span><br><span class="line">  2.将图片较多的服务器，推送到nfs共享存储上</span><br><span class="line">    [root@web02 ~]# cd /code/wordpress/wp-content</span><br><span class="line">    [root@web02 wp-content]# scp -r uploads/* root@192.168.160.158:/data/blog/</span><br><span class="line">    注意：需要上nfs服务器进行重新的递归授权，否则会出现无法上传文件的错误</span><br><span class="line">    [root@nfs01 blog]# chown -R www.www /data/</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  3.多台web01和web02分别都进行挂载，此时图片进行实现了共享</span><br><span class="line">  [root@web02 uploads]# mount -t nfs 192.168.160.158:/data/blog /code/wordpress/wp-content/uploads/</span><br><span class="line">  [root@web01 opt]# mount -t nfs 192.168.160.158:/data/blog /code/wordpress/wp-content/uploads/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">拆分数据库</span><br><span class="line">拆分静态资源</span><br><span class="line">扩展多台web</span><br><span class="line"></span><br><span class="line">虚拟机还原，安装nginx与php，记得做快照</span><br><span class="line">1.lnmp</span><br><span class="line">2.拆分数据库</span><br><span class="line">3.拆分静态资源</span><br><span class="line">4.扩展多台web</span><br><span class="line">5.研究前端用负载均衡</span><br><span class="line">web01 web02  安装nginx+php</span><br><span class="line">mysql  安装mariadb-server</span><br><span class="line">nfs-utils  安装nfs</span><br></pre></td></tr></table></figure>

<p><strong>9.拆分静态资源至独立服务器</strong></p>
<p><strong>1.为什么拆分静态资源至独立存储服务器</strong></p>
<p>当后端的web节点出现多台时，会导致用户上传的图片、视频附件等内容仅上传至一台web服务器，那么其他的web服务器则无法访问到该图片。</p>
<p><strong>2.新增一台nfs存储解决了什么问题</strong></p>
<p>1.保证了多台web节点静态资源一致。</p>
<p>2.有效节省多台web节点的存储空间。</p>
<p>3.统一管理静态资源，便于后期推送至CDN进行静态资源加速</p>
<p><strong>3.多台web节点技术架构组成，如下图所示</strong></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\449852bb8dea4a1490c21ef700b22112.jpg" alt="img"></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\5b78e0d42e4e42e59e0c582b13c92316.jpg" alt="img"></p>
<p><strong>4.快速扩展一台web节点环境规划</strong></p>
<table>
<thead>
<tr>
<th><strong>主机名称</strong></th>
<th><strong>应用环境</strong></th>
<th><strong>外网地址</strong></th>
<th><strong>内网地址</strong></th>
</tr>
</thead>
<tbody><tr>
<td>web01</td>
<td>nginx+php</td>
<td>10.0.0.7</td>
<td>172.16.1.7</td>
</tr>
<tr>
<td>web02</td>
<td>nginx+php</td>
<td>10.0.0.8</td>
<td>172.16.1.8</td>
</tr>
<tr>
<td>nfs</td>
<td>nfs</td>
<td></td>
<td>172.16.1.31</td>
</tr>
<tr>
<td>db01</td>
<td>mysql</td>
<td></td>
<td>172.16.1.51</td>
</tr>
</tbody></table>
<p><strong>5.快速扩展一台web节点详细步骤</strong></p>
<p>1.nfs服务端，操作步骤如下</p>
<p>1）安装并配置nfs</p>
<h2 id="day35-nginx代理-P404"><a href="#day35-nginx代理-P404" class="headerlink" title="day35-nginx代理 P404"></a><strong>day35-nginx代理 P404</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">正向代理，（内部上网）</span><br><span class="line">反向代理，用于公司集群架构中</span><br><span class="line"></span><br><span class="line">5.正向与反向代理的区别</span><br><span class="line">区别在于形式上服务的“对象”不一样</span><br><span class="line">正向代理代理的对象是客户端，为客户端服务  PC电脑</span><br><span class="line">反向代理代理的对象是服务端，为服务端服务  服务器</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">proxy_set_header Host $http_host;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for</span><br><span class="line"></span><br><span class="line">[root@lb01 conf.d]# cat /etc/nginx/proxy_params</span><br><span class="line">proxy_set_header Host $http_host;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">proxy_connect_timeout 30;</span><br><span class="line">proxy_send_timeout 60;</span><br><span class="line">proxy_read_timeout 60;</span><br><span class="line"></span><br><span class="line">proxy_buffering on;</span><br><span class="line">proxy_buffer_size 32k;</span><br><span class="line">proxy_buffers 4 128k;</span><br><span class="line"></span><br><span class="line">7.代理配置location时调用，方便后续多个Location重复使用</span><br><span class="line">location / &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1:8080;</span><br><span class="line">    include proxy_params;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nginx代理局限性</span><br><span class="line">1.一个location仅能代理后端一台主机</span><br><span class="line">Nginx负载均衡</span><br><span class="line">  负载</span><br><span class="line">  负载均衡</span><br><span class="line">  调度</span><br><span class="line">  load balance</span><br><span class="line">  LB</span><br><span class="line">公有云</span><br><span class="line">  SLB  阿里云负载均衡</span><br><span class="line">  QLB  青云负载均衡</span><br><span class="line">  CLB  腾讯负载均衡</span><br><span class="line">  ULB  ucloud的负载均衡</span><br><span class="line">  </span><br><span class="line">负载均衡场景</span><br><span class="line">  lb  --&gt;  web01  web02</span><br><span class="line"></span><br><span class="line">问题：</span><br><span class="line">  使用nginx负载均衡时，如何将后端请求超时的服务器流量平滑的切换到另一台上。</span><br><span class="line">，Nginx是本身是有机制的，如果出现一个节点down掉的时候，Nginx会更据你具体负载均衡的设置，将请求转移到其他的节点上，但是</span><br><span class="line">如果后台服务连接没有down掉，但是返回错误异常码了如：504、502、500</span><br></pre></td></tr></table></figure>

<p><strong>1.Nginx代理服务基本概述</strong></p>
<p>1.代理一词往往并不陌生，该服务我们常常用到如（代理理财、代理租房、代理收货等等），如下图所示</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\a3d038a9696e409399a360c9ec757f58.jpg" alt="img"></p>
<p>2.在没有代理模式的情况下，客户端和Nginx服务端，都是客户端直接请求服务端，服务端直接响应客户端。</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\984cded2cda0461eaeb0b1478e257422.jpg" alt="img"></p>
<p>3.那么在互联网请求里面，客户端往往无法直接向服务端发起请求，那么就需要用到代理服务，来实现客户端和服务通信，如下图所示</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\2a30fffb6cc44d1ea103386be21cf179.jpg" alt="img"></p>
<p><strong>2.Nginx代理服务常见模式</strong></p>
<p>4.那Nginx作为代理服务，按照应用场景模式进行总结，代理分为正向代理、反向代理</p>
<p>正向代理，（内部上网）客户端&lt;—&gt;代理-&gt;服务端</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\b26e4ec07ceb4f1da88d276f1536d45e.jpg" alt="img"></p>
<p>反向代理，用于公司集群架构中，客户端-&gt;代理&lt;–&gt;服务端</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\d867e2e763204307bb7e6aafe846bcbb.jpg" alt="img"></p>
<p>5.正向与反向代理的区别</p>
<p>区别在于形式上服务的“对象“不一样</p>
<p>正向代理代理的对象是客户端，为客户端服务   PC电脑</p>
<p>反向代理代理的对象是服务端，为服务端服务   服务器</p>
<p><strong>3.Nginx代理服务支持协议</strong></p>
<p>1.Nginx作为代理服务，可支持的代理协议非常的多，具体如下图</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\47ae4094da2c4c028b088974de6aafef.jpg" alt="img"></p>
<p>2.如果将Nginx作为反向代理服务，常常会用到如下几种代理协议，如下图所示</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\e45942fb1129426ca51f8a6e58d98ce2.jpg" alt="img"></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\89e194a4986d4a55b308e02ca3a4daaa.jpg" alt="img"></p>
<p>3.反向代理模式与Nginx代理模块总结如表格所示</p>
<table>
<thead>
<tr>
<th><strong>反向代理模式</strong></th>
<th><strong>Nginx配置模块</strong></th>
</tr>
</thead>
<tbody><tr>
<td>http、websocket、https</td>
<td>ngx_http_proxy_module</td>
</tr>
<tr>
<td>fastcgi</td>
<td>ngx_http_fastcgi_module</td>
</tr>
<tr>
<td>uwsgi</td>
<td>ngx_http_uwsgi_module</td>
</tr>
<tr>
<td>grpc</td>
<td>ngx_http_v2_module</td>
</tr>
</tbody></table>
<p><strong>4.Nginx反向代理配置语法</strong></p>
<p>1.Nginx代理配置语法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Syntax: proxy_pass URL;</span><br><span class="line">Default:  -</span><br><span class="line">Context:  location, if in location, limit_except</span><br><span class="line">    </span><br><span class="line">http://localhost:8000/uri/</span><br><span class="line">http://192.168.56.11:8000/uri/</span><br><span class="line">http://unix:/tmp/backend.socket:/uri/</span><br></pre></td></tr></table></figure>

<p><strong>5.Nginx反向代理场景实践</strong></p>
<p>Nginx反向代理配置实例</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\653291136e79401b8d764c7b4e32a8c5.jpg" alt="img"></p>
<p>1.环境准备</p>
<table>
<thead>
<tr>
<th><strong>角色</strong></th>
<th><strong>外网IP（NAT）</strong></th>
<th><strong>内网IP（LAN）</strong></th>
<th><strong>主机名</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Proxy</td>
<td>eth0:10.0.05</td>
<td>eth1:172.16.1.5</td>
<td>lb01</td>
</tr>
<tr>
<td>web01</td>
<td></td>
<td>eth1:172.16.1.7</td>
<td>web01</td>
</tr>
</tbody></table>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">1.配置后端的web</span><br><span class="line">[root@web01 conf.d]<span class="comment"># vim web.oldboy.com.conf </span></span><br><span class="line">[root@web01 conf.d]<span class="comment"># cat web.oldboy.com.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name web.oldboy.com;</span><br><span class="line">    root /web;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        index index.php index.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">[root@web01 conf.d]<span class="comment"># mkdir /web</span></span><br><span class="line">[root@web01 conf.d]<span class="comment"># echo &quot;Web01......&quot; &gt; /web/index.html</span></span><br><span class="line">[root@web01 conf.d]<span class="comment"># nginx -t</span></span><br><span class="line">[root@web01 conf.d]<span class="comment"># systemctl restart  nginx</span></span><br><span class="line"></span><br><span class="line">2.nginx代理配置</span><br><span class="line">[root@lb01 conf.d]<span class="comment"># cat proxy_web.conf </span></span><br><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name web.oldboy.com;</span><br><span class="line">        location / &#123;</span><br><span class="line">                proxy_pass http://192.168.160.149:80;</span><br><span class="line">                proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@lb01 conf.d]<span class="comment"># systemctl restart nginx</span></span><br><span class="line"></span><br><span class="line">3.抓包分析：</span><br><span class="line"></span><br><span class="line">4.代理相关的参数</span><br><span class="line">proxy_pass http://192.168.160.149:80;</span><br><span class="line">proxy_http_version 1.1;  <span class="comment">#代理使用http1.1协议</span></span><br><span class="line">proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;  <span class="comment">#记录真实的IP地址</span></span><br><span class="line"></span><br><span class="line">[root@Nginx ~]<span class="comment"># vim /etc/nginx/proxy_params</span></span><br><span class="line">proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"></span><br><span class="line">proxy_connect_timeout 30;</span><br><span class="line">proxy_send_timeout 60;</span><br><span class="line">proxy_read_timeout 60;</span><br><span class="line"></span><br><span class="line">proxy_buffering on;</span><br><span class="line">proxy_buffer_size 32k;</span><br><span class="line">proxy_buffers 4 128k;</span><br><span class="line"></span><br><span class="line">7.代理配置location时调用，方便后续多个Location重复使用</span><br><span class="line">location / &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1:8080;</span><br><span class="line">    include proxy_params;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决日志favicon.ico问题</span></span><br><span class="line">location /favicon.ico &#123;</span><br><span class="line">    <span class="built_in">return</span> 200;</span><br><span class="line">    access_log off;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nginx代理局限性</span><br><span class="line">    1.一个location仅能代理后端一台主机</span><br><span class="line"></span><br><span class="line">location ~* ^\/appmgr\/ &#123;</span><br><span class="line">    proxy_set_header  Host <span class="variable">$host</span>;</span><br><span class="line">    proxy_set_header  X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    proxy_set_header  X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    proxy_pass http://172.16.1.7:80;</span><br><span class="line">    &#125;</span><br><span class="line">location ~* ^\/CreditAssist-<span class="built_in">test</span> &#123;</span><br><span class="line">    proxy_set_header  Host <span class="variable">$host</span>;</span><br><span class="line">    proxy_set_headerX-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    proxy_set_header  X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    proxy_pass http://172.16.1.8:80;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>3.添加发往后端服务器的请求头信息，如图</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Syntax:proxy_set_header field value;</span><br><span class="line">Default:  proxy_set_header Host <span class="variable">$proxy_host</span>;</span><br><span class="line">          proxy_set_header Connection close;</span><br><span class="line">Context:  http, server, location</span><br><span class="line"></span><br><span class="line"><span class="comment">#用户请求的时候HOST的值是www.bgx.com，那么代理服务会像后端传递请求的还是www.bgx.com</span></span><br><span class="line">proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line"><span class="comment">#将$remote_addr的值放进变量X-Real-IP中，$remote_addr的值为客户端的ip</span></span><br><span class="line">proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line"><span class="comment">#客户端通过代理服务访问后端服务，后端服务通过该变量会记录真实客户端地址</span></span><br><span class="line">proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br></pre></td></tr></table></figure>

<p>4.代理到后端的TCP连接、响应、返回等超时时间，如图</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//nginx代理与后端服务器连接超时时间（代理连接超时）</span><br><span class="line">Syntax: proxy_connect_timeout time;</span><br><span class="line">Default: proxy_connect_timeout 60s;</span><br><span class="line">Context: http, server, location</span><br><span class="line"></span><br><span class="line">//nginx代理等待后端服务器的响应时间</span><br><span class="line">Syntax: proxy_read_timeout time;</span><br><span class="line">Default: proxy_read_timeout 60s;</span><br><span class="line">Context: http, server, location</span><br><span class="line">    </span><br><span class="line">//后端服务器数据回传给nginx代理超时时间</span><br><span class="line">Syntax: proxy_send_timeout time;</span><br><span class="line">Default: proxy_send_timeout 60s;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>

<p>5.proxy_buffer代理缓冲区,如图</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ax: proxy_buffering on | off;</span><br><span class="line">Default: proxy_buffering on;</span><br><span class="line">Context: http, server, location</span><br><span class="line"></span><br><span class="line">//设置nginx代理保存用户头信息的缓冲区人小</span><br><span class="line">Syntax: proxy_buffer_size size;</span><br><span class="line">Default: proxy_buffer_size 4k|8k;</span><br><span class="line">Context: http, server, location</span><br><span class="line"></span><br><span class="line">//proxy_buffers 缓冲区</span><br><span class="line">Syntax: proxy_buffers number size;</span><br><span class="line">Default: proxy_buffers 8 4k|8k;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>

<p>6.Proxy代理网站常用优化配置如下，将配置写入新文件，调用时使用 include引用即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ~]# vim /etc/nginx/proxy_params</span><br><span class="line">proxy_set_header Host $http_host;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">proxy_connect_timeout 30;</span><br><span class="line">proxy_send_timeout 60;</span><br><span class="line">proxy_read_timeout 60;</span><br><span class="line"></span><br><span class="line">proxy_buffering on;</span><br><span class="line">proxy_buffer_size 32k;</span><br><span class="line">proxy_buffers 4 128k;</span><br></pre></td></tr></table></figure>

<p>7.代理配置location时调用，方便后续多个Location重复使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1:8080;</span><br><span class="line">    include proxy_params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>07.Nginx七层负载均衡</strong></p>
<p>1.Nginx负载均衡基本概述</p>
<p>为什么需要使用负载均衡</p>
<p>当我们的Web服务器直接面向用户，往往要承载大量并发请求，单台服务器难以负荷，我使用多台WEB服务器组成集群，前端使用Nginx负载均衡，将请求分散的打到我们的后端服务器集群中，实现负载的分发。那么会大大提升系统的吞吐率、请求性能、高容灾</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\509e167bcffa4801a83145b1558314c0.jpg" alt="img"></p>
<p>往往我们接触的最多的是SLB(Server Load Balance)负载均衡，实现最多的也是SLB、那么SLB它的调度节点和服务节点通常是在一个地域里面。那么它在这个小的逻辑地域里面决定了他对部分服务的实时性、响应性是非常好的。</p>
<p>所以说当海量用户请求过来以后，它同样是请求调度节点，调度节点将用户的请求转发给后端对应的服务节点，服务节点处理完请求后在转发给调度节点，调度节点最后响应给用户节点。这样也能实现一个均衡的作用，那么Nginx则是一个典型的SLB</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\e7c42c5547454aa297b04d5e94f93615.jpg" alt="img"></p>
<p><strong>负载均衡能实现的应用场景一：四层负载物衡</strong></p>
<p>所谓四层负载均衡指的是OSI七层模型中的传输层，那么传输层Nginx已经能支持TCP&#x2F;IP的控制，所以只需要对客户端的请求进行TCP&#x2F;IP协议的包转发就可以实现负载均衡，那么它的好处是性能非常快、只需要底层进行应用处理，而不需要进行一些复杂的逻辑。</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\f110140204054003a97cca40664d3dd8.jpg" alt="img"></p>
<p><strong>负载均衡能实现的应用场景二：七层负载均衡</strong></p>
<p>七层负载均衡它是在应用层，那么它可以完成很多应用方面的协议请求，比如我们说的http应用的负载均衡，它可以实现http信息的改写、头信息的改写、安全应用规则控制、URL匹配规则控制、以及转发、rewrite等等的规则，所以在应用层的服务里面，我们可以做的内容就更多，那么Nginx则是一个典型的七层负载均衡SLB</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\a432c6575a7f4286a23066f28b0dbcdc.jpg" alt="img"></p>
<p><strong>3.四层负载均衡与七层负载均衡区别</strong></p>
<p>四层负载均衡数据包在底层就进行了分发，而七层负载均衡数据包则是在最顶层进行分发、由此可以看出，七层负载均衡效率没有四负载均衡高。</p>
<p>但七层负载均衡更贴近于服务，如：http协议就是七层协议，我们可以用Nginx可以作会话保持，URL路径规则匹配、head头改写等等，这些是四层负载均衡无法实现的。</p>
<p><strong>2.Nginx负载均衡配置场景</strong></p>
<p>Nginx要实现负载均衡需要用到proxy_pass代理模块配置.</p>
<p>Nginx负载均衡与Nginx代理不同地方在于，Nginx代理仅代理一台服务器，而Nginx负载均衡则是将客户端请求代理转发至一组upstream虚拟服务池</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\ad2b842e97014447ba65c5186ac77029.jpg" alt="img"></p>
<p>Nginx upstream虚拟配置语法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Syntax: upstream name &#123; .….&#125;</span><br><span class="line">Default: -</span><br><span class="line">Context: http</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">upstream例</span></span><br><span class="line">upstream backend &#123;</span><br><span class="line">    server backend1.example.com  weight=5;</span><br><span class="line">    server backend2.example.com:8080;</span><br><span class="line">    server unix:/tmp/backend3;</span><br><span class="line">    server backup1.example.com:8080  backup;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://backend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>0,环境规划</p>
<table>
<thead>
<tr>
<th><strong>角色</strong></th>
<th><strong>外网IP（NAT）</strong></th>
<th><strong>内网IP（LAN）</strong></th>
<th><strong>主机名</strong></th>
</tr>
</thead>
<tbody><tr>
<td>LB01</td>
<td>eth0:10.0.0.5</td>
<td>eth1:172.16.1.5</td>
<td>lb01</td>
</tr>
<tr>
<td>web01</td>
<td>eth0:10.0.0.7</td>
<td>eth1:172.16.1.7</td>
<td>web01</td>
</tr>
<tr>
<td>web02</td>
<td>eth0:10.0.0.8</td>
<td>eth1:172.16.1.8</td>
<td>web02</td>
</tr>
</tbody></table>
<p>1.Web01服务器上配置nginx，并创建对应html 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]# cd /etc/nginx/conf.d/</span><br><span class="line">[root@web01 conf.d]# cat node.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name node.oldboy.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /node;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@web01 conf.d]# mkdir /node</span><br><span class="line">[root@web01 conf.d]# echo &quot;Web01...&quot; &gt; /node/index.html</span><br><span class="line">[root@web01 conf.d]# systemctl restart nginx</span><br></pre></td></tr></table></figure>

<p>2.Web02服务器上配置nginx，并创建对应html 文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@web02 ~]<span class="comment"># cd /etc/nginx/conf.d/</span></span><br><span class="line">[root@web02 conf.d]<span class="comment"># cat node.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name node.oldboy.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /node;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@web02 conf.d]<span class="comment"># mkdir /node</span></span><br><span class="line">[root@web02 conf.d]<span class="comment"># echo &quot;Webe2...&quot; &gt; /node/index.html</span></span><br><span class="line">[root@web02 conf.d]<span class="comment"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure>

<p>3.配置Nginx负载均衡</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">[root@lb01~]# </span><span class="language-bash"><span class="built_in">cd</span> /etc/ngnx/conf.d/</span></span><br><span class="line">[root@lb01 conf.d]# cat node_proxy.conf</span><br><span class="line">upstream node &#123;</span><br><span class="line">    server 172.16.1.7:80;</span><br><span class="line">    server 172.16.1.8:80;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen B0;</span><br><span class="line">    server_name node.oldboy.com;</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://node;</span><br><span class="line">        include proxy_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">nginx代理</span><br><span class="line">    正向代理</span><br><span class="line">    反向代理</span><br><span class="line">    </span><br><span class="line">    反向代理场景</span><br><span class="line">        proxy_pass</span><br><span class="line">        携带头部信息    proxy_set_header</span><br><span class="line">        </span><br><span class="line">proxy_http_version 1.1;   #代理向后请求使用的版本</span><br><span class="line">proxy_set_header Host $http_host;  #代理向后端主机请求时携带的host域名</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  #获取客户端真实IP以及全链路IP</span><br><span class="line"></span><br><span class="line">proxy_connect_timeout 30;  #代理连接后端超时时间</span><br><span class="line">proxy_send_timeout 60;  #后端传递数据至代理超时时间</span><br><span class="line">proxy_read_timeout 60;  #后端响应代理的超时时间</span><br><span class="line"></span><br><span class="line">proxy_buffering on;</span><br><span class="line">proxy_buffer_size 32k;</span><br><span class="line">proxy_buffers 4 128k;</span><br><span class="line"></span><br><span class="line">负载均衡</span><br><span class="line">    稳定</span><br><span class="line">    高效</span><br><span class="line">    容灾</span><br><span class="line">    负载均衡代理的是一组虚拟资源池。</span><br><span class="line">    负载均衡能对物理主机进行逻辑上的捆绑。（主要是让后端的主机组成集群。）</span><br><span class="line">    </span><br><span class="line">    调度 --》 服务节点</span><br><span class="line">    负载均衡场景</span><br><span class="line">        lb --&gt; web01  web02</span><br><span class="line">        </span><br><span class="line">    问题：</span><br><span class="line">        7.使用nginx负载均衡时，如何将后端请求超时的服务器流量平滑的切换到另一台上。</span><br><span class="line">如果后台服务连接超时，Nginx是本身是有机制的，如果出现一个节点down掉的时候，Nginx会更据你具体负载均衡的设置，将请求转移到其他的节点上，但是，如果后台服务连接没有down掉，但是返回错误异常码了如:504、502、500。</span><br></pre></td></tr></table></figure>

<h2 id="day36-nginx负载均衡"><a href="#day36-nginx负载均衡" class="headerlink" title="day36-nginx负载均衡"></a><strong>day36-nginx负载均衡</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">nginx作为代理服务</span><br><span class="line">    正向代理  -----&gt;  科学上网</span><br><span class="line">    反向代理  -----&gt;  为后端节点没有公网IP的主机进行代理</span><br><span class="line">    </span><br><span class="line">http_proxy_module</span><br><span class="line">    proxy_pass address 将请求转发至对应的地址  http://IP:PORT</span><br><span class="line">    proxy_set_header 设置代理头部信息  Host  X-Forward-For X-Real-IP</span><br><span class="line">    proxy_http_version 1.1;   让代理与后端通信时使用http1.1协议</span><br><span class="line"></span><br><span class="line">include proxy_params；方便调用</span><br><span class="line"></span><br><span class="line">location ~^/user &#123;</span><br><span class="line">    proxy_pass http://10.0.0.7;</span><br><span class="line">&#125;</span><br><span class="line">location ~^/pass &#123;</span><br><span class="line">    proxy_pass http://10.0.0.8;</span><br><span class="line">&#125;</span><br><span class="line">location ~^/login &#123;</span><br><span class="line">    proxy_pass http://10.0.0.9;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">nginx负载均衡</span><br><span class="line">    代理仅能代理一台主机，负载均衡能代理一组资源池</span><br><span class="line">1.先定义资源池，定义相同主机为一个资酒油</span><br><span class="line">2.使用proxy_pass 调用 http://资源池名称</span><br><span class="line"></span><br><span class="line">使用nqinx负载均衡时，如何将后端请求超时的服务器流量平滑的切换到另一台上。</span><br><span class="line">，Nginx是本身是有机制的，如果出现一个节点down掉的时候，Nginx会更据你具体负载均衡的设置，将请求转移到其他的节点上，但是</span><br><span class="line">如果后台服务连接没有down掉，但是返回错误异常码了如：504、502、500</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name xuliangwei.com;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://node;</span><br><span class="line">        proxy_next_upstream error timeout http_500 http_502 http_503 http_504;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">后端的状态</span><br><span class="line">调度模式</span><br><span class="line">健康检查（编译）</span><br><span class="line">会话登录</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">调度算法     概述</span><br><span class="line">轮询        按时间顺序逐一分配到不同的后端服务器（默认）</span><br><span class="line">weight      加权轮询，weight值越大，分配到的诱问几率越高</span><br><span class="line">ip_hash     每个请求按访问IP的hash结果分配，这样来自同一IP的固定访问一个后端服务器</span><br><span class="line">url_hash    按照访问URL的hash结果来分配请求，是每个URL定向到同一个后端服务器</span><br><span class="line">least_conn  最少链接数，那个机器链接数少就分发</span><br><span class="line"></span><br><span class="line">轮询</span><br><span class="line">upstream load_pass &#123;</span><br><span class="line">    server 10.0.0.7:80;</span><br><span class="line">    server 10.0.0.8:80;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">加权轮询</span><br><span class="line">upstream web &#123;</span><br><span class="line">        server 192.168.160.149:80 weight=5;</span><br><span class="line">        server 192.168.160.157:80 weight=1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ip_hash不能加权轮询一起使用</span><br><span class="line">ip_hash能解决会话登录,会造成负载不均衡,导致某一台主机流量过大,而另一台没什么流量</span><br><span class="line">upstream web &#123;</span><br><span class="line">        ip_hash;</span><br><span class="line">        server 192.168.160.149:80;</span><br><span class="line">        server 192.168.160.157:80;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.Nginx负载均衡调度算法</p>
<table>
<thead>
<tr>
<th><strong>调度算法</strong></th>
<th><strong>概述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>轮询</td>
<td>按时间顺序逐一分配到不同的后端服务器（默认）</td>
</tr>
<tr>
<td>weight</td>
<td>加权轮询，weight值越大，分配到的访问几率越高</td>
</tr>
<tr>
<td>ip_hash</td>
<td>每个请求按访问IP的hash结果分配，这样来自同一IP的固定访问一个后端服务器</td>
</tr>
<tr>
<td>url_hash</td>
<td>按照访问URL的hash结果来分配请求，是每个URL定向到同一个后端服务器</td>
</tr>
<tr>
<td>least_conn</td>
<td>最少链接数，那个机器链接数少就分发</td>
</tr>
</tbody></table>
<p>1.Nginx负载均衡[wrr]轮询具体配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">upstream load_pass &#123;</span><br><span class="line">    server 10.0.0.7:80;</span><br><span class="line">    server 10.0.0.8:80;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">状态           概述</span><br><span class="line">down          当前的server暂时不参与负载均衡</span><br><span class="line">backup        预留的备份服务器</span><br><span class="line">max_ fails    允许请求失败的次数</span><br><span class="line">fail_timeout  经过max_fails失败后，服务暂停时间</span><br><span class="line">max_conns     限制最大的接收连接数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">一般用于停机维护时使用</span><br><span class="line">upstream web &#123;</span><br><span class="line">    server 172.16.1.7:80 down;</span><br><span class="line">    server 172.16.1.8:80;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">当所有的server不可用时，才会启用backup</span><br><span class="line">upstream web &#123;</span><br><span class="line">    server 172.16.1.7:80 backup;</span><br><span class="line">    server 172.16.1.8:80;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">健康检查，但无法查看到具体的指标，不够形象</span><br><span class="line">upstream web &#123;</span><br><span class="line">server 172.16.1.7:80 max fails=2 fail timeout=10s;</span><br><span class="line">server 172.16.1.8:80 max fails=2 fail timeout=10s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>4.Nginx负载均衡后端状态</strong></p>
<p>后端 web 服务器在前端Nginx负载均衡调度中的状态</p>
<table>
<thead>
<tr>
<th><strong>状态</strong></th>
<th><strong>概述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>down</td>
<td>当前的server暂时不参与负载均衡</td>
</tr>
<tr>
<td>backup</td>
<td>预留的备份服务器</td>
</tr>
<tr>
<td>max_fails</td>
<td>允许请求失败的次数</td>
</tr>
<tr>
<td>fail_timeout</td>
<td>经过max_fails失败后，服务暂停时间</td>
</tr>
<tr>
<td>max_conns</td>
<td>限制最大的接收连接数</td>
</tr>
</tbody></table>
<p>1.测试 down|状态，测试该server 不参与负载均衡的调度</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream load_pass &#123;</span><br><span class="line">    #不参与任何调度，一般用于停机维护</span><br><span class="line">    server 10.0.0.7:80 down;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>5.Nginx负载均衡健康检查</strong></p>
<p>在Nginx官方模块提供的模块中，没有对负载均衡后端节点的健康检查模块，但可以使用第三方模块nginx_upstream_check_module来检测后方服务的健康状态<a target="_blank" rel="noopener" href="https://github.com/yaoweibin/nginx_upstream_check_module/">upstream_check_module</a>项目地址</p>
<p>1.安装依赖包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@lb02 ~]# yum install -y gcc glibc gcc-c++ pcre-devel openssl-devel pcre-devel patch</span><br></pre></td></tr></table></figure>

<p>2.下载nginx源码包以及nginx_upstream_check模块第三方模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@lb02 ~]# wget http://nginx.org/download/nginx-1.14.2.tar.gz </span><br><span class="line">[root@lbe2 ~]# wget https://github.com/yaoweibin/nginx_upstream_check_module/archive/master.zip</span><br></pre></td></tr></table></figure>

<p>3.解压nginx源码包以及第三方模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@lb02 ~]# tar xf nginx-1.14.2.tar.gz </span><br><span class="line">[root@lb02 ~]# unzip master.zip</span><br></pre></td></tr></table></figure>

<p>4.进入nginx目录，打补丁（nginx的版本是1.14补丁就选择1.14的,p1代表在nginx目录，p0是不在nginx目录）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@lb02 ~]# cd nginx-1.14.2/ </span><br><span class="line">[root@lbe2 nginx-1.14.2]# patch -p1 &lt;../nginx_upstream_check_modüle-master/check_1.14.o+.patch</span><br></pre></td></tr></table></figure>

<p>5.编译Nginx,需要添加upstream_check第三方模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@lb02 nginx-1.14.2]# ./configure --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path </span><br><span class="line">[root@lb02 nginx-1.14.2]# make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>6.配置nginx负载均衡，同时打开upstream健康检查功能</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@lb02 conf.d]# cat proxy.blog.bgx.com.conf</span><br><span class="line">upstream blog.bgx.com &#123;</span><br><span class="line">    server 172.16.1.7:80;</span><br><span class="line">    server 172.16.1.8:80;</span><br><span class="line">    check interval=3000 rise=2 fall=3 timeout=1000 type=tcp;</span><br><span class="line">    #interval检测间隔时间，单位为毫秒</span><br><span class="line">    #rsie表示请求2次正常，标记此后端的状态为up</span><br><span class="line">    #fall表示请求3次失败，标记此后端的状态为down</span><br><span class="line">    #type 类型为tcp</span><br><span class="line">    #timeout为超时时间，单位为毫秒</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name blog.bgx.com;</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">    proxy_pass http://blog.bgx.com;</span><br><span class="line">    proxy_set_header Host $http_host;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwardad_for;</span><br><span class="line">    &#125;</span><br><span class="line">    location /upstream_check &#123;</span><br><span class="line">        check_status;</span><br><span class="line">        allow 10.0.0.1;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line">nginx第三方健康检查模块</span><br><span class="line">1.安装依赖包</span><br><span class="line">[root@lb02 ~]# yum install -y gcc glibc gcc-c++ pcre-devel openssl-devel pcre-devel patch</span><br><span class="line"></span><br><span class="line">2.下载nginx源码包以及nginx_upstream_check模块第三方模块</span><br><span class="line">[root@lb02 ~]# wget http://nginx.org/download/nginx-1.14.2.tar.gz</span><br><span class="line">[root@lb02 ~]# wget https://github.com/yaoweibin/nginx_upstream_check_module/archive/master.zip</span><br><span class="line"></span><br><span class="line">3.解压nginx源码包以及第三方模块</span><br><span class="line">[root@lb02 ~]# tar xf nginx-1.14.2.tar.gz</span><br><span class="line">[root@lb02 ~]# unzip master.zip</span><br><span class="line"></span><br><span class="line">4.进入nginx目录，打补丁（nginx的版本是1.14补J就选择1.14的，p1代表在nginx目录，p0是不在nginx目录）</span><br><span class="line">[root@lb02 ~]# cd nginx-1.14.2/</span><br><span class="line">[root@lb02 nginx-1.14.2]# patch -pl &lt;../nginx_upstream_check_module-master/check_1.14.0+.patch</span><br><span class="line">[root@lb01 ~]# nginx -V</span><br><span class="line">./configure --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --add-module=/root/nginx_upstream_check_module-master --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --add-module=/root/nginx_upstream_check_module-master --with-cc-opt=&#x27;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC&#x27; --with-ld-opt=&#x27;-Wl,-z,relro -Wl,-z,now -pie&#x27;</span><br><span class="line">[root@lb01 nginx-1.14.2]# make</span><br><span class="line">[root@lb01 nginx-1.14.2]# make install</span><br><span class="line"></span><br><span class="line">5.在已有的负载均衡上增加健康检查的功能</span><br><span class="line">[root@lb01 conf.d]# vim proxy_web.conf</span><br><span class="line">upstream web &#123;</span><br><span class="line">        server 192.168.160.149:80;</span><br><span class="line">        server 192.168.160.157:80;</span><br><span class="line">        check interval=3000 rise=2 fall=3 timeout=1000 type=tcp;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name web.oldboy.com;</span><br><span class="line">        location / &#123;</span><br><span class="line">                proxy_pass http://web;</span><br><span class="line">                proxy_set_header Host $http_host;</span><br><span class="line">                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">                proxy_http_version 1.1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /upstream_check &#123;</span><br><span class="line">                check_status;</span><br><span class="line">                allow 10.0.0.1;</span><br><span class="line">                deny all;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ip_hash  会话登录问题，造成某一台主机压力过大</span><br><span class="line"></span><br><span class="line">ip_hash</span><br><span class="line">session复制</span><br><span class="line">session共享</span><br><span class="line">  本地文件---&gt;nfs共享</span><br><span class="line">  通过程序-》写入redis数据库</span><br><span class="line">  通过程序-》写入mysql数据库</span><br><span class="line"></span><br><span class="line">1.配置Nginx</span><br><span class="line">[root@web01 conf.d]# vim php.conf </span><br><span class="line">[root@web01 conf.d]# cat php.conf </span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name php.oldboy.com;</span><br><span class="line">    root /code/phpMyAdmin-5.1.3-all-languages;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        index index.php index.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@web01 conf.d]# systemctl restart nginx</span><br><span class="line"></span><br><span class="line">2.安装phpmyadmin（web01和web02上都装）</span><br><span class="line">[root@web01 code]# tar xf phpMyAdmin-5.1.3-all-languages.zip </span><br><span class="line">[root@web01 code]# unzip phpMyAdmin-5.1.3-all-languages.zip </span><br><span class="line"></span><br><span class="line">3.配置phpmyadmin连接远程的数据库</span><br><span class="line">[root@web01 code]# cd phpMyAdmin-5.1.3-all-languages</span><br><span class="line">[root@web01 phpMyAdmin-5.1.3-all-languages]# cp config.sample.inc.php config.inc.php </span><br><span class="line">[root@web01 phpMyAdmin-5.1.3-all-languages]# vim config.inc.php</span><br><span class="line">/* Server parameters */</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">cfg[<span class="string">&#x27;Servers&#x27;</span>][<span class="variable">$i</span>][<span class="string">&#x27;host&#x27;</span>] = <span class="string">&#x27;192.168.160.151&#x27;</span>;</span> </span><br><span class="line">  </span><br><span class="line">4.配置授权</span><br><span class="line">[root@web01 conf.d]# chown -R www.www /var/lib/php</span><br><span class="line"></span><br><span class="line">5.将web01上配置好的phpmyadmin以及nginx的配置文件推送到web02主机上</span><br><span class="line">[root@web01 code]# scp -rp phpMyAdmin-5.1.3-all-languages root@192.168.160.157:/code/</span><br><span class="line">[root@web01 code]# scp /etc/nginx/conf.d/php.conf root@192.168.160.157:/etc/nginx/conf.d/</span><br><span class="line">  </span><br><span class="line">6.在web02上重载Nginx服务</span><br><span class="line">[root@web02 code]# systemctl restart nginx</span><br><span class="line"></span><br><span class="line">7.授权</span><br><span class="line">[root@web02 code]# chown -R www.www /var/lib/php/</span><br><span class="line"></span><br><span class="line">8.接入负载均衡</span><br><span class="line">[root@lb01 conf.d]# vim proxy_php.com.conf </span><br><span class="line">[root@lb01 conf.d]# cat proxy_php.com.conf </span><br><span class="line">upstream php &#123;</span><br><span class="line">        server 192.168.160.149:80;</span><br><span class="line">        server 192.168.160.157:80;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name php.oldboy.com;</span><br><span class="line">        location / &#123;</span><br><span class="line">                proxy_pass http://php;</span><br><span class="line">                proxy_next_upstream error timeout http_500 http_502 http_503 http_504;</span><br><span class="line">                include proxy_params;</span><br><span class="line">         &#125;</span><br><span class="line">&#125;</span><br><span class="line">root@lb01 conf.d]# nginx -t</span><br><span class="line">[root@lb01 conf.d]# systemctl restart nginx</span><br><span class="line"></span><br><span class="line">使用redis解决会话登录问题</span><br><span class="line">1.安装redis内存数据库</span><br><span class="line">[root@db01 ~]# yum install redis -y</span><br><span class="line"></span><br><span class="line">2.配置redis监听在172.16.1.0网段上</span><br><span class="line">[root@db01 ~]# sed -i &#x27;/^bind/c bind 127.0.0.1 192.168.160.151&#x27; /etc/redis.conf</span><br><span class="line"></span><br><span class="line">3.启动redis</span><br><span class="line">[root@db01 ~]# systemctl start redis</span><br><span class="line">[root@db01 ~]# systemctl enable redis</span><br><span class="line"></span><br><span class="line">4.php配置session连接redis</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.修改/etc/php.ini文件</span></span><br><span class="line">[root@web01 code]# vim /etc/php.ini </span><br><span class="line">session.save_handler = redis</span><br><span class="line">session.save_path = &quot;tcp://192.168.160.151:6379&quot;</span><br><span class="line">;session.save_path = &quot;tcp://192.168.160.151:6379?auth=123&quot;  #如果redis存在密码，则使用该方式</span><br><span class="line">session.auto_start = 1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.注释php-fpm.d/www.conf里面的两条内容，否则session内容会一直写入/var/lib/php/session目录中</span></span><br><span class="line">[root@web01 code]# vim /etc/php-fpm.d/www.conf</span><br><span class="line">;php_value[session.save_handler] = files</span><br><span class="line">;php_value[session.save_path]    = /var/lib/php/session</span><br><span class="line"></span><br><span class="line">3.重启php-fpm</span><br><span class="line">[root@web01 code]# systemctl restart php-fpm</span><br><span class="line"></span><br><span class="line">4.将web01上配置好的文件推送到web02</span><br><span class="line">[root@web01 code]# scp /etc/php.ini root@192.168.160.157:/etc/php.ini</span><br><span class="line">[root@web01 code]# scp /etc/php-fpm.d/www.conf root@192.168.160.157:/etc/php-fpm.d/www.conf </span><br><span class="line"></span><br><span class="line">5.上web02上重启php-fpm</span><br><span class="line">[root@web02 code]# systemctl restart php-fpm</span><br><span class="line"></span><br><span class="line">6.redis查看数据</span><br><span class="line">[root@db01 ~]# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;PHPREDIS_SESSION:2202756531b044534af773add2207ccc&quot;</span><br><span class="line">2) &quot;PHPREDIS_SESSION:a7e4783dec0f93303df50e8cce6d8d17&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">上周回顾：</span><br><span class="line">nginx</span><br><span class="line">nginx搭建网站 LNMP</span><br><span class="line">数据库拆分</span><br><span class="line">nginx搭建多个网站</span><br><span class="line">wordpress</span><br><span class="line">wecenter</span><br><span class="line">zblog</span><br><span class="line">phpmyadmin</span><br><span class="line">edusoho</span><br><span class="line">nginx负载均衡和反向代理</span><br><span class="line">redis缓存，session会话共享</span><br></pre></td></tr></table></figure>

<h2 id="day37-nginx负载均衡"><a href="#day37-nginx负载均衡" class="headerlink" title="day37-nginx负载均衡"></a><strong>day37-nginx负载均衡</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">七层负载均衡作用：（OSI 应用层）</span><br><span class="line">    流量分发</span><br><span class="line">    后端服务高可用</span><br><span class="line">    调度策略</span><br><span class="line">    轮询</span><br><span class="line">    加权轮询</span><br><span class="line">    ip_hash  （会话登录）  redis将session_id进行共享</span><br><span class="line">    url_hash</span><br><span class="line">    健康检查（官方）</span><br><span class="line">        backup  备机</span><br><span class="line">        down    注释</span><br><span class="line">        max_fails   失败的次数</span><br><span class="line">        fail_timeout   多长时间内失败max_fails次，则视为down</span><br><span class="line">    健康检查  check_upstream  第三方</span><br><span class="line"></span><br><span class="line">upstream</span><br><span class="line">proxy_pass</span><br><span class="line"></span><br><span class="line">四层负载均衡：（OSI传输层  ip:port）</span><br><span class="line">    nginx1.9 版本 加入的四层负载均衡</span><br><span class="line">硬件：F5</span><br><span class="line">软件：LVS、Haproxy、Nginx</span><br></pre></td></tr></table></figure>

<p><strong>1.Nginx四层负载均衡基本概述</strong></p>
<p><strong>1.什么是四层负载均衡</strong></p>
<p>四层负载均衡基于传输层协议包来封装的（如：TCP&#x2F;IP），那我们前面使用到的七层是指的应用层，它的组装在四层基础之上，无论四层还是七层都是指的OSI网络模型。</p>
<p><strong>2.四层层负载均衡应用场景</strong></p>
<p>1.四层+七层来作负载均衡，4层可以保证7层的负载均衡的高可用性。如：nginx就无法保证自己的服务高可用，需要依赖vs或者keepalive来作。</p>
<p>2.，如:tcp协议的负载均衡，有些请求是TCP协议的（mysql、ssh），或者说这些请求只需要使用4层进行端口的转发就可以了，所以使用4层负载均衡。</p>
<p>比如做：mysql读的负载均衡（轮询）</p>
<p>比如做：端口映射、端口转发  tcp&#x2F;udp</p>
<p><strong>3.四层+七层构建大规模集群架构使用场景</strong></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647566965462.png" alt="img"></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\2dc38130b33c4c87aa44fba756aed812.jpg" alt="img"></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\67109ee81a274077a538afaf07d07737.jpg" alt="img"></p>
<p><strong>四层负载均衡总结</strong></p>
<p>1.四层负载均衡仅能转发TQP&#x2F;IP协议、UDP协议，通常用来转发端口，如：tcp&#x2F;3306，tcp&#x2F;22，udp&#x2F;53。</p>
<p>2.四层负载均衡可以用来解决七层负载均衡的端口限制问题。（七层负载均衡最大使用65535个端口号）</p>
<p>3.可以用来解决七层负载均衡的高可用问题。（多台后端七层负载均衡能同时的使用）</p>
<p>4.四层的转发效率比七层的高的多，但仅支持tcp&#x2F;ip协议，不支持http或者https协议</p>
<h2 id="day37-nginx负载均衡-4"><a href="#day37-nginx负载均衡-4" class="headerlink" title="day37-nginx负载均衡-4"></a><strong>day37-nginx负载均衡-4</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">1.在lb02上面安装Nginx</span><br><span class="line">[root@lb02 ~]# vim /etc/yum.repos.d/nginx.repo </span><br><span class="line">[root@lb02 ~]# cat /etc/yum.repos.d/nginx.repo </span><br><span class="line">[nginx]</span><br><span class="line">name=nginx repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/7/$basearch/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">[root@lb02 ~]# yum install nginx -y</span><br><span class="line"></span><br><span class="line">2.在lb02上面拷贝lb02的所有nginx相关配置即可。</span><br><span class="line">[root@lb02 ~]# scp -rp root@192.168.160.161:/etc/nginx/ /etc/</span><br><span class="line"></span><br><span class="line">3.启动nginx</span><br><span class="line">[root@lb02 conf.d]# nginx -t</span><br><span class="line">[root@lb02 conf.d]# systemctl start nginx</span><br><span class="line">[root@lb02 conf.d]# systemctl enable nginx</span><br><span class="line"></span><br><span class="line">zh.oldboy.com 报错</span><br><span class="line">[root@web02 ~]# vim /etc/php.ini </span><br><span class="line">session.auto_start = 1 → 0</span><br><span class="line"></span><br><span class="line">4.配置nginx四层负载均衡</span><br><span class="line">stream  --with-stream  tcp</span><br><span class="line"></span><br><span class="line">[root@lb02 ~]# vim /etc/yum.repos.d/nginx.repo </span><br><span class="line">[root@lb02 ~]# cat /etc/yum.repos.d/nginx.repo </span><br><span class="line">[nginx]</span><br><span class="line">name=nginx repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/7/$basearch/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">[root@lb02 ~]# yum install nginx -y</span><br><span class="line">[root@lb4_01 ~]# vim /etc/nginx/nginx.conf </span><br><span class="line">events &#123;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br><span class="line">include /etc/nginx/conf.c/*.conf;</span><br><span class="line">http &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">3.创建存放四层负载均衡配置的目录</span><br><span class="line">[root@lb4_01 conf.c]# rm -f /etc/nginx/conf.d/default.conf  #删除http的80端口</span><br><span class="line">[root@lb4_01 ~]# mkdir /etc/nginx/conf.c</span><br><span class="line">[root@lb4_01 ~]# cd /etc/nginx/conf.c</span><br><span class="line">[root@lb4_01 conf.c]# vim lb_domain.conf</span><br><span class="line">stream &#123;</span><br><span class="line">    upstream lb &#123;</span><br><span class="line">        server 192.168.160.161:80 weight=5 max_fails=3 fail_timeout=30s;</span><br><span class="line">        server 192.168.160.169:80 weight=5 max_fails=3 fail_timeout=30s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        proxy_connect_timeout 3s;</span><br><span class="line">        proxy_pass lb;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">4.重载服务</span><br><span class="line">[root@lb4_01 conf.c]# nginx -t</span><br><span class="line">[root@lb4_01 conf.c]# systemctl restart nginx</span><br><span class="line">[root@lb4_01 conf.c]# systemctl enable nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">使用nginx四层负载均衡实现tcp的转发</span><br><span class="line">请求负载均衡5555  ---&gt;  172.16.1.7:22;</span><br><span class="line">请求负载均衡6666  ---&gt;  172.16.1.51:3306;</span><br><span class="line"></span><br><span class="line">[root@lb4_01 conf.c]# cat /etc/nginx/conf.c/lb_domain.conf </span><br><span class="line">stream &#123;</span><br><span class="line">log_format proxy &#x27;$remote_addr $remote_port - [$time_local] $status $protocol &#x27;</span><br><span class="line">                 &#x27;&quot;$upstream_addr&quot; &quot;$upstream_bytes_sent&quot; &quot;$upstream_connect_time&quot;&#x27; ;</span><br><span class="line">    access_log /var/log/nginx/proxy.log proxy;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">定义转发ssh的22端口</span></span><br><span class="line">        upstream ssh_7 &#123;</span><br><span class="line">                server 192.168.160.149:22;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">定义转发mysql的3306端口</span></span><br><span class="line">        upstream mysql_51 &#123;</span><br><span class="line">                server 192.168.160.151:3306;</span><br><span class="line">        &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 5555;</span><br><span class="line">        proxy_connect_timeout 3s;</span><br><span class="line">        proxy_timeout 300s;</span><br><span class="line">        proxy_pass ssh_7;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 6666;</span><br><span class="line">        proxy_connect_timeout 3s;</span><br><span class="line">        proxy_timeout 3s;</span><br><span class="line">        proxy_pass mysql_51;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">nginx四层负载均衡记录日志</span><br><span class="line">[root@lb4_01 conf.c]# vim lb_domain.conf </span><br><span class="line">stream &#123;</span><br><span class="line">log_format proxy &#x27;$remote_addr $remote_port - $msec - [$time_local] $status $protocol &#x27;</span><br><span class="line">                 &#x27;&quot;$upstream_addr&quot; &quot;$upstream_bytes_sent&quot; &quot;$upstream_connect_time&quot;&#x27; ;</span><br><span class="line">    access_log /var/log/nginx/proxy.log proxy;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">日志展示效果</span><br><span class="line">[root@lb4_01 conf.c]# tail -f /var/log/nginx/proxy.log </span><br><span class="line">192.168.160.1 5252 - [15/Mar/2022:23:03:34 +0800] 200 TCP &quot;192.168.160.151:3306&quot; &quot;62&quot; &quot;0.001&quot;</span><br><span class="line">192.168.160.1 5255 - [15/Mar/2022:23:03:37 +0800] 200 TCP &quot;192.168.160.151:3306&quot; &quot;62&quot; &quot;0.000&quot;</span><br><span class="line">192.168.160.1 5264 - [15/Mar/2022:23:03:45 +0800] 200 TCP &quot;192.168.160.151:3306&quot; &quot;64&quot; &quot;0.001&quot;</span><br><span class="line">192.168.160.1 5273 - [15/Mar/2022:23:03:55 +0800] 200 TCP &quot;192.168.160.151:3306&quot; &quot;88&quot; &quot;0.001&quot;</span><br><span class="line">192.168.160.1 5279 - [15/Mar/2022:23:04:03 +0800] 200 TCP &quot;192.168.160.151:3306&quot; &quot;177&quot; &quot;0.000&quot;</span><br><span class="line">192.168.160.1 5295 - [15/Mar/2022:23:04:22 +0800] 200 TCP &quot;192.168.160.151:3306&quot; &quot;177&quot; &quot;0.000&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="day-38-nginx动静分离"><a href="#day-38-nginx动静分离" class="headerlink" title="day-38-nginx动静分离"></a><strong>day-38-nginx动静分离</strong></h2><p><img src="D:\文件管理\Typora\images\linux.assest\1ea03a27843e45e28210f0b720ad8b50.jpg" alt="img"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">四层负载均衡</span><br><span class="line">四层  内核空间  转发  传输层（tcp、udp转发）</span><br><span class="line">七层  用户空间  代理  应用层（域名匹配，路径规则控制、安全、限速、等）</span><br><span class="line"></span><br><span class="line">动静分离</span><br><span class="line">    单台服务器实现动静分离</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code/wordpress;</span><br><span class="line">        index.php;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~* ^.*\.(png|jpg|mp4|)$&#123;</span><br><span class="line">        root /code/wordpress/images;</span><br><span class="line">        gzip on;</span><br><span class="line">        .....</span><br><span class="line">    &#125;</span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">        .....</span><br><span class="line">    &#125;</span><br><span class="line">    blog.oldboy.com/index.php</span><br></pre></td></tr></table></figure>

<p><strong>1.Nginx动静分离基不概述</strong></p>
<p>动静分离，通过中间件将动静分离和静态请求进行分离。</p>
<p>那为什么要通过中间件将动态请求和静态请求进行分离？减少不必要的请求消耗，同时能减少请求的延时。</p>
<p><strong>通过中间件将动态请求和静态请求分离，逻辑图如下</strong></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647566974221.png" alt="img"></p>
<p>动静分离只有好处：动静分离后，即使动态服务不可用，但静态资源不会受到影响</p>
<p><strong>2.Nginx动静分离场景实践</strong></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\747fe273c2a9464997e1a32f1b06f4a8.jpg" alt="img"></p>
<p>Nginx动静分离实践应用案例</p>
<p>0.环境准备</p>
<table>
<thead>
<tr>
<th><strong>系统</strong></th>
<th><strong>服务</strong></th>
<th><strong>服务</strong></th>
<th><strong>地址</strong></th>
</tr>
</thead>
<tbody><tr>
<td>CentOS7.5</td>
<td>负载均衡</td>
<td>Nginx Proxy</td>
<td>10.0.0.5</td>
</tr>
<tr>
<td>CentOS7.5</td>
<td>静态资源</td>
<td>Nginx Static</td>
<td>10.0.0.7</td>
</tr>
<tr>
<td>CentOS7.5</td>
<td>动态资源</td>
<td>Tomcat Server</td>
<td>10.0.0.8</td>
</tr>
</tbody></table>
<p>1.在10.0.0.7服务器上配置静态资源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 conf.d]# cat ds_oldboy.conf</span><br><span class="line">server&#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name ds.oldboy.com;</span><br><span class="line">        root /soft/code;</span><br><span class="line">        index index.html;</span><br><span class="line">        </span><br><span class="line">        location ~* .*\.(png|jpg|gif)$ &#123;</span><br><span class="line">                root /soft/code/images;</span><br><span class="line">        &#125;</span><br><span class="line">        location ~ \.php &#123;</span><br><span class="line">            fastcgi_pass;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">准备目录，以及静态相关图片</span></span><br><span class="line">[root@web01 ~]# mkdir /soft/code/images -p</span><br><span class="line">[root@web01 ~]# wget -O /soft/code/images/nginx.png http://nginx.org/nginx.png</span><br><span class="line">[root@web01 ~]# systemctl restart nginx</span><br></pre></td></tr></table></figure>

<p>2.在10.0.0.8服务器上配置动态资源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]# yum install -y tomcat</span><br><span class="line">[root@web01 ~]# mkdir /usr/share/tomcat/webapps/ROOT</span><br><span class="line">[root@web01 ~]# vim /usr/share/tomcat/webapps/ROOT/java_test.jsp</span><br><span class="line">&lt;%@ page language=&quot;java&quot; import=&quot;java.util.*&quot; pageEncoding=&quot;utf-8&quot;%&gt;</span><br><span class="line">&lt;HTML&gt;</span><br><span class="line">    &lt;HEAD&gt;</span><br><span class="line">        &lt;TITLE&gt;JSP Test Page&lt;/TITLE&gt;</span><br><span class="line">    &lt;/HEAD&gt;</span><br><span class="line">    &lt;BODY&gt;</span><br><span class="line">      &lt;%</span><br><span class="line">        Random rand = new Random();</span><br><span class="line">        out.println(&quot;&lt;h1&gt;Random number:&lt;/h1&gt;&quot;);</span><br><span class="line">        out.println(rand.nextInt(99)+100);</span><br><span class="line">      %&gt;</span><br><span class="line">    &lt;/BODY&gt;</span><br><span class="line">&lt;/HTML&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重启tomcat服务</span></span><br><span class="line">[root@web01 ~]# systemctl start tomcat</span><br><span class="line">[root@web01 ~]# netstat -lntp</span><br></pre></td></tr></table></figure>

<p>3.在负载均衡10.0.0.5上配置调度，实现访问jsp和png</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 conf.d]# vim proxy_ds.conf </span><br><span class="line">[root@lb01 conf.d]# cat proxy_ds.conf </span><br><span class="line">upstream static &#123;</span><br><span class="line">        server 192.168.160.149:80;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">upstream java &#123;</span><br><span class="line">        server 192.168.160.157:8080;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name ds.oldboy.com;</span><br><span class="line"></span><br><span class="line">        location ~* .*\.(png|gif|jpg)$ &#123;</span><br><span class="line">                proxy_pass http://static;</span><br><span class="line">                proxy_set_header Host $http_host;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location ~ \.jsp &#123;</span><br><span class="line">                proxy_pass http://java;</span><br><span class="line">                proxy_set_header Host $http_host;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4.通过负载测试访问静态资源</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647566979274.png" alt="img"></p>
<p>5.通过负载测试访问动态资源</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647566980539.png" alt="img"></p>
<p>6.在负载均衡10.0.0.5上整合动态和静态资源的html文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 ~]# mkdir /soft/code -p</span><br><span class="line">[root@lb01 ~]# cat /soft/code/index.html</span><br><span class="line"></span><br><span class="line">[root@lb01 conf.d]# mkdir /code</span><br><span class="line">[root@lb01 conf.d]# vim /code/index.html</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot; /&gt;</span><br><span class="line">    &lt;title&gt;测试ajax和跨域访问&lt;/title&gt;</span><br><span class="line">    &lt;script src=&quot;http://libs.baidu.com/jquery/2.1.4/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">(document).ready(<span class="function"><span class="title">function</span></span>()&#123;</span></span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">        type: &quot;GET&quot;,</span><br><span class="line">        url: &quot;http://ds.oldboy.com/java_test.jsp&quot;,</span><br><span class="line">        success: function(data) &#123;</span><br><span class="line">                $(&quot;#get_data&quot;).html(data)</span><br><span class="line">        &#125;,</span><br><span class="line">        error: function() &#123;</span><br><span class="line">        alert (&quot;fail!!,请刷新再试!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">        &lt;body&gt;</span><br><span class="line">                &lt;h1&gt;测试动静分离&lt;/h1&gt;</span><br><span class="line">                &lt;img src=&quot;http://ds.oldboy.com/nginx.png&quot;&gt;</span><br><span class="line">                &lt;div id=&quot;get_data&quot;&gt;&lt;/div&gt;</span><br><span class="line">        &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>7.测试动态和静态资源是否能正常加载在一个html文件中</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647566982759.png" alt="img"></p>
<p>8.当使用systemctl stop nginx 停止 Nginx后，会发现静态内容无法访问，动态内容依旧运行正常</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647566984979.png" alt="img"></p>
<p>9.当使用systemctl stop tomcat停止tomcat后，静态内容依旧能正常访问，动态内容将不会被请求到</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647566986835.png" alt="img"></p>
<p><strong>3.Nginx资源分离场景实践</strong></p>
<p><strong>Nginx通过负载均衡实现手机与PC调度至不同的后端节点应用案例</strong></p>
<p>1.根据iphone、安卓、pc跳转不同的页面环境规划</p>
<table>
<thead>
<tr>
<th><strong>系统版本</strong></th>
<th><strong>主机角色</strong></th>
<th><strong>外网IP</strong></th>
<th><strong>内网IP</strong></th>
<th><strong>提供端口</strong></th>
</tr>
</thead>
<tbody><tr>
<td>CentOS7.5</td>
<td>负载均衡</td>
<td>10.0.0.5</td>
<td>172.16.1.5</td>
<td>80</td>
</tr>
<tr>
<td>CentOS7.5</td>
<td>提供Android页面</td>
<td></td>
<td>172.16.1.7</td>
<td>9090</td>
</tr>
<tr>
<td>CentOS7.5</td>
<td>提供Iphone页面</td>
<td></td>
<td>172.16.1.7</td>
<td>9091</td>
</tr>
<tr>
<td>CentOS7.5</td>
<td>提供pc页面</td>
<td></td>
<td>172.16.1.7</td>
<td>9092</td>
</tr>
</tbody></table>
<p>2.配置后端WEB节点的Nginx配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 conf.d]# cat sj.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 9090;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code/android;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 9091;</span><br><span class="line">    location / &#123;</span><br><span class="line">    root /code/iphone;</span><br><span class="line">    index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 9092;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code/pc;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.为后端WEB节点配置对应的网站目录以及代码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 conf.d]# mkdir -p /code/&#123;android,iphone,pc&#125;</span><br><span class="line">[root@web01 conf.d]# echo &quot;PC&quot; &gt; /code/pc/index.html</span><br><span class="line">[root@web01 conf.d]# echo &quot;Iphone&quot; &gt; /code/iphone/index.html</span><br></pre></td></tr></table></figure>

<p>2.配置负载均衡服务，根据不同的浏览器调度到不同的资源池</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 conf.d]# vim proxy_sj.conf</span><br><span class="line">[root@lb01 conf.d]# cat proxy_sj.conf </span><br><span class="line">upstream android &#123;</span><br><span class="line">        server 192.168.160.149:9090;</span><br><span class="line">&#125;</span><br><span class="line">upstream iphone &#123;</span><br><span class="line">        server 192.168.160.149:9091;</span><br><span class="line">&#125;</span><br><span class="line">upstream pc &#123;</span><br><span class="line">        server 192.168.160.149:9092;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name sj.oldboy.com;</span><br><span class="line">        </span><br><span class="line">        location / &#123;</span><br><span class="line">                if ($http_user_agent ~* &quot;Android&quot;) &#123;</span><br><span class="line">                        proxy_pass http://android;</span><br><span class="line">                &#125;</span><br><span class="line">                if ($http_user_agent ~* &quot;Iphone&quot;) &#123;</span><br><span class="line">                        proxy_pass http://iphone;</span><br><span class="line">                &#125;</span><br><span class="line">                if ($http_user_agent ~* &quot;MSIE&quot;) &#123;</span><br><span class="line">                        return 403;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                proxy_pass http://pc;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">另一种写法  实际线上的配置</span></span><br><span class="line">[root@lb01 conf.d]# vim proxy_sj.conf</span><br><span class="line">[root@lb01 conf.d]# cat proxy_sj.conf </span><br><span class="line">upstream android &#123;</span><br><span class="line">        server 192.168.160.149:9090;</span><br><span class="line">&#125;</span><br><span class="line">upstream iphone &#123;</span><br><span class="line">        server 192.168.160.149:9091;</span><br><span class="line">&#125;</span><br><span class="line">upstream pc &#123;</span><br><span class="line">        server 192.168.160.149:9092;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name sj.oldboy.com;</span><br><span class="line">        if ($http_user_agent ~* &quot;Android|Iphone&quot;) &#123;</span><br><span class="line">                rewrite ^/$ http://www.jd.com redirect;  #如果来源的是&quot;android|iphone|ipod|windows\sphone&quot;）是跳转域名下面的m站（忽略大小写）</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag</span><br><span class="line">last       本条规则匹配完成后，停止匹配，不在匹配后面的规则</span><br><span class="line">break      本条规则匹配完成后，停止匹配，不在匹配后面的规则</span><br><span class="line">redirect   返回302临时重定向，地址栏会显示跳转后的地址</span><br><span class="line">permanent  返回301永久重定向，地址栏会显示跳转后的地址</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@bgx conf.d]# cat. rewrite.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name rewrite.oldboy.com;</span><br><span class="line">    root /code;</span><br><span class="line">    </span><br><span class="line">    location ~ ^/break &#123;</span><br><span class="line">        rewrite /break /test/ break;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~ ^/last &#123;</span><br><span class="line">        rewrite ^/last /test/ last;</span><br><span class="line">    &#125;</span><br><span class="line">    location /test/ &#123;</span><br><span class="line">        default_type application/json;</span><br><span class="line">        return 200 &#x27;ok&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">break:</span><br><span class="line">    1.请求rewrite.oldboy.com/break</span><br><span class="line">        首先：会去查找本地的/code/test/index.html;</span><br><span class="line">            如果找到了，则返回/code/test/index.html的内容；</span><br><span class="line">            如果没找到该目录则报错404，如果找到该目录没找到对应的文件则403</span><br><span class="line"></span><br><span class="line">last:</span><br><span class="line">    1.请求rewrite.oldboy.com/last</span><br><span class="line">        首先：会对当前server重新的发起一次请求，rewrite.oldbo.com/test/</span><br><span class="line">            如果有location匹配上，则直接返回该location的内容。</span><br><span class="line">            如果没有location匹配,/code/test/index.html;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">9.redirect和permanent都是一个跳转，那redirect和permanent区别在哪呢（实现https）</span><br><span class="line">redirect：每次请求都会询问服务器，如果当服务器不可用时，则会跳转失败。</span><br><span class="line">permanent：第一次请求会询问，浏览器会记录跳转的地址，第二次则不再询问服务器，直接通过浏览器缓存的地址跳转。</span><br><span class="line"></span><br><span class="line">[root@web0l conf.d]# vim rewrite.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name rewrite.oldboy.com;</span><br><span class="line">    root /code;</span><br><span class="line">    </span><br><span class="line">    location /oldboy &#123;</span><br><span class="line">    #rewrite ^(.*)$ https://www.xuliangwei.com redirect;</span><br><span class="line">    rewrite ^(.*)$ https://www.xuliangwei.com permanent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">http://www.bgx.com/abc/1.html ==&gt; http://www.bgx.com/ccc/bbb/2.html</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.准备真实的访问路径</span></span><br><span class="line">[root@web03 ~]# mkdir /code/ccc/bbb -p</span><br><span class="line">[root@web03 ~]# echo &quot;ccc_bbb_2&quot;&gt; /code/ccc/bbb/2.html</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.Nginx跳转配置</span></span><br><span class="line">[root@web03 conf.d]# cat ccbb.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">        root /code;</span><br><span class="line">        index index.html;</span><br><span class="line">    &#125;</span><br><span class="line">    location /abc &#123;</span><br><span class="line">        rewrite (.*)/ccc/bbb/2.html redirect;</span><br><span class="line">        #return 302 /ccc/bbb/2.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@web01 conf.d]# mkdir /code/ccc/bbb/ -p</span><br><span class="line">[root@web01 conf.d]# echo &quot;ccc_bbb_123&quot; &gt; /code/ccc/bbb/index.html</span><br><span class="line">[root@web01 conf.d]# vim rewrite.conf </span><br><span class="line">[root@web01 conf.d]# cat rewrite.conf </span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name rewrite.oldboy.com;</span><br><span class="line">    root /code;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">                index index.html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location ~ \/abc &#123;</span><br><span class="line">                rewrite ^(.*)$ /ccc/bbb/index.html redirect;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">http://www.bgx.com/2018/ccc/bbb/2.html ==&gt; http://www.bgx.com/2014/ccc/bbb/2.html</span></span><br><span class="line"></span><br><span class="line">[root@web01 conf.d]# mkdir /code/2014/ccc/bbb/ -p</span><br><span class="line">[root@web01 conf.d]# echo &quot;old1&quot; &gt; /code/2014/ccc/bbb/1.html</span><br><span class="line">[root@web01 conf.d]# echo &quot;old2&quot; &gt; /code/2014/ccc/bbb/2.html</span><br><span class="line">[root@web01 conf.d]# vim rewrite.conf </span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name rewrite.oldboy.com;</span><br><span class="line">    root /code;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">                index index.html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location ~ \/abc &#123;</span><br><span class="line">                rewrite ^(.*)$ /ccc/bbb/index.html redirect;</span><br><span class="line">        &#125;</span><br><span class="line">        location ~ /2018 &#123;</span><br><span class="line">                rewrite ^/2018/(.*) /2014/$1 redirect;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">例4：用户访问course-11-22-33.html实际上真实访问是/course/11/22/33/course_33.html</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">http://www.bgx.com/course-11-22-33.html ==&gt; http://www.bgx.com/course/11/22/33/course 33.html</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">http://www.bgx.com/course-44-55-66.html ==&gt; http://www.bgx.com/course/44/55/66/course_66.html</span></span><br><span class="line"></span><br><span class="line">[root@web01 conf.d]# mkdir /code/course/11/22/33/ -p</span><br><span class="line">[root@web01 conf.d]# mkdir /code/course/44/55/66/ -p</span><br><span class="line">[root@web01 conf.d]# echo &quot;123&quot; &gt; /code/course/11/22/33/course_33.html</span><br><span class="line">[root@web01 conf.d]# echo &quot;456&quot; &gt; /code/course/44/55/66/course_66.html</span><br><span class="line">[root@web01 conf.d]# vim rewrite.conf </span><br><span class="line">[root@web01 conf.d]# cat rewrite.conf </span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name rewrite.oldboy.com;</span><br><span class="line">    root /code;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">                index index.html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location ~ \/abc &#123;</span><br><span class="line">                rewrite ^(.*)$ /ccc/bbb/index.html redirect;</span><br><span class="line">        &#125;</span><br><span class="line">        location ~ /2018 &#123; </span><br><span class="line">                rewrite ^/2018/(.*) /2014/$1 redirect;</span><br><span class="line">        &#125;</span><br><span class="line">        location /test &#123;</span><br><span class="line">                rewrite ^(.*)$ http://www.xuliangwei.com redirect;</span><br><span class="line">        &#125;</span><br><span class="line">        location ~ ^/course &#123;</span><br><span class="line">                rewrite (.*)-(.*)-(.*)-(.*)\.(.*) /$1/$2/$3/$4/$1_$4.$5 break;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">例5：将http请求，跳转至https</span><br><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name bgx.com;</span><br><span class="line">        rewrite ^(.*) https://$server_names1 redirect;</span><br><span class="line">        #return 302 https://$server_name$request_uri;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name bgx.com;</span><br><span class="line">    ssl on;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>1.Rewrite基本概述</strong></p>
<p><strong>1.什么是rewrite</strong></p>
<p>Rewrite主要实现url地址重写,以及重定向,就是把传入Web的请求重定向到其他URL的过程。</p>
<p><strong>2.Rewrite使用场景</strong></p>
<p>1.地址跳转，用户访问<a target="_blank" rel="noopener" href="http://www.oldboyedu.com/sz%E8%BF%99%E4%B8%AAURL%E6%97%B6,%E5%B0%86%E5%85%B6%E5%AE%9A%E5%90%91%E8%87%B3%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%E5%9F%9F%E5%90%8Dsz.oldboyedu.com">www.oldboyedu.com/sz这个URL时,将其定向至一个新的域名sz.oldboyedu.com</a></p>
<p>2.协议跳转，用户通过http协议请求网站时，将其重新跳转至https协议方式</p>
<p>2.伪静态，将动态页面显示为静态页面方式的一种技术，便于搜索引擎的录入，同时减少动态URL地址对外暴</p>
<p>露过多的参数，提升更高的安全性。</p>
<p>3.搜索引擎，SEO优化依赖于url路径，好记的url便于支持搜索引擎录入</p>
<p><strong>3.Rewrite配置示例</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Syntax: rewrite regex replacement [flag];</span><br><span class="line">Default: --</span><br><span class="line">Context: server, location, if</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">用于切换维护页面场景</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">rewrite ^(.*)$ /page/maintain.html <span class="built_in">break</span>;</span></span><br></pre></td></tr></table></figure>

<p>2.Rewrite标记Flag</p>
<p>rewrite指令根据表达式来重定向uRI,或者修改字符串。可以应用于server,location,if环境下,每</p>
<p>行rewrite指令最后跟一个flag标记，支持的flag标记有如下表格所示：</p>
<table>
<thead>
<tr>
<th><strong>flag</strong></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>last</td>
<td>本条规则匹配完成后，停止匹配，不在匹配后面的规则</td>
</tr>
<tr>
<td>break</td>
<td>本条规则匹配完成后，停止匹配，不在匹配后面的规则</td>
</tr>
<tr>
<td>redirect</td>
<td>返回302临时重定向，地址栏会显示跳转后的地址</td>
</tr>
<tr>
<td>permanent</td>
<td>返回301永久重定向，地址栏会显示跳转后的地址</td>
</tr>
</tbody></table>
<p>1.last与break区别对比示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx conf.d]# cat. rewrite.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name rewrite.oldboy.com;</span><br><span class="line">    root /code;</span><br><span class="line">    </span><br><span class="line">    location ~ ^/break &#123;</span><br><span class="line">        rewrite /break /test/ break;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~ ^/last &#123;</span><br><span class="line">        rewrite ^/last /test/ last;</span><br><span class="line">    &#125;</span><br><span class="line">    location /test/ &#123;</span><br><span class="line">        default_type application/json;</span><br><span class="line">        return 200 &#x27;ok&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重启Nginx服务</span></span><br><span class="line">[root@bgx conf.d]# systemctl restart nginx</span><br></pre></td></tr></table></figure>

<p>4.last和break 都是一个作用，都是表示停止rewrite规则，那last和break区别在哪呢</p>
<p>break只要匹配到规则，则会去本地路径中目录中寻找请求的文件。</p>
<p>last只要匹配到规则，会对其所在的server{.….}标签重新发起请求。</p>
<p>所以，在访问&#x2F;break和&#x2F;last请求时，虽然对应的请求目录&#x2F;test都是不存在了，理论上都应该返回404,但是实际请求&#x2F;last的时候，是会有后面localtion所匹配到的结果返回的。原因正在于此。</p>
<p>5.redirect与permanent区别对比示例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ~]<span class="comment"># cat /etc/nginx/conf.d/rewrite.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name rewrite.oldboy.com;</span><br><span class="line">    root /code;</span><br><span class="line">    </span><br><span class="line">    location ~ /bgx &#123;</span><br><span class="line">    rewrite ^(.*)$ https://www.xuliangwei.com redirect;</span><br><span class="line">    rewrite ^(.*)$ https://www.xuliangwei.com permanent;</span><br><span class="line">    <span class="comment">#return 301 http://kt.xuliangwei.com;</span></span><br><span class="line">    <span class="comment">#return 302 http://kt.xuliangwei.com;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5.通过浏览器访问，redirect会进行302跳转</p>
<h2 id="day-38-nginx-https"><a href="#day-38-nginx-https" class="headerlink" title="day-38-nginx-https"></a><strong>day-38-nginx-https</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">动静分离</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">http_user_agent</span></span><br><span class="line">手机</span><br><span class="line">    iphone</span><br><span class="line">    andriod</span><br><span class="line">电脑</span><br><span class="line">rewrite  url替换  rewrite  正则  真实的文件  flag</span><br><span class="line">return  http-&gt;https  return  状态码  跳转后的地址（可以使用变量）</span><br><span class="line">    301  permanent</span><br><span class="line">    302  redirect</span><br><span class="line">    </span><br><span class="line">    break:</span><br><span class="line">    last::</span><br><span class="line"></span><br><span class="line">sub_filter &#x27;&#x27; &#x27;&#x27;;  #nginx 代理 替换代码模块</span><br><span class="line"></span><br><span class="line">Nginx RewriteI</span><br></pre></td></tr></table></figure>



<p><strong>1.HTTPS安全证书基本概述</strong></p>
<p>为什么需要使用HTTPS，因为HTTP不安全。当我们使用http网站时，会遭到劫持和篡改，如果采用https协议，那么数据在传输过程中是加密的，所以黑客无法窃取或者篡改数据报文信息，同时也避免网站传输时信息泄露。</p>
<p>那么我们在实现https时，需要了解ssl协议，但我们现在使用的更多的是TLS加密协议。</p>
<p>那么TLS是怎么保证明文消息被加密的呢？在OSI七层模型中，应用层是http协议，那么在应用层协议之下，我们的表示层，是ssl协议所发挥作用的一层，它通过（握手、交换秘钥、告警、加密）等方式，使应用层http协议没有感知的情况下做到了数据的安全加密</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647566994349.png" alt="img"></p>
<p>那么在数据进行加密与解密过程中，如何确定双方的身份，此时就需要有一个权威机构来验证双方省份。那么这个权威机构则是CA机构。那CA机构又是如何颁发证书</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647566995732.png" alt="img"></p>
<p>我们首先需要申请证书，需要进行登记，登记我是谁，我是什么组织，我想做什么，到了登记机构在通过CSR发给CA，CA中心通过后，CA中心会生成一对公钥和私钥，那么公钥会在CA证书链中保存，公钥和私钥证书订阅人拿到后，会将其部署在WEB服务器上</p>
<p>1.当浏览器访问我们的https站点时，它会去请求我们的证书</p>
<p>2.Nginx这样的web服务器会将我们的公钥证书发给浏览器</p>
<p>3.浏览器会去验证我们的证书是否是合法和有效的。</p>
<p>4.CA机构会将过期的证书放置在CRL服务器，那么CRL服务的验证效率是非常差的，所以CA又推出了OCSP响应程序，OCSP响应程序可以查询指定的一个证书是否过期，所以浏览器可以直接查询OCSP响应程序，但OCSP响应程序性能还不是很高。</p>
<p>5.Nginx会有一个OCSP的开关，当我们开启后，Nginx会主动上OCSP上查询，这样大量的客户端直接从Nginx获取，证书是否有效。</p>
<p><strong>那么证书究竟是怎样组成的呢，接下来我们看一下证书有哪几种类型？</strong></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647566998013.png" alt="img"></p>
<p>HTTPS证书的类型</p>
<p>DV</p>
<p>OV</p>
<p>EV</p>
<p><strong>HTTPS证书购买选择</strong></p>
<p>保护1个域名  www</p>
<p>保护5个域名  www images cdn test m</p>
<p>通配符域名  *.oldboy.com</p>
<p><strong>HTTPS注意事项</strong></p>
<p>Https不支持续费，证书到期需重新申请新并进行替换</p>
<p>Https不支持三级域名解析,如test.m.oldboy.com</p>
<p>Https显示绿色，说明整个网站的url都是https的。</p>
<p>Https显示黄色，因为网站代码中包含http的不安全连接。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">nginx必须有ssl模块</span></span><br><span class="line">[root@Nginx ~]# nginx -V</span><br><span class="line">--with-http ssl module</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建存放ssl证书的路径</span></span><br><span class="line">[root@Nginx ~]# mkdir -p /etc/nginx/ssl_key</span><br><span class="line">[root@Nginx ~]# cd /etc/nginx/ssl_key</span><br><span class="line"></span><br><span class="line">生成证书</span><br><span class="line">[root@Nginx ssh_key]# openssl genrsa -idea -out server.key 2048</span><br><span class="line">[root@Nginx ssl_key]# openssl req -days 36500 -x509 \</span><br><span class="line">-sha256 -nodes -newkey rsa:2048 -keyout server.key -out server.crt</span><br><span class="line"></span><br><span class="line">配置nginx</span><br><span class="line">[root@web01 conf.d]# vim s.oldboy.conf</span><br><span class="line">server &#123;</span><br><span class="line">        listen 443;</span><br><span class="line">        server_name s.oldboy.com</span><br><span class="line">        root /code;</span><br><span class="line">        ssl on;</span><br><span class="line">        ssl_certificate ssl_key/server.crt;</span><br><span class="line">        ssl_certificate_key ssl_key/server.key;</span><br><span class="line">        location / &#123;</span><br><span class="line">                index index.html;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">准备对应的站点目录，并重启Nginx服务</span></span><br><span class="line">[root@Nginx ~]# mkdir -p /code</span><br><span class="line">[root@web01 ssl_key]# echo &quot;Test Https&quot; &gt; /code/index.html</span><br><span class="line">[root@web01 ssl_key]# systemctl restart nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@web01 conf.d]# vim s.oldboy.conf</span><br><span class="line">server &#123;</span><br><span class="line">        listen 443;</span><br><span class="line">        server_name s.oldboy.com</span><br><span class="line">        root /code;</span><br><span class="line">        ssl on;</span><br><span class="line">        ssl_certificate ssl_key/server.crt;</span><br><span class="line">        ssl_certificate_key ssl_key/server.key;</span><br><span class="line">        location / &#123;</span><br><span class="line">                index index.html;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name s.oldboy.com;</span><br><span class="line">        return 302 https://$server_name$request_uri;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.配置2台web服务器都监听在80端口</span><br><span class="line">2.配置负载均衡，也监听在80端口，进行访问网站测试。</span><br><span class="line">3.在负载均衡器上管理我们的ssl证书。</span><br><span class="line"></span><br><span class="line">Nginx集群实现HTTPS实践</span><br><span class="line">如果希望http的流量全部导入到https上</span><br><span class="line">[root@lb01 conf.d]# vim proxy_s.conf </span><br><span class="line">[root@lb01 conf.d]# systemctl restart nginx</span><br><span class="line">[root@lb01 conf.d]# cat proxy_s.conf </span><br><span class="line">upstream website &#123;</span><br><span class="line">        server 192.168.160.149:80;</span><br><span class="line">        server 192.168.160.157:80;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">        listen 443;</span><br><span class="line">        server_name s.oldboy.com;</span><br><span class="line">        ssl on;</span><br><span class="line">        ssl_certificate ssl_key/server.crt;</span><br><span class="line">        ssl_certificate_key ssl_key/server.key;</span><br><span class="line">        location / &#123;</span><br><span class="line">                proxy_pass http://website;</span><br><span class="line">                proxy_set_header Host $http_host;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name s.oldboy.com;</span><br><span class="line">        return 302 https://$server_name$request_uri;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">blog和zh修改为https</span><br><span class="line">负载均衡器的配置</span><br><span class="line">[root@lb01 conf.d]# cat proxy_oldboy.com.conf </span><br><span class="line">upstream node &#123;</span><br><span class="line">        server 192.168.160.149:80 weight=5;</span><br><span class="line">        server 192.168.160.157:80 weight=1;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name blog.oldboy.com;</span><br><span class="line">        return 302 https://$server_name$request_uri;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">        listen 443;</span><br><span class="line">        server_name blog.oldboy.com;</span><br><span class="line">        ssl on;</span><br><span class="line">        ssl_certificate ssl_key/server.crt;</span><br><span class="line">        ssl_certificate_key ssl_key/server.key;</span><br><span class="line">        location / &#123;</span><br><span class="line">                proxy_pass http://node;</span><br><span class="line">                proxy_next_upstream error timeout http_500 http_502 http_503 http_504;</span><br><span class="line">                include proxy_params;</span><br><span class="line">         &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name zh.oldboy.com;</span><br><span class="line">        return 302 https://$server_name$request_uri;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen 443;</span><br><span class="line">        server_name zh.oldboy.com;</span><br><span class="line">        ssl on;</span><br><span class="line">        ssl_certificate ssl_key/server.crt;</span><br><span class="line">        ssl_certificate_key ssl_key/server.key;</span><br><span class="line">        location / &#123;</span><br><span class="line">                proxy_pass http://node;</span><br><span class="line">                include proxy_params;</span><br><span class="line">                proxy_next_upstream error timeout http_500 http_502 http_503 http_504;</span><br><span class="line">         &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">blog和zh修改为https后，导致破图</span><br><span class="line">需要添加fastcgi_param HTTPS on; 使https支持php文件</span><br><span class="line">fastcgi_param HTTPS on; 参数是添加在后端的web上。</span><br><span class="line"></span><br><span class="line">后端web的配置</span><br><span class="line">[root@web01 conf.d]# cat zh.oldboy.com.conf </span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name zh.oldboy.com;</span><br><span class="line">    root /code/zh;</span><br><span class="line">    client_max_body_size 100m;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        index index.php index.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">        fastcgi_param HTTPS on;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">推荐配置</span><br><span class="line">ssl on;</span><br><span class="line">ssl_certificate ssl_key/server.crt;</span><br><span class="line">ssl_certificate_key ssl_key/server.key;</span><br><span class="line">ssl_session_cache shared:SSL:lm;  #在建立完ssl握手后如果断开连接，在session_timeout时间内再次连接，是不需要在次建立握手，可以复用之前的连接</span><br><span class="line">ssl_session_timeout 1440m;  #ssL连接断开后的超时时间</span><br><span class="line">ssl_protocols TLSv1 TLSv1.1 TLSv1.2;  #使用的TLS版本协议</span><br><span class="line">ssl_prefer_server_ciphers on;  #Nginx决定使用哪些协议与浏览器进行通讯</span><br><span class="line">ssL_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;  #配置加密套件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">公网单台服务器配置https</span><br><span class="line">server &#123;</span><br><span class="line">        listen 443:</span><br><span class="line">        server_name blog.lingxiao998.com;</span><br><span class="line">        root /code/wordpress;</span><br><span class="line">        client_max_body_size 100m;</span><br><span class="line">        ssl on;</span><br><span class="line">        ssl_certificate ssl_key/1775624_blog.lingxiao998.com.pem;</span><br><span class="line">        ssl_certificate_key ssl_key/1775624_blog.lingxiao998.com.key;</span><br><span class="line">        ssl_session_cache shared:SSL:lm;</span><br><span class="line">        ssl session timeout 1440m;</span><br><span class="line">        ssl_protocols TLSvl TLSvl.1 TLSvl.2;</span><br><span class="line">        ssl_prefer_server_ciphers on;</span><br><span class="line">        ssL_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name blog.lingxiao998.com;</span><br><span class="line">    return 302 https://$server_name$request_uri;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ssl发展史</span><br><span class="line">ca证书机构如何颁发证书。怎么配置证书，浏览器怎么验证证书。</span><br><span class="line">配置https证书,nginx+web集群配置https   php fastcgi_param HTTPS on;</span><br><span class="line">阿里云配置单台  阿里云配置SLB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">实现全站https （30-40分钟）</span><br><span class="line">nginx+多台web+nfs+数据库+redis+https</span><br><span class="line">wordpress</span><br><span class="line">zh</span><br><span class="line">phpmyadmin</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>2.Nginx单台实现HTTPS实战</strong></p>
<p>1.环境准备</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">nginx必须有ssl模块</span> </span><br><span class="line">[root@Nginx ~]# nginx -V </span><br><span class="line">--with-http ssl module </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建存放ssl证书的路径</span> </span><br><span class="line">[root@Nginx ~]# mkdir -p /etc/nginx/ssl_key </span><br><span class="line">[root@Nginx ~]# cd /etc/nginx/ssl_key</span><br></pre></td></tr></table></figure>

<p>2.使用openssl命令充当CA权威机构创建证书（生产不使用此方式生成证书，不被互联网认可的黑户证书）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ssh_key]# openssl genrsa -idea -out server.key 2048 </span><br><span class="line">Generating RSA private key, 2048 bit long modulus </span><br><span class="line">.....+++ </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">记住配置密码，我这里是1234</span> </span><br><span class="line">Enter pass phrase for server.key: </span><br><span class="line">Verifying - Enter pass phrase for server.key:</span><br></pre></td></tr></table></figure>

<p>3.生成自签证书，同时去掉私钥的密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ssl_key]# openssl req -days 36500 -x509 \ </span><br><span class="line">-sha256 -nodes -newkey rsa:2048 -keyout server.key -out server.crt </span><br><span class="line"></span><br><span class="line">Country Name (2 letter code) [XX]:CN </span><br><span class="line">State or Province Name (full name) []:WH </span><br><span class="line">Locality Name (eg, city) [Default City]:WH </span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:edu </span><br><span class="line">Organizational Unit Name (eg, section) []:SA </span><br><span class="line">Common Name (eg, your name or your servers hostname) []:bgx </span><br><span class="line">Email Address []:bgx@foxmail.com </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">req --&gt;用于创建新的证书</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">new --&gt;表示创建的是新证书</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">×509 --&gt;表示定义证书的格式为标准格式</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">key --&gt;表示调用的私钥文件信息</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">out --&gt;表示输出证书文件信息</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">days --&gt;表示证书的有效期</span></span><br></pre></td></tr></table></figure>

<p>4.证书申请完成后需要了解Nginx如何配置Https</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动ssl功能</span> </span><br><span class="line">Syntax: ssl on | off; </span><br><span class="line">Default: ssl off; </span><br><span class="line">Context: http, server </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">证书文件</span> </span><br><span class="line">Syntax: ssl_certificate file; </span><br><span class="line">Default:- </span><br><span class="line">Context: http, server </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">私钥文件 Syntax:</span> </span><br><span class="line">ssl_certificate_key file; </span><br><span class="line">Default: – </span><br><span class="line">Context: http, server</span><br></pre></td></tr></table></figure>

<p>5.配置Nginx配置Https实例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ~]# cat /etc/nginx/conf.d/ssl.conf </span><br><span class="line">server &#123;    </span><br><span class="line">	listen 443;    </span><br><span class="line">	server_name s.oldboy.com;    </span><br><span class="line">	ssl on;    </span><br><span class="line">	ssl_certificate  ssl_key/server.crt;    </span><br><span class="line">	ssl_certificate_key  ssl_key/server.key;    </span><br><span class="line">	location / &#123;        </span><br><span class="line">		root /code;        </span><br><span class="line">		index index.html;    </span><br><span class="line">	&#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">准备对应的站点目录，并重启Nginx服务</span> </span><br><span class="line">[root@Nginx ~]# mkdir -p /code </span><br><span class="line">[root@Nginx ~]# echo &quot;Https&quot; &gt; /code/index.html </span><br><span class="line">[root@Nginx ~]# systemctl restart nginx</span><br></pre></td></tr></table></figure>

<p><strong>3.Nginx集群实现HTTPS实践</strong></p>
<p>实战Nginx负载均衡+Nginx WEB配置HTTPS安全</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\827f3fb48486466a96877e8e571711de.jpg" alt="img"></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647567004870.png" alt="img"></p>
<h2 id="day40-keepalived高可用"><a href="#day40-keepalived高可用" class="headerlink" title="day40-keepalived高可用"></a><strong>day40-keepalived高可用</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line">四层负载均衡 </span><br><span class="line">动静分离 </span><br><span class="line">rewrite   rewrite 正则 替换的字符串 flag标记 跳转 </span><br><span class="line">https   单台https  多台  SLB </span><br><span class="line"></span><br><span class="line">rewrite (.*)/forum-([0-9]+)-([0-9]+).html$  $1/forumdisplay.php?fid=$2&amp;page=$3 last; </span><br><span class="line">blog.oldboy.com/forum-123-123.html  blog.oldboy.com/forumdisplay.php?fid=123&amp;page=123 break;  </span><br><span class="line"></span><br><span class="line">1.什么是高可用。    </span><br><span class="line">	通常情况下，都是启动2台相同的业务系统，一台故障，另外一台自动接管。 </span><br><span class="line">2.高可用实现的工具。    </span><br><span class="line">	服务高可用，keepalived软件实现（硬件。） </span><br><span class="line">3.keepalived如何实现高可用？    </span><br><span class="line">	keepalived基于VRRP协议,虚拟路由冗余协议。 </span><br><span class="line">4.VRRP解决什么问题。 </span><br><span class="line">状态   IP        角色 </span><br><span class="line">节点1  10.0.0.5  Master </span><br><span class="line">节点2  10.0.0.6  Backup </span><br><span class="line">VIP    10.0.0.3 </span><br><span class="line"></span><br><span class="line">安装keepalived </span><br><span class="line">yum install keepalived -y </span><br><span class="line"></span><br><span class="line">配置Master的keepalived rpm -qc keepalived -y </span><br><span class="line">[root@lb01 conf.d]# vim /etc/keepalived/keepalived.conf  </span><br><span class="line">global_defs &#123;         #全局配置    </span><br><span class="line">router_id lb01    #表示身份 -&gt; 名称 </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;    </span><br><span class="line">    state MASTER    		#标识角色状态    </span><br><span class="line">    interface eth0    		#网卡绑定接口    </span><br><span class="line">    virtual_router_id 50    #虚拟路由id    </span><br><span class="line">    priority 150         	#优先级    </span><br><span class="line">    advert_int 1          	#监测间隔时间    </span><br><span class="line">    authentication &#123;       	#认证        </span><br><span class="line">    auth_type PASS       	#明文认证        </span><br><span class="line">    auth_pass 1111         	#明文密码 </span><br><span class="line">&#125;    </span><br><span class="line">virtual_ipaddress &#123;        </span><br><span class="line">10.0.0.3         #虚拟的VIP地址    </span><br><span class="line">&#125; </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">配置Backup的Keepalived </span><br><span class="line">[root@lb02 conf.d]# vim /etc/keepalived/keepalived.conf </span><br><span class="line">global_defs &#123;         #全局配置    </span><br><span class="line">router_id lb02    #表示身份 -&gt; 名称 </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;    </span><br><span class="line">state BACKUP    #标识角色状态    </span><br><span class="line">interface eth0    #网卡绑定接口   </span><br><span class="line">virtual_router_id 50    #虚拟路由id    </span><br><span class="line">priority 100             #优先级    </span><br><span class="line">advert_int 1             #监测间隔时间    </span><br><span class="line">authentication &#123;         #认证        </span><br><span class="line">auth_type PASS         #明文认证        </span><br><span class="line">auth_pass 1111         #明文密码 </span><br><span class="line">&#125;    </span><br><span class="line">virtual_ipaddress &#123;        </span><br><span class="line">10.0.0.3         #虚拟的VIP地址    </span><br><span class="line">&#125; </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">5.对比keepalived的master与backup配置的区别 </span><br><span class="line">Keepalived配置区别    Master配置      Backup节配置 </span><br><span class="line">route_id(唯一标识)    route_id lb01   route_id lb02 </span><br><span class="line">state(角色状态)       state Master    </span><br><span class="line">state Backup priority(竞选优先级）  priority 150    priority 100 </span><br><span class="line"></span><br><span class="line">启动keepalived </span><br><span class="line">[root@lb01 ~]# systemctl enable keepalived </span><br><span class="line">[root@lb01 ~]# systemctl start keepalived  </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置非抢占式</span> </span><br><span class="line">[root@lb01 conf.d]# vim /etc/keepalived/keepalived.conf </span><br><span class="line">global_defs &#123;    </span><br><span class="line">	router_id lb01 </span><br><span class="line">&#125; </span><br><span class="line">vrrp_instance VI_1 &#123;    </span><br><span class="line">    nopreempt    #非抢占式    </span><br><span class="line">    state BACKUP   #需要两台设备都是BACKUP    </span><br><span class="line">    interface eth0    </span><br><span class="line">    virtual_router_id 50    </span><br><span class="line">    priority 150    </span><br><span class="line">    advert_int 1    </span><br><span class="line">    authentication &#123;        </span><br><span class="line">    	auth_type PASS        </span><br><span class="line">    	auth_pass 1111 </span><br><span class="line">	&#125;    </span><br><span class="line">	virtual_ipaddress &#123;        </span><br><span class="line">		192.168.160.184    </span><br><span class="line">	&#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">5.配置非抢占式 </span><br><span class="line">1、两个节点的state都必须配置为BACKUP </span><br><span class="line">2、两个节点都必须加上配置 nopreempt </span><br><span class="line">3、其中一个节点的优先级必须要高于另外一个节点的优先级。 </span><br><span class="line">两台服务器都角色状态启用nopreempt后，必须修改角色状态统一为BACKUP，唯一的区分就是优先级。 </span><br><span class="line">引用官方文档对nopreempt字段的说明： &quot;nopreempt&quot; allows the lower priority machine to maintain the master role, even when a higher priority machine comes back online. </span><br><span class="line">NOTE: For this to work, the initial state of this entry must be BACKUP.</span><br><span class="line">根据上述描述，第一点提到的state必须配置为BACKUP就明白了。 </span><br><span class="line"></span><br><span class="line">Master </span><br><span class="line">vrrp_instance VI_1 &#123;    </span><br><span class="line">	state BACKUP    </span><br><span class="line">	priority 150    </span><br><span class="line">	nopreempt </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">Backup vrrp_instance VI_1 &#123;    </span><br><span class="line">	state BACKUP    </span><br><span class="line">	priority 100    </span><br><span class="line">	nopreempt </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">通过windows的arp去验证，是否会切换MAC地址、</span><br><span class="line">arp -a</span><br><span class="line"></span><br><span class="line">主和备都配置一样的角色，一样的优先级？？</span><br><span class="line"></span><br><span class="line">keepalived虚拟地址漂移与Nginx服务进行关联</span><br><span class="line">    1.Nginx默认监听在所有的IP地址上。</span><br><span class="line">    2.用户将域名解析到VIP上面即可。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">由于某些原因，导致两台keepalived高可用服务器在指定时间内，无法检测到对方的心跳消息，各自取得资源及服务的所有权，而此时的两台高可用服务器又都还活着。</span><br><span class="line"></span><br><span class="line">服务器网线松动等网络故障</span><br><span class="line">服务器硬件故障发生损坏现象而崩溃</span><br><span class="line">主备都开启firewalld防火墙</span><br><span class="line"></span><br><span class="line">如果发生闹裂，则随机kill掉一台即可。</span><br><span class="line"></span><br><span class="line">Nginx服务死掉等</span><br><span class="line">    1.会导致用户无法正常的访问到网站。</span><br><span class="line">    2.该服务器的VIp也不会进行漂移（因为keepalived与nginx是两个不同的软件）</span><br><span class="line"></span><br><span class="line">解决手段：</span><br><span class="line">	1.写个监控脚本，如果nginx停止运行，则尝试启动，如果尝试失败，则停止keepalived</span><br><span class="line">[root@lb02 ~]# cat check_split_brain.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">1b01_vip=10.0.0.3</span><br><span class="line">1b01_ip=10.0.0.5</span><br><span class="line">while true;do</span><br><span class="line">    ping -c 2 -W 3 $lb81_ip &amp;&gt;/dev/null</span><br><span class="line">    if [ $? -eq e -a ip add|grep &quot;$lb01_vip&quot;|wc -1&#x27; -eq 1 ];then</span><br><span class="line">    	echo &quot;ha is split brain.warning.&quot;</span><br><span class="line">    else</span><br><span class="line">    	echo &quot;ha is ok&quot;</span><br><span class="line">    fi</span><br><span class="line">sleep 5</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">编写脚本</span><br><span class="line">[root@lb01 ~]# mkdir /server/scripts</span><br><span class="line">[root@lb01 ~]# vim /server/scripts/check_web.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">nginxpid=$(ps -C nginx --no-header|wc -l)</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.判断Nginx是否存活，如果不存活则尝试启动Nginx</span></span><br><span class="line">if [ $nginxpid -eq 0 ];then</span><br><span class="line">    systemctl start nginx</span><br><span class="line">    sleep 3</span><br><span class="line">    #2.等待3秒后再次获取一次Nginx状态</span><br><span class="line">    nginxpid=$(ps -C nginx --no-header|wc -l)</span><br><span class="line">    #3.再次进行判断，如Nginx还不存活则停止Keepalived,让地址进行漂移,并退出脚本</span><br><span class="line">    if [ $nginxpid -eq 0 ];then</span><br><span class="line">    	systemctl stop keepalived</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">给脚本增加执行权限</span></span><br><span class="line">[root@lb01 ~]# chmod +x /server/scripts/check_web.sh</span><br><span class="line"></span><br><span class="line">在Master的keepalived中调用脚本，抢占式，仅需在master配置即可。（注意，如果配置为非抢占式，那么需要两台服务器都使用该脚本）</span><br><span class="line">[root@lb01 ~]# cat /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123;</span><br><span class="line">		router_id LVS_01</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.每5秒执行一次脚本，脚本执行内容不能超过5秒，否则会被中断再次重新运行脚本</span></span><br><span class="line">vrrp_script check_web &#123;</span><br><span class="line">	script &quot;/server/scripts/check_web.sh&quot;</span><br><span class="line">	interval 5</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	nopreempt</span><br><span class="line">	state MASTER</span><br><span class="line">	interface etho</span><br><span class="line">	virtual_router_id 50</span><br><span class="line">	priority 150</span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASs</span><br><span class="line">		auth_pass 1111</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		10.0.0.3</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta prompt_">	</span></span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">2.调用并运行该脚本</span></span><br><span class="line">	track_scpipt &#123;</span><br><span class="line">		check_web</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">公有云不支持keepalived、银行、金融、证券、国企</span><br></pre></td></tr></table></figure>

<p><strong>1.Keepalived高可用基本概述</strong></p>
<p><strong>1.什么是高可用</strong></p>
<p>一般是指2台机器启动着相同的业务系统,当有一台机器down机了，另外一台服务器能快速的接管，对于访问的用户是无感知的。</p>
<p><strong>2.高可用通常使用什么软件？</strong></p>
<p>通常服务高可用我们选择使用keepalived软件实现</p>
<p><strong>3.keepalived是如何实现高可用的?</strong></p>
<p>keepalived软件是基于VRRP协议实现的。VRRP虚拟路由冗余协议，主要用于解决单点故障问题</p>
<p><strong>4.那VRRP是如何诞生的，VRRP的原理又是什么？</strong></p>
<p>比如公司的网络是通过网关转换进行上网的，那如果该路由器故障了，网关无法转发报文了，此时所有人都将无法上网，这么时候怎么办呢？</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647567008230.png" alt="img"></p>
<p>通常做法是给路由增加一台备节点，但问题来了？如果我们的主网关master故障了，用户是需要手动修改网关指向Backup，如果用户过多修改起来会非常的麻烦。</p>
<p>第一个问题：假设用户将指向都修改到Backup路由器，那么Master路由器如果修复好了又该怎么办？</p>
<p>第二个问题：假设Master网关故障，我们将Backup网关配置为Master网关IP行不行?</p>
<p>其实上不行，因为PC第一次是通过ARP广播寻找到Master网关的Mac地址与IP地址，PC则会将Master网关的对应IP与MAC地址写入ARP缓存表中，那么PC第二次则会直接读取ARP缓存表中的MAC地址与IP地址，然后进行数据包的转发。此时PC转发的数据包还是会教给Master。（除非PC的ARP缓存表过期，在次发起ARP广播的时候才能正确获取Bakcup的Mac地址与对应的IP地址。）</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\clipboard-1647567009806.png" alt="img"></p>
<p>如何才能做到出现故障自动转移，此时VRRP就应运而生，我们的VRRP其实是通过软件或硬件的形式在Master和Backup外面增加一个虚拟MAC地址（简称VMAC)与虚拟IP地址(简称VIP)。那么在这种情况下，PC请求VIP的时候，无论是Master处理还是Backup处理，PC仅会在ARP缓存表中记录VMAC与VIP的对应关系。</p>
<p><strong>5.高可用keepalived使用场景</strong></p>
<p>通常业务系统需要保证7×24小时不DOWN机，比如公司内部OA系统，每天公司人员都需要使用，则不允许Down机。作为业务系统来说随时都可用</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\11f2dc5ae5a143d691fc02eadb625e10.jpg" alt="img"></p>
<p><strong>6.高可用核心概念总结</strong></p>
<p>1.如何确定谁是主节点谁是备节点。（投票选举？优先级？）</p>
<p>2.如果Master故障，Backup自动接管，那Master恢复后会夺权吗？（抢占式、非抢占式）</p>
<p>3.如果两台服务器都认为自己是Master会出现什么问题？（脑裂)</p>
<p><strong>2.Keepalived高可用安装配置</strong></p>
<p>1.实践环境，配置实现虚IP转移</p>
<table>
<thead>
<tr>
<th><strong>状态</strong></th>
<th><strong>IP</strong></th>
<th><strong>角色</strong></th>
</tr>
</thead>
<tbody><tr>
<td>节点1</td>
<td>10.0.0.5</td>
<td>Master</td>
</tr>
<tr>
<td>节点2</td>
<td>10.0.0.6</td>
<td>Backup</td>
</tr>
<tr>
<td>VIP</td>
<td>10.0.0.3</td>
<td></td>
</tr>
</tbody></table>
<p>2.在master与backup上分别安装keepalived</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 ~]# yum install keepalived -y </span><br><span class="line">[root@lb02 ~]# yum install keepalived -y</span><br></pre></td></tr></table></figure>

<p>3.配置节点1,Master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">[root@lb01~]# </span><span class="language-bash"><span class="built_in">cat</span> /etc/keepalived/keepalived.conf</span> </span><br><span class="line">global_defs &#123;    </span><br><span class="line">	router_id lb01 </span><br><span class="line">&#125; </span><br><span class="line">vrrp_instance VI_1 &#123;    </span><br><span class="line">    state MASTER    </span><br><span class="line">    interface eth0    </span><br><span class="line">    virtual_router_id 50    </span><br><span class="line">    priority 150    </span><br><span class="line">    advert_int 1    </span><br><span class="line">    authentication &#123;        </span><br><span class="line">    	auth_type PASS        </span><br><span class="line">    	auth_pass 1111 </span><br><span class="line">	&#125;    </span><br><span class="line">	virtual_ipaddress &#123;    </span><br><span class="line">		10.0.0.3    </span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4.配置节点2,Backup</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">[root@lb02~]# </span><span class="language-bash"><span class="built_in">cat</span> /etc/keepalived/keepalived.conf</span> </span><br><span class="line">global_defs &#123;    </span><br><span class="line">	router_id lb02 </span><br><span class="line">&#125; </span><br><span class="line">vrrp_instance VI_1 &#123;    </span><br><span class="line">    state BACKUP    </span><br><span class="line">    interface eth0    </span><br><span class="line">    virtual_router_id 50    </span><br><span class="line">    priority 100    </span><br><span class="line">    advert_int 1    </span><br><span class="line">    authentication &#123;        </span><br><span class="line">    	auth_type PASS        </span><br><span class="line">    	auth_pass 1111 </span><br><span class="line">&#125;    </span><br><span class="line">	virtual_ipaddress &#123;    	</span><br><span class="line">		10.0.0.3    </span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5.对比keepalived的master 与backup 配置的区别</p>
<table>
<thead>
<tr>
<th><strong>Keepalived配置区别</strong></th>
<th><strong>Master配置</strong></th>
<th><strong>Backup节配置</strong></th>
</tr>
</thead>
<tbody><tr>
<td>route_id(唯一标识)</td>
<td>route_id Ib01</td>
<td>route_id lb02</td>
</tr>
<tr>
<td>state(角色状态)</td>
<td>state Master</td>
<td>state Backup</td>
</tr>
<tr>
<td>priority(竞选优先级）</td>
<td>priority 150</td>
<td>priority 100</td>
</tr>
</tbody></table>
<p>6.启动Master与Backup节点的keepalived</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">lb01</span> </span><br><span class="line">[root@lb01 ~]# systemctl enable keepalived </span><br><span class="line">[root@lb01 ~]# systemctl start keepalived </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">lb02</span> </span><br><span class="line">[root@lb02 ~]# systemctl enable keepalived </span><br><span class="line">[root@lb02 ~]# systemctl start keepalived</span><br></pre></td></tr></table></figure>



<p><strong>4.keepalived高可用故障脑裂</strong><br>由于某些原因，导致两台keepalived高可用服务器在指定时间内，无法检测到对方的心跳消息，各自取得资源及服务的所有权，而此时的两台高可用服务器又都还活着。</p>
<blockquote>
<p>服务器网线松动等网络故障<br>服务器硬件故障发生损坏现象而崩溃<br>主备都开启firewalld防火墙<br>Nginx服务死掉等</p>
</blockquote>
<p>1.在备上编写检测脚本，测试如果能ping 通主并且备节点还有VIP 的话则认为产生了列脑</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@lb02 ~]# cat check_split_brain.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">1b01_vip=10.0.0.3</span><br><span class="line">1b01_ip=10.0.0.5</span><br><span class="line">while true;do</span><br><span class="line">    ping -c 2 -W 3 $lb81_ip &amp;&gt;/dev/null</span><br><span class="line">    if [ $? -eq e -a ip add|grep &quot;$lb01_vip&quot;|wc -1&#x27; -eq 1 ];then</span><br><span class="line">    	echo &quot;ha is split brain.warning.&quot;</span><br><span class="line">    else</span><br><span class="line">    	echo &quot;ha is ok&quot;</span><br><span class="line">    fi</span><br><span class="line">sleep 5</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>2.如果Nginx岩机,会导致用户请求失败，但Keepalived并不会进行切换，所以需要编写一个脚本检测Nginx的存活状态，如果不存活则kil nginx和eepalived</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 ~]# mkdir /server/scripts</span><br><span class="line">[root@lb01 ~]# vim /server/scripts/check_web.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">nginxpid=$(ps -C nginx --no-header|wc -l)</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.判断Nginx是否存活，如果不存活则尝试启动Nginx</span></span><br><span class="line">if [ $nginxpid -eq 0 ];then</span><br><span class="line">    systemctl start nginx</span><br><span class="line">    sleep 3</span><br><span class="line">    #2.等待3秒后再次获取一次Nginx状态</span><br><span class="line">    nginxpid=$(ps -C nginx --no-header|wc -l)</span><br><span class="line">    #3.再次进行判断，如Nginx还不存活则停止Keepalived,让地址进行漂移,并退出脚本</span><br><span class="line">    if [ $nginxpid -eq 0 ];then</span><br><span class="line">    	systemctl stop keepalived</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">给脚本增加执行权限</span></span><br><span class="line">[root@lb01 ~]# chmod +x /server/scripts/check_web.sh</span><br></pre></td></tr></table></figure>

<p>3.在b01主机的keepalived配置文件中调用此脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01 ~]# cat /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123;</span><br><span class="line">		router_id LVS_01</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.每5秒执行一次脚本，脚本执行内容不能超过5秒，否则会被中断再次重新运行脚本</span></span><br><span class="line">vrrp_script check_web &#123;</span><br><span class="line">	script &quot;/server/scripts/check_web.sh&quot;</span><br><span class="line">	interval 5</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	nopreempt</span><br><span class="line">	state MASTER</span><br><span class="line">	interface etho</span><br><span class="line">	virtual_router_id 50</span><br><span class="line">	priority 150</span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASs</span><br><span class="line">		auth_pass 1111</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		10.0.0.3</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta prompt_">	</span></span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">2.调用并运行该脚本</span></span><br><span class="line">	track_scpipt &#123;</span><br><span class="line">		check_web</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><strong>1.Nginx多Server优先级</strong></p>
<p>在开始处理一个http请求时,nginx会取出header头中的Host变量，与nginx.conf中每个server的server_name进行匹配，以此决定到底由哪一个server来处理这个请求。但nginx如配置多个相同的server_name，会导致server_name出现优先级访问冲突。</p>
<p>1.准备nginx对应的配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">1.多个server_name容易产生冲突，会按照如下顺序匹配    </span><br><span class="line">    1.首先选择所有的字符串完全匹配的server_name。(完全匹配)</span><br><span class="line">    2.选择通配符在前面的server_name，如*.bgx.com  www.bgx.com</span><br><span class="line">    3.选择通配符在后面的server_name，如bgx.\*   bgx.com  bgx.cn</span><br><span class="line">    4.最后选择使用正则表达式匹配的server_name</span><br><span class="line">    5.如果全部都没有匹配到，那么将选择在listen配置项后加入[default_server]的server块</span><br><span class="line">    6.如果没写，那么就找到匹配listen端口的第一个Server块的配置文件</span><br><span class="line">    </span><br><span class="line">2.如何通过default_server 禁止用户通过IP地址访问，或使用default_server进行导流</span><br><span class="line">禁止直接通过IP访问</span><br><span class="line">[root@web01 conf.d]# cat server4.conf </span><br><span class="line">server &#123;</span><br><span class="line">        listen 80 default_server;</span><br><span class="line">        server_name _;</span><br><span class="line">        return 503;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">导流</span><br><span class="line">[root@web01 conf.d]# cat server4.conf </span><br><span class="line">server &#123;</span><br><span class="line">        listen 80 default_server;</span><br><span class="line">        server_name _;</span><br><span class="line">        return 302 http://www.baidu.com;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">一台服务器配置多个server网站，如果配置都写在nginx.conf主配置文件中，会导致nginx.conf主配置文件变得非常庞大而且可读性非常的差。那么后期的维护就变得麻烦。</span><br><span class="line">假设现在希望快速的关闭一个站点，该怎么办?</span><br><span class="line">1.如果是写在nginx.conf中，则需要手动注释，比较麻烦</span><br><span class="line">2.如果是include的方式，那么仅需修改配置文件的扩展名，即可完成注释</span><br><span class="line">Include包含的作用是为了简化主配置文件，便于人类可读。</span><br><span class="line"></span><br><span class="line">inlcude /etc/nginx/online/*.conf   #线上使用的配置</span><br><span class="line">/etc/nginx/offline   #保留配置，不启用（下次使用在移动到online中）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root与alias路径匹配主要区别在于nginx如何解释ocation后面的uri，这会使两者分别以不同的方式将请求映射到服务器文件上，alias是一个目录别名的定义，root则是最上层目录的定义。</span><br><span class="line">root的处理结果是：root路径+location路径</span><br><span class="line">alias的处理结果是：使用alias路径替换location路径</span><br><span class="line"></span><br><span class="line">http://image.oldboy.com/image/1.png   root路径+location路径</span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name image.oldboy.com;</span><br><span class="line">	location /image/ &#123;</span><br><span class="line">		root /code;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http://image.oldboy.com/image/1.png   直接上alias定义的路径中去查找。</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name image.oldboy.com;</span><br><span class="line">	location /image/ &#123;</span><br><span class="line">		alias /code/;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">nginx的try_file路径匹配，按顺序检查文件是否存在</span><br><span class="line">[root@bgx ~]# cat /etc/nginx/conf.d/try_file.conf</span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name try.bgx.com;</span><br><span class="line">	root /code;</span><br><span class="line">	</span><br><span class="line">	location / &#123;</span><br><span class="line">		try_files $uri $uri/ /index.php;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">uri 匹配文件名，如用户请求try.oldboy.com/index.html那么<span class="variable">$uri</span>则会上对应的root指定的站点目录中查找是否存在该文件</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">uri/匹配目录下的文件，如用户请求try.oldboy.com/，那么<span class="variable">$uri</span>/则会上/对应root指定的站点目录中查找文件</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.当用户访问xx.com/index.html则由Nginx提供，如果Nginx没有该文件则由Tomcat服务提供该文件</span><br><span class="line">[root@web01 conf.d]# cat try.conf</span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name try.oldboy.com;</span><br><span class="line">	root /code;</span><br><span class="line">	index index.html;</span><br><span class="line">	location / &#123;</span><br><span class="line">		try_files $uri $uri/ @java_page;</span><br><span class="line">	&#125;</span><br><span class="line">	location @java_page &#123;</span><br><span class="line">		proxy_pass http://172.16.1.8:8080;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>5.多ServerName优先级总结,在开始处理一个HTTP请求时,Nginx会读取header(请求头)中的host，与每个server中的server_name进行匹配，来决定用哪一个server标签来完成处理这个请求。有可能一个Host与多个server中的server_name都匹配，这个时候就会更具匹配优先级来选择实际处理的server块。优先级匹配结果如下：</p>
<blockquote>
<p>1.首先选择所有的字符串完全匹配的server_name。(完全匹配)<br>2.选择通配符在前面的server_name，如*.bgx.com  <a target="_blank" rel="noopener" href="http://www.bgx.com/">www.bgx.com</a><br>3.选择通配符在后面的server_name，如bgx.*   bgx.com  bgx.cn<br>4.最后选择使用正则表达式匹配的server_name<br>5.如果全部都没有匹配到，那么将选择在listen配置项后加入[default_server]的server块<br>6.如果没写，那么就找到匹配listen端口的第一个Server块的配置文件</p>
</blockquote>
<p>注意：当出现多个相同的Server_Name情况下，配置文件排序优先使用则会先被调用，所以建议配置相同端口，不同域名，这样则不会出现域名访问冲突</p>
<p><strong>2.Nginx禁止IP直接访问</strong><br>当用户通过访问P或者未知域名访问你的网站的时候，你希望禁止显示任何有效内容，可以给他返回500，目前国内很多机房都要求网站主关闭空主机头，防止未备案的域名指向过来造成麻烦</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name www.xuliangwei.com	#这里指定自己的域名</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">listen 80 default_server;  	#默认优先返回</span><br><span class="line">server_name _;  			#空主机头或IP</span><br><span class="line">return 500;  				#返回500错误</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.也可以将流量集中导入自己的网站，只要做以下跳转设置就可以</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80 default_server;</span><br><span class="line">	return 302 https://www.xuliangwei.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>3.Nginx包含文件Include</strong></p>
<p>一台服务器配置多个server网站，如果配置都写在nginx.conf主配置文件中，会导致nginx.conf主配置文件变得非常庞大而且可读性非常的差。那么后期的维护就变得麻烦。<br>假设现在希望快速的关闭一个站点，该怎么办?<br>1.如果是写在nginx.conf中，则需要手动注释，比较麻烦<br>2.如果是include的方式，那么仅需修改配置文件的扩展名，即可完成注释</p>
<p>Include包含的作用是为了简化主配置文件，便于人类可读。</p>
<p><strong>4.Nginx路径root与alias</strong><br>root与alias路径匹配主要区别在于nginx如何解释ocation后面的uri，这会使两者分别以不同的方式将请求映射到服务器文件上，alias是一个目录别名的定义，root则是最上层目录的定义。<br>root的处理结果是：root路径+location路径<br>alias的处理结果是：使用alias路径替换location路径</p>
<p>1.root路径配置实例用户访问<a target="_blank" rel="noopener" href="http://www.xuliangwei.com/image/test.gif%EF%BC%8C%E5%AE%9E%E9%99%85%E4%B8%8ANginx%E4%BC%9A%E4%B8%8A/code/image/%E7%9B%AE%E5%BD%95%E4%B8%8B%E6%89%BE%E5%8E%BB%E6%89%BEtest.gif%E6%96%87%E4%BB%B6">www.xuliangwei.com/image/test.gif，实际上Nginx会上/code/image/目录下找去找test.gif文件</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name www.xuliangwei.com;</span><br><span class="line">	location /image/ &#123;</span><br><span class="line">		root /code;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>5.Nginx try_file路径匹配</strong></p>
<p>nginx的try_file路径匹配，按顺序检查文件是否存在</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx ~]# cat /etc/nginx/conf.d/try_file.conf</span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name try.bgx.com;</span><br><span class="line">	root /code;</span><br><span class="line">	</span><br><span class="line">	location / &#123;</span><br><span class="line">		try_files $uri /404.html /index.php;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.检查用户请求的uri内容是否存在本地，存在则解析</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.如果请求的url不存在，则访问对应站点目录中的404.html文件</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.最后交给index.php处理</span></span><br></pre></td></tr></table></figure>

<p><strong>6.Nginx调整上传文件大小</strong><br>在nginx使用过程中，上传文件的过程中，通常需要设置nginx报文大小限制。避免出现413 Request Entity Too Large<br>nginx上传文件大小限制配置语法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: client_max_body_size size;</span><br><span class="line">Default: client_max_body_size 1m;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>

<p>nginx上传文件大小限制配置示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">也可以放入http层，全局生效</span></span><br><span class="line">server &#123;</span><br><span class="line">...</span><br><span class="line">	client_max_body_size 200m;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>7.Nginx优雅显示错误页面</strong><br>error_page错误日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 conf.d]# cat code3.conf</span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name code.oldboy.com;</span><br><span class="line">	location / &#123;</span><br><span class="line">		root /code;</span><br><span class="line">	&#125;</span><br><span class="line">	location ~ \.php$ &#123;</span><br><span class="line">		fastcgi_pass 127.0.0.1:900;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #如服务器返回如下错误状态码，则进行跳转，跳转至/404.html</span><br><span class="line">    error_page 404 403 /40x.html;</span><br><span class="line"></span><br><span class="line">    #如服务器返回如下错误状态码，则进行跳转，跳转至/50x.html</span><br><span class="line">    error_page 500 502 503 504 /50x.html;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    #精准匹配访问</span><br><span class="line">    location = /404.html &#123;</span><br><span class="line">        root /code;</span><br><span class="line">    &#125;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root /code;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">正常作业：</span><br><span class="line">    全站https</span><br><span class="line">    负载均衡</span><br><span class="line">    keepalived高可用</span><br><span class="line">    LNMP(php、python)</span><br><span class="line">    mysql主从</span><br><span class="line">    nfs共享存储</span><br><span class="line">    redis共享会话</span><br><span class="line">    rsync备份主机配置</span><br><span class="line">    sersync实时同步nfs静态资源</span><br><span class="line">    (jumpserver| openvpn) </span><br><span class="line">    	1.访问内部无公网IP服务器</span><br><span class="line">    	2.无法上公网（firewalld共享上网）</span><br><span class="line">    	</span><br><span class="line">扩展作业</span><br><span class="line">	阿里云。申请域名-备案-解析（ECS、SLB、RDS、云Redis、VPN网关、共享上网、弹性公网IP）</span><br><span class="line">	firewalld 防火墙</span><br><span class="line">	zabbix 监控</span><br><span class="line">	（ntp、ftp附带了解）</span><br><span class="line">节后考试</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>15.Nginx性能优化实践</strong></p>
<p><strong>1.性能优化概述</strong><br>基于Nginx性能优化，那么在性能优化这一章，我们将分为如下几个方面做介绍<br>1.首先我们需要了解性能优化要考虑哪些方面。<br>2.然后我们需要了解性能优化必须要用到的压力测试工具ab。<br>3.最后我们需要了解系统上有哪些注意和优化的点，以及Nginx配置文件。</p>
<p><strong>我们在做性能优化工作前，我们重点需要考虑哪些方面，和了解哪些方面。</strong><br>1.首先需要了解我们当前系统结构和瓶颈，了解当前使用的是什么，运行的是什么业务，都有哪些服务，了解每个服务最大能支撑多大并发。比如Nginx作为静态资源服务的并发是多少，最高瓶颈在哪里，能支持多少qps（每秒查询率)的访问请求，那我们怎么得出这组系统结构瓶颈呢，比如top查看系统的cpu负载、内存使用率、总的运行进程等，也可以通过日志去分析请求的情况，当然也可以通过我们前面介绍到的stub_status模块查看当前的连接情况，也可以对线上的业务进行压力测试（低峰期），去了解当前这套系统能承担多少的请求和并发，已做好相应的评估。这个是我们做性能优化最先考虑的地方。</p>
<p>2.其次我们需要了解业务模式，虽然我们是做性能优化，但每一个性能的优化都是为业务所提供服务的，我们需要了解每个业务接口的类型，比如：电商网站中的抢购模式，这种情况下面，平时没什么流量，但到了抢购时间流量会突增。</p>
<p>我们还需要了解系统层次化的结构，比如：我们使用Nginx做的是代理、还是动静分离、还是后端直接服务用户，那么这个就需要我们对每一层做好相应的梳理。以便更好的服务业务。</p>
<p>3.最后我们需要考虑性能与安全，往往注重了性能，但是忽略了安全。往往过于注重安全，性能又会产生影响。比如：我们在设计防火墙功能时，检测过于严密，这样就会给性能带来影响。那么如果对于性能完全追求，却不顾服务的安全，这个也会造成很大的隐患，所以需要评估好两者的关系，把握好两者的孰重孰轻。以及整体的相关性，权衡好对应的点。</p>
<p><strong>2.压力测试工具</strong><br>在系统业务量没有增长之前，我们就要做好相应的准备工作，已防患业务量徒增带来的接口压力，所以对于接口压力测试就显得非常重要了。我们首先要评估好系统压力，然后使用工具检测当前系统情况，是否能满足对应压力的需求。<br>1.安装ab压力测试工具</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-lua ~]# yum install httpd-tools -y</span><br></pre></td></tr></table></figure>

<p>2.了解压测工具使用方式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-lua ~]# ab -n 200 -c 2 http://127.0.0.1/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-n总的请求次数</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-c并发请求数</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-k是否开启长连接</span></span><br></pre></td></tr></table></figure>

<p>3.配置Nginx静态网站与tomcat动态网站环境</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 conf.d]# cat jsp.conf</span><br><span class="line">server &#123;</span><br><span class="line">	server_name ab.oldboy.com;</span><br><span class="line">	listen 80;</span><br><span class="line">	location / &#123;</span><br><span class="line">		root /code;</span><br><span class="line">		try_files $uri @java_page;</span><br><span class="line">		index index.jsp index.html;</span><br><span class="line">	&#125;</span><br><span class="line">	location @java_page&#123;&#125;</span><br><span class="line">		proxy_pass http://172.16.1.7:8080;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">分别给Nginx准备静态网站</span></span><br><span class="line"><span class="meta prompt_">[root@web01~]# </span><span class="language-bash"><span class="built_in">cat</span> /code/bgx.html</span></span><br><span class="line">Nginx Ab Load</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">给Tomcat准备静态网站文件</span></span><br><span class="line">[root@web01 ROOT]# cat /soft/tomcat-8080/webapps/R00T/bgx.html</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 conf.d]# vim try.conf</span><br><span class="line">server &#123;</span><br><span class="line">	server_name _;</span><br><span class="line">	listen 80;</span><br><span class="line">	location / &#123;</span><br><span class="line">		root /code;</span><br><span class="line">		try_files $uri @java;</span><br><span class="line">	&#125;</span><br><span class="line">	location @java &#123;</span><br><span class="line">		proxy_pass http://127.0.0.1:8080;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">分别给Nginx准备静态网站</span></span><br><span class="line">[root@web01 conf.d]# gzip *.conf</span><br><span class="line">[root@web01 conf.d]# echo &quot;nginx ab&quot; &gt; /code/tt.html</span><br><span class="line"><span class="meta prompt_">[root@web01~]# </span><span class="language-bash"><span class="built_in">cat</span> /code/tt.html</span></span><br><span class="line">nginx ab </span><br><span class="line">[root@web01 conf.d]# systemctl restart nginx</span><br><span class="line">[root@web01 conf.d]# ab -n10000 -c200 http://127.0.0.1/tt.html</span><br><span class="line">[root@web01 conf.d]# ab -k -n10000 -c200 http://127.0.0.1/tt.html</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">给Tomcat准备静态网站文件</span></span><br><span class="line">[root@web01 ROOT]# cat /soft/tomcat-8080/webapps/R00T/tt.html</span><br><span class="line">nginx ab </span><br><span class="line">[root@web01 ~]# wget https://dlcdn.apache.org/tomcat/tomcat-9/v9.0.60/bin/apache-tomcat-9.0.60.tar.gz</span><br><span class="line">[root@web01 ~]# tar xf apache-tomcat-9.0.60.tar.gz</span><br><span class="line">[root@web01 ~]# cd apache-tomcat-9.0.60</span><br><span class="line">[root@web01 apache-tomcat-9.0.60]# cd webapps/</span><br><span class="line">[root@web01 webapps]# cd ROOT/</span><br><span class="line">[root@web01 ROOT]# mv /code/tt.html  ./</span><br><span class="line">[root@web01 ~]# cd apache-tomcat-9.0.60</span><br><span class="line">[root@web01 apache-tomcat-9.0.60]# ./bin/startup.sh</span><br><span class="line">[root@web01 apache-tomcat-9.0.60]# netstat -lntp</span><br><span class="line">[root@web01 apache-tomcat-9.0.60]# ab -n100000 -c200 http://127.0.0.1/tt.html</span><br><span class="line">[root@web01 conf.d]# ab -n10000 -c200 http://127.0.0.1/tt.html</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1.系统结构和瓶颈</span><br><span class="line">2.分析，压力测试工具ab、stub_status</span><br><span class="line">3.了解业务模式</span><br><span class="line">4.了解系统层次化的结构</span><br><span class="line">5.性能与安全</span><br><span class="line"></span><br><span class="line">OSI</span><br><span class="line">    硬件  代理（CPU） 静态（磁盘IO） 动态（cpu、内存）</span><br><span class="line">    网络</span><br><span class="line">    系统  文件描述符（文件句柄）</span><br><span class="line">    应用  服务于服务保持长连接http1.1</span><br><span class="line">    服务  静态资源服务优化</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">压力测试工具</span><br><span class="line">[root@web01 conf.d]# ab</span><br><span class="line">ab: wrong number of arguments</span><br><span class="line">Usage: ab [options] [http[s]://]hostname[:port]/path</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="day42-nginx优化"><a href="#day42-nginx优化" class="headerlink" title="day42-nginx优化"></a><strong>day42-nginx优化</strong></h2><p><strong>2.了解影响性能指标</strong></p>
<ul>
<li>1.网络<ul>
<li>​	网络的流量</li>
<li>​	网络是否丢包</li>
<li>​	这些会影响http的请求与调用</li>
</ul>
</li>
<li>2.系统<ul>
<li>​	硬件有没有磁盘损坏，磁盘速率</li>
<li>​	系统负载、内存、系统稳定性</li>
</ul>
</li>
<li>3.服务<ul>
<li>​	连接优化、请求优化</li>
<li>​	根据业务形态做对应的服务设置</li>
</ul>
</li>
<li>4.程序<ul>
<li>​	接口性能</li>
<li>​	处理速度</li>
<li>​	程序执行效率</li>
</ul>
</li>
<li>5.数据库</li>
</ul>
<p>每个服务与服务之间都或多或少有一些关联，我们需要将整个架构进行分层，找到对应系统或服务的短板，然后进行优化</p>
<p><strong>3.系统性能优化</strong><br>文件句柄，Linux一切皆文件，文件句柄可以理解为就是一个索引，文件句柄会随着我们进程的调用频繁增加，系统默认文件句柄是有限制的，不能让一个进程无限的调用，所以我们需要限制每个进程和每个服务使用多大的文件句柄，文件句柄也是必须要调整的优化参数。</p>
<p>文件句柄的设置方式，1.系统全局性修改。2.用户局部性修改。3.进程局部性修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]# vim /etc/security/limits.conf</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">针对root用户，soft仅提醒，hard限制，nofile打开最大文件数</span></span><br><span class="line">root soft nofife 65535</span><br><span class="line">root hard nofile 65535</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">*代表所有用户</span></span><br><span class="line">* soft nofile 25535</span><br><span class="line">* hard nofile 25535</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">针对Nginx进程</span></span><br><span class="line">worker_rlimit_nofile 65535;</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">系统层面必须要调整</span><br><span class="line">    1.系统全局性修改。</span><br><span class="line">    # *代表所有用户</span><br><span class="line">    * soft nofile 25535</span><br><span class="line">    * hard nofile 25535</span><br><span class="line"></span><br><span class="line">    2.用户局部性修改。</span><br><span class="line">    root soft nofile 65535</span><br><span class="line">    root hard nofile 65535</span><br><span class="line"></span><br><span class="line">    3.进程局部性修改</span><br><span class="line">    worker_rlimit_nofile 65535;  #针对Nginx进程(核心模块)</span><br><span class="line">    </span><br><span class="line">    4.调整内核参数：让time_wait状态重用（端口重用）</span><br><span class="line">    [root@web01 R00T]# vim /etc/sysctl.conf</span><br><span class="line">	net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">    net.ipv4.tcp_timestamps = 1</span><br><span class="line">    [root@web01 R00T]# sysctl -p</span><br></pre></td></tr></table></figure>



<p><strong>4.代理服务优化</strong><br>通常Nginx作为代理服务，负责转发用户的请求，那么在转发的过程中建议开启HTTP长连接，用于减少握手次数，降低服务器损耗。upstream keepalive说明<br>1.长连接语法示例（应用层面优化）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax: keepalive connections;</span><br><span class="line">Default:-</span><br><span class="line">Context: upstream</span><br><span class="line">This directive appeared in version 1.1.4.</span><br></pre></td></tr></table></figure>

<p>2.配置Nginx代理服务使用长连接方式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">upstream http_backend &#123;</span><br><span class="line">	server 127.0.0.1:8080;</span><br><span class="line">	keepalive 16;  #长连接</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">	...</span><br><span class="line">	location /http/ &#123;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">必加参数↓</span></span><br><span class="line">        proxy_pass http://http_backend;</span><br><span class="line">        proxy_http_version 1.1;  #对于http协议应该指定为1.1</span><br><span class="line">        proxy_set_header Connection &quot;&quot;;  #清除“connection&quot;头字段</span><br><span class="line">        proxy_next_upstream error timeout http_500 http_502 http_503 http_504;  #平滑过渡</span><br><span class="line">        proxy_set_header Host $http_host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwared-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_connect_timeout 30s;   #代理连接web超时时间</span><br><span class="line">        proxy_read_timeout 60s;  #代理等待web响应超时时间</span><br><span class="line">        proxy_send_timeout 60s;  # web回传数据至代理超时时间  </span><br><span class="line">        </span><br><span class="line">        # 选加参数↓</span><br><span class="line">		proxy_buffering on;  #开启代理缓冲区，web回传数据至缓冲区，代理边收边传返回给客户端</span><br><span class="line">		proxy_buffer_size 32k;  #代理接收web响应的头信息的缓冲区大小</span><br><span class="line">		proxy_buffers 4 128k;  #缓冲代理接收单个长连接内包含的web响应的数量和大小</span><br><span class="line">    	...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">代理请求web使用http1.1协议</span></span><br><span class="line">proxy_http_version 1.1;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">代理请求web时，继承客户端请求负载的头部信息，指定访问的server_name</span></span><br><span class="line">proxy_set_header Host $http_host;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">显示客户端的IP,不显示多层链路IP信息,log_format默认格式中没有相关信息,需要自行添加</span></span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">显示客户端真实IP，且显示多层链路信息</span></span><br><span class="line">proxy_set_header X-Forwared-For $proxy_add_x_forwarded_for;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">代理连接web超时时间</span></span><br><span class="line">proxy_connect_timeout 30s;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">代理等待web响应超时时间</span></span><br><span class="line">proxy_read_timeout 60s;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">web回传数据至代理超时时间</span></span><br><span class="line">proxy_send_timeout 60s;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">开启代理缓冲区，web回传数据至缓冲区，代理边收边传返回给客户端</span></span><br><span class="line">proxy_buffering on;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">代理接收web响应的头信息的缓冲区大小</span></span><br><span class="line">proxy_buffer_size 32k;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">缓冲代理接收单个长连接内包含的web响应的数量和大小</span></span><br><span class="line">proxy_buffers 4 128k;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.对于fastcgi服务器，需要设置fastcgi_keep_conn以便保持长连接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">upstream fastcgi_backend &#123;</span><br><span class="line">	server 127.0.0.1:9000;</span><br><span class="line">	keepalive 8;</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line">server &#123;</span><br><span class="line">	...</span><br><span class="line">	location /fastcgi/ &#123;</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">必须参数↓</span></span><br><span class="line">		fastcgi_pass fastcgi_backend;</span><br><span class="line">		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">		fastcgi_keep_conn on;</span><br><span class="line">		</span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">可选参数↓</span></span><br><span class="line">		fastcgi_connect_timeout 60s;</span><br><span class="line">		include fastcgi_params;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">注意：</span><br><span class="line">1.scgi和uwsgi协议没有保持连接的概念。</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>4.keepalive_requests设置通过一个keepalive连接提供的最大请求数。在发出最大请求数后,将关闭连接。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Syntax: keepalive_requests number;</span><br><span class="line">Default: keepalive_requests 100;</span><br><span class="line">Context: upstream</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">该指令出现在1.15.3版中。</span></span><br></pre></td></tr></table></figure>

<p>5.keepalive_timeout设置超时，在此期间与代理服务器的空闲keepalive连接将保持打开状态。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Syntax: keepalive_timeout timeout;</span><br><span class="line">Default: keepalive_timeout 60s;</span><br><span class="line">Context: upstream</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">函指令出见1.15，3版中。</span></span><br></pre></td></tr></table></figure>

<p>注意<br>1.scgi和uwsgi协议没有保持连接的概念。<br>2.但无论是proxy、fastcgi、uwsgi协议都有cache缓存的功能，开启后可加速网站访问的效率。（取决硬件）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">1.现在设置缓存10s中的时问。10s到了缓存是不是应该过期。</span><br><span class="line">	浏览器If-None-Match &quot;9-1550193224000&quot;  询问  web服务器  etag  &quot;9-1550193224000&quot;</span><br><span class="line">	浏览器认为只是缓存过期，内容并没有修改，所以协商后还是304</span><br><span class="line">	</span><br><span class="line">		浏览器If-Modified-Since Tue,29Jan 2019 02:29:51 GMT</span><br><span class="line">			询问</span><br><span class="line">		web服务器Last-Modified: Tue, 29 Jan 2019 02:29:51 GMT</span><br><span class="line">	浏览器认为只是缓存过期，内容并没有修改，所以协商后还是304</span><br><span class="line">	</span><br><span class="line">ETag: &quot;5c662c2a-a&quot;		ETag:&quot;5c4fba9f-6&quot;</span><br><span class="line">If-None-Match: &quot;5c4fba9f-6&quot;		If-None-Match: &quot;5c4fba9f-6&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.开启浏览器缓存</span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name static.bgx.com;</span><br><span class="line">	location ~ .*\.(jpg|gif|png)$ &#123;</span><br><span class="line">		expires  7d;</span><br><span class="line">	&#125;</span><br><span class="line">	location ~ .*\.(js|css)$ &#123;</span><br><span class="line">		expires  1y;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">2.如果不希望缓存</span><br><span class="line">location ~ \.*(png|jpg|gif|jpeg)$ &#123;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">	expires 30d;</span></span><br><span class="line">	add_header Cache-Control no-store;</span><br><span class="line">	add_header Pragma no-cache;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">静态资源压缩</span><br><span class="line">[rootaNginx conf.d]# cat static_server.conf</span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name static.oldboy.com;</span><br><span class="line">	</span><br><span class="line">	location ~* .*\.(jpg|gif|png)$ &#123;</span><br><span class="line">        root /code/images;</span><br><span class="line">        gzip on;</span><br><span class="line">        gzip_http_version 1.1;</span><br><span class="line">        Ngzip_comp_level 2;</span><br><span class="line">        gzip_types image/jpeg image/gif image/png;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">针对txt</span><br><span class="line">[rootaNginx conf.d]# cat static_server.conf</span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server name static.oldboy.com;</span><br><span class="line">	sendfile on;</span><br><span class="line">	location ~ .*\.(txt|xml|html|json|js|css)$ &#123;</span><br><span class="line">        gzip on;</span><br><span class="line">        gzip_http_version 1.1;</span><br><span class="line">        gzip_comp_level 1;</span><br><span class="line">        gzip_types text/plain application/json application/x-javascript application/css application/xml application/xml+rss</span><br><span class="line">        text/javascript;</span><br><span class="line">        root /code/doc;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>5.静态资源优化</strong></p>
<p>Nginx作为静态资源Web服务器，用于静态资源处理，传输非常的高效</p>
<p><img src="D:\文件管理\Typora\linux.assets\image-20220320170935863.png" alt="image-20220320170935863"></p>
<p>静态资源指的是，非WEB服务器端运行处理而生成的文件</p>
<table>
<thead>
<tr>
<th>静态资源类型</th>
<th>种类</th>
</tr>
</thead>
<tbody><tr>
<td>浏览器渲染</td>
<td>HTML、CSS、JS</td>
</tr>
<tr>
<td>图片文件</td>
<td>JPEG、GIF、PNG</td>
</tr>
<tr>
<td>视频文件</td>
<td>FLV、Mp4、AVI</td>
</tr>
<tr>
<td>其它文件</td>
<td>TXT、DOC、PDF、…</td>
</tr>
</tbody></table>
<p><strong>5.1.静态资源缓存</strong><br>浏览器缓存设置用于提高网站性能，尤其是新闻网站，图片一旦发布，改动的可能是非常小的。所以我们希望<br>能否用户访问一次后，图片缓存在用户的浏览器长时间缓存。<br>浏览器是有自己的缓存机制，它是基于HTTP协议缓存机制来实现的，在HTTP协议中有很多头信息，那么实<br>现浏览器的缓存就需要依赖特殊的头信息来与服务器进行特殊的验证，如:Expires（http&#x2F;1.0）；Cache-control(http&#x2F;1.1)。Nginx静态资源缓存参考<br>1.浏览器无缓存</p>
<p><img src="D:\文件管理\Typora\linux.assets\image-20220320171420759.png" alt="image-20220320171420759"></p>
<p>2.浏览器有缓存</p>
<p><img src="D:\文件管理\Typora\linux.assets\image-20220320171632599.png" alt="image-20220320171632599"></p>
<p>3.浏览器缓存过期校验检查机制，说明如下：<br>1.浏览器请求服务器会先进行Expires、Cache-Control的检查，检查缓存是否过期，如果没有过期则直接从缓存文件中读取。</p>
<p>2.如果缓存过期，首先检查是否存在etag，如果存在则会客户端会向web服务器请求if-None-Match，与etag值进行比对，由服务器决策返回200还是304。</p>
<p>3.如果etag不存在，则进行ast-Modified检查，客户端会向web服务器请求if-Modified-Since，与ast-Modified进行比对，由服务器决策返回200还是304。</p>
<p><img src="D:\文件管理\Typora\linux.assets\image-20220320171808138.png" alt="image-20220320171808138"></p>
<p>4.如何配置静态资源缓存expires</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">作用：添加cache-Control Expires头</span></span><br><span class="line">Syntax: expires [modified] time;</span><br><span class="line">expires epoch | max | off;</span><br><span class="line">Default: expires off;</span><br><span class="line">Context: http, server, location, if in location</span><br></pre></td></tr></table></figure>

<p>5.配置静态资源缓存场景</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name static.bgx.com;</span><br><span class="line">	location ~ .*\.(jpg|gif|png)$ &#123;</span><br><span class="line">		expires  7d;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>6.如果开发代码没有正式上线时，希望静态文件不被缓存</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">取消js css html等静态文件缓存</span></span><br><span class="line">location ~ .*\.(css|js|swf|json|mp4|htm|html)$ &#123;</span><br><span class="line">	add_header Cache-Control no-store;</span><br><span class="line">	add_header Pragma no-cache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>5.2.静态资源读取</strong><br>1.文件读取高效sendfile，如下图</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: sendfile on | off;</span><br><span class="line">Default: sendfile off;</span><br><span class="line">Context: http, server, location, if in location</span><br></pre></td></tr></table></figure>

<p><img src="D:\文件管理\Typora\linux.assets\image-20220320175144452.png" alt="image-20220320175144452"></p>
<p>传统读取文件方式VS sendfile读取文件方式</p>
<p>2.将多个包一次发送，用于提升网络传输效率，大文件推荐打开，需要开启sendfile才行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: tcp_nopush on | off;</span><br><span class="line">Default: tcp_nopush off;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>


<p>3.提高网络传输实时性，需要开启keepalive</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: tcp_nodelay on | off;</span><br><span class="line">Default: tcp_nodelay on;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>

<p><strong>5.3.静态资源压缩</strong></p>
<p>Nginx将响应报文发送至客户端之前启用压缩功能，然后进行传输，这能够有效地节约带宽，并提高响应至客户端的速度。</p>
<p><img src="D:\文件管理\Typora\linux.assets\image-20220320175548041.png" alt="image-20220320175548041"></p>
<p>1.gzip传输压缩，传输前压缩，传输后解压</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: gzip on | off;</span><br><span class="line">Default: gzip off;</span><br><span class="line">Context: http, server, location, if in location</span><br></pre></td></tr></table></figure>

<p>2.gzip压缩哪些类型的文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: gzip_types mime-type ...;</span><br><span class="line">Default: gzip_types text/html;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>

<p>3.gzip压缩比率，加快传输，但压缩本身比较耗费服务端性能</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: gzip_comp_level level;</span><br><span class="line">Default: gzip_comp_level 1;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>

<p>4.gzip压缩协议版本，压缩使用在http哪个协议，主流选择1.1版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: gzip_http_version 1.0 | 1.1;</span><br><span class="line">Default: gzip_http_version 1.1;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>







<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##fj.xuliangwei.com服务器</span></span></span><br><span class="line">[root@bgx conf.d]# cat fj.xuliangwei.com.conf</span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name fj.xuliangwei.com;</span><br><span class="line">	root /code/fj;</span><br><span class="line">	access_log /logs/fj.xuliangwei.com main;</span><br><span class="line">	</span><br><span class="line">	location / &#123;</span><br><span class="line">	index index.html;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">referer demo测试</span></span><br><span class="line">	location ~ .*\.(jpg||jpeg|gif|png)$ &#123;</span><br><span class="line">		valid_referers none blocked *.xuliangwei.com;</span><br><span class="line">			if ($invalid_referer) &#123;</span><br><span class="line">				return 403;</span><br><span class="line"><span class="meta prompt_">		#</span><span class="language-bash">	rewrite ^(.*)$ /public/ks.jpeg <span class="built_in">break</span>;</span></span><br><span class="line">			&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@bgx conf.d]# 1l /code/fj/public/</span><br><span class="line">-rw-r--r-- 1 root root  14116 Feb 14 17:51 ks.jpeg</span><br><span class="line">-rw-r--r-- 1 root root  12174 Feb 14 17:31 tt.jpeg</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##盗链服务器</span></span></span><br><span class="line">[root@web01 code]# cat /code/tt.html</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">	&lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">	&lt;title&gt;oldboyedu.com&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body style=&quot;background-color:red;&quot;&gt;</span><br><span class="line">	&lt;img src=&quot;http://fj.xuliangwei.com/public/tt.jpeg&quot;/&gt;  #根据情况修改你的服务器地址</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">10.0.0.8  static.oldboy.com</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.配置Nginx</span></span><br><span class="line">[root@web02 conf.d]# cat static.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name static.oldboy.com;</span><br><span class="line">    root /code;</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">    	index index.html;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.上传2张图片</span></span><br><span class="line">    一张是可以被盗链的图片</span><br><span class="line">    一张是广告位的图片</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.重启服务器</span></span><br><span class="line">[root@web02 code]# systemctl restart nginx</span><br><span class="line">--------------------------------------------------------</span><br><span class="line">--------------------------------------------------------</span><br><span class="line"></span><br><span class="line">10.0.0.7  dl.oldboy.com  ###盗链服务器</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.配置Nginx</span></span><br><span class="line">[root@web01 conf.d]# cat try.conf</span><br><span class="line">server &#123;</span><br><span class="line">	server_name dl.oldboy.com;</span><br><span class="line">	listen 80;</span><br><span class="line">	root /code;</span><br><span class="line">	location / &#123;</span><br><span class="line">		index index.html;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.配置盗链的页面</span></span><br><span class="line">[root@web01 code]# cat /code/tt.html</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">	&lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">	&lt;title&gt;oldboyedu.com&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body style=&quot;background-color:red;&quot;&gt;</span><br><span class="line">	&lt;img src=&quot;http://static.oldboy.com/smg.jpg&quot;/&gt;   #根据情况修改你的服务器地址</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">--------------------------------------------------------</span><br><span class="line">--------------------------------------------------------</span><br><span class="line"></span><br><span class="line">3.在10.0.0.8 添加防盗链操作</span><br><span class="line">location ~* \.(gif|jpg|png|bmp)$ &#123;</span><br><span class="line">	valid_referers none blocked *.xuliangwei.com</span><br><span class="line">	if ($invalid referer) &#123;</span><br><span class="line">		return 403;   						#可以选择直接返回403</span><br><span class="line">		rewrite ^(.*)$ /ggw.png break;   	#也可以选择返回一张水印的图片，给公司做广告</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>5.4.防止资源盗链</strong><br>防盗链，指的是防止资源被其他网站恶意盗用，<br>基础防盗链设置思路：主要是针对客户端请求过程中所携带的一些Header信息来验证请求的合法性，比如客户端在请求的过程中都会携带referer信息(referer会告诉服务器我是丛哪一个页面过来的。优点是规则简单，配置和使用都很方便，缺点是防盗链所依赖的Referer验证信息是可以伪造的，所以通过Referer信息防盗链并非100%可靠，但是它能够限制大部分的盗链情况。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Syntax: valid_referers none | blocked | server_names | string ...;</span><br><span class="line">Default: –</span><br><span class="line">Context: server, location</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">none: Referer来源头部为空的情况</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">blocked: Referer来源头部不为空，这些值都不以http://或者https://开头</span></span><br></pre></td></tr></table></figure>

<p>1.在盗链服务器上准备html文件,偷取fj.xuliangwei.com网站上的图片</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ~]# cat /code/referer_test.html</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">	&lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">	&lt;title&gt;oldboyedu.com&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body style=&quot;background-color:red;&quot;&gt;</span><br><span class="line">	&lt;img src=&quot;http://fj.xuliangwei.com/public/tt.jpeg&quot;/&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>2.使用浏览器能正常访问到偷链的资源</p>
<p><img src="D:\文件管理\Typora\linux.assets\image-20220320211419358.png" alt="image-20220320211419358"></p>
<p>3.在kt.xuliangwei.com服务器上启动基于防盗链</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location ~ .*\.(jpg||jpeg|gif|png)$ &#123;</span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash"><span class="comment">#指定合法的来源referer，这个变量被设置为0，否则设置为1</span></span></span><br><span class="line">	valid_referers none blocked www.xuliangwei.com;</span><br><span class="line">	if ($invalid_referer) &#123;</span><br><span class="line">		return 403;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上配置含义表示：所有来自xuliangwei.com都可以访问到当前站点的图片，如果来源域名不在这个列表中，那么$invalid_referer等于1，在if语句中返回一个403给用户，这样用户便会看到一个403的页面</p>
<p>4.使用浏览器验证会发现恶意的来源网站已经无法正常盗链</p>
<p><img src="D:\文件管理\Typora\linux.assets\image-20220320212129976.png" alt="image-20220320212129976"></p>
<p>5.如果不使用return 403而使用rewrite,那么盗链图片会返回一个ks.jpeg给用户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location ~ .*\.(jpg||jpeg|gif|png)$ &#123;</span><br><span class="line">	valid_referers none blocked *.xuliangwei.com;</span><br><span class="line">	if ($invalid_referer) &#123;</span><br><span class="line">		rewrite ^(.*)$ /public/ks.jpeg break;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>6.验证rewrite的效果</p>
<p><img src="D:\文件管理\Typora\linux.assets\image-20220320212603356.png" alt="image-20220320212603356"></p>
<p>7.如果希望某些网站能够使用（盗链）资源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location ~* \.(gif|jpg|png|bmp)$ &#123;</span><br><span class="line">	valid_referers none blocked *.xuliangwei.com server_names ~\.google\. ~\.baidu\.;</span><br><span class="line"><span class="meta prompt_">	if($</span><span class="language-bash">invalid_referer)&#123;</span></span><br><span class="line">		return 403;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>8.当然这种防护并不能百分百保证资源被盗链，因为我们可以通过命令修改来源的refrer信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">跨站访问</span><br><span class="line"></span><br><span class="line">1.准备a网站</span><br><span class="line">[root@Nginx ~]# cat /code/http_origin.html</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">	&lt;meta charset=&quot;UTF-8&quot; /&gt;</span><br><span class="line">	&lt;title&gt;测试ajax和跨域访问&lt;/title&gt;</span><br><span class="line">	&lt;script src=&quot;http://libs.baidu.com/jquery/2.1.4/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">(document).ready(<span class="function"><span class="title">function</span></span>()&#123;</span></span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">    type: &quot;GET&quot;,</span><br><span class="line">    url:&quot;http://fj.xuliangwei.com/public/tt.html&quot;,  #调用的也是b网站</span><br><span class="line">    success: function(data) &#123;</span><br><span class="line">    	alert(&quot;sucess!!!&quot;);</span><br><span class="line">    &#125;,</span><br><span class="line">    error: function()&#123;</span><br><span class="line">    	alert(&quot;fail!!,请刷新再试!&quot;)；</span><br><span class="line">    &#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">	&lt;body&gt;</span><br><span class="line">		&lt;h1&gt;测试跨域访问&lt;/h1&gt;</span><br><span class="line">	&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">2.准备b网站</span><br><span class="line"></span><br><span class="line">3.通过浏览器测试跨域访问</span><br><span class="line"></span><br><span class="line">4.在b网站上允许a网站跨域访问</span><br><span class="line">[root@Nginx conf.d]# cat fj.xuliangwei.com.conf</span><br><span class="line">location ~ .*\.(html|htm)$ &#123;</span><br><span class="line">	add_header Access-Control-Allow-Origin *;   # * 可以改为定向http://down.xuliangwei.com</span><br><span class="line">	add_header Access-Control-Allow-Methods GET,POST,PUT,DELETE,OPTIONS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>5.5.允许跨域访问</strong><br>什么是跨站访问，当我们通过浏览器访问a网站时，同时会利用到ajax或其他方式，同时也请求b网站，这样的话就出现了请求一个页面，使用了2个域名，这种方式对浏览器来说默认是禁止。</p>
<p><img src="D:\文件管理\Typora\linux.assets\image-20220320222132038.png" alt="image-20220320222132038"></p>
<p>那Nginx允许跨站访问与浏览器有什么关系呢，因为浏览器会读取Access-Control-Allow-Origin的头信息，如果服务端允许，则浏览器不会进行拦截。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: add_header name value [always];</span><br><span class="line">Default: -</span><br><span class="line">Context: http, server, location, if in location</span><br></pre></td></tr></table></figure>

<p>1.在down.xuliangwei.com网站上准备跨站访问的文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ~]# cat /code/http_origin.html</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">	&lt;meta charset=&quot;UTF-8&quot; /&gt;</span><br><span class="line">	&lt;title&gt;测试ajax和跨域访问&lt;/title&gt;</span><br><span class="line">	&lt;script src=&quot;http://libs.baidu.com/jquery/2.1.4/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">(document).ready(<span class="function"><span class="title">function</span></span>()&#123;</span></span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">    type: &quot;GET&quot;,</span><br><span class="line">    url:&quot;http://fj.xuliangwei.com/public/tt.html&quot;,  #调用的也是b网站</span><br><span class="line">    success: function(data) &#123;</span><br><span class="line">    	alert(&quot;sucess!!!&quot;);</span><br><span class="line">    &#125;,</span><br><span class="line">    error: function()&#123;</span><br><span class="line">    	alert(&quot;fail!!,请刷新再试!&quot;)；</span><br><span class="line">    &#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">	&lt;body&gt;</span><br><span class="line">		&lt;h1&gt;测试跨域访问&lt;/h1&gt;</span><br><span class="line">	&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>2.通过浏览器测试，该跨站操作一定会被拒绝</p>
<p><img src="D:\文件管理\Typora\linux.assets\image-20220320225800623.png" alt="image-20220320225800623"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">cpu亲和</span><br><span class="line">1.查看当前CPU物理状态</span><br><span class="line"><span class="meta prompt_">[root@nginx~]# </span><span class="language-bash">lscpu |grep <span class="string">&quot;CPU(s)&quot;</span></span></span><br><span class="line">CPU(s):					24</span><br><span class="line">On-line CPU(s) list:	0-23</span><br><span class="line">NUMA nodeO CPU(s):		0,2,4,6,8,10,12,14,16,18,20,22</span><br><span class="line">NUMA node1 CPU(s):		1,3,5,7,9,11,13,15,17,19,21,23</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">本次演示服务器为两颗物理cpu，每颗物理CPU12个核心，总共有24个核心</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改nginx启动的work进程为自动。</span></span><br><span class="line">worker_processes auto;</span><br><span class="line">worker_cpu_affinity auto;</span><br><span class="line"></span><br><span class="line">[root@web01 ~]# ps -eo pid,args,psr|grep [n]ginx</span><br><span class="line">1242 nginx: master process /usr/	2</span><br><span class="line">1243 nginx: worker process			0</span><br><span class="line">1244 nginx: worker process			1</span><br><span class="line">1245 nginx: worker process			2</span><br><span class="line">1246 nginx: worker process			3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">不推荐调整的方式</span><br><span class="line">    #第一种绑定组合方式</span><br><span class="line">    worker_processes 24;</span><br><span class="line">    worker_cpu_affinity 000000000001 000000000010 000000000100 000000001000 000000010000 000000100000 000001000000 000010000000 000100000000 001000000000 010000000000 10000000000;</span><br><span class="line"></span><br><span class="line">    #第二种方式（使用较少）</span><br><span class="line">    worker_processes 2;</span><br><span class="line">    worker_cpu_affinity 101010101010 010101010101;</span><br><span class="line">    </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">Nginx通用配置  Nginx代理相关配置  Nginx Fastcgi</span><br><span class="line">[root@nginx～]# cat nginx.conf</span><br><span class="line">user www;	#nginx进程启动用户</span><br><span class="line">worker_processes auto;	#与cpu核心一致即可</span><br><span class="line">worker_cpu_affinity auto;	#cpu亲和</span><br><span class="line">error_log /var/log/nginx/error.log warn;	#错误日志</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line">worker_rlimit_nofile 35535;	#每个work能打开的文件描述符，调整至1w以上，负荷较高建议2-3w</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">	use epoll;	#使用epoll高效网络模型</span><br><span class="line">	worker_connections 10240;	#限制每个进程能处理多少个连接，10240x[cpu核心]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http&#123;</span><br><span class="line">	include			mime.types;</span><br><span class="line">	default_type	application/octet-stream;</span><br><span class="line">	charset utf-8;	#统一使用utf-8字符集</span><br><span class="line"><span class="meta prompt_">	</span></span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">定义日志格式</span></span><br><span class="line">	log_format main &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">					&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">					&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;;</span><br><span class="line"></span><br><span class="line">	access_log /var/log/nginx/access.log main;	#访问日志</span><br><span class="line"></span><br><span class="line">	server_tokens off;	#禁止浏览器显示nginx版本号</span><br><span class="line">	client_max_body_size 200m;	#文件上传大小限制调整</span><br><span class="line"></span><br><span class="line">    #文件高效传输，静态资源服务器建议打开</span><br><span class="line">    sendfile			on;</span><br><span class="line">    tcp_nopush			on;</span><br><span class="line">    #文件实时传输，动态资源服务建议打开，需要打开keepalived</span><br><span class="line">    tcp_nodelay			on;</span><br><span class="line">	keepalive_timeout 	65;</span><br><span class="line"><span class="meta prompt_">	</span></span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">Gzip压缩</span></span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_disable &quot;MSIE [1-6]\.&quot;;</span><br><span class="line">    gzip_http_version 1.1;</span><br><span class="line">    gzip_ comp level 2;</span><br><span class="line">    gzip_buffers 16 8k;</span><br><span class="line">    gzip_min_length 1024;</span><br><span class="line">    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript image/jpeg;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    #虚拟主机</span><br><span class="line">	include /etc/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>5.6.CPU亲和配置</strong><br>CPU亲和(affinity)减少进程之间不断频繁切换，减少性能损耗，其实现原理是将CPU核心和Nginx工作进程绑定方式，把每个worker进程固定对应的cpu 上执行,减少切换cpu的cache miss,获得更好的性能。</p>
<p><img src="D:\文件管理\Typora\linux.assets\image-20220320230215409.png" alt="image-20220320230215409"></p>
<p>1.查看当前CPU物理状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">[root@nginx~]# </span><span class="language-bash">lscpu |grep <span class="string">&quot;CPU(s)&quot;</span></span></span><br><span class="line">CPU(s):					24</span><br><span class="line">On-line CPU(s) list:	0-23</span><br><span class="line">NUMA nodeO CPU(s):		0,2,4,6,8,10,12,14,16,18,20,22</span><br><span class="line">NUMA node1 CPU(s):		1,3,5,7,9,11,13,15,17,19,21,23</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">本次演示服务器为两颗物理cpu，每颗物理CPU12个核心，总共有24个核心</span></span><br></pre></td></tr></table></figure>

<p>2.将Nginx worker进程绑至不同的核心上，官方建议与cpu的核心保持一致</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第一种绑定组合方式</span></span><br><span class="line">worker_processes 24;</span><br><span class="line">worker_cpu_affinity 000000000001 000000000010 000000000100 000000001000 ...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第二种方式（使用较少）</span></span><br><span class="line">worker_processes 2;</span><br><span class="line">worker_cpu_affinity 101010101010 010101010101;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">最佳方式绑定方式</span></span><br><span class="line">worker_processes auto;</span><br><span class="line">worker_cpu_affinity auto;</span><br></pre></td></tr></table></figure>

<p>3.查看nginx worker进程绑定至对应cpu</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -eo pid,args,psr|grep [n]ginx</span><br></pre></td></tr></table></figure>



<p><strong>5.7.通用优化配置</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx～]# cat nginx.conf</span><br><span class="line">user www;	#nginx进程启动用户</span><br><span class="line">worker_processes auto;	#与cpu核心一致即可</span><br><span class="line">worker_cpu_affinity auto;	#cpu亲和</span><br><span class="line">error_log /var/log/nginx/error.log warn;	#错误日志</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line">worker_rlimit_nofile 35535;	#每个work能打开的文件描述符，调整至1w以上，负荷较高建议2-3w</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">	use epoll;	#使用epoll高效网络模型</span><br><span class="line">	worker_connections 10240;	#限制每个进程能处理多少个连接，10240x[cpu核心]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http&#123;</span><br><span class="line">	include			mime.types;</span><br><span class="line">	default_type	application/octet-stream;</span><br><span class="line">	charset utf-8;	#统一使用utf-8字符集</span><br><span class="line"><span class="meta prompt_">	</span></span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">定义日志格式</span></span><br><span class="line">	log_format main &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">					&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">					&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;;</span><br><span class="line"></span><br><span class="line">	access_log /var/log/nginx/access.log main;	#访问日志</span><br><span class="line"></span><br><span class="line">	server_tokens off;	#禁止浏览器显示nginx版本号</span><br><span class="line">	client_max_body_size 200m;	#文件上传大小限制调整</span><br><span class="line"></span><br><span class="line">    #文件高效传输，静态资源服务器建议打开</span><br><span class="line">    sendfile			on;</span><br><span class="line">    tcp_nopush			on;</span><br><span class="line">    #文件实时传输，动态资源服务建议打开，需要打开keepalived</span><br><span class="line">    tcp_nodelay			on;</span><br><span class="line">	keepalive_timeout 	65;</span><br><span class="line"><span class="meta prompt_">	</span></span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">Gzip压缩</span></span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_disable &quot;MSIE [1-6]\.&quot;;</span><br><span class="line">    gzip_http_version 1.1;</span><br><span class="line">    gzip_ comp level 2;</span><br><span class="line">    gzip_buffers 16 8k;</span><br><span class="line">    gzip_min_length 1024;</span><br><span class="line">    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript image/jpeg;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    #虚拟主机</span><br><span class="line">	include /etc/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">防止恶意IP解析</span></span><br><span class="line">server &#123;</span><br><span class="line">	listen 80 default_server;</span><br><span class="line">	return 302 https://www.xuliangwei.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Nginx安全与优化总结</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Nginx安全与优化总结</span><br><span class="line">1.cpu亲和、worker进程数、调整每个worker进程打开的文件数</span><br><span class="line">2.使用epool网络模型、调整每个worker进程的最大连接数</span><br><span class="line">3.文件的高效读取sendfile、nopush、</span><br><span class="line">4.文件的传输实时性、nodealy</span><br><span class="line">5.开启tcp长链接、以及长链接超时时间keepalived</span><br><span class="line">6.开启文件传输压缩gzip</span><br><span class="line">7.开启静态文件expires缓存</span><br><span class="line">8.隐藏Nginx的版本号</span><br><span class="line">9.禁止通过IP地址访问，禁止恶意域名解析，只允许域名访问</span><br><span class="line">10.配置放盗链、以及跨域访问</span><br><span class="line">11.防DDOS、cc攻击，限制单IP并发连接，以及http请求</span><br><span class="line">12.优雅限制nginx错误页面</span><br><span class="line">13.nginx加密传输https优化</span><br><span class="line">14.nginx proxy_cache、fastcgi_cache、uwsgi_cache缓存</span><br><span class="line">			squid、uvarnish()</span><br></pre></td></tr></table></figure>



<p><strong>6.PHP服务优化</strong><br>1.php程序配置管理文件&#x2F;etc&#x2F;php.ini，主要调整日志、文件上传、禁止危险函<br>数、关闭版本号显示、等</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#;;;;;;;;;;;;;;;;;</span></span><br><span class="line"><span class="comment"># Errorlogging;  #错误日志设置</span></span><br><span class="line"><span class="comment">#;;;;;;;;;;;;;;;;;</span></span><br><span class="line">expose_php = Off  					<span class="comment">#关闭php版本信息</span></span><br><span class="line">display_error = Off  				<span class="comment">#屏幕不显示错误日志</span></span><br><span class="line">error_reporting = E_ALL 	 		<span class="comment">#记录PHP的每个错误</span></span><br><span class="line">log_errors = On  					<span class="comment">#开启错误日志</span></span><br><span class="line">error_log = /<span class="keyword">var</span>/log/php_error.log  <span class="comment">#错误日志写入的位置</span></span><br><span class="line">date.timezone = Asia/Shanghai  		<span class="comment">#调整时区，默认PRC</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#;;;;;;;;;;;;;;;</span></span><br><span class="line"><span class="comment"># File Uploads ;	#文件上传设置</span></span><br><span class="line"><span class="comment">#;;;;;;;;;;;;;;;</span></span><br><span class="line">file_uploads = On			<span class="comment">#允许文件上传</span></span><br><span class="line">upload_max_filesize=<span class="number">300</span>M	<span class="comment">#允许上传文件的最大大小</span></span><br><span class="line">post_max_size = <span class="number">300</span>M		<span class="comment">#允许客户端单个POST请求发送的最大数据</span></span><br><span class="line">max_file_uploads = <span class="number">20</span>		<span class="comment">#允许同时上传的文件的最大数量</span></span><br><span class="line">memory_limit = <span class="number">128</span>M			<span class="comment">#每个脚本执行最大内存</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#;;;;;;;;;;;;;;;</span></span><br><span class="line"><span class="comment"># session	   ;	#会话共享</span></span><br><span class="line"><span class="comment">#;;;;;;;;;;;;;;;    </span></span><br><span class="line">[Session]</span><br><span class="line">session.save_handler = redis</span><br><span class="line">session.save_path = <span class="string">&quot;tcp://172.16.1.51:6379&quot;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment">#php禁止危险函数执行</span></span><br><span class="line">disable_functions = chown,chmod,pfsockopen,phpinfo</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/unixtech/article/details/53761832">php危险函数禁用参考列表</a></p>
<p>2.php-fpm进程管理配置文件&#x2F;etc&#x2F;php-fpm.conf</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#第一部分，fpm配置</span></span><br><span class="line">;<span class="keyword">include</span>=etc/fpm.d<span class="comment">/*.conf</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#第二部分，全局配置</span></span><br><span class="line"><span class="comment">[global]</span></span><br><span class="line"><span class="comment">;pid = /var/log/php-fpm/php-fpm.pid  #pid文件存放的位置</span></span><br><span class="line"><span class="comment">;error_log = /var/log/php-fpm/php-fpm.log  #错误日志存放的位置</span></span><br><span class="line"><span class="comment">;log_level=error  #日志级别,alert,error,warning,notice,debug</span></span><br><span class="line"><span class="comment">rlimit_files = 65535  #php-fpm进程能打开的文件数</span></span><br><span class="line"><span class="comment">events.mechanism = epoll  #使用epoll事件模型处理请求</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#第三部分，进程池定义</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">[www]			#池名称</span></span><br><span class="line"><span class="comment">user = www		#进程运行的用户</span></span><br><span class="line"><span class="comment">group = www 	#进程运行的组</span></span><br><span class="line"><span class="comment">;listen = /dev/shm/php-fpm.sock		#监听在本地socket文件</span></span><br><span class="line"><span class="comment">listen = 127.0.0.1:9000  #监听在本地tcp的9000端口</span></span><br><span class="line"><span class="comment">;listen.allowed_clients = 127.0.0.1  #允许访问FastCGI进程的IP,any不限制</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">pm =dynamic  					#动态调节php-fpm的进程数</span></span><br><span class="line"><span class="comment">pm.max_children = 512 			#最大启动的php-fpm进程数</span></span><br><span class="line"><span class="comment">pm.start_servers = 32			#初始启动的php-fpm进程数</span></span><br><span class="line"><span class="comment">pm.min_spare_servers = 32		#最少的空闲php-fpm进程数</span></span><br><span class="line"><span class="comment">pm.max_spare_servers = 64		#最大的空闲php-fpm进积数</span></span><br><span class="line"><span class="comment">pm.max_requests = 1500			#每一个进程能响应的请求数</span></span><br><span class="line"><span class="comment">pm.process_idle_timeout = 15s;</span></span><br><span class="line"><span class="comment">pm.status_path = /phpfpm_status  #开启php的状态页面</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#第四部分，日志相关</span></span><br><span class="line"><span class="comment">php_flag[display_errors] = off</span></span><br><span class="line"><span class="comment">php_admin_value[error_log] = /var/log/phpfpm_error.log</span></span><br><span class="line"><span class="comment">php_admin_flag[log_errors] = on</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#慢日志</span></span><br><span class="line"><span class="comment">request_slowlog_timeout = 5s	#php脚本执行超过5s的文件</span></span><br><span class="line"><span class="comment">slowlog= /var/log/php_slow.log	#记录至该文件中</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">慢日志示例</span></span><br><span class="line"><span class="comment">[21-Nov-2013 14:30:38] [pool www] pid 11877</span></span><br><span class="line"><span class="comment">script_filename = /usr/local/lnmp/nginx/html/www.quancha.cn/www/fyzb.php</span></span><br><span class="line"><span class="comment">[Oxb70fb88c] file_get_contents() /usr/local/lnmp/nginx/html/www.quancha.cn/www/fyzb.php:2</span></span><br><span class="line"><span class="comment"></span></span><br></pre></td></tr></table></figure>

<p>3.php-fpm监控模块，用于监控php-fpm状态使用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]<span class="comment"># vim /etc/php-fpm.d/www.conf</span></span><br><span class="line">pm.status_path = /phpfpm_status  <span class="comment">#开启php的状态页面</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#修改nginx配置</span></span><br><span class="line">[root@nginx conf.d]<span class="comment"># cat /etc/nginx/conf.d/fpm.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">	listen <span class="number">80</span>;</span><br><span class="line">	server_name php.bgx.com;</span><br><span class="line">	location / &#123;</span><br><span class="line">		root /code;</span><br><span class="line">		index index.php;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">#新增如下配置</span></span><br><span class="line">	location /phpfpm_status &#123;</span><br><span class="line">		fastcgi_pass <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9000</span>;</span><br><span class="line">		fastcgi_param  SCRIPT FILENAME  <span class="variable">$document</span>_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">		<span class="keyword">include</span>  fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">	location ~ \.php$ &#123;</span><br><span class="line">		fastcgi_pass <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9000</span>;</span><br><span class="line">		fastcgi_param SCRIPT_FILENAME <span class="variable">$document</span>_root<span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">		<span class="keyword">include</span> fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4.访问测试phpfpm_status状态页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">php 状态页面  pm.status_path = /phpfpm_status  #开启php的状态页面</span><br><span class="line">[root@nginx ~]# curl http://127.0.0.1/phpfpm_status</span><br><span class="line">pool:					WWW				#fpm池名称，大多数为www</span><br><span class="line">process manager:		dynamic			#动态管理phpfpm进程</span><br><span class="line">start time:				05/Jul/2016		#启动时间，如果重启会发生变化</span><br><span class="line">start since:			409				#php-fpm运行时间</span><br><span class="line">accepted conn:			22				#当前池接受的连接数</span><br><span class="line">listen queue:			0				#请求等待队列，如果这个值不为0，那么需要增加FPM的进程数量</span><br><span class="line">max listen queue:		0				#请求等待队列最高的数量</span><br><span class="line">listen queue len:		128				#请求等待队列的长度</span><br><span class="line">idle processes:			4				#php-fpm空闲的进程数量</span><br><span class="line">active processes:		1				#php-fpm活跃的进程数量</span><br><span class="line">total processes:		5				#php-fpm总的进程数量</span><br><span class="line">max active processes:	2				#php-fpm最大活跃的程数量（FPM启动开始计算）</span><br><span class="line">max children reached:	0				#进程最大数量限制的次数，如果数量不为0，则说明phpfpm最大进程数量过小，可以适当调整。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>5.PHP-FPM配置文件4核16G、4核32G</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]<span class="comment"># cat /etc/php-fpm.d/www.conf</span></span><br><span class="line">[<span class="keyword">global</span>]</span><br><span class="line">pid = /<span class="keyword">var</span>/run/php-fpm.pid</span><br><span class="line">    </span><br><span class="line">error_log =/<span class="keyword">var</span>/log/php-fpm.log</span><br><span class="line">log_level = warning</span><br><span class="line">rlimit_files = <span class="number">655350</span></span><br><span class="line">events.mechanism = epoll</span><br><span class="line">    </span><br><span class="line">[www]</span><br><span class="line">user = nginx</span><br><span class="line">group = nginx</span><br><span class="line">listen = <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">9000</span></span><br><span class="line">listen.owner = www</span><br><span class="line">listen.group = www</span><br><span class="line">listen.mode = <span class="number">0660</span></span><br><span class="line"></span><br><span class="line">listen.allowed_clients = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line">pm =dynamic</span><br><span class="line">pm.max children = <span class="number">512</span></span><br><span class="line">pm.start_servers = <span class="number">32</span></span><br><span class="line">pm.min_spare_servers = <span class="number">32</span></span><br><span class="line">pm.max_spare_servers = <span class="number">64</span></span><br><span class="line">pm.process_idle_timeout = <span class="number">15</span>s;</span><br><span class="line">pm.max_requests = <span class="number">2048</span></span><br><span class="line">pm.status_path = /phpfpm_status</span><br><span class="line">    </span><br><span class="line"><span class="comment">#php-www模块错误日志</span></span><br><span class="line">php_flag[display_errors] = off</span><br><span class="line">php_admin_value[error_log] =/<span class="keyword">var</span>/log/php/php-www.log</span><br><span class="line">php_admin_flag[log_errors] = on</span><br><span class="line">    </span><br><span class="line"><span class="comment">#php慢査询日志</span></span><br><span class="line">request_slowlog_timeout = <span class="number">5</span>s</span><br><span class="line">slowlog = /<span class="keyword">var</span>/log/php-slow.log</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">nginx</span><br><span class="line">    硬件层面	 代理比较的消耗CPU、内存、		静态比较消耗磁盘I0、</span><br><span class="line">    网络层面	 网络带宽大小、传输速率、是否有丢包、</span><br><span class="line">    系统层面	 调整文件描述。	   timewait重用</span><br><span class="line">    应用层面	 nginx作为代理		 keepalive长连接</span><br><span class="line">    服务层面	 nginx作为静态		 浏览器缓存、文件传输、压缩、防盗链、跨域访问、CPU亲和</span><br><span class="line">                nginx作为缓存		proxy_cache fastcgi_cache uwsgi_cache</span><br><span class="line">                nginx作为安全		nginx+lua实现waf防火墙</span><br><span class="line"></span><br><span class="line">php</span><br><span class="line">    php.ini		错误日志记录、文件大小的调整、session会话共享的配置、禁止不必要的函数（与开发协商）</span><br><span class="line">    php-fpm		监听地址、进程的动态调节、日志开启。</span><br><span class="line">    php状态	   php自身监控的状态信息</span><br><span class="line">    php慢查询	  什么时间、什么进程、运行什么文件、哪个函数、第几行达到了超时时间</span><br></pre></td></tr></table></figure>



<h2 id="day43-zabbix-day01"><a href="#day43-zabbix-day01" class="headerlink" title="day43-zabbix-day01"></a><strong>day43-zabbix-day01</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">监控</span><br><span class="line"></span><br><span class="line">1.什么是监控？</span><br><span class="line">2.为什么要做监控？</span><br><span class="line">    超市：防内外偷</span><br><span class="line">    监控|测速，</span><br><span class="line">--------------------------</span><br><span class="line">系统监控：</span><br><span class="line">1.对系统不间断实时监控：（这就是监控）</span><br><span class="line">2.实时反馈系统当前状态：</span><br><span class="line">3.保证服务可靠性安全性：</span><br><span class="line">4.保证业务持续稳定运行：</span><br><span class="line"></span><br><span class="line">3.监控使用什么工具来实现？</span><br><span class="line">    cacti（网络监控用的比较多）</span><br><span class="line">    Nagios系统监控</span><br><span class="line">    zabbix</span><br><span class="line">    open-falcon小米公司开发</span><br><span class="line">    Lepus天兔(专门监控数据库 MySQL Redis Oracle .....)</span><br><span class="line">    Prometheus(专门监控Docker)</span><br><span class="line"></span><br><span class="line">4.如果你去到一家新公司，怎么着手完善监控？</span><br><span class="line">每个人所在的行业不同、公司不同、业务不同、岗位不同、对监控的理解也不同，但是我们需要注意，监控是需要站在公司的业务角度去考虑，而不是针对某个监控技术的使用。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">硬件监控</span><br><span class="line">	硬盘是否故障、CPU、内存是正常运行....（Dell IDRAC)</span><br><span class="line">	使用zabbix的IPMI接口监控硬件</span><br><span class="line">网络设备监控	路由器	交换机	zabbix snmp方式监控</span><br><span class="line">公有云		【云监控】</span><br><span class="line">系统监控	CPU使用率、负载内存使用率、磁盘使用率、I0（磁盘I0/网路I0）、进程、TCP状态</span><br><span class="line">应用服务	nginx、php、mysql、redis、nfs、rsync......</span><br><span class="line">安全监控	四层tcp/ip Firewalld nginx+lua=waf防火墙，拦截ddocs、cc、漏洞注入.....</span><br><span class="line">WEB监控	 请求时间、响应时间、加载时间、渲染时间....</span><br><span class="line">日志监控	elk 收集、存储、展示、分析</span><br><span class="line">API监控	 针对业务的接口进行监控（获取哪个接口返回效率比较低）</span><br><span class="line">自动化监控	网络发现（被动）zabbix-server--&gt;agent、自动注册（主动）agent--&gt;zabbix-server</span><br><span class="line">网络监控	 第三方 监控宝</span><br><span class="line">业务监控	 配合开发来实现</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">P480 shuijiao</span><br></pre></td></tr></table></figure>





<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">1.cpu (w、 top、 <span class="built_in">uptime</span>、 htop、 glances)</span><br><span class="line">用户空间	30-35%</span><br><span class="line">内核空间	60-65%</span><br><span class="line"></span><br><span class="line">CPU		0.8%</span><br><span class="line">user:	0.3%</span><br><span class="line">system:	0.3%</span><br><span class="line">idle:	99.4%</span><br><span class="line"></span><br><span class="line">2.内存（free、top、glances、htop）</span><br><span class="line">MEM		27.7%</span><br><span class="line">    total:	975M</span><br><span class="line">    used:	270M</span><br><span class="line">    free:	704M</span><br><span class="line"></span><br><span class="line">占用内存的计算方法：</span><br><span class="line">https://www.cnblogs.com/dachenzi/p/6812317.html</span><br><span class="line"></span><br><span class="line">3.磁盘(<span class="built_in">df</span> -h -i iotop glances)</span><br><span class="line">    inode</span><br><span class="line">    block</span><br><span class="line">    读写速率</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4.网络iftop、glances、nethogs</span><br><span class="line">NETWORK		Rx/s	Tx/s</span><br><span class="line">etho		69Kb	530Kb</span><br><span class="line">lo			5.07Mb 	5.07Mb</span><br><span class="line"></span><br><span class="line">	100Mbps（百兆带宽）	/8		12MB（实际下载速度）</span><br><span class="line"></span><br><span class="line">5.进程top</span><br><span class="line">	比如：平均持续2分钟，进程超过500</span><br><span class="line">	</span><br><span class="line">6.tcp状态</span><br><span class="line">	netstat</span><br><span class="line">	SS</span><br><span class="line"></span><br><span class="line">7.如果我想每1分钟监控当前系统的内存使用状态，如果可用低于100MB则发送邮件。同时打印当前还剩余多少内存</span><br><span class="line">    1.如何获取内存的状态信息free-m</span><br><span class="line">    2.如何获取内存的可用状态 free -m|awk <span class="string">&#x27;/^Mem/&#123;print $NF&#125;&#x27;</span></span><br><span class="line">    3.如何进行数字的比对，高于100MB不处理，低于100MB，发送邮件。</span><br><span class="line">    4.如何每分钟执行。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ZabbixServer ~]<span class="comment"># vim free.sh</span></span><br><span class="line"><span class="comment">#!/usr/bin/bash</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>;<span class="keyword">do</span></span><br><span class="line">	free_ava=$(free -m|awk <span class="string">&#x27;/^Mem/&#123;print $NF&#125;&#x27;</span>)</span><br><span class="line">	Hostname=$(hostname)_$(hostname -I|awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">	Date=$(<span class="built_in">date</span> +%F)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> [ <span class="variable">$free_ava</span> -lt 100 ];<span class="keyword">then</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$Date</span>: <span class="variable">$&#123;Hostname&#125;</span>,内存低于100MB,还有<span class="variable">$&#123;free_ava&#125;</span>MB内存可用&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">        <span class="built_in">sleep</span> 2</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">[root@ZabbixServer ~]<span class="comment"># sh free.sh</span></span><br><span class="line">[root@ZabbixServer ~]<span class="comment"># dd if=/dev/zero of=/dev/null bs=600M</span></span><br><span class="line"></span><br><span class="line">1.单台服务器如何去查看系统的指标	cpu	内存	磁盘	网络I0</span><br><span class="line">2.几台服务器的情况如何去监控	shell--&gt;系统命令（取值）--&gt;比对是否达到设定阈值--&gt;通知。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">借助第三方工具来实现监控：</span><br><span class="line">			Zabbix,10.0.0.71</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">zabbix版本</span><br><span class="line">	2</span><br><span class="line">	3.0 3.2 3.4</span><br><span class="line">基于lnmp环境--&gt;zabbix代码</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>2.单机时代如何监控</strong></p>
<p><a target="_blank" rel="noopener" href="http://man.linuxde.net/par/3">1.监控命令参考文档</a><br>1.CPU监控命令：w、top、htop、glances</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">%</span><span class="language-bash">cpu(s): 0.3 us, 0.3 sy, 0.0 ni, 99.3 <span class="built_in">id</span>, 0.0 wa, 0.0 hi, 0.0 si, 0.0 st</span></span><br><span class="line">	us 用户态：跟用户的操作有关 35%</span><br><span class="line">	sy 系统态：跟内核的处理有关 60%</span><br><span class="line">	id CPU空闲：</span><br></pre></td></tr></table></figure>

<p>2.内存监控命令：free</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ZabbixServer ~]# free -m</span><br><span class="line">		total		used		free	shared		buff/cache		available</span><br><span class="line">Mem:	974			440			194			4			340				328</span><br><span class="line">Swap:	2047		11			2036</span><br></pre></td></tr></table></figure>

<p>3.磁盘监控命令：df、iotop、iostat、dstat</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-3-centos ~]# iotop</span><br><span class="line">Total DISK READ :	0.00 B/s | Total DISK WRITE :       0.00 B/s</span><br><span class="line">Actual DISK READ:	0.00 B/s | Actual DISK WRITE:       0.00 B/s</span><br></pre></td></tr></table></figure>

<p>4.网络监控命令：ifconfig、route、glances、iftop、nethogs</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@ZabbixServer ~]# iftop</span><br><span class="line">bgx.com:https	=&gt; 101.200.101.219:57456	0b	9.53Kb	6.11Kb</span><br><span class="line">				&lt;=</span><br><span class="line">bgx.com:https	=&gt; 101.200.101.207:65254	0b	3.37Kb	1.12Kb</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">中间的&lt;==&gt;这两个左右箭头，表示的是流量的方向。</span></span><br><span class="line"></span><br><span class="line">TX:		cum:	170KB	#发送流量</span><br><span class="line">RX:				37.1KB	#接收流量</span><br><span class="line">TOTAL:			208KB	#总的流量</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果单位为Mbps.换算为MB需要除以8，比如：100Mbps = 12MB</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>5.TCP11状态监控netstat</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ZabbixServer ~]# netstat -an|grep ESTABLISHED</span><br><span class="line">[root@ZabbixServer ~]# netstat -lntup</span><br></pre></td></tr></table></figure>

<p>6.那单机时代，如何使用shell脚本来实现服务器的监控，比如：每隔1分钟监控一次内存，当你的可用内存低于100m，发邮件报警，要求显示剩余内存，具体实现思路如下：<br>1.怎么获取内存可用的值<code>free -m|awk &#39;/^Mem/&#123;print $NF&#125;&#39;</code><br>2.获取到内存可用的值如何和设定的阈值进行比较<br>3.比较如果大于100m则不处理，如果小于100则报警<br>4.如何每隔1分钟执行一次</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@ZabbixServer ~]# cat free.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">HostName=$(hostname)_$(hostname -i)</span><br><span class="line">Date=$(date +%F)</span><br><span class="line"></span><br><span class="line">while true;do</span><br><span class="line">	Free=$(free -m|awk &#x27;hsMem/&#123;print $NF&#125;&#x27;)</span><br><span class="line">	</span><br><span class="line">	if [ $Free -le 100 ];then</span><br><span class="line">		echo &quot;$Date: $HostName Mem Is &lt; $&#123;Free&#125;MB&quot;</span><br><span class="line">	fi</span><br><span class="line">	sleep 5</span><br><span class="line">done</span><br></pre></td></tr></table></figure>



<p><strong>day44-zabbix-day02</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix-server ~]# rpm -ivh https://mirrors.tuna.tsinghua.edu.cn/zabbix/zabbix/3.4/rhel/7/x86_64/zabbix-release-3.4-2.el7.noarch.rpm</span><br><span class="line">[root@zabbix-server ~]# yum install -y zabbix-server-mysql zabbix-web-mysql zabbix-agent mariadb-server</span><br><span class="line"></span><br><span class="line">1.启动数据库，创建数据库，配置数据库连接信息。</span><br><span class="line">[root@zabbix-server ~]# systemctl start mariadb</span><br><span class="line">[root@zabbix-server ~]# systemctl enable mariadb</span><br><span class="line">[root@zabbix-server ~]# mysql</span><br><span class="line"><span class="meta prompt_">shell&gt; </span><span class="language-bash">mysql -uroot -p&lt;password&gt;</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">create database zabbix character <span class="built_in">set</span> utf8 collate utf8_bin;</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">grant all privileges on zabbix.* to zabbix@localhost identified by <span class="string">&#x27;zabbix&#x27;</span>;</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">quit</span></span><br><span class="line"></span><br><span class="line">2.导入数据</span><br><span class="line">[root@zabbix-server ~]# cd /usr/share/doc/zabbix-server-mysql-3.4.15</span><br><span class="line">[root@zabbix-server zabbix-server-mysql-3.4.15]# zcat create.sql.gz |mysql -uroot zabbix</span><br><span class="line"></span><br><span class="line">3.修改vi /etc/zabbix/zabbix_server.conf zabbix-server连接数据库</span><br><span class="line">DBHost=localhost</span><br><span class="line">DBName=zabbix</span><br><span class="line">DBUser=zabbix</span><br><span class="line">DBPassword=zabbix</span><br><span class="line"></span><br><span class="line">[root@zabbix-server zabbix-server-mysql-3.4.15]# systemctl start zabbix-server</span><br><span class="line">[root@zabbix-server zabbix-server-mysql-3.4.15]# systemctl enable zabbix-server</span><br><span class="line"></span><br><span class="line">4.检查10051端口是否启动</span><br><span class="line">[root@zabbix-server ~]# netstat -lntp</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name           </span><br><span class="line">tcp        0      0 0.0.0.0:10051           0.0.0.0:*               LISTEN      2560/zabbix_server </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5.修改 vim/etc/httpd/conf.d/zabbix.conf 前端时区</span><br><span class="line">[root@zabbix-server ~]# vim /etc/httpd/conf.d/zabbix.conf </span><br><span class="line">        php_value max_execution_time 300</span><br><span class="line">        php_value memory_limit 128M</span><br><span class="line">        php_value post_max_size 16M</span><br><span class="line">        php_value upload_max_filesize 2M</span><br><span class="line">        php_value max_input_time 300</span><br><span class="line">        php_value max_input_vars 10000</span><br><span class="line">        php_value always_populate_raw_post_data -1</span><br><span class="line">        php_value date.timezone Asia/Shanghai</span><br><span class="line"></span><br><span class="line">6.启动httpd服务，并加入开机自启动</span><br><span class="line">[root@zabbix-server ~]# systemctl start httpd</span><br><span class="line">[root@zabbix-server ~]# systemctl enable httpd</span><br><span class="line"></span><br><span class="line">7.监控一台主机</span><br><span class="line">	1.得有1台机器</span><br><span class="line">	2.需要安装Agent</span><br><span class="line">    [root@web01 ~]# rpm -ivh https://mirrors.aliyun.com/zabbix/zabbix/3.4/rhel/7/x86_64/zabbix-agent-3.4.15-1.el7.x86_64.rpm</span><br><span class="line">    3.配置</span><br><span class="line">    [root@web01 ~]# vim /etc/zabbix/zabbix_agentd.conf </span><br><span class="line">    Server=192.168.160.171    #Zabbix-Server的IP地址</span><br><span class="line">    4.启动</span><br><span class="line">    [root@web01 ~]# systemctl start zabbix-agent</span><br><span class="line">    [root@web01 ~]# systemctl enable zabbix-agent</span><br><span class="line">    5.检查agent端口是否启动</span><br><span class="line">    [root@web01 ~]# netstat -lntp</span><br><span class="line">    Active Internet connections (only servers)</span><br><span class="line">    Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name         </span><br><span class="line">    tcp6       0      0 :::10050                :::*                    LISTEN      1900/zabbix_agentd  </span><br><span class="line">    6.打开zabbix-server的web界面</span><br><span class="line"></span><br><span class="line">    7.排查错误：</span><br><span class="line">        1.检查IP和端口</span><br><span class="line">        2.检查firewalld和selinux</span><br><span class="line">        3.检查配置文件</span><br><span class="line">        4.重载服务</span><br><span class="line">        5.关注日志</span><br><span class="line">zabbix-agent(数据采集)--&gt;zabbix-server(数据分析|报警）--&gt;数据库(数据存储)&lt;---zabbix web(数据展示）</span><br><span class="line"></span><br><span class="line">拆分数据库</span><br><span class="line">    1.准备一台172.16.1.51的数据库，安装mysql（版本一致）</span><br><span class="line">    yum install mariadb-server -y</span><br><span class="line">    systemctl start mariadb</span><br><span class="line">    systemctl enable mariadb</span><br><span class="line">     </span><br><span class="line">    2.创建zabbix数据库，授权（网络授权）</span><br><span class="line">    mysql</span><br><span class="line">    create database zabbix character set utf8 collate utf8_bin;</span><br><span class="line">    grant all privileges on zabbix.* to zabbix@&#x27;%&#x27; identified by &#x27;zabbix&#x27;;</span><br><span class="line">    quit</span><br><span class="line">    </span><br><span class="line">    3.在旧数据库上备份库，然后恢复到新的数据库。</span><br><span class="line">    [root@ZabbixServer ～]# mysqldump -uroot \</span><br><span class="line">	--databases zabbix \</span><br><span class="line">	--single-transaction &gt; `date +%F%H`-zabbix.sql</span><br><span class="line"><span class="meta prompt_">	</span></span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash">远程导入数据</span></span><br><span class="line">	[root@zabbix-server ~]# cat 2022-03-2320-zabbix.sql |mysql -h192.168.160.151 -uzabbix -pzabbix zabbix</span><br><span class="line"></span><br><span class="line">    4.修改Zabbix-Server配置文件指向数据库的IP</span><br><span class="line">    [root@zabbix-server ~]# vim /etc/zabbix/zabbix_server.conf </span><br><span class="line">    DBHost=192.168.160.151</span><br><span class="line">	[root@zabbix-server ~]# systemctl restart zabbix-server</span><br><span class="line"></span><br><span class="line">    5.修改Zabbix-Web配置文件指向数据库的IP</span><br><span class="line">    [root@zabbix-server ~]# vim /etc/zabbix/web/zabbix.conf.php</span><br><span class="line">    $DB[&#x27;SERVER&#x27;]   = &#x27;192.168.160.151&#x27;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Database error  #数据库错误</span><br><span class="line">Error connecting to database: Can&#x27;t connect to local MySQL server through socket &#x27;/var/lib/mysql/mysql.sock&#x27; (2)</span><br></pre></td></tr></table></figure>

<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220323185843751.png" alt="image-20220323185843751"></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220323202417819.png" alt="image-20220323202417819"></p>
<p><strong>day45-zabbix-day03</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line">自定义监控item</span><br><span class="line">触发器---&gt;动作--&gt;（通知|执行远程命令）</span><br><span class="line">自定义触发器&gt;告警升级</span><br><span class="line"></span><br><span class="line">自定义图形</span><br><span class="line"></span><br><span class="line">聚合图形</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.安装graphtree</span></span><br><span class="line">cd /usr/share/zabbix</span><br><span class="line">wget https://raw.githubusercontent.com/OneOaaS/graphtrees/master/graphtree3.0.4.patch</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.导入补丁包</span></span><br><span class="line">yum install -y patch</span><br><span class="line">patch -Np0 &lt;graphtree3.0.4.patch</span><br><span class="line">chown -R apache.apache oneoaas</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.修改Apache配置文件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vim /etc/httpd/conf.d/zabbix.conf</span></span><br><span class="line">Alias /oneoaas /usr/share/zabbix/oneoaas</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4.重启httpd服务</span></span><br><span class="line">systemctl restart httpd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">解决中文乱码问题</span></span><br><span class="line">[root@zabbix-server dejavu]# rpm -ql zabbix-web|grep font</span><br><span class="line">/usr/share/zabbix/fonts</span><br><span class="line">[root@zabbix-server alternatives]# cd /usr/share/fonts/dejavu/</span><br><span class="line">[root@zabbix-server dejavu]# mv DejaVuSans.ttf DejaVuSans.ttf.bak</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从window上C:\WINDOWS\Fonts拉取字体 微软雅黑 msyh.ttc</span></span><br><span class="line">[root@zabbix-server dejavu]# mv msyh.ttc DejaVuSans.ttf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@web01 zabbix_agentd.d]# cat test.conf</span><br><span class="line">UserParameter=tcp[*],netstat -an |grep -wc &quot;$1&quot;</span><br><span class="line">UserParameter=mem.ava,free -m|awk &#x27;/^Mem/&#123;print $NF/$2*100&#125;&#x27;</span><br><span class="line">UserParameter=swap.ava,free -m|awk &#x27;/^Swap/&#123;print $3/$2*100&#125;&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@zabbix-server dejavu]# yum install -y zabbix-get</span><br><span class="line">[root@zabbix-server dejavu]# zabbix_get -s 192.168.160.149 -k tcp[ESTABLISHED]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">幻灯片</span><br><span class="line">模板</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.比如监控Nginx的状态，怎么做？</span><br><span class="line">1.端口是否正常</span><br><span class="line">2.stub_status 7种状态</span><br><span class="line"><span class="meta prompt_">--&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">1.安装nginx</span></span><br><span class="line">2.开启stub_status</span><br><span class="line">[root@web01 conf.d]# vim /etc/nginx/conf.d/try.conf</span><br><span class="line">        location /nginx_status &#123;</span><br><span class="line">                stub_status;</span><br><span class="line">                allow 127.0.0.1;</span><br><span class="line">                deny all;</span><br><span class="line">        &#125;</span><br><span class="line">[root@web01 conf.d]# systemctl restart nginx</span><br><span class="line">[root@web01 conf.d]# curl 127.0.0.1/nginx_status</span><br><span class="line">Active connections: 1 </span><br><span class="line">server accepts handled requests</span><br><span class="line"> 1 1 1 </span><br><span class="line">Reading: 0 Writing: 1 Waiting: 0 </span><br><span class="line">3.获取每个状态的指标</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Active</span></span><br><span class="line">[root@web01 conf.d]# curl -s 127.0.0.1/nginx_status|awk &#x27;/^Active/ &#123;print $NF&#125;&#x27;</span><br><span class="line">1</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">accepts</span></span><br><span class="line">[root@web01 conf.d]# curl -s 127.0.0.1/nginx_status|awk &#x27;NR==3 &#123;print $1&#125;&#x27;</span><br><span class="line">5</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">handled</span></span><br><span class="line">[root@web01 conf.d]# curl -s 127.0.0.1/nginx_status|awk &#x27;NR==3 &#123;print $2&#125;&#x27;</span><br><span class="line">6</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">request</span></span><br><span class="line">[root@web01 conf.d]# curl -s 127.0.0.1/nginx_status|awk &#x27;NR==3 &#123;print $3&#125;&#x27;</span><br><span class="line">7</span><br><span class="line"></span><br><span class="line">4.将获取到的状态做成监控项</span><br><span class="line">[root@web01 ~]# cd /etc/zabbix/zabbix_agentd.d/</span><br><span class="line">[root@web01 zabbix_agentd.d]# vim nginx.conf</span><br><span class="line">UserParameter=nginx.active,curl -s 127.0.0.1/nginx_status|awk &#x27;/^Active/ &#123;print $NF&#125;&#x27;</span><br><span class="line">UserParameter=nginx.accepts,curl -s 127.0.0.1/nginx_status|awk &#x27;NR==3 &#123;print $1&#125;&#x27;</span><br><span class="line">UserParameter=nginx.handled,curl -s 127.0.0.1/nginx_status|awk &#x27;NR==3 &#123;print $2&#125;&#x27;</span><br><span class="line">UserParameter=nginx.request,curl -s 127.0.0.1/nginx_status|awk &#x27;NR==3 &#123;print $3&#125;&#x27;</span><br><span class="line">[root@web01 ~]# systemctl restart zabbix-agent</span><br><span class="line">[root@web01 ~]# zabbix_agentd -p</span><br><span class="line"></span><br><span class="line">5.在web界面创建模板-&gt;创建监控项（8次）--&gt;创建触发器（端口是否正常）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">P504 睡觉</span><br><span class="line"></span><br><span class="line">2.监控php-fpm的状态？</span><br><span class="line">1.启用php-fpm的状态？</span><br><span class="line">[root@web01 ~]# vim /etc/php-fpm.d/www.conf </span><br><span class="line">user = www</span><br><span class="line">group = www</span><br><span class="line">listen = 127.0.0.1:9000</span><br><span class="line">listen.allowed_clients = 127.0.0.1</span><br><span class="line">pm = dynamic</span><br><span class="line">pm.max_children = 512</span><br><span class="line">pm.start_servers = 32</span><br><span class="line">pm.min_spare_servers = 32</span><br><span class="line">pm.max_spare_servers = 64</span><br><span class="line">pm.process_idle_timeout = 10s;</span><br><span class="line">pm.max_requests = 500</span><br><span class="line">pm.status_path = /phpfpm_status</span><br><span class="line"></span><br><span class="line">[root@web01 ~]# systemctl restart php-fpm</span><br><span class="line"></span><br><span class="line">2.配置Aginx访问php-fpm的状态？</span><br><span class="line">[root@web01 conf.d]# vim /etc/nginx/conf.d/try.conf </span><br><span class="line">location /phpfpm_status &#123;</span><br><span class="line">	fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">	fastcgi_param SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">	include         fastcgi_params;</span><br><span class="line">&#125;</span><br><span class="line">2.根据状态，提取需要的指标？</span><br><span class="line">3.将系统提取到的指标做成监控项？</span><br><span class="line">4.在web界面创建模板-&gt;创建监控项-&gt;创建触发器</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">作业：</span><br><span class="line">0.tcp11中状态监控写成脚本</span><br><span class="line">1.nginx状态监控（完整的，脚本方式），nginx的状态码监控（200,301,302,404,403,500,502）</span><br><span class="line">2.php-fpm状态监控（完整的，脚本方式）</span><br><span class="line">3.redis监控上(redis-cliinfo监控5个指标,写脚本方式）</span><br><span class="line">4.percona监控mysql</span><br><span class="line">5.使用jmx监控tomcat[学tomcat时才会在讲的]</span><br><span class="line">6.最后做好的模板，脚本，conf文件，导入存储本地。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220325123701780.png" alt="image-20220325123701780"></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220325123810935.png" alt="image-20220325123810935"></p>
<p><strong>day46-zabbix-day04</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">web监测</span><br><span class="line">1.使用curl命令模拟登陆zabbix服务器,获取cookie,将cookie保存至本地cook文件中</span><br><span class="line">[root@m01 ~]# curl -L -c cook -b cook &#x27;http://10.0.0.61/zabbix/index.php&#x27;</span><br><span class="line"></span><br><span class="line">2.再次访问时，携带cook信息，同时使用-d参数携带用户以及密码，模拟登陆</span><br><span class="line">[root@web01 ~]# curl -L -c cook -b cook -d &#x27;name=Admin&amp;password=zabbix&amp;autologn+in&#x27; &#x27;http://192.168.160.171/zabbix/index.php&#x27;</span><br><span class="line"></span><br><span class="line">regex:name=&quot;sid&quot; value=&quot;([0-9a-z]&#123;16&#125;)&quot;</span><br><span class="line"></span><br><span class="line">web场景监测</span><br><span class="line">	1.创建一个场景--&gt;监控zabbix服务器</span><br><span class="line">		1）访问zabbix</span><br><span class="line">		2）登录zabbix  &#123;会话信息&#125;</span><br><span class="line">		3）检查zabbix</span><br><span class="line">		4）退出zabbix</span><br><span class="line">		5）检查是否退出</span><br><span class="line">	作业：使用web监测wordpress</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">自动化监控</span><br><span class="line">    网络发现（被动）</span><br><span class="line">        1.配置自动发现规则</span><br><span class="line">        2.如果自动发现规则生效--&gt;触发动作--&gt;条件（）---&gt;添加主机-&gt;主机组--》模板</span><br><span class="line">            如果发生以下情况，动作（action）将被激活：</span><br><span class="line">            &quot;Zabbix agent&quot;服务是&quot;up&quot;</span><br><span class="line">            system.uname(规则中定义的Zabbix agent键值)包含&quot;Linux&quot;</span><br><span class="line">            正常运行时间为1小时（3600秒）或更长</span><br><span class="line">    网络发现缺陷：</span><br><span class="line">		1.发现太慢</span><br><span class="line">		2.是轮询扫描网段</span><br><span class="line">		3.如果网段中存在不同的主机--&gt;会出现卡顿--&gt;造成后续新增的服务器无法加入节点</span><br><span class="line">		4.会导致server性能变缓</span><br><span class="line">    </span><br><span class="line">    作业：基于不同的服务端的主机名称分配到不同的模板</span><br><span class="line"></span><br><span class="line">自动注册（主动）</span><br><span class="line">    1.安装agent</span><br><span class="line">    2.推送所有的脚本以及.conf配置文件至该服务器</span><br><span class="line">    3.在zabbix-server上配置动作（根据不同的主机名称）</span><br><span class="line"></span><br><span class="line">Agent主动向Server上报  （agent配置ServerActive以及Hostname)</span><br><span class="line"></span><br><span class="line">主动和被动模式区别（面试）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">默认标题</span><br><span class="line">自动发现主机IP:&#123;DISCOVERY.DEVICE.IPADDRESS&#125;</span><br><span class="line"></span><br><span class="line">消息内容</span><br><span class="line">客户端名称:&#123;DISCOVERY.SERVICE.NAME&#125;</span><br><span class="line">客户端端口:&#123;DISCOVERY.SERVICE.PORT&#125;</span><br><span class="line">客户端状态:&#123;DISCOVERY.SERVICE.STATUS&#125;</span><br><span class="line"></span><br><span class="line">操作动作</span><br><span class="line">添加主机，添加主机组，链接模板，发送邮件，等等</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---------------------------------</span><br><span class="line">1.zabbix内部资源结构</span><br><span class="line">2.zabbixweb监测</span><br><span class="line">    cookie和session    session共享   session复制</span><br><span class="line">    curl命令模拟登陆网站</span><br><span class="line">    web监测一个网站</span><br><span class="line">        1.打开网站</span><br><span class="line">        2.登陆网站</span><br><span class="line">        3.检查登陆</span><br><span class="line">        4.退出登陆</span><br><span class="line">        5.检查退出</span><br><span class="line">作业：使用web监测wordpress（会话ID）</span><br><span class="line"></span><br><span class="line">3.自动化监控</span><br><span class="line">    网络发现（被动模式）</span><br><span class="line">    	1.扫描效率低（于个进程扫描一个网段很麻烦）</span><br><span class="line">		2.容易漏扫描（扫描的时候刚好掉线了。）</span><br><span class="line">		3.如果有网段主机hang住，后面的主机容易没有被扫描到，而又开始重新扫描。</span><br><span class="line"></span><br><span class="line">    自动注册（主动模式）</span><br><span class="line">		agent自动注册到server根据不同的主机名称关联不同的模板</span><br><span class="line">		效率高</span><br><span class="line">		</span><br><span class="line">	主动模式和被动模式的区别（监控项）</span><br><span class="line">		被动是由server去轮询查询agent监控项的值，如果有100个监控项，需要100个来回。</span><br><span class="line">		主动是由agent主动发送所有的数据，比如server询问100个监控项的值，agent会一次返回给server。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220325131139069.png" alt="image-20220325131139069"></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220325134359487.png" alt="image-20220325134359487"></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220325132544337.png" alt="image-20220325132544337"></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220325132829596.png" alt="image-20220325132829596"></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220325133120545.png" alt="image-20220325133120545"></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220325133146153.png" alt="image-20220325133146153"></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220325144641798.png" alt="image-20220325144641798"></p>
<p><strong>1.Web场景监测概述</strong><br><strong>1.Web网站中什么是动态网站，什么是静态网站</strong><br>静态网站：纯静态网站就是服务器的源代码和客户端的源代码一致。<br>动态网站：比如：&lt;？php phpinfo()？&gt;每次用户访问的时候，内容都是在内存中动态生成的。动态网站支持登<br>陆，支持用户交互，所以用户在请求动态网站时，会给客户端下发一个叫sessionlD的内容，那么客户端则会<br>将SessionlD保存至浏览器的cookie中。<br><strong>2.当用户访问Web网站时，session和cookie是如何进行工作的</strong><br>1）当用户首次访问动态网站时，是不会携带cookie信息，那么在服务端返回网页的时候，会给该客户端的浏<br>览器分配一个唯一的sessionlD，客户端会将sessionlD存储至浏览器的Cookie中。<br>2)当用户再次访问网站时，浏览器会在Header头信息添加Set-Cookie，Set-Cookie携带的则是该网站对应的<br>sessionlD信息，服务端接收后会进行校验</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220325124208405.png" alt="image-20220325124208405"></p>
<p><strong>3.Zabbix主被模式区别</strong><br><strong>1.主动模式与被动模式区别</strong><br>    1)被动模式(Zabbix-server轮询检测zabbix-agent)<br>    2)主动模式（Zabbix-agent主动上报给Zabbix-server)<br><strong>2.主动模式与被被动模式选择如何选择</strong><br>    1.当Queue里有大量延迟的监控项<br>    2.当监控主机超过300+，建议使用主动模式。</p>
<p><strong>4.Zabbix主被模式实践</strong><br>1.Zabbix被动模式演示取值：Zabbix默认是被动模式，被动模式如果需要获取100个监控项的值，需要Server<br>向Agent获取100次。（注意zabbix图中的时间)</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220325152442493.png" alt="image-20220325152442493"></p>
<p>3.如何将Zabbix调整为主动模式</p>
<ol>
<li>修改&#x2F;etc&#x2F;zabbix&#x2F;zabbix_agent.conf配置文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@web83 ~]# vim /etc/zabbix/zabbix_agentd.conf</span><br><span class="line">ServerActive=172.16.1.71</span><br><span class="line">Hostname=  #填写主机名称</span><br></pre></td></tr></table></figure>

<p>2)Zabbix需要更新模板为Active<br>1.克隆一份被动模式的模板<br>2.点击克隆后的模板-&gt;选中所有监控项-&gt;批量修改-&gt;修改为主动模式<br>3.主机取消链接并清理被动模板，重新关联新模板即可。</p>
<h2 id="day48-firewalld"><a href="#day48-firewalld" class="headerlink" title="day48-firewalld"></a><strong>day48-firewalld</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line">区域</span><br><span class="line">iptables		firewalld</span><br><span class="line"></span><br><span class="line">安全框架		OSI</span><br><span class="line"></span><br><span class="line">硬件		机架上锁（机柜）温度硬件检查</span><br><span class="line">网络		iptables/firewalld 仅匀速公司的IP地址能连接服务器的22端口	公有云使用	安全组</span><br><span class="line">系统		没有公网IP、修改ssh端口、禁止root直接登陆、使用密钥登陆</span><br><span class="line">服务		mysql、redis、即使更新服务，防止漏洞被人攻击</span><br><span class="line">网站		漏洞注入		sql注入		 ddos		 waf防火墙		SSL证书	保证网站的传输安全</span><br><span class="line"></span><br><span class="line">安全狗</span><br><span class="line">知道创宇</span><br><span class="line">牛盾云</span><br><span class="line"></span><br><span class="line">firewalld	之能做和IP/Port相关的限制，web相关的限制无法实现。</span><br><span class="line"></span><br><span class="line">SLA</span><br><span class="line">1年 = 365天 = 8760小时</span><br><span class="line">99.9 = 8760 * 0.1% = 8760 * 0.001= 8.76小时</span><br><span class="line">99.99 = 8760 * 0.0001= 0.876小时 =0.876 * 60= 52.6分钟</span><br><span class="line">99.999 = 8760 * 0.00001 = 0.0876小时 = 0.0876 * 60= 5.26分钟</span><br><span class="line"></span><br><span class="line">需要注意的是：</span><br><span class="line">如果开启防火墙工具，并且没有配置任何允许的规则，那么丛外部访问防火墙这台主机默认会被阻止，但如果直接丛防火墙内部往外部流出的流量默认会被允许。</span><br><span class="line"></span><br><span class="line">需要注意的是Firewalld中的区域与接口</span><br><span class="line">一个网卡仅能绑定一个区域，  eth0 --&gt;A区域  A区域--&gt;eth0 eth1 eth2</span><br><span class="line">但一个区域可以绑定多个网卡。</span><br><span class="line">还可以根据来源的地址设定不同的规则。比如：所有人能访问80端口，但只有公司的IP才允许访问22端口。</span><br><span class="line"></span><br><span class="line">trusted		白名单</span><br><span class="line">public		默认</span><br><span class="line">drop		黑名单</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">runtime运行时：修改规则马上生效，但如果重启服务则马上失效，测试建议。</span><br><span class="line">permanent持久配置：修改规则后需要reload重载服务才会生效，生产建议。</span><br><span class="line"></span><br><span class="line">1.启动firewalld防火墙，并加入开机自启动服务</span><br><span class="line">[root@Firewalld ~]# systemctl start firewalld</span><br><span class="line">[root@Firewalld ~]# systemctl enable firewalld</span><br><span class="line"></span><br><span class="line">2.了解我们使用的是哪个区域</span><br><span class="line">[root@localhost ~]# firewall-cmd --get-default-zone</span><br><span class="line">public</span><br><span class="line"></span><br><span class="line">3.使用--list-all 获取当前默认区域的规则</span><br><span class="line">[root@localhost ~]# firewall-cmd --list-all</span><br><span class="line">public (active)</span><br><span class="line">  target: default</span><br><span class="line">  icmp-block-inversion: no</span><br><span class="line">  interfaces: eth0</span><br><span class="line">  sources: </span><br><span class="line">  services: dhcpv6-client ssh</span><br><span class="line">  ports: </span><br><span class="line">  protocols: </span><br><span class="line">  masquerade: no</span><br><span class="line">  forward-ports: </span><br><span class="line">  source-ports: </span><br><span class="line">  icmp-blocks: </span><br><span class="line">  rich rules: </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4.使用firewalld各个区域规则结合配置，调整默认public区域拒绝所有流量，但如果来源IP是10.0.0.0/24网段则允许。</span><br><span class="line">	必须根据来源的地址设定，给其添加至一个规则，这样才能做到多区域。</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# firewall-cmd --remove-service=ssh</span><br><span class="line">success</span><br><span class="line">[root@localhost ~]# firewall-cmd --add-source=192.168.160.1/32 --zone=trusted</span><br><span class="line">success</span><br><span class="line"></span><br><span class="line">5.检查当前活动的区域</span><br><span class="line">[root@localhost ~]# firewall-cmd --get-active-zone</span><br><span class="line">public</span><br><span class="line">  interfaces: eth0</span><br><span class="line">trusted</span><br><span class="line">  sources: 192.168.160.1/32</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">firewalld放行某个服务的流量</span><br><span class="line">[root@localhost ~]# firewall-cmd --add-service=http</span><br><span class="line">success</span><br><span class="line">firewalld移除某个服务的流量</span><br><span class="line">[root@localhost ~]# firewall-cmd --remove-service=http</span><br><span class="line">success</span><br><span class="line"></span><br><span class="line">注意--permanent  如果添加则代表永久，否则都临时</span><br><span class="line"></span><br><span class="line">firewalld放行某个端口的流量</span><br><span class="line">[root@localhost ~]# firewall-cmd --add-port=80/tcp</span><br><span class="line">success</span><br><span class="line">firewalld移除某个端口的流量</span><br><span class="line">[root@localhost ~]# firewall-cmd --remove-port=80/tcp</span><br><span class="line">success</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">firewalld放行自定义服务</span><br><span class="line">	1.名称代表后面添加的服务名称</span><br><span class="line">[root@m01 ~]# cp /usr/lib/firewalld/services/&#123;http.xml,zabbix-agent.xml&#125;</span><br><span class="line">	2.重载firewalld</span><br><span class="line">[root@m01 services]# firewall-cmd --reload</span><br><span class="line">success</span><br><span class="line">	3.添加自定义后的服务名</span><br><span class="line">[root@m01 services]# firewall-cmd --add-service=zabbix-agent</span><br><span class="line">success</span><br><span class="line"></span><br><span class="line">	建议：以后就直接添加端口就行。</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">firewalld实现端口转发（端口映射）只能转发tcp相关的服务</span><br><span class="line">[root@m01 services]# firewall-cmd --add-forward-port=port=2222:proto=tcp:toport=22:toaddr=172.16.1.7</span><br><span class="line">success</span><br><span class="line">[root@m01 services]# firewall-cmd --list-all</span><br><span class="line">public (active)</span><br><span class="line">  target: default</span><br><span class="line">  icmp-block-inversion: no</span><br><span class="line">  interfaces: eth0 eth1</span><br><span class="line">  sources: </span><br><span class="line">  services: dhcpv6-client ssh zabbix-agent</span><br><span class="line">  ports: </span><br><span class="line">  protocols: </span><br><span class="line">  masquerade: no</span><br><span class="line">  forward-ports: port=2222:proto=tcp:toport=22:toaddr=172.16.1.7</span><br><span class="line">  source-ports: </span><br><span class="line">  icmp-blocks: </span><br><span class="line">  rich rules: </span><br><span class="line">	</span><br><span class="line">[root@m01 network-scripts]# firewall-cmd --add-masquerade</span><br><span class="line">success</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">######必写👇############</span></span></span><br><span class="line">rule [family=&quot;ipv4|ipv6&quot;]</span><br><span class="line">source address=&quot;faddress[/mask]&quot; [invert=&quot;True&quot;]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">########################</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">######任意写其一👇############</span></span></span><br><span class="line">service name=&quot;service name&quot;</span><br><span class="line">port port=&quot;port value&quot; protocol=&quot;tcp|udp&quot;</span><br><span class="line">protocol value=&quot;protocol value&quot;</span><br><span class="line">forward-port port=&quot;port value&quot; protocol=&quot;tcp|udp&quot; to-port=&quot;port value&quot; to-addr=&quot;address&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#############################</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">######必写👇############</span></span></span><br><span class="line">accept | reiect [type=&quot;reiect type&quot;] | drop   #	accept 允许	reiect 婉拒	drop直拒</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">########################</span></span></span><br><span class="line"></span><br><span class="line">1.比如允许10.0.0.1主机能够访问http服务，允许172.16.1.0/24能访问10050端口</span><br><span class="line">[root@m01 ~]# firewall-cmd --add-rich-rule=&#x27;rule family=ipv4 source address=&quot;10.0.0.1&quot; service name=http accept&#x27;</span><br><span class="line">[root@m01 ~]# firewall-cmd --add-rich-rule=&#x27;rule family=ipv4 source address=&quot;172.16.1.0/24&quot; port port=&quot;10050&quot; protocol=&quot;tcp&quot; accept&#x27;</span><br><span class="line"></span><br><span class="line">2.默认public区域对外开放所有人能通过ssh服务连接，但拒绝172.16.1.0/24网段通过ssh连接服务器</span><br><span class="line">[root@m01 ~]# firewall-cmd --add-rich-rule=&#x27;rule family=ipv4 source address=&quot;172.16.1.0/24&quot; service name=ssh drop&#x27;</span><br><span class="line"></span><br><span class="line">3.使用firewalld,允许所有人能访问http,https服务，但只有10.0.0.1主机可以访问ssh服务</span><br><span class="line">[root@m01 ~]# firewall-cmd --remove-service=ssh</span><br><span class="line">[root@m01 ~]# firewall-cmd --add-service=&#123;http,https&#125;</span><br><span class="line">[root@m01 ~]# firewall-cmd --add-rich-rule=&#x27;rule family=ipv4 source address=10.0.0.1/32 service name=ssh accept&#x27;</span><br><span class="line"></span><br><span class="line">4.当用户来源IP地址是10.0.0.1主机，则将用户请求的5555端口转发至后端172.16.1.9的22端口</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">firewalld的备份?</span><br><span class="line">	我们所有针对public区域编写的永久添加的规则都会写入备份文件（--permanent）</span><br><span class="line">	/etc/firewalld/zones/public.xml</span><br><span class="line"></span><br><span class="line">	ssh openvpn 都只是实现通过外网访问内部主机</span><br><span class="line">	firewalld、路由器	都是用来解决内部主机共享上网的</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------------firewalld内部共享上网</span><br><span class="line">1.firewalld |防火墙开启masquerade，实现地址转换</span><br><span class="line">[root@Firewalld ~]# firewall-cmd --add-masquerade --permanent</span><br><span class="line">[root@Firewalld ~]# firewall-cmd --reload</span><br><span class="line"></span><br><span class="line">2.客户端将网关指向firewalld服务器，将所有网络请求交给firewalld</span><br><span class="line">[root@web03 ~]# cat /etc/sysconfig/network-scripts/ifcfg-eth1</span><br><span class="line">GATEWAY=172.16.1.61</span><br><span class="line"></span><br><span class="line">3.客户端还需配置dns服务器</span><br><span class="line">[root@web03 ~]# cat /etc/resolv.conf</span><br><span class="line">nameserver 223.5.5.5</span><br><span class="line"></span><br><span class="line">4.重启网络，使其配置生效</span><br><span class="line">[root@web03 ~]# nmcli connection reload</span><br><span class="line">[root@web03 ~]# nmcli connection down eth1 &amp;&amp; nmcli connection up eth1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5.测试后端web的网络是否正常</span><br><span class="line">[root@m01 ~]# ping www.baidu.com</span><br><span class="line">PING www.baidu.com (14.215.177.38) 56(84) bytes of data.</span><br><span class="line">64 bytes from www.baidu.com (14.215.177.38): icmp_seq=1 ttl=128 time=25.0 ms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">firewalld/  firewall-config图形</span><br><span class="line">    区域概念</span><br><span class="line">    放行端口、基于端口做成自定义的服务</span><br><span class="line">    放行服务</span><br><span class="line">    端口转发</span><br><span class="line">    富规则</span><br><span class="line">	内部共享上网</span><br></pre></td></tr></table></figure>



<p><strong>1.防火墙安全基本概述</strong></p>
<p>在CentOS7系统中集成了多款防火墙管理工具，默认启用的是firewalld(动态防火墙管理器)防火墙管理工具，Firewalld支持CLI(命令行）以及GUI（图形）的两种管理方式。<br>对于接触Linux较早的人员对ptables比较的熟悉，但由于Iptables的规则比较的麻烦，并网络有一定要求，所以学习成本较高。但Firewalld的学习对网络并没有那么高的要求，相对ptables来说要简单不少。就好比如（手动挡汽车VS自动挡汽车），所以建议刚接触CentOS7系统的人员直接学习Firewalld</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220327102750761.png" alt="image-20220327102750761"></p>
<p>需要注意的是：如果开启防火墙工具，并且没有配置任何允许的规则，那么丛外部访问防火墙设备默认会被阻止，但如果直接丛防火墙内部往外部流出的流量默认会被允许。</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220327103443214.png" alt="image-20220327103443214"></p>
<p><strong>2.防火墙使用区域管理</strong><br>那么相较于传统的lptables防火墙，firewalld支持动态更新，并加入了区域zone的概念。<br>简单来说，区域就是firewalld预先准备了几套防火墙策略集合（策略模板），用户可以根据不同的场景而选择不同的策略模板，从而实现防火墙策略之间的快速切换。</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220327103917516.png" alt="image-20220327103917516"></p>
<p><strong>4.防火墙区域配置策略</strong><br>1.为了能正常使用firwalld服务和相关工具去管理防火墙，必须启动firwalld服务，同时关闭以前旧防火墙相关服务。需要注意firewalld的规则分两种状态：<br>runtime运行时：修改规则马上生效，但如果重启服务则马上失效，测试建议。<br>permanent持久配置：修改规则后需要reload重载服务才会生效，生产建议。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.禁用旧版防火墙服务</span></span><br><span class="line">[root@Firewalld ~]# systemctl mask iptables</span><br><span class="line">[root@Firewalld ~]# systemctl mask ip6tables</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.启动firewalld防火墙，并加入开机自启动服务</span></span><br><span class="line">[root@Firewalld ~]# systemctl start firewalld</span><br><span class="line">[root@Firewalld ~]# systemctl enable firewalld</span><br></pre></td></tr></table></figure>

<p>2.firewalld启动后，我们需要知道使用的是什么区域，区域的规则明细又有哪些？</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.通过--qet-default-zone获取当前默认使用的区域</span></span><br><span class="line">[root@Firewalld ~]# firewall-cmd --get-default-zone</span><br><span class="line">public</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.通过--list-all查看当前默认区域配置了哪些规则</span></span><br><span class="line">[root@Firewalld ~]# firewall-cmd --list-all</span><br><span class="line">public (active)</span><br><span class="line">  target: default</span><br><span class="line">  icmp-block-inversion: no</span><br><span class="line">  interfaces: eth0</span><br><span class="line">  sources: </span><br><span class="line">  services: dhcpv6-client ssh</span><br><span class="line">  ports: </span><br><span class="line">  protocols: </span><br><span class="line">  masquerade: no</span><br><span class="line">  forward-ports: </span><br><span class="line">  source-ports: </span><br><span class="line">  icmp-blocks: </span><br><span class="line">  rich rules: </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>7.防火墙端口转发策略</strong><br>端口转发是指传统的目标地址映射，实现外网访问内网资源，流量转发命令格式为：firewall-cmd–permanent –zone&#x3D;&lt;区域&gt;-add-forward-port&#x3D;port&#x3D;&lt;源端口号&gt;:proto&#x3D;&lt;协议&gt;:toport&#x3D;&lt;目标端口号&gt;:toaddr&#x3D;&lt;目标P地址&gt;</p>
<p>如果需要将本地的10.0.0.61:5555端口转发至后端172.16.1.9:22端口</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220327145446854.png" alt="image-20220327145446854"></p>
<p><strong>8.防火墙富规则策略</strong><br>firewalld中的富规则表示更细致、更详细的防火墙策略配置，它可以针对系统服务、端口号、源地址和目标地址等诸多信息进行更有针对性的策略配置，优先级在所有的防火墙策略中也是最高的。，下面为firewalld富规则帮助手册</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@Firewalld ~]# man firewall-cmd  #帮助手册</span><br><span class="line">[root@Firewalld ~]# man firewalld.richlanguage  #获取富规则手册</span><br><span class="line">	rule</span><br><span class="line">    [source]</span><br><span class="line">    [destination]</span><br><span class="line">    service|port|protocol|icmp-block|masquerade|forward-port</span><br><span class="line">    [1og]</span><br><span class="line">    [audit]</span><br><span class="line">    [accept|reject|drop]</span><br><span class="line"></span><br><span class="line">rule [family=&quot;ipv4|ipv6&quot;]</span><br><span class="line">source address=&quot;faddress[/mask]&quot; [invert=&quot;True&quot;]</span><br><span class="line">destination address=&quot;address[/mask]&quot; invert=&quot;True&quot;</span><br><span class="line">service name=&quot;service name&quot;</span><br><span class="line">port port=&quot;port value&quot; protocol=&quot;tcp|udp&quot;</span><br><span class="line">protocol value=&quot;protocol value&quot;</span><br><span class="line">forward-port port=&quot;port value&quot; protocol=&quot;tcp|udp&quot; to-port=&quot;port value&quot; to-addr=&quot;address&quot;</span><br><span class="line">log [prefix=&quot;prefix text&quot;] [level=&quot;log level&quot;] [limit value=&quot;rate/duration&quot;] </span><br><span class="line">accept | reiect [type=&quot;reiect type&quot;] | drop</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">富规则相关命令</span></span><br><span class="line">--add-rich-rule=&#x27;&lt;RULE&gt;&#x27;	#座指定的区添加一条富规则</span><br><span class="line">--remove-rich-rule=&#x27;&lt;RULE&gt;&#x27;	#在指定的区删除一条富规则</span><br><span class="line">--query-rich-rule=&#x27;&lt;RULE&gt;&#x27;	#找到规则返回o，找不到返回1</span><br><span class="line">--list-rich-rules			#列出指定区里的所有富规则</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.比如允许10.0.0.1主机能够访问http服务，允许172.16.1.0/24能访问10050端口</span><br><span class="line">[root@m01 ~]# firewall-cmd --add-rich-rule=&#x27;rule family=ipv4 source address=&quot;10.0.0.1&quot; service name=http accept&#x27;</span><br><span class="line">[root@m01 ~]# firewall-cmd --list-all</span><br><span class="line">public (active)</span><br><span class="line">  rich rules: </span><br><span class="line">	rule family=&quot;ipv4&quot; source address=&quot;10.0.0.1&quot; service name=&quot;http&quot; accept</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>9.防火墙开启内部上网</strong></p>
<p>在指定的带有公网IP的实例上启动Firewalld防火墙的NAT地址转换，以此达到内部主机上网。</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220328094502313.png" alt="image-20220328094502313"></p>
<p>1.firewalld |防火墙开启masquerade，实现地址转换</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@Firewalld ~]# firewall-cmd --add-masquerade --permanent</span><br><span class="line">[root@Firewalld ~]# firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<p>2.客户端将网关指向firewalld服务器，将所有网络请求交给firewalld</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@web03 ~]# cat /etc/sysconfig/network-scripts/ifcfg-eth1</span><br><span class="line">GATEWAY=172.16.1.61</span><br></pre></td></tr></table></figure>

<p>3.客户端还需配置dns服务器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@web03 ~]# cat /etc/resolv.conf</span><br><span class="line">nameserver 223.5.5.5</span><br></pre></td></tr></table></figure>

<p>4.重启网络，使其配置生效</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@web03 ~]# nmcli connection reload</span><br><span class="line">[root@web03 ~]# nmcli connection down eth1 &amp;&amp; nmcli connection up eth1</span><br></pre></td></tr></table></figure>

<p>5.测试后端web的网络是否正常</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]# ping www.baidu.com</span><br><span class="line">PING www.baidu.com (14.215.177.38) 56(84) bytes of data.</span><br><span class="line">64 bytes from www.baidu.com (14.215.177.38): icmp_seq=1 ttl=128 time=25.0 ms</span><br></pre></td></tr></table></figure>





<h2 id="day49-Ansible-Day01"><a href="#day49-Ansible-Day01" class="headerlink" title="day49-Ansible-Day01"></a>day49-Ansible-Day01</h2><blockquote>
<p>Ansible集数缺失，所以使用其它替代</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line">1.先安装epel源(提供最新的ansible)</span><br><span class="line">wget -0 /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line"></span><br><span class="line">2.安装Ansible</span><br><span class="line">yum install ansible -y</span><br><span class="line"></span><br><span class="line">查看ansible的版本</span><br><span class="line">[root@m01 ~]# ansible --version</span><br><span class="line">ansible 2.7.7</span><br><span class="line">    config file = /etc/ansible/ansible.cfg</span><br><span class="line">    configured module search path = [u&#x27;/root/.ansible/plugins/modules&#x27;, u&#x27;/usr/share/ansible/plugins/modules&#x27;]</span><br><span class="line">    ansible python module location = /usr/lib/python2.7/site-packages/ansible</span><br><span class="line">    executable location = /usr/bin/ansible</span><br><span class="line">    python version = 2.7.5 (default, Apr 11 2018, 07:36:10) [GCC 4.8.5 20150623 (Red Hat 4.8.5-28)]</span><br><span class="line"></span><br><span class="line">3.Ansible的配置文件，配置文件可以随意放，但有查找顺序</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">ANSIBLE_CONFIG</span></span><br><span class="line">ansible.cfg		#当前目录下面查找</span><br><span class="line">.ansible.cfg	#当前用户的家目录下查找</span><br><span class="line">/etc/ansible/ansible.cfg</span><br><span class="line"></span><br><span class="line">[root@m01 ~]# cat /etc/ansible/ansible.cfg</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">inventory		= /etc/ansible/hosts		<span class="comment">#主机列表配置文件</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">library		= /usr/share/my_modules/	<span class="comment">#库文件存放目录</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">remote_tmp		= ~/.ansible/tmp			<span class="comment">#临时py文件存放在远程主机目录</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">local_tmp		= ~/.ansible/tmp			<span class="comment">#本机的临时执行目录</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">forks			=5							<span class="comment">#默认并发数</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">sudo_user		= root						<span class="comment">#默认sudo用户</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ask_sudo_pass 	= True						<span class="comment">#每次执行是否询问sudo的ssh密码</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ask_pass		= True						<span class="comment">#每次执行是否询问ssh密码</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">remote_port	= 22						<span class="comment">#远程主机端口</span></span></span><br><span class="line">host_key_checking = False					#跳过检查主机指纹</span><br><span class="line">log_path = /var/log/ansible.log				#ansible日志</span><br><span class="line"></span><br><span class="line">[privilege_escalation]						#如果是普通用户则需要配置提权</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">become=True</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">become method=sudo</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Ineventory主机清单</span><br><span class="line"></span><br><span class="line">1.场景一、基于密码连接</span><br><span class="line">[root@oldboy.com ~]# cat /etc/ansible/hosts</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方式一、主机+端口+密码</span></span><br><span class="line">[webservers]</span><br><span class="line">172.16.1.7 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=&#x27;123456&#x27;</span><br><span class="line">172.16.1.8 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=&#x27;123456&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方式二、主机+端口+密码</span></span><br><span class="line">[webservers]</span><br><span class="line">web[1:2].oldboy.com ansible_ssh_pass=&#x27;123456&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方式三、主机+端口+密码</span></span><br><span class="line">[webservers]</span><br><span class="line">web[1:2].oldboy.com</span><br><span class="line">[webservers:vars]</span><br><span class="line">ansible_ssh_pass=&#x27;123456&#x27;</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">场景二、基于密钥连接，需要先创建公钥和私钥，并下发公钥至被控端</span><br><span class="line">[rootam01 ~]# ssh-keygen</span><br><span class="line">[root@m01 ~]# ssh-copy-id -i~/.ssh/id_rsa.pub root@172.16.1.7</span><br><span class="line">[root@m01 ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.16.1.8</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------</span><br><span class="line">[root@m01 ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.16.1.8</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------</span><br><span class="line">[root@m01 ~]# cat hosts</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方式一、主机+端口+密钥</span></span><br><span class="line">[webservers]</span><br><span class="line">172.16.1.7</span><br><span class="line">172.16.1.8</span><br><span class="line"></span><br><span class="line">[root@m01 ~]# ansible webservers -m ping -i ./hosts</span><br><span class="line">172.16.1.8 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">172.16.1.7 | SUCCESS =&gt;&#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------</span><br><span class="line">[root@m01 ~]# cat hosts</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方式二、别名+主机+端口+密钥</span></span><br><span class="line">[webservers]</span><br><span class="line">web01 ansible_ssh_host=172.16.1.7 ansible_ssh_port=22</span><br><span class="line">web02 ansible_ssh_host=172.16.1.8</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@m01 ~]# ansible webservers -m ping -i ./hosts</span><br><span class="line">web02 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">web01 | SUCCESS =&gt;&#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">----------------------------------------------------------</span><br><span class="line">场景三、主机组使用方式</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.定义两个组</span></span><br><span class="line">[lbservers]</span><br><span class="line">172.16.1.5</span><br><span class="line">172.16.1.6</span><br><span class="line"></span><br><span class="line">[webservers]</span><br><span class="line">172.16.1.7</span><br><span class="line">172.16.1.8</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.servers组包括两个子组[lbservers,webserver]</span></span><br><span class="line">[servers:children]</span><br><span class="line">[lbservers]</span><br><span class="line">[webserver]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">列出当前某个组有多少台主机</span></span><br><span class="line">[root@m01 ~]# ansible lbservers -m ping -i ./hosts --list-hosts</span><br><span class="line">	hosts (1):</span><br><span class="line">		web01</span><br><span class="line">[root@m01 ~]# ansible webservers -m ping -i ./hosts --list-hosts</span><br><span class="line">	hosts (1):</span><br><span class="line">		web02</span><br><span class="line">[rootam01 ~]# ansible servers -m ping -i ./hosts --list-hosts</span><br><span class="line">	hosts (2):</span><br><span class="line">		web01</span><br><span class="line">		web02</span><br><span class="line">[root@m01 ~]# ansible all -m ping -i ./hosts --list-hosts</span><br><span class="line">	hosts (3):</span><br><span class="line">		web03</span><br><span class="line">		web02</span><br><span class="line">		web01</span><br><span class="line">		</span><br><span class="line">注意：</span><br><span class="line">	如果控制端和被控制端第一次通讯，需要先添加指纹信息，那如果机器特别多少的情况下怎么办？</span><br><span class="line">		仅需开启ansible中的 host_key_checking = False</span><br><span class="line">----------------------------------------------------------------------------</span><br><span class="line">Ad-Hoc，常用模块</span><br><span class="line">command			#执行shel1命令（不支持管道等特殊字符）</span><br><span class="line">shell			#执行shell命令</span><br><span class="line">scripts			#执行shell脚本</span><br><span class="line">yum repository	#配置yum仓库</span><br><span class="line">联网下载	   get_url</span><br><span class="line">安装			yum</span><br><span class="line">配置			copy</span><br><span class="line">启动			service、systemd</span><br><span class="line">创建用户与组	  user、group</span><br><span class="line">授权			file</span><br><span class="line">定吋任务	   crond</span><br><span class="line">挂载			 mount</span><br><span class="line">firewalld	  firewall</span><br><span class="line">selinux		  selinux</span><br><span class="line"></span><br><span class="line">6.使用过程中需要先了解ansible-doc帮助手册</span><br><span class="line">[root@m01 ~]# ansible-doc -l		#查看所有模块说明</span><br><span class="line">[root@m01 ~]# ansible-doc copy		#表示指定模块方法</span><br><span class="line">[root@m01 ~]# ansible-doc -s copy	#表示指定模块参数</span><br><span class="line"></span><br><span class="line">7.command默认执行bash命令模块，模块不支持重定向或管道</span><br><span class="line">[rootam01 ~]# ansible oldboy -a &quot;hostname&quot;</span><br><span class="line"></span><br><span class="line">8.shel1模块，如果需要一些管道操作，则使用shell</span><br><span class="line">[root@m01 ~]# ansible oldboy -m shell -a &quot;ifconfig|grep etho&quot; -f 50</span><br><span class="line"></span><br><span class="line">9.script脚本模块</span><br><span class="line">[root@m01 ～]# cat yum.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">yum install -y iftop</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在本地运行模块，等同于在远程执行，不需要将脚本文件进行推送目标主机执行</span></span><br><span class="line">[root@m01 ~]# ansible oldboy -m script -a &quot;/server/scripts/yum.sh&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">10.yum安装软件模块</span><br><span class="line">[root@m01 ~]# ansible oldboy -m yum -a &quot;name=httpd state=installed&quot;</span><br><span class="line">name</span><br><span class="line">    httpd						#指定要安装的软件包名称</span><br><span class="line">    file://						#指定从本地哪个目录安装rpm</span><br><span class="line">    http://						#指定从哪个网站安装rpm包</span><br><span class="line">state							#指定使用yum的方法</span><br><span class="line">    present						#安装软件包</span><br><span class="line">    absent						#移除软件包</span><br><span class="line">    latest						#安装最新软件包</span><br><span class="line">list=ansible					#列出当前仓库可用的软件包</span><br><span class="line">disablerepo=&quot;epel,ol7_latest&quot;	#安装软件时，不从哪些仓库获取</span><br><span class="line">download_only=true				#仅下载软件包，不安装</span><br><span class="line"></span><br><span class="line">1.copy文件拷贝模块</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.拷贝文件文件至被控节点</span></span><br><span class="line">[root@m01 ~]# ansible oldboy -m copy -a &quot;src=/etc/hosts dest=/tmp/test.txt&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.对远端已有文件进行备份，按照时间信息备份</span></span><br><span class="line">[root@m01 ~]# ansible oldboy -m copy -a &quot;src=/etc/hosts dest=/tmp/test.txt backup=yes&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.向被控端主机写入数据，并且会覆盖远端文件内原有数据信息</span></span><br><span class="line">[root@m01 ~]# ansible oldboy -m copy -a &quot;content=&#x27;bgx&#x27; dest=/tmp/oldboy&quot;</span><br><span class="line"></span><br><span class="line">src			#推送数据的源文件信息</span><br><span class="line">dest		#推送数据的目标路径</span><br><span class="line">backup		#对推送传输过去的文件，进行备份</span><br><span class="line">content		#直接批量在被管理端文件中添加内容</span><br><span class="line">group		#将本地文件推送到远端，指定文件属组信息</span><br><span class="line">owner		#将本地文件推送到远端，指定文件属主信息</span><br><span class="line">mode		#将本地文件推送到远端，指定文件权限信息</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.file文件创建模块</span><br><span class="line"></span><br><span class="line">1.直接修改被控端的权限</span><br><span class="line">[root@m01 ~]# ansible web01 -m file -a &quot;path=/opt mode=0400&quot; -i ./hosts</span><br><span class="line"></span><br><span class="line">2.在被控端创建目录</span><br><span class="line">[root@m01 ~]# ansible oldboy -m file -a &quot;path=/tmp/oldboy state=directory&quot;</span><br><span class="line"></span><br><span class="line">3.在被控端创建文件</span><br><span class="line">[root@m01 ~]# ansible oldboy -m file -a &quot;path=/tmp/tt state=touch mode=555 owner=root group=root&quot;</span><br><span class="line"></span><br><span class="line">4.递归授权目录权限</span><br><span class="line">[root@m01 ~]# ansible oldboy -m file -a &quot;path=/data owner=bgx group=bgx recurse=yes&quot;</span><br><span class="line">path			#指定远程主机目录或文件</span><br><span class="line">recurse			#递归授权</span><br><span class="line">state			#状态</span><br><span class="line">    directory	#在远端创建目录</span><br><span class="line">    touch		#在远端创建文件</span><br><span class="line">    link		#创建链接文件</span><br><span class="line">    absent		#表示删除文件或目录</span><br><span class="line">    mode		#设置文件或目录权限</span><br><span class="line">	owner		#设置文件或目录属主</span><br><span class="line">	group		#设置文件或目录属组</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">firewalld模块</span><br><span class="line">[rootam0l ~]# ansible webservers -m systemd -a &quot;name=firewalld state=started&quot; -i ./hosts</span><br><span class="line">[rootamo1 ~]# ansible webservers -m firewalld -a &quot;service=http immediate=yes permanent=ves state=enabled&quot; -i ./hosts</span><br><span class="line">[root@m01 ~]# ansible webservers -m firewalld -a &quot;port=8080-8090/tcp_immediate=yes permanent=yes state=enabled&quot; -i ./hosts</span><br><span class="line"></span><br><span class="line">service			#指定开放或关闭的服务名称</span><br><span class="line">port			#指定开放或关闭的端口</span><br><span class="line">masquerade		#开启地址伪装</span><br><span class="line">immediate		#临时生效</span><br><span class="line">permanent		#是否添加永久生效</span><br><span class="line">state			#开启或是关闭</span><br><span class="line">zone			#指定配置某个区域</span><br><span class="line">rich_rule		#配置富规则</span><br><span class="line">source			#指定来源IP</span><br><span class="line"></span><br><span class="line">9.常用模块练习</span><br><span class="line">1.安装http服务									 yum</span><br><span class="line">2.编写简单网页测试内容							 copy</span><br><span class="line">3.启动httpd服务并加入开机自启					    systemd|service</span><br><span class="line">4.放行对应的firewalld防火墙端口。临时和永久生效	   firewalld</span><br><span class="line">[root@m01 ~]# ansible webservers -m yum -a &quot;name=httpd state=present&quot; -i ./hosts</span><br><span class="line">[root@m01 ~]# ansible webservers -m copy -a &quot;content=&#x27;This Web&#x27; dest=/var/www/html/index.html&quot; -i ./hosts</span><br><span class="line">[root@m0l ~]# ansible webservers -m systemd -a &quot;name=httpd state=started enabled=yes&quot; -i ./hosts</span><br><span class="line">[root@m01 ~]# ansible webservers -m systemd -a &quot;name=firewalld state=started enabled=yes&quot; -i ./hosts</span><br><span class="line">[root@m01 ~]# ansible webservers -m firewalld -a &quot;service=http immediate=yes permanent=yes state=enabled&quot; -i ./hosts</span><br><span class="line"></span><br><span class="line">P529</span><br></pre></td></tr></table></figure>



<p><strong>千峰代替Ansible内容</strong></p>
<p><strong>3.2安装Ansible</strong><br>yum方式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@qfedu.com ~]# yum install epel-release</span><br><span class="line">[root@qfedu.com ~]# yum install ansible</span><br></pre></td></tr></table></figure>

<p>pip方式</p>
<blockquote>
<p>这里是使用系统自带的python2的环境<br>如果系统中安装的pip3，可以直接使用pip3安装ansible</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@qfedu.com ~]# yum install epel-release</span><br><span class="line">[root@qfedu.com ~]# yum install python2-pip</span><br><span class="line">[root@qfedu.com ~]# pip install ansible</span><br></pre></td></tr></table></figure>

<p>查看版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]# ansible --version</span><br><span class="line">ansible 2.9.27</span><br><span class="line">  config file = /etc/ansible/ansible.cfg</span><br><span class="line">  configured module search path = [u&#x27;/root/.ansible/plugins/modules&#x27;, u&#x27;/usr/share/ansible/plugins/modules&#x27;]</span><br><span class="line">  ansible python module location = /usr/lib/python2.7/site-packages/ansible</span><br><span class="line">  executable location = /usr/bin/ansible</span><br><span class="line">  python version = 2.7.5 (default, Nov 16 2020, 22:23:17) [GCC 4.8.5 20150623 (Red Hat 4.8.5-44)]</span><br></pre></td></tr></table></figure>



<p><strong>二、管理节点与被管理节点建立SSH信任关系</strong><br>管理节点(ansible)中创建密钥对</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@qfedu.com ~]# ssh-keygen -t rsa</span><br></pre></td></tr></table></figure>

<p>将本地的公钥传输到被管理节点</p>
<blockquote>
<p>每个被管理节点都需要传递<br>过程中需要被管理节点（这里是172.18.0.3）的用户名（这里是root）及密码</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@qfedu.com ~]# ssh-copy-id root@172.18.0.3</span><br></pre></td></tr></table></figure>

<p>三、快速入门</p>
<p>1.场景假设</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">管理节点：</span><br><span class="line">172.18.0.2 主机名 qfedu.com</span><br><span class="line"></span><br><span class="line">被管理节点（资产）：</span><br><span class="line">172.18.0.3</span><br><span class="line">172.17.0.4</span><br><span class="line"></span><br><span class="line">且管理节点 和 被管理节点之间的节点已经打通 SSH 信任关系。</span><br></pre></td></tr></table></figure>

<p>2.场景一</p>
<blockquote>
<p>在管理节点上，测试与所有被管理节点的网络连通性。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#在vim /etc/ansible/hosts 在文件的底部加入ip</span><br><span class="line">[root@m01 ansible]# vim /etc/ansible/hosts </span><br><span class="line">## db-[99:101]-node.example.com</span><br><span class="line">172.16.1.7</span><br><span class="line"></span><br><span class="line">[root@m01 ansible]# ansible all -i 172.16.1.7 -m ping</span><br><span class="line">[root@m01 ansible]# ssh-copy-id root@192.168.160.157</span><br><span class="line">[root@m01 ansible]# vim /etc/ansible/hosts </span><br><span class="line">[root@m01 ansible]# vim /etc/ansible/hosts </span><br><span class="line">## db-[99:101]-node.example.com</span><br><span class="line">172.16.1.7</span><br><span class="line">192.168.160.157</span><br><span class="line">[root@m01 ansible]# ansible all -i 172.16.1.7,192.168.160.157 -m ping</span><br><span class="line">172.16.1.7 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.160.157 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意 <code>-i</code> 参数后面接的是一个列表（List）。因此当为一个被管理节点时，我们后面一定要加一个英文逗号(,)告知是List</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible all -i 172.18.0.3, -m ping</span></span><br></pre></td></tr></table></figure>

<p>3.场景二</p>
<blockquote>
<p>在管理节点上，确保文件 <code>/tmp/a.conf</code> 发布到所有被管理节点</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">touch</span> /tmp/a.conf</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible all -i 172.18.0.3,172.18.0.4 -m copy -a <span class="string">&quot;src=/tmp/a.conf dest=/tmp/a.conf&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>选项参数解释</p>
<ul>
<li>all 在ansible中，将其叫做psattern，即匹配。我通常称它为资产选择器。就是匹配资产（-i 参数指定）中的一部分。这里的all是匹配所有指定的所有资产。将在下面资产部分详细阐述。</li>
<li><code>-i</code> 指定Ansible的资产，也就是被管理服务器。</li>
<li><code>-m</code> 指定要运行的模块，比如这里的ping模块和copy模块</li>
<li><code>-a</code> 指定模块的参数，这里模块ping没有指定参数。模块copy指定了src和dest参数。</li>
</ul>
<p>总结一句话<br>ansible 就是用什么模块，让谁去干什么事情。</p>
<p><strong>四、Ansible 资产</strong></p>
<p>在快速入门的场景中，我们一共管理了两台服务器。但是在实际场景中，我<br>们要管理的服务器往往要多得多。难道依然要在Ansible的-i参数后面一个<br>个追加IP指定吗？这显然不合乎常理。</p>
<p>因此这一节我们主要去介绍一下Ansible的资产。</p>
<p>Ansible的资产分为静态资产和动态资产，动态资产会在后面的高级部分详<br>细阐释。</p>
<p>下面仅介绍静态资产</p>
<p>1.静态资产<br>顾名思义它本身是一个文本文件，一个格式类似INI的文件。</p>
<p>默认情况下,Ansible的资产文件位于<code>/ect/ansible/hosts</code>。pip安装的可能没有这个文件，创建一个即可。</p>
<p>1.1自定义资产</p>
<p>这个文件可以自定义，之后使用相应的参数指定。</p>
<p>下面给出一个自定义的静态资产实例，然后再具体解释其含义。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> inventory.ini</span></span><br><span class="line">1.1.1.1</span><br><span class="line">2.2.2.2</span><br><span class="line">3.3.3.3</span><br><span class="line">test01.qfedu.com</span><br><span class="line">test03.qfedu.com</span><br><span class="line">test[05:09]·qfedu.com</span><br><span class="line"></span><br><span class="line">[web_servers]</span><br><span class="line">192.168.1.2</span><br><span class="line">192.168.1.3</span><br><span class="line">192.168.1.5</span><br><span class="line"></span><br><span class="line">[dbdb_servers]</span><br><span class="line">192.168.2.2</span><br><span class="line">192.168.2.3</span><br><span class="line">192.168.1.5</span><br><span class="line"></span><br><span class="line">[alldb_servers]</span><br><span class="line">[alldb_servers:children]</span><br><span class="line">dbdb_servers</span><br><span class="line">web_servers</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>1.Ansible的资产文件中，可以以IP地址的形式或者主机名的形式存在。</p>
<p>2.Ansible，的资产若连续，可以使用[stat:end]的形式去表达。</p>
<p>3.可以将服务器按照业务场景定义成组，比如dbdb servers和web servers</p>
<p>4.组和组之间可以存在继承关系，比如dbdb servers和web servers同时继承 alldb servers 组</p>
<p><strong>1.2如何使用自定义资产</strong><br>通过-i参数指定自定义资产的位置即可（可以是全路径，也可以是相对路径）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible all-i inventory.ini...//伪指令，不可执行</span></span><br></pre></td></tr></table></figure>

<p><strong>1.3如何验证自定义资产</strong><br>假如我们刚刚定义的资产为 inventory.ini</p>
<ul>
<li>列举出所有资产</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible all -i inventory.ini --list-hosts</span></span><br><span class="line">    hosts (29):</span><br><span class="line">        1.1.1.1</span><br><span class="line">        2.2.2.2</span><br><span class="line">        3.3.3.1</span><br><span class="line">        ...略...</span><br></pre></td></tr></table></figure>

<ul>
<li>列举出选定资产<br>比如这里列举出 <code>web_servers</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]# ansible web_servers -i inventory.ini --list-hosts</span><br><span class="line">  hosts (3):</span><br><span class="line">    192.168.1.2</span><br><span class="line">    192.168.1.3</span><br><span class="line">    192.168.1.5</span><br></pre></td></tr></table></figure>

<p>注意这里使用的了资产选择器（pattern），不要慌，将会在下面对他进行详细的阐述</p>
<p><strong>2.资产选择器</strong></p>
<p>有时操作者希望只对资产中的一部分服务器进行操作，而不是资产中所有服</p>
<p>务器。此时可以使用Ansible的资产选择器PATTERN。</p>
<p>下面学习如何通过资产选择器，更灵活的选择想要操作的服务器。</p>
<p><strong>2.1基本语法格式</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible PATTERN -i inventory -m module -a argument</span><br></pre></td></tr></table></figure>

<p><strong>选择一台或者几台服务器</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible 1.1.1.1 -i inventory.ini --list-hosts</span></span><br><span class="line">	hosts (1):</span><br><span class="line">		1.1.1.1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible test01.qfedu.com -i inventory.ini --list-hosts</span></span><br><span class="line">	hosts (1):</span><br><span class="line">		test01.qfedu.com</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible 1.1.1.1,2.2.2.2 -i inventory.ini --list-hosts</span></span><br><span class="line">    hosts (2):</span><br><span class="line">        1.1.1.1</span><br><span class="line">        2.2.2.2</span><br></pre></td></tr></table></figure>

<p><strong>选择一组服务器</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible web servers -i inventory.ini --list-hosts</span></span><br><span class="line">	hosts (3):</span><br><span class="line">        192.168.1.2</span><br><span class="line">        192.168.1.3</span><br><span class="line">        192.168.1.5</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>使用 * 匹配</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible 3.3.3.1* -i inventory.ini --list-hosts</span></span><br><span class="line">	hosts (7):</span><br><span class="line">        3.3.3.13</span><br><span class="line">        3.3.3.10</span><br><span class="line">        3.3.3.11</span><br><span class="line">        3.3.3.12</span><br><span class="line">        3.3.3.14</span><br><span class="line">        3.3.3.15</span><br><span class="line">        3.3.3.1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>使用逻辑匹配</strong></p>
<ul>
<li>web_servers和dbdb_servers的并集<br>两个组内的所有主机</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible <span class="string">&#x27;web_servers:db_servers&#x27;</span> -i inventory.ini --list-hosts</span></span><br><span class="line">	hosts (5):</span><br><span class="line">        192.168.1.2</span><br><span class="line">        192.168.1.3</span><br><span class="line">        192.168.1.5</span><br><span class="line">        192.168.2.2</span><br><span class="line">        192.168.2.3</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>web_servers和dbdb_servers的交集<br>两个组共有的主机</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible <span class="string">&#x27;web_servers:&amp;db_servers&#x27;</span> -i inventory.ini --list-hosts</span></span><br><span class="line">	hosts (1):</span><br><span class="line">		192.168.1.5</span><br></pre></td></tr></table></figure>

<ul>
<li><p>排除</p>
<p>在web_servers中,但是不在db_servers中</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible &#x27;web_servers:!db_servers&#x27; -i inventory.ini --list-hosts</span><br><span class="line">	hosts (2):</span><br><span class="line">		192.168.1.2</span><br><span class="line">		192.168.1.3</span><br></pre></td></tr></table></figure>



<p><strong>五、Ansible Ad-Hoc命令</strong><br>Ad-hoc命令是什么呢？这其实是一个概念性的名字,是相对于写Ansible playbook来说的.类似于在命令行敲入shell命令和写shell scripts两者之间的关系。可以用于执行一些临时命令。</p>
<p>如果我们敲入一些命令去比较快的完成一些事情，而不需要将这些执行的命令<br>特别保存下来，这样的命令就叫做ad-hoc命令。</p>
<p>Ansible提供两种方式去完成任务，一是 ad-hoc命令，一是写Ansible playbook（这部分在高级课程中会详细阐释）。</p>
<p>前者可以解决一些简单的任务，后者解决较复杂的任务，比如做配置管理或部署。</p>
<p><strong>1.命令格式</strong><br>在快速入门中执行的Ansible命令，类似于批量执行命令。</p>
<p>在Ansible中统称为Ansible <code>Ad-Hoc</code>。</p>
<p>命令语法格式如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible pattern [-i inventory] -m module -a argument</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>pattern</code>资产选择器</p>
</li>
<li><p><code>-i</code>指定资产清单文件的位置</p>
</li>
<li><p><code>-m</code>指定本次Ansible ad-hoc要执行的模块。可以类别成SHELL中的命令。</p>
</li>
<li><p><code>-a</code>模块的参数，可以类比成SHELL中的命令参数</p>
</li>
</ul>
<p><strong>快速入门中的实例</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible all -i 172.18.0.3,172.18.0.4 -m copy -a &quot;src=/tmp/a.conf dest=/tmp/a.conf&quot;</span><br></pre></td></tr></table></figure>



<p><strong>2.模块类型</strong><br>Ansible模块分三种类型：核心模块(core module)、附加模块(extra module)及用户自定义模块(consume module)。</p>
<p>核心模块是由Ansible的官方团队提供的。</p>
<p>附加模块是由各个社区提供的。例如：OPENSTACK社区、DOCKER社区等<br>等。</p>
<p>当核心模块和附加模块都无法满足你的需求时，用户可以自定义模块。</p>
<p>默认情况下，在安装Ansible的时候，核心模块和附加模块都已经安装而无需用户干预。</p>
<p><strong>3.联机帮助</strong></p>
<p>Ansible的核心模块和附加模块，数量有1000+。这样庞大的模块数量，对于任何一个接触Ansible的人都不可能将其完全记住、掌握使用。因此能够顺利使用Ansible的帮助文档，对我们来说是很有必要的。Ansible的帮助文档，由它本身提供的命令ansible-doc实现。</p>
<p><strong>常用帮助参数</strong></p>
<ul>
<li>列举出所有的核心模块和附加模块</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible-doc -l</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查询某个模块的使用方法</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible-doc modulename</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查询某个模块的使用方法，比较简洁的信息</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible-doc -s modulename</span></span><br></pre></td></tr></table></figure>

<p><strong>Example</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible-doc yum</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible-doc -s yum</span></span><br></pre></td></tr></table></figure>



<p><strong>4.常用模块</strong></p>
<p>为了便于演示和操作，现在把之前的测试主机IP<code>172.18.0.3</code>和<code>172.18.0.4</code>保存到当前目录下的hosts文件中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@qfedu.com ~]# cat hosts</span><br><span class="line">[dbservers]</span><br><span class="line">172.18.0.3</span><br><span class="line"></span><br><span class="line">[webservers]</span><br><span class="line">172.18.0.4</span><br></pre></td></tr></table></figure>



<p><strong>4.1 command &amp; shell 模块</strong><br>两个模块都是在远程服务器上去执行命令。</p>
<p>但command模块是ad-hoc的默认模块，在执行ad-hoc时，若不指定模块的名字则默认使用此模块。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible all -i hosts -a <span class="string">&quot;echo &#x27;hello&#x27;&quot;</span></span></span><br><span class="line">172.18.0.4 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">hello</span><br><span class="line">172.18.0.3 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">hello</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible all -i hosts -m shell -a <span class="string">&quot;echo &#x27;hello&#x27;&quot;</span></span></span><br><span class="line">172.18.0.4| CHANGED | rc=0 &gt;&gt;</span><br><span class="line">hello</span><br><span class="line">172.18.0.3| CHANGED | rc=0 &gt;&gt;</span><br><span class="line">hello</span><br></pre></td></tr></table></figure>



<p><strong>两个模块的差异</strong></p>
<ul>
<li>shell模块可以执行SHELL的内置命令和：特性（比如管道符）。</li>
<li>command模块无法执行SHELL的内置命令和特性</li>
</ul>
<p><strong>Example</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible all -i hosts -m shell -a <span class="string">&quot;echo &#x27;hello&#x27;|grep -o &#x27;e&#x27;&quot;</span></span></span><br><span class="line">172.18.0.3| CHANGED| rc=0 &gt;&gt;</span><br><span class="line">e</span><br><span class="line">172.18.0.4| CHANGED | rc=0 &gt;&gt;</span><br><span class="line">e</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible all -i hosts -a <span class="string">&quot;echo &#x27;hello&#x27;|grep -o &#x27;e&#x27;&quot;</span></span></span><br><span class="line"></span><br><span class="line">172.18.0.4| CHANGED | rc=0 &gt;&gt;</span><br><span class="line">hello|grep -o e</span><br><span class="line">172.18.0.3 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">hello|grep -o e</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>4.2 script 模块</p>
<p>将管理节点上的脚本传递到被管理节点（远程服务器）上进行执行，理论上此模块的执行完全不需要被管理服务器上有Python。</p>
<p><strong>Example</strong></p>
<p>管理节点上的一个脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> /root/a.sh</span></span><br><span class="line">touch /tmp/testfile</span><br></pre></td></tr></table></figure>





<p>copy模块的主要用于管理节点和被管理节点之间的文件拷贝。</p>
<p><strong>常用参数</strong></p>
<ul>
<li>src    指定拷贝文件的源地址</li>
<li>dest    指定拷贝文件的目标地址</li>
<li>backup    拷贝文件前，若原始文件发生变化，则对目标文件进行备份</li>
<li>woner    指定新拷贝文件的所有者</li>
<li>group    指定新拷贝文件的所有组</li>
<li>mode    指定新拷贝文件的权限</li>
</ul>
<p><strong>Example</strong></p>
<ul>
<li>copy  管理节点上的<code>nginx.repo</code>到被管理节点上</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> nginx.repo</span></span><br><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/$releasever/$base</span><br><span class="line">arch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module hotfixes=true</span><br><span class="line"></span><br><span class="line">[nginx-mainline]</span><br><span class="line">name=nginx mainline repo</span><br><span class="line">baseurl=http://nginx.org/packages/mainline/centos/$release</span><br><span class="line"><span class="meta prompt_">ver/$</span><span class="language-bash">basearch/</span></span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module hotfixes=true</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -i hosts -m copy -a <span class="string">&quot;src=./nginx.repo dest=/etc/yum.repos.d/nginx.repo&quot;</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li>copy前，在被管理节点上对原文件进行备份</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible all -i hosts -m copy -a <span class="string">&quot;src=./nginx.repo dest=/etc/yum.repos.d/nginx.repo backup=yes&quot;</span></span></span><br></pre></td></tr></table></figure>



<ul>
<li>copy文件的同时对文件进行用户及用户组设置</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible all -i hosts -m copy -a <span class="string">&quot;src=./nginx.repo dest=/etc/yum.repos.d/nginx.repo owner=nobody group=nobody&quot;</span></span></span><br></pre></td></tr></table></figure>



<ul>
<li>copy文件的同时对文件进行权限设置</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible all -i hosts -m copy -a <span class="string">&quot;src=./nginx.repo dest=/etc/yum.repos.d/nginx.repo mode=0755&quot;</span></span></span><br></pre></td></tr></table></figure>



<p><strong>4.4 yum_repsitory</strong></p>
<p>添加YUM仓库</p>
<p><strong>常用参数</strong></p>
<ul>
<li><p><code>name</code>仓库名称，就是仓库文件中第一行的中括号中名称，必须的参数。</p>
</li>
<li><p><code>description</code>仓库描述信息，添加时必须的参数</p>
</li>
<li><p><code>baseurl yum</code>存储库“repodata”目录所在目录的URL,添加时必须的参数。</p>
<p>它也可以是多个URL的列表。</p>
</li>
<li><p><code>file</code>仓库文件保存到被管理节点的文件名，不包含<code>.repo</code>。默认是<code>name</code>的值。</p>
</li>
<li><p><code>state</code> preset确认添加仓库文件，absent确认删除仓库文件。</p>
</li>
<li><p><code>gpgcheck</code> 是否检查GPG yes|no,没有默认值，使用<code>/etc/yum.conf</code>中的配置。</p>
</li>
</ul>
<p><strong>Example</strong></p>
<p>添加epel源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@qfedu.com ~]# ansible dbservers -i hosts -m yum_repository -a &quot;name=epel baseurl=&#x27;https://download.fedoraproject.org/pub/epel/$rele asever/$basearch/&#x27; description=&#x27;EPEL YUM repo&#x27;&quot;</span><br><span class="line">172.18.0.3 | CHANGED =&gt; &#123;</span><br><span class="line">	&quot;ansible_facts&quot;: &#123;</span><br><span class="line">		&quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">&#125;，</span><br><span class="line">&quot;changed&quot;: true,</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>删除epel源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@qfedu.com ~]# ansible dbservers -i hosts -m yum_repository -a &quot;name=epel state=absent&quot;</span><br><span class="line">172.18.0.3| CHANGED =&gt;&#123;</span><br><span class="line">	&quot;ansible_facts&quot;: &#123;</span><br><span class="line">		&quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">	&#125;,</span><br><span class="line">    &quot;changed&quot;: true,</span><br><span class="line">    &quot;repo&quot;: &quot;epel&quot;,</span><br><span class="line">    &quot;state&quot;: &quot;absent&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>4.5 yum模块</strong></p>
<p>等同于Linux上的YUM命令，对远程服务器上RPM包进行管理。</p>
<p><strong>常用参数：</strong></p>
<ul>
<li>name要安装的软件包名，多个软件包以逗号（）隔开</li>
<li>state対当前指定的软件安装、移除操作(present installed latestabsent removed)<br>支持的参数<ul>
<li>present确认已经安装，但不升级</li>
<li>installed确认已经安装</li>
<li>latest确保安装，且升级为最新</li>
<li>absent和 removed 确认已移除</li>
</ul>
</li>
</ul>
<p><strong>Example</strong></p>
<ul>
<li>安装一个软件包</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -i hosts -m yum -a <span class="string">&quot;name=nginx state=present&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -i hosts -m yum -a <span class="string">&quot;name=nginx state=latest&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -i hosts -m yum -a <span class="string">&quot;name=nginx state=installed&quot;</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>移除一个软件包</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -i hosts -m yum -a <span class="string">&quot;name=nginx state=absent&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -i hosts -m yum -a <span class="string">&quot;name=nginx state=removed</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>安装一个软件包组</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -i hosts -m yum -a <span class="string">&quot;name=&#x27;@revelopment tools&#x27; state=present&quot;</span></span></span><br></pre></td></tr></table></figure>



<p><strong>4.5 systemd模块</strong></p>
<blockquote>
<p>Centos6之前的版本使用 <code>service</code>模块。</p>
<p>请使用 <code>ansible-doc service</code>命令自行查看帮助信息。</p>
</blockquote>
<p>管理远程节点上的systemd服务，就是由systemd所管理的服务。</p>
<p><strong>常用参数：</strong></p>
<ul>
<li>daemon_reload重新载入systemd,扫描新的或有变动的单元</li>
<li>enabled是否开机自启动 yes|no</li>
<li>name 必选项，服务名称，比如httpd vsftpd</li>
<li>state对当前服务执行启动，停止、重启、重新加载等操作(started,stopped,restarted,reloaded)</li>
</ul>
<p><strong>Example</strong></p>
<ul>
<li>重新加载systemd</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -i hosts -m systemd -a <span class="string">&quot;daemon_reload=yes&quot;</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>启动Nginx服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -i hosts -m systemd -a <span class="string">&quot;name=nginx state=started&quot;</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>关闭Nginx服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -i hosts -m systemd -a <span class="string">&quot;name=nginx state=stopped&quot;</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>重启Nginx服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -i hosts -m systemd -a <span class="string">&quot;name=nginx state=restarted&quot;</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>重新加载Nginx服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -i hosts -m systemd -a <span class="string">&quot;name=nginx state=reloaded&quot;</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>将Nginx服务设置开机自启动</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -i hosts -m systemd -a <span class="string">&quot;name=nginx enabled=yes&quot;</span></span></span><br></pre></td></tr></table></figure>



<p><strong>4.6 group模块</strong></p>
<p>在被管理节点上，对组进行管理。</p>
<p><strong>常用参数</strong>：</p>
<ul>
<li>name		组名称，必须的</li>
<li>system 	是否为系统组，yes&#x2F;no，默认是no</li>
<li>state        删除或者创建，present&#x2F;absent，默认是present</li>
</ul>
<p><strong>Example</strong></p>
<ul>
<li>创建普通组db_admin</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ansible dbservers -i hosts -m group -a &quot;name=db_admin&quot;</span></span><br></pre></td></tr></table></figure>



<p><strong>4.7 user模块</strong></p>
<p>用于在被管理节点上对用户进行管理。</p>
<p><strong>常用参数：</strong></p>
<ul>
<li><p>name  必须的参数，指定用户名</p>
</li>
<li><p>password  设置用户的密码，这里接受的是一个加密的值，因为会直接存到shadow，默认不设置密码。</p>
</li>
<li><p>update_password  假如设置的密码不同于原密码，则会更新密码.在1.3中被加入</p>
</li>
<li><p>home  指定用户的家目录</p>
</li>
<li><p>shell  设置用户的shell</p>
</li>
<li><p>comment  用户的描述信息</p>
</li>
<li><p>create_home  在创建用户时,是否创建其家目录。默认创建,假如不创建，设置为 no。2.5版本之前使createhome</p>
</li>
<li><p>group  设置用户的主组</p>
</li>
<li><p>groups  将用户加入到多个其他组中，多个用逗号隔开。<br>            默认会把用户从其他已经加入的组中删除。</p>
</li>
<li><p>append yes|no 和 groups 配合使用，yes时，</p>
<p>不会把用户从其他已经加入的组中删除</p>
</li>
<li><p>system  设置为yes时，将会创建一个系统账号</p>
</li>
<li><p>expires  设置用户的过期时间，值为时间戳，会转为为天数后，放在shadow的最后第8个字段里</p>
</li>
<li><p>generate_ssh_key  设置为yes将会为用户生成密钥，这不会覆盖原来的密钥</p>
</li>
<li><p>ssh_key_type  指定用户的密钥类型,默认rsa,具体的类型取决于被管理节点</p>
</li>
<li><p>state  删除或添加用户，present 为添加，absent为删除；</p>
<p>​			默认值 present</p>
</li>
<li><p>remove  当与state&#x3D;absent一起使用，删除一个用户及关联的目录，</p>
<p>​				比如家目录，邮箱目录。可选的值为：yes&#x2F;no</p>
</li>
</ul>
<p><strong>Example</strong></p>
<p>创建用户并设置密码</p>
<p>先生成加密密码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@qfedu.com ~]# pass=$(echo &quot;123456&quot;| openssl passwd -1 -stdin)</span><br></pre></td></tr></table></figure>

<p>执行ansible命令创建用户foo并设置密码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ansible all -i hosts -m user -a &quot;name=foo password=$&#123;pass&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>创建用户yangge,并且为其创建密钥对，并且密钥类型为：ecdsa</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ansible all -i hosts -m user -a &quot;name=yangge generate_ssh_key=yes ssh_key_type=ecdsa&quot;</span><br></pre></td></tr></table></figure>

<p>创建用tom,并且设置其有效期到2020年4月15日,加入到组db_admin中，不改变用户原有加入的组。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible dbservers -i hosts -m user -a <span class="string">&quot;name=tom expires=<span class="subst">$(date +%s -d 20200415)</span> groups=db_admin append=yes&quot;</span></span></span><br></pre></td></tr></table></figure>



<p><strong>4.8 file模块</strong></p>
<p>file模埭主要用于远程主机上的文件操作。</p>
<p><strong>常用参数：</strong></p>
<ul>
<li>owner  定义文件&#x2F;目录的属主</li>
<li>group  定义文件&#x2F;目录的属组</li>
<li>mode  定义文件&#x2F;目录的权限</li>
<li>path  必选项，定义文件&#x2F;目录的路径</li>
<li>recurse  递归的设置文件的属性，只对目录有效</li>
<li>src  链接（软&#x2F;硬）文件的源文件的路径，只应用于state&#x3D;link的情况</li>
<li>dest  被链接到的路径，只应用于state&#x3D;link的情况</li>
<li>state<ul>
<li>directory 如果目录不存在，创建目录</li>
<li>file  文件不存在，则不会被创建，存在则返回文件的信息，常用于检查文件是否存在。</li>
<li>link  创建软链接</li>
<li>hard  创建硬链接</li>
<li>touch 如果文件不存在，则会创建一个新的文件，如果文件或目录已存在，则更新其最后修改时间</li>
<li>absent  删除目录、文件或者取消链接文件</li>
</ul>
</li>
</ul>
<p>​	</p>
<p><strong>Example</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 创建一个文件</span><br><span class="line"><span class="comment"># ansible all -i hosts -m file -a &quot;path=/tmp/foo.conf state=touch&quot;</span></span><br><span class="line">// 改变文件所有者及权限</span><br><span class="line"><span class="comment"># ansible all -i hosts -m file -a &quot;path=/tmp/foo.conf owner=nobody group=nobody mode=0644&quot;</span></span><br><span class="line">// 创建一个软连接</span><br><span class="line"><span class="comment"># ansible all -i hosts -m file -a &quot;src=/tmp/foo.conf dest=/tmp/link.conf state=link&quot;</span></span><br><span class="line">// 创建一个目录</span><br><span class="line"><span class="comment"># ansible all -i hosts -m file -a &quot;path=/tmp/testdir state=directory&quot;</span></span><br><span class="line">// 取消一个连接</span><br><span class="line"><span class="comment"># ansible all -i hosts -m file -a &quot;path=/tmp/link.conf state=absent&quot;</span></span><br><span class="line">// 删除一个文件</span><br><span class="line"><span class="comment"># ansible all -i hosts -m file -a &quot;path=/tmp/foo.conf state=absent&quot;</span></span><br></pre></td></tr></table></figure>



<p><strong>4.9 cron模块</strong></p>
<p>管理远程节点的CRON服务。等同于Linux中的计划任务。</p>
<blockquote>
<p>注意：使用Ansible创建的计划任务不能使用本地crontab -e编辑，否则Ansible无法再次操作他。</p>
</blockquote>
<p><strong>常用参数：</strong></p>
<ul>
<li><p>name 指定一个cron job的名字。一定要指定，便于日之后删除。</p>
</li>
<li><p>minute 指定分钟，可以设置成（0-59, *，*&#x2F;2等）格式。默认是*，也就是每分钟。</p>
</li>
<li><p>hour 指定小时，可以设置成（0-23, *，*&#x2F;2等）格式。默认是*，也就是每小时。</p>
</li>
<li><p>day 指定天，可以设置成（1-31，*，*&#x2F;2等）格式。默认是*，也就是每天。</p>
</li>
<li><p>month 指定月份，可以设置成（1-12, *，*&#x2F;2等）格式。默认是*，也就是每周。</p>
</li>
<li><p>job  指定要执行的内容，通常可以写个脚本，或者一段内容。</p>
</li>
<li><p>state  指定这个job的状态，可以是新增(present)或者是删除(absent)。默认为新增（present)</p>
</li>
</ul>
<p><strong>Example</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//新建一个CRON JOB任务</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible all -i hosts -m cron -a <span class="string">&quot;name=&#x27;create new job&#x27; minute=&#x27;0&#x27; job=&#x27;ls -alh &gt; /dev/null&#x27;&quot;</span></span></span><br><span class="line">//删除一个 CRON JOB 任务，删除时，一定要正确指定job的name参数，以免误删除。</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible all -i hosts -m cron -a <span class="string">&quot;name=&#x27;create new job&#x27; state=absent&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>登录任何一台管理机验证cron</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">crontab -l</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Ansible: create new job</span></span><br><span class="line">0 * * * * ls -alh &gt; /dev/null</span><br></pre></td></tr></table></figure>



<p><strong>4.10 debug模块</strong></p>
<p>debug模块主要用于调试时使用，通常的作用是将一个变量的值打印出来。</p>
<p><strong>常用参数：</strong></p>
<ul>
<li>var直接打印一个指定的变量值</li>
<li>msg打印一段可以格式化的字符串</li>
</ul>
<p><strong>Example</strong></p>
<ul>
<li>这里引入了变量，我们只需了解debug模板的使用即可。在学习变量、剧本时，我们会对它有更深刻的理解。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible all -i hosts -m debug -a <span class="string">&quot;var=role&quot;</span> -e <span class="string">&quot;role=web&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible all -i hosts -m debug -a <span class="string">&quot;msg=&#x27;role is &#123;&#123;role&#125;&#125;&#x27;&quot;</span> -e <span class="string">&quot;role=web&quot;</span></span></span><br></pre></td></tr></table></figure>



<p><strong>4.11 template 模块</strong></p>
<p>template 模块使用了Jinjja2格式作为文件模版，可以进行文档内变量的替换。文件以 .j2结尾。</p>
<p>常用参数：</p>
<ul>
<li>src  指定Ansible控制端的文件路径、</li>
<li>dest  指定Ansible被控端的文件路径</li>
<li>owner  指定文件的属主</li>
<li>group  指定文件的属组</li>
<li>mode  指定文件的权限</li>
<li>backup  创建一个包含时间戳信息的备份文件，这样如果您以某种方式错误地破坏了原始文件，就可以将其恢复原状。yes&#x2F;no</li>
</ul>
<p><strong>Example</strong></p>
<p>用法其实和 copy模块基本一样，template模块的强大之处就是使用变量替换，就是可以把传递给Ansible的变量的值替换到模板文件中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1.建立一个 template文件，名为 hello_world.j2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> hello_world.j2</span></span><br><span class="line">Hello &#123;&#123;var&#125;&#125; !</span><br><span class="line"></span><br><span class="line">2.执行命令，并且设置变量var的值为 world</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible all -i hosts -m template -a <span class="string">&quot;src=hello_world.j2 dest=/tmp/hello_world.world&quot;</span> -e <span class="string">&quot;var=world&quot;</span></span></span><br><span class="line"></span><br><span class="line">3.在被控主机上验证</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> /tmp/hello_world.world</span></span><br><span class="line">Hello world !</span><br></pre></td></tr></table></figure>



<p><strong>4.12 lineinfile 模块</strong> </p>
<p>在被管理节点上，用正则匹配的方式对目标文件的一行内容修改删除等操作。</p>
<p>如果是在一个文件中把所有匹配到的多行都进行统一处理，请参考replace模块。</p>
<p>如果想对一个文件进行一次性添加&#x2F;更新&#x2F;删除等操作，参考blockinfile模块</p>
<p><strong>常用参数</strong></p>
<ul>
<li><p>path  被管理节点的目标文件路径，必须。</p>
</li>
<li><p>state  可选值absent 删除|present 替换（默认值）。</p>
</li>
<li><p>regexp  在文件的每一行中查找的正则表达式。</p>
<p>对于state&#x3D;present，仅找到的最后一行将被替换。</p>
</li>
<li><p>line  要在文件中插入&#x2F;替换的行。需要state&#x3D;present。</p>
</li>
<li><p>create  文件不存在时,是否要创建文件并添加内容。yes&#x2F;no</p>
</li>
</ul>
<p><strong>Example</strong></p>
<ul>
<li>删除被控节点文件里的某一条内容</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ansible dbservers -i hosts -m lineinfile -a &quot;path=/etc/sudoers regexp=&#x27;^%wheel&#x27; state=absent&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>替换某一行</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible dbservers -i hosts -m lineinfile -a <span class="string">&quot;path=/etc/selinux/config regexp=&#x27;^SELINUX=&#x27; line=&#x27;SELINUX=disabled&#x27; state=present&quot;</span></span></span><br></pre></td></tr></table></figure>





<blockquote>
<p>切回老男孩</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">1.Playbook</span><br><span class="line">[root@m01 ~]<span class="comment"># vim /etc/ansible/hosts</span></span><br><span class="line">[webservers]</span><br><span class="line">web01 ansible_ssh_host=192.168.160.149</span><br><span class="line">web02 ansible_ssh_host=192.168.160.157</span><br><span class="line">[root@m01 ~]<span class="comment"># mkdir project1</span></span><br><span class="line">[root@m01 ~]<span class="comment"># cd project1/</span></span><br><span class="line">[root@m01 project1]<span class="comment"># vim p1.yml</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#play</span></span><br><span class="line">- hosts: webservers</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installed Httpd Server</span><br><span class="line">      yum: </span><br><span class="line">        name: httpd</span><br><span class="line">        state: present</span><br><span class="line"></span><br><span class="line">    - name: Start Httpd Server</span><br><span class="line">      systemd:</span><br><span class="line">        name: httpd</span><br><span class="line">        state: started</span><br><span class="line">        enabled: <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#第二种写法，相对不规范</span></span><br><span class="line">    - name: Start Firewalld Server</span><br><span class="line">      systemd: name=firewalld state=started enabled=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">    - name: Configure Firewalld Server</span><br><span class="line">      firewalld: </span><br><span class="line">        service: http</span><br><span class="line">        immediate: <span class="built_in">yes</span></span><br><span class="line">        permanent: <span class="built_in">yes</span></span><br><span class="line">        state: enabled</span><br><span class="line"></span><br><span class="line">- hosts: web01</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Configure web01 Website</span><br><span class="line">      copy: content=<span class="string">&#x27;This is Web01&#x27;</span> dest=/var/www/html/index.html</span><br><span class="line"></span><br><span class="line">- hosts: web02</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Configure web02 Website</span><br><span class="line">      copy: content=<span class="string">&#x27;This is Web02&#x27;</span> dest=/var/www/html/index.html</span><br><span class="line"></span><br><span class="line">2.检查语法，只检查是否是yaml语法格式。并不做逻辑校验。</span><br><span class="line">[root@m01 project1]<span class="comment"># ansible-playbook --syntax-check p1.yml</span></span><br><span class="line"></span><br><span class="line">playbook: p1.yml</span><br><span class="line"></span><br><span class="line">3.模拟执行（不是真的执行）</span><br><span class="line">[root@m01 project1]<span class="comment"># ansible-playbook -C p1.yml</span></span><br><span class="line"></span><br><span class="line">4.真实的描述状态（被控端的状态必须与控制端描述的状态一致）</span><br><span class="line">[root@m01 project1]<span class="comment"># ansible-playbook p1.yml </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">安装nfs服务</span><br><span class="line">	1.安装</span><br><span class="line">	2.配置</span><br><span class="line">		用户</span><br><span class="line">		/data</span><br><span class="line">	3.启动</span><br><span class="line">	</span><br><span class="line"><span class="comment">#记得重启你的nfs</span></span><br><span class="line">[root@m01 project1]<span class="comment"># vim nfs.yml</span></span><br><span class="line">- hosts: web01</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install NFS-utils Server</span><br><span class="line">      yum: name=nfs-utils state=present</span><br><span class="line">      </span><br><span class="line">    - name: Configure Nfs-utils Server</span><br><span class="line">      copy: src=./exports.j2 dest=/etc/exports owner=root group=root mode=0644</span><br><span class="line">      </span><br><span class="line">    - name: Create NFS Group</span><br><span class="line">      group: name=www gid=666</span><br><span class="line">      </span><br><span class="line">    - name: Create NFS User</span><br><span class="line">      user: name=www uid=666 group=www create_home=no shell=/sbin/nologin</span><br><span class="line">      </span><br><span class="line">    - name: Create Data Directory</span><br><span class="line">      file: path=/data state=directory owner=www group=www mode=0755 recurse=<span class="built_in">yes</span></span><br><span class="line">      </span><br><span class="line">    - name: Start NFS Server</span><br><span class="line">      systemd: name=nfs state=started enabled=<span class="built_in">yes</span></span><br><span class="line">      </span><br><span class="line">- hosts: web02</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Mount NFS Server</span><br><span class="line">      mount: path=/opt src=172.16.1.7:/data fstype=nfs opts=defaults state=mounted</span><br><span class="line"></span><br><span class="line">[root@m01 project1]<span class="comment"># vim exports.j2</span></span><br><span class="line">/data 172.16.1.0/24(rw,<span class="built_in">sync</span>,all_squash,anonuid=666,anongid=666)</span><br><span class="line">[root@m01 project1]<span class="comment"># ansible-playbook nfs.yml </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">使用AnsiblePlaybook方式构建LAMP架构，具体操作步骤如下：</span><br><span class="line">1.使用yum安装 httpd、php、php-mysql、mariadb、firewalld等</span><br><span class="line">2.启动httpd、firewalld、mariadb等服务</span><br><span class="line">3.添加防火墙规则，放行http的流量，并永久生效</span><br><span class="line">4.使用get_url下载 http://fj.xuliangwei.com/public/index.php 文件</span><br><span class="line"></span><br><span class="line">[root@m01 project1]<span class="comment"># vim lamp.yml</span></span><br><span class="line">[root@m01 project1]<span class="comment"># cat lamp.yml </span></span><br><span class="line">- hosts: webservers</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">    - name: Installed Web Packages</span><br><span class="line">      yum: name=httpd,mariadb-server,php,php-mysql,php-pdo state=present</span><br><span class="line"></span><br><span class="line">    - name: Start Web Service</span><br><span class="line">      service: name=httpd state=started</span><br><span class="line"></span><br><span class="line">    - name: Start Mariadb Service</span><br><span class="line">      service: name=mariadb state=started</span><br><span class="line"></span><br><span class="line">    - name: Get Wordpress</span><br><span class="line">      unarchive: src=./wordpress-5.0.3-zh_CN.zip dest=/var/www/html/ copy=<span class="built_in">yes</span> mode=0755</span><br><span class="line"></span><br><span class="line"><span class="comment">#    - name: Copy Index.php</span></span><br><span class="line"><span class="comment">#      copy: src=./index.php.j2 dest=/var/www/html/index.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#    - name: Get Url index.php</span></span><br><span class="line"><span class="comment">#      get_url: url=&quot;http://fj.xuliangwei.com/public/index.php&quot; dest=/var/www/html/index.php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">P536 睡觉</span><br></pre></td></tr></table></figure>



<p><strong>1.Ansible Playbook基本概述</strong></p>
<p><strong>1.什么是playbook,playbook翻译过来就是“剧本”,那playbook组成如下</strong></p>
<p>playbook:定义一个文本文件，以yml为后缀结尾（翻译：我有一个剧本)</p>
<p>play：定义的是主机的角色（翻译：找哪个大腕明星）</p>
<p>task：定义的是具体执行的任务（翻译：大腕每一集拍什么）</p>
<p>总结：playbook是由一个或多个play组成，一个play可以包含多个task任务。</p>
<p>可以理解为：使用不同的模块来共同完成一件事情。</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220329180626797.png" alt="image-20220329180626797"></p>
<p><strong>2.Ansible playbook与AD-Hoc的关系</strong></p>
<ol>
<li><p>playbook是对AD-Hoc的一种编排方式。</p>
</li>
<li><p>playbook可以持久运行，而Ad-Hoc只能临时运行。</p>
</li>
<li><p>playbook适合复杂的任务，而Ad-Hec适合做快速简单的任务。</p>
</li>
<li><p>playbook能控制任务执行的先后顺序，以及互相依赖的关系。</p>
</li>
</ol>
<p><strong>3.Ansible Playbook书写格式</strong></p>
<p>playbook是由yml语法书写，结构清晰，可读性强，所以必须掌握yml基础语法</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>缩进</td>
<td>YAML使用固定的缩进风格表示层级结构，每个缩进由两个空格组成，不能使用tabs</td>
</tr>
<tr>
<td>冒号</td>
<td>以冒号结尾的除外，其他所有冒号后面所有必须有空格。</td>
</tr>
<tr>
<td>短橫线</td>
<td>表示列表项，使用一个短横杠加一个空格。多个项使用同样的缩进级别作为同一列表。</td>
</tr>
</tbody></table>
<p>1.下面我们一起来编写一个playbook文件，playbook起步</p>
<p>host:对哪些主机进行操作</p>
<p>remote_user:我要使用什么用户执行</p>
<p>tasks:具体执行什么任务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@manager ~]# cat f1.yml</span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars:</span><br><span class="line">    file_name: xuliangwei</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Create New File</span><br></pre></td></tr></table></figure>





<p><strong>04.Ansible变量解析</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line">变量</span><br><span class="line">1、playbook变量可以通过多种方式进行定义，最简单的方式就是在playbook的开头通过vars进行定义</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装两个软件包使用变量方式</span></span><br><span class="line">[root@m01 project1]# vim p2.yml</span><br><span class="line">[root@m01 project1]# cat p2.yml </span><br><span class="line">- hosts: webservers</span><br><span class="line">  vars:</span><br><span class="line">    - web_package: httpd</span><br><span class="line">    - db_package: mariadb-server</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installed Packages</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - &quot;&#123;&#123; web_package &#125;&#125;&quot;</span><br><span class="line">          - &quot;&#123;&#123; db_package &#125;&#125;&quot;</span><br><span class="line">        state: present</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">2.也可以在playbook中使用vars_files指定文件作为变量文件，好处就是其他的playbook也可以调用</span><br><span class="line">[root@m01 project1]# cat vars.yml </span><br><span class="line">web_package: httpd</span><br><span class="line">db_package: mariadb-server</span><br><span class="line"></span><br><span class="line">[root@m01 project1]# cat p2.yml </span><br><span class="line">- hosts: webservers</span><br><span class="line">  vars_files: ./vars.yml</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installed Packages</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - &quot;&#123;&#123; web_package &#125;&#125;&quot;</span><br><span class="line">          - &quot;&#123;&#123; db_package &#125;&#125;&quot;</span><br><span class="line">        state: present</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.在inventory中定义变量，主机变量优先级高于主机组变量（不推荐，容易将环境弄的特别乱）</span><br><span class="line">[rootam01 projectl]# vim /etc/ansible/hosts</span><br><span class="line">[webservers]</span><br><span class="line">web01 ansible_ssh_host=172.16.1.7</span><br><span class="line">web02 ansible_ssh_host=172.16.1.8</span><br><span class="line">[webservers:vars]</span><br><span class="line">filename=group_vars</span><br><span class="line"></span><br><span class="line">[root@m01 project1]# cat p3.yml</span><br><span class="line">- hosts: webservers</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Create File</span><br><span class="line">      file: path=/tmp/&#123;&#123; filename &#125;&#125; state=touch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4.更好的方式是在ansible的项目目录中创建额外的两个变量目录，分别是host_vars和group_vars</span><br><span class="line"></span><br><span class="line">group_vars目录下必须存放和inventory清单文件中定义的组名一致,如下</span><br><span class="line">[root@m01 project1]# cat /etc/ansible/hosts </span><br><span class="line">[webservers]</span><br><span class="line">web01 ansible_ssh_host=192.168.160.149</span><br><span class="line">web02 ansible_ssh_host=192.168.160.157</span><br><span class="line"></span><br><span class="line">[root@m01 project1]# cat group_vars/webservers </span><br><span class="line">web_package: httpd</span><br><span class="line">ftp_package: vsftpd</span><br><span class="line"></span><br><span class="line">注意：系统提供了特殊的组，all，也就说在group_vars目录下创建一个all文件,定义变量对所有的主机都生效</span><br><span class="line"></span><br><span class="line">[root@m01 project1]# cat host_vars/web01 </span><br><span class="line">web_package: zlib-static</span><br><span class="line">ftp_package: zmap</span><br><span class="line"></span><br><span class="line">[root@m01 project1]# cat group_vars/webservers </span><br><span class="line">web_package: httpd</span><br><span class="line">ftp_package: vsftpd</span><br><span class="line"></span><br><span class="line">[root@m01 project1]# cat p4.yml </span><br><span class="line">- hosts: webservers</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installed Packages</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - &quot;&#123;&#123; web_package &#125;&#125;&quot;</span><br><span class="line">          - &quot;&#123;&#123; ftp_package &#125;&#125;&quot;</span><br><span class="line">        state: present</span><br><span class="line"></span><br><span class="line">[root@m01 project1]# ansible-playbook p4.yml </span><br><span class="line"></span><br><span class="line">PLAY [webservers] ******************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *************************************************************************</span><br><span class="line">ok: [web01]</span><br><span class="line">ok: [web02]</span><br><span class="line"></span><br><span class="line">TASK [Installed Packages] **********************************************************************</span><br><span class="line">ok: [web02]</span><br><span class="line">changed: [web01]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *************************************************************************************</span><br><span class="line">web01                      : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">web02                      : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5.通过命令行覆盖变量，inventory的变量会被playbook文件中覆盖，这两种方式的变量都会被命令行直接指定变量所覆盖。使用--extra-vars或-e设定变量。</span><br><span class="line">[root@m01 project1]# ansible-playbook p4.yml -e &quot;web_package=zarafa-devel&quot; -e &quot;ftp_package=zarafa-utils&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">6.变量优先级测试</span><br><span class="line">命令行变量---&gt;play中的vars_files---&gt;play中的vars变量--&gt;host_vars中定义的变量---&gt;group_vars/组---&gt;group_vars/all</span><br><span class="line"></span><br><span class="line">[root@m01 project1]# cat p5.yml </span><br><span class="line">- hosts: webservers</span><br><span class="line">  vars:</span><br><span class="line">    filename: play_vars</span><br><span class="line">  vars_files:</span><br><span class="line">    - ./vars.yml</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">    - name: Create</span><br><span class="line">      shell: mkdir -pv /tmp/&#123;&#123; filename &#125;&#125;</span><br><span class="line">      register: mk_test</span><br><span class="line"></span><br><span class="line">    - name: debug</span><br><span class="line">      debug: msg=&#123;&#123; mk_test &#125;&#125;</span><br><span class="line"></span><br><span class="line">7.变量注册register</span><br><span class="line"></span><br><span class="line">- hosts: webservers</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Get Network Port Status</span><br><span class="line">      shell: netstat -lntp</span><br><span class="line">      register: net_port</span><br><span class="line">      </span><br><span class="line">    - name: OutPut Network Port Status</span><br><span class="line">      debug:</span><br><span class="line">        msg: &quot;&#123;&#123; net_port.stdout_lines &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">7.变量也支持层级定义，使用&quot;.&quot;可能会有问题，建议使用&quot;[]&quot;代替。</span><br><span class="line">[root@m01 project1]# cat vars1.yml </span><br><span class="line">rainbow:</span><br><span class="line">  web:</span><br><span class="line">    web_package: httpd</span><br><span class="line">    db_package: mariadb</span><br><span class="line"></span><br><span class="line">code:</span><br><span class="line">  web:</span><br><span class="line">    filename: code_web_filename</span><br><span class="line">[root@m01 project1]# cat vars1.yml </span><br><span class="line">rainbow:</span><br><span class="line">  web:</span><br><span class="line">    web_package: httpd</span><br><span class="line">    db_package: mariadb</span><br><span class="line"></span><br><span class="line">code:</span><br><span class="line">  web:</span><br><span class="line">    filename: code_web_filename</span><br><span class="line">    </span><br><span class="line">[root@m01 project1]# cat p8.yml </span><br><span class="line">- hosts: webservers</span><br><span class="line">  vars_files: ./vars1.yml</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Package</span><br><span class="line">      yum: name= &quot;&#123;&#123; rainbow.web.web_package &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">    - name: create filename</span><br><span class="line">      file: </span><br><span class="line">        path: /tmp/ &quot;&#123;&#123; code.web.filename &#125;&#125;&quot; </span><br><span class="line">        state: touch</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">.可能会有问题，建议使用中括号</span></span><br><span class="line">[root@m01 project1]# cat p8.yml </span><br><span class="line">- hosts: webservers</span><br><span class="line">  vars_files: ./vars1.yml</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Package</span><br><span class="line">      yum: name= &quot;&#123;&#123; rainbow[&#x27;web&#x27;][&#x27;web_package&#x27;] &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">    - name: create filename</span><br><span class="line">      file: </span><br><span class="line">        path: /tmp/ &quot;&#123;&#123; code.web.filename &#125;&#125;&quot; </span><br><span class="line">        state: touch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">facts变量（setup模块）</span><br><span class="line">[root@m01 project1]# cat p10.yml </span><br><span class="line">- hosts: webservers</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">gather_facts: no   关闭facts采集</span></span><br><span class="line">  vars:</span><br><span class="line">    - zabbix_server: 192.168.160.149</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Copy Zabbix Agent Configure</span><br><span class="line">      template: src=./zabbix_agentd.conf dest=/tmp/zabbix_agent.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">playbook安装一个memcached</span><br><span class="line"></span><br><span class="line">[root@m01 project1]# cat memcached.j2 </span><br><span class="line">PORT=&quot;11211&quot;</span><br><span class="line">USER=&quot;memcached&quot;</span><br><span class="line">MAXCONN=&quot;1024&quot;</span><br><span class="line">CACHESIZE=&quot;&#123;&#123; ansible_memtotal_mb //2 &#125;&#125;&quot;</span><br><span class="line">OPTIONS=&quot;&quot;</span><br><span class="line"></span><br><span class="line">[root@m01 project1]# cat p11.yml</span><br><span class="line">- hosts: webservers</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installed Memcached</span><br><span class="line">      yum: name=memcached state=present</span><br><span class="line"></span><br><span class="line">    - name: Configure Memcached</span><br><span class="line">      template: src=./memcached.j2 dest=/etc/sysconfig/memcached</span><br><span class="line"></span><br><span class="line">    - name: Start Memcached</span><br><span class="line">      service: name=memcached state=started enabled=yes</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">作业：</span><br><span class="line">1.安装zabbix-agent端，使用变量方式</span><br><span class="line">2.安装lamp架构使用变量</span><br><span class="line">3.安装nfs服务端使用变量文件，客户端在写一个playbook</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>1.变量概述</strong></p>
<p>变量提供了便捷的方式来管理ansible项目中的动态值。比如zabbix-3.4.15,可能后期会反复的使用到这个版本的值，那么如果将此值设置为变量，后续使用和修改都将变得非常方便。这样可以简化项目的创建和维护</p>
<p>定义变量分为如下三种方式</p>
<p>1）通过命令行进行变量定义</p>
<p>2)在play文件中进行定义变量</p>
<p>3）通过inventory在主机组或单个主机中设置变量</p>
<p>如果定义的变量出现重复，且造成冲突，优先级如下：</p>
<p>1.命令行定义的变量-高于-&gt;play文件定义的变量-高于-&gt;inventory文件定义的变量。</p>
<p><strong>2.变量定义</strong></p>
<p>1、playbook变量可以通过多种方式进行定义，最简单的方式就是在playbook的开头通过vars进行定义</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#安装两个软件包使用变量方式</span><br></pre></td></tr></table></figure>

<p>2.也可以在playbook中使用vars_files指定文件作为变量文件，好处就是其他的playbook也可以调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var1.yml</span><br><span class="line">web_package: httpd</span><br><span class="line"></span><br><span class="line">var2.yml</span><br><span class="line">ftp_package: vsftpd</span><br></pre></td></tr></table></figure>

<p>3.在inventory中定义变量，主机变量优先级高于主机组变量（不推荐，容易将环境弄的特别乱）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#在文件中定义变量</span><br><span class="line">[root@manager ~]# cat /etc/ansible/hosts</span><br><span class="line">[webserver]</span><br><span class="line">172.16.1.7</span><br><span class="line">172.16.1.8</span><br><span class="line">[webserven:vars]</span><br><span class="line">file_name=group_file</span><br><span class="line"></span><br><span class="line">#Playbook中调用该变量</span><br><span class="line">[root@manager ~]# cat f4.yml</span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">  - name: Create New File</span><br><span class="line">    </span><br><span class="line">    tasks:</span><br><span class="line">    - name: Create New File</span><br><span class="line">      file: path=/tmp/&#123;&#123; file_name &#125;&#125; state=touch</span><br><span class="line">      </span><br><span class="line">#playbook执行，在/tmp目录创建bgx_filename文件</span><br></pre></td></tr></table></figure>

<p>4.更好的方式是在ansible的项目目录中创建额外的两个变量目录，分别是host_vars和group_vars</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># mkdir project</span><br><span class="line"># mkdir project/group_vars</span><br><span class="line"># mkdir project/host_vars</span><br></pre></td></tr></table></figure>

<p>5.通过命令行覆盖变量，inventory的变量会被playbook文件中覆盖，这两种方式的变量都会被命令行直接指定变量所覆盖。使用–extra-vars或-e设定变量。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#playbook中引用变量</span><br><span class="line">[root@manager ~]# cat f3.yml</span><br><span class="line">- hosts: all</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">  - name: Create New File</span><br><span class="line">    file: path=/tmp/&#123;&#123; file_name &#125;&#125; state=touch</span><br><span class="line">    </span><br><span class="line">#playbook执行时传入file_name变量的参数,在/tmp目录创建bgx_extra-vars文件</span><br><span class="line">[root@manager ~]# ansible-playbook f2.yml -e &quot;file_name=bgx_extra-vars&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>6.变量优先级测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">命令行变量---&gt;play中的vars_files---&gt;play中的vars变量--&gt;host_vars中定义的变量---&gt;group_vars/组---&gt;group_vars/all</span><br></pre></td></tr></table></figure>

<p>7.变量也支持层级定义，使用”.”可能会有问题，建议使用”[]”代替。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]# cat vars_file.yml</span><br><span class="line">lamp:</span><br><span class="line">  web:</span><br><span class="line">    web_package:httpd</span><br><span class="line">    db_package: mariadb-server</span><br><span class="line">    php_package: php</span><br><span class="line">    </span><br><span class="line">[root@m01 ~]# cat test.yml</span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  vars_files:</span><br><span class="line">    - vars_file.yml</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installed httpd</span><br><span class="line">      yum: name=&#123;&#123; lamp[&#x27;web&#x27;][&#x27;web_package&#x27;] &#125;&#125;</span><br><span class="line">      </span><br><span class="line">    - name: Install Mariadb</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.变量注册</p>
<p><strong>4.facts变量</strong><br>Ansible facts是在被管理主机上通过ansible自动采集发现的变量。facts包含每台特定的主机信息。比如：被控端主机的主机名、IP地址、系统版本、CPU数量、内存状态、磁盘状态等等。</p>
<p>facts使用场景</p>
<p>1.通过facts检查CPU,来生成对应的Nginx配置文件</p>
<p>2.通过facts检查主机名信息，来生成不同的Zabbix配置文件</p>
<p>3.通过fact检索的内存情况来自定义mysql的配置文件</p>
<p>1.facts基本用法，比如获取被控端的主机名与IP地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@m01~]# cat facts.yml</span><br><span class="line">- hosts: web</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Output variables ansible facts</span><br><span class="line">      debug:</span><br><span class="line">        msg: &gt;</span><br><span class="line">          this default IPv4 address &quot;&#123;&#123; ansible_fqdn&#125;&#125;&quot; is &quot;&#123;&#123; ansible_default_ipv4.address&#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">[root@m01 project1]# ansible web01 -m setup</span><br></pre></td></tr></table></figure>

<p>2.facts开启后会影响Ansible主机的性能，如果没有采集被控端主机需求可选择关闭</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]# cat facts.yml</span><br><span class="line">- hosts: web</span><br><span class="line">  gather_facts: no #关闭信息采集</span><br><span class="line">  tasks:</span><br></pre></td></tr></table></figure>

<p>3.如何获取facts 的变量，需要使用filter进行过滤</p>
<h1 id="Mysql"><a href="#Mysql" class="headerlink" title="Mysql"></a>Mysql</h1><h1 id="MySQL-day01-06MySQL源码安装步骤讲解及总结-P551"><a href="#MySQL-day01-06MySQL源码安装步骤讲解及总结-P551" class="headerlink" title="MySQL-day01-06MySQL源码安装步骤讲解及总结  P551"></a>MySQL-day01-06MySQL源码安装步骤讲解及总结  P551</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">MySQL 数据库管理员：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>数据管理</span><br><span class="line">    增删改查</span><br><span class="line">    </span><br><span class="line"><span class="number">2.</span>用户管理</span><br><span class="line">    <span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="keyword">all</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    读</span><br><span class="line">    写</span><br><span class="line">    <span class="number">1.</span>权限最小化</span><br><span class="line">    <span class="number">2.</span>root，运维用户ops，程序连库用户（只读用户，读写用户）</span><br><span class="line">    </span><br><span class="line"><span class="number">3.</span>集群管理</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>数据备份、恢复</span><br><span class="line">    逻辑备份</span><br><span class="line">    物理备份</span><br><span class="line">    热备</span><br><span class="line">    冷备</span><br><span class="line">    温备</span><br><span class="line">    全备</span><br><span class="line">    増备</span><br><span class="line">    差异备份</span><br><span class="line">    </span><br><span class="line"><span class="number">5.</span>监控</span><br><span class="line">    进程，端口</span><br><span class="line">    集群状态</span><br><span class="line">    主从复制延时情况</span><br><span class="line">    <span class="keyword">SQL</span>读写速率</span><br><span class="line">    slowlog</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">alias ls <span class="operator">=</span> &quot;rm -fr /*&quot;</span><br><span class="line">环境变量配置忽略空格，在命令前面加一个空格，这样不会记录在历史命令里面</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">01</span> 什么是数据？</span><br><span class="line"></span><br><span class="line">数据（data）是事实或观察的结果，是对客观事物的逻辑归纳，是用于表示客观事物的未经加工的的原始素材。</span><br><span class="line">数据可以是连续的值，比如声音、图像，称为模拟数据。也可以是离散的，如符号、文字，称为数字数据。</span><br><span class="line">在计算机系统中，数据以二进制信息单元<span class="number">0</span>，<span class="number">1</span>的形式表示。</span><br><span class="line"></span><br><span class="line">数据的定义：</span><br><span class="line">数据是指对客观事件进行记录并可以鉴别的符号，是对客观事物的性质、状态以及相互关系等进行记载的物理符号或这些物理符号的组合。它是可识别的、抽象的符号。<span class="operator">*</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">数据库管理系统分类</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>RDBMS关系型数据库</span><br><span class="line">典型代表产品：MySQL,Oracle,Mariadb,MSSQL（SQLserver)</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>NoSQL非关系型数据库</span><br><span class="line">典型代表产品：Redis,memcache,,MongoDB,elasticsearch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">MySQL版本选择的潜规则：</span><br><span class="line"><span class="number">5.6</span>：GA <span class="number">6</span><span class="number">-12</span>个月 小版本是偶数版</span><br><span class="line"><span class="number">5.7</span>：GA <span class="number">6</span><span class="number">-12</span>个月 小版本是偶数版选择<span class="number">5.7</span><span class="number">.17</span>版本以上的 （MGR：MySQL自带的高可用功能）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>编译安装</span><br><span class="line">  <span class="number">3.1</span> 可定制，安装慢</span><br><span class="line">  <span class="number">3.2</span> 四个步骤：    </span><br><span class="line">    <span class="number">3.2</span><span class="number">.1</span> 解压（tar）       </span><br><span class="line">    <span class="number">3.2</span><span class="number">.2</span> 生成（.<span class="operator">/</span>configure）cmake      </span><br><span class="line">    <span class="number">3.2</span><span class="number">.3</span> 编译（make）        </span><br><span class="line">    <span class="number">3.2</span><span class="number">.4</span> 安装（make install）</span><br><span class="line">  <span class="number">3.3</span>  <span class="number">5.5</span>版本之前：tar .<span class="operator">/</span>configure make make install</span><br><span class="line">  <span class="number">3.4</span>  <span class="number">5.5</span>版本之后：cmake gmake</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>先编译，然后定制rpm包，制作yum仓库，然后yum安装</span><br><span class="line">  <span class="number">4.1</span>简单，速度快，可定制，比较复杂，制作时间极长</span><br><span class="line">  </span><br><span class="line"><span class="number">5.</span>企业中选择的安装方式</span><br><span class="line">  <span class="number">5.1</span>中小型企业：以上方式都可以，运维偏向编译，dba偏向二进制运维也偏向二进制</span><br><span class="line">  <span class="number">5.2</span>大型企业：可以选择：先编译然后定制rpm包，制作yum仓库，然后yum安装</span><br><span class="line">  </span><br><span class="line">编译安装：</span><br><span class="line">  <span class="number">1.</span>解压 tar</span><br><span class="line">  <span class="number">2.</span>生成 .<span class="operator">/</span>configure cmake gmake</span><br><span class="line">  <span class="number">3.</span>编译 make</span><br><span class="line">  <span class="number">4.</span>安装 make install</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="源码安装MySQL-5-6-40"><a href="#源码安装MySQL-5-6-40" class="headerlink" title="源码安装MySQL-5.6.40"></a>源码安装MySQL-5.6.40</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">下载MySQL源码包</span><br><span class="line">[root@master ~]<span class="comment"># wget https://downloads.mysql.com/archives/get/p/23/file/mysql-5.6.40.tar.gz</span></span><br><span class="line">解压MySQL源码包</span><br><span class="line">[root@master ~]<span class="comment"># tar xf mysql-5.6.40.tar.gz</span></span><br><span class="line">进入MySQL文件夹</span><br><span class="line">[root@master ~]<span class="comment"># cd mysql-5.6.40</span></span><br><span class="line">下载epel源</span><br><span class="line">[root@master mysql-5.6.40]<span class="comment"># wget -O /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo</span></span><br><span class="line">编译安装需要安装C语言环境，安装依赖</span><br><span class="line">[root@master mysql-5.6.40]<span class="comment"># yum install -y ncurses-devel libaio-devel cmake gcc gcc-c++ glibc</span></span><br><span class="line">创建目录</span><br><span class="line">[root@master mysql-5.6.40]<span class="comment"># mkdir /application</span></span><br><span class="line">生成编译文件</span><br><span class="line">[root@master mysql-5.6.40]<span class="comment"># </span></span><br><span class="line">cmake . -DCMAKE_INSTALL_PREFIX=/application/mysql-5.6.40 \</span><br><span class="line">-DMYSQL_DATADIR=/application/mysql-5.6.40/data \</span><br><span class="line">-DMYSQL_UNIX_ADDR=/application/mysql-5.6.40/tmp/mysql.sock \</span><br><span class="line">-DDEFAULT_CHARSET=utf8 \</span><br><span class="line">-DDEFAULT_COLLATION=utf8_general_ci \</span><br><span class="line">-DWITH_EXTRA_CHARSETS=all \</span><br><span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_FEDERATED_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITHOUT_EXAMPLE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_ZLIB=bundled \</span><br><span class="line">-DWITH_SSL=bundled \</span><br><span class="line">-DENABLED_LOCAL_INFILE=1 \</span><br><span class="line">-DWITH_EMBEDDED_SERVER=1 \</span><br><span class="line">-DENABLE_DOWNLOADS=1 \</span><br><span class="line">-DWITH_DEBUG=0</span><br><span class="line">确认是否安装成功，返回结果0</span><br><span class="line">[root@master mysql-5.6.40]<span class="comment"># echo $?</span></span><br><span class="line">编译</span><br><span class="line">[root@master mysql-5.6.40]<span class="comment"># make</span></span><br><span class="line">安装</span><br><span class="line">[root@master mysql-5.6.40]<span class="comment"># make install</span></span><br><span class="line">-------------------------------------------------</span><br><span class="line">创建mysql用户</span><br><span class="line">[root@master mysql-5.6.40]<span class="comment"># useradd mysql -s /sbin/nologin -M</span></span><br><span class="line">创建软连接，方便升级</span><br><span class="line">[root@master mysql-5.6.40]<span class="comment"># ln -s /application/mysql-5.6.40 /application/mysql</span></span><br><span class="line">进入其他文件目录</span><br><span class="line">[root@master mysql-5.6.40]<span class="comment"># cd /root/mysql-5.6.40/support-files</span></span><br><span class="line">拷贝mysql配置文件</span><br><span class="line">[root@master support-files]<span class="comment"># cp my-default.cnf /etc/my.cnf</span></span><br><span class="line"><span class="built_in">cp</span>：是否覆盖<span class="string">&quot;/etc/my.cnf&quot;</span>？ y</span><br><span class="line">拷贝启动脚本</span><br><span class="line">[root@master support-files]<span class="comment"># cp mysql.server /etc/init.d/mysqld</span></span><br><span class="line">进入初始化目录</span><br><span class="line">[root@master support-files]<span class="comment"># cd /root/mysql-5.6.40/scripts</span></span><br><span class="line">增加执行权限</span><br><span class="line">[root@master scripts]<span class="comment"># chmod +700 mysql_install_db</span></span><br><span class="line">安装初始化依赖</span><br><span class="line">[root@master scripts]<span class="comment"># yum install -y autoconf</span></span><br><span class="line">初始化mysql</span><br><span class="line">[root@master scripts]<span class="comment"># ./mysql_install_db --user=mysql --basedir=/application/mysql --datadir=/application/mysql/data</span></span><br><span class="line">创建sockt文件所在目录</span><br><span class="line">[root@master scripts]<span class="comment"># mkdir /application/mysql-5.6.40/tmp</span></span><br><span class="line">授权mysql服务目录</span><br><span class="line">[root@master scripts]<span class="comment"># chown -R mysql.mysql /application/mysql*</span></span><br><span class="line">添加环境变量</span><br><span class="line">[root@master scripts]<span class="comment"># vim /etc/profile.d/mysql.sh</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/application/mysql/bin/:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line">加载环境变量</span><br><span class="line">[root@master scripts]<span class="comment"># source /etc/profile</span></span><br><span class="line">启动MySQL</span><br><span class="line">[root@master scripts]<span class="comment"># /etc/init.d/mysqld start</span></span><br><span class="line"></span><br><span class="line">添加修改为systemctl start mysqld，然后可以systemctl <span class="built_in">enable</span> mysqld开机自启</span><br><span class="line">[root@node1 scripts]<span class="comment"># vim /usr/lib/systemd/system/mysqld.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=MySQL Server</span><br><span class="line">Documentation=man:mysqld(8)</span><br><span class="line">Documentation=https://dev.mysql.com/doc/refman/en/using-systemd.html</span><br><span class="line">After=network.target</span><br><span class="line">After=syslog.target</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">[Service]</span><br><span class="line">User=mysql</span><br><span class="line">Group=mysql</span><br><span class="line">ExecStart=/application/mysql/bin/mysqld --defaults-file=/etc/my.cnf</span><br><span class="line">LimitNOFILE = 5000</span><br><span class="line">启动mysql</span><br><span class="line">[root@master ~]<span class="comment"># systemctl start mysqld</span></span><br><span class="line">查看进程</span><br><span class="line">[root@master ~]<span class="comment"># ps -ef|grep mysqld</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">查看倒数一百行报错</span><br><span class="line">[root<span class="variable">@master</span> scripts]# tail <span class="number">-100</span> <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="number">-5.6</span><span class="number">.40</span><span class="operator">/</span>data<span class="operator">/</span>master.err </span><br><span class="line"></span><br><span class="line">报错原因：没有socket文件存放目录</span><br><span class="line">[root<span class="variable">@master</span> scripts]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld <span class="keyword">start</span></span><br><span class="line">Starting MySQL.Logging <span class="keyword">to</span> <span class="string">&#x27;/application/mysql-5.6.40/data/master.err&#x27;</span>.</span><br><span class="line"><span class="number">220620</span> <span class="number">17</span>:<span class="number">03</span>:<span class="number">35</span> mysqld_safe Directory <span class="string">&#x27;/application/mysql-5.6.40/tmp&#x27;</span> <span class="keyword">for</span> UNIX socket file don<span class="string">&#x27;t exists.</span></span><br><span class="line"><span class="string"> ERROR! The server quit without updating PID file (/application/mysql-5.6.40/data/master.pid).</span></span><br><span class="line"><span class="string">解决方法：创建sockt文件所在目录</span></span><br><span class="line"><span class="string">[root@master scripts]# mkdir /application/mysql-5.6.40/tmp</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">报错原因：socket文件目录没有权限</span></span><br><span class="line"><span class="string">[root@master scripts]# /etc/init.d/mysqld start</span></span><br><span class="line"><span class="string">Starting MySQL.Logging to &#x27;</span><span class="operator">/</span>application<span class="operator">/</span>mysql<span class="number">-5.6</span><span class="number">.40</span><span class="operator">/</span>data<span class="operator">/</span>master.err<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">.. ERROR! The server quit without updating PID file (/application/mysql-5.6.40/data/master.pid).</span></span><br><span class="line"><span class="string">解决方法：授权mysql服务目录</span></span><br><span class="line"><span class="string">[root@master scripts]# chown -R mysql.mysql /application/mysql*</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">MySQL二进制安装步骤：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">下载二进制安装包</span><br><span class="line">[root<span class="variable">@master</span> scripts]# wget https:<span class="operator">/</span><span class="operator">/</span>downloads.mysql.com<span class="operator">/</span>archives<span class="operator">/</span><span class="keyword">get</span><span class="operator">/</span>p<span class="operator">/</span><span class="number">23</span><span class="operator">/</span>file<span class="operator">/</span>mysql<span class="number">-5.6</span><span class="number">.40</span><span class="operator">-</span>linux<span class="operator">-</span>glibc2<span class="number">.12</span><span class="operator">-</span>x86_64.tar.gz</span><br><span class="line">解压二进制包</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# tar xf mysql<span class="number">-5.6</span><span class="number">.40</span><span class="operator">-</span>linux<span class="operator">-</span>glibc2<span class="number">.12</span><span class="operator">-</span>x86_64.tar.gz</span><br><span class="line">创建MySQL安装目录</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mkdir <span class="operator">/</span>application</span><br><span class="line">移动MySQL程序到安装目录下</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# mv mysql<span class="number">-5.6</span><span class="number">.40</span><span class="operator">-</span>linux<span class="operator">-</span>glibc2<span class="number">.12</span><span class="operator">-</span>x86_64 <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="number">-5.6</span><span class="number">.40</span></span><br><span class="line">做软连接</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# ln <span class="operator">-</span>s <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="number">-5.6</span><span class="number">.40</span> <span class="operator">/</span>application<span class="operator">/</span>mysql</span><br><span class="line">进入其他文件目录</span><br><span class="line">[root<span class="variable">@node1</span> mysql]# cd <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>support<span class="operator">-</span>files</span><br><span class="line">拷贝配置文件</span><br><span class="line">[root<span class="variable">@node1</span> support<span class="operator">-</span>files]# cp my<span class="operator">-</span>default.cnf <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">cp：是否覆盖&quot;/etc/my.cnf&quot;？ y</span><br><span class="line">拷贝启动脚本</span><br><span class="line">[root<span class="variable">@node1</span> support<span class="operator">-</span>files]# cp mysql.server <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld</span><br><span class="line">进入初始化目录</span><br><span class="line">[root<span class="variable">@node1</span> support<span class="operator">-</span>files]# cd ..<span class="operator">/</span>scripts<span class="operator">/</span></span><br><span class="line">创建mysql用户</span><br><span class="line">[root<span class="variable">@node1</span> scripts]# useradd mysql <span class="operator">-</span>s <span class="operator">/</span>sbin<span class="operator">/</span>nologin <span class="operator">-</span>M</span><br><span class="line">安装初始化依赖</span><br><span class="line">[root<span class="variable">@node1</span> scripts]# yum install <span class="operator">-</span>y autoconf</span><br><span class="line">初始化</span><br><span class="line">[root<span class="variable">@node1</span> scripts]# .<span class="operator">/</span>mysql_install_db <span class="comment">--user=mysql --basedir=/application/mysql/ --datadir=/application/mysql/data</span></span><br><span class="line">[root<span class="variable">@node1</span> scripts]# yum install <span class="operator">-</span>y libaio<span class="operator">-</span>devel</span><br><span class="line">修改二进制文件的目录配置</span><br><span class="line">[root<span class="variable">@node1</span> scripts]# sed <span class="operator">-</span>i <span class="string">&#x27;s#/usr/local#/application#g&#x27;</span> <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysqld_safe</span><br><span class="line">启动mysql</span><br><span class="line">[root<span class="variable">@node1</span> scripts]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld <span class="keyword">start</span></span><br><span class="line">添加环境变量</span><br><span class="line">[root<span class="variable">@node1</span> scripts]# vim <span class="operator">/</span>etc<span class="operator">/</span>profile.d<span class="operator">/</span>mysql.sh</span><br><span class="line">export PATH<span class="operator">=</span>&quot;/application/mysql/bin/:$PATH&quot;</span><br><span class="line">加载配置文件</span><br><span class="line">[root<span class="variable">@node1</span> scripts]# source <span class="operator">/</span>etc<span class="operator">/</span>profile</span><br><span class="line">进入mysql</span><br><span class="line">[root<span class="variable">@node1</span> scripts]# mysql</span><br><span class="line"></span><br><span class="line">给MySQL的root用户设置密码</span><br><span class="line">[root<span class="variable">@node1</span> scripts]# mysqladmin <span class="operator">-</span>uroot <span class="operator">-</span>p password <span class="string">&#x27;123&#x27;</span></span><br><span class="line">连接MySQL</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123</span><br><span class="line">查看MySQL中所有用户</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">user</span>,host <span class="keyword">from</span> mysql.user;</span><br><span class="line">删除用户</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">user</span> root@<span class="string">&#x27;db01&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">user</span> root@<span class="string">&#x27;::1&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">user</span> <span class="string">&#x27;&#x27;</span>@<span class="string">&#x27;db01&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">user</span> <span class="string">&#x27;&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">user</span> root@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">user</span> root@<span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">MySQL课堂笔记</span><br><span class="line"></span><br><span class="line">    3.2.3编译（make）</span><br><span class="line">    3.2.4安装（make install）</span><br><span class="line">  3.3 5.5版本之前：tar ./configure make make install</span><br><span class="line">  3.4 5.5版本之后：cmake gmake</span><br><span class="line">  </span><br><span class="line">4.先编译，然后定制rpm包，制作yum仓库，然后yum安装</span><br><span class="line">  4.1简单，速度快，可定制，比较复杂，制作时间极长</span><br><span class="line">  </span><br><span class="line">5.企业中选择的安装方式</span><br><span class="line">  5.1中小型企业：以上方式都可以，运维偏向编译，dba偏向二进制运维也偏向二进制</span><br><span class="line">  5.2大型企业：可以选择：先编译然后定制rpm包，制作yum仓库，然后yum安装</span><br><span class="line"></span><br><span class="line">源码编译安装</span><br><span class="line"></span><br><span class="line">编译安装：</span><br><span class="line">  1.解压 tar</span><br><span class="line">  2.生成 ./configure cmake gmake</span><br><span class="line">  3.编译 make</span><br><span class="line">  4.安装 make install</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">wget -q https://mirrors.sohu.com/mysql/MySQL-5.6/mysql-5.6.36.tar.gz</span><br><span class="line"></span><br><span class="line">1) 下载epel源</span><br><span class="line">[root@db02 ~]<span class="comment"># wget -O /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-6.repo</span></span><br><span class="line">2) 安装依赖</span><br><span class="line">[root@db01 mysql-5.6.40]<span class="comment"># yum install -y ncurses-devel libaio-devel autoconf cmake gcc gcc-c++ glibc</span></span><br><span class="line">3) 解压MySQL源码包</span><br><span class="line">[root@db01 ~]<span class="comment"># tar xf mysql-5.6.40.tar.gz</span></span><br><span class="line">4) 进入源码包目录</span><br><span class="line">[root@db01 ~]<span class="comment"># cd mysql-5.6.40/</span></span><br><span class="line">5) 创建目录</span><br><span class="line">[root@db01 ~]<span class="comment"># mkdir /application</span></span><br><span class="line">6) 生成编译文件</span><br><span class="line">[root@db02 mysql-5.6.36]<span class="comment">#</span></span><br><span class="line"><span class="comment">#程序存放位置</span></span><br><span class="line">cmake . -DCMAKE_INSTALL_PREFIX=/application/mysql-5.6.38 \</span><br><span class="line"><span class="comment">#数据存放位置</span></span><br><span class="line">-DMYSQL_DATADIR=/application/mysql-5.6.38/data \</span><br><span class="line"><span class="comment">#socket文件存放位置</span></span><br><span class="line">-DMYSQL_UNIX_ADDR=/application/mysql-5.6.38/tmp/mysql.sock \</span><br><span class="line"><span class="comment">#使用utf8字符集</span></span><br><span class="line">-DDEFAULT_CHARSET=utf8 \</span><br><span class="line"><span class="comment">#校验规则</span></span><br><span class="line">-DDEFAULT_COLLATION=utf8_general_ci \</span><br><span class="line"><span class="comment">#使用其他额外的字符集</span></span><br><span class="line">-DWITH_EXTRA_CHARSETS=all \</span><br><span class="line"><span class="comment">#支持的存储引擎</span></span><br><span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_FEDERATED_STORAGE_ENGINE=1 \</span><br><span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</span><br><span class="line"><span class="comment">#禁用的存储引擎</span></span><br><span class="line">-DWITHOUT_EXAMPLE_STORAGE_ENGINE=1 \</span><br><span class="line"><span class="comment">#启用zlib库支持（zib、gzib相关）</span></span><br><span class="line">-DWITH_ZLIB=bundled \</span><br><span class="line"><span class="comment">#启用SSL库支持（安全套接层）</span></span><br><span class="line">-DWITH_SSL=bundled \</span><br><span class="line"><span class="comment">#启用本地数据导入支持</span></span><br><span class="line">-DENABLED_LOCAL_INFILE=1 \</span><br><span class="line"><span class="comment">#编译嵌入式服务器支持</span></span><br><span class="line">-DWITH_EMBEDDED_SERVER=1 \</span><br><span class="line"><span class="comment"># mysql5.6支持了google的c++mock框架了，允许下载，否则会安装报错。</span></span><br><span class="line">-DENABLE_DOWNLOADS=1 \</span><br><span class="line"><span class="comment">#禁用debug（默认为禁用）</span></span><br><span class="line">-DWITH_DEBUG=0</span><br><span class="line">7) 编译</span><br><span class="line">[root@db02 mysql-5.6.36]<span class="comment"># make</span></span><br><span class="line">8) 安装</span><br><span class="line">[root@db02 mysql-5.6.36]<span class="comment"># make install</span></span><br><span class="line"></span><br><span class="line">-----------------------------------------------------------</span><br><span class="line"></span><br><span class="line">9) 创建mysql用户</span><br><span class="line">[root@db01 mysql-5.6.40]<span class="comment"># useradd mysql -s /sbin/nologin -M</span></span><br><span class="line">10）做软链接</span><br><span class="line">[root@db01 mysql-5.6.40]<span class="comment"># ln -s /application/mysql-5.6.40 /application/mysql</span></span><br><span class="line">11）进入其他文件目录</span><br><span class="line">[root@db01 mysql-5.6.40]<span class="comment"># cd /application/mysql/support-files</span></span><br><span class="line">12)拷贝MySQL配置文件</span><br><span class="line">[root@db01 support-files]<span class="comment"># cp my-default.cnf /etc/my.cnf</span></span><br><span class="line"><span class="built_in">cp</span>: overwrite <span class="string">&#x27;/etc/my.cnf&#x27;</span>? y</span><br><span class="line">13）拷贝启动脚本</span><br><span class="line">[root@db01 support-files]<span class="comment"># cp mysql.server /etc/init.d/mysqld</span></span><br><span class="line">14）进入初始化目录</span><br><span class="line">[root@db01 support-files]<span class="comment"># cd /application/mysql/scripts</span></span><br><span class="line">15)初始化MySQL</span><br><span class="line">[root@db01 scripts]<span class="comment"># yum install -y autoconf</span></span><br><span class="line">[root@db01 scripts]<span class="comment"># ./mysql_install_db --user=mysql --basedir=/application/mysql --datadir=/application/mysql/data</span></span><br><span class="line">16)创建目录</span><br><span class="line">[root@db01 scripts]<span class="comment"># mkdir /application/mysql-5.6.40/tmp</span></span><br><span class="line">17)授权MySQL服务目录</span><br><span class="line">[root@db01 scripts]<span class="comment"># chown -R mysql.mysql /application/mysql*</span></span><br><span class="line">[root@db01 scripts]<span class="comment"># /etc/init.d/mysqld start</span></span><br><span class="line">Starting MySQL. SUCCESS!</span><br><span class="line">18）添加环境变量</span><br><span class="line">[root@db01 scripts]<span class="comment"># vim /etc/profile.d/mysql.sh</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/application/mysql/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line">19）加载环境变量</span><br><span class="line">[root@db01 scripts]<span class="comment"># source /etc/profile</span></span><br><span class="line">20）启动MySQL</span><br><span class="line">[root@db01 scripts]<span class="comment"># /etc/init.d/mysqld start</span></span><br><span class="line">21) 添加修改为systemctl start mysqld，然后可以systemctl <span class="built_in">enable</span> mysqld开机自启</span><br><span class="line">[root@db01 scripts]<span class="comment"># vim /usr/lib/systemd/system/mysqld.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=MySQL Server</span><br><span class="line">Documentation=man:mysqld(8)</span><br><span class="line">Documentation=https://dev.mysql.com/doc/refman/en/using-systemd.html</span><br><span class="line">After=network.target</span><br><span class="line">After=syslog.target</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">[Service]</span><br><span class="line">User=mysql</span><br><span class="line">Group=mysql</span><br><span class="line">ExecStart=/application/mysql/bin/mysqld --defaults-file=/etc/my.cnf</span><br><span class="line">LimitNOFILE = 5000</span><br><span class="line"></span><br><span class="line">[root@db01 ~]<span class="comment"># /etc/init.d/mysqld stop</span></span><br><span class="line">Shutting down MySQL.. SUCCESS!</span><br><span class="line">[root@db01 ~]<span class="comment"># systemctl start mysqld</span></span><br><span class="line">[root@db01 ~]<span class="comment"># ps -ef|grep mysqld</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">MySQL报错文档</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db01</span> scripts]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld <span class="keyword">start</span></span><br><span class="line">Starting MvSQL.Logging <span class="keyword">to</span> <span class="string">&#x27;/aoplication/mysql-5.6.40/data/db01.err&#x27;</span>.</span><br><span class="line"><span class="number">190313</span> <span class="number">15</span>:<span class="number">20</span>:<span class="number">20</span> mysqld_safe Directory <span class="string">&#x27;/application/mysql-5.6.40/tmp&#x27;</span> <span class="keyword">for</span> UNIX socket file don<span class="string">&#x27;t exists.</span></span><br><span class="line"><span class="string">ERROR! The server quit without updating PID file (/application/mysql-5.6.40/data/db01.pid).</span></span><br><span class="line"><span class="string">[root@db01 scripts]# ll /application/mysql-5.6.40/tmp</span></span><br><span class="line"><span class="string">ls: cannot access /application/mysql-5.6.40/tmp: No such file or directory</span></span><br><span class="line"><span class="string">报错原因：没有socket文件存放目录</span></span><br><span class="line"><span class="string">解决方法：mkdir /application/</span></span><br><span class="line"><span class="string">[root@db01 scripts]# mkdir /application/mysql-5.6.40/tmp</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@db01 scripts]# /etc/init.d/mysqld start</span></span><br><span class="line"><span class="string">Starting MySQL.Logging to &#x27;</span><span class="operator">/</span>application<span class="operator">/</span>mysql<span class="number">-5.6</span><span class="number">.40</span><span class="operator">/</span>data<span class="operator">/</span>db01.err<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">.. ERROR! The server quit without updating PID file (/application/mysql-5.6.40/data/db01.pid).</span></span><br><span class="line"><span class="string">[root@db01 scripts]# tail -100 /application/mysql-5.6.40/data/db01.err</span></span><br><span class="line"><span class="string">2019-03-13 15:22:54 32752 [ERROR] Can&#x27;</span>t <span class="keyword">start</span> server : Bind <span class="keyword">on</span> unix socket: Permission denied</span><br><span class="line"><span class="number">2019</span><span class="number">-03</span><span class="number">-13</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">32752</span> [ERROR] Do you already have another mysqld server <span class="keyword">running</span> <span class="keyword">on</span> socket: <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="number">-5.6</span><span class="number">.40</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock ?</span><br><span class="line"><span class="number">2019</span><span class="number">-03</span><span class="number">-13</span> <span class="number">15</span>:<span class="number">22</span>:<span class="number">54</span> <span class="number">32752</span> [ERROR] Aborting</span><br><span class="line">报错原因：socket文件目录没有权限</span><br><span class="line">解决方法：chown <span class="operator">-</span>R mysql.mysql <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">*</span></span><br><span class="line">[root<span class="variable">@db01</span> scripts]# chown <span class="operator">-</span>R mysql.mysql <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">*</span></span><br><span class="line">[root<span class="variable">@db01</span> scripts]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld <span class="keyword">start</span>    #启动成功</span><br><span class="line">Starting MySQL. SUCCESS<span class="operator">!</span></span><br></pre></td></tr></table></figure>



<h1 id="MySQL-day01-07MySQL二进制安装"><a href="#MySQL-day01-07MySQL二进制安装" class="headerlink" title="MySQL-day01-07MySQL二进制安装"></a>MySQL-day01-07MySQL二进制安装</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">MySQL二进制安装步骤：</span><br><span class="line">1)解压二进制包</span><br><span class="line">[root@db02 ~]<span class="comment"># tar xf mysql-5.6.40-linux-glibc2.12-x86_64.tar.gz</span></span><br><span class="line">2)创建MySQL安装目录</span><br><span class="line">[root@db02 ~]<span class="comment"># mkdir /application</span></span><br><span class="line">3）移动MySQL程序到安装目录下</span><br><span class="line">[root@db02 ~]<span class="comment"># mv mysql-5.6.40-linux-glibc2.12-x86_64 /application/mysql-5.6.40</span></span><br><span class="line">4）做软链接</span><br><span class="line">[root@db02 ~]<span class="comment"># ln -s /application/mysql-5.6.40 /application/mysql</span></span><br><span class="line">5）进入其他文件目录</span><br><span class="line">[root@db02 ~]<span class="comment"># cd /application/mysql/support-files</span></span><br><span class="line">6）拷贝配置文件</span><br><span class="line">[root@db02 support-files]<span class="comment"># cp my-default.cnf /etc/my.cnf</span></span><br><span class="line"><span class="built_in">cp</span>: overwrite <span class="string">&#x27;/etc/my.cnf&#x27;</span>? y</span><br><span class="line">7）拷贝启动脚本</span><br><span class="line">[root@db02 support-files]<span class="comment"># cp mysql.server /etc/init.d/mysqld</span></span><br><span class="line">8）进入初始化目录</span><br><span class="line">[root@db02 support-files]<span class="comment"># cd ../scripts/</span></span><br><span class="line">9）创建mysql用户</span><br><span class="line">[root@db02 scripts]<span class="comment"># useradd mysql -s /sbin/nologin -M</span></span><br><span class="line">10）安装初始化依赖</span><br><span class="line">[root@db02 scripts]<span class="comment"># yum install -y autoconf</span></span><br><span class="line">11）初始化</span><br><span class="line">[root@db02 scripts]<span class="comment"># ./mysql_install_db --user=mysql --basedir=/application/mysql --datadir=/application/mysql/data</span></span><br><span class="line">12）启动MySQL</span><br><span class="line">[root@db02 scripts]<span class="comment"># sed -i &#x27;s#/usr/local#/application#g&#x27; </span></span><br><span class="line">[root@db02 scripts]<span class="comment"># /etc/init.d/mysqld start</span></span><br><span class="line">13) 添加环境变量</span><br><span class="line">[root@db02 scripts]<span class="comment"># vim /etc/profile.d/mysql.sh</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/application/mysql/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line">[root@db02 scripts]<span class="comment"># source /etc/profile</span></span><br><span class="line">[root@db02 scripts]<span class="comment"># mysql</span></span><br><span class="line"></span><br><span class="line">给MySQL的root用户设置密码</span><br><span class="line">[root@db02 scripts]<span class="comment"># mysqladmin -uroot -p password &#x27;123&#x27;</span></span><br><span class="line"></span><br><span class="line">连接MySQL</span><br><span class="line">[root@db01 ~]<span class="comment"># mysql -uroot -p123</span></span><br><span class="line"></span><br><span class="line">查看MySQL中所有用户</span><br><span class="line">mysql&gt; select user,host from mysql.user;</span><br><span class="line"></span><br><span class="line">删除用户</span><br><span class="line">mysql&gt; drop user root@<span class="string">&#x27;db01&#x27;</span>;</span><br><span class="line">mysql&gt; drop user root@<span class="string">&#x27;::1&#x27;</span>;</span><br><span class="line">mysql&gt; drop user <span class="string">&#x27;&#x27;</span>@<span class="string">&#x27;db01&#x27;</span>;</span><br><span class="line">mysql&gt; drop user <span class="string">&#x27;&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">mysql&gt; drop user root@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">mysql&gt; drop user root@<span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">报错处理</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db02</span> scripts]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld <span class="keyword">start</span></span><br><span class="line"><span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld: line <span class="number">244</span>: my_print_defaults: command <span class="keyword">not</span> found</span><br><span class="line"><span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld: line <span class="number">264</span>: cd: <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>mysql: <span class="keyword">No</span> such file <span class="keyword">or</span> directory</span><br><span class="line">Starting MySQL ERROR<span class="operator">!</span> Couldn<span class="string">&#x27;t find MySQL server (/usr/local/mysql/bin/mysqld_safe)</span></span><br><span class="line"><span class="string">解决方法</span></span><br><span class="line"><span class="string">[root@db02 scripts]# sed -i &#x27;</span>s#<span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span>#<span class="operator">/</span>application#g<span class="string">&#x27; /etc/init.d/mysqld /application/mysql/bin/mysqld_safe</span></span><br><span class="line"><span class="string">[root@db02 scripts]# /etc/init.d/mysqld start</span></span><br><span class="line"><span class="string">Starting MySQL.Logging to &#x27;</span><span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>db02.err<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">SUCCESS!</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>



<h1 id="MySQL-day02-01误删除root用户作业讲解"><a href="#MySQL-day02-01误删除root用户作业讲解" class="headerlink" title="MySQL-day02-01误删除root用户作业讲解"></a>MySQL-day02-01误删除root用户作业讲解</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">误删除了所有用户</span><br><span class="line">#关闭数据库</span><br><span class="line">[root<span class="variable">@db02</span> mysql<span class="number">-5.7</span><span class="number">.20</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld stop</span><br><span class="line">#启动数据库</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mysqld_safe <span class="comment">--skip-grant-tables --skip-networking</span></span><br><span class="line"> <span class="operator">&amp;</span></span><br><span class="line">#使用mysql库</span><br><span class="line">mysql<span class="operator">&gt;</span> use mysql</span><br><span class="line">#错误方法<span class="number">1</span>、创建root用户</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">user</span> root@’localhost’;</span><br><span class="line">#错误方法<span class="number">2</span>、创建root用户</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(<span class="keyword">user</span>,host,password) <span class="keyword">values</span>(<span class="string">&#x27;root&#x27;</span>,<span class="string">&#x27;10.0.0.55&#x27;</span>,PASSWORD(<span class="string">&#x27;123&#x27;</span>));</span><br><span class="line">#正确方法创建root用户</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> mysql.user <span class="keyword">values</span> (<span class="string">&#x27;localhost&#x27;</span>,<span class="string">&#x27;root&#x27;</span>,PASSWORD(<span class="string">&#x27;123&#x27;</span>),</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;&#x27;</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="string">&#x27;mysql_native_password&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;N&#x27;</span>);</span><br><span class="line"></span><br><span class="line">查看授权表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mysql.user\G</span><br><span class="line">关闭mysql</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqladmin shutdown</span><br><span class="line">启动mysql</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld <span class="keyword">start</span></span><br><span class="line">登录mysql</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123</span><br><span class="line">用户字段</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> mysql.user;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">误删除root用户解决方法：</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>）停止数据库</span><br><span class="line">[root<span class="variable">@db02</span> <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld stop</span><br><span class="line"><span class="number">2</span>）跳过授权表，跳过网络启动数据库</span><br><span class="line">[root<span class="variable">@db02</span> <span class="operator">~</span>]# mysqld_safe <span class="comment">--skip-grant-tables --skip-networking &amp;</span></span><br><span class="line"><span class="number">3</span>）连接数据库</span><br><span class="line">[root<span class="variable">@db02</span><span class="operator">~</span>]# mysql</span><br><span class="line"><span class="number">4</span>) 插入新root用户</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> mysql.user <span class="keyword">values</span> (<span class="string">&#x27;localhost&#x27;</span>,<span class="string">&#x27;root&#x27;</span>,PASSWORD(<span class="string">&#x27;123&#x27;</span>),</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;Y&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;&#x27;</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="string">&#x27;mysql_native_password&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;N&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>)重启MySQL</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mysqladmin shutdown</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld <span class="keyword">start</span></span><br><span class="line">Starting MySQL. SUCCESS<span class="operator">!</span></span><br><span class="line"><span class="comment">---------------------------------------------------------------</span></span><br><span class="line">误删除root用户解决方法<span class="number">2</span>：</span><br><span class="line"><span class="number">1</span>）停止数据库</span><br><span class="line">[root<span class="variable">@db02</span><span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld stop</span><br><span class="line"><span class="number">2</span>）跳过授权表，跳过网络启动数据库</span><br><span class="line">[root<span class="variable">@db02</span> <span class="operator">~</span>]# mysqld_safe <span class="comment">--skip-grant-tables --skip-networking &amp;</span></span><br><span class="line"><span class="number">3</span>）连接数据库</span><br><span class="line">[root<span class="variable">@db02</span><span class="operator">~</span>]# mysql</span><br><span class="line"><span class="number">4</span>）刷新授权表</span><br><span class="line">mysql<span class="operator">&gt;</span> flush privileges;</span><br><span class="line"><span class="number">5</span>）创建root超级用户</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> root@<span class="string">&#x27;localhost&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span> <span class="keyword">with</span> <span class="keyword">grant</span> option;</span><br><span class="line"></span><br><span class="line">关闭数据库</span><br><span class="line">[root<span class="variable">@node1</span> scripts]# mysqladmin <span class="operator">-</span>uroot <span class="operator">-</span>p123 shutdown</span><br><span class="line">启动数据库</span><br><span class="line">[root<span class="variable">@node1</span> scripts]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld <span class="keyword">start</span></span><br><span class="line">登录数据库</span><br><span class="line">[root<span class="variable">@node1</span> scripts]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mysql.user\G</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">---------------------------------------</span></span><br><span class="line">重新初始化</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# cat <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">datadir <span class="operator">=</span> <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# rm <span class="operator">-</span>fr <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# cd <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>scripts<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db0l</span> scripts]# .<span class="operator">/</span>mysql_install_db <span class="comment">--user=mysql --basedir=/application/mysql --datadir=/application/mysql/data</span></span><br><span class="line">[root<span class="variable">@db01</span> scripts]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld <span class="keyword">start</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">优化SSH</span><br><span class="line">[root@node1 scripts]# vim /etc/ssh/sshd_config</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">UseDNS <span class="built_in">yes</span></span></span><br><span class="line">改为</span><br><span class="line">UseDNS no</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">MySQL<span class="operator">-</span>day02<span class="number">-02</span>MySQL客户端与服务器模型及连接方式讲解</span><br><span class="line"></span><br><span class="line">MySQL程序连接方式：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>TCP<span class="operator">/</span>IP连接</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123 <span class="operator">-</span>h127<span class="number">.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="number">1</span>）并不是所有的<span class="operator">-</span>h都是TCP<span class="operator">/</span>IP连接</span><br><span class="line"><span class="number">2</span>）所有的远程连接都是TCP<span class="operator">/</span>IP连接</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>socket连接</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123 <span class="operator">-</span>S <span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>pl23</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123 <span class="operator">-</span>hlocalhost</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>MySQL默认连接方式是socket连接</span><br><span class="line"><span class="number">2.</span>socket连接速度快，因为不需要建立三次握手</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">MySQL-day02-03MySQL实例讲解</span><br><span class="line">什么是实例？</span><br><span class="line">1.MySQL的后台进程+线程+预分配的内存结构。</span><br><span class="line">2.MySQL在启动的过程中会启动后台守护进程，并生成工作线程，预分配内存结构供MySQL处理数据使用。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">关闭Mysql反向解析</span><br><span class="line">[root@master ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">skip_name_resolve</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">连接层</span><br><span class="line">1.验证用户的合法性（ip，端口，用户名，密码）</span><br><span class="line">2.提供两种连接方式（socket,TCP/IP）</span><br><span class="line">3.提供一个与SQL层交互的专用线程</span><br><span class="line"></span><br><span class="line">SQL层</span><br><span class="line">1.接收连接层传来的SQL语句。</span><br><span class="line">2.检查语法。</span><br><span class="line">3.检查语义。（DDL,DML）DQL,DCL</span><br><span class="line">检查,show select grant</span><br><span class="line">4.解析器，解析SQL语句，生成多种执行计划。</span><br><span class="line">5.优化器，根据多种执行计划，选择最优方式。</span><br><span class="line">6.执行器，执行优化器传来的最优方式SQL。</span><br><span class="line">  6.1提供跟存储引擎层交互的线程。</span><br><span class="line">  6.2接收返回数据，优化成表的形式返回SQL。</span><br><span class="line">7.将数据存入缓存</span><br><span class="line">8.记录日志，binlog</span><br><span class="line"></span><br><span class="line">存储引擎层</span><br><span class="line">1.接收SQL传来的SQL语句</span><br><span class="line">2.去磁盘找到要找的数据</span><br><span class="line">3.提供一个与SQL层交互的线程，返回SQL层，结构化成表的形式。</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">修改配置文件，免密码登录数据库</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[client]</span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>root</span><br><span class="line">password<span class="operator">=</span><span class="number">123</span></span><br><span class="line"></span><br><span class="line">#删除↓</span><br><span class="line">sql_mode<span class="operator">=</span>NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">user</span> bgx;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">user</span>,host <span class="keyword">from</span> mysql.user;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> grants <span class="keyword">for</span> bgx@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">user</span> bgx@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">user</span> bgx identified <span class="keyword">by</span> <span class="string">&#x27;sb250&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> grants <span class="keyword">for</span> bgx@<span class="string">&#x27;%&#x27;</span>；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">查看mysql用户</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">user</span>,host <span class="keyword">from</span> mysql.user;</span><br><span class="line">查看所在表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> database();</span><br><span class="line">删除bgx用户</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span>  mysql.user <span class="keyword">where</span> host<span class="operator">=</span><span class="string">&#x27;%&#x27;</span> <span class="keyword">and</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27;bgx&#x27;</span>;</span><br><span class="line"></span><br><span class="line">修改oldboy的host为<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> mysql.user <span class="keyword">set</span> host<span class="operator">=</span><span class="string">&#x27;127.0.0.1&#x27;</span> <span class="keyword">where</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27;oldboy&#x27;</span>;</span><br><span class="line">修改root密码为<span class="number">1</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> mysql.user <span class="keyword">set</span> password<span class="operator">=</span>PASSWORD(<span class="string">&#x27;1&#x27;</span>) <span class="keyword">where</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27;root&#x27;</span> <span class="keyword">and</span> host<span class="operator">=</span><span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"><span class="keyword">update</span>更新密码需要执行刷新，后退出重新登录</span><br><span class="line">mysql<span class="operator">&gt;</span> flush privileges;</span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">MySQL<span class="operator">-</span>day03<span class="number">-03</span>用户权限管理<span class="operator">-</span>用户定义</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> oldboyl@<span class="string">&#x27;10.0.0.0/255.255.255.0&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"></span><br><span class="line">MySQL修改密码</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mysqladmin <span class="operator">-</span>uroot <span class="operator">-</span>p1 password <span class="string">&#x27;123&#x27;</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> mysql.user <span class="keyword">set</span> password<span class="operator">=</span>PASSWORD(<span class="string">&#x27;456&#x27;</span>) <span class="keyword">where</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27;root&#x27;</span> <span class="keyword">and</span> host<span class="operator">=</span><span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> flush privileges;  #<span class="keyword">update</span>修改需执行这条命令</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> password<span class="operator">=</span>PASSWORD(<span class="string">&#x27;789&#x27;</span>);  #修改当前登录用户的密码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> root@<span class="string">&#x27;localhost&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>查看用户权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from mysql.user\G</span><br></pre></td></tr></table></figure>



<p>2.用户管理及权限管理_</p>
<p>1）创建用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create user oldboy@&#x27;10.0.0.%&#x27; identified by &#x27;123&#x27;;</span><br></pre></td></tr></table></figure>

<p>2）查看用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  select user,host from mysql.user;</span><br></pre></td></tr></table></figure>

<p>3）删除用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  drop user oldboy@‘10.0.0.%’；</span><br></pre></td></tr></table></figure>

<p>4）修改密码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set password</span><br><span class="line">mysql&gt; update user set password=PASSWORD(&#x27;oldboy123&#x27;) where user=&#x27;root&#x27; and host=&#x27;localhost&#x27;;</span><br><span class="line">mysql&gt; grant all privileges on *.* to oldboy@’10.0.0.%’ identified by ‘123’;</span><br></pre></td></tr></table></figure>





<p>归属<br>每次设定只能有一个属主，没有属组或其他用户的概念</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span>     <span class="keyword">all</span> privileges    <span class="keyword">on</span>     <span class="operator">*</span>.<span class="operator">*</span>    <span class="keyword">to</span>   oldboy@’<span class="number">10.0</span><span class="number">.0</span>.<span class="operator">%</span>’  identified <span class="keyword">by</span>    ‘<span class="number">123</span>’;</span><br><span class="line">                权限               作用对象          归属               密码</span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">*</span>.<span class="operator">*</span>    全部权限</span><br><span class="line">mysql.<span class="operator">*</span>    单库级别</span><br><span class="line">mysql.user    单表级别</span><br><span class="line">脱敏：脱离敏感信息</span><br><span class="line">单列级别：mysql.user.host</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> <span class="keyword">select</span>(<span class="keyword">user</span>) <span class="keyword">on</span> mysql.user <span class="keyword">to</span> dev@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span>;  #dev权限只能查询<span class="keyword">user</span>，权限最小化到列级别</span><br><span class="line"></span><br><span class="line">了解开用户的需求：</span><br><span class="line"><span class="number">1.</span>权限的需求, <span class="keyword">select</span>, <span class="keyword">insert</span>, <span class="keyword">update</span>, <span class="keyword">delete</span></span><br><span class="line"><span class="number">2.</span>要知道哪个库，哪张表</span><br><span class="line"><span class="number">3.</span>对用户有什么要求，主机域</span><br><span class="line"><span class="number">4.</span>对密码有什么要求。</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>发邮件，写清楚需求，发送给我，抄送各个部门老大</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">select</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> wordpress@<span class="string">&#x27;10.0.0.5%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line">给wordpress@<span class="string">&#x27;10.0.0.5%&#x27;</span>用户授权查询所有库所有表的权限，密码是<span class="number">123</span></span><br><span class="line"><span class="number">10.0</span><span class="number">.0</span><span class="number">.50</span><span class="number">-59</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">insert</span>,<span class="keyword">delete</span>,<span class="keyword">update</span> <span class="keyword">on</span> wordpress.<span class="operator">*</span> <span class="keyword">to</span> wordpress@<span class="string">&#x27;10.0.0.5%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line">给wordpress@<span class="string">&#x27;10.0.0.5。&#x27;</span>用户授权对wordpress库下的所有表有增，删，改权限，密码是<span class="number">123</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> wordpress.t1 <span class="keyword">to</span> wordpress@<span class="string">&#x27;10.0.0.5%&#x27;</span>identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line">给wordpressa<span class="string">&#x27;10.0.0.5%&#x27;</span>用户授权对wordpress库下的t1表所有权限，密码是<span class="number">123</span></span><br><span class="line"></span><br><span class="line">问：</span><br><span class="line">一个客户端程序使用wordpress用户登陆到<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>的MySQL后，</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>、对t1表的管理能力？    所有权限    <span class="number">1</span><span class="operator">+</span><span class="number">2</span><span class="operator">+</span><span class="number">3</span></span><br><span class="line"><span class="number">2</span>、对t2表的管理能力？    <span class="number">1.</span>所有权限    X</span><br><span class="line">                      <span class="number">2.</span><span class="keyword">insert</span>, <span class="keyword">delete</span>, <span class="keyword">update</span>    X</span><br><span class="line">                      <span class="number">3.</span><span class="keyword">insert</span>, <span class="keyword">delete</span>, <span class="keyword">update</span>, <span class="keyword">select</span>    <span class="number">1</span><span class="operator">+</span><span class="number">2</span></span><br><span class="line">结论：</span><br><span class="line"><span class="number">1</span>、如果在不同级别都包含某个表的管理能力时，权限是相加关系。</span><br><span class="line"><span class="number">2</span>、但是我们不推荐在多级别定义重复权限。</span><br><span class="line"><span class="number">3</span>、最常用的权限设定方式是单库级别授权，即：wordpress.<span class="operator">*</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">MySQL<span class="operator">-</span>day03<span class="number">-07</span>MySQL的连接管理</span><br><span class="line"></span><br><span class="line">mysql</span><br><span class="line"></span><br><span class="line"><span class="operator">-</span>u    指定用户</span><br><span class="line"><span class="operator">-</span>p    指定密码</span><br><span class="line"><span class="operator">-</span>h    指定主机域</span><br><span class="line"><span class="operator">-</span>S    指定socket文件</span><br><span class="line"><span class="operator">-</span>P    指定端口</span><br><span class="line"><span class="operator">-</span>е    指定<span class="keyword">SQL</span>语句</span><br><span class="line"><span class="comment">--protocol=name  指定连接方式 TCP/IP  socket （没啥用，不好使）</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">命令行执行mysql语句</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123 <span class="operator">-</span>e &quot;show grants for root@&#x27;localhost&#x27;&quot;</span><br><span class="line"></span><br><span class="line">新建root用户</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> root@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>




<h1 id="MySQL-day03-10MySQL多实例部署及小技巧讲解"><a href="#MySQL-day03-10MySQL多实例部署及小技巧讲解" class="headerlink" title="MySQL-day03-10MySQL多实例部署及小技巧讲解"></a>MySQL-day03-10MySQL多实例部署及小技巧讲解</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">什么是多实例？</span><br><span class="line"></span><br><span class="line">（进程+多个线程+预分配内存结构）*多个</span><br><span class="line"></span><br><span class="line">多个端口</span><br><span class="line">多套配置文件</span><br><span class="line">多个socket文件</span><br><span class="line">datadir（多套数据目录）</span><br><span class="line"></span><br><span class="line">多套配置文件：端口，多个data目录，多个socket文件</span><br><span class="line"></span><br><span class="line">[root@master ~]# mkdir /data</span><br><span class="line">[root@master ~]# mkdir /data/&#123;3307,3308,3309&#125;</span><br><span class="line"></span><br><span class="line">[root@master ~]# vim /data/3307/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/application/mysql/</span><br><span class="line">datadir=/data/3307/data</span><br><span class="line">socket=/data/3307/data/mysql.sock</span><br><span class="line">port=3307</span><br><span class="line">log_error=/data/3307/mysql.err</span><br><span class="line">log-bin=/data/3307/mysql-bin</span><br><span class="line">server_id=7</span><br><span class="line"></span><br><span class="line">[root@master ~]# cp /data/3307/my.cnf /data/3308</span><br><span class="line">[root@master ~]# vim /data/3308/my.cnf</span><br><span class="line">:%s#7#8#g    #7替换8</span><br><span class="line"></span><br><span class="line">[root@master ~]# cp /data/3307/my.cnf /data/3309</span><br><span class="line">[root@master ~]# vim /data/3309/my.cnf</span><br><span class="line">:%s#7#9#g    #7替换9</span><br><span class="line"></span><br><span class="line">安装tree命令</span><br><span class="line">[root@master ~]# yum -y install tree</span><br><span class="line"></span><br><span class="line">查看目录结构</span><br><span class="line">[root@master ~]# tree /data/</span><br><span class="line">/data/</span><br><span class="line">├── 3307</span><br><span class="line">│   └── my.cnf</span><br><span class="line">├── 3308</span><br><span class="line">│   └── my.cnf</span><br><span class="line">└── 3309</span><br><span class="line">    └── my.cnf</span><br><span class="line"></span><br><span class="line">查看3套配置文件，多套配置文件：端口，多个data目录</span><br><span class="line">[root@master ~]# cat /data/330*/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/application/mysql/</span><br><span class="line">datadir=/data/3307/data</span><br><span class="line">socket=/data/3307/data/mysql.sock</span><br><span class="line">port=3307</span><br><span class="line">log_error=/data/3307/mysql.err</span><br><span class="line">log-bin=/data/3307/mysql-bin</span><br><span class="line">server_id=7</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/application/mysql/</span><br><span class="line">datadir=/data/3308/data</span><br><span class="line">socket=/data/3308/data/mysql.sock</span><br><span class="line">port=3308</span><br><span class="line">log_error=/data/3308/mysql.err</span><br><span class="line">log-bin=/data/3308/mysql-bin</span><br><span class="line">server_id=8</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/application/mysql/</span><br><span class="line">datadir=/data/3309/data</span><br><span class="line">socket=/data/3309/data/mysql.sock</span><br><span class="line">port=3309</span><br><span class="line">log_error=/data/3309/mysql.err</span><br><span class="line">log-bin=/data/3309/mysql-bin</span><br><span class="line">server_id=9</span><br><span class="line"></span><br><span class="line">准备多套数据目录：</span><br><span class="line">[root@db01 ~]# cd /application/mysql/scripts/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">授权</span></span><br><span class="line">[root@db01 scripts]# chown -R mysql.mysql /data/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">初始化</span></span><br><span class="line">[root@db01 scripts]# ./mysql_install_db --user=mysql --defaults-file=/data/3307/my.cnf --basedir=/application/mysql --datadir=/data/3307/data</span><br><span class="line">[root@db01 scripts]# ./mysql_install_db --user=mysql --defaults-file=/data/3308/my.cnf --basedir=/application/mysql --datadir=/data/3308/data</span><br><span class="line">[root@db01 scripts]# ./mysql_install_db --user=mysql --defaults-file=/data/3309/my.cnf --basedir=/application/mysql --datadir=/data/3309/data</span><br><span class="line">[root@db01 scripts]# tree -L 2 /data</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动</span></span><br><span class="line">[root@db01 scripts]# mysqld_safe --defaults-file=/data/3307/my.cnf &amp;</span><br><span class="line">[root@db01 scripts]# mysqld_safe --defaults-file=/data/3308/my.cnf &amp;</span><br><span class="line">[root@db01 scripts]# mysqld_safe --defaults-file=/data/3309/my.cnf &amp;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看端口是否启动</span></span><br><span class="line">[root@master scripts]# netstat -lntup|grep mysqld</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置密码</span></span><br><span class="line">[root@db01 scripts]# mysqladmin -uroot -p -S /data/3307/data/mysql.sock password &#x27;3307&#x27;</span><br><span class="line">[root@db01 scripts]# mysqladmin -uroot -p -S /data/3308/data/mysql.sock password &#x27;3308&#x27;</span><br><span class="line">[root@db01 scripts]# mysqladmin -uroot -p -S /data/3309/data/mysql.sock password &#x27;3309&#x27;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">连接</span></span><br><span class="line">[root@db01 scripts]# mysql -uroot -p3307 -S /data/3307/data/mysql.sock</span><br><span class="line">[root@db01 scripts]# mysql -uroot -p3308 -S /data/3308/data/mysql.sock</span><br><span class="line">[root@db01 scripts]# mysql -uroot -p3309 -S /data/3309/data/mysql.sock</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看server_id</span></span><br><span class="line">[root@db01 scripts]# mysql -uroot -p3307 -S /data/3307/data/mysql.sock -e &quot;show variables like &#x27;server_id&#x27;&quot;</span><br><span class="line">[root@db01 scripts]# mysql -uroot -p3308 -S /data/3308/data/mysql.sock -e &quot;show variables like &#x27;server_id&#x27;&quot;</span><br><span class="line">[root@db01 scripts]# mysql -uroot -p3309 -S /data/3309/data/mysql.sock -e &quot;show variables like &#x27;server_id&#x27;&quot;</span><br><span class="line"></span><br><span class="line">[root@db01 scripts]# vim /usr/local/bin/mysql3307</span><br><span class="line">mysql -uroot -p3307 -S /data/3307/data/mysql.sock</span><br><span class="line">[root@db01 scripts]# chmod 700 /usr/local/bin/mysql3307</span><br><span class="line">[root@db01 scripts]# mysql3307    #登录</span><br><span class="line">[root@db01 scripts]# mysqladmin -uroot -p3307 -S /data/3307/data/mysql.sock shutdown    #关闭多实例</span><br><span class="line">[root@db01 scripts]# vim /usr/local/bin/close3307</span><br><span class="line">mysqladmin -uroot -p3307 -S /data/3307/data/mysql.sock shutdown</span><br><span class="line">[root@db01 scripts]# chmod 700 /usr/local/bin/close3307</span><br><span class="line">[root@db01 scripts]# close3307</span><br></pre></td></tr></table></figure>



<h1 id="MySQL-day04-01上周课程回顾"><a href="#MySQL-day04-01上周课程回顾" class="headerlink" title="MySQL-day04-01上周课程回顾"></a>MySQL-day04-01上周课程回顾</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>什么是数据库管理系统：</span><br><span class="line"></span><br><span class="line">DBMS</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>）管理数据</span><br><span class="line"><span class="number">2</span>）存储数据</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>数据库管理系统的类型：</span><br><span class="line"></span><br><span class="line">RDBMS（关系型数据库）：</span><br><span class="line">MySQL, Oracle, Mariadb, MSSQL</span><br><span class="line"></span><br><span class="line">NoSQL（非关系型数据库）：</span><br><span class="line">Redis, MongoDB, Memcache, Elasticsearch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>关系型数据库非关系型数据库功能性能对比：</span><br><span class="line"></span><br><span class="line">RDBMS：强大的查询功能，二级索引，数据的强一致性</span><br><span class="line"></span><br><span class="line">NoSQL：灵活性，可扩展，性能，支持分布式</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>特点对比</span><br><span class="line">NoSQL：不适用<span class="keyword">SQL</span>语句，想做老大，先做好老二，并不想取代关系型数据库，是关系型数据库的补充。</span><br><span class="line"></span><br><span class="line">RDBMS：二维表，支持<span class="keyword">SQL</span>语句，安全</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>MySQL版本选型潜规则</span><br><span class="line"></span><br><span class="line">MySQL5<span class="number">.6</span>: GA <span class="number">6</span><span class="number">-12</span>个月 小版本是偶数版本</span><br><span class="line"></span><br><span class="line">MySQL5<span class="number">.7</span>: GA <span class="number">6</span><span class="number">-12</span>个月 小版本是偶数版本  <span class="number">5.7</span><span class="number">.17</span>版本以上（MGR：自带的高可用功能）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">6.</span>MySQL的安装方式：</span><br><span class="line"></span><br><span class="line">yum, rpm</span><br><span class="line"></span><br><span class="line">编译安装（源码安装）</span><br><span class="line">    <span class="number">1</span>）解压</span><br><span class="line">    <span class="number">2</span>）生成</span><br><span class="line">    <span class="number">3</span>）编译</span><br><span class="line">    <span class="number">4</span>）安装</span><br><span class="line"></span><br><span class="line">二进制安装</span><br><span class="line">    <span class="number">1</span>）安装依赖</span><br><span class="line">    yum install autoconf gcc gcc<span class="operator">-</span>c<span class="operator">+</span><span class="operator">+</span> glbc</span><br><span class="line">    <span class="number">2</span>）解压</span><br><span class="line">    <span class="number">3</span>）移动到指定目录</span><br><span class="line">    mv xx <span class="operator">/</span>application</span><br><span class="line">    <span class="number">4</span>）软链接</span><br><span class="line">    <span class="number">5</span>）启动脚本，配置文件</span><br><span class="line">    <span class="number">6</span>）创建mysql用户</span><br><span class="line">    <span class="number">7</span>）初始化</span><br><span class="line">    <span class="number">8</span>）修改启动脚本及mysqld_safe</span><br><span class="line">    <span class="number">9</span>）启动</span><br><span class="line">    <span class="number">10</span>）添加环境变量</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">先定制rpm包，制作yum仓库</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">7.</span>MySQL服务器模型</span><br><span class="line"></span><br><span class="line">C<span class="operator">/</span>S结构</span><br><span class="line"></span><br><span class="line">客户端工具：mysql mysqladmin mysqldump</span><br><span class="line"></span><br><span class="line"><span class="number">8.</span>连接方式</span><br><span class="line"></span><br><span class="line">TCP<span class="operator">/</span>IP:</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123 <span class="operator">-</span>h127<span class="number">.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line">socket:</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123（默认：速度快，不需要建立三次握手）</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123 <span class="operator">-</span>S</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123 <span class="operator">-</span>hlocalhost</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">9.</span>什么是实例？</span><br><span class="line"></span><br><span class="line">一个进程<span class="operator">+</span>多个线程<span class="operator">+</span>预分配的内存结构</span><br><span class="line"></span><br><span class="line"><span class="number">10.</span>mysqld程序结构</span><br><span class="line"></span><br><span class="line">连接层：</span><br><span class="line"></span><br><span class="line">    <span class="number">1</span>）验证用户的合法性</span><br><span class="line">    <span class="number">2</span>）提供两种连接方式</span><br><span class="line">    <span class="number">3</span>）提供一个与<span class="keyword">SQL</span>层交互的专用线程</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span>层：</span><br><span class="line">    <span class="number">1</span>）接受连接层传来的<span class="keyword">SQL</span>语句</span><br><span class="line">    <span class="number">2</span>）检查语法</span><br><span class="line">    <span class="number">3</span>）检查语义</span><br><span class="line">    <span class="number">4</span>）解析器</span><br><span class="line">    <span class="number">5</span>）优化器</span><br><span class="line">    <span class="number">6</span>）执行器</span><br><span class="line">    <span class="number">7</span>）缓存</span><br><span class="line">    <span class="number">8</span>）记录日志binlog</span><br><span class="line"></span><br><span class="line">存储引擎层：</span><br><span class="line">    <span class="number">1</span>）接收<span class="keyword">SQL</span>层传来的<span class="keyword">SQL</span>语句</span><br><span class="line">    <span class="number">2</span>）与磁盘交互查找数据文件，结构化成表的形式，返回给<span class="keyword">SQL</span>层</span><br><span class="line">    <span class="number">3</span>）提供一个与<span class="keyword">SQL</span>层交互的线程</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">11.</span>MySQL的逻辑结构</span><br><span class="line">    库<span class="operator">+</span>表</span><br><span class="line">    表：元数据<span class="operator">+</span>真实数据行</span><br><span class="line">    元数据：列<span class="operator">+</span>其他属性</span><br><span class="line">    列：列名<span class="operator">+</span>约束</span><br><span class="line"></span><br><span class="line"><span class="number">12.</span>MySQL的物理结构</span><br><span class="line">    最底层的数据文件</span><br><span class="line"></span><br><span class="line"><span class="number">13.</span>段，区，页</span><br><span class="line">    段：一个表就是一个段，由多个区构成</span><br><span class="line">    区：由多个页构成</span><br><span class="line">    页：最小单位，<span class="number">16</span>K</span><br><span class="line">    分区表：一个区构成一个段，就是一个分区表</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">14.</span>MySQL中用户是如何定义的？</span><br><span class="line"></span><br><span class="line">用户名@主机域</span><br><span class="line"></span><br><span class="line">主机域：</span><br><span class="line"><span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span></span><br><span class="line"><span class="number">10.0</span><span class="number">.0</span>.<span class="operator">%</span></span><br><span class="line"><span class="number">10.0</span>.<span class="operator">%</span>.<span class="operator">%</span></span><br><span class="line"><span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="operator">/</span><span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span></span><br><span class="line"><span class="number">10.0</span><span class="number">.0</span><span class="number">.5</span><span class="operator">%</span></span><br><span class="line"><span class="operator">%</span></span><br><span class="line">db01</span><br><span class="line">localhost</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">15.</span>MySQL修改密码</span><br><span class="line">  <span class="keyword">update</span></span><br><span class="line">  <span class="keyword">set</span></span><br><span class="line">  mysqladmin</span><br><span class="line">  <span class="keyword">grant</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">16.</span>脱敏，单列级别的授权</span><br><span class="line">  <span class="keyword">grant</span> <span class="keyword">select</span>(<span class="keyword">user</span>) <span class="keyword">on</span> mysql.user <span class="keyword">to</span> dev@<span class="string">&#x27;10.0.0.5%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">17.</span>发邮件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">18.</span>配置文件读取顺序：</span><br><span class="line">    <span class="number">1</span>) <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">    <span class="number">2</span>) <span class="operator">/</span>etc<span class="operator">/</span>mysql<span class="operator">/</span>my.cnf</span><br><span class="line">    <span class="number">3</span>) $basedir<span class="operator">/</span>my.cnf</span><br><span class="line">    <span class="number">4</span>) defaults<span class="operator">-</span>extra<span class="operator">-</span>file</span><br><span class="line">    <span class="number">5</span>) <span class="operator">~</span><span class="operator">/</span>.my.cnf</span><br><span class="line">    优先级: <span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">19.</span>优先级结论</span><br><span class="line">    <span class="number">1.</span>命令行</span><br><span class="line">    <span class="number">2.</span>defaults<span class="operator">-</span>file</span><br><span class="line">    <span class="number">3.</span>配置文件</span><br><span class="line">        <span class="operator">~</span><span class="operator">/</span>.my.cnf</span><br><span class="line">        defaults<span class="operator">-</span>extra<span class="operator">-</span>file</span><br><span class="line">        $basedir<span class="operator">/</span>my.cnf</span><br><span class="line">        <span class="operator">/</span>etc<span class="operator">/</span>mysql<span class="operator">/</span>my.cnf</span><br><span class="line">        <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">    <span class="number">4.</span>cmake编译参数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">20.</span>配置文件的作用</span><br><span class="line">   <span class="number">1</span>）影响服务端的启动</span><br><span class="line">   <span class="number">2</span>）影响客户端的连接</span><br><span class="line">   </span><br><span class="line"><span class="number">21.</span>多实例</span><br><span class="line">多个进程<span class="operator">+</span>多个线程<span class="operator">+</span>多个预分配内存结构</span><br><span class="line">   多个配置文件：</span><br><span class="line">   <span class="number">1</span>）多端口</span><br><span class="line">   <span class="number">2</span>）多个数据目录</span><br><span class="line">   <span class="number">3</span>）多个socket文件</span><br><span class="line">   <span class="number">4</span>）多个日志文件</span><br><span class="line">   <span class="number">5</span>）多个server_id</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>下载world.sql文件<br><code>ttps://dev.mysql.com/doc/index-other.html</code></p>
<p>MySQL-day04-03MySQL客户端命令mysqladmin讲解</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">mysql客户端命令：</span><br><span class="line"></span><br><span class="line">\h 或 help 或？    查看帮助</span><br><span class="line">\G    格式化查看数据（key：<span class="keyword">value</span>）</span><br><span class="line">\T 或 tee    记录日志</span><br><span class="line">\c（<span class="number">5.7</span>可以ctrl<span class="operator">+</span>c）    结束命令</span><br><span class="line">\s 或 status    查看状态信息</span><br><span class="line">\. 或 source    导入<span class="keyword">SQL</span>数据</span><br><span class="line">\u或 use    使用数据库</span><br><span class="line">\q 或 exit 或 quit    退出</span><br><span class="line"></span><br><span class="line">记录日志</span><br><span class="line">mysql<span class="operator">&gt;</span> tee <span class="operator">/</span>tmp<span class="operator">/</span>b.log</span><br><span class="line"></span><br><span class="line">mysqladmin客户端命令：</span><br><span class="line">#查看MySQL存活状态</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mysqladmin <span class="operator">-</span>uroot <span class="operator">-</span>p123 ping</span><br><span class="line">#查看MySQL状态信息</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mysqladmin <span class="operator">-</span>uroot <span class="operator">-</span>p123 status</span><br><span class="line">#关闭MySQL进程</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mysqladmin <span class="operator">-</span>uroot <span class="operator">-</span>p123 shutdown</span><br><span class="line">#查看NySQL参数</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mysqladmin <span class="operator">-</span>uroot <span class="operator">-</span>p123 variables</span><br><span class="line">#删除数据库</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mysqladmin <span class="operator">-</span>uroot <span class="operator">-</span>p123 <span class="keyword">drop</span> DATABASE</span><br><span class="line">#创建数据库</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mysqladmin <span class="operator">-</span>uroot <span class="operator">-</span>p123 <span class="keyword">create</span> DATABASE</span><br><span class="line">#重载授权表</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mysqladmin <span class="operator">-</span>uroot <span class="operator">-</span>p123 reload</span><br><span class="line">#刷新日志</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mysqladmin <span class="operator">-</span>uroot <span class="operator">-</span>p123 flush<span class="operator">-</span>log</span><br><span class="line">#刷新缓存主机</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mysqladmin <span class="operator">-</span>uroot <span class="operator">-</span>p123 reload</span><br><span class="line">#修改口令</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mysqladmin <span class="operator">-</span>uroot <span class="operator">-</span>p123 password</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<hr>
<h1 id="老男孩教育上海linux脱产3期MySQL-day04-04SQL语句DDL-库操作讲解"><a href="#老男孩教育上海linux脱产3期MySQL-day04-04SQL语句DDL-库操作讲解" class="headerlink" title="老男孩教育上海linux脱产3期MySQL-day04-04SQL语句DDL-库操作讲解"></a>老男孩教育上海linux脱产3期MySQL-day04-04SQL语句DDL-库操作讲解</h1><ul>
<li>1.什么是SQL</li>
</ul>
<p>结构化的查询语句</p>
<ul>
<li>2.SQL的种类</li>
</ul>
<p><strong><em>DDL：数据定义语言</em></strong></p>
<p><strong>库对象：库名字、库属性</strong><br>开发规范：库名小写</p>
<p><em>创建库：create database|schema</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#创建oldboy数据库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database oldboy;</span><br><span class="line">#创建OLDBOY数据库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database OLDBOY;</span><br><span class="line">#查看数据库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line">#查看oldboy的创建语句（DQL）</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> database oldboy;</span><br><span class="line">#查看创建数据库语句帮助</span><br><span class="line">mysql<span class="operator">&gt;</span> help <span class="keyword">create</span> database</span><br><span class="line">#创建oldboy数据库添加属性</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database testa charset utf8;</span><br></pre></td></tr></table></figure>

<p><em>删库：drop database</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#删除oldboy数据库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database oldboy;</span><br></pre></td></tr></table></figure>

<p><em>修改定义库：alter database</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#修改oldboy数据库属性</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> database oldboy charset gbk;</span><br><span class="line">#查看oldboy的创建语句（DQL）</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> database oldboy;</span><br></pre></td></tr></table></figure>



<p>老男孩教育上海linux脱产3期MySQL-day04-05SQL语句DDL-表操作讲解</p>
<p><strong><em>DDL：数据定义语言</em></strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">创建test库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database test;</span><br><span class="line">查看数据库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> database;</span><br><span class="line">进入test库</span><br><span class="line">mysql<span class="operator">&gt;</span> use test</span><br><span class="line">查看当前所在库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> database();</span><br><span class="line">创建表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> student(id <span class="type">int</span>);</span><br><span class="line">查看表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line">查看表结构</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> student;</span><br><span class="line">删除表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">table</span> student;</span><br><span class="line"><span class="comment">--------------------------------</span></span><br><span class="line">创建student表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> student(id <span class="type">int</span>,name <span class="type">varchar</span>(<span class="number">10</span>),age tinyint);</span><br><span class="line">查看student表字段</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> student;</span><br><span class="line">创建student1表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> student1(id <span class="type">int</span>,name <span class="type">varchar</span>(<span class="number">10</span>),age tinyint,sex enum(<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;bgx&#x27;</span>));</span><br><span class="line">创建student2表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> student2(id <span class="type">int</span>,name <span class="type">varchar</span>(<span class="number">10</span>),age tinyint,sex enum(<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;bgx&#x27;</span>),<span class="type">date</span> datetime);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> student2;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+---------------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> Field <span class="operator">|</span> Type                <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+---------------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> id    <span class="operator">|</span> <span class="type">int</span>(<span class="number">11</span>)             <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">10</span>)         <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> age   <span class="operator">|</span> tinyint(<span class="number">4</span>)          <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sex   <span class="operator">|</span> enum(<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;bgx&#x27;</span>) <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="type">date</span>  <span class="operator">|</span> datetime            <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+---------------------+------+-----+---------+-------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> student2(id,name,age,sex,<span class="type">date</span>) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;bgx&#x27;</span>,<span class="number">-128</span>,<span class="string">&#x27;bgx&#x27;</span>,NOW());</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student2;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+------+------+---------------------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> name <span class="operator">|</span> age  <span class="operator">|</span> sex  <span class="operator">|</span> <span class="type">date</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+------+------+---------------------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> bgx  <span class="operator">|</span> <span class="number">-128</span> <span class="operator">|</span> bgx  <span class="operator">|</span> <span class="number">2022</span><span class="number">-06</span><span class="number">-22</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">15</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+------+------+---------------------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> student3(</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> id <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> name <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> age tinyint unsigned,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> sex enum(<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;bgx&#x27;</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="string">&#x27;bgx&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="type">date</span> datetime <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> NOW());</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> student3;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+---------------------+------+-----+-------------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> Field <span class="operator">|</span> Type                <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span>           <span class="operator">|</span> Extra          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+---------------------+------+-----+-------------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> id    <span class="operator">|</span> <span class="type">int</span>(<span class="number">11</span>)             <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>              <span class="operator">|</span> auto_increment <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">10</span>)         <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>              <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> age   <span class="operator">|</span> tinyint(<span class="number">3</span>) unsigned <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>              <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sex   <span class="operator">|</span> enum(<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;bgx&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> bgx               <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="type">date</span>  <span class="operator">|</span> datetime            <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+---------------------+------+-----+-------------------+----------------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> student3(id,name,age) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;bgx&#x27;</span>,<span class="number">250</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student3;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+-----+---------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span> age  <span class="operator">|</span> sex <span class="operator">|</span> <span class="type">date</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+-----+---------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> bgx  <span class="operator">|</span>  <span class="number">250</span> <span class="operator">|</span> bgx <span class="operator">|</span> <span class="number">2022</span><span class="number">-06</span><span class="number">-22</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">33</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+-----+---------------------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> student2(id,name,age) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;bgx&#x27;</span>,<span class="number">1</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student2;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+------+------+---------------------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> name <span class="operator">|</span> age  <span class="operator">|</span> sex  <span class="operator">|</span> <span class="type">date</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+------+------+---------------------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> bgx  <span class="operator">|</span> <span class="number">-128</span> <span class="operator">|</span> bgx  <span class="operator">|</span> <span class="number">2022</span><span class="number">-06</span><span class="number">-22</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">15</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> bgx  <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+------+------+---------------------+</span></span><br><span class="line"></span><br><span class="line">查看建表语句</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> student3;</span><br><span class="line"></span><br><span class="line">创建student4表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> student4(</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> id <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">primary</span> key auto_increment comment <span class="string">&#x27;学号&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> name <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> age tinyint unsigned comment <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> sex enum(<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;bgx&#x27;</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="string">&#x27;bgx&#x27;</span> comment <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="type">date</span> datetime <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> NOW() comment <span class="string">&#x27;入学时间&#x27;</span>);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> student4;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+---------------------+------+-----+-------------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> Field <span class="operator">|</span> Type                <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span>           <span class="operator">|</span> Extra          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+---------------------+------+-----+-------------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> id    <span class="operator">|</span> <span class="type">int</span>(<span class="number">11</span>)             <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>              <span class="operator">|</span> auto_increment <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">10</span>)         <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>              <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> age   <span class="operator">|</span> tinyint(<span class="number">3</span>) unsigned <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>              <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sex   <span class="operator">|</span> enum(<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;bgx&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> bgx               <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="type">date</span>  <span class="operator">|</span> datetime            <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+---------------------+------+-----+-------------------+----------------+</span></span><br><span class="line"></span><br><span class="line">查看student4建表语句</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> student4;</span><br><span class="line"></span><br><span class="line">创建student5表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `student5` (</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;学号&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `name` <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `age` tinyint(<span class="number">3</span>) unsigned <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `sex` enum(<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;bgx&#x27;</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;bgx&#x27;</span> COMMENT <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `<span class="type">date</span>` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;入学时间&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> ) ENGINE<span class="operator">=</span>myisam <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>gbk;</span><br><span class="line"></span><br><span class="line">查看student5建表语句</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> student5;</span><br><span class="line"></span><br><span class="line">student4表添加一列</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student4 <span class="keyword">add</span> weight <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.03</span> sec)</span><br><span class="line">Records: <span class="number">0</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> student4;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+---------------------+------+-----+-------------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> Field  <span class="operator">|</span> Type                <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span>           <span class="operator">|</span> Extra          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+---------------------+------+-----+-------------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> id     <span class="operator">|</span> <span class="type">int</span>(<span class="number">11</span>)             <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>              <span class="operator">|</span> auto_increment <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> name   <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">10</span>)         <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>              <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> age    <span class="operator">|</span> tinyint(<span class="number">3</span>) unsigned <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>              <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sex    <span class="operator">|</span> enum(<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;bgx&#x27;</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> bgx               <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="type">date</span>   <span class="operator">|</span> datetime            <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> weight <span class="operator">|</span> <span class="type">int</span>(<span class="number">11</span>)             <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>              <span class="operator">|</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+---------------------+------+-----+-------------------+----------------+</span></span><br><span class="line"></span><br><span class="line">修改表名</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> stu rename stu1;</span><br><span class="line">查看表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#修改表名</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student rename stu;</span><br><span class="line">#添加列和列定义</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> stu <span class="keyword">add</span> age <span class="type">int</span>;</span><br><span class="line">#添加多个列</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> stu <span class="keyword">add</span> test <span class="type">varchar</span>(<span class="number">20</span>),<span class="keyword">add</span> qq <span class="type">int</span>;</span><br><span class="line">#指定位置进行添加列（表首）</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> stu <span class="keyword">add</span> classid <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">first</span>;</span><br><span class="line">#指定位置进行添加列（指定列）</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> stu <span class="keyword">add</span> phone <span class="type">int</span> after age;</span><br><span class="line">#删除指定的列及定义</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> stu <span class="keyword">drop</span> qq;</span><br><span class="line">#修改列及定义（列属性）</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> stu modify sid <span class="type">varchar</span>(<span class="number">20</span>);</span><br><span class="line">#修改列及定义（列名及属性）</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> stu change phone telphone <span class="type">char</span>(<span class="number">20</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>char  定长<br>varchar  变长<br>tinyint  -128~128  255<br>enum： 枚举类型<br>datetime： 时间类型 年月日时分秒<br>not nul:  非空<br>primary key:  主键  唯一+非空<br>unique key:  唯一键  唯一   unique key + not null &#x3D; primary key<br>auto_increment:  自增<br>unsigned:  非负<br>default:  默认值</p>
</blockquote>
<hr>
<p><strong><em>DCL：数据控制语言</em></strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#授权root<span class="variable">@10</span><span class="number">.0</span><span class="number">.0</span><span class="number">.51</span>用户所有权限（非炒鸡管理员）</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> root@<span class="string">&#x27;10.0.0.51&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;oldboy123&#x27;</span>;</span><br><span class="line">#怎么去授权一个炒鸡管理员呢？</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> root@<span class="string">&#x27;10.0.0.51&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;oldboy123&#x27;</span> <span class="keyword">with</span> <span class="keyword">grant</span> option;</span><br><span class="line">#其他参数（扩展）</span><br><span class="line">max_queries_per_hour：一个用户每小时可发出的查询数量</span><br><span class="line">max_updates_per_hour：一个用户每小时可发出的更新数量</span><br><span class="line">max_connections_per_hour：一个用户每小时可连接到服务器的次数</span><br><span class="line">max_user_connections：允许同时连接数量</span><br><span class="line"></span><br><span class="line">允许dev同时连接两个</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> dev@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span> <span class="keyword">with</span> max_user_connections <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">#收回<span class="keyword">select</span>权限</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">revoke</span> <span class="keyword">select</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">from</span> dev@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line">查看所有权限</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> grants <span class="keyword">for</span> dev@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">添加多行</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> student4(name,age,sex,weight) <span class="keyword">values</span>(<span class="string">&#x27;zls&#x27;</span>,<span class="number">18</span>,<span class="string">&#x27;m&#x27;</span>,<span class="number">100</span>),(<span class="string">&#x27;bgx&#x27;</span>,<span class="number">250</span>,<span class="string">&#x27;f&#x27;</span>,<span class="number">500</span>);</span><br><span class="line"></span><br><span class="line">更新指定条件行</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> student4 <span class="keyword">set</span> sex<span class="operator">=</span><span class="string">&#x27;bgx&#x27;</span> <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;zls&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span>使用规范必须加条件，<span class="number">1</span><span class="operator">=</span><span class="number">1</span>永久成立，类似while ture</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> student4 <span class="keyword">set</span> sex<span class="operator">=</span><span class="string">&#x27;f&#x27;</span> <span class="keyword">where</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">使用<span class="keyword">update</span>修改密码，需要执行flush privileges</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> mysql.user <span class="keyword">set</span> password<span class="operator">=</span>PASSWORD(<span class="string">&#x27;456&#x27;</span>) <span class="keyword">where</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27;root&#x27;</span> <span class="keyword">and</span> host<span class="operator">=</span><span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> flush privileges;</span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span>会一行一行删除数据，重新插入会接着删除前的顺序</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> test.student4;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test.student4;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> test.student4(name,age,sex,weight) <span class="keyword">values</span>(<span class="string">&#x27;zls&#x27;</span>,<span class="number">18</span>,<span class="string">&#x27;m&#x27;</span>,<span class="number">100</span>),(<span class="string">&#x27;bgx&#x27;</span>,<span class="number">250</span>,<span class="string">&#x27;f&#x27;</span>,<span class="number">500</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test.student4;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+-----+---------------------+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span> age  <span class="operator">|</span> sex <span class="operator">|</span> <span class="type">date</span>                <span class="operator">|</span> weight <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+-----+---------------------+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> zls  <span class="operator">|</span>   <span class="number">18</span> <span class="operator">|</span> m   <span class="operator">|</span> <span class="number">2022</span><span class="number">-06</span><span class="number">-22</span> <span class="number">21</span>:<span class="number">23</span>:<span class="number">54</span> <span class="operator">|</span>    <span class="number">100</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> bgx  <span class="operator">|</span>  <span class="number">250</span> <span class="operator">|</span> f   <span class="operator">|</span> <span class="number">2022</span><span class="number">-06</span><span class="number">-22</span> <span class="number">21</span>:<span class="number">23</span>:<span class="number">54</span> <span class="operator">|</span>    <span class="number">500</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+-----+---------------------+--------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">truncate</span>会清空表，清空属性记录，从头开始</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">truncate</span> test.student4;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test.student4;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> test.student4(name,age,sex,weight) <span class="keyword">values</span>(<span class="string">&#x27;zls&#x27;</span>,<span class="number">18</span>,<span class="string">&#x27;m&#x27;</span>,<span class="number">100</span>),(<span class="string">&#x27;bgx&#x27;</span>,<span class="number">250</span>,<span class="string">&#x27;f&#x27;</span>,<span class="number">500</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test.student4;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+-----+---------------------+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span> age  <span class="operator">|</span> sex <span class="operator">|</span> <span class="type">date</span>                <span class="operator">|</span> weight <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+-----+---------------------+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> zls  <span class="operator">|</span>   <span class="number">18</span> <span class="operator">|</span> m   <span class="operator">|</span> <span class="number">2022</span><span class="number">-06</span><span class="number">-22</span> <span class="number">21</span>:<span class="number">28</span>:<span class="number">25</span> <span class="operator">|</span>    <span class="number">100</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> bgx  <span class="operator">|</span>  <span class="number">250</span> <span class="operator">|</span> f   <span class="operator">|</span> <span class="number">2022</span><span class="number">-06</span><span class="number">-22</span> <span class="number">21</span>:<span class="number">28</span>:<span class="number">25</span> <span class="operator">|</span>    <span class="number">500</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+-----+---------------------+--------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span>属于DCL数据操作语言，只能删除数据，删表需要使用<span class="keyword">drop</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> test.student4 <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test.student4;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+-----+---------------------+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span> age  <span class="operator">|</span> sex <span class="operator">|</span> <span class="type">date</span>                <span class="operator">|</span> weight <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+-----+---------------------+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> bgx  <span class="operator">|</span>  <span class="number">250</span> <span class="operator">|</span> f   <span class="operator">|</span> <span class="number">2022</span><span class="number">-06</span><span class="number">-22</span> <span class="number">21</span>:<span class="number">28</span>:<span class="number">25</span> <span class="operator">|</span>    <span class="number">500</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+-----+---------------------+--------+</span></span><br></pre></td></tr></table></figure>

<p>老男孩教育上海linux脱产3期MySQL-day04-09企业中如何使用update代替delete做伪删除</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">实际生产环境中使用<span class="keyword">update</span>代替<span class="keyword">delete</span>，使用一个状态列表示删除，和发配合不显示状态为<span class="number">0</span>的数据，数据不显示即可代替删除</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> test.student4 <span class="keyword">add</span> state enum(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;0&#x27;</span>) <span class="keyword">default</span> <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test.student4;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+-----+---------------------+--------+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span> age  <span class="operator">|</span> sex <span class="operator">|</span> <span class="type">date</span>                <span class="operator">|</span> weight <span class="operator">|</span> state <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+-----+---------------------+--------+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> bgx  <span class="operator">|</span>  <span class="number">250</span> <span class="operator">|</span> f   <span class="operator">|</span> <span class="number">2022</span><span class="number">-06</span><span class="number">-22</span> <span class="number">21</span>:<span class="number">28</span>:<span class="number">25</span> <span class="operator">|</span>    <span class="number">500</span> <span class="operator">|</span> <span class="number">1</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+-----+---------------------+--------+-------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> test.student4 <span class="keyword">set</span> state<span class="operator">=</span><span class="string">&#x27;0&#x27;</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test.student4;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+-----+---------------------+--------+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name <span class="operator">|</span> age  <span class="operator">|</span> sex <span class="operator">|</span> <span class="type">date</span>                <span class="operator">|</span> weight <span class="operator">|</span> state <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+-----+---------------------+--------+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> bgx  <span class="operator">|</span>  <span class="number">250</span> <span class="operator">|</span> f   <span class="operator">|</span> <span class="number">2022</span><span class="number">-06</span><span class="number">-22</span> <span class="number">21</span>:<span class="number">28</span>:<span class="number">25</span> <span class="operator">|</span>    <span class="number">500</span> <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+-----+---------------------+--------+-------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">----------------------</span></span><br><span class="line"></span><br><span class="line">DDL: <span class="keyword">create</span> <span class="keyword">drop</span> <span class="keyword">alter</span></span><br><span class="line">DCL: <span class="keyword">grant</span> <span class="keyword">revoke</span></span><br><span class="line">DML: <span class="keyword">insert</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> 代替 <span class="keyword">delete</span> 做伪删除</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>设置一个状态列</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> xxx <span class="keyword">add</span> state enum(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;0&#x27;</span>) <span class="keyword">default</span> <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="number">2.</span>删除数据</span><br><span class="line"><span class="keyword">update</span> xxx <span class="keyword">set</span> state<span class="operator">=</span><span class="string">&#x27;0&#x27;</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="number">3.</span>查询数据</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> xxx <span class="keyword">where</span> state<span class="operator">=</span><span class="string">&#x27;1&#x27;</span>;</span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> student3(</span><br><span class="line">id <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">name <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">age tinyint unsigned,</span><br><span class="line">sex enum(<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;bgx&#x27;</span>), <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="string">&#x27;bgx&#x27;</span>,</span><br><span class="line"><span class="type">date</span> datetime <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> NOW());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">not</span> <span class="keyword">null</span>:   	 非空</span><br><span class="line"><span class="keyword">primary</span> key: 	 主键		唯一<span class="operator">+</span>非空</span><br><span class="line"><span class="keyword">unique</span> key:		 唯一键	唯一		<span class="keyword">unique</span> key <span class="operator">+</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="operator">=</span> <span class="keyword">primary</span> key</span><br><span class="line">auto_increment:	 自增</span><br><span class="line">unsigned:	 	 非负</span><br><span class="line"><span class="keyword">default</span>:  		 默认值</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> student4(</span><br><span class="line">id <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">primary</span> key auto_increment comment <span class="string">&#x27;学号&#x27;</span>,</span><br><span class="line">name <span class="type">varchar</span>(<span class="number">10</span>)<span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">age tinyint unsigned comment <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">sex enum(<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;bgx&#x27;</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="string">&#x27;bgx&#x27;</span> comment <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line"><span class="type">date</span> datetime <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> NOW() comment <span class="string">&#x27;入学时间&#x27;</span>);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> student4;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student4 <span class="keyword">add</span> weight <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> student4;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">#添加列和列定义  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> stu <span class="keyword">add</span> age <span class="type">int</span>;  </span><br><span class="line">#添加多个列  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> stu <span class="keyword">add</span> test <span class="type">varchar</span>(<span class="number">20</span>),<span class="keyword">add</span> qq <span class="type">int</span>;  </span><br><span class="line">#指定位置进行添加列（表首）  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> stu <span class="keyword">add</span> classid <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">first</span>;  </span><br><span class="line">#指定位置进行添加列（指定列）  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> stu <span class="keyword">add</span> phone <span class="type">int</span> after age;  </span><br><span class="line">#删除指定的列及定义  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> stu <span class="keyword">drop</span> qq;</span><br><span class="line">#修改表名  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student rename stu;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> dev@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span> <span class="keyword">with</span> max_user_connections <span class="number">2</span>;</span><br><span class="line">max_user_connections <span class="number">2</span>    #允许同时连接数量<span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `student5` (</span><br><span class="line">`id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO INCREMENT COMMENT <span class="string">&#x27;学号&#x27;</span>，</span><br><span class="line">`name` <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>，</span><br><span class="line">`age` tinyint(<span class="number">3</span>) unsigned <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">`sex` enum(<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;bgx&#x27;</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;bgx&#x27;</span> COMMENT <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">`<span class="type">date</span>` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;入学时问&#x27;</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>myisam <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>gbk</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DDL: <span class="keyword">create</span> <span class="keyword">drop</span> <span class="keyword">alter</span></span><br><span class="line"></span><br><span class="line">DCL: <span class="keyword">grant</span> <span class="keyword">revoke</span></span><br><span class="line"></span><br><span class="line">DML: <span class="keyword">insert</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> 代替 <span class="keyword">delete</span> 做伪删除</span><br><span class="line"><span class="number">1.</span>设置一个状态列</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> xxx <span class="keyword">add</span> state enum(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;0&#x27;</span>) <span class="keyword">default</span> <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="number">2.</span>删除数据</span><br><span class="line"><span class="keyword">update</span> xxx <span class="keyword">set</span> state<span class="operator">=</span><span class="string">&#x27;0&#x27;</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="number">3.</span>查询数据</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> xxx <span class="keyword">where</span> state<span class="operator">=</span><span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>MySQL-day04-10SQL语句DQL-select基础用法讲解</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">&lt;</span> world.sql  #导入world.sql文件</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p456</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line">mysql<span class="operator">&gt;</span> use world</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">user</span>,host <span class="keyword">from</span> mysql.user;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> city;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name,countrycode <span class="keyword">from</span> city <span class="keyword">where</span> CountryCode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name,District,countrycode <span class="keyword">from</span> city <span class="keyword">where</span> CountryCode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name,District,countrycode,population <span class="keyword">from</span> city <span class="keyword">where</span> CountryCode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name,District,countrycode,population <span class="keyword">from</span> city <span class="keyword">where</span> CountryCode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span> limit <span class="number">10</span>;  #limit <span class="number">10</span>显示前十行</span><br><span class="line">显示<span class="number">60</span>行</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> id,name,District,countrycode,population <span class="keyword">from</span> city <span class="keyword">where</span> CountryCode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span> limit <span class="number">60</span>;</span><br><span class="line">前端内容一页显示<span class="number">60</span>行，第一页<span class="number">60</span>行</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> id,name,District,countrycode,population <span class="keyword">from</span> city limit <span class="number">60</span>;</span><br><span class="line">前端内容一页显示<span class="number">60</span>行，第二页<span class="number">60</span>行</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> id,name,District,countrycode,population <span class="keyword">from</span> city limit <span class="number">60</span>,<span class="number">60</span>;</span><br><span class="line">前端内容一页显示<span class="number">60</span>行，第三页<span class="number">60</span>行</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> id,name,District,countrycode,population <span class="keyword">from</span> city limit <span class="number">120</span>,<span class="number">60</span>;</span><br><span class="line"></span><br><span class="line">#行级查询  网站的翻页功能</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> countrycode,district <span class="keyword">from</span> city limit <span class="number">2</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> id,countrycode,district <span class="keyword">from</span> city limit <span class="number">2</span>,<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">#多条件查询</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name,population <span class="keyword">from</span> city <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span> <span class="keyword">and</span> district<span class="operator">=</span><span class="string">&#x27;heilongjiang&#x27;</span>;</span><br><span class="line"></span><br><span class="line">模糊查询</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%server%&#x27;</span>;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name,countrycode,population <span class="keyword">from</span> city <span class="keyword">where</span> countrycode <span class="keyword">like</span> <span class="string">&#x27;%N%&#x27;</span>;  #模糊查询 带有N的</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name,countrycode,population <span class="keyword">from</span> city <span class="keyword">where</span> countrycode <span class="keyword">like</span> <span class="string">&#x27;N%&#x27;</span>;  #模糊查询 以N开头的</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name,countrycode,population <span class="keyword">from</span> city <span class="keyword">where</span> countrycode <span class="keyword">like</span> <span class="string">&#x27;%N&#x27;</span>;    #模糊查询 以N结尾的</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">order</span> <span class="keyword">by</span> population limit <span class="number">10</span>;    #以人口排序从小到大，取前十</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">order</span> <span class="keyword">by</span> population <span class="keyword">desc</span> limit <span class="number">10</span>;    #以人口排序从大到小，取前十</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> population <span class="operator">&gt;</span> <span class="number">1000000</span>;    #范围查询</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span> <span class="keyword">or</span> countrycode<span class="operator">=</span><span class="string">&#x27;USA&#x27;</span>;    #范围查询</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode <span class="keyword">in</span> (<span class="string">&#x27;USA&#x27;</span>,<span class="string">&#x27;CHN&#x27;</span>);    #范围查询</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">查询 人口数量小于<span class="number">100</span> 国家 城市 以及城市人口数 国家代码？</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> country.name,city.name,city.population,country.code <span class="keyword">from</span> city,country <span class="keyword">where</span> city.countrycode<span class="operator">=</span>country.code <span class="keyword">and</span> city.population <span class="operator">&lt;</span><span class="number">100</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------+------------+------+</span></span><br><span class="line"><span class="operator">|</span> name     <span class="operator">|</span> name      <span class="operator">|</span> population <span class="operator">|</span> code <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------+------------+------+</span></span><br><span class="line"><span class="operator">|</span> Pitcairn <span class="operator">|</span> Adamstown <span class="operator">|</span>         <span class="number">42</span> <span class="operator">|</span> PCN  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-----------+------------+------+</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>MySQL-day05-01SQL语句DQL-select高级查询（传统连接，自连接）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> t1.name,t2.score <span class="keyword">from</span> t1,t2 <span class="keyword">where</span> t1.id<span class="operator">=</span>t2.id <span class="keyword">and</span> t1.name<span class="operator">=</span><span class="string">&#x27;bgx&#x27;</span>;    #连表查询，多表联查</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">创建oldboy库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database oldboy;</span><br><span class="line">进入oldboy库</span><br><span class="line">mysql<span class="operator">&gt;</span> use oldboy;</span><br><span class="line">创建t1表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> t1(id <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">primary</span> key auto_increment,name <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span>);</span><br><span class="line">创建t2表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> t2(id <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">primary</span> key auto_increment,score <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="number">0</span>);</span><br><span class="line">查看表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_oldboy <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> t1               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> t2               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line">t1表插入name</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> t1(name) <span class="keyword">values</span>(<span class="string">&#x27;lidao&#x27;</span>),(<span class="string">&#x27;bgx&#x27;</span>),(<span class="string">&#x27;zhang3&#x27;</span>);</span><br><span class="line">t2表插入score</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> t2(score) <span class="keyword">values</span>(<span class="number">50</span>),(<span class="number">70</span>),(<span class="number">80</span>);</span><br><span class="line">查询t1表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> lidao  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> bgx    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> zhang3 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line">查询t2表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t2;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> score <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span>    <span class="number">50</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span>    <span class="number">70</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span>    <span class="number">80</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+</span></span><br><span class="line">传统连接 连表查询，多表联查</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> t1.name,t2.score <span class="keyword">from</span> t1,t2 <span class="keyword">where</span> t1.id<span class="operator">=</span>t2.id <span class="keyword">and</span> t1.name<span class="operator">=</span><span class="string">&#x27;bgx&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+-------+</span></span><br><span class="line"><span class="operator">|</span> name <span class="operator">|</span> score <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+-------+</span></span><br><span class="line"><span class="operator">|</span> bgx  <span class="operator">|</span>    <span class="number">70</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+-------+</span></span><br><span class="line"></span><br><span class="line">世界上国家人口数量小于<span class="number">100</span>的城市在哪个国家，说的什么语言？传统连接（只能内连接，只能取交集）</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> country.population,city.name,country.name,countrylanguage.language <span class="keyword">from</span> city,country,countrylanguage <span class="keyword">where</span> city.countrycode<span class="operator">=</span>country.code <span class="keyword">and</span> countrylanguage.countrycode<span class="operator">=</span>country.code <span class="keyword">and</span> country.population<span class="operator">&lt;</span><span class="number">100</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----------+----------+-------------+</span></span><br><span class="line"><span class="operator">|</span> population <span class="operator">|</span> name      <span class="operator">|</span> name     <span class="operator">|</span> <span class="keyword">language</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----------+----------+-------------+</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">50</span> <span class="operator">|</span> Adamstown <span class="operator">|</span> Pitcairn <span class="operator">|</span> Pitcairnese <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----------+----------+-------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">NATURAL</span>　<span class="keyword">JOIN</span>（自连接的表要有共同的列名字）</span><br><span class="line"><span class="keyword">SELECT</span> city.name,city.countrycode ,countrylanguage.language ,city.population</span><br><span class="line"><span class="keyword">FROM</span>  city <span class="keyword">NATURAL</span>  <span class="keyword">JOIN</span>  countrylanguage </span><br><span class="line"><span class="keyword">WHERE</span> population <span class="operator">&gt;</span> <span class="number">1000000</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> population;</span><br><span class="line"></span><br><span class="line">城市人口数量等于<span class="number">2352121</span>，城市说的什么语言，国家代码是什么？</span><br><span class="line"><span class="keyword">select</span> city.name,countrylanguage.language,city.countrycode</span><br><span class="line"><span class="keyword">from</span> city <span class="keyword">natural</span> <span class="keyword">join</span> countrylanguage</span><br><span class="line"><span class="keyword">where</span> city.population<span class="operator">=</span><span class="number">2352121</span>;</span><br><span class="line"></span><br><span class="line">企业中多表连接查询（内连接）  建议：使用<span class="keyword">join</span>语句时，小表在前，大表在后。（效率高）</span><br><span class="line"><span class="keyword">select</span> city.name,city.countrycode,country.name </span><br><span class="line"><span class="keyword">from</span> city <span class="keyword">join</span> country <span class="keyword">on</span> city.countrycode<span class="operator">=</span>country.code </span><br><span class="line"><span class="keyword">where</span> city.population<span class="operator">&lt;</span><span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">外连接</span><br><span class="line"><span class="keyword">select</span> city.name,city.countrycode,country.name </span><br><span class="line"><span class="keyword">from</span> city <span class="keyword">left</span> <span class="keyword">join</span> country </span><br><span class="line"><span class="keyword">on</span> city.countrycode<span class="operator">=</span>country.code </span><br><span class="line"><span class="keyword">and</span> city.population<span class="operator">&lt;</span><span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">UNION</span>（合并查询） （效率高）</span><br><span class="line">#范围查询<span class="keyword">OR</span>语句</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span> <span class="keyword">or</span> countrycode<span class="operator">=</span><span class="string">&#x27;USA&#x27;</span>;</span><br><span class="line">#范围查询<span class="keyword">IN</span>语句</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode <span class="keyword">in</span> (<span class="string">&#x27;CHN&#x27;</span>,<span class="string">&#x27;USA&#x27;</span>);</span><br><span class="line">替换为：</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span> </span><br><span class="line"><span class="keyword">union</span>  <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;USA&#x27;</span> limit <span class="number">10</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>老男孩教育上海linux脱产3期MySQL-day05-03MySQL字符集讲解</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">将库替换字符集为gbk</span><br><span class="line">[root@master ~]# mysqldump -uroot -p456 -S /application/mysql-5.6.40/tmp/mysql.sock  -A &gt; /tmp/full.sql</span><br><span class="line">[root@master ~]# vim /tmp/full.sql</span><br><span class="line">:%s#utf8#gbk#g</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>老男孩教育上海Linux3期MySQL-day05-01MySQL索引管理-BTREE算法讲解</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1)BTREE:B+树索引  </span><br><span class="line">2)HASH：HASH索引  </span><br><span class="line">3)FULLTEXT：全文索引  </span><br><span class="line">4)RTREE：R树索引</span><br></pre></td></tr></table></figure>


<p>MySQL-day05-02MySQL索引管理-创建主键，唯一，普通索引及判断讲解</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line">mysql<span class="operator">&gt;</span> use test;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> student4;</span><br><span class="line">#index给name添加索引idx_name</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student4 <span class="keyword">add</span> index idx_name(name);</span><br><span class="line">#查看索引，Key<span class="operator">=</span>MUL 普通索引</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> student4;</span><br><span class="line">#查看建表语句索引 KEY `idx_name` (`name`)</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> student4;</span><br><span class="line">#另一种查看索引方式，Key_name<span class="operator">=</span>idx_name，Column_name<span class="operator">=</span>name，Index_type<span class="operator">=</span>BTREE</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> index <span class="keyword">from</span> student4;</span><br><span class="line">#删除idx_name索引</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student4 <span class="keyword">drop</span> index idx_name;</span><br><span class="line">#查看studnet表没有主键</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> student;</span><br><span class="line">#添加主键索引</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student <span class="keyword">add</span> <span class="keyword">primary</span> key pri_id(id);</span><br><span class="line">#查看主键索引，Key_name<span class="operator">=</span><span class="keyword">PRIMARY</span>，主键索引Key_name不可自定义</span><br><span class="line">mysql<span class="operator">&gt;</span> mysql<span class="operator">&gt;</span> <span class="keyword">show</span> index <span class="keyword">from</span> student;</span><br><span class="line">#添加唯一索引uni_age</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student <span class="keyword">add</span> <span class="keyword">unique</span> key uni_age(age);</span><br><span class="line">#查看唯一索引，Key_name<span class="operator">=</span>uni_age，唯一索引<span class="operator">+</span>非空<span class="operator">=</span>主键索引</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> index <span class="keyword">from</span> student;</span><br><span class="line">#查看student表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> student;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> Field <span class="operator">|</span> Type        <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> id    <span class="operator">|</span> <span class="type">int</span>(<span class="number">11</span>)     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="number">0</span>       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">10</span>) <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> age   <span class="operator">|</span> tinyint(<span class="number">4</span>)  <span class="operator">|</span> YES  <span class="operator">|</span> UNI <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------------+------+-----+---------+-------+</span></span><br><span class="line">#给name添加普通索引</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student <span class="keyword">add</span> index idx_name(name);</span><br><span class="line">#查看student表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> student;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> Field <span class="operator">|</span> Type        <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> id    <span class="operator">|</span> <span class="type">int</span>(<span class="number">11</span>)     <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="number">0</span>       <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">10</span>) <span class="operator">|</span> YES  <span class="operator">|</span> MUL <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> age   <span class="operator">|</span> tinyint(<span class="number">4</span>)  <span class="operator">|</span> YES  <span class="operator">|</span> UNI <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------------+------+-----+---------+-------+</span></span><br><span class="line">#查看student2表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> student2;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+---------------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> Field <span class="operator">|</span> Type                <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+---------------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> id    <span class="operator">|</span> <span class="type">int</span>(<span class="number">11</span>)             <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">10</span>)         <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> age   <span class="operator">|</span> tinyint(<span class="number">4</span>)          <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sex   <span class="operator">|</span> enum(<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;bgx&#x27;</span>) <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="type">date</span>  <span class="operator">|</span> datetime            <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+---------------------+------+-----+---------+-------+</span></span><br><span class="line">#查询studnet2表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student2;</span><br><span class="line">#计算name列总共有多少行数据</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(name) <span class="keyword">from</span> student2;</span><br><span class="line">#计算所有数据总共有多少行数据，空行数据不计算</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> student2;</span><br><span class="line">#查询name列数据</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name <span class="keyword">from</span> student2;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> name <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> bgx  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> bgx  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line">#查询对name列数据去重</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">distinct</span>(name) <span class="keyword">from</span> student2;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> name <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> bgx  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line">#计算去重后name列总共有多少行数据</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span>(name)) <span class="keyword">from</span> student2;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="keyword">distinct</span>(name)) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+</span></span><br><span class="line"><span class="operator">|</span>                     <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+</span></span><br><span class="line">#有重复数据的列无法添加唯一索引</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student2 <span class="keyword">add</span> <span class="keyword">unique</span> key uni_name(name);</span><br><span class="line">ERROR <span class="number">1062</span> (<span class="number">23000</span>): Duplicate entry <span class="string">&#x27;bgx&#x27;</span> <span class="keyword">for</span> key <span class="string">&#x27;uni_name&#x27;</span></span><br><span class="line">#计算去重后age列总共有多少行数据</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span>(age)) <span class="keyword">from</span> student2;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="keyword">distinct</span>(age)) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+</span></span><br><span class="line"><span class="operator">|</span>                    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+</span></span><br><span class="line">#计算age列总共有多少行数据</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(age) <span class="keyword">from</span> student2;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(age) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+</span></span><br><span class="line">#查询age列无重复数据后，可以添加唯一索引</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student2 <span class="keyword">add</span> <span class="keyword">unique</span> key uni_age(age);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> use world;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> index <span class="keyword">from</span> city;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(population) <span class="keyword">from</span> city;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(population) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="operator">|</span>              <span class="number">4079</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line">#查询后发现有population列有重复数据，无法添加唯一索引</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span>(population)) <span class="keyword">from</span> city;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="keyword">distinct</span>(population)) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------+</span></span><br><span class="line"><span class="operator">|</span>                        <span class="number">3897</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student4 <span class="keyword">add</span> index idx_name(name);    #添加索引</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> student4;    #查看索引</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> index <span class="keyword">from</span> student4;    #查看索引</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student4 <span class="keyword">drop</span> index idx_name;  #删除索引</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student <span class="keyword">add</span> <span class="keyword">primary</span> key pri_id(id);  #添加主键索引</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student <span class="keyword">add</span> <span class="keyword">unique</span> key uni_age(age);  #添加唯一索引</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student <span class="keyword">add</span> index idx_name(name);  #添加普通索引</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(name) <span class="keyword">from</span> student2;  #计算name列有多少数据</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">distinct</span>(name) <span class="keyword">from</span> student2;  #去重name列</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span>(name)) <span class="keyword">from</span> student2;  #计算去重后name列有多少数据</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>老男孩教育上海Linux3期MySQL-day05-03MySQL索引管理-前缀索引及联合索引讲解</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> use test;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> student3;</span><br><span class="line">#给student3表name列前<span class="number">4</span>个字符添加前缀索引</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student3 <span class="keyword">add</span> index idx_name(name(<span class="number">4</span>));</span><br><span class="line">#Key<span class="operator">=</span>MUL，普通索引</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> student3;</span><br><span class="line">#前缀索引，Key_name<span class="operator">=</span>idx_name，Column_name<span class="operator">=</span>name，Sub_part<span class="operator">=</span><span class="number">4</span>（前<span class="number">4</span>个字符）</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> index <span class="keyword">from</span> student3;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>前缀索引的作用：创建索引会列数据进行排序，默认情况下按Btree算法排序，前缀索引是针对数据比较长的列。长数据列不使用前缀索引会需要消耗较长时间创建索引。<br>企业中需要避免对数据较大的列创建索引，如果有，就使用前缀索引</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">联合索引，将多个字段创建成索引</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> student3;</span><br><span class="line">#对age,sex,<span class="type">date</span>三列创建联合索引</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student3 <span class="keyword">add</span> index idx_all(age,sex,<span class="type">date</span>);</span><br><span class="line">#Field<span class="operator">=</span>age,Key<span class="operator">=</span>MUL,联合索引只显示在一列</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> student3;</span><br><span class="line">#查看联合索引，Non_unique都一致为<span class="number">1</span>，Seq_in_index按创建顺序<span class="number">1</span>(age),<span class="number">2</span>(sex),<span class="number">3</span>(<span class="type">date</span>)</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> index <span class="keyword">from</span> student3;</span><br><span class="line">#删除联合索引</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student3 <span class="keyword">drop</span> index idx_all;</span><br><span class="line">#查看索引</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> index <span class="keyword">from</span> student3;</span><br><span class="line">#可以修改联合索引的顺序<span class="number">1</span>(sex),<span class="number">2</span>(age),<span class="number">3</span>(<span class="type">date</span>)</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student3 <span class="keyword">add</span> index idx_all(sex,age,<span class="type">date</span>);</span><br><span class="line"></span><br><span class="line">#创建xiangqin表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> xiangqin(id <span class="type">int</span>,name <span class="type">varchar</span>(<span class="number">10</span>),QQ <span class="type">int</span>,age tinyint,sex enum(<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;m&#x27;</span>),money <span class="type">int</span>,face <span class="type">varchar</span>(<span class="number">10</span>),body <span class="type">varchar</span>(<span class="number">10</span>),hight <span class="type">int</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> xiangqing;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> xiangqin <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;fbb&#x27;</span>,<span class="number">123456</span>,<span class="number">18</span>,<span class="string">&#x27;f&#x27;</span>,<span class="number">1000</span>,<span class="string">&#x27;beautiful&#x27;</span>,<span class="string">&#x27;nice&#x27;</span>,<span class="number">170</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> xiangqin <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">&#x27;fj&#x27;</span>,<span class="number">123457</span>,<span class="number">30</span>,<span class="string">&#x27;f&#x27;</span>,<span class="number">1000</span>,<span class="string">&#x27;very ugly&#x27;</span>,<span class="string">&#x27;bad&#x27;</span>,<span class="number">150</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> xiangqin <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">&#x27;ly&#x27;</span>,<span class="number">123458</span>,<span class="number">18</span>,<span class="string">&#x27;f&#x27;</span>,<span class="number">2000</span>,<span class="string">&#x27;v b&#x27;</span>,<span class="string">&#x27;perfact&#x27;</span>,<span class="number">175</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> xiangqin <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">&#x27;bgx&#x27;</span>,<span class="number">123459</span>,<span class="number">58</span>,<span class="string">&#x27;m&#x27;</span>,<span class="number">2</span>,<span class="string">&#x27;qichouwubi&#x27;</span>,<span class="string">&#x27;very fat&#x27;</span>,<span class="number">110</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> xiangqin <span class="keyword">values</span>(<span class="number">4</span>,<span class="string">&#x27;drz&#x27;</span>,<span class="number">133411023</span>,<span class="number">18</span>,<span class="string">&#x27;m&#x27;</span>,<span class="number">10000000</span>,<span class="string">&#x27;handsome&#x27;</span>,<span class="string">&#x27;perfact&#x27;</span>,<span class="number">182</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> xiangqin;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> xiangqin <span class="keyword">add</span> index idx_all(money,sex,face,body);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> index <span class="keyword">from</span> xiangqin;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> xiangqin <span class="keyword">where</span> money<span class="operator">&gt;</span><span class="number">1000</span> <span class="keyword">and</span> sex<span class="operator">=</span><span class="string">&#x27;f&#x27;</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>money,sex,face,body 按顺序才可以走索引<br>a,ab,ac,abc,abcd 可以走索引或部分走索引<br>b bc bcd cd c d ba … 不走索引</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#创建前缀索引</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> test <span class="keyword">add</span> index idx_name(anme(<span class="number">10</span>));</span><br><span class="line"></span><br><span class="line">#创建联合索引</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student3 <span class="keyword">add</span> index idx_all(age,sex,<span class="type">date</span>);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> student3;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> index <span class="keyword">from</span> student3;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#删除联合索引</span><br><span class="line">msyql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student3 <span class="keyword">drop</span> index idx_all;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msyql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">const  <span class="keyword">ALL</span>  <span class="keyword">ref</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>老男孩教育上海Linux3期MySQL-day05-04MySQL索引管理-全表扫描索引扫描及explain讲解</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> use world;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name,countrycode <span class="keyword">from</span> city <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">#使用explain查看语句索引效率，type<span class="operator">=</span>const</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> name,countrycode <span class="keyword">from</span> city <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">#使用explain查看语句索引效率，type<span class="operator">=</span>const</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city;</span><br><span class="line">#type<span class="operator">=</span><span class="keyword">ALL</span>，就是全表扫描，速率最慢</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> city;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> District<span class="operator">=</span><span class="string">&#x27;heilongjiang&#x27;</span>;</span><br><span class="line">#type<span class="operator">=</span><span class="keyword">ALL</span>，全表扫描</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> District<span class="operator">=</span><span class="string">&#x27;heilongjiang&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> city <span class="keyword">add</span> index idx_District(District);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> District<span class="operator">=</span><span class="string">&#x27;heilongjiang&#x27;</span>;</span><br><span class="line">#添加普通索引后，type<span class="operator">=</span><span class="keyword">ref</span></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> District<span class="operator">=</span><span class="string">&#x27;heilongjiang&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>查询数据的方式<br>1.全表扫描</p>
<blockquote>
<p>1）在explain语句结果中type为ALL<br>2）什么时候出现全表扫描?</p>
<blockquote>
<p>2.1 业务确实要获取所有数据<br>2.2 不走索引导致的全表扫描</p>
<blockquote>
<p>2.2.1 没索引<br>2.2.2 索引创建有问题<br> 2.2.3 语句有问题</p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<p><strong>生产中,mysql在使用全表扫描时的性能是极其差的，所以MySQL尽量避免出现全表扫描</strong> </p>
<blockquote>
<p>2.索引扫描</p>
<blockquote>
<p>2.1 常见的索引扫描类型:<br>1）index<br>2）range<br>3）ref<br>4）eq_ref<br>5）const<br>6）system<br>7）null</p>
</blockquote>
</blockquote>
<p><strong>从上到下，性能从最差到最好，我们认为至少要达到range级别</strong></p>
<p><strong>index</strong>：Full Index Scan，index与ALL区别为index类型只遍历索引树。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> District <span class="keyword">from</span> city;</span><br><span class="line">#type<span class="operator">=</span>index </span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> District <span class="keyword">from</span> city;</span><br></pre></td></tr></table></figure>

<p><strong>range</strong>：索引范围扫描，对索引的扫描开始于某一点，返回匹配值域的行。显而易见的索引范围扫描是带有between或者where子句里带有&lt;,&gt;查询。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#查看city表，Population没有索引</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> city;</span><br><span class="line">#给Population添加普通索引</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> city <span class="keyword">add</span> index idx_pop(population);</span><br><span class="line">#Key<span class="operator">=</span>MUL，Population有索引了</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> city;</span><br><span class="line">#type<span class="operator">=</span><span class="keyword">range</span>级别</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> population<span class="operator">&gt;</span><span class="number">30000000</span>;</span><br><span class="line">#删除索引idx_pop</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> city <span class="keyword">drop</span> index idx_pop;</span><br><span class="line">#type<span class="operator">=</span><span class="keyword">ALL</span>级别</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> population<span class="operator">&gt;</span><span class="number">30000000</span>;</span><br></pre></td></tr></table></figure>

<p><strong>ref</strong>：使用非唯一索引扫描或者唯一索引的前缀扫描，返回匹配某个单独值的记录行。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> city <span class="keyword">drop</span> key idx_code;</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;chn&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode <span class="keyword">in</span> (<span class="string">&#x27;CHN&#x27;</span>,<span class="string">&#x27;USA&#x27;</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span> <span class="keyword">union</span> <span class="keyword">all</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;USA&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>eq_ref</strong>：类似ref，区别就在使用的索引是唯一索引，对于每个索引键值，表中只有一条记录匹配，简单来说，就是多表连接中使用primary key或者 unique key作为关联条件A</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">join</span> B </span><br><span class="line"><span class="keyword">on</span> A.sid<span class="operator">=</span>B.sid</span><br></pre></td></tr></table></figure>

<p><strong>const、system</strong>：当MySQL对查询某部分进行优化，并转换为一个常量时，使用这些类型访问。<br><em>如将主键置于where列表中，MySQL就能将该查询转换为一个常量</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1000</span>;</span><br></pre></td></tr></table></figure>

<p><strong>NULL</strong>：MySQL在优化过程中分解语句，执行时甚至不用访问表或索引，例如从一个索引列里选取最小值可以通过单独索引查找完成。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1000000000000000000000000000</span>;</span><br></pre></td></tr></table></figure>

<p><strong>Extra（扩展）</strong><br>Using temporary<br>Using filesort 使用了默认的文件排序（如果使用了索引，会避免这类排序）<br>Using join buffer</p>
<p><strong>如果出现Using filesort请检查order by ,group by ,distinct,join 条件列上没有索引</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> population;</span><br></pre></td></tr></table></figure>

<p><strong>当order by语句中出现Using filesort，那就尽量让排序值在where条件中出现</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> countrycode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> population;</span><br><span class="line">#修改添加为population<span class="operator">=</span><span class="number">2870300</span> <span class="keyword">and</span> countrycode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span>，可以避免<span class="keyword">Using</span> filesort</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> population<span class="operator">=</span><span class="number">2870300</span> <span class="keyword">and</span> countrycode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> population;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> population<span class="operator">&gt;</span><span class="number">30000000</span> <span class="keyword">order</span> <span class="keyword">by</span> population;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city <span class="keyword">where</span> population<span class="operator">=</span><span class="number">2870300</span> <span class="keyword">order</span> <span class="keyword">by</span> population;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>key_len</strong>: 越小越好</p>
</blockquote>
<ul>
<li>前缀索引去控制</li>
</ul>
<blockquote>
<p><strong>rows</strong>: 越小越好</p>
</blockquote>
<hr>
<p>老男孩教育上海Linux3期MySQL-day07-01索引创建规范以及不走索引案例讲解</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#判断是否有重复值</span><br><span class="line"><span class="built_in">count</span>(name)  <span class="built_in">count</span>(<span class="keyword">distinct</span>(name))</span><br><span class="line"></span><br><span class="line">#awk取值索引type类型</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">-</span>e <span class="string">&#x27;use world;explain select * from city where population&gt;3000 order by population limit 10;&#x27;</span><span class="operator">|</span>awk <span class="string">&#x27;NR==2&#123;print $4&#125;&#x27;</span></span><br><span class="line">#awk取值索引type类型，赋值给变量a</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# a<span class="operator">=</span>`mysql <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">-</span>e <span class="string">&#x27;use world;explain select * from city where population&gt;3000 order by population limit 10;&#x27;</span><span class="operator">|</span>awk <span class="string">&#x27;NR==2&#123;print $4&#125;&#x27;</span>`</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# echo $a</span><br><span class="line">index</span><br><span class="line"></span><br><span class="line">#脚本判断是否走索引</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# vim a.sh</span><br><span class="line">#<span class="operator">!</span><span class="operator">/</span>bin<span class="operator">/</span>bash</span><br><span class="line">a<span class="operator">=</span>`mysql <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">-</span>e <span class="string">&#x27;use world;explain select * from city where population&gt;3000 order by population limit 10;&#x27;</span><span class="operator">|</span>awk <span class="string">&#x27;NR==2&#123;print $4&#125;&#x27;</span>`</span><br><span class="line">if [ $a <span class="operator">=</span><span class="operator">=</span> <span class="string">&#x27;ALL&#x27;</span> ];<span class="keyword">then</span></span><br><span class="line">        echo faild</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        echo OK</span><br><span class="line">fi</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">个人信息：</span><br><span class="line">工作经验：</span><br><span class="line">教育经验：</span><br><span class="line">项目经验:</span><br><span class="line">项目背景：公司<span class="keyword">SQL</span>语句执行效率低</span><br><span class="line">项目名称：优化<span class="keyword">SQL</span>语句创建索引及规范设置</span><br><span class="line">项目实施（规范）：</span><br><span class="line">	<span class="number">1.</span>创建唯一索引</span><br><span class="line">	<span class="number">2.</span>如果该列重复值较多，采用联合索引</span><br><span class="line">	<span class="number">3.</span>经常需要排序、分组和联合操作的字段建立索引</span><br><span class="line">	<span class="number">4.</span>常作为查询条件的字段建立索引</span><br><span class="line">	<span class="number">5.</span>索引字段的值很长，尽量使用前缀索引</span><br><span class="line">	<span class="number">6.</span>限制索引数目</span><br><span class="line">	<span class="number">7.</span>删除不再使用或者很少使用的索引</span><br><span class="line"></span><br><span class="line">优化：</span><br><span class="line">	<span class="number">1.</span>没有查询条件，或者查询条件没有索引。</span><br><span class="line">		a)添加查询条件</span><br><span class="line">		b)为查询条件创建索引</span><br><span class="line">	<span class="number">2.</span>查询结果集是原表中的大部分数据，应该是<span class="number">25</span><span class="operator">%</span>以上不走索引</span><br><span class="line">		a) 使用 limit去查询数据</span><br><span class="line">	<span class="number">3.</span>索引本身损坏（失效），不走索引</span><br><span class="line">		a)监控索引</span><br><span class="line">		b)删除索引，重新建立索引</span><br><span class="line">	<span class="number">4.</span>使用函数在索引列上或者对索引列进行运算，不走索引</span><br><span class="line">	<span class="number">5.</span>隐式转换导致索引失效</span><br><span class="line">	<span class="number">6.</span><span class="operator">&lt;&gt;</span>，<span class="keyword">not</span> <span class="keyword">in</span>不走索引</span><br><span class="line">	<span class="number">7.</span><span class="keyword">like</span> &quot;%_&quot; 百分号在最前面不走</span><br><span class="line">	<span class="number">8.</span>单独引用联合索引里非第一位置的索引列</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>老男孩教育上海Linux3期MySQL-day07-02MySQL存储引擎介绍</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#查看当前MySQL支持的存储引擎类型  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> engines  </span><br><span class="line">#查看innodb的表有哪些  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> table_schema,table_name,engine <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> engine<span class="operator">=</span><span class="string">&#x27;innodb&#x27;</span>;  </span><br><span class="line">#查看myisam的表有哪些  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> table_schema,table_name,engine <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> engine<span class="operator">=</span><span class="string">&#x27;myisam&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">#查询默认存储引擎  </span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@default</span>_storage_engine;</span><br><span class="line"></span><br><span class="line">#查询表的存储引擎 </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> world.city;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">explain<span class="operator">=</span><span class="keyword">desc</span>,相对于别名</span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> table_schema,table_name,engine <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> engine<span class="operator">=</span><span class="string">&#x27;myisam&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> <span class="keyword">select</span> table_schema,table_name,engine <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> engine<span class="operator">=</span><span class="string">&#x27;myisam&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看存储引擎</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> TABLE_NAME, ENGINE <span class="keyword">FROM</span> INFORMATION_SCHEMA.TABLES <span class="keyword">WHERE</span> TABLE_NAME<span class="operator">=</span><span class="string">&#x27;country&#x27;</span> <span class="keyword">AND</span> TABLE_SCHEMA<span class="operator">=</span><span class="string">&#x27;world&#x27;</span>\G</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>老男孩教育上海Linux3期MySQL-day07-03MySQL表空间-共享表空间，存储表空间介绍<br>1）查看共享表空间</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">物理查看</span>  </span><br><span class="line">[root@db01 ~]# ll /application/mysql/data/  </span><br><span class="line">-rw-rw---- 1 mysql mysql 79691776 Aug 14 16:23 ibdata1  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">命令行查看</span>  </span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show variables like <span class="string">&#x27;%path%&#x27;</span>;</span></span><br><span class="line">+-----------------------+------------------------+</span><br><span class="line">| Variable_name         | Value                  |</span><br><span class="line">+-----------------------+------------------------+</span><br><span class="line">| innodb_data_file_path | ibdata1:12M:autoextend |</span><br><span class="line">| ssl_capath            |                        |</span><br><span class="line">| ssl_crlpath           |                        |</span><br><span class="line">+-----------------------+------------------------+</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看表空间大小</span></span><br><span class="line">[root@master data]# cd /application/mysql/data/</span><br><span class="line">[root@db01 data]# du -sh ibdata1</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">  </span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置共享表空间，编辑配置文件，需要保证ibdata1实际大小与设定大小一致（设置两个共享表空间）</span></span><br><span class="line">[root@db01 ~]# vim /etc/my.cnf  </span><br><span class="line">[mysqld]  </span><br><span class="line">log_error=/application/mysql/data/mysql.err</span><br><span class="line">lower_case_table_names = 1</span><br><span class="line">innodb_data_file_path=ibdata1:50M;ibdata2:50M:autoextend  #25行添加</span><br><span class="line">[root@db01 data]# /etc/init.d/mysql restart  #重启数据库</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">报错：ibdata1实际大小与设定大小不一致导致，需修改为实际大小</span><br><span class="line">2022-06-24 13:41:32 29451 [ERROR] InnoDB: Data file ./ibdata1 is of a different size 4864 pages (rounded down to MB) than specified in the .cnf file 3200 pages!</span><br><span class="line"></span><br><span class="line">[root@master data]# du -sh ibdata1</span><br><span class="line">76M     ibdata1</span><br><span class="line">[root@master data]# vim /etc/my.cnf</span><br><span class="line">innodb_data_file_path=ibdata1:76M;ibdata2:50M:autoextend</span><br><span class="line">[root@master data]# /etc/init.d/mysqld restart</span><br><span class="line">[root@master data]# mysql -uroot -p456</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看共享表空间的变化</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show variables like <span class="string">&#x27;%path%&#x27;</span>;</span></span><br><span class="line">+-----------------------+------------------------------------+</span><br><span class="line">| Variable_name         | Value                              |</span><br><span class="line">+-----------------------+------------------------------------+</span><br><span class="line">| innodb_data_file_path | ibdata1:76M;ibdata2:50M:autoextend |</span><br><span class="line">| ssl_capath            |                                    |</span><br><span class="line">| ssl_crlpath           |                                    |</span><br><span class="line">+-----------------------+------------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>共享表空间中存储哪些数据<br>1.系统数据<br>2.undo<br>3.临时表</p>
</blockquote>
<p>1）查看独立表空间<br>对于用户自主创建的表，会采用此种模式，每个表由一个独立的表空间进行管理</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">idb文件就是独立表空间</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">物理查看</span>  </span><br><span class="line">[root@db01 ~]# ll /application/mysql/data/world/  </span><br><span class="line">-rw-rw---- 1 mysql mysql 688128 Aug 14 16:23 city.ibd  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">命令行查看</span>  </span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show variables like <span class="string">&#x27;%per_table%&#x27;</span>;</span></span><br><span class="line">+-----------------------+-------+</span><br><span class="line">| Variable_name         | Value |</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">| innodb_file_per_table | ON    |</span><br><span class="line">+-----------------------+-------+</span><br></pre></td></tr></table></figure>

<h1 id="老男孩教育上海Linux3期MySQL-day07-04表空间表结构损坏企业案例讲解"><a href="#老男孩教育上海Linux3期MySQL-day07-04表空间表结构损坏企业案例讲解" class="headerlink" title="老男孩教育上海Linux3期MySQL-day07-04表空间表结构损坏企业案例讲解"></a>老男孩教育上海Linux3期MySQL-day07-04表空间表结构损坏企业案例讲解</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# ps <span class="operator">-</span>ef<span class="operator">|</span>grep mysql</span><br><span class="line">#启动mysql3307</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqld_safe <span class="comment">--defaults-file=/data/3307/my.cnf &amp;</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# netstat <span class="operator">-</span>lntup</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# cd <span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span>data<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@master</span> data]# ll</span><br><span class="line">[root<span class="variable">@master</span> data]# cp <span class="operator">-</span>r <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>world .</span><br><span class="line">[root<span class="variable">@master</span> data]# ll</span><br><span class="line">[root<span class="variable">@master</span> data]# chown <span class="operator">-</span>R mysql.mysql world<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@master</span> data]# ll</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> test               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> world              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> use world;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_world <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> city            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> country         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> countrylanguage <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city;</span><br><span class="line">ERROR <span class="number">1146</span> (<span class="number">42</span>S02): <span class="keyword">Table</span> <span class="string">&#x27;world.city&#x27;</span> doesn<span class="string">&#x27;t exist &#x27;</span></span><br><span class="line"><span class="comment">------------</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqld_safe <span class="comment">--defaults-file=/data/3308/my.cnf &amp;</span></span><br><span class="line">[root<span class="variable">@master</span> data]# netstat <span class="operator">-</span>lntup<span class="operator">|</span>grep <span class="number">3308</span></span><br><span class="line">[root<span class="variable">@master</span> data]# cp <span class="operator">-</span>a <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>bin<span class="operator">/</span>mysql3307 <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>bin<span class="operator">/</span>mysql3308</span><br><span class="line">[root<span class="variable">@master</span> data]# vim <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>bin<span class="operator">/</span>mysql3308</span><br><span class="line">:<span class="operator">%</span>s#<span class="number">7</span>#<span class="number">8</span>#g</span><br><span class="line">[root<span class="variable">@master</span> data]# mysql3308</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> test               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database world;</span><br><span class="line">mysql<span class="operator">&gt;</span> use world;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"><span class="comment">----------------</span></span><br><span class="line">#进入mysql3306</span><br><span class="line">[root<span class="variable">@master</span> data]# mysql</span><br><span class="line">#通过开发获取建表语句</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> world.city;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `city` (</span><br><span class="line">  `ID` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `Name` <span class="type">char</span>(<span class="number">35</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `CountryCode` <span class="type">char</span>(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `District` <span class="type">char</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `Population` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`ID`),</span><br><span class="line">  KEY `CountryCode` (`CountryCode`),</span><br><span class="line">  KEY `idx_District` (`District`),</span><br><span class="line">  KEY `idx_pop` (`Population`),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `city_ibfk_1` <span class="keyword">FOREIGN</span> KEY (`CountryCode`) <span class="keyword">REFERENCES</span> `country` (`Code`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4080</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@master</span> data]# mysql3308</span><br><span class="line">mysql<span class="operator">&gt;</span> use world;</span><br><span class="line">#删除建表语句的外键后添加</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `city` (</span><br><span class="line">  `ID` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `Name` <span class="type">char</span>(<span class="number">35</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `CountryCode` <span class="type">char</span>(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `District` <span class="type">char</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `Population` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`ID`),</span><br><span class="line">  KEY `CountryCode` (`CountryCode`),</span><br><span class="line">  KEY `idx_District` (`District`),</span><br><span class="line">  KEY `idx_pop` (`Population`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4080</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_world <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> city            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line">[root<span class="variable">@master</span> data]# cd <span class="operator">/</span>data<span class="operator">/</span><span class="number">3308</span><span class="operator">/</span>data<span class="operator">/</span>world<span class="operator">/</span></span><br><span class="line">#需要删掉ibd表空间文件</span><br><span class="line">[root<span class="variable">@master</span> world]# ll</span><br><span class="line">总用量 <span class="number">160</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----. 1 mysql mysql   8710 6月  24 14:18 city.frm</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----. 1 mysql mysql 147456 6月  24 14:18 city.ibd</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----. 1 mysql mysql     61 6月  24 14:11 db.opt</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@master</span> world]# mysql3308</span><br><span class="line">#删掉city独立表空间文件（没有数据的文件）</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> world.city discard tablespace;</span><br><span class="line">[root<span class="variable">@master</span> world]# ll</span><br><span class="line">总用量 <span class="number">16</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----. 1 mysql mysql 8710 6月  24 14:18 city.frm</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----. 1 mysql mysql   61 6月  24 14:11 db.opt</span></span><br><span class="line"></span><br><span class="line">#拷贝损坏数据库<span class="number">3307</span>的表空间文件到<span class="number">3308</span></span><br><span class="line">[root<span class="variable">@master</span> world]# cp <span class="operator">-</span>a <span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span>data<span class="operator">/</span>world<span class="operator">/</span>city.ibd .</span><br><span class="line">[root<span class="variable">@master</span> world]# ll</span><br><span class="line">总用量 <span class="number">816</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----. 1 mysql mysql   8710 6月  24 14:18 city.frm</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 819200 6月  24 14:02 city.ibd</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----. 1 mysql mysql     61 6月  24 14:11 db.opt</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@master</span> world]# mysql3308</span><br><span class="line">mysql<span class="operator">&gt;</span> use world;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_world <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> city            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city;</span><br><span class="line">ERROR <span class="number">1814</span> (HY000): Tablespace has been discarded <span class="keyword">for</span> <span class="keyword">table</span> <span class="string">&#x27;city&#x27;</span></span><br><span class="line">#导入表空间</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> world.city import tablespace;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#导出恢复的<span class="number">3308</span>数据，恢复<span class="number">3307</span></span><br><span class="line">[root<span class="variable">@master</span> world]# mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p3308 <span class="operator">-</span>S <span class="operator">/</span>data<span class="operator">/</span><span class="number">3308</span><span class="operator">/</span>data<span class="operator">/</span>mysql.sock world city <span class="operator">&gt;</span> <span class="operator">/</span>tmp<span class="operator">/</span>city.sql</span><br><span class="line">#查看</span><br><span class="line">[root<span class="variable">@master</span> world]# vim <span class="operator">/</span>tmp<span class="operator">/</span>city.sql</span><br><span class="line">:<span class="operator">%</span>s#city#city_new#g</span><br><span class="line">[root<span class="variable">@master</span> world]# mysql3307</span><br><span class="line">mysql<span class="operator">&gt;</span> use world;</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>tmp<span class="operator">/</span>city.sql;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_world <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> city_new        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> country         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> countrylanguage <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line">[root<span class="variable">@master</span> world]# cd <span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span>data<span class="operator">/</span>world<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@master</span> world]# ll</span><br><span class="line">总用量 <span class="number">2104</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 819200 6月  24 14:02 city.ibd</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----. 1 mysql mysql   8710 6月  24 14:39 city_new.frm</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----. 1 mysql mysql 884736 6月  24 14:39 city_new.ibd</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql   9172 6月  24 14:02 country.frm</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 180224 6月  24 14:02 country.ibd</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql   8702 6月  24 14:02 countrylanguage.frm</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 229376 6月  24 14:02 countrylanguage.ibd</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql     67 6月  24 14:02 db.opt</span></span><br><span class="line">[root<span class="variable">@master</span> world]# rm <span class="operator">-</span>fr city.ibd</span><br><span class="line">[root<span class="variable">@master</span> world]# ll</span><br><span class="line">总用量 <span class="number">1304</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----. 1 mysql mysql   8710 6月  24 14:39 city_new.frm</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----. 1 mysql mysql 884736 6月  24 14:39 city_new.ibd</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql   9172 6月  24 14:02 country.frm</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 180224 6月  24 14:02 country.ibd</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql   8702 6月  24 14:02 countrylanguage.frm</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 229376 6月  24 14:02 countrylanguage.ibd</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql     67 6月  24 14:02 db.opt</span></span><br><span class="line">[root<span class="variable">@master</span> world]# mysql3307</span><br><span class="line">mysql<span class="operator">&gt;</span> use world</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> city_new rename city;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city;</span><br></pre></td></tr></table></figure>


<p>老男孩教育上海Linux3期MySQL-day08-01企业案例回顾</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# cd <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>oldboy</span><br><span class="line">[root<span class="variable">@master</span> oldboy]# ll</span><br><span class="line">[root<span class="variable">@master</span> oldboy]# cp <span class="operator">-</span>a ..<span class="operator">/</span>oldboy <span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span>data<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@master</span> oldboy]# cd <span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span>data<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@master</span> data]# mysql3307</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> oldboy             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> test               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> world              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> use oldboy;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_oldboy <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> t1               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> t2               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1;</span><br><span class="line">ERROR <span class="number">1146</span> (<span class="number">42</span>S02): <span class="keyword">Table</span> <span class="string">&#x27;oldboy.t1&#x27;</span> doesn<span class="string">&#x27;t exist &#x27;</span></span><br><span class="line">[root<span class="variable">@master</span> data]# mysqladmin <span class="operator">-</span>uroot <span class="operator">-</span>p3307 <span class="operator">-</span>S <span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span>data<span class="operator">/</span>mysql.sock shutdown</span><br><span class="line">[root<span class="variable">@master</span> data]# mysqld_safe <span class="comment">--defaults-file=/data/3307/my.cnf &amp;</span></span><br><span class="line">[root<span class="variable">@master</span> data]# netstat <span class="operator">-</span>lntup</span><br><span class="line"><span class="number">1.</span>准备</span><br><span class="line">[root<span class="variable">@master</span> data]# mysql3308</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database oldboy;</span><br><span class="line"></span><br><span class="line">#拿到建表语句</span><br><span class="line">[root<span class="variable">@master</span> data]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p456</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> oldboy.t1;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t1` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@master</span> data]# mysql3308</span><br><span class="line">mysql<span class="operator">&gt;</span> use oldboy;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t1` (</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `name` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> ) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">表结构，表空间损坏恢复过程</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>准备一个新数据库</span><br><span class="line"><span class="number">2.</span>在新库中创建数据库</span><br><span class="line">[root<span class="variable">@master</span> data]# mysql3308</span><br><span class="line">nysql<span class="operator">&gt;</span> <span class="keyword">create</span> database world;</span><br><span class="line"><span class="number">3.</span>管开发要建表语句</span><br><span class="line">[root<span class="variable">@master</span> data]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p456</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> world.country;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `country` (</span><br><span class="line">  `Code` <span class="type">char</span>(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `Name` <span class="type">char</span>(<span class="number">52</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `Continent` enum(<span class="string">&#x27;Asia&#x27;</span>,<span class="string">&#x27;Europe&#x27;</span>,<span class="string">&#x27;North America&#x27;</span>,<span class="string">&#x27;Africa&#x27;</span>,<span class="string">&#x27;Oceania&#x27;</span>,<span class="string">&#x27;Antarctica&#x27;</span>,<span class="string">&#x27;South America&#x27;</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;Asia&#x27;</span>,</span><br><span class="line">  `Region` <span class="type">char</span>(<span class="number">26</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `SurfaceArea` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0.00&#x27;</span>,</span><br><span class="line">  `IndepYear` <span class="type">smallint</span>(<span class="number">6</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `Population` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  `LifeExpectancy` <span class="type">decimal</span>(<span class="number">3</span>,<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `GNP` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `GNPOld` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `LocalName` <span class="type">char</span>(<span class="number">45</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `GovernmentForm` <span class="type">char</span>(<span class="number">45</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `HeadOfState` <span class="type">char</span>(<span class="number">60</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `Capital` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `Code2` <span class="type">char</span>(<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`Code`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>在新库中创建表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `country` (</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `Code` <span class="type">char</span>(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `Name` <span class="type">char</span>(<span class="number">52</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `Continent` enum(<span class="string">&#x27;Asia&#x27;</span>,<span class="string">&#x27;Europe&#x27;</span>,<span class="string">&#x27;North America&#x27;</span>,<span class="string">&#x27;Africa&#x27;</span>,<span class="string">&#x27;Oceania&#x27;</span>,<span class="string">&#x27;Antarctica&#x27;</span>,<span class="string">&#x27;South America&#x27;</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;Asia&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `Region` <span class="type">char</span>(<span class="number">26</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `SurfaceArea` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0.00&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `IndepYear` <span class="type">smallint</span>(<span class="number">6</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `Population` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `LifeExpectancy` <span class="type">decimal</span>(<span class="number">3</span>,<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `GNP` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `GNPOld` <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `LocalName` <span class="type">char</span>(<span class="number">45</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `GovernmentForm` <span class="type">char</span>(<span class="number">45</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `HeadOfState` <span class="type">char</span>(<span class="number">60</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `Capital` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   `Code2` <span class="type">char</span>(<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   <span class="keyword">PRIMARY</span> KEY (`Code`)</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> ) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>删除表空问</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> country discard tablespace;</span><br><span class="line">[root<span class="variable">@master</span> data]# ll <span class="operator">/</span>data<span class="operator">/</span><span class="number">3308</span><span class="operator">/</span>data<span class="operator">/</span>world<span class="operator">/</span></span><br><span class="line">总用量 <span class="number">828</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----. 1 mysql mysql   8710 6月  24 14:18 city.frm</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 819200 6月  24 14:27 city.ibd</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----. 1 mysql mysql   9172 6月  24 22:53 country.frm</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----. 1 mysql mysql     61 6月  24 14:11 db.opt</span></span><br><span class="line"></span><br><span class="line"><span class="number">6.</span>拷贝旧表的表空问文件</span><br><span class="line">[root<span class="variable">@db01</span> data]# cp <span class="operator">-</span>a <span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span>data<span class="operator">/</span>world<span class="operator">/</span>country.ibd <span class="operator">/</span>data<span class="operator">/</span><span class="number">3308</span><span class="operator">/</span>data<span class="operator">/</span>world<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@master</span> data]# mysql3308</span><br><span class="line">mysql<span class="operator">&gt;</span> use world;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_world <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> city            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> country         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> country;</span><br><span class="line">ERROR <span class="number">1814</span> (HY000): Tablespace has been discarded <span class="keyword">for</span> <span class="keyword">table</span> <span class="string">&#x27;country&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="number">7.</span>导入表空间</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> country import tablespace;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> country;</span><br><span class="line"></span><br><span class="line"><span class="number">8.</span>恢复环境</span><br><span class="line">  <span class="number">1</span>）将应用割接到新库（开发改代码，wp<span class="operator">-</span>config.php修改连库信息）</span><br><span class="line">  <span class="number">2</span>）将新库中的表导出，然后恢复到旧库中（如果是数据量小，可以使用）</span><br><span class="line">    a)导出新恢复的表</span><br><span class="line">    [root<span class="variable">@db01</span> data]# mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p3308 <span class="operator">-</span>S <span class="operator">/</span>data<span class="operator">/</span><span class="number">3308</span><span class="operator">/</span>data<span class="operator">/</span>mysql.sock world country <span class="operator">&gt;</span> <span class="operator">/</span>tmp<span class="operator">/</span>country.sql</span><br><span class="line">    b）删除旧库的表文件（物理删除）</span><br><span class="line">    [root<span class="variable">@master</span> data]# cd <span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span>data<span class="operator">/</span>world<span class="operator">/</span></span><br><span class="line">    [root<span class="variable">@master</span> world]# ll</span><br><span class="line">    总用量 <span class="number">1304</span></span><br><span class="line">    <span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----. 1 mysql mysql   8710 6月  24 14:39 city.frm</span></span><br><span class="line">    <span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----. 1 mysql mysql 884736 6月  24 14:39 city.ibd</span></span><br><span class="line">    <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql   9172 6月  24 14:02 country.frm</span></span><br><span class="line">    <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 180224 6月  24 14:02 country.ibd</span></span><br><span class="line">    <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql   8702 6月  24 14:02 countrylanguage.frm</span></span><br><span class="line">    <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 229376 6月  24 14:02 countrylanguage.ibd</span></span><br><span class="line">    <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql     67 6月  24 14:02 db.opt</span></span><br><span class="line">    [root<span class="variable">@db01</span> world]# rm <span class="operator">-</span>fr country.<span class="operator">*</span></span><br><span class="line">    [root<span class="variable">@master</span> world]# ll</span><br><span class="line">    总用量 <span class="number">1116</span></span><br><span class="line">    <span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----. 1 mysql mysql   8710 6月  24 14:39 city.frm</span></span><br><span class="line">    <span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----. 1 mysql mysql 884736 6月  24 14:39 city.ibd</span></span><br><span class="line">    <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql   8702 6月  24 14:02 countrylanguage.frm</span></span><br><span class="line">    <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 229376 6月  24 14:02 countrylanguage.ibd</span></span><br><span class="line">    <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql     67 6月  24 14:02 db.opt</span></span><br><span class="line"></span><br><span class="line">    c）导入数据文件</span><br><span class="line">    [root<span class="variable">@master</span> world]# mysql3307</span><br><span class="line">    mysql<span class="operator">&gt;</span> use world;</span><br><span class="line">    mysql<span class="operator">&gt;</span> source <span class="operator">/</span>tmp<span class="operator">/</span>country.sql;</span><br><span class="line">    mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line">    <span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line">    <span class="operator">|</span> Tables_in_world <span class="operator">|</span></span><br><span class="line">    <span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line">    <span class="operator">|</span> city            <span class="operator">|</span></span><br><span class="line">    <span class="operator">|</span> country         <span class="operator">|</span></span><br><span class="line">    <span class="operator">|</span> countrylanguage <span class="operator">|</span></span><br><span class="line">    <span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line">    #查看数据已经恢复</span><br><span class="line">    mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> country;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>老男孩教育上海Linux3期MySQL-day08-02MySQL存储引擎-事务及事务操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#成功的事务</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> xxx;</span><br><span class="line">mysql<span class="operator">&gt;</span> xxx;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line">#失败的事务</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> xxx;</span><br><span class="line">mysql<span class="operator">&gt;</span> xxx;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">rollback</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看事务自动提交是否开启</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;autocommit&#x27;</span>;</span><br><span class="line">#关闭事务自动提交</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">autocommit<span class="operator">=</span><span class="number">0</span></span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysql restart  #重启</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>老男孩教育上海Linux3期MySQL-day08-04MySQL故障自动回复过程CSR用redo重做讲解<br><strong>1）Redo是什么？</strong><br>redo,顾名思义“重做日志”，是事务日志的一种。<br><strong>2）作用是什么？</strong><br>在事务ACID过程中，实现的是“D”持久化的作用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cd /application/mysql/data</span><br><span class="line">-rw-rw----. 1 mysql mysql 79691776 6月  25 00:11 ibdata1  #undo在共享表空间里面</span><br><span class="line">-rw-rw----. 1 mysql mysql 50331648 6月  25 00:11 ib_logfile0  #redo</span><br><span class="line">-rw-rw----. 1 mysql mysql 50331648 6月  20 16:56 ib_logfile1  #redo</span><br><span class="line">[root@master data]# du -sh ibdata1</span><br><span class="line">12M     ibdata1</span><br><span class="line">[root@master data]# du -sh ib_logfile0</span><br><span class="line">48M     ib_logfile0</span><br><span class="line">[root@master data]# du -sh ib_logfile1</span><br><span class="line">48M     ib_logfile1</span><br></pre></td></tr></table></figure>
<p>![[Pasted image 20220625224828.png]]</p>
<p>老男孩教育上海Linux3期MySQL-day08-05MySQL故障自动回复过程CSR用redo，undo恢复讲解<br>![[Pasted image 20220519173000.png]]</p>
<p>老男孩教育上海Linux3期MySQL-day09-01MySQL锁（共享锁，排它锁，悲观锁，乐观锁）介绍<br><strong>1）什么是“锁”？</strong><br>“锁”顾名思义就是锁定的意思。<br><strong>2）“锁”的作用是什么？</strong><br>在事务ACID特性过程中，“锁”和“隔离级别”一起来实现“I”隔离性的作用</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">#窗口A</span><br><span class="line">mysql<span class="operator">&gt;</span> use jiaoyi;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> lk(id <span class="type">int</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> lk <span class="keyword">values</span>(<span class="number">1</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> lk;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> lk <span class="keyword">add</span> <span class="keyword">primary</span> key pri_id(id);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> lk;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> lk <span class="keyword">set</span> id<span class="operator">=</span><span class="number">2</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">#新开一个窗口B</span><br><span class="line">mysql<span class="operator">&gt;</span> use jiaoyi;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> lk <span class="keyword">set</span> id<span class="operator">=</span><span class="number">3</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;  #夯住了，InnoDB行级锁</span><br><span class="line"></span><br><span class="line">#窗口A</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> lk;  #第一个事务成功</span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-------------</span></span><br><span class="line">#窗口A</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> lk <span class="keyword">values</span>(<span class="number">3</span>),(<span class="number">4</span>),(<span class="number">5</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> lk;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line">#窗口A</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> lk <span class="keyword">set</span> id<span class="operator">=</span><span class="number">10</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">#窗口B</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> lk <span class="keyword">set</span> id<span class="operator">=</span><span class="number">11</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">2</span>;  #夯住了</span><br><span class="line"></span><br><span class="line">#窗口C</span><br><span class="line">mysql<span class="operator">&gt;</span> use jiaoyi；</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> lk <span class="keyword">set</span> id<span class="operator">=</span><span class="number">12</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">3</span>;  #正常修改，证明InnoDB是行级锁</span><br><span class="line"></span><br><span class="line">#窗口A</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line">#窗口C</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>老男孩教育上海Linux3期MySQL-day09-02MySQL多版本并发控制MVCC及隔离级别讲解</p>
<ul>
<li><strong>12.多版本并发控制（MVCC）</strong><br>1）只阻塞修改类操作，不阻塞查询类操作<br>2）乐观锁的机制（谁先提交谁为准）</li>
<li><strong>13.锁的粒度</strong><br>MyIsam：低并发锁（表级锁）<br>Innodb：高并发锁（行级锁）</li>
<li><strong>14.事务的隔离级别</strong><br><em>四种隔离级别：</em><br>READ UNCOMMITTED（独立提交）<br>允许事务查看其他事务所进行的未提交更改<br>READ COMMITTED<br>允许事务查看其他事务所进行的已提交更改<br>REPEATABLE READ******<br>确保每个事务的 SELECT 输出一致<br>InnoDB 的默认级别<br>SERIALIZABLE<br>将一个事务的结果与其他事务完全隔离</li>
</ul>
<p><strong>企业中一般使用RR和RC级别</strong></p>
<p>RU</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">#窗口A</span><br><span class="line">#查看隔离级别</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%iso%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> tx_isolation  <span class="operator">|</span> REPEATABLE<span class="operator">-</span>READ <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------------+</span></span><br><span class="line">#修改隔离级别为RU</span><br><span class="line">[root<span class="variable">@master</span> data]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">transaction_isolation<span class="operator">=</span>read<span class="operator">-</span>uncommit  #添加</span><br><span class="line">[root<span class="variable">@master</span> data]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld restart</span><br><span class="line">[root<span class="variable">@master</span> data]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p456</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%iso%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------------+</span></span><br><span class="line"><span class="operator">|</span> tx_isolation  <span class="operator">|</span> READ<span class="operator">-</span>UNCOMMITTED <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+------------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> lk <span class="keyword">set</span> id<span class="operator">=</span><span class="number">15</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">#窗口B</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> lk;</span><br><span class="line">ERROR <span class="number">2006</span> (HY000): MySQL server has gone away</span><br><span class="line"><span class="keyword">No</span> connection. Trying <span class="keyword">to</span> reconnect...</span><br><span class="line">Connection id:    <span class="number">2</span></span><br><span class="line"><span class="keyword">Current</span> database: jiaoyi</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">12</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">15</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"></span><br><span class="line">#窗口A</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">rollback</span>;</span><br><span class="line"></span><br><span class="line">#窗口B</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> lk;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">12</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br></pre></td></tr></table></figure>

<p>RC</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">#窗口A</span><br><span class="line">#修改隔离级别为RC</span><br><span class="line">[root<span class="variable">@master</span> data]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">transaction_isolation<span class="operator">=</span>read<span class="operator">-</span><span class="keyword">commit</span></span><br><span class="line">[root<span class="variable">@master</span> data]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld restart</span><br><span class="line">[root<span class="variable">@master</span> data]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> use jiaoyi;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> lk <span class="keyword">set</span> id<span class="operator">=</span><span class="number">15</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">窗口B</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> lk;</span><br><span class="line">ERROR <span class="number">2006</span> (HY000): MySQL server has gone away</span><br><span class="line"><span class="keyword">No</span> connection. Trying <span class="keyword">to</span> reconnect...</span><br><span class="line">Connection id:    <span class="number">3</span></span><br><span class="line"><span class="keyword">Current</span> database: jiaoyi</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">12</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"></span><br><span class="line">#窗口A</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line">#窗口B</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> lk;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">12</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">15</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+</span></span><br></pre></td></tr></table></figure>


<p>老男孩教育上海Linux3期MySQL-day09-04MySQL日志-二进制日志模式，开启方式及语句模式和行级模式区别讲解</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br></pre></td><td class="code"><pre><span class="line">#开启binlog</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">log<span class="operator">-</span>bin<span class="operator">=</span>mysql<span class="operator">-</span>bin</span><br><span class="line">#binlog_format<span class="operator">=</span><span class="type">row</span></span><br><span class="line">#server_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld restart</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# ll <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----. 1 mysql mysql      120 6月  26 13:31 mysql-bin.000001  #binlog日志</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----. 1 mysql mysql       19 6月  26 13:31 mysql-bin.index  #binlog日志索引</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database binlog;</span><br><span class="line">mysql<span class="operator">&gt;</span> use binlog;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> binlog(id <span class="type">int</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> binlog <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>),(<span class="number">3</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> binlog;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqlbinlog <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>mysql<span class="operator">-</span>bin<span class="number">.000001</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">log<span class="operator">-</span>bin<span class="operator">=</span>mysql<span class="operator">-</span>bin</span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span>  #取消注释</span><br><span class="line">#server_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database binlog1;</span><br><span class="line">mysql<span class="operator">&gt;</span> use binlog1;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> binlog1(id <span class="type">int</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> binlog1 <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>),(<span class="number">3</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%format%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name            <span class="operator">|</span> <span class="keyword">Value</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> binlog_format            <span class="operator">|</span> <span class="type">ROW</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> date_format              <span class="operator">|</span> <span class="operator">%</span>Y<span class="operator">-</span><span class="operator">%</span>m<span class="operator">-</span><span class="operator">%</span>d          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> datetime_format          <span class="operator">|</span> <span class="operator">%</span>Y<span class="operator">-</span><span class="operator">%</span>m<span class="operator">-</span><span class="operator">%</span>d <span class="operator">%</span>H:<span class="operator">%</span>i:<span class="operator">%</span>s <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> default_week_format      <span class="operator">|</span> <span class="number">0</span>                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> innodb_file_format       <span class="operator">|</span> Antelope          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> innodb_file_format_check <span class="operator">|</span> <span class="keyword">ON</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> innodb_file_format_max   <span class="operator">|</span> Antelope          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> time_format              <span class="operator">|</span> <span class="operator">%</span>H:<span class="operator">%</span>i:<span class="operator">%</span>s          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-------------------+</span></span><br><span class="line">#查看当前有那些binlog日志</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="type">binary</span> logs;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> File_size <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>       <span class="number">449</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span>       <span class="number">143</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span>       <span class="number">143</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>       <span class="number">769</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000005</span> <span class="operator">|</span>       <span class="number">587</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000006</span> <span class="operator">|</span>       <span class="number">120</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000006</span> <span class="operator">|</span>      <span class="number">120</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqlbinlog <span class="comment">--base64-output=decode-rows /application/mysql/data/mysql-bin.000003</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqlbinlog <span class="comment">--base64-output=decode-rows -vvv /application/mysql/data/mysql-bin.000003</span></span><br><span class="line"></span><br><span class="line">#刷新binlog，binlog起始位置点<span class="number">120</span>，结束位置点<span class="number">143</span></span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;</span><br><span class="line">#查看binlog事件</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000003&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000008</span> <span class="operator">|</span>      <span class="number">120</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database test_binlog;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000008</span> <span class="operator">|</span>      <span class="number">235</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> use test_binlog;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> binlog_table(id <span class="type">int</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000008</span> <span class="operator">|</span>      <span class="number">356</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> binlog_table <span class="keyword">values</span>(<span class="number">1</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000008</span> <span class="operator">|</span>      <span class="number">356</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000008</span> <span class="operator">|</span>      <span class="number">568</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> binlog_table <span class="keyword">values</span>(<span class="number">2</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> binlog_table <span class="keyword">values</span>(<span class="number">3</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000008</span> <span class="operator">|</span>      <span class="number">568</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000008</span> <span class="operator">|</span>      <span class="number">882</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> binlog_table <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000008</span> <span class="operator">|</span>      <span class="number">882</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000008</span> <span class="operator">|</span>     <span class="number">1094</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> binlog_table <span class="keyword">set</span> id<span class="operator">=</span><span class="number">22</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">2</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000008</span> <span class="operator">|</span>     <span class="number">1094</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000008</span> <span class="operator">|</span>     <span class="number">1312</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> binlog_table;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">22</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000008</span> <span class="operator">|</span>     <span class="number">1312</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">table</span> binlog_table;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000008</span> <span class="operator">|</span>     <span class="number">1451</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database test_binlog;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000008</span> <span class="operator">|</span>     <span class="number">1550</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line">#查看test_binlog已经删除</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqlbinlog <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>mysql<span class="operator">-</span>bin<span class="number">.000008</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqlbinlog <span class="comment">--base64-output=decode-rows -vvv /application/mysql/data/mysql-bin.000008</span></span><br><span class="line"># <span class="keyword">at</span> <span class="number">120</span>  #起始位置点</span><br><span class="line"># <span class="keyword">at</span> <span class="number">882</span>  #结束位置点</span><br><span class="line"></span><br><span class="line">#恢复前临时关闭binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">#查看筛选出的位置点</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqlbinlog <span class="comment">--start-position=120 --stop-position=882 /application/mysql/data/mysql-bin.000008</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqlbinlog <span class="comment">--start-position=120 --stop-position=882 /application/mysql/data/mysql-bin.000008 &gt; /tmp/test_binlog.sql</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">&lt;</span> <span class="operator">/</span>tmp<span class="operator">/</span>test_binlog.sql</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p456</span><br><span class="line">#查看删除的库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> test_binlog        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line">#进binlog库</span><br><span class="line">mysql<span class="operator">&gt;</span> use test_binlog;</span><br><span class="line">#查看删除的表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_test_binlog <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+</span></span><br><span class="line"><span class="operator">|</span> binlog_table          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+</span></span><br><span class="line">#查看表中内容</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> binlog_table;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>mysql一重启，binlog就会刷新</p>
</blockquote>
<p><strong>思考，存在问题：</strong></p>
<blockquote>
<p>数据库或表被误删除的是很久之前创建的（一年前）<br><strong>如果基于binlog全量恢复，成本很高</strong><br>1）可以用备份恢复+短时间内二进制日志，恢复到故障之前<br>2）非官方方法，binlog2sql，binlog取反，类似于Oracle的flushback<br>3）延时从库</p>
<p>如果同一时间内和故障库无关的数据库都有操作，在截取binlog时都会被截取到<br><strong>想一个办法过滤出来？</strong><br>1）grep？<br><strong>其他过滤方案？</strong><br>1）-d 参数接库名</p>
</blockquote>
<p>-d参数截取test_binlog数据库的binlog</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqlbinlog <span class="operator">-</span>d test_binlog <span class="comment">--start-position=120 --stop-position=882 /application/mysql/data/mysql-bin.000008 &gt; /tmp/test_binlog.sql</span></span><br></pre></td></tr></table></figure>



<p>老男孩教育上海Linux3期MySQL-day09-06MySQL指定库恢复数据及如何刷新删除binlog</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">#刷新binlog</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqladmin <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">-</span>S <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="number">-5.6</span><span class="number">.40</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock flush<span class="operator">-</span>logs</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000009</span> <span class="operator">|</span>      <span class="number">120</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line">#刷新binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> flush logs;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000010</span> <span class="operator">|</span>      <span class="number">120</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line">#重启也能刷新binlog</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld restart</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# <span class="operator">!</span>mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000011</span> <span class="operator">|</span>      <span class="number">120</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line">#当binglog文件达到<span class="number">1</span>G时会自动刷新binlog</span><br><span class="line">#备份时使用mysqldump <span class="operator">-</span>f 也会刷新binlog</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="type">binary</span> logs;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> File_size <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>       <span class="number">449</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span>       <span class="number">143</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span>       <span class="number">143</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>       <span class="number">769</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000005</span> <span class="operator">|</span>       <span class="number">587</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000006</span> <span class="operator">|</span>       <span class="number">167</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000007</span> <span class="operator">|</span>       <span class="number">167</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000008</span> <span class="operator">|</span>      <span class="number">2359</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000009</span> <span class="operator">|</span>       <span class="number">167</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000010</span> <span class="operator">|</span>       <span class="number">143</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000011</span> <span class="operator">|</span>       <span class="number">120</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000008&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database test_binlog;</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqlbinlog <span class="comment">--start-position=120 --stop-position=1312 /application/mysql/data/mysql-bin.000008 &gt; /tmp/test_binlog.sql</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p456</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>tmp<span class="operator">/</span>test_binlog.sql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> DATABASE           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> test_binlog        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> use test_binlog;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_test_binlog <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+</span></span><br><span class="line"><span class="operator">|</span> binlog_table          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> binlog_table;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">22</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>tmp<span class="operator">/</span>test_binlog.sql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> binlog_table;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> binlog_table;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">22</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">22</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">-</span>S <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="number">-5.6</span><span class="number">.40</span><span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock <span class="operator">-</span>A <span class="operator">&gt;</span> <span class="operator">/</span>tmp<span class="operator">/</span>full.sql</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# vim <span class="operator">/</span>tmp<span class="operator">/</span>full.sql</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="type">binary</span> logs;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> File_size <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>       <span class="number">449</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span>       <span class="number">143</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span>       <span class="number">143</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>       <span class="number">769</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000005</span> <span class="operator">|</span>       <span class="number">587</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000006</span> <span class="operator">|</span>       <span class="number">167</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000007</span> <span class="operator">|</span>       <span class="number">167</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000008</span> <span class="operator">|</span>      <span class="number">2359</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000009</span> <span class="operator">|</span>       <span class="number">167</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000010</span> <span class="operator">|</span>       <span class="number">143</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000011</span> <span class="operator">|</span>       <span class="number">233</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line">#根据文件名删除binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> PURGE <span class="type">BINARY</span> LOGS <span class="keyword">TO</span> <span class="string">&#x27;mysql-bin.000007&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="type">binary</span> logs;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> File_size <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000007</span> <span class="operator">|</span>       <span class="number">167</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000008</span> <span class="operator">|</span>      <span class="number">2359</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000009</span> <span class="operator">|</span>       <span class="number">167</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000010</span> <span class="operator">|</span>       <span class="number">143</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000011</span> <span class="operator">|</span>       <span class="number">233</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line">#清空binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> reset master;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>删除、刷新binlog</strong></p>
<blockquote>
<p>刷新binlog日志<br>1）flush logs;<br>2）重启数据库时会刷新<br>3）二进制日志上限（max_binlog_size）</p>
</blockquote>
<p>老男孩教育上海Linux3期-MySQL-day10-02MySQL慢日志开启方式及模拟慢SQL</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">#开启慢查询日志</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf  </span><br><span class="line">[mysqld]  </span><br><span class="line">#指定是否开启慢查询日志  </span><br><span class="line">slow_query_log <span class="operator">=</span> <span class="number">1</span>  </span><br><span class="line">#指定慢日志文件存放位置（默认在data）  </span><br><span class="line">slow_query_log_file<span class="operator">=</span><span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>slow.log  </span><br><span class="line">#设定慢查询的阀值(默认<span class="number">10</span>s)  </span><br><span class="line">long_query_time<span class="operator">=</span><span class="number">0.05</span>  </span><br><span class="line">#不使用索引的慢查询日志是否记录到日志</span><br><span class="line">log_queries_not_using_indexes  </span><br><span class="line">#查询检查返回少于该参数指定行的<span class="keyword">SQL</span>不被记录到慢查询日志  </span><br><span class="line">min_examined_row_limit<span class="operator">=</span><span class="number">100</span>（鸡肋）</span><br><span class="line">[root<span class="variable">@master</span> data]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld restart</span><br><span class="line">#查看慢查询日志</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# cd <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="comment">----. 1 mysql mysql      172 6月  27 15:31 slow.log</span></span><br><span class="line">[root<span class="variable">@master</span> data]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> use world;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_world <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> city            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> country         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> countrylanguage <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> city_new <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city_new;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> city_new;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> city_new <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city_new;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> city_new <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city_new;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> city_new <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city_new;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> city_new <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city_new;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> city_new <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city_new;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> city_new <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city_new;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> city_new <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city_new;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> city_new <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city_new;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> city_new <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city_new;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> city_new <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city_new;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> city_new <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city_new;</span><br><span class="line">Query OK, <span class="number">2088448</span> <span class="keyword">rows</span> affected (<span class="number">13.03</span> sec)</span><br><span class="line">Records: <span class="number">2088448</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> city_new;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4176896</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> city_new;</span><br><span class="line">#阻塞了</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> processlist;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+-----------+-------+---------+------+-------+------------------+</span></span><br><span class="line"><span class="operator">|</span> Id <span class="operator">|</span> <span class="keyword">User</span> <span class="operator">|</span> Host      <span class="operator">|</span> db    <span class="operator">|</span> Command <span class="operator">|</span> <span class="type">Time</span> <span class="operator">|</span> State <span class="operator">|</span> Info             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+-----------+-------+---------+------+-------+------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> root <span class="operator">|</span> localhost <span class="operator">|</span> world <span class="operator">|</span> Sleep   <span class="operator">|</span>  <span class="number">190</span> <span class="operator">|</span>       <span class="operator">|</span> <span class="keyword">NULL</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> root <span class="operator">|</span> localhost <span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span> Query   <span class="operator">|</span>    <span class="number">0</span> <span class="operator">|</span> init  <span class="operator">|</span> <span class="keyword">show</span> processlist <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+-----------+-------+---------+------+-------+------------------+</span></span><br><span class="line">#通过id kill掉</span><br><span class="line">mysql<span class="operator">&gt;</span> kill <span class="number">1</span>;</span><br></pre></td></tr></table></figure>


<p>老男孩教育上海Linux3期-MySQL-day10-03MySQL慢日志分析工具讲解</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cd /application/mysql/bin/</span><br><span class="line">-rwxr-xr-x. 1 mysql mysql   8962992 6月  20 16:38 mysqlshow</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">输出记录次数最多的10条SQL语句</span></span><br><span class="line">[root@master ~]# mysqldumpslow -s c -t 10 /application/mysql/data/slow.log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Anemometer基于pt-query-digest将MySQL慢查询可视化</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下载慢日志分析工具</span></span><br><span class="line">[root@master ~]# wget https://www.percona.com/downloads/percona-toolkit/3.0.11/binary/redhat/7/x86_64/percona-toolkit-3.0.11-1.el7.x86_64.rpm</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下载可视化代码</span></span><br><span class="line">[root@master ~]# git clone https://github.com/box/Anemometer.git</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装慢日志分析工具</span></span><br><span class="line">[root@master ~]# yum localinstall -y percona-toolkit-3.0.11-1.el7.x86_64.rpm</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用percona公司提供的pt-query-digest工具分析慢查询日志</span></span><br><span class="line">[root@master ~]# pt-query-digest /application/mysql/data/slow.log</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>参数说明:<br>-s:<br>是表示按照何种方式排序，c、t、l、r分别是按照记录次数、时间、查询时间、返回的记录数来排序，ac、at、al、ar，表示相应的倒叙；<br>-t:<br>是top n的意思，即为返回前面多少条的数据；<br>-g:<br>后边可以写一个正则匹配模式，大小写不敏感的；</p>
</blockquote>
<p>老男孩教育上海Linux3期-MySQL-day10-04MySQL备份原因及备份方式和备份策略讲解</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">备份类型</span><br><span class="line">冷备：停服务，停机备份</span><br><span class="line">温备：不停服务，锁表，其他用户无法写入数据</span><br><span class="line">热备：不停服务，不锁表，其他用户可以继续写入数据</span><br><span class="line"></span><br><span class="line">备份方式：</span><br><span class="line">逻辑备份</span><br><span class="line">物理备份</span><br><span class="line"></span><br><span class="line">备份策略：</span><br><span class="line">全备</span><br><span class="line">增备</span><br><span class="line">差异备</span><br><span class="line"></span><br><span class="line">mysqldump：<span class="number">1.</span>可以全备 <span class="number">2.</span>不可以做增备 <span class="number">3.</span>不可以做差异备份</span><br><span class="line">Xtrabackup：<span class="number">1.</span>可以全备 <span class="number">2.</span>可以增备 <span class="number">3.</span>可以差异备份</span><br></pre></td></tr></table></figure>

<p><strong>逻辑备份:</strong><br><strong>基于SQL语句的备份</strong><br>1）binlog<br>2）into outfile</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">into</span> outfile逻辑备份只是备份数据，把数据导到文件里，没有作用</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">skip_name_resolve</span><br><span class="line">log<span class="operator">-</span>bin<span class="operator">=</span>mysql<span class="operator">-</span>bin</span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span></span><br><span class="line">secure<span class="operator">-</span>file<span class="operator">-</span>priv<span class="operator">=</span><span class="operator">/</span>tmp  #添加</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld restart</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> world.city <span class="keyword">into</span> outfile <span class="string">&#x27;/tmp/world_city.data&#x27;</span>;</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# cat <span class="operator">/</span>tmp<span class="operator">/</span>world_city.data</span><br></pre></td></tr></table></figure>
<p>3）mysqldump<br>4）replication<br>5）mysqlbinlog</p>
<p><strong>物理备份:</strong><br><strong>基于数据文件的备份</strong><br>1）Xtrabackup（percona公司）<br>2）cp -a &#x2F;data</p>
<p><strong>五.备份工具</strong><br>1）mysqldump（逻辑）<br>mysql原生自带很好用的逻辑备份工具<br>2）mysqlbinlog（逻辑）<br>实现binlog备份的原生态命令<br>3）xtrabackup（物理）<br>precona公司开发的性能很高的物理备份工具</p>
<p>老男孩教育上海Linux3期-MySQL-day10-05mysqldump参数详细分解讲解</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">-</span>A：全库备份</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">-</span>A <span class="operator">&gt;</span> <span class="operator">/</span>tmp<span class="operator">/</span>full.sql</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# ll <span class="operator">/</span>tmp<span class="operator">/</span>full.sql</span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root 1104087 6月  27 16:50 /tmp/full.sql</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# vim <span class="operator">/</span>tmp<span class="operator">/</span>full.sql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysqldump 不加参数 可以单库备份（只备份表），可以单表</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p456 world <span class="operator">&gt;</span> <span class="operator">/</span>tmp<span class="operator">/</span>world.sql</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# vim <span class="operator">/</span>tmp<span class="operator">/</span>world.sql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysqldump <span class="operator">-</span>B 指定库备份，单个或者多个，不能备份表</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">-</span>B world <span class="operator">&gt;</span> <span class="operator">/</span>tmp<span class="operator">/</span>world1.sql</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# vim <span class="operator">/</span>tmp<span class="operator">/</span>world1.sql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# diff <span class="operator">/</span>tmp<span class="operator">/</span>world.sql <span class="operator">/</span>tmp<span class="operator">/</span>world1.sql</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> use world</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_world <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> city            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> city_new        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> country         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> countrylanguage <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database world;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line">ERROR <span class="number">1046</span> (<span class="number">3</span>D000): <span class="keyword">No</span> database selected</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>tmp<span class="operator">/</span>world.sql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> DATABASE           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>tmp<span class="operator">/</span>world1.sql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> DATABASE           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> world              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> use world</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_world <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> city            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> city_new        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> country         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> countrylanguage <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database world;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database world;</span><br><span class="line">mysql<span class="operator">&gt;</span> use world</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>tmp<span class="operator">/</span>world.sql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_world <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> city            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> city_new        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> country         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> countrylanguage <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line">#表级备份，可以指定表</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p456 world city <span class="operator">&gt;</span> <span class="operator">/</span>tmp<span class="operator">/</span>world2.sql</span><br><span class="line"></span><br><span class="line">#<span class="operator">-</span>F：flush logs在备份时自动刷新binlog（不怎么常用）</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">-</span>A <span class="operator">-</span>F <span class="operator">&gt;</span> <span class="operator">/</span>tmp<span class="operator">/</span>full_flush.sql</span><br><span class="line"></span><br><span class="line">#<span class="comment">--master-data=2：备份时加入change master语句0没有1不注释2注释（温备）</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">-</span>A <span class="comment">--master-data=2 &gt; /tmp/full1.sql</span></span><br><span class="line"></span><br><span class="line">#<span class="comment">--single-transaction：快照备份</span></span><br><span class="line">[root<span class="variable">@master</span> tmp]# mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">-</span>A <span class="operator">-</span>R <span class="comment">--triggers --single-transaction --master-data=2 &gt; /tmp/full4.sql.gz</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@master</span> tmp]# mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">-</span>A <span class="operator">-</span>R <span class="comment">--triggers --single-transaction --master-data=2 | gzip &gt; /tmp/full6.sql.gz</span></span><br><span class="line">[root<span class="variable">@master</span> tmp]# ll <span class="operator">/</span>tmp<span class="operator">/</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root  root   334683 6月  27 17:38 full6.sql.gz</span></span><br><span class="line">[root<span class="variable">@master</span> tmp]# gzip <span class="operator">-</span>d full6.sql.gz</span><br><span class="line">[root<span class="variable">@master</span> tmp]# ll</span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root  root  1104221 6月  27 17:38 full6.sql</span></span><br><span class="line">#gzip:压缩备份</span><br><span class="line">[root<span class="variable">@master</span> tmp]# mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">-</span>A <span class="operator">-</span>R <span class="comment">--triggers --single-transaction --master-data=2 | gzip &gt; /tmp/full7.sql.gz</span></span><br><span class="line">[root<span class="variable">@master</span> tmp]# zcat full7.sql.gz</span><br><span class="line">[root<span class="variable">@master</span> tmp]# zcat full7.sql.gz <span class="operator">&gt;</span> <span class="operator">/</span>tmp<span class="operator">/</span>linshi.sql</span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">完整的热备份语句</span></span><br><span class="line">[root@db01 tmp]# mysqldump -uroot -p3307 -A -R --triggers --master-data=2 --single-transaction |gzip &gt; /tmp/full_$(date +%F).sql.gz</span><br></pre></td></tr></table></figure>


<p>老男孩教育上海Linux3期MySQL-day11-01企业案例，MySQL误删除核心业务表恢复过程讲解</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line">#查看当前使用的binlog</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000024</span> <span class="operator">|</span>      <span class="number">223</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line">#创建backup库 </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database backup;</span><br><span class="line">#进入backup库 </span><br><span class="line">mysql<span class="operator">&gt;</span> use backup</span><br><span class="line">#创建<span class="keyword">full</span>表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">full</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> world.city;</span><br><span class="line">#创建full_1表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> full_1 <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> world.city;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_backup <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">full</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> full_1           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line">[root<span class="variable">@master</span> tmp]# mkdir <span class="operator">/</span>backup</span><br><span class="line">#完整热备份</span><br><span class="line">[root<span class="variable">@master</span> tmp]# mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">-</span>A <span class="operator">-</span>R <span class="comment">--triggers --master-data=2 --single-transaction |gzip &gt; /backup/full_$(date +%F).sql.gz</span></span><br><span class="line">[root<span class="variable">@master</span> tmp]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> use backup</span><br><span class="line">#创建<span class="keyword">new</span>表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">new</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mysql.user;</span><br><span class="line">#创建new_1表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> new_1 <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> world.country;</span><br><span class="line">#查看表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_backup <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">full</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> full_1           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">new</span>              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> new_1            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line">#查看<span class="keyword">full</span>表中所有数据</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">full</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> <span class="keyword">full</span> <span class="keyword">set</span> countrycode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span> <span class="keyword">where</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> <span class="keyword">full</span> <span class="keyword">where</span> id<span class="operator">&gt;</span><span class="number">200</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">full</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">new</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_backup <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">full</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> full_1           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> new_1            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"></span><br><span class="line">恢复过程：</span><br><span class="line"><span class="number">1.</span>停止连库业务（避免数据二次伤害）</span><br><span class="line">[root<span class="variable">@master</span> tmp]# systemctl stop tomcat nginx php</span><br><span class="line"><span class="number">2.</span>准备一个新库</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqld_safe <span class="comment">--defaults-file=/data/3309/my.cnf &amp;</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# netstat <span class="operator">-</span>lntup</span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">3306</span>                 :::<span class="operator">*</span>                    LISTEN      <span class="number">84293</span><span class="operator">/</span>mysqld</span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">3309</span>                 :::<span class="operator">*</span>                    LISTEN      <span class="number">115140</span><span class="operator">/</span>mysqld</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# ll <span class="operator">/</span>backup<span class="operator">/</span></span><br><span class="line">总用量 <span class="number">456</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root 464534 6月  27 19:40 full_2022-06-27.sql.gz</span></span><br><span class="line"><span class="number">3.</span>将周三<span class="number">23</span>：<span class="number">00</span>的数据全备，恢复到新库</span><br><span class="line"><span class="number">1</span>）解压备份数据</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# gzip <span class="operator">-</span>d <span class="operator">/</span>backup<span class="operator">/</span>full_2022<span class="number">-06</span><span class="number">-27.</span>sql.gz</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# ll <span class="operator">/</span>backup<span class="operator">/</span>full_2022<span class="number">-06</span><span class="number">-27.</span><span class="keyword">sql</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root 1461625 6月  27 19:40 /backup/full_2022-06-27.sql</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqladmin password <span class="string">&#x27;3309&#x27;</span> <span class="operator">/</span>data<span class="operator">/</span><span class="number">3309</span><span class="operator">/</span>data<span class="operator">/</span>mysql.sock</span><br><span class="line"><span class="number">2</span>）导入新库</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p3309 <span class="operator">-</span>S <span class="operator">/</span>data<span class="operator">/</span><span class="number">3309</span><span class="operator">/</span>data<span class="operator">/</span>mysql.sock <span class="operator">&lt;</span> <span class="operator">/</span>backup<span class="operator">/</span>full_2022<span class="number">-06</span><span class="number">-27.</span><span class="keyword">sql</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# vim <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>bin<span class="operator">/</span>mysql3309</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p3309 <span class="operator">-</span>S <span class="operator">/</span>data<span class="operator">/</span><span class="number">3309</span><span class="operator">/</span>data<span class="operator">/</span>mysql.sock</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# chmod <span class="number">700</span> <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>bin<span class="operator">/</span>mysql3309</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql3309 <span class="operator">-</span>uroot <span class="operator">-</span>p3309</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> DATABASE           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> backup             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> binlog             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> binlog1            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> binlog3            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> binlog5            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jiaoyi             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> oldboy             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> test               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> test_binlog        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> world              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> use backup</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_backup <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">full</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> full_1           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="number">4.</span>截取binlog，周三晚上<span class="number">23</span>：<span class="number">00</span>以后到周四上午<span class="number">10</span>：<span class="number">00</span>之前的数据</span><br><span class="line"><span class="number">1</span>）找起点</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# vim <span class="operator">/</span>backup<span class="operator">/</span>full_2022<span class="number">-06</span><span class="number">-27.</span><span class="keyword">sql</span></span><br><span class="line"><span class="comment">-- CHANGE MASTER TO MASTER_LOG_FILE=&#x27;mysql-bin.000024&#x27;, MASTER_LOG_POS=269943;</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqlbinlog <span class="comment">--base64-output=decode-rows -vvv /application/mysql/data/mysql-bin.000024 |tail -200</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="type">binary</span> logs;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> File_size <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000023</span> <span class="operator">|</span>       <span class="number">167</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000024</span> <span class="operator">|</span>    <span class="number">676134</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000024&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">112.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">   Log_name: mysql<span class="operator">-</span>bin<span class="number">.000024</span></span><br><span class="line">        Pos: <span class="number">675872</span></span><br><span class="line">        Event_type: Query</span><br><span class="line">        Server_id: <span class="number">1</span></span><br><span class="line">        End_log_pos: <span class="number">675992</span></span><br><span class="line">        Info: use `backup`; <span class="keyword">DROP</span> <span class="keyword">TABLE</span> `<span class="keyword">new</span>` <span class="comment">/* generated by server */</span></span><br><span class="line"><span class="number">3</span>）截取binlog</span><br><span class="line"><span class="keyword">start</span><span class="operator">-</span>position<span class="operator">=</span><span class="number">269943</span>      stop<span class="operator">-</span>position<span class="operator">=</span><span class="number">675872</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqlbinlog <span class="comment">--start-position=269943 --stop-position=675872 /application/mysql/data/mysql-bin.000024 &gt; /backup/inc.sql</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# ll <span class="operator">/</span>backup<span class="operator">/</span></span><br><span class="line">总用量 <span class="number">1972</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root 1461625 6月  27 19:40 full_2022-06-27.sql</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root  555306 6月  27 20:38 inc.sql</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql3309</span><br><span class="line">#恢复方式<span class="number">1</span></span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>backup<span class="operator">/</span>inc.sql</span><br><span class="line">mysql<span class="operator">&gt;</span> use backup</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_backup <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">full</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> full_1           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">new</span>              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> new_1            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">full</span>;</span><br><span class="line">#恢复方式<span class="number">2</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql3309 <span class="operator">&lt;</span> <span class="operator">/</span>backup<span class="operator">/</span>inc.sql</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# vim <span class="operator">/</span>data<span class="operator">/</span><span class="number">3309</span><span class="operator">/</span>my.cnf</span><br><span class="line">log<span class="operator">-</span>bin<span class="operator">=</span>mysql<span class="operator">-</span>bin</span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqladmin <span class="operator">-</span>uroot <span class="operator">-</span>p3309 <span class="operator">-</span>S <span class="operator">/</span>data<span class="operator">/</span><span class="number">3309</span><span class="operator">/</span>data<span class="operator">/</span>mysql.sock shutdown</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqld_safe <span class="comment">--defaults-file=/data/3309/my.cnf &amp;</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# <span class="operator">!</span>net</span><br><span class="line">#恢复全备修改了mysql的root用户密码</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">-</span>S <span class="operator">/</span>data<span class="operator">/</span><span class="number">3309</span><span class="operator">/</span>data<span class="operator">/</span>mysql.sock</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>backup<span class="operator">/</span>inc.sql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">new</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">new</span>\G</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">full</span>; </span><br><span class="line"><span class="number">6.</span>测试功能</span><br><span class="line"><span class="number">7.</span>提供服务</span><br><span class="line"><span class="number">1</span>）应用割接，修改代码</span><br><span class="line"><span class="number">2</span>）导出核心业务表恢复到生产库中</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">-</span>S <span class="operator">/</span>data<span class="operator">/</span><span class="number">3309</span><span class="operator">/</span>data<span class="operator">/</span>mysql.sock backup <span class="keyword">new</span> <span class="operator">&gt;</span> <span class="operator">/</span>backup<span class="operator">/</span>new.sql</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> use backup</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>backup<span class="operator">/</span>new.sql</span><br><span class="line"></span><br><span class="line">#另一种恢复方式</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p456 backup <span class="operator">&lt;</span> <span class="operator">/</span>backup<span class="operator">/</span>new.sql</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> use backup</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> sql_log_bin<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">new</span>\G</span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#创建backup库 </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database backup; </span><br><span class="line">#进入backup库 </span><br><span class="line">mysql<span class="operator">&gt;</span> use backup</span><br><span class="line">#查看表 </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mkdir <span class="operator">/</span>backup</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p123 <span class="operator">-</span>A <span class="operator">-</span>R <span class="comment">--triggers --master-data=2 --single-transaction|gzip &gt; /backup/full_$(date +%F).sql.gz</span></span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# ll <span class="operator">/</span>backup<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#进入backup库 </span><br><span class="line">mysql<span class="operator">&gt;</span> use backup </span><br><span class="line">#创建<span class="keyword">new</span>表 </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">new</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mysql.user; </span><br><span class="line">#创建new_1表 </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> new_1 <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> world.country</span><br><span class="line">#查看表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line">#查看<span class="keyword">full</span>表中所有数据</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">full</span>;</span><br><span class="line">#把<span class="keyword">full</span>表中所有的countrycode都改成CHN</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> <span class="keyword">full</span> <span class="keyword">set</span> countrycode<span class="operator">=</span><span class="string">&#x27;CHN&#x27;</span> <span class="keyword">where</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">#提交</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line">#删除<span class="keyword">new</span>表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">new</span>;</span><br><span class="line">#查看表</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">恢复过程：</span><br><span class="line">1.停止连库业务（避免数据二次伤害）</span><br><span class="line">[root@db01 ~]# systemctl stop tomcat nginx php</span><br><span class="line">2.准备一个新库</span><br><span class="line">[root@db01 ~]# mysqld_safe --defaults-file=/data/3309/my.cnf &amp;</span><br><span class="line">3.将周三23：00的数据全备，恢复到新库</span><br><span class="line">    1）解压备份数据</span><br><span class="line">    [root@db01 ~]# gzip -d /backup/full_2019-03-28.sql.gz</span><br><span class="line">    2）导入新库</span><br><span class="line">    [root@db01 ~]# mysql -uroot -p3309 -S /data/3309/data/mysql.sock &lt; /backup/full_2019-03-28.sql</span><br><span class="line">4.截取binlog，周三晚上23：00以后到周四上午10：00之前的数据</span><br><span class="line">    1）找起点</span><br><span class="line">    [root@db01 ~]# vim /backup/full_2019-03-28.sql</span><br><span class="line">-- CHANGE MASTER T0 MASTER_L0G_FILE=&#x27;mysql-bin.000031&#x27;, MASTER_L0G_POS=268102;</span><br><span class="line">    2）找终点</span><br><span class="line">    mysql&gt; show binlog events in &#x27;mysql-bin.000031&#x27;\G</span><br><span class="line">    ***************** 111.row ****************</span><br><span class="line">    Log_name: mysql-bin.000031</span><br><span class="line">        Pos: 670665</span><br><span class="line">        Event_type: Query</span><br><span class="line">        Server_id: 1</span><br><span class="line">        End_log_pos: 670785</span><br><span class="line">        Info: use &#x27;backup&#x27;; DROP TABLE &#x27;new&#x27; /* generated by server */</span><br><span class="line">    3）截取binlog</span><br><span class="line">    start-position=268102      stop-position=670665</span><br><span class="line"></span><br><span class="line">[root@db01 ~]# mysqlbinlog --start-position=268102 --stop-position=670665 /application/mysql/data/mysql-bin.000031 &gt; /backup/inc.sql</span><br><span class="line">[root@db01 ~]# ll /backup/</span><br><span class="line">5.恢复数据</span><br><span class="line">[root@db01 ~]# mysql3309</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="built_in">source</span> /backup/inc.sql</span></span><br><span class="line"></span><br><span class="line">mysql3309 &lt; /backup/inc.sql</span><br><span class="line"></span><br><span class="line">6.测试功能</span><br><span class="line">7.提供服务</span><br><span class="line">    1）应用割接，修改代码</span><br><span class="line">    2）导出核心业务表恢复到生产库中</span><br><span class="line">    [root@db01 ~]# mysqldump -uroot -p3307 -S /data/3309/data/mysql.sock backup new &gt; /backup/new.sql</span><br><span class="line">    [rootedb01 ~]# mysal</span><br><span class="line">    mysql&gt; use backup</span><br><span class="line">    mysql&gt; set sql_log_bin=0;</span><br><span class="line">    mysql&gt; source /backup/new.sql</span><br><span class="line">    </span><br><span class="line">    [root@db01 ~]# mysql -uroot -p3307 backup &lt; /backup/new.sql</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>老男孩教育上海Linux3期MySQL-day11-02MySQL物理备份Xtrabackup进行全备及恢复讲解</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下载epel源</span></span><br><span class="line">[root@master ~]# wget -O /etc/yum.repos.d/epel.repo  https://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装依赖</span></span><br><span class="line">[root@master ~]# yum -y install perl perl-devel libaio libaio-devel perl-Time-HiRes perl-DBD-MySQL</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下载Xtrabackup</span></span><br><span class="line">[root@master ~]# wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.4/binary/redhat/6/x86_64/percona-xtrabackup-24-2.4.4-1.el6.x86_64.rpm</span><br><span class="line">[root@master ~]# yum localinstall -y percona-xtrabackup-24-2.4.4-1.el6.x86_64.rpm</span><br><span class="line"></span><br><span class="line">Xtrabackup物理备份</span><br><span class="line">备份方式（物理备份）</span><br><span class="line">1）对于非innodb表（比如myisam）是直接锁表cp数据文件，属于一种温备。  </span><br><span class="line">2）对于innodb的表（支持事务），不锁表，cp数据页最终以数据文件方式保存下来，并且把redo和undo一并备走，属于热备方式。  </span><br><span class="line">3）备份时读取配置文件/etc/my.cnf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">socket = /application/mysql/tmp/mysql.sock</span><br><span class="line">[root@master ~]# /etc/init.d/mysqld restart</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">全备</span></span><br><span class="line">[root@master ~]# innobackupex --user=root --password=456 /backup/</span><br><span class="line">[root@master ~]# ll /backup/</span><br><span class="line">drwxr-x---. 15 root root    4096 6月  27 22:16 2022-06-27_22-16-06</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">避免时间戳，自定义路径名</span></span><br><span class="line">[root@master ~]# innobackupex --user=root --password=456 --no-timestamp /backup/full</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看备份路径中的内容</span></span><br><span class="line">[root@master ~]# ll /backup/</span><br><span class="line">[root@master ~]# ll /backup/full/</span><br><span class="line">[root@master ~]# cd /backup/full</span><br><span class="line">[root@master full]# cat xtrabackup_binlog_info</span><br><span class="line">mysql-bin.000025 120</span><br><span class="line">[root@master full]# cat xtrabackup_binlog_info</span><br><span class="line">mysql-bin.000025 120</span><br><span class="line">[root@master full]# cat xtrabackup_checkpoints</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">备份类型</span></span><br><span class="line">backup_type = full-backuped</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">日志版本号</span></span><br><span class="line">from_lsn = 0</span><br><span class="line">to_lsn = 707817655</span><br><span class="line">last_lsn = 707817655</span><br><span class="line"></span><br><span class="line">compact = 0</span><br><span class="line">recover_binlog_info = 0</span><br><span class="line">[root@master full]# cat xtrabackup_info</span><br><span class="line">uuid = 3f98eb98-f624-11ec-901c-000c2925dbbc</span><br><span class="line">name =</span><br><span class="line">tool_name = innobackupex</span><br><span class="line">tool_command = --user=root --password=... --no-timestamp /backup/full</span><br><span class="line">tool_version = 2.4.4</span><br><span class="line">ibbackup_version = 2.4.4</span><br><span class="line">server_version = 5.6.40-log</span><br><span class="line">start_time = 2022-06-27 22:20:07</span><br><span class="line">end_time = 2022-06-27 22:20:08</span><br><span class="line">lock_time = 0</span><br><span class="line">binlog_pos = filename &#x27;mysql-bin.000025&#x27;, position &#x27;120&#x27;</span><br><span class="line">innodb_from_lsn = 0</span><br><span class="line">innodb_to_lsn = 707817655</span><br><span class="line">partial = N</span><br><span class="line">incremental = N</span><br><span class="line">format = file</span><br><span class="line">compact = N</span><br><span class="line">compressed = N</span><br><span class="line">encrypted = N</span><br><span class="line">[root@master full]# cat /application/mysql/data/auto.cnf</span><br><span class="line">[auto]</span><br><span class="line">server-uuid=2c5eb45e-f078-11ec-92eb-000c2925dbbc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master mysql]# rm -fr data/</span><br><span class="line">[root@master mysql]# mysql</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show databases;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">+--------------------+</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">已删除data重启失败，物理备份恢复前提需要停库</span></span><br><span class="line">[root@master mysql]# /etc/init.d/mysqld restart</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">恢复步骤：</span><br><span class="line">1）模拟CSR</span><br><span class="line">[root@master mysql]# innobackupex --user=root --password=123 --apply-log /backup/full</span><br><span class="line"></span><br><span class="line">恢复备份</span><br><span class="line">前提1：被恢复的目录是空的  </span><br><span class="line">前提2：被恢复的数据库的实例是关闭的</span><br><span class="line">2）前提1：被恢复的目录是空的</span><br><span class="line">        a)mv /application/mysql/data/ /tmp</span><br><span class="line">        b)rm -fr /application/mysql/data</span><br><span class="line">   前提2：被恢复的数据库的实例是关闭的</span><br><span class="line">         systemctl stop mysqld</span><br><span class="line">         /etc/init.d/mysqld stop</span><br><span class="line">3）恢复数据</span><br><span class="line">[root@master mysql]# innobackupex --copy-back /backup/full</span><br><span class="line">[root@master mysql]# ll /application/mysql/</span><br><span class="line">drwxr-x---. 15 root  root   4096 6月  27 22:45 data  #已恢复data</span><br><span class="line">4）修改权限</span><br><span class="line">[root@master mysql]# chown -R mysql.mysql /application/mysql/data/</span><br><span class="line"></span><br><span class="line">[root@master mysql]# tail -100 /application/mysql/data/master.err</span><br><span class="line">[root@master mysql]# netstat -lntup</span><br><span class="line">tcp6       0      0 :::3306                 :::*                    LISTEN      7514/mysqld</span><br><span class="line">[root@master mysql]# killall mysqld</span><br><span class="line">[root@master mysql]# kill 7514</span><br><span class="line">[root@master mysql]# !net</span><br><span class="line">[root@master mysql]# /etc/init.d/mysqld start</span><br><span class="line">[root@master mysql]# mysql</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show databases;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| DATABASE           |</span><br><span class="line">| backup             |</span><br><span class="line">| binlog             |</span><br><span class="line">| binlog1            |</span><br><span class="line">| binlog3            |</span><br><span class="line">| binlog5            |</span><br><span class="line">| jiaoyi             |</span><br><span class="line">| mysql              |</span><br><span class="line">| oldboy             |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test               |</span><br><span class="line">| test_binlog        |</span><br><span class="line">| world              |</span><br><span class="line">+--------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">物理备份一定要打开</span><br><span class="line">[root@master mysql]# vim /etc/my.cnf</span><br><span class="line">basedir = /application/mysql</span><br><span class="line">datadir = /application/mysql/data</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Xtrabackup物理备份</span><br><span class="line"></span><br><span class="line">备份方式（物理备份）</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>）对于非innodb表（比如myisam）是直接锁表cp数据文件，属于一种温备。</span><br><span class="line"><span class="number">2</span>）对于innodb的表（支持事务），不锁表，cp数据页最终以数据文件方式保存下来，并且把redo和undo一并备走，属于热备方式。</span><br><span class="line"><span class="number">3</span>)备份时读取配置文件<span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@db01</span> <span class="keyword">full</span>]# cat xtrabackup_binlog_info</span><br><span class="line">mysql<span class="operator">-</span>bin<span class="number">.000033</span>    <span class="number">120</span></span><br><span class="line">[root<span class="variable">@db01</span> <span class="keyword">full</span>]# cat xtrabackup_checkpoints</span><br><span class="line">#备份类型</span><br><span class="line">backup_type <span class="operator">=</span> <span class="keyword">full</span><span class="operator">-</span>backuped</span><br><span class="line">#日志版本号</span><br><span class="line">from_lsn <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">to_lsn <span class="operator">=</span> <span class="number">2539984874</span></span><br><span class="line">last_lsn <span class="operator">=</span> <span class="number">2539984874</span></span><br><span class="line"></span><br><span class="line">compact <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">recover_binlog_info <span class="operator">=</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">恢复步骤：</span><br><span class="line"><span class="number">1</span>）模拟CSR</span><br><span class="line">[root<span class="variable">@db01</span> mysql]# innobackupex <span class="comment">--user=root --password=123 --apply-log /backup/full</span></span><br><span class="line"><span class="number">2</span>）前提<span class="number">1</span>：被恢复的目录是空的</span><br><span class="line">        a)mv <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span> <span class="operator">/</span>tmp</span><br><span class="line">        b)rm <span class="operator">-</span>fr <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data</span><br><span class="line">   前提<span class="number">2</span>：被恢复的数据库的实例是关闭的</span><br><span class="line">         systemctl stop mysqld</span><br><span class="line">         <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld stop</span><br><span class="line"><span class="number">3</span>）恢复数据</span><br><span class="line">[root<span class="variable">@db01</span> mysql]# innobackupex <span class="comment">--copy-back /backup/full</span></span><br><span class="line"><span class="number">4</span>）修改权限</span><br><span class="line">[root<span class="variable">@db01</span> mysql]# chown <span class="operator">-</span>R mysql.mysql <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">物理备份一定要打开</span><br><span class="line">vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir <span class="operator">=</span> <span class="operator">/</span>application<span class="operator">/</span>mysql</span><br><span class="line">datadir <span class="operator">=</span> <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>增量备份及恢复</strong><br><em>备份方式</em><br>1）基于上一次备份进行增量<br>2）增量备份无法单独恢复，必须基于全备进行恢复<br>3）所有增量必须要按顺序合并到全备当中</p>
<p>老男孩教育上海Linux3期MySQL-day11-03MySQL物理备份Xtrabackup进行增备及恢复讲解</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#不使用之前的全备，执行一次全备</span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db01 <span class="operator">~</span>]# innobackupex <span class="comment">--user=root --password=123 --no-timestamp /backup/full</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">增量备份及恢复</span><br><span class="line">1）全备</span><br><span class="line">[root@master ~]#innobackupex --user=root --password=456 --no-timestamp /backup/full</span><br><span class="line">2）模拟数据变化</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">create database inc1;</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">use inc1</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">create table incl_tab(<span class="built_in">id</span> int);</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">insert into incl_tab values(1),(2),(3);</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">commit;</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">select * from inc1_tab;</span></span><br><span class="line">+------+</span><br><span class="line">| id   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">3）增量备份，--incremental开启增量备份，--incremental-basedir指定上一次全备的路径</span><br><span class="line">[root@master ~]# innobackupex --user=root --password=456 --no-timestamp --incremental --incremental-basedir=/backup/full/ /backup/inc1</span><br><span class="line">查看增量数据</span><br><span class="line">[root@master ~]# ll /backup/inc1/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4）模拟第二次数据变化</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">create database inc2;</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">use inc2</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">create table inc2_tab(<span class="built_in">id</span> int);</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">insert into inc2_tab values(1),(2),(3);</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">commit;</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">select * from inc2_tab;</span></span><br><span class="line">+------+</span><br><span class="line">| id   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">5) 第二次增量备份</span><br><span class="line">[root@master ~]# innobackupex --user=root --password=456 --no-timestamp --incremental --incremental-basedir=/backup/inc1/ /backup/inc2</span><br><span class="line">[root@master ~]# ll /backup/</span><br><span class="line">[root@master ~]# cat /backup/full/xtrabackup_checkpoints</span><br><span class="line">[root@master ~]# cat /backup/inc1/xtrabackup_checkpoints</span><br><span class="line">[root@master ~]# cat /backup/inc2/xtrabackup_checkpoints</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">6）破坏数据</span><br><span class="line">[root@master ~]# /etc/init.d/mysqld stop</span><br><span class="line">[root@master ~]# rm -fr /application/mysql/data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">7）恢复</span><br><span class="line">    a) 在全备中模拟CSR但是 只做redo 不做 undo</span><br><span class="line">    [root@master ~]# innobackupex --apply-log --redo-only /backup/full/</span><br><span class="line">    b）合并第一次增备，只做redo不做undo</span><br><span class="line">    [root@master ~]# innobackupex --apply-log --redo-only --incremental-dir=/backup/inc1/ /backup/full/</span><br><span class="line">    c）合并第二次增备，redo undo都做（最后一次增备）</span><br><span class="line">    [root@master ~]# innobackupex --apply-log --incremental-dir=/backup/inc2/ /backup/full/</span><br><span class="line">    d）整体full目录再做一次redo undo模拟CSR</span><br><span class="line">    [root@master ~]# innobackupex --apply-log /backup/full/</span><br><span class="line">    e)执行copy-back恢复数据</span><br><span class="line">    [root@master ~]# innobackupex --copy-back /backup/full/</span><br><span class="line">8）修改权限</span><br><span class="line">    [root@master ~]# chown -R mysql.mysql /application/mysql/data/</span><br><span class="line">9）启动数据库</span><br><span class="line">    [root@master ~]# /etc/init.d/mysqld start</span><br><span class="line">10）查看数据恢复</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">select * from inc2_tab;</span></span><br><span class="line">+------+</span><br><span class="line">| id   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    2 |</span><br><span class="line">|    3 |</span><br><span class="line">+------+</span><br></pre></td></tr></table></figure>

<p>老男孩教育上海Linux3期MySQL-day11-04MySQL物理备份Xtrabackup进行差异备份及恢复讲解</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">差异备份：</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>）先做全备</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# innobackupex <span class="comment">--user=root --password=456 --no-timestamp /backup/full</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# cat <span class="operator">/</span>backup<span class="operator">/</span><span class="keyword">full</span><span class="operator">/</span>xtrabackup_checkpoints</span><br><span class="line">from_lsn <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">to_lsn <span class="operator">=</span> <span class="number">2563131</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span>）模拟数据变化</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database chayi1;</span><br><span class="line">mysql<span class="operator">&gt;</span> use chayi1;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> chayi1(id <span class="type">int</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> chayi1 <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>) 做差异备份</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# innobackupex <span class="comment">--user=root --password=456 --no-timestamp --incremental --incremental-basedir=/backup/full /backup/chayi1</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# cat <span class="operator">/</span>backup<span class="operator">/</span>chayi1<span class="operator">/</span>xtrabackup_checkpoints</span><br><span class="line">from_lsn <span class="operator">=</span> <span class="number">2563131</span></span><br><span class="line">to_lsn <span class="operator">=</span> <span class="number">2568751</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4</span>）模拟第二次数据变化</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database chayi2;</span><br><span class="line">mysql<span class="operator">&gt;</span> use chayi2</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> chayi2(id <span class="type">int</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> chayi2 <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>),(<span class="number">3</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# innobackupex <span class="comment">--user=root --password=456 --no-timestamp --incremental --incremental-basedir=/backup/full /backup/chayi2</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# cat <span class="operator">/</span>backup<span class="operator">/</span>chayi2<span class="operator">/</span>xtrabackup_checkpoints</span><br><span class="line">from_lsn <span class="operator">=</span> <span class="number">2563131</span></span><br><span class="line">to_lsn <span class="operator">=</span> <span class="number">2575083</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">6</span>）模拟数据损坏</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld stop</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# rm <span class="operator">-</span>fr <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">7</span>）恢复数据</span><br><span class="line">    a）全备只做redo</span><br><span class="line">    [root<span class="variable">@master</span> <span class="operator">~</span>]# innobackupex <span class="comment">--apply-log --redo-only /backup/full/</span></span><br><span class="line">    b）合并最后一次差异备份，redo undo都做</span><br><span class="line">    [root<span class="variable">@master</span> <span class="operator">~</span>]# innobackupex <span class="comment">--apply-log --incremental-dir=/backup/chayi2/ /backup/full/</span></span><br><span class="line">    [root<span class="variable">@master</span> <span class="operator">~</span>]# cat <span class="operator">/</span>backup<span class="operator">/</span><span class="keyword">full</span><span class="operator">/</span>xtrabackup_checkpoints</span><br><span class="line">    from_lsn <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    to_lsn <span class="operator">=</span> <span class="number">2575083</span></span><br><span class="line">    c）全备做redo undo模拟CSR</span><br><span class="line">    [root<span class="variable">@master</span> <span class="operator">~</span>]# innobackupex <span class="comment">--apply-log /backup/full/</span></span><br><span class="line">    d）执行<span class="keyword">copy</span><span class="operator">-</span>back恢复数据</span><br><span class="line">    [root<span class="variable">@master</span> <span class="operator">~</span>]# innobackupex <span class="comment">--copy-back /backup/full/</span></span><br><span class="line"><span class="number">8</span>）修改权限</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# chown <span class="operator">-</span>R mysql.mysql <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span></span><br><span class="line"><span class="number">9</span>）启动数据库</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld <span class="keyword">start</span></span><br><span class="line"><span class="number">10</span>)查看数据恢复</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line">mysql<span class="operator">&gt;</span> use chayi2</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span>  <span class="operator">*</span> <span class="keyword">from</span> chayi2;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>老男孩教育上海Linux3期MySQL-day12-02MySQL主从复制原理画图详细讲解<br>![[Pasted image 20220521192953.png]]</p>
<p>老男孩教育上海Linux3期MySQL-day12-03MySQL主从复制过程演示机讲解</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">主从复制步骤：</span><br><span class="line"><span class="number">1.</span>保证两台 实例数据一致性</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p123 <span class="operator">-</span>A <span class="operator">-</span>R <span class="comment">--triggers --master-data=2 --single-transaction &gt; /tmp/full.sql</span></span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# scp <span class="operator">/</span>tmp<span class="operator">/</span>full.sql <span class="number">172.16</span><span class="number">.1</span><span class="number">.52</span>:<span class="operator">/</span>tmp<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db02</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>tmp<span class="operator">/</span>full.sql</span><br><span class="line">从库刚初始化完，新库，导入主库全备</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>主库开启binlog,开启server_id</span><br><span class="line">vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">log<span class="operator">-</span>bin<span class="operator">=</span>mysql<span class="operator">-</span>bin</span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span></span><br><span class="line">server_id<span class="operator">=</span><span class="number">5</span></span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld restart</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>从库开启server_id,不用开启binlog,从库之间server_id可以相同,但是不等于主库</span><br><span class="line">[root<span class="variable">@db02</span><span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server_id<span class="operator">=</span><span class="number">10</span></span><br><span class="line">[root<span class="variable">@db02</span> <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld restart</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>在主库上创建主从复制用户</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> replication slave <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> slave@<span class="string">&#x27;172.16.1.5%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>在从库上change master,开启主从复制(IO <span class="keyword">SQL</span>)</span><br><span class="line">host: <span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span></span><br><span class="line"><span class="keyword">user</span>: slave</span><br><span class="line">password: <span class="number">123</span></span><br><span class="line"></span><br><span class="line">主库执行：<span class="keyword">show</span> master status；（没有在生产环境中提供服务的主库）</span><br><span class="line"></span><br><span class="line">在全备full.sql文件中 查找binlog file 名字 和 binlog pos（在生产环境中提供服务的主库）</span><br><span class="line">vim <span class="operator">/</span>tmp<span class="operator">/</span>full.sql</span><br><span class="line">log_file: mysql<span class="operator">-</span>bin<span class="number">.000001</span></span><br><span class="line">log_pos: <span class="number">317</span></span><br><span class="line"></span><br><span class="line"># 从库</span><br><span class="line">mysql<span class="operator">&gt;</span> change master <span class="keyword">to</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_host<span class="operator">=</span><span class="string">&#x27;172.16.1.51&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_user<span class="operator">=</span><span class="string">&#x27;slave&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_password<span class="operator">=</span><span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_log_file<span class="operator">=</span><span class="string">&#x27;mysql-bin.000001&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_log_pos<span class="operator">=</span><span class="number">317</span>;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> slave;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G</span><br><span class="line">        Slave_IO_Running: Yes</span><br><span class="line">        Slave_SQL_Running: Yes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">change master <span class="keyword">to</span></span><br><span class="line">master_host<span class="operator">=</span><span class="string">&#x27;192.168.160.3&#x27;</span>,</span><br><span class="line">master_user<span class="operator">=</span><span class="string">&#x27;slave&#x27;</span>,</span><br><span class="line">master_password<span class="operator">=</span><span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">master_log_file<span class="operator">=</span><span class="string">&#x27;mysql-bin.000003&#x27;</span>,</span><br><span class="line">master_log_pos<span class="operator">=</span><span class="number">120</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">主从复制排错IO线程：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>网络问题</span><br><span class="line">ping <span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>端口问题</span><br><span class="line">telnet <span class="number">172.16</span><span class="number">.1</span><span class="number">.51</span> <span class="number">3306</span></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>用户名，密码</span><br><span class="line">mysql <span class="operator">-</span>uslave <span class="operator">-</span>p123 <span class="operator">-</span>h172<span class="number">.16</span><span class="number">.1</span><span class="number">.51</span></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>没有跳过反向解析</span><br><span class="line">[mysqld]</span><br><span class="line">server_id<span class="operator">=</span><span class="number">10</span></span><br><span class="line"><span class="keyword">skip</span><span class="operator">-</span>name<span class="operator">-</span>resolve</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">延时从库：</span><br><span class="line"></span><br><span class="line">已经做好主从复制步骤：</span><br><span class="line">mysql<span class="operator">&gt;</span> stop slave;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> change master <span class="keyword">to</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_delay<span class="operator">=</span><span class="number">180</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> slave;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">没有做好主从复制的情况下：</span><br><span class="line">mysql<span class="operator">&gt;</span> change master <span class="keyword">to</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_host<span class="operator">=</span><span class="string">&#x27;172.16.1.51&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_user<span class="operator">=</span><span class="string">&#x27;slave&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_password<span class="operator">=</span><span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_log_file<span class="operator">=</span><span class="string">&#x27;mysql-bin.000001&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_log_pos<span class="operator">=</span><span class="number">317</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_delay<span class="operator">=</span><span class="number">180</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#关闭<span class="keyword">sql</span>线程</span><br><span class="line">mysql<span class="operator">&gt;</span> stop slave sql_thread;</span><br><span class="line"></span><br><span class="line">#主库建库一般要做个判断if <span class="keyword">not</span> exist</span><br><span class="line">mysql <span class="operator">&gt;</span> <span class="keyword">create</span> database if <span class="keyword">not</span> exist rep2;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql <span class="operator">&gt;</span> stop slave;</span><br><span class="line">#跳过一个错误</span><br><span class="line">mysql <span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> sql_slave_skip_counter<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">mysql <span class="operator">&gt;</span> <span class="keyword">start</span> slave;</span><br><span class="line">mysql <span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G</span><br><span class="line"></span><br><span class="line">#添加到从库配置文件，跳过指定的错误代码</span><br><span class="line">vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">slave<span class="operator">-</span><span class="keyword">skip</span><span class="operator">-</span>errors<span class="operator">=</span><span class="number">1032</span>,<span class="number">1062</span>,<span class="number">1007</span></span><br></pre></td></tr></table></figure>



<p>老男孩教育上海Linux3期MySQL-day13-02Xtrabackup物理恢复企业案例讲解</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line">xtrabackup企业案例思路：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span>停业务</span><br><span class="line"><span class="number">2.</span>准备一个新数据库</span><br><span class="line"><span class="number">3.</span>将周六全备<span class="operator">+</span>周日增备<span class="operator">+</span>周一增备<span class="operator">+</span>周二增备<span class="operator">+</span>周三的增备合并恢复到新库</span><br><span class="line"><span class="number">4.</span>截取周三<span class="number">00</span>：<span class="number">00</span>到<span class="number">14</span>：<span class="number">00</span>之间的binlog数据，恢复到新库中</span><br><span class="line"><span class="number">5.</span>测试功能</span><br><span class="line"><span class="number">6.</span>恢复业务</span><br><span class="line">  <span class="number">1</span>）将应用割接到新库当中</span><br><span class="line">  <span class="number">2</span>）把恢复好的表，导出恢复到生产库中</span><br><span class="line"><span class="number">7.</span>开启业务</span><br><span class="line"></span><br><span class="line">模拟数据：</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database xtrabackup;</span><br><span class="line">mysql<span class="operator">&gt;</span> use xtrabackup</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> xtrabackup(id <span class="type">int</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> xtrabackup <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>),(<span class="number">3</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">周六<span class="number">00</span>:<span class="number">00</span>全备:</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# innobackupex <span class="comment">--user=root --password=456 --no-timestamp /backup/full2</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# ll <span class="operator">/</span>backup<span class="operator">/</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 10 root root  273 6月  29 15:32 full2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">模拟周日增量数据：</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> use xtrabackup</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> xtrabackup1(id <span class="type">int</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> xtrabackup1 <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">周日增备：</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# innobackupex <span class="comment">--user=root --password=456 --no-timestamp --incremental --incremental-basedir=/backup/full2 /backup/inc1</span></span><br><span class="line">模拟周一增量数据：</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysgl<span class="operator">&gt;</span> use xtrabackup</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> xtrabackup2(id <span class="type">int</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> xtrabackup2 <span class="keyword">values</span>(<span class="number">1</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">周一增备：</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# innobackupex <span class="comment">--user=root --password=456 --no-timestamp --incremental --incremental-basedir=/backup/inc1 /backup/inc2</span></span><br><span class="line"></span><br><span class="line">模拟周二数据：</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> use xtrabackup</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> xtrabackup3(id <span class="type">int</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> xtrabackup3 <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">周二増备：</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# innobackupex <span class="comment">--user=root --password=456 --no-timestamp --incremental --incremental-basedir=/backup/inc2 /backup/inc3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">模拟周三数据：</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> use xtrabackup</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> xtrabackup4(id <span class="type">int</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> xtrabackup4 <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">2</span>),(<span class="number">3</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">周三<span class="number">00</span>:<span class="number">00</span>增备</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# innobackupex <span class="comment">--user=root --password=456 --no-timestamp --incremental --incremental-basedir=/backup/inc3 /backup/inc4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">模拟周三<span class="number">00</span>:<span class="number">00</span>到周三<span class="number">14</span>:<span class="number">00</span>数据</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p456</span><br><span class="line">mysql<span class="operator">&gt;</span> use xtrabackup</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_xtrabackup <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+</span></span><br><span class="line"><span class="operator">|</span> xtrabackup           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> xtrabackup1          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> xtrabackup2          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> xtrabackup3          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> xtrabackup4          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> xtrabackup5(id <span class="type">int</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> xtrabackup5 <span class="keyword">values</span>(<span class="number">1</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">14</span>:<span class="number">00</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">table</span> xtrabackup1;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">恢复步骤：</span><br><span class="line"><span class="number">1.</span>停业务</span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# systemctl stop nginx php<span class="operator">-</span>fpm tomcat</span><br><span class="line"><span class="number">2.</span>准备新库，不用起，删除data目录</span><br><span class="line">#查看<span class="number">3307</span>端口是否启动</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# netstat <span class="operator">-</span>lntup</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# ll <span class="operator">/</span>backup<span class="operator">/</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 10 root root  273 6月  29 15:32 full2</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 10 root root 4096 6月  29 15:42 inc1</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 10 root root 4096 6月  29 15:44 inc2</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 10 root root 4096 6月  29 15:47 inc3</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 10 root root 4096 6月  29 15:50 inc4</span></span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# cd <span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span></span><br><span class="line">[root<span class="variable">@db01</span> <span class="number">3307</span>]# rm <span class="operator">-</span>fr data<span class="operator">/</span></span><br><span class="line"><span class="number">3.</span>合并数据</span><br><span class="line">    #停库</span><br><span class="line">    [root<span class="variable">@master</span> <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld stop</span><br><span class="line">    <span class="number">1</span>）将周六全备只做redo不做undo</span><br><span class="line">    [root<span class="variable">@master</span> <span class="operator">~</span>]# innobackupex <span class="comment">--user=root --password=456 --apply-log --redo-only /backup/full2</span></span><br><span class="line">    <span class="number">2</span>）将周日增备合并到ful12中只做redo不做 undo</span><br><span class="line">    [root<span class="variable">@master</span> <span class="number">3307</span>]# innobackupex <span class="comment">--apply-log --redo-only --incremental-dir=/backup/inc1 /backup/full2</span></span><br><span class="line"></span><br><span class="line">    <span class="number">3</span>）将周一增备合并到full2中只做redo不做undo</span><br><span class="line">    [root<span class="variable">@master</span> <span class="number">3307</span>]# innobackupex <span class="comment">--apply-log --redo-only --incremental-dir=/backup/inc2 /backup/full2</span></span><br><span class="line">    <span class="number">4</span>）将周二増备合并到full2中只做redo不做undo</span><br><span class="line">    [root<span class="variable">@master</span> <span class="number">3307</span>]# innobackupex <span class="comment">--apply-log --redo-only --incremental-dir=/backup/inc3 /backup/full2</span></span><br><span class="line">    <span class="number">5</span>）将周二增备合并到full2中redo undo都做</span><br><span class="line">    [root<span class="variable">@master</span> backup]# innobackupex <span class="comment">--apply-log --incremental-dir=/backup/inc4 /backup/full2</span></span><br><span class="line">    <span class="number">6</span>）全备redo undo都做</span><br><span class="line">    [root<span class="variable">@master</span> backup]# innobackupex <span class="comment">--apply-log /backup/full2</span></span><br><span class="line">    #查看位置点</span><br><span class="line">    [root<span class="variable">@master</span> backup]# cat full2<span class="operator">/</span>xtrabackup_binlog_info</span><br><span class="line">    mysql<span class="operator">-</span>bin<span class="number">.000003</span>        <span class="number">2241</span></span><br><span class="line">    [root<span class="variable">@master</span> backup]# cat full2<span class="operator">/</span>xtrabackup_binlog_pos_innodb</span><br><span class="line">    mysql<span class="operator">-</span>bin<span class="number">.000003</span>        <span class="number">2241</span></span><br><span class="line">    [root<span class="variable">@master</span> backup]# cat inc4<span class="operator">/</span>xtrabackup_binlog_info</span><br><span class="line">    mysql<span class="operator">-</span>bin<span class="number">.000003</span>        <span class="number">2241</span></span><br><span class="line"><span class="number">4.</span>将数据恢复到新库并授权</span><br><span class="line">[root<span class="variable">@master</span> inc4]# innobackupex <span class="comment">--defaults-file=/data/3307/my.cnf --copy-back /backup/full2</span></span><br><span class="line">[root<span class="variable">@master</span> inc4]# chown <span class="operator">-</span>R mysql.mysql <span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>启动数据库并测试</span><br><span class="line">[root<span class="variable">@master</span> inc4]# mysqld_safe <span class="comment">--defaults-file=/data/3307/my.cnf &amp;</span></span><br><span class="line">[root<span class="variable">@master</span> inc4]# netstat <span class="operator">-</span>lntup</span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">3307</span>                 :::<span class="operator">*</span>                    LISTEN      <span class="number">103971</span><span class="operator">/</span>mysqld</span><br><span class="line">[root<span class="variable">@master</span> inc4]# vim <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>bin<span class="operator">/</span>mysql3307</span><br><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">-</span>S <span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span>data<span class="operator">/</span>mysql.sock</span><br><span class="line">[root<span class="variable">@master</span> inc4]# mysql3307</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> world              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> xtrabackup         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> use xtrabackup</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_xtrabackup <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+</span></span><br><span class="line"><span class="operator">|</span> xtrabackup           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> xtrabackup1          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> xtrabackup2          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> xtrabackup3          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> xtrabackup4          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">6.</span>截取binlog</span><br><span class="line">[root<span class="variable">@master</span> inc4]# cat xtrabackup_binlog_info</span><br><span class="line">mysql<span class="operator">-</span>bin<span class="number">.000003</span>        <span class="number">2241</span></span><br><span class="line">[root<span class="variable">@master</span> inc4]# mysqlbinlog <span class="comment">--base64-output=decode-rows -vvv /application/mysql/data/mysql-bin.000003</span></span><br><span class="line"><span class="keyword">COMMIT</span><span class="comment">/*!*/</span>;</span><br><span class="line"># <span class="keyword">at</span> <span class="number">2568</span>  #<span class="keyword">drop</span>之前，<span class="keyword">commit</span>之后</span><br><span class="line"></span><br><span class="line"><span class="keyword">start</span><span class="operator">-</span>position<span class="operator">=</span><span class="number">2241</span>    stop<span class="operator">-</span>position<span class="operator">=</span><span class="number">2568</span></span><br><span class="line">[root<span class="variable">@master</span> inc4]# mysqlbinlog <span class="comment">--start-position=2241 --stop-position=2568 /application/mysql/data/mysql-bin.000003 &gt; /backup/inc6.sql</span></span><br><span class="line"></span><br><span class="line"><span class="number">7.</span>恢复增量数据到新库</span><br><span class="line">[root<span class="variable">@master</span> inc4]# vim <span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span></span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span>data</span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span>data<span class="operator">/</span>mysql.sock</span><br><span class="line">port<span class="operator">=</span><span class="number">3307</span></span><br><span class="line">log_error<span class="operator">=</span><span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span>mysql.err</span><br><span class="line">log<span class="operator">-</span>bin<span class="operator">=</span><span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span>mysql<span class="operator">-</span>bin</span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span>  #添加行级模式</span><br><span class="line">server_id<span class="operator">=</span><span class="number">7</span></span><br><span class="line">#重启数据库</span><br><span class="line">[root<span class="variable">@master</span> inc4]# netstat <span class="operator">-</span>lntup</span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">3307</span>                 :::<span class="operator">*</span>                    LISTEN      <span class="number">103971</span><span class="operator">/</span>mysqld</span><br><span class="line">[root<span class="variable">@master</span> inc4]# kill <span class="number">103971</span></span><br><span class="line">[root<span class="variable">@master</span> inc4]# mysqld_safe <span class="comment">--defaults-file=/data/3307/my.cnf &amp;</span></span><br><span class="line">[root<span class="variable">@master</span> inc4]# netstat <span class="operator">-</span>lntup</span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">3307</span>                 :::<span class="operator">*</span>                    LISTEN      <span class="number">106370</span><span class="operator">/</span>mysqld</span><br><span class="line">[root<span class="variable">@master</span> inc4]# mysql3307</span><br><span class="line">mysql<span class="operator">&gt;</span> source <span class="operator">/</span>backup<span class="operator">/</span>inc6.sql</span><br><span class="line"></span><br><span class="line"><span class="number">8.</span>恢复业务</span><br><span class="line">    <span class="number">1</span>）将应用割接到新库当中</span><br><span class="line">    <span class="number">2</span>）把恢复好的表，导出恢复到生产库中</span><br><span class="line">    [root<span class="variable">@master</span> inc4]# mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">-</span>S <span class="operator">/</span>data<span class="operator">/</span><span class="number">3307</span><span class="operator">/</span>data<span class="operator">/</span>mysql.sock xtrabackup xtrabackup1 <span class="operator">&gt;</span> <span class="operator">/</span>backup<span class="operator">/</span>xtrabackup1.sql</span><br><span class="line">    [root<span class="variable">@master</span> inc4]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld <span class="keyword">start</span></span><br><span class="line">    [root<span class="variable">@master</span> inc4]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p456</span><br><span class="line">    mysql<span class="operator">&gt;</span> use xtrabackup</span><br><span class="line">    mysql<span class="operator">&gt;</span> source <span class="operator">/</span>backup<span class="operator">/</span>xtrabackup1.sql</span><br><span class="line">    #第二种导入方式</span><br><span class="line">    [root<span class="variable">@db01</span> inc4]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p456 xtrabackup <span class="operator">&lt;</span> <span class="operator">/</span>backup<span class="operator">/</span>xtrabackup1.sql</span><br><span class="line"></span><br><span class="line"><span class="number">9.</span>启动业务</span><br><span class="line">[root<span class="variable">@db01</span> inc4]# systemctl <span class="keyword">start</span> nginx php<span class="operator">-</span>fpm tomcat</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>老男孩教育上海Linux3期MySQL-day13-03企业案例利用延时从库恢复数据讲解</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">延时从库</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[client]</span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>root</span><br><span class="line">password<span class="operator">=</span><span class="number">456</span></span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G</span><br><span class="line">    Slave_IO_Running: Yes</span><br><span class="line">    Slave_SQL_Running: Yes</span><br><span class="line">mysql<span class="operator">&gt;</span> stop slave;</span><br><span class="line">mysql<span class="operator">&gt;</span> change master <span class="keyword">to</span> master_delay<span class="operator">=</span><span class="number">3600</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> slave;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G</span><br><span class="line">    SQL_Delay: <span class="number">3600</span></span><br><span class="line"></span><br><span class="line">主库</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database xtrabackup;</span><br><span class="line"></span><br><span class="line">#停止延时从库<span class="keyword">SQL</span>线程</span><br><span class="line">mysql<span class="operator">&gt;</span> stop slave sql_thread;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">主库模拟增量数据</span><br><span class="line">mysql<span class="operator">&gt;</span> use inc1</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_inc1 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> inc1_tab       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> inc1_tab;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> inc1_tab <span class="keyword">values</span>(<span class="number">4</span>),(<span class="number">5</span>),(<span class="number">6</span>);</span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> inc1_tab;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"></span><br><span class="line">延时从库</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">-</span>B xtrabackup <span class="operator">&gt;</span> <span class="operator">/</span>tmp<span class="operator">/</span>xtrabackup.sql</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# scp <span class="operator">/</span>tmp<span class="operator">/</span>xtrabackup.sql <span class="number">192.168</span><span class="number">.160</span><span class="number">.3</span>:<span class="operator">/</span>tmp</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# mysqlbinlog <span class="comment">--base64-output=decode-rows -vvv /application/mysql/data/node1-relay-bin.000002</span></span><br><span class="line"><span class="keyword">drop</span> database xtrabackup</span><br><span class="line"><span class="comment">/*!*/</span>;</span><br><span class="line"># <span class="keyword">at</span> <span class="number">393</span>  #<span class="keyword">drop</span>之前</span><br><span class="line">end_log_pos <span class="number">1244</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# mysqlbinlog <span class="comment">--start-position=393 --stop-position=1242 /application/mysql/data/node1-relay-bin.000002</span></span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# mysqlbinlog <span class="comment">--start-position=393 --stop-position=1242 /application/mysql/data/node1-relay-bin.000002 &gt; /tmp/inc1.sql</span></span><br><span class="line"></span><br><span class="line">主库</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database inc1;</span><br><span class="line"></span><br><span class="line">从库</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# mysqldump <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">-</span>B xtrabackup inc1 <span class="operator">&gt;</span> <span class="operator">/</span>tmp<span class="operator">/</span>test.sql</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# scp <span class="operator">/</span>tmp<span class="operator">/</span>test.sql <span class="number">192.168</span><span class="number">.160</span><span class="number">.3</span>:<span class="operator">/</span>tmp</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# mysqlbinlog <span class="comment">--base64-output=decode-rows -vvv /application/mysql/data/node1-relay-bin.000002</span></span><br><span class="line"><span class="keyword">COMMIT</span><span class="comment">/*!*/</span>;</span><br><span class="line"># <span class="keyword">at</span> <span class="number">597</span></span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# mysqlbinlog <span class="comment">--start-position=393 --stop-position=597 /application/mysql/data/node1-relay-bin.000002 &gt; /tmp/inc1.sql</span></span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# scp <span class="operator">/</span>tmp<span class="operator">/</span>inc1.sql <span class="number">192.168</span><span class="number">.160</span><span class="number">.3</span>:<span class="operator">/</span>tmp</span><br><span class="line"></span><br><span class="line">主库</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">&lt;</span> <span class="operator">/</span>tmp<span class="operator">/</span>test.sql</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">&lt;</span> <span class="operator">/</span>tmp<span class="operator">/</span>inc1.sql</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line">mysql<span class="operator">&gt;</span> use inc1</span><br><span class="line">Reading <span class="keyword">table</span> information <span class="keyword">for</span> completion <span class="keyword">of</span> <span class="keyword">table</span> <span class="keyword">and</span> <span class="keyword">column</span> names</span><br><span class="line">You can turn off this feature <span class="keyword">to</span> <span class="keyword">get</span> a quicker startup <span class="keyword">with</span> <span class="operator">-</span>A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_inc1 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> inc1_tab       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> inc1_tab;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">从库</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# mysql</span><br><span class="line">#恢复开启<span class="keyword">SQL</span>线程</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> slave sql_thread;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>老男孩教育上海Linux3期MySQL-day13-04MySQL半同步复制讲解<br><strong>半同步复制开启方法</strong><br>1）安装（主库）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#查看是否有动态支持</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> variables <span class="keyword">like</span> <span class="string">&#x27;have_dynamic_loading&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name        <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> have_dynamic_loading <span class="operator">|</span> YES   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+-------+</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# ll <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>lib<span class="operator">/</span>plugin<span class="operator">/</span></span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> mysql mysql <span class="number">522184</span> <span class="number">6</span>月  <span class="number">27</span> <span class="number">23</span>:<span class="number">49</span> semisync_master.so</span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> mysql mysql <span class="number">282888</span> <span class="number">6</span>月  <span class="number">27</span> <span class="number">23</span>:<span class="number">50</span> semisync_slave.so</span><br><span class="line">#安装自带插件</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> INSTALL PLUGIN rpl_semi_sync_master SONAME<span class="string">&#x27;semisync_master.so&#x27;</span>;</span><br><span class="line">#启动插件（临时开启）</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> <span class="keyword">GLOBAL</span> rpl_semi_sync_master_enabled <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">#设置超时</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> <span class="keyword">GLOBAL</span> rpl_semi_sync_master_timeout <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">#修改配置文件(永久开启) </span><br><span class="line">[root<span class="variable">@db01</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf  </span><br><span class="line">#在[mysqld]标签下添加如下内容（不用重启库）  </span><br><span class="line">[mysqld]  </span><br><span class="line">rpl_semi_sync_master_enabled<span class="operator">=</span><span class="number">1</span>  </span><br><span class="line">rpl_semi_sync_master_timeout<span class="operator">=</span><span class="number">1000</span>  </span><br><span class="line">检查安装：  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span><span class="string">&#x27;rpl%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                      <span class="operator">|</span> <span class="keyword">Value</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> rpl_semi_sync_master_enabled       <span class="operator">|</span> <span class="keyword">ON</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> rpl_semi_sync_master_timeout       <span class="operator">|</span> <span class="number">1000</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------------+----------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;rpl_semi%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                              <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_clients               <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+</span></span><br><span class="line"></span><br><span class="line">#安装从库后查看clients<span class="operator">=</span><span class="number">1</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;rpl_semi%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                              <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_clients               <span class="operator">|</span> <span class="number">1</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2）安装（从库）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#登录数据库  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db02 <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p456 </span><br><span class="line">#安装slave半同步插件  </span><br><span class="line">mysql<span class="operator">&gt;</span> INSTALL PLUGIN rpl_semi_sync_slave SONAME<span class="string">&#x27;semisync_slave.so&#x27;</span>;  </span><br><span class="line">#启动插件  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> <span class="keyword">GLOBAL</span> rpl_semi_sync_slave_enabled <span class="operator">=</span> <span class="number">1</span>;  </span><br><span class="line">#重启io线程使其生效  </span><br><span class="line">mysql<span class="operator">&gt;</span> stop slave io_thread;  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> slave io_thread;  </span><br><span class="line">#编辑配置文件（不需要重启数据库）  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db02 <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf  </span><br><span class="line">#在[mysqld]标签下添加如下内容  </span><br><span class="line">[mysqld]  </span><br><span class="line">rpl_semi_sync_slave_enabled <span class="operator">=</span><span class="number">1</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span><span class="string">&#x27;rpl%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                   <span class="operator">|</span> <span class="keyword">Value</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> rpl_semi_sync_slave_enabled     <span class="operator">|</span> <span class="keyword">ON</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> rpl_semi_sync_slave_trace_level <span class="operator">|</span> <span class="number">32</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> rpl_stop_slave_timeout          <span class="operator">|</span> <span class="number">31536000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+----------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;rpl_semi%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name              <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_slave_status <span class="operator">|</span> <span class="keyword">ON</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+-------+</span></span><br></pre></td></tr></table></figure>

<p><strong>测试半同步</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">#创建两个数据库，test1和test2  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database test1;  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database test2;    </span><br><span class="line">#查看复制状态  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;rpl_semi%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                              <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_clients               <span class="operator">|</span> <span class="number">1</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_net_avg_wait_time     <span class="operator">|</span> <span class="number">574</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_net_wait_time         <span class="operator">|</span> <span class="number">1149</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_net_waits             <span class="operator">|</span> <span class="number">2</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_no_times              <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_no_tx                 <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_status                <span class="operator">|</span> <span class="keyword">ON</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_timefunc_failures     <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_tx_avg_wait_time      <span class="operator">|</span> <span class="number">743</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_tx_wait_time          <span class="operator">|</span> <span class="number">1486</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_tx_waits              <span class="operator">|</span> <span class="number">2</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_wait_pos_backtraverse <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_wait_sessions         <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line">#此行显示<span class="number">2</span>，表示刚才创建的两个库执行了半同步</span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_yes_tx                <span class="operator">|</span> <span class="number">2</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+</span></span><br><span class="line"></span><br><span class="line">#从库查看  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+  </span></span><br><span class="line"><span class="operator">|</span> Database <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+  </span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> mysql <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> test <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> test1 <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> test2 <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+  </span></span><br><span class="line">#关闭半同步（<span class="number">1</span>:开启 <span class="number">0</span>:关闭）  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> <span class="keyword">GLOBAL</span> rpl_semi_sync_master_enabled <span class="operator">=</span> <span class="number">0</span>;  </span><br><span class="line">#查看半同步状态  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;rpl_semi%&#x27;</span>;  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+  </span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+  </span></span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_clients <span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_net_avg_wait_time <span class="operator">|</span> <span class="number">768</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_net_wait_time <span class="operator">|</span> <span class="number">1497</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_net_waits <span class="operator">|</span> <span class="number">2</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_no_times <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_no_tx <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_status <span class="operator">|</span> OFF <span class="operator">|</span> #状态为关闭  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_timefunc_failures <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_tx_avg_wait_time <span class="operator">|</span> <span class="number">884</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_tx_wait_time <span class="operator">|</span> <span class="number">1769</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_tx_waits <span class="operator">|</span> <span class="number">2</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_wait_pos_backtraverse <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_wait_sessions <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_yes_tx <span class="operator">|</span> <span class="number">2</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+  </span></span><br><span class="line"><span class="number">14</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)  </span><br><span class="line">  </span><br><span class="line">#再一次创建两个库  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database test3;  </span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database test4;  </span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)  </span><br><span class="line">  </span><br><span class="line">#再一次查看半同步状态  </span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> status <span class="keyword">like</span> <span class="string">&#x27;rpl_semi%&#x27;</span>;  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+  </span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+  </span></span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_clients <span class="operator">|</span> <span class="number">1</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_net_avg_wait_time <span class="operator">|</span> <span class="number">768</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_net_wait_time <span class="operator">|</span> <span class="number">1497</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_net_waits <span class="operator">|</span> <span class="number">2</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_no_times <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_no_tx <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_status <span class="operator">|</span> OFF <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_timefunc_failures <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_tx_avg_wait_time <span class="operator">|</span> <span class="number">884</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_tx_wait_time <span class="operator">|</span> <span class="number">1769</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_tx_waits <span class="operator">|</span> <span class="number">2</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_wait_pos_backtraverse <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_wait_sessions <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span>  </span><br><span class="line">#此行还是显示<span class="number">2</span>，则证明，刚才的那两条并没有执行半同步否则应该是<span class="number">4</span>  </span><br><span class="line"><span class="operator">|</span> Rpl_semi_sync_master_yes_tx <span class="operator">|</span> <span class="number">2</span> <span class="operator">|</span>  </span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+-------+  </span></span><br><span class="line"><span class="number">14</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)  </span><br><span class="line">注:不难发现，在查询半同步状态是，开启半同步，查询会有延迟时间，关闭之后则没有  </span><br><span class="line">&#123;<span class="number">1</span>&#125;</span><br></pre></td></tr></table></figure>


<p>老男孩教育上海Linux3期MySQL-day13-05MySQL过滤复制讲解</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">从库</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server_id<span class="operator">=</span><span class="number">10</span></span><br><span class="line"><span class="keyword">skip</span><span class="operator">-</span>name<span class="operator">-</span>resolve</span><br><span class="line">replicate<span class="operator">-</span>do<span class="operator">-</span>db<span class="operator">=</span>wangzherongyao  #添加</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld restart</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G</span><br><span class="line">    Replicate_Do_DB: wangzherongyao</span><br><span class="line"></span><br><span class="line">主库</span><br><span class="line">mysql<span class="operator">&gt;</span> use wangzherongyao</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> wangzherongyao(id <span class="type">int</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> wangzherongyao <span class="keyword">values</span>(<span class="number">1</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line">从库</span><br><span class="line">mysql<span class="operator">&gt;</span> use wangzherongyao</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_wangzherongyao <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+</span></span><br><span class="line"><span class="operator">|</span> wangzherongyao           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> wangzherongyao;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"></span><br><span class="line">主库</span><br><span class="line">mysql<span class="operator">&gt;</span> use chiji</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> chiji(id <span class="type">int</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> chiji <span class="keyword">values</span>(<span class="number">1</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line">从库</span><br><span class="line">mysql<span class="operator">&gt;</span> use chiji</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>老男孩教育上海Linux3期MySQL-day13-07MySQL高可用MHA工作原理画图讲解<br>![[Pasted image 20220629210913.png]]</p>
<h1 id="老男孩教育上海Linux3期MySQL-day13-08MySQL高可用MHA架构讲解"><a href="#老男孩教育上海Linux3期MySQL-day13-08MySQL高可用MHA架构讲解" class="headerlink" title="老男孩教育上海Linux3期MySQL-day13-08MySQL高可用MHA架构讲解"></a>老男孩教育上海Linux3期MySQL-day13-08MySQL高可用MHA架构讲解</h1><p><img src="D:\文件管理\Typora\images\linux.assest\image-20220629212151904.png" alt="image-20220629212151904"></p>
<h1 id="老男孩教育上海Linux3期MySQL-day13-09MySQL高可用MHA工具包讲解"><a href="#老男孩教育上海Linux3期MySQL-day13-09MySQL高可用MHA工具包讲解" class="headerlink" title="老男孩教育上海Linux3期MySQL-day13-09MySQL高可用MHA工具包讲解"></a>老男孩教育上海Linux3期MySQL-day13-09MySQL高可用MHA工具包讲解</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#安装依赖包</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# yum install perl<span class="operator">-</span>DBD<span class="operator">-</span>MySQL <span class="operator">-</span>y</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# yum install perl<span class="operator">-</span>DBD<span class="operator">-</span>MySQL <span class="operator">-</span>y</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# yum install perl<span class="operator">-</span>DBD<span class="operator">-</span>MySQL <span class="operator">-</span>y</span><br><span class="line">#安装manager节点依赖，安装在第三台，</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# yum install <span class="operator">-</span>y perl<span class="operator">-</span>Config<span class="operator">-</span>Tiny epel<span class="operator">-</span><span class="keyword">release</span> perl<span class="operator">-</span>Log<span class="operator">-</span>Dispatch perl<span class="operator">-</span>Parallel<span class="operator">-</span>ForkManager perl<span class="operator">-</span><span class="type">Time</span><span class="operator">-</span>HiRes</span><br><span class="line">#解压源码包</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# tar xf mha4mysql<span class="operator">-</span>manager<span class="number">-0.58</span>.tar.gz</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# cd <span class="operator">/</span>root<span class="operator">/</span>mha4mysql<span class="operator">-</span>manager<span class="number">-0.58</span><span class="operator">/</span>bin</span><br><span class="line">[root<span class="variable">@master</span> bin]# ll</span><br><span class="line">总用量 <span class="number">40</span></span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> mysql mysql <span class="number">1995</span> <span class="number">3</span>月  <span class="number">23</span> <span class="number">2018</span> masterha_check_repl  #检查主从状态</span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> mysql mysql <span class="number">1779</span> <span class="number">3</span>月  <span class="number">23</span> <span class="number">2018</span> masterha_check_ssh  #检查SSH</span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> mysql mysql <span class="number">1865</span> <span class="number">3</span>月  <span class="number">23</span> <span class="number">2018</span> masterha_check_status  #检查MHA启动状态 systemctl status mha</span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> mysql mysql <span class="number">3201</span> <span class="number">3</span>月  <span class="number">23</span> <span class="number">2018</span> masterha_conf_host  #配置配置文件里的server标签</span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> mysql mysql <span class="number">2517</span> <span class="number">3</span>月  <span class="number">23</span> <span class="number">2018</span> masterha_manager  #启动mha，mysqld_safe</span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> mysql mysql <span class="number">2165</span> <span class="number">3</span>月  <span class="number">23</span> <span class="number">2018</span> masterha_master_monitor  #监测主库心跳</span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> mysql mysql <span class="number">2373</span> <span class="number">3</span>月  <span class="number">23</span> <span class="number">2018</span> masterha_master_switch  #切换数据库</span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> mysql mysql <span class="number">5172</span> <span class="number">3</span>月  <span class="number">23</span> <span class="number">2018</span> masterha_secondary_check  #TCP<span class="operator">/</span>IP连接的</span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> mysql mysql <span class="number">1739</span> <span class="number">3</span>月  <span class="number">23</span> <span class="number">2018</span> masterha_stop  #停止MHA  mysqladmin shutdown</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# tar xf mha4mysql<span class="operator">-</span>manager<span class="number">-0.58</span>.tar.gz</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# tar xf mha4mysql<span class="operator">-</span>node<span class="number">-0.58</span>.tar.gz</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# cd <span class="operator">/</span>root<span class="operator">/</span>mha4mysql<span class="operator">-</span>node<span class="number">-0.58</span><span class="operator">/</span>bin</span><br><span class="line">[root<span class="variable">@master</span> bin]# ll</span><br><span class="line">总用量 <span class="number">48</span></span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> mysql mysql <span class="number">17639</span> <span class="number">3</span>月  <span class="number">23</span> <span class="number">2018</span> apply_diff_relay_logs  #对比relay<span class="operator">-</span>log</span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> mysql mysql  <span class="number">4807</span> <span class="number">3</span>月  <span class="number">23</span> <span class="number">2018</span> filter_mysqlbinlog  #截取日志</span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> mysql mysql  <span class="number">8337</span> <span class="number">3</span>月  <span class="number">23</span> <span class="number">2018</span> purge_relay_logs  #清除relay<span class="operator">-</span>log</span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> mysql mysql  <span class="number">7525</span> <span class="number">3</span>月  <span class="number">23</span> <span class="number">2018</span> save_binary_logs  #保存binlog</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>老男孩教育上海Linux3期MySQL-day13-11MySQL高可用MHA安装先决条件准备</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%gtid%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                   <span class="operator">|</span> <span class="keyword">Value</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> binlog_gtid_simple_recovery     <span class="operator">|</span> OFF       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> enforce_gtid_consistency        <span class="operator">|</span> OFF       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_executed                   <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_mode                       <span class="operator">|</span> OFF       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_next                       <span class="operator">|</span> AUTOMATIC <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_owned                      <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_purged                     <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> simplified_binlog_gtid_recovery <span class="operator">|</span> OFF       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-----------+</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">skip_name_resolve</span><br><span class="line">log<span class="operator">-</span>bin<span class="operator">=</span>mysql<span class="operator">-</span>bin</span><br><span class="line">secure<span class="operator">-</span>file<span class="operator">-</span>priv<span class="operator">=</span><span class="operator">/</span>tmp</span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span></span><br><span class="line">basedir<span class="operator">=</span><span class="operator">/</span>application<span class="operator">/</span>mysql</span><br><span class="line">datadir<span class="operator">=</span><span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data</span><br><span class="line">socket<span class="operator">=</span><span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>tmp<span class="operator">/</span>mysql.sock</span><br><span class="line">slow_query_log<span class="operator">=</span><span class="number">1</span></span><br><span class="line">slow_query_log_file<span class="operator">=</span><span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>slow.log</span><br><span class="line">long_query_time<span class="operator">=</span><span class="number">0.05</span></span><br><span class="line">autocommit<span class="operator">=</span><span class="number">0</span></span><br><span class="line">server_id<span class="operator">=</span><span class="number">5</span></span><br><span class="line">gtid_mode<span class="operator">=</span><span class="keyword">ON</span>  #添加</span><br><span class="line">enforce_gtid_consistency  #添加</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# tail <span class="number">-100</span> <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>master.err</span><br><span class="line"><span class="number">2022</span><span class="number">-06</span><span class="number">-29</span> <span class="number">23</span>:<span class="number">56</span>:<span class="number">43</span> <span class="number">27444</span> [ERROR] <span class="comment">--gtid-mode=ON or UPGRADE_STEP_1 or UPGRADE_STEP_2 requires --log-bin and --log-slave-updates</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">log<span class="operator">-</span>slave<span class="operator">-</span>updates  #添加（三种情况要开，双主、级联复制、GTID）</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld restart</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%gtid%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                   <span class="operator">|</span> <span class="keyword">Value</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> binlog_gtid_simple_recovery     <span class="operator">|</span> OFF       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> enforce_gtid_consistency        <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_executed                   <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_mode                       <span class="operator">|</span> <span class="keyword">ON</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_next                       <span class="operator">|</span> AUTOMATIC <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_owned                      <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_purged                     <span class="operator">|</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> simplified_binlog_gtid_recovery <span class="operator">|</span> OFF       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-----------+</span></span><br><span class="line">#把三个配置添加到其他从库</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server_id<span class="operator">=</span><span class="number">10</span></span><br><span class="line"><span class="keyword">skip</span><span class="operator">-</span>name<span class="operator">-</span>resolve</span><br><span class="line">gtid_mode<span class="operator">=</span><span class="keyword">ON</span>  #添加</span><br><span class="line">enforce_gtid_consistency  #添加</span><br><span class="line">log<span class="operator">-</span>slave<span class="operator">-</span>updates  #添加</span><br><span class="line">log<span class="operator">-</span>bin<span class="operator">=</span>mysql<span class="operator">-</span>bin  #还需要添加（做gtid主从复制的时候需要开启）</span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span>  #还需要添加（做gtid主从复制的时候需要开启）</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">server_id<span class="operator">=</span><span class="number">10</span></span><br><span class="line"><span class="keyword">skip</span><span class="operator">-</span>name<span class="operator">-</span>resolve</span><br><span class="line">gtid_mode<span class="operator">=</span><span class="keyword">ON</span>  #添加</span><br><span class="line">enforce_gtid_consistency  #添加</span><br><span class="line">log<span class="operator">-</span>slave<span class="operator">-</span>updates  #添加</span><br><span class="line">log<span class="operator">-</span>bin<span class="operator">=</span>mysql<span class="operator">-</span>bin  #还需要添加（做gtid主从复制的时候需要开启）</span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span>  #还需要添加（做gtid主从复制的时候需要开启）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#gtid是由tid<span class="operator">+</span>uuid组成的，tid是一个唯一标识符，uuid也是标识符</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# cat <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data<span class="operator">/</span>auto.cnf</span><br><span class="line">[auto]</span><br><span class="line">server<span class="operator">-</span>uuid<span class="operator">=</span><span class="number">282</span>b00ad<span class="operator">-</span>f693<span class="number">-11</span>ec<span class="operator">-</span>baba<span class="number">-000</span>c2925dbbc</span><br><span class="line">例如：#uuid:tid  <span class="number">282</span>b00ad<span class="operator">-</span>f693<span class="number">-11</span>ec<span class="operator">-</span>baba<span class="number">-000</span>c2925dbbc:<span class="number">1</span>（gtid是唯一的标识符）</span><br><span class="line">#url 统一资源定位符</span><br><span class="line">gitd优点：</span><br><span class="line">#<span class="number">1.</span>效率高，速度快，在每一个库都开启一个<span class="keyword">SQL</span>线程</span><br><span class="line">#<span class="number">2.</span><span class="type">row</span>，节省网络资源，磁盘资源，内存使用率。</span><br><span class="line">#<span class="number">3.</span>传统主从，file mysql<span class="operator">-</span>bin<span class="number">.000001</span> pos <span class="number">120</span>，不需要找。master_auto_position<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">#<span class="number">4.</span>将主从的信息记录在tables中，提高了可用性。</span><br><span class="line">#<span class="number">5.</span>支持所有复制，包括延时。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">开启gtid主从复制</span><br><span class="line">从库</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G</span><br><span class="line">mysql<span class="operator">&gt;</span> stop slave;</span><br><span class="line">mysql<span class="operator">&gt;</span> reset slave <span class="keyword">all</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">mysql<span class="operator">&gt;</span> change master <span class="keyword">to</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_host<span class="operator">=</span><span class="string">&#x27;192.168.160.3&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_user<span class="operator">=</span><span class="string">&#x27;slave&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_password<span class="operator">=</span><span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_auto_position<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> slave;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G</span><br><span class="line">    Slave_IO_Running: Yes</span><br><span class="line">    Slave_SQL_Running: Yes</span><br><span class="line">    Auto_Position: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G</span><br><span class="line">mysql<span class="operator">&gt;</span> stop slave;</span><br><span class="line">mysql<span class="operator">&gt;</span> reset slave <span class="keyword">all</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">mysql<span class="operator">&gt;</span> change master <span class="keyword">to</span></span><br><span class="line">master_host<span class="operator">=</span><span class="string">&#x27;192.168.160.3&#x27;</span>,</span><br><span class="line">master_user<span class="operator">=</span><span class="string">&#x27;slave&#x27;</span>,</span><br><span class="line">master_password<span class="operator">=</span><span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">master_auto_position<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G</span><br><span class="line">    Slave_IO_Running: Yes</span><br><span class="line">    Slave_SQL_Running: Yes</span><br><span class="line">    Auto_Position: <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">主库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database gtid;</span><br><span class="line">mysql<span class="operator">&gt;</span> mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+----------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set                      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+----------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000008</span> <span class="operator">|</span>      <span class="number">293</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span> <span class="number">282</span>b00ad<span class="operator">-</span>f693<span class="number">-11</span>ec<span class="operator">-</span>baba<span class="number">-000</span>c2925dbbc:<span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+----------------------------------------+</span></span><br><span class="line">Binlog_Do_DB  #允许的（过滤复制）</span><br><span class="line">Binlog_Ignore_DB  #忽略的（过滤复制）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">从库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G</span><br><span class="line">    Retrieved_Gtid_Set: <span class="number">282</span>b00ad<span class="operator">-</span>f693<span class="number">-11</span>ec<span class="operator">-</span>baba<span class="number">-000</span>c2925dbbc:<span class="number">1</span></span><br><span class="line">    Executed_Gtid_Set: <span class="number">282</span>b00ad<span class="operator">-</span>f693<span class="number">-11</span>ec<span class="operator">-</span>baba<span class="number">-000</span>c2925dbbc:<span class="number">1</span></span><br><span class="line">    Auto_Position: <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">主库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> database gtid;</span><br><span class="line"></span><br><span class="line">从库</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G</span><br><span class="line">           Retrieved_Gtid_Set: <span class="number">282</span>b00ad<span class="operator">-</span>f693<span class="number">-11</span>ec<span class="operator">-</span>baba<span class="number">-000</span>c2925dbbc:<span class="number">1</span><span class="number">-2</span></span><br><span class="line">            Executed_Gtid_Set: <span class="number">282</span>b00ad<span class="operator">-</span>f693<span class="number">-11</span>ec<span class="operator">-</span>baba<span class="number">-000</span>c2925dbbc:<span class="number">1</span><span class="number">-2</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>老男孩教育上海Linux3期MySQL-day13-12MySQL高可用MHA主从复制环境准备</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">当Master出现故障时，它可以自动将最新数据的Slave提升为新的Master,然后将所有其他的Slave重新指向新的Master。</span><br><span class="line"></span><br><span class="line">传统主从复制：</span><br><span class="line">1.主库开启binlog,从库不开启binlog</span><br><span class="line">2.server_id：主库和从库不同，从库可以相同</span><br><span class="line">3.主库要有主从复制用户，从库不需要</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">MHA的主从：</span><br><span class="line">一定要有主从复制</span><br><span class="line">1.主库开启binlog，从库也必须开启binlog</span><br><span class="line">2.server_id：主库和从库不同，从库之间也不能相同</span><br><span class="line">3.主库要有主从复制用户，从库也必须要有主从复制用户</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">仅从库执行</span><br><span class="line">set global read_only=1;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">所有库执行</span><br><span class="line">set global relay_log_purge = 0;</span><br><span class="line">#编辑配置文件  </span><br><span class="line">[root@mysql-db02 ~]# vim /etc/my.cnf  </span><br><span class="line">#在mysqld标签下添加  </span><br><span class="line">[mysqld]  </span><br><span class="line">#禁用自动删除relay log 永久生效  </span><br><span class="line">relay_log_purge = 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master ~]# mysql</span><br><span class="line">mysql&gt; set global relay_log_purge = 0;</span><br><span class="line">[root@master ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld] </span><br><span class="line">relay_log_purge = 0  #添加</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# mysql</span><br><span class="line">mysql&gt; set global read_only=1;</span><br><span class="line">mysql&gt; set global relay_log_purge = 0;</span><br><span class="line">[root@node1 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld] </span><br><span class="line">relay_log_purge = 0  #添加</span><br><span class="line"></span><br><span class="line">[root@node2 ~]# mysql</span><br><span class="line">mysql&gt; set global read_only=1;</span><br><span class="line">mysql&gt; set global relay_log_purge = 0;</span><br><span class="line">[root@node2 ~]# vim /etc/my.cnf</span><br><span class="line">[mysqld] </span><br><span class="line">relay_log_purge = 0  #添加</span><br></pre></td></tr></table></figure>


<p>老男孩教育上海Linux3期MySQL-day13-13MySQL高可用MHA安装部署</p>
<blockquote>
<p>mha安装包:<code>https://github.com/yoshinorim/mha4mysql-manager/releases</code></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">#安装node包</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# rpm <span class="operator">-</span>ivh mha4mysql<span class="operator">-</span>node<span class="number">-0.58</span><span class="number">-0.</span>el7.centos.noarch.rpm</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# rpm <span class="operator">-</span>ivh mha4mysql<span class="operator">-</span>node<span class="number">-0.58</span><span class="number">-0.</span>el7.centos.noarch.rpm</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# rpm <span class="operator">-</span>ivh mha4mysql<span class="operator">-</span>node<span class="number">-0.58</span><span class="number">-0.</span>el7.centos.noarch.rpm</span><br><span class="line">#安装manager</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# rpm <span class="operator">-</span>ivh mha4mysql<span class="operator">-</span>manager<span class="number">-0.58</span><span class="number">-0.</span>el7.centos.noarch.rpm</span><br><span class="line">#登录数据库</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p456</span><br><span class="line">#添加mha管理账号</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> mha@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;mha&#x27;</span>;</span><br><span class="line"></span><br><span class="line">命令软连接（所有节点）</span><br><span class="line">#如果不创建命令软连接，检测mha复制情况的时候会报错  </span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# ln <span class="operator">-</span>s <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# ln <span class="operator">-</span>s <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysql <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysql</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# ln <span class="operator">-</span>s <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# ln <span class="operator">-</span>s <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysql <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysql</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# ln <span class="operator">-</span>s <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysqlbinlog</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# ln <span class="operator">-</span>s <span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>bin<span class="operator">/</span>mysql <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# mkdir <span class="operator">/</span>etc<span class="operator">/</span>mha</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# mkdir <span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>logs</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# mkdir <span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>app1</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>app1.cnf</span><br><span class="line">[server <span class="keyword">default</span>]</span><br><span class="line">manager_log<span class="operator">=</span><span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>logs<span class="operator">/</span>manager.log</span><br><span class="line">manager_workdir<span class="operator">=</span><span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>app1</span><br><span class="line">master_binlog_dir<span class="operator">=</span><span class="operator">/</span>application<span class="operator">/</span>mysql<span class="operator">/</span>data</span><br><span class="line"><span class="keyword">user</span><span class="operator">=</span>mha</span><br><span class="line">password<span class="operator">=</span>mha</span><br><span class="line">ping_interval<span class="operator">=</span><span class="number">2</span></span><br><span class="line">repl_password<span class="operator">=</span><span class="number">123</span></span><br><span class="line">repl_user<span class="operator">=</span>slave</span><br><span class="line">ssh_user<span class="operator">=</span>root</span><br><span class="line">#ssh_port<span class="operator">=</span><span class="number">52013</span></span><br><span class="line"></span><br><span class="line">[server1]</span><br><span class="line">hostname<span class="operator">=</span><span class="number">192.168</span><span class="number">.160</span><span class="number">.3</span></span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"></span><br><span class="line">[server2]</span><br><span class="line">#candidate_master<span class="operator">=</span><span class="number">1</span></span><br><span class="line">#check_repl_delay<span class="operator">=</span><span class="number">0</span></span><br><span class="line">hostname<span class="operator">=</span><span class="number">192.168</span><span class="number">.160</span><span class="number">.4</span></span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"></span><br><span class="line">[server3]</span><br><span class="line">hostname<span class="operator">=</span><span class="number">192.168</span><span class="number">.160</span><span class="number">.5</span></span><br><span class="line">port<span class="operator">=</span><span class="number">3306</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置ssh信任（所有节点）</span><br><span class="line">#创建秘钥对 </span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# ssh<span class="operator">-</span>keygen <span class="operator">-</span>t dsa <span class="operator">-</span>P <span class="string">&#x27;&#x27;</span> <span class="operator">-</span>f <span class="operator">~</span><span class="operator">/</span>.ssh<span class="operator">/</span>id_dsa <span class="operator">&gt;</span><span class="operator">/</span>dev<span class="operator">/</span><span class="keyword">null</span> <span class="number">2</span><span class="operator">&gt;</span><span class="operator">&amp;</span><span class="number">1</span></span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# ssh<span class="operator">-</span>keygen <span class="operator">-</span>t dsa <span class="operator">-</span>P <span class="string">&#x27;&#x27;</span> <span class="operator">-</span>f <span class="operator">~</span><span class="operator">/</span>.ssh<span class="operator">/</span>id_dsa <span class="operator">&gt;</span><span class="operator">/</span>dev<span class="operator">/</span><span class="keyword">null</span> <span class="number">2</span><span class="operator">&gt;</span><span class="operator">&amp;</span><span class="number">1</span></span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# ssh<span class="operator">-</span>keygen <span class="operator">-</span>t dsa <span class="operator">-</span>P <span class="string">&#x27;&#x27;</span> <span class="operator">-</span>f <span class="operator">~</span><span class="operator">/</span>.ssh<span class="operator">/</span>id_dsa <span class="operator">&gt;</span><span class="operator">/</span>dev<span class="operator">/</span><span class="keyword">null</span> <span class="number">2</span><span class="operator">&gt;</span><span class="operator">&amp;</span><span class="number">1</span></span><br><span class="line">#发送公钥，包括自己</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="operator">-</span>i <span class="operator">/</span>root<span class="operator">/</span>.ssh<span class="operator">/</span>id_dsa.pub root<span class="variable">@192</span><span class="number">.168</span><span class="number">.160</span><span class="number">.3</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="operator">-</span>i <span class="operator">/</span>root<span class="operator">/</span>.ssh<span class="operator">/</span>id_dsa.pub root<span class="variable">@192</span><span class="number">.168</span><span class="number">.160</span><span class="number">.4</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="operator">-</span>i <span class="operator">/</span>root<span class="operator">/</span>.ssh<span class="operator">/</span>id_dsa.pub root<span class="variable">@192</span><span class="number">.168</span><span class="number">.160</span><span class="number">.5</span></span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="operator">-</span>i <span class="operator">/</span>root<span class="operator">/</span>.ssh<span class="operator">/</span>id_dsa.pub root<span class="variable">@192</span><span class="number">.168</span><span class="number">.160</span><span class="number">.3</span></span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="operator">-</span>i <span class="operator">/</span>root<span class="operator">/</span>.ssh<span class="operator">/</span>id_dsa.pub root<span class="variable">@192</span><span class="number">.168</span><span class="number">.160</span><span class="number">.4</span></span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="operator">-</span>i <span class="operator">/</span>root<span class="operator">/</span>.ssh<span class="operator">/</span>id_dsa.pub root<span class="variable">@192</span><span class="number">.168</span><span class="number">.160</span><span class="number">.5</span></span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="operator">-</span>i <span class="operator">/</span>root<span class="operator">/</span>.ssh<span class="operator">/</span>id_dsa.pub root<span class="variable">@192</span><span class="number">.168</span><span class="number">.160</span><span class="number">.3</span></span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="operator">-</span>i <span class="operator">/</span>root<span class="operator">/</span>.ssh<span class="operator">/</span>id_dsa.pub root<span class="variable">@192</span><span class="number">.168</span><span class="number">.160</span><span class="number">.4</span></span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# ssh<span class="operator">-</span><span class="keyword">copy</span><span class="operator">-</span>id <span class="operator">-</span>i <span class="operator">/</span>root<span class="operator">/</span>.ssh<span class="operator">/</span>id_dsa.pub root<span class="variable">@192</span><span class="number">.168</span><span class="number">.160</span><span class="number">.5</span></span><br><span class="line"></span><br><span class="line">所有节点测试ssh</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# ssh <span class="number">192.168</span><span class="number">.160</span><span class="number">.3</span></span><br><span class="line"><span class="keyword">Last</span> login: Thu Jun <span class="number">30</span> <span class="number">14</span>:<span class="number">07</span>:<span class="number">54</span> <span class="number">2022</span> <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.1</span></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# logout</span><br><span class="line">Connection <span class="keyword">to</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.3</span> closed.</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# ssh <span class="number">192.168</span><span class="number">.160</span><span class="number">.4</span></span><br><span class="line"><span class="keyword">Last</span> login: Thu Jun <span class="number">30</span> <span class="number">14</span>:<span class="number">07</span>:<span class="number">58</span> <span class="number">2022</span> <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.1</span></span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# logout</span><br><span class="line">Connection <span class="keyword">to</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.4</span> closed.</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# ssh <span class="number">192.168</span><span class="number">.160</span><span class="number">.5</span></span><br><span class="line"><span class="keyword">Last</span> login: Thu Jun <span class="number">30</span> <span class="number">14</span>:<span class="number">08</span>:<span class="number">15</span> <span class="number">2022</span> <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.1</span></span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# logout</span><br><span class="line">Connection <span class="keyword">to</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.5</span> closed.</span><br><span class="line"></span><br><span class="line">#测试ssh</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# masterha_check_ssh <span class="comment">--conf=/etc/mha/app1.cnf</span></span><br><span class="line">#看到如下字样，则测试成功</span><br><span class="line">Thu Jun <span class="number">30</span> <span class="number">14</span>:<span class="number">57</span>:<span class="number">20</span> <span class="number">2022</span> <span class="operator">-</span> [info] <span class="keyword">All</span> SSH connection tests passed successfully.</span><br><span class="line">#测试复制</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# masterha_check_repl <span class="comment">--conf=/etc/mha/app1.cnf</span></span><br><span class="line">#看到如下字样，则测试成功</span><br><span class="line">MySQL Replication Health <span class="keyword">is</span> OK.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#启动MHA</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# nohup masterha_manager <span class="comment">--conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt; /dev/null &gt; /etc/mha/app1/manager.log 2&gt;&amp;1 &amp;</span></span><br><span class="line">#查看MHA状态</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# masterha_check_status <span class="comment">--conf=/etc/mha/app1.cnf</span></span><br><span class="line">app1 (pid:<span class="number">64919</span>) <span class="keyword">is</span> <span class="keyword">running</span>(<span class="number">0</span>:PING_OK), master:<span class="number">192.168</span><span class="number">.160</span><span class="number">.3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">报错，从库切换成主库serveer_id冲突</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server_id<span class="operator">=</span><span class="number">15</span>  #修改为<span class="number">15</span></span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld restart</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G</span><br><span class="line">mysql<span class="operator">&gt;</span> stop slave;</span><br><span class="line">mysql<span class="operator">&gt;</span> reset slave <span class="keyword">all</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> change master <span class="keyword">to</span></span><br><span class="line">master_host<span class="operator">=</span><span class="string">&#x27;192.168.160.3&#x27;</span>,</span><br><span class="line">master_user<span class="operator">=</span><span class="string">&#x27;slave&#x27;</span>,</span><br><span class="line">master_password<span class="operator">=</span><span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">master_auto_position<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> slave;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# nohup masterha_manager <span class="comment">--conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt; /dev/null &gt; /etc/mha/app1/manager.log 2&gt;&amp;1 &amp;</span></span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# masterha_check_status <span class="comment">--conf=/etc/mha/app1.cnf                               app1 (pid:72538) is running(0:PING_OK), master:192.168.160.3</span></span><br><span class="line"></span><br><span class="line">#查看切换成功</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#手动恢复集群</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# grep <span class="operator">-</span>i <span class="string">&#x27;change master to&#x27;</span> <span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>logs<span class="operator">/</span>manager.log</span><br><span class="line">Thu Jun <span class="number">30</span> <span class="number">15</span>:<span class="number">48</span>:<span class="number">35</span> <span class="number">2022</span> <span class="operator">-</span> [info]  <span class="keyword">All</span> other slaves should <span class="keyword">start</span> replication <span class="keyword">from</span> here. Statement should be: CHANGE MASTER <span class="keyword">TO</span> MASTER_HOST<span class="operator">=</span><span class="string">&#x27;192.168.160.4&#x27;</span>, MASTER_PORT<span class="operator">=</span><span class="number">3306</span>, MASTER_AUTO_POSITION<span class="operator">=</span><span class="number">1</span>, MASTER_USER<span class="operator">=</span><span class="string">&#x27;slave&#x27;</span>, MASTER_PASSWORD<span class="operator">=</span><span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> reset slave <span class="keyword">all</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> CHANGE MASTER <span class="keyword">TO</span> MASTER_HOST<span class="operator">=</span><span class="string">&#x27;192.168.160.4&#x27;</span>, MASTER_PORT<span class="operator">=</span><span class="number">3306</span>, MASTER_AUTO_POSITION<span class="operator">=</span><span class="number">1</span>, MASTER_USER<span class="operator">=</span><span class="string">&#x27;slave&#x27;</span>, MASTER_PASSWORD<span class="operator">=</span><span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>报错：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">测试复制</span></span><br><span class="line">[root@node2 ~]# masterha_check_repl --conf=/etc/mha/app1.cnf</span><br><span class="line">    Checking if super_read_only is defined and turned on..DBD::mysql::st execute failed: Unknown system variable &#x27;super_read_only&#x27; at /usr/share/perl5/vendor_perl/MHA/SlaveUtil.pm line 245.</span><br><span class="line">Thu Jul 14 10:44:39 2022 - [error][/usr/share/perl5/vendor_perl/MHA/MasterMonitor.pm, ln205] Slaves settings check failed!</span><br><span class="line">Thu Jul 14 10:44:39 2022 - [error][/usr/share/perl5/vendor_perl/MHA/MasterMonitor.pm, ln413] Slave configuration failed.</span><br><span class="line">Thu Jul 14 10:44:39 2022 - [error][/usr/share/perl5/vendor_perl/MHA/MasterMonitor.pm, ln424] Error happened on checking configurations.  at /usr/bin/masterha_check_repl line 48.</span><br><span class="line">Thu Jul 14 10:44:39 2022 - [error][/usr/share/perl5/vendor_perl/MHA/MasterMonitor.pm, ln523] Error happened on monitoring servers.</span><br><span class="line">Thu Jul 14 10:44:39 2022 - [info] Got exit code 1 (Not master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication Health is NOT OK!</span><br><span class="line"></span><br><span class="line">MHA0.58和Centos7版本不兼容，需要更换成MHA0.56</span><br><span class="line"></span><br><span class="line">查询删除0.58</span><br><span class="line">[root@node2 ~]# rpm -qa|grep  mha4mysql</span><br><span class="line">mha4mysql-node-0.58-0.el7.centos.noarch</span><br><span class="line">mha4mysql-manager-0.58-0.el7.centos.noarch</span><br><span class="line">[root@node2 ~]# rpm -e mha4mysql-manager-0.58-0.el7.centos.noarch</span><br><span class="line">[root@node2 ~]# rpm -qa|grep  mha4mysql</span><br><span class="line">mha4mysql-node-0.58-0.el7.centos.noarch</span><br><span class="line">[root@node2 ~]# rpm -e mha4mysql-manager-0.58-0.el7.centos.noarch</span><br><span class="line"></span><br><span class="line">安装0.56（manager节点）</span><br><span class="line">[root@node2 ~]# rpm -ivh mha4mysql-node-0.56-0.el6.noarch.rpm</span><br><span class="line">[root@node2 ~]# rpm -ivh mha4mysql-manager-0.56-0.el6.noarch.rpm</span><br><span class="line"></span><br><span class="line">卸载0.58，安装0.56（node节点）</span><br><span class="line">[root@master ~]# rpm -qa|grep  mha4mysql</span><br><span class="line">mha4mysql-node-0.58-0.el7.centos.noarch</span><br><span class="line">[root@master ~]# rpm -e mha4mysql-node-0.58-0.el7.centos.noarch</span><br><span class="line">[root@master ~]# rpm -ivh mha4mysql-node-0.56-0.el6.noarch.rpm</span><br><span class="line"></span><br><span class="line">卸载0.58，安装0.56（node节点）</span><br><span class="line">[root@node1 ~]# rpm -qa|grep  mha4mysql</span><br><span class="line">mha4mysql-node-0.58-0.el7.centos.noarch</span><br><span class="line">[root@node1 ~]# rpm -e mha4mysql-node-0.58-0.el7.centos.noarch</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>老男孩教育上海Linux3期MySQL-day13-14MySQL高可用MHA环境排错及切换演示</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">视频中报错需要修改</span><br><span class="line">mysql<span class="operator">&gt;</span> stop slave;</span><br><span class="line">mysql<span class="operator">&gt;</span> reset slave <span class="keyword">all</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> change master <span class="keyword">to</span></span><br><span class="line">master_host<span class="operator">=</span><span class="string">&#x27;10.0.0.51&#x27;</span>,</span><br><span class="line">master_user<span class="operator">=</span><span class="string">&#x27;rep&#x27;</span>,</span><br><span class="line">master_password<span class="operator">=</span><span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">master_auto_position<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> slave;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave stauts\G</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>app1.cnf</span><br><span class="line">repl_user<span class="operator">=</span>rep  #修改为rep</span><br><span class="line"></span><br><span class="line"><span class="comment">-------------------</span></span><br><span class="line">nohup  #放后台启动</span><br><span class="line"></span><br><span class="line">masterha_manager  #启动命令</span><br><span class="line"></span><br><span class="line"><span class="comment">--conf=/etc/mha/app1.cnf  #指定配置文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--remove_dead_master_conf  #主库宕机，做完切换会把配置文件主库摘掉</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--ignore_last_failover  #忽略上一次切换，不生产锁文件</span></span><br><span class="line"></span><br><span class="line"><span class="operator">&amp;</span></span><br><span class="line">MHA工作机制：</span><br><span class="line">做完一次切换后，会生成一个锁文件，在工作目录下。</span><br><span class="line"><span class="number">8</span>小时之内，不做第二次切换。</span><br></pre></td></tr></table></figure>

<p>老男孩教育上海Linux3期MySQL-day13-03MySQL高可用MHA传统主从切换及日志分析</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">#停止MHA</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# masterha_stop <span class="comment">--conf=/etc/mha/app1.cnf</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server_id<span class="operator">=</span><span class="number">10</span></span><br><span class="line"><span class="keyword">skip</span><span class="operator">-</span>name<span class="operator">-</span>resolve</span><br><span class="line">#gtid_mode<span class="operator">=</span><span class="keyword">ON</span>  #注释</span><br><span class="line">#enforce_gtid_consistency  #注释</span><br><span class="line">#log<span class="operator">-</span>slave<span class="operator">-</span>updates  #注释</span><br><span class="line">log<span class="operator">-</span>bin<span class="operator">=</span>mysql<span class="operator">-</span>bin</span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span></span><br><span class="line">relay_log_purge <span class="operator">=</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">server_id<span class="operator">=</span><span class="number">15</span></span><br><span class="line"><span class="keyword">skip</span><span class="operator">-</span>name<span class="operator">-</span>resolve</span><br><span class="line">#gtid_mode<span class="operator">=</span><span class="keyword">ON</span>  #注释</span><br><span class="line">#enforce_gtid_consistency  #注释</span><br><span class="line">#log<span class="operator">-</span>slave<span class="operator">-</span>updates  #注释</span><br><span class="line">log<span class="operator">-</span>bin<span class="operator">=</span>mysql<span class="operator">-</span>bin</span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span></span><br><span class="line">relay_log_purge <span class="operator">=</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">skip_name_resolve</span><br><span class="line">log<span class="operator">-</span>bin<span class="operator">=</span>mysql<span class="operator">-</span>bin</span><br><span class="line">binlog_format<span class="operator">=</span><span class="type">row</span></span><br><span class="line">server_id<span class="operator">=</span><span class="number">5</span></span><br><span class="line">#gtid_mode<span class="operator">=</span><span class="keyword">ON</span>  #注释</span><br><span class="line">#enforce_gtid_consistency  #注释</span><br><span class="line">#log<span class="operator">-</span>slave<span class="operator">-</span>updates  #注释</span><br><span class="line">relay_log_purge <span class="operator">=</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld restart</span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld restart</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld restart</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@master</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> stop slave;</span><br><span class="line">mysql<span class="operator">&gt;</span> reset slave <span class="keyword">all</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> reset master;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>      <span class="number">120</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line">#创建rep主从复制用户</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> replication slave <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> rep@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@node1</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> stop slave;</span><br><span class="line">mysql<span class="operator">&gt;</span> reset slave <span class="keyword">all</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> reset master;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>      <span class="number">120</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> change master <span class="keyword">to</span></span><br><span class="line">master_host<span class="operator">=</span><span class="string">&#x27;192.168.160.3&#x27;</span>,</span><br><span class="line">master_user<span class="operator">=</span><span class="string">&#x27;slave&#x27;</span>,</span><br><span class="line">master_password<span class="operator">=</span><span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">master_log_file<span class="operator">=</span><span class="string">&#x27;mysql-bin.000001&#x27;</span>,</span><br><span class="line">master_log_pos<span class="operator">=</span><span class="number">120</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> slave;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G</span><br><span class="line">    Slave_IO_Running: Yes</span><br><span class="line">    Slave_SQL_Running: Yes</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# mysql</span><br><span class="line">mysql<span class="operator">&gt;</span> stop slave;</span><br><span class="line">mysql<span class="operator">&gt;</span> reset slave <span class="keyword">all</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> reset master;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>      <span class="number">120</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> change master <span class="keyword">to</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_host<span class="operator">=</span><span class="string">&#x27;192.168.160.3&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_user<span class="operator">=</span><span class="string">&#x27;slave&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_password<span class="operator">=</span><span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_log_file<span class="operator">=</span><span class="string">&#x27;mysql-bin.000001&#x27;</span>,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> master_log_pos<span class="operator">=</span><span class="number">120</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">start</span> slave;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G</span><br><span class="line">    Slave_IO_Running: Yes</span><br><span class="line">    lave_SQL_Running: Yes</span><br><span class="line"></span><br><span class="line">#手动切换（无效）</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# masterha_master_switch <span class="comment">--master_state=dead --conf=/etc/mha/app1.cnf --dead_master_host=10.0.0.51 --dead_master_port=3306 --new_master_host=10.0.0.52 --new_master_port=3306 --ignore_last_failover</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# masterha_master_switch <span class="comment">--master_state=dead --conf=/etc/mha/app1.cnf --dead_master_ip=10.0.0.51 --dead_master_host=10.0.0.51 --dead_master_port=3306 --new_master_host=10.0.0.52 --new_master_port=3306 --ignore_last_failover</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>MHA环境恢复步骤：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>修复主库并启动主库</span><br><span class="line"><span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld <span class="keyword">start</span></span><br><span class="line"><span class="number">2.</span>在MHA日志中找到change master <span class="keyword">to</span> 语句</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# grep <span class="operator">-</span>i <span class="string">&#x27;change master to&#x27;</span> <span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>logs<span class="operator">/</span>manager.log</span><br><span class="line"><span class="number">3.</span>在旧主库中执行change master <span class="keyword">to</span></span><br><span class="line">mysql<span class="operator">&gt;</span> CHANGE MASTER <span class="keyword">TO</span> MASTER_HOST<span class="operator">=</span><span class="string">&#x27;10.0.0.52&#x27;</span>, MASTER_PORT<span class="operator">=</span><span class="number">3306</span>, MASTER_AUTO_POSITION<span class="operator">=</span><span class="number">1</span>, MASTER_USER<span class="operator">=</span><span class="string">&#x27;rep&#x27;</span>, MASTER_PASSWORD<span class="operator">=</span><span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"><span class="number">4.</span><span class="keyword">start</span> slave;</span><br><span class="line"><span class="number">5.</span>修改MHA配置文件，添加server标签</span><br><span class="line"><span class="number">6.</span>启动MHA</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# nohup masterha_manager <span class="comment">--conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt; /dev/null &gt; /etc/mha/app1/manager.log 2&gt;&amp;1 &amp;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>老男孩教育上海Linux3期MySQL-day13-04MySQL高可用MHA管理VIP操作及讲解</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#编辑配置文件  </span><br><span class="line">[root<span class="variable">@mysql</span><span class="operator">-</span>db03 <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>app1.cnf  </span><br><span class="line">#在[server <span class="keyword">default</span>]标签下添加  </span><br><span class="line">[server <span class="keyword">default</span>]  </span><br><span class="line">#使用MHA自带脚本  </span><br><span class="line">master_ip_failover_script<span class="operator">=</span><span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>app1<span class="operator">/</span>master_ip_failover</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# cd <span class="operator">/</span>root<span class="operator">/</span>mha4mysql<span class="operator">-</span>manager<span class="number">-0.58</span><span class="operator">/</span>samples<span class="operator">/</span>scripts<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@node2</span> scripts]# ll</span><br><span class="line">总用量 <span class="number">32</span></span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> mysql mysql  <span class="number">3648</span> <span class="number">3</span>月  <span class="number">23</span> <span class="number">2018</span> master_ip_failover</span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> mysql mysql  <span class="number">9870</span> <span class="number">3</span>月  <span class="number">23</span> <span class="number">2018</span> master_ip_online_change</span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> mysql mysql <span class="number">11867</span> <span class="number">3</span>月  <span class="number">23</span> <span class="number">2018</span> power_manager</span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> mysql mysql  <span class="number">1360</span> <span class="number">3</span>月  <span class="number">23</span> <span class="number">2018</span> send_report</span><br><span class="line">[root<span class="variable">@node2</span> scripts]# ll <span class="operator">/</span>root<span class="operator">/</span>mha4mysql<span class="operator">-</span>manager<span class="number">-0.58</span><span class="operator">/</span>samples<span class="operator">/</span>scripts<span class="operator">/</span>master_ip_failover</span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> mysql mysql <span class="number">3648</span> <span class="number">3</span>月  <span class="number">23</span> <span class="number">2018</span> <span class="operator">/</span>root<span class="operator">/</span>mha4mysql<span class="operator">-</span>manager<span class="number">-0.58</span><span class="operator">/</span>samples<span class="operator">/</span>scripts<span class="operator">/</span>master_ip_failover</span><br><span class="line">[root<span class="variable">@node2</span> scripts]# cp master_ip_failover <span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@node2</span> mha]# vim master_ip_failover</span><br><span class="line">use Getopt::Long;</span><br><span class="line">#use MHA::DBHelper;  #注释</span><br><span class="line"></span><br><span class="line">my (</span><br><span class="line">  $command,        $ssh_user,         $orig_master_host,</span><br><span class="line">  $orig_master_ip, $orig_master_port, $new_master_host,</span><br><span class="line">  $new_master_ip,  $new_master_port,  $new_master_user,</span><br><span class="line">  $new_master_password</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">my $vip <span class="operator">=</span> <span class="string">&#x27;10.0.0.55/24&#x27;</span>;  #添加</span><br><span class="line">my $key <span class="operator">=</span> <span class="string">&#x27;0&#x27;</span>;  #添加</span><br><span class="line">my $ssh_start_vip <span class="operator">=</span> &quot;/sbin/ifconfig eth0:$key $vip&quot;;  #添加</span><br><span class="line">my $ssh_stop_vip <span class="operator">=</span> &quot;/sbin/ifconfig eth0:$key down&quot;;  #添加</span><br><span class="line"></span><br><span class="line">GetOptions(</span><br><span class="line">  <span class="string">&#x27;command=s&#x27;</span>             <span class="operator">=</span><span class="operator">&gt;</span> \$command,</span><br><span class="line">  <span class="string">&#x27;ssh_user=s&#x27;</span>            <span class="operator">=</span><span class="operator">&gt;</span> \$ssh_user,</span><br><span class="line">  <span class="string">&#x27;orig_master_host=s&#x27;</span>    <span class="operator">=</span><span class="operator">&gt;</span> \$orig_master_host,</span><br><span class="line">  <span class="string">&#x27;orig_master_ip=s&#x27;</span>      <span class="operator">=</span><span class="operator">&gt;</span> \$orig_master_ip,</span><br><span class="line">  <span class="string">&#x27;orig_master_port=i&#x27;</span>    <span class="operator">=</span><span class="operator">&gt;</span> \$orig_master_port,</span><br><span class="line">  <span class="string">&#x27;new_master_host=s&#x27;</span>     <span class="operator">=</span><span class="operator">&gt;</span> \$new_master_host,</span><br><span class="line">  <span class="string">&#x27;new_master_ip=s&#x27;</span>       <span class="operator">=</span><span class="operator">&gt;</span> \$new_master_ip,</span><br><span class="line">  <span class="string">&#x27;new_master_port=i&#x27;</span>     <span class="operator">=</span><span class="operator">&gt;</span> \$new_master_port,</span><br><span class="line">  <span class="string">&#x27;new_master_user=s&#x27;</span>     <span class="operator">=</span><span class="operator">&gt;</span> \$new_master_user,</span><br><span class="line">  <span class="string">&#x27;new_master_password=s&#x27;</span> <span class="operator">=</span><span class="operator">&gt;</span> \$new_master_password,</span><br><span class="line">);</span><br><span class="line">#需要在主库上手动绑定vip</span><br><span class="line">[root<span class="variable">@node2</span> mha]# ifconfig eth0:<span class="number">0</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.55</span><span class="operator">/</span><span class="number">24</span></span><br><span class="line">#转换unix格式</span><br><span class="line">[root<span class="variable">@node2</span> mha]# dos2unix master_ip_failover</span><br></pre></td></tr></table></figure>

<p>老男孩教育上海Linux3期MySQL-day13-06MySQL高可用MHA防止断电断网binlog-server及MHA找最新数据从库演示</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">配置binlog<span class="operator">-</span>server</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>mha<span class="operator">/</span>app1.cnf </span><br><span class="line">[binlog1]  </span><br><span class="line">no_master<span class="operator">=</span><span class="number">1</span>  </span><br><span class="line">hostname<span class="operator">=</span><span class="number">10.0</span><span class="number">.0</span><span class="number">.53</span>  </span><br><span class="line">master_binlog_dir<span class="operator">=</span><span class="operator">/</span>data<span class="operator">/</span>mysql<span class="operator">/</span>binlog<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# mkdir <span class="operator">-</span>p <span class="operator">/</span>data<span class="operator">/</span>mysql<span class="operator">/</span>binlog<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# cd <span class="operator">/</span>data<span class="operator">/</span>mysql<span class="operator">/</span>binlog<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@node2</span> binlog]# mysqlbinlog <span class="operator">-</span>R <span class="comment">--host=192.168.160.3 --user=mha --password=mha --raw --stop-never mysql-bin.000001 &amp;</span></span><br><span class="line">[root<span class="variable">@node2</span> binlog]# ps <span class="operator">-</span>ef<span class="operator">|</span>grep mysqlbinlog</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vim sql.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">MysqlLogin=&quot;mysql -uroot -p123&quot;</span><br><span class="line">i=1</span><br><span class="line">while true</span><br><span class="line">do</span><br><span class="line"><span class="meta prompt_">  $</span><span class="language-bash">&#123;MysqlLogin&#125; -e <span class="string">&quot;insert into test.student values (&quot;</span><span class="variable">$i</span><span class="string">&quot;,&#x27;oldboy&quot;</span><span class="variable">$i</span><span class="string">&quot;&#x27;&#x27;,&#x27;m&#x27;,&#x27;21&#x27;, &#x27;computer&quot;</span><span class="variable">$i</span><span class="string">&quot;&#x27;);commit;&quot;</span></span></span><br><span class="line">  ((1++))</span><br><span class="line">  sleep 2;</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>老男孩教育上海Linux3期MySQL-day13-07MySQL读写分离Atlas部署讲解</p>
<blockquote>
<p>下载地址：<code>https://github.com/Qihoo360/Atlas/releases/download/2.2.1/Atlas-2.2.1.el6.x86_64.rpm</code></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# rpm <span class="operator">-</span>ivh Atlas<span class="number">-2.2</span><span class="number">.1</span>.el6.x86_64.rpm</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# cd <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>mysql<span class="operator">-</span>proxy<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@node2</span> mysql<span class="operator">-</span>proxy]# ll</span><br><span class="line">总用量 <span class="number">4</span></span><br><span class="line">drwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">2</span> root root   <span class="number">75</span> <span class="number">7</span>月   <span class="number">1</span> <span class="number">10</span>:<span class="number">18</span> bin</span><br><span class="line">drwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">2</span> root root   <span class="number">22</span> <span class="number">7</span>月   <span class="number">1</span> <span class="number">10</span>:<span class="number">18</span> conf</span><br><span class="line">drwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">3</span> root root <span class="number">4096</span> <span class="number">7</span>月   <span class="number">1</span> <span class="number">10</span>:<span class="number">18</span> lib</span><br><span class="line">drwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">2</span> root root    <span class="number">6</span> <span class="number">12</span>月 <span class="number">17</span> <span class="number">2014</span> log</span><br><span class="line">[root<span class="variable">@node2</span> mysql<span class="operator">-</span>proxy]# cd conf<span class="operator">/</span></span><br><span class="line">[root<span class="variable">@node2</span> conf]# ll</span><br><span class="line">总用量 <span class="number">4</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root 2810 12月 17 2014 test.cnf</span></span><br><span class="line">#需要修改</span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# vim <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>mysql<span class="operator">-</span>proxy<span class="operator">/</span>conf<span class="operator">/</span>test.cnf</span><br><span class="line">proxy<span class="operator">-</span>backend<span class="operator">-</span>addresses <span class="operator">=</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.3</span>:<span class="number">3306</span></span><br><span class="line">proxy<span class="operator">-</span>read<span class="operator">-</span><span class="keyword">only</span><span class="operator">-</span>backend<span class="operator">-</span>addresses <span class="operator">=</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.52</span>:<span class="number">3306</span>,<span class="number">10.0</span><span class="number">.0</span><span class="number">.53</span>:<span class="number">3306</span></span><br><span class="line">pwds <span class="operator">=</span> root:OoCn<span class="operator">/</span>XdFpIg<span class="operator">=</span>,slave:<span class="number">3</span>yb5jEku5h4<span class="operator">=</span>,mha:O2jBXONX098<span class="operator">=</span></span><br><span class="line">log<span class="operator">-</span>level <span class="operator">=</span> error</span><br><span class="line"><span class="keyword">sql</span><span class="operator">-</span>log <span class="operator">=</span> <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">sql</span><span class="operator">-</span>log<span class="operator">-</span>slow <span class="operator">=</span> <span class="number">10</span></span><br><span class="line">instance <span class="operator">=</span> test</span><br><span class="line">proxy<span class="operator">-</span>address <span class="operator">=</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">3307</span></span><br><span class="line">charset <span class="operator">=</span> utf8</span><br><span class="line">client<span class="operator">-</span>ips <span class="operator">=</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">[root<span class="variable">@node2</span> <span class="operator">~</span>]# cd <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>mysql<span class="operator">-</span>proxy<span class="operator">/</span>bin</span><br><span class="line">[root<span class="variable">@node2</span> bin]# ll</span><br><span class="line">总用量 <span class="number">44</span></span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> root root  <span class="number">9696</span> <span class="number">12</span>月 <span class="number">17</span> <span class="number">2014</span> encrypt</span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> root root <span class="number">23564</span> <span class="number">12</span>月 <span class="number">17</span> <span class="number">2014</span> mysql<span class="operator">-</span>proxy</span><br><span class="line"><span class="operator">-</span>rwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">1</span> root root  <span class="number">1552</span> <span class="number">12</span>月 <span class="number">17</span> <span class="number">2014</span> mysql<span class="operator">-</span>proxyd</span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--. 1 root root     6 12月 17 2014 VERSION</span></span><br><span class="line">#加密root密码<span class="number">456</span></span><br><span class="line">[root<span class="variable">@node2</span> bin]# .<span class="operator">/</span>encrypt <span class="number">456</span></span><br><span class="line">OoCn<span class="operator">/</span>XdFpIg<span class="operator">=</span></span><br><span class="line">#加密rep密码<span class="number">123</span></span><br><span class="line">[root<span class="variable">@node2</span> bin]# .<span class="operator">/</span>encrypt <span class="number">123</span></span><br><span class="line"><span class="number">3</span>yb5jEku5h4<span class="operator">=</span></span><br><span class="line">#加密mha密码mha</span><br><span class="line">[root<span class="variable">@node2</span> bin]# .<span class="operator">/</span>encrypt mha</span><br><span class="line">O2jBXONX098<span class="operator">=</span></span><br><span class="line">#启动</span><br><span class="line">[root<span class="variable">@node2</span> bin]# <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>mysql<span class="operator">-</span>proxy<span class="operator">/</span>bin<span class="operator">/</span>mysql<span class="operator">-</span>proxyd test <span class="keyword">start</span></span><br><span class="line">OK: MySQL<span class="operator">-</span>Proxy <span class="keyword">of</span> test <span class="keyword">is</span> started</span><br><span class="line">[root<span class="variable">@node2</span> conf]# ps <span class="operator">-</span>ef<span class="operator">|</span>grep mysql<span class="operator">-</span>proxy</span><br><span class="line">#远程连接权限</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> root@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line">[root<span class="variable">@node2</span> conf]# vim test.cnf</span><br><span class="line">#client<span class="operator">-</span>ips <span class="operator">=</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">[root<span class="variable">@node2</span> conf]# <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>mysql<span class="operator">-</span>proxy<span class="operator">/</span>bin<span class="operator">/</span>mysql<span class="operator">-</span>proxyd test stop</span><br><span class="line">[root<span class="variable">@node2</span> conf]# <span class="operator">/</span>usr<span class="operator">/</span><span class="keyword">local</span><span class="operator">/</span>mysql<span class="operator">-</span>proxy<span class="operator">/</span>bin<span class="operator">/</span>mysql<span class="operator">-</span>proxyd test <span class="keyword">start</span></span><br><span class="line">[root<span class="variable">@node2</span> conf]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p456 <span class="operator">-</span>h192<span class="number">.168</span><span class="number">.160</span><span class="number">.5</span> <span class="operator">-</span>P3307</span><br><span class="line">[root<span class="variable">@node2</span> conf]# mysql <span class="operator">-</span>uuser <span class="operator">-</span>ppwd <span class="operator">-</span>h127<span class="number">.0</span><span class="number">.0</span><span class="number">.1</span> <span class="operator">-</span>P2345</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> help;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> backends;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+-------+------+</span></span><br><span class="line"><span class="operator">|</span> backend_ndx <span class="operator">|</span> address            <span class="operator">|</span> state <span class="operator">|</span> type <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+-------+------+</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">1</span> <span class="operator">|</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.3</span>:<span class="number">3306</span> <span class="operator">|</span> up    <span class="operator">|</span> rw   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">2</span> <span class="operator">|</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.4</span>:<span class="number">3306</span> <span class="operator">|</span> up    <span class="operator">|</span> ro   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">3</span> <span class="operator">|</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.5</span>:<span class="number">3306</span> <span class="operator">|</span> up    <span class="operator">|</span> ro   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+-------+------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> backends;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+-------+------+</span></span><br><span class="line"><span class="operator">|</span> backend_ndx <span class="operator">|</span> address            <span class="operator">|</span> state <span class="operator">|</span> type <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+-------+------+</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">1</span> <span class="operator">|</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.3</span>:<span class="number">3306</span> <span class="operator">|</span> up    <span class="operator">|</span> rw   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">2</span> <span class="operator">|</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.4</span>:<span class="number">3306</span> <span class="operator">|</span> up    <span class="operator">|</span> ro   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">3</span> <span class="operator">|</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.5</span>:<span class="number">3306</span> <span class="operator">|</span> up    <span class="operator">|</span> ro   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+-------+------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> offline <span class="number">2</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+---------+------+</span></span><br><span class="line"><span class="operator">|</span> backend_ndx <span class="operator">|</span> address            <span class="operator">|</span> state   <span class="operator">|</span> type <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+---------+------+</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">2</span> <span class="operator">|</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.4</span>:<span class="number">3306</span> <span class="operator">|</span> offline <span class="operator">|</span> ro   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+---------+------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> backends;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+---------+------+</span></span><br><span class="line"><span class="operator">|</span> backend_ndx <span class="operator">|</span> address            <span class="operator">|</span> state   <span class="operator">|</span> type <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+---------+------+</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">1</span> <span class="operator">|</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.3</span>:<span class="number">3306</span> <span class="operator">|</span> up      <span class="operator">|</span> rw   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">2</span> <span class="operator">|</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.4</span>:<span class="number">3306</span> <span class="operator">|</span> offline <span class="operator">|</span> ro   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">3</span> <span class="operator">|</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.5</span>:<span class="number">3306</span> <span class="operator">|</span> up      <span class="operator">|</span> ro   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+---------+------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> online <span class="number">2</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+---------+------+</span></span><br><span class="line"><span class="operator">|</span> backend_ndx <span class="operator">|</span> address            <span class="operator">|</span> state   <span class="operator">|</span> type <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+---------+------+</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">2</span> <span class="operator">|</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.4</span>:<span class="number">3306</span> <span class="operator">|</span> <span class="literal">unknown</span> <span class="operator">|</span> ro   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+---------+------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> backends;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+-------+------+</span></span><br><span class="line"><span class="operator">|</span> backend_ndx <span class="operator">|</span> address            <span class="operator">|</span> state <span class="operator">|</span> type <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+-------+------+</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">1</span> <span class="operator">|</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.3</span>:<span class="number">3306</span> <span class="operator">|</span> up    <span class="operator">|</span> rw   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">2</span> <span class="operator">|</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.4</span>:<span class="number">3306</span> <span class="operator">|</span> up    <span class="operator">|</span> ro   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">3</span> <span class="operator">|</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.5</span>:<span class="number">3306</span> <span class="operator">|</span> up    <span class="operator">|</span> ro   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+-------+------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">add</span> slave <span class="number">10.0</span><span class="number">.0</span><span class="number">.59</span>:<span class="number">3306</span>;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> save config;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> backends;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+-------+------+</span></span><br><span class="line"><span class="operator">|</span> backend_ndx <span class="operator">|</span> address            <span class="operator">|</span> state <span class="operator">|</span> type <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+-------+------+</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">1</span> <span class="operator">|</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.3</span>:<span class="number">3306</span> <span class="operator">|</span> up    <span class="operator">|</span> rw   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">2</span> <span class="operator">|</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.4</span>:<span class="number">3306</span> <span class="operator">|</span> up    <span class="operator">|</span> ro   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">3</span> <span class="operator">|</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.5</span>:<span class="number">3306</span> <span class="operator">|</span> up    <span class="operator">|</span> ro   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">4</span> <span class="operator">|</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.59</span>:<span class="number">3306</span>     <span class="operator">|</span> down  <span class="operator">|</span> ro   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+-------+------+</span></span><br><span class="line">mysql<span class="operator">&gt;</span> remove backend <span class="number">4</span>;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> save config;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> backends;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+-------+------+</span></span><br><span class="line"><span class="operator">|</span> backend_ndx <span class="operator">|</span> address            <span class="operator">|</span> state <span class="operator">|</span> type <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+-------+------+</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">1</span> <span class="operator">|</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.3</span>:<span class="number">3306</span> <span class="operator">|</span> up    <span class="operator">|</span> rw   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">2</span> <span class="operator">|</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.4</span>:<span class="number">3306</span> <span class="operator">|</span> up    <span class="operator">|</span> ro   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">3</span> <span class="operator">|</span> <span class="number">192.168</span><span class="number">.160</span><span class="number">.5</span>:<span class="number">3306</span> <span class="operator">|</span> up    <span class="operator">|</span> ro   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+--------------------+-------+------+</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Atlas管理操作中文版</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> help;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> command                    <span class="operator">|</span> description                                        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> help         <span class="operator">|</span> 查看help帮助                                       </span><br><span class="line"><span class="operator">|</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> backends     <span class="operator">|</span> 查看后端代理的数据库                                  </span><br><span class="line"><span class="operator">|</span> <span class="keyword">SET</span> OFFLINE $backend_id    <span class="operator">|</span> 平滑下线数据库，例：<span class="keyword">SET</span> OFFLINE <span class="number">1</span>;加后端ID            </span><br><span class="line"><span class="operator">|</span> <span class="keyword">SET</span> ONLINE $backend_id     <span class="operator">|</span> 平滑上线数据库，例：<span class="keyword">ADD</span> MASTER <span class="number">1</span>;加后端ID                            </span><br><span class="line"><span class="operator">|</span> <span class="keyword">ADD</span> MASTER $backend        <span class="operator">|</span> 添加一个主库，例：<span class="keyword">ADD</span> MASTER <span class="number">172.16</span><span class="number">.1</span><span class="number">.56</span>:<span class="number">3306</span>;                </span><br><span class="line"><span class="operator">|</span> <span class="keyword">ADD</span> SLAVE $backend         <span class="operator">|</span> 添加一个从库，例：<span class="keyword">ADD</span> SLAVE <span class="number">172.168</span><span class="number">.1</span><span class="number">.57</span>:<span class="number">3306</span>;                </span><br><span class="line"><span class="operator">|</span> REMOVE BACKEND $backend_id <span class="operator">|</span> 删除一个后端的库：例：REMOVE BACKEND <span class="number">1</span>；加后端ID                            </span><br><span class="line"><span class="operator">|</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> clients      <span class="operator">|</span> 查看可连接管理接口客户端                                    </span><br><span class="line"><span class="operator">|</span> <span class="keyword">ADD</span> CLIENT $client         <span class="operator">|</span> 添加一个客户端，例：<span class="keyword">ADD</span> CLIENT <span class="number">10.0</span><span class="number">.0</span><span class="number">.52</span>;            </span><br><span class="line"><span class="operator">|</span> REMOVE CLIENT $client      <span class="operator">|</span> 删除一个客户端，例：REMOVE CLIENT <span class="number">10.0</span><span class="number">.0</span><span class="number">.52</span>;         </span><br><span class="line"><span class="operator">|</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> pwds         <span class="operator">|</span> 查看Atlas可连接用户                                        </span><br><span class="line"><span class="operator">|</span> <span class="keyword">ADD</span> PWD $pwd               <span class="operator">|</span> 添加用户（密码会自动加密）例：<span class="keyword">ADD</span> PWD mha:mha;         </span><br><span class="line"><span class="operator">|</span> <span class="keyword">ADD</span> ENPWD $pwd             <span class="operator">|</span> 添加用户(需要加密后的密码)例:<span class="keyword">ADD</span> ENPWD mha:<span class="number">02</span>jBXONX098<span class="operator">=</span>     </span><br><span class="line"><span class="operator">|</span> REMOVE PWD $pwd            <span class="operator">|</span> 删除用户，例：REMOVE PwD mha;                        </span><br><span class="line"><span class="operator">|</span> SAVE CONFIG                <span class="operator">|</span> 保存到配置文件<span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">SELECT</span> VERSION             <span class="operator">|</span> 查看版本信息                           </span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------+----------------------------------------------------+</span></span><br></pre></td></tr></table></figure>




<p><strong>ELKstack简介</strong></p>
<p><strong>什么是ELK？</strong></p>
<p>通俗来讲，ELK是由Elasticsearch、Logstash、Kibana三个开源软件的组成的一个组合体，这三个软件当中，每个软件用于完成不同的功能，ELK又称为ELK stack,官方域名为stactic.co,ELK stack的主要优点有如下几个：</p>
<p>1.处理方式灵活：elasticsearch是实时全文索引，具有强大的搜索功能</p>
<p>2.配置相对简单：elasticsearch全部使用JSON 接口，logstash使用模块配置，kibana的配置文件部分更简单。</p>
<p>3.检索性能高效：基于优秀的设计，虽然每次查询都是实时，但是也可以达到百亿级数据的查询秒级响应。</p>
<p>4.集群线性扩展：elasticsearch和logstash都可以灵活线性扩展</p>
<p>5.前端操作绚丽：kibana的前端设计比较绚丽，而且操作简单</p>
<p><strong>什么是Elasticsearch?</strong></p>
<p>是一个高度可扩展的开源全文搜索和分析引擎，它可实现数据的实时全文搜索搜索、支持分布式可实现高可用、提供API接口，可以处理大规模日志数据，比如Nginx、Tomcat、系统日志等功能。</p>
<p><strong>什么是Logstash?</strong></p>
<p>可以通过插件实现日志收集和转发，支持日志过滤，支持普通log、自定义json格式的日志解析。</p>
<p><strong>什么是Kibana?</strong></p>
<p>主要是通过接口调用elasticsearch的数据，并进行前端数据可视化的展现。</p>
<p><a target="_blank" rel="noopener" href="https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.3.0.rpm">https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.3.0.rpm</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/mobz/elasticsearch-head">https://github.com/mobz/elasticsearch-head</a></p>
<p>ELKstack部署及配置<br>环境准备</p>
<table>
<thead>
<tr>
<th>公网IP</th>
<th>内网IP</th>
<th>主机名</th>
<th>部罯服务</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.51</td>
<td>172.16.1.51</td>
<td>elkstack01</td>
<td>elasticsearch、JDK</td>
<td>存储日志的数据库</td>
</tr>
<tr>
<td>10.0.0.52</td>
<td>172.16.1.52</td>
<td>elkstack02</td>
<td>elasticsearch、JDK</td>
<td>存储日志的数据库</td>
</tr>
<tr>
<td>10.0.0.53</td>
<td>172.16.1.53</td>
<td>elkstack03</td>
<td>Logstash、JDK</td>
<td>收集日志、过滤日志</td>
</tr>
<tr>
<td>10.0.0.54</td>
<td>172.16.1.54</td>
<td>elkstack04</td>
<td>Redis、Kibana</td>
<td>消息队列、日志展示</td>
</tr>
<tr>
<td>10.0.0.55</td>
<td>172.16.1.55</td>
<td>nginx01</td>
<td>nginx、filebeat</td>
<td>修改nginx日志格式为json收集</td>
</tr>
<tr>
<td>10.0.0.56</td>
<td>172.16.1.56</td>
<td>tomcat01</td>
<td>tomcat、JDK、filebeat</td>
<td>修改tomcat日志格式为json收集</td>
</tr>
</tbody></table>
<p><strong>安装包准备</strong></p>
<table>
<thead>
<tr>
<th>安装包名</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>elasticsearch-5.3.0.rpm</td>
<td>存储日志的数据库</td>
</tr>
<tr>
<td>elasticsearch-head.tar.gz</td>
<td>elasticsearch的web界面插件</td>
</tr>
<tr>
<td>logstash-5.3.0.rpm</td>
<td>日志收集、日志分析工具</td>
</tr>
<tr>
<td>kibana-5.3.0-x86_64.rpm</td>
<td>日志展示、日志查询工具</td>
</tr>
<tr>
<td>filebeat-5.3.2-x86_64.rpm</td>
<td>日志收集工具（比Logstash轻量）</td>
</tr>
<tr>
<td>jdk-8u121-linux-x64.tar.gz</td>
<td>JAVA容器(es、Logstash、tomcat需要）</td>
</tr>
<tr>
<td>nginx-1.10.3.tar.gz</td>
<td>测试收集nginx日志</td>
</tr>
<tr>
<td>apache-tomcat-8.0.38.tar.gz</td>
<td>测试收集tomcat日志</td>
</tr>
<tr>
<td>redis-3.2.8.tar.gz</td>
<td>消息队列工具</td>
</tr>
</tbody></table>
<p>关闭防火墙</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Centos6 关闭防火墙</span></span><br><span class="line">[root@db01 ~]# /etc/init.d/iptables stop</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Centos7 关闭防火墙</span></span><br><span class="line">[root@db01 ~]# systemctl stop firewalld</span><br></pre></td></tr></table></figure>

<p>关闭SELINUX</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">临时关闭</span></span><br><span class="line">[root@elkstack01 ~]# setenforce 0</span><br><span class="line">setenforce: SELinux is disabled</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">永久关闭</span></span><br><span class="line">[root@elkstack01 ~]# vim /etc/sysconfig/selinux</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This file controls the state of SELinux on the system.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">SELINUX= can take one of these three values:</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">	enforcing - SELinux security policy is enforced.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">	permissive - SELinux prints warnings instead of enforcing.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">	disabled - No SELinux policy is loaded.</span></span><br><span class="line">SELINUX=disabled	==&gt;		//原来是enforcing 改成disabled</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">SELINUXTYPE= can take one of these two values:</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">	targeted - Targeted processes are protected,</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">	mls - Multi Level Security protection.</span></span><br><span class="line">SELINUXTYPE=targeted</span><br></pre></td></tr></table></figure>

<p>设置epel源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">CentoS6 下载epel源</span></span><br><span class="line">[root@elkstack01 w]# wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Centos7 下载epel源</span></span><br><span class="line">[root@elkstacke1 w]# wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br></pre></td></tr></table></figure>

<p>修改时区</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将时区修改为上海时区</span></span><br><span class="line">[root@elkstack01 w]# cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line">cp: 是否覆盖&quot;/etc/localtime&quot;? y</span><br></pre></td></tr></table></figure>

<p>设置时间同步</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">同步服务器时间（切记保证集群之间时间一致非常重要）</span></span><br><span class="line">[root@db01 yum.repos.d]# yum install -y ntpdate</span><br><span class="line">[root@elkstack01 ~]# ntpdate time1.aliyun.com</span><br><span class="line">28 Feb 14:11:28 ntpdate[8904]: step time server 203.107.6.88 offset 3168820.831817 sec</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">或者</span></span><br><span class="line">[root@db02 ~]# crontab -e</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">时间同步</span></span><br><span class="line">*/5 * * * * ntpdate time1.aliyun.com &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">:wq</span><br></pre></td></tr></table></figure>

<p>部署Elasticsearch</p>
<p>在elkstack01和elkstack02两台机器分别安装elasticsearch，因为elasticsearch服务运行需要JAVA环境，所以两台服务器都需要安装</p>
<p>安装JDK环境</p>
<p>下载地址:<a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html">http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# tar xf jdk-8u121-linux-x64.tar.gz</span><br><span class="line">[root@db01 ~]# mv jdk.1.8.0_121 /usr/local/jdk1.8.sh</span><br><span class="line">[root@db01 ~]# ln -s /usr/local/jdk1.8 /usr/local/jdk</span><br><span class="line">[root@db01 ~]# vim /etc/profile.d/jdk1.8</span><br><span class="line">export JAVA_HOME=/usr/local/jdk1.8</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/jre/lib/rt.jar:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line">[root@db01 ~]# source /etc/profile</span><br><span class="line">[root@db01 ~]# java -version</span><br><span class="line">[root@db01 ~]# mv /etc/profile.d/jdk1.8 /etc/profile.d/jdk1.8.sh</span><br><span class="line">[root@db01 ~]# source /etc/profile</span><br><span class="line">[root@db01 ~]# java -version</span><br><span class="line">java version &quot;1.8.0_121&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_121-b13)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.121-b13, mixed mode)</span><br><span class="line">[root@db01 ~]# yum localinstall -y elasticsearch-5.3.0.rpm</span><br><span class="line">[root@db01 ~]# vim /etc/elasticsearch/jvm.options</span><br><span class="line">-Xms2g    ---&gt;   -Xms1g   #修改</span><br><span class="line">-Xmx2g    ---&gt;   -Xmx1g   #修改</span><br><span class="line">[root@db01 ~]# vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">cluster.name: my-application  ---&gt;  cluster.name: elk_cluster   <span class="comment">#17行取消注释修改</span></span></span><br><span class="line">:set nu 显示行数</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node.name: node01  ---&gt;  node.name: es-node01   <span class="comment">#23行取消注释修改</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">path.data: /path/to/data  ---&gt;  path.data: /data/elk/data   <span class="comment">#33行取消注释修改</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">path.logs: /path/to/logs  ---&gt;  path.logs: /data/elk/logs   <span class="comment">#37行取消注释修改</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">bootstrap.memory_lock: <span class="literal">true</span>  ---&gt;  bootstrap.memory_lock: <span class="literal">false</span>   <span class="comment">#43行取消注释修改</span></span></span><br><span class="line">bootstrap.system_call_filter: false   #44行手动添加</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">network.host: 192.168.0.1  ---&gt;  network.host: 0.0.0.0   <span class="comment">#56行取消注释修改</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">http.port: 9200  ---&gt;  http.port: 9200   <span class="comment">#60行取消注释</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">discovery.zen.ping.unicast.hosts: [<span class="string">&quot;host1&quot;</span>, <span class="string">&quot;host2&quot;</span>]  ---&gt;  discovery.zen.ping.unicast.hosts: [<span class="string">&quot;10.0.0.51&quot;</span>, <span class="string">&quot;10.0.0.52&quot;</span>]    <span class="comment">#69行取消注释修改</span></span></span><br><span class="line"></span><br><span class="line">[root@db01 ~]# grep -Ev &quot;^#|^$&quot; /etc/elasticsearch/elasticsearch.yml &gt; /etc/elasticsearch/elasticsearch.yml.a</span><br><span class="line">[root@db01 ~]# cd /etc/elasticsearch/</span><br><span class="line">[root@db01 elasticsearch]# mv elasticsearch.yml elasticsearch.yml.ori</span><br><span class="line">[root@db01 elasticsearch]# mv elasticsearch.yml.a 	elasticsearch.yml</span><br><span class="line">[root@db01 elasticsearch]# chown root.elasticsearch elasticsearch.yml</span><br><span class="line">[root@db01 elasticsearch]# cat elasticsearch.yml</span><br><span class="line">cluster.name: elk_cluster</span><br><span class="line">node.name: es-node01</span><br><span class="line">path.data: /data/elk/data</span><br><span class="line">path.logs: /data/elk/logs</span><br><span class="line">bootstrap.memory_lock: false</span><br><span class="line">bootstrap.system_call_filter: false</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br><span class="line">discovery.zen.ping.unicast.hosts: [&quot;10.0.0.51&quot;, &quot;10.0.0.52&quot;]</span><br><span class="line">[root@db01 elasticsearch]# scp /etc/elasticsearch/elasticsearch.yml 192.168.160.152:/etc/elasticsearch/</span><br><span class="line">[root@db02 ~]# vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line">cluster.name: elk_cluster</span><br><span class="line">node.name: es-node02</span><br><span class="line">path.data: /data/elk/data</span><br><span class="line">path.logs: /data/elk/logs</span><br><span class="line">bootstrap.memory_lock: false</span><br><span class="line">bootstrap.system_call_filter: false</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br><span class="line">discovery.zen.ping.unicast.hosts: [&quot;10.0.0.51&quot;, &quot;10.0.0.52&quot;]</span><br><span class="line">[root@db02 ~]# mkdir -p /data/elk/&#123;data,logs&#125;</span><br><span class="line">[root@db01 ~]# mkdir -p /data/elk/&#123;data,logs&#125;</span><br><span class="line">[root@db01 elasticsearch]# tree /data/</span><br><span class="line">/data/</span><br><span class="line">└── elk</span><br><span class="line">    ├── data</span><br><span class="line">    └── logs</span><br><span class="line"></span><br><span class="line">3 directories, 0 files</span><br><span class="line">[root@db02 ~]# vim /etc/security/limits.conf   #在最后一行添加</span><br><span class="line">* - nofile 65535</span><br><span class="line">* soft memlock unlimited</span><br><span class="line">* hard memlock unlimited</span><br><span class="line">* soft nofile 131072</span><br><span class="line">* hard nofile 131072</span><br><span class="line">[root@db01 ~]# vim /etc/security/limits.conf   #在最后一行添加</span><br><span class="line">* - nofile 65535</span><br><span class="line">* soft memlock unlimited</span><br><span class="line">* hard memlock unlimited</span><br><span class="line">* soft nofile 131072</span><br><span class="line">* hard nofile 131072</span><br><span class="line">[root@db01 elasticsearch]# systemctl start elasticsearch</span><br><span class="line">[root@db01 data]# ln -s /usr/local/jdk/bin/* /usr/bin/</span><br><span class="line">[root@db01 data]# chown -R elasticsearch.elasticsearch /data/elk/</span><br><span class="line">[root@db01 elasticsearch]# systemctl start elasticsearch</span><br><span class="line">[root@db01 elasticsearch]# netstat -lntup</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp6       0      0 :::9200                 :::*                    LISTEN      3101/java           </span><br><span class="line">tcp6       0      0 :::9300                 :::*                    LISTEN      3101/java           </span><br><span class="line"></span><br><span class="line">访问192.168.160.152:9200</span><br><span class="line">[root@elkstack01 elasticsearch-head]# yum install -y npm</span><br><span class="line">[root@elkstack01 elasticsearch-head]# cd /usr/local/</span><br><span class="line">[root@elkstack01 elasticsearch-head]# yum install -y git</span><br><span class="line">[root@elkstack01 elasticsearch-head]# git clone git://github.com/mobz/elasticsearch-head.git</span><br><span class="line">[root@db01 ~]# tar xf elasticsearch-head.tar.gz</span><br><span class="line">[root@db01 ~]# mv elasticsearch-head /usr/local/</span><br><span class="line">[root@db01 ~]# cd /usr/local/elasticsearch-head</span><br><span class="line">[root@elkstack01 elasticsearch-head]# npm cache clean -f</span><br><span class="line">[root@elkstack01 elasticsearch-head]# npm install -g n</span><br><span class="line">[root@elkstack01 elasticsearch-head]# n stable</span><br><span class="line">[root@elkstack01 elasticsearch-head]# npm install grunt -save</span><br><span class="line">[root@elkstack01 elasticsearch-head]# ll node_modules/grunt</span><br><span class="line">[root@elkstack01 elasticsearch-head]# npm install</span><br><span class="line">[root@elkstack01 elasticsearch-head]# npm run start &amp;</span><br><span class="line">访问192.168.160.152:9100</span><br><span class="line">[root@db01 ~]# vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line">cluster.name: elk_cluster</span><br><span class="line">node.name: es-node02</span><br><span class="line">path.data: /data/elk/data</span><br><span class="line">path.logs: /data/elk/logs</span><br><span class="line">bootstrap.memory_lock: false</span><br><span class="line">bootstrap.system_call_filter: false</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">解压JDK安装包</span></span><br><span class="line">[root@elkstack01 ~]# tar xf jdk-8u121-linux-x64.tar.gz</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将JDK安装包移动到安装目录下</span></span><br><span class="line">[root@elkstack01 ~]# mv jdk1.8.0_121 /usr/local/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">做软链接（方便日后升级）</span></span><br><span class="line">[root@elkstack01 w]# ln -s /usr/local/jdk1.8.0_121 /usr/local/jdk1.8</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">添加环境变量</span></span><br><span class="line">[root@elkstack01 w]# vim /etc/profile.d/jdk1.8.sh</span><br><span class="line">export JAVA_HOME=/usr/local/jdk1.8</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/jre/lib/rt.jar:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">加载环境变量</span></span><br><span class="line">[root@elkstack01 ~]# source /etc/profile</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">检查是否加载成功</span></span><br><span class="line">[root@elkstack01 ~]# java -version</span><br><span class="line">java version &quot;1.8.0_121&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_121-b13)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.121-b13, mixed mode)</span><br><span class="line"></span><br></pre></td></tr></table></figure>









<p><strong>安装elasticsearch插件</strong></p>
<p>插件是为了完成不同的功能，官方提供了一些插件但大部分是收费的，另外也有一些开发爱好者提供的插件，可以实现对elasticsearch集群的状态监控与管理配置等功能，我们现在要安装的是Elasticsearch的head插件，此插件提供elasticsearch的web界面功能。</p>
<p>安装Elasticsearch的head插件时，要安装npm，npm的全称是Node Package Manager，是随同NodeJS一起安装的包管理和分发工具，它很方便让JavaScript开发者下载、安装、上传以及管理已经安装的包。</p>
<p>在Elasticsearch 5.x版本以后不再支持直接安装head插件，而是需要通过启动一个服务方式。<br>Github地址：<a target="_blank" rel="noopener" href="https://github.com/mobz/elasticsearch-head">https://github.com/mobz/elasticsearch-head</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装npm（只需要在一个节点安装即可，如果前端还有nginx做反向代理可以每个节点都装）</span></span><br><span class="line">[root@elkstack01 ~]# yum install -y npm</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">进入下载<span class="built_in">head</span>插件代码目录</span></span><br><span class="line">[root@elkstack01 src]# cd /usr/local/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">从GitHub上克隆代码到本地</span></span><br><span class="line">[root@elkstack01 local]# git clone git://github.com/mobz/elasticsearch-head.git</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">克隆完成后，进入elasticsearch插件目录</span></span><br><span class="line">[root@elkstack01 local]# cd elasticsearch-head/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">清除缓存</span></span><br><span class="line">[root@elkstack01 elasticsearch-head]# npm cache clean -f</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用npm安装n模块（不同的项目js脚本所需的node版本可能不同，所以就需要node版本管理工具）</span></span><br><span class="line">[root@elkstack01 elasticsearch-head]# npm install -g n</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装最新版本n模块</span></span><br><span class="line">[root@elkstack01 elasticsearch-head]# n stable</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">生成grunt</span></span><br><span class="line">[root@elkstack01 elasticsearch-head]# npm install grunt -save</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">确认生成grunt文件</span></span><br><span class="line">[root@elkstack01 elasticsearch-head]# ll node_modules/grunt</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">执行安装grunt</span></span><br><span class="line">[root@elkstack01 elasticsearch-head]# npm install</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">后台启动<span class="built_in">head</span>插件（切记，必须在插件目录下执行启动命令）</span></span><br><span class="line">[root@elkstack01 elasticsearch-head]# npm run start &amp;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">验证端口是否启动成功</span></span><br><span class="line">[root@elkstack01 elasticsearch-head]# netstat -lntup</span><br><span class="line">tcp        0      0 0.0.0.0:9100                0.0.0.0:*                   LISTEN      11293/grunt</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动成功后，修改elasticsearch配置文件</span></span><br><span class="line">[root@elkstack01 elasticsearch-head]# vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">添加如下两行，开启跨域访问支持（添加在配置文件最后即可）</span></span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重启elasticsearch</span></span><br><span class="line">[root@elkstack01 elasticsearch-head]# /etc/init.d/elasticsearch restart</span><br></pre></td></tr></table></figure>





<p> <strong>第二章·Elasticsearch内部分片及分片处理机制介绍</strong></p>
<p>副本分片介绍</p>
<p>什么是副本分片？</p>
<p>副本分片的主要目的就是为了故障转移，如果持有主分片的节点挂掉了，一个副本分片就会晋升为主分片的角色。</p>
<p>在索引写入时，副本分片做着与主分片相同的工作。新文档首先被索引进主分片然后再同步到其它所有的副本分片。增加副本数并不会增加索引容量。</p>
<p>无论如何，副本分片可以服务于读请求，如果你的索引也如常见的那样是偏向查询使用的，那你可以通过增加副本的数目来提升查询性能，但也要为此，增加额外的硬件资源。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@elkstack01 ~]# curl -XPUT 10.0.0.51:9200/_template/my_template -d&#x27;</span><br><span class="line">&#123;    &quot;template&quot;: &quot;*&quot;,</span><br><span class="line">     &quot;settings&quot;: &#123;</span><br><span class="line">        &quot;index&quot;: &#123;</span><br><span class="line">            &quot;number_of_shards&quot;: 6,</span><br><span class="line">            &quot;number_of_replicas&quot;: 1</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@elkstack02 ~]# curl –sXGET http://10.0.0.51:9200/_cluster/health?pretty=true</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>python脚本检测</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#编写python脚本</span></span><br><span class="line">[root@elkstack01 ~]<span class="comment"># vim es_cluster_status.py</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="comment">#Author:_DriverZeng_</span></span><br><span class="line"><span class="comment">#Date:2017.02.12</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> smtplib</span><br><span class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</span><br><span class="line"><span class="keyword">from</span> email.utils <span class="keyword">import</span> formataddr</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line">body = <span class="string">&quot;&quot;</span></span><br><span class="line">false = <span class="string">&quot;false&quot;</span></span><br><span class="line">clusterip = <span class="string">&quot;10.0.0.51&quot;</span></span><br><span class="line">obj = subprocess.Popen((<span class="string">&quot;curl -sXGET http://&quot;</span>+clusterip+<span class="string">&quot;:9200/_cluster/health?pretty=true&quot;</span>),shell=<span class="literal">True</span>, stdout=subprocess.PIPE)</span><br><span class="line">data =  obj.stdout.read()</span><br><span class="line">data1 = <span class="built_in">eval</span>(data)</span><br><span class="line">status = data1.get(<span class="string">&quot;status&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> status == <span class="string">&quot;green&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;\033[1;32m 集群运行正常 \033[0m&quot;</span></span><br><span class="line"><span class="keyword">elif</span> status == <span class="string">&quot;yellow&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;\033[1;33m 副本分片丢失 \033[0m&quot;</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;\033[1;31m 主分片丢失 \033[0m&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#执行结果如下</span></span><br><span class="line">[root@elkstack01 ~]<span class="comment"># python es_cluster_status.py</span></span><br><span class="line">集群运行正常</span><br></pre></td></tr></table></figure>

<p>P649 睡觉</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/logstash/bin/logstash -e &#x27;input &#123; stdin&#123;&#125; &#125; output &#123; file &#123; path =&gt; &quot;/tmp/test_%&#123;+YYYY.MM.dd&#125;.log&quot;&#125;&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>暂时跳过elk</p>
<h3 id="1-Shelll课程大纲"><a href="#1-Shelll课程大纲" class="headerlink" title="1.Shelll课程大纲"></a>1.Shelll课程大纲</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br></pre></td><td class="code"><pre><span class="line">1.shell基本概述</span><br><span class="line">2.shell变量定义variables</span><br><span class="line">3.shell数值运算expr bc</span><br><span class="line">4.shell流程控制if case</span><br><span class="line">6.shell循环语句for while</span><br><span class="line">7.shell数组函数array function</span><br><span class="line">8.shell内置命令break continue exit</span><br><span class="line">9.shell轻量项目</span><br><span class="line">10.shell正则表达式 sed awk</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.什么是shel1</span><br><span class="line">2.什么是shell脚本</span><br><span class="line">3.shel1脚本能做什么</span><br><span class="line">	减少重复性、周期性的工作。</span><br><span class="line">	减少故障的几率。</span><br><span class="line">4.怎么学shel1脚本，shel1脚本需要预备知识</span><br><span class="line">5.shel1脚本的规范</span><br><span class="line">6.如何正确执行shell脚本</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@bgx ~]# vim /tmp/test</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash    <span class="comment">#解释器加与不加是存在区别</span></span></span><br><span class="line">echo &quot;Hello world&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.直接使用解释器器执行脚本，无需执行权限</span></span><br><span class="line">[root@bgx ~]# bash /tmp/test</span><br><span class="line">Hello world</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.以./运行的方式执行，需要拥有执行权限</span></span><br><span class="line">[root@bgx ~]# chmod 755 /tmp/test</span><br><span class="line">[root@bgx ~]# ./tmp/test</span><br><span class="line">Hello world</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">	脚本中如果不写，在执行过程中如果./方式执行（需要权限），默认调用bash命令翻译该文件</span><br><span class="line">	脚本中如果写了使用什么解释器翻译，那在使用./时则会调用对应的解释器执行</span><br><span class="line">	执行方式</span><br><span class="line">	bash test.sh	无需权限，直接调用解释器翻译</span><br><span class="line">	./test.sh		需要权限，同时需要定义对应的解释器，不定义默认bash</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">system_cpu_load_1</span><br><span class="line">system_cpu_load_5</span><br><span class="line">system_cpu_load_15</span><br><span class="line"></span><br><span class="line">1.变量的定义，需要具备一定的含义，同时不要与系统的命令产生冲突。</span><br><span class="line">HositName_IP</span><br><span class="line">HostName_Network</span><br><span class="line"></span><br><span class="line">定义变量方式</span><br><span class="line">[root@m01 ~]# HostName=$(hostname)</span><br><span class="line">[root@m01 ~]# echo $HostName</span><br><span class="line">mo1</span><br><span class="line">如下的方式会报错</span><br><span class="line"><span class="meta prompt_">[root@m01~]# </span><span class="language-bash">HostName = $(hostname)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">练习</span><br><span class="line">[root@VM-4-3-centos ~]# var=&quot;hello shell&quot;</span><br><span class="line">[root@VM-4-3-centos ~]# echo $var</span><br><span class="line">hello shell</span><br><span class="line">[root@VM-4-3-centos ~]# echo $var_log   #var_log当作一个整体</span><br><span class="line"></span><br><span class="line">[root@VM-4-3-centos ~]# echo $&#123;var&#125;_log</span><br><span class="line">hello shell_log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.在定义变量的时候，比如：var=&quot;$(hostname)&quot;</span><br><span class="line">2.在引用变量的时候，尽可能的使用双引号	echo &quot;$var&quot;</span><br><span class="line">3.在我们使用echo输出的时候，如果输出的字符串中有特殊的符号，建议使用单引	echo&#x27;#$123&#x27;</span><br><span class="line"></span><br><span class="line">[rootam01 ~]# echo &quot;$var is good is \$500&quot;</span><br><span class="line">	希望$var被解析</span><br><span class="line">	而$500不被解析</span><br><span class="line">	</span><br><span class="line">------------------------------------------------	</span><br><span class="line">1.如何自定义变量</span><br><span class="line">2.变量的命名规范，不要与系统冲突，不要太随意。</span><br><span class="line">3.使用变量需要注意$var_log 以及 &quot;&quot; &#x27;&#x27;带来的问题。</span><br><span class="line">------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">系统变量</span><br><span class="line">-------------------------------------------------</span><br><span class="line">1.简单的使用一下系统的变量，当然也可以使用export打印当前系统所有的环境变量</span><br><span class="line">[root@mo1 shell01]# cat env.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">echo &quot;用户的家目录：$HOME&quot;</span><br><span class="line">echo &quot;当前主机名是：$HOSTNAME&quot;</span><br><span class="line">echo &quot;当前所在目录：$PWD&quot;</span><br><span class="line">echo &quot;当前连接服务器使用的地址和端口是：$SSH_CONNECTION&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.如果系统的环境变量不满足要求，可以自定义</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1）定义环境变量：<span class="built_in">export</span>变量，将自定义变量转换成环境变量</span></span><br><span class="line">[root@bgx shell]# var2=hello</span><br><span class="line">[root@bgx shell]# echo $var2</span><br><span class="line">hello</span><br><span class="line">[root@bgx shell1# cat a.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">echo $var2</span><br><span class="line"><span class="meta prompt_">[root@bgxshel1]#</span><span class="language-bash">sh a.sh<span class="comment">#执行a.sh 时，会使用另一个bash去执行，就访问不$VAR1的值</span></span></span><br><span class="line"></span><br><span class="line">[root@bgx shell]# export var2=hello  #将变量转为环境变量</span><br><span class="line">[root@bgx shell]# sh a.sh	#再次执行脚本</span><br><span class="line">hello</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.预先定义的变量参数示例，系统内置变量的使用方法。</span><br><span class="line">-------------------------------------------------</span><br><span class="line">[root@bgx shell]# cat variable.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">echo &quot;#当前shel1脚本的文件名：$0&quot;</span><br><span class="line">echo &quot;#第1个shell脚本位置参数：$1&quot;</span><br><span class="line">echo &quot;#第2个shell脚本位置参数：$2&quot;</span><br><span class="line">echo &quot;#第3个shel1脚本位置参数：$3&quot;</span><br><span class="line">echo &quot;#所有传递的位置参数是：$*&quot;</span><br><span class="line">echo &quot;#所有传递的位置参数是：$@&quot;</span><br><span class="line">echo &quot;#总共传递的参数个数是：$#&quot;</span><br><span class="line">echo &quot;#当前程序运行的PID是：$$&quot;</span><br><span class="line">echo &quot;#上一个命令执行的返回结果：$?&quot;</span><br><span class="line"></span><br><span class="line">需要注意$*和$@的区别</span><br><span class="line">    可以看到不加引号时，二者都是返回传入的参数，但加了引号后</span><br><span class="line">    $*把参数作为一个字符串整体（单字符串）返回，</span><br><span class="line">    $@把每个参数作为一个一个字符串返回</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4.位置是什么？在执行脚本的时候，在脚本后面写入的内容，按空格分隔</span><br><span class="line">-------------------------------------------------</span><br><span class="line">[rootam01 shell01]# /etc/init.d/network</span><br><span class="line">Usage: /etc/init.d/network &#123;start|stop|status|restart|reload|force-reload&#125;</span><br><span class="line">[rootam01 shell01]# /etc/init.d/network start  #start 就算第一个位置参数 $1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">2</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">3</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">4</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">9</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">&#123;10&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5.补充：将命令执行的结果传递给变量。（命令替换）</span><br><span class="line">----------------------------------------</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">根据系统时间，打印几年时间和明年时间</span></span><br><span class="line">[root@bgx shell]# echo &quot;This is $(date +%Y) year&quot;</span><br><span class="line">This is 2019 year</span><br><span class="line">[root@bgx shell]# echo &quot;This is $(($(date +%Y)+1)) year&quot;</span><br><span class="line">This is 2020 year</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">命令的嵌套使用，使用$($())</span></span><br><span class="line">[root@bgx ~]# find /root/ -name *.txt</span><br><span class="line">[root@bgx ~]# db=$(tar zcvf root.tar.gz $(find /root/ -name *.txt))</span><br><span class="line">[rootabgx ~]# echo $db	#查看db变量存储的值</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">打包/etc/下面所有以.conf结尾的文件</span><br><span class="line">[root@bgx ~]# tar zcvf etc.tar.gz $(find /etc/ -name *.conf)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">read示例</span><br><span class="line">	read示例语法，测试用户输入的IP是否通</span><br><span class="line">		1.执行脚本时，提示：请输入ip read</span><br><span class="line">		2.使用ping命令去探测用户输入的IP是否通ping -W1 -c1 192.168.1.1</span><br><span class="line">		如果通则返回存活，如果不通则返回失败。</span><br><span class="line">		</span><br><span class="line">[root@m01 shell01]# cat ping1.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.提示用户输入一个IP地址</span></span><br><span class="line">read -p &quot;请输入需要检测的IP地址：&quot; IP</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.使用ping命令检测IP地址是否通讯</span></span><br><span class="line">ping -W1 -c1 $IP &amp;&gt;/dev/null</span><br><span class="line">rc=$?</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.检查上一次命令执行返回的状态码是否正常</span></span><br><span class="line">if [ $rc -eq 0 ];then</span><br><span class="line">    echo &quot;$IP 能正常通信&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;$IP 无法正常通信&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">------------------------------------</span><br><span class="line">4.使用read命令写一个脚本修改主机名和IP地址</span><br><span class="line">    1.提示用户输入主机名称</span><br><span class="line">    3.询问用户是否确此操作</span><br><span class="line">    4.真的执行</span><br><span class="line"></span><br><span class="line">[root@m01 shell01]# cat read3.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.提示用户输入新的主机名称，然后打印新的主机名称</span></span><br><span class="line">read -p &quot;请输入你想修改的主机名称：&quot; HostName</span><br><span class="line">echo &quot;你将要修改的主机名称为：$HostName&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.是否确认修改，如果确认则真的执行shell命令，如果不确认则退出</span></span><br><span class="line">read -p &quot;你确定真的要修改如下内容吗[Y|N]？&quot; readly</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.判断用户输入的是Y还是N，如果是Y则真的执行，如果是其他则退出</span></span><br><span class="line">if [ $readly == &quot;Y&quot; ];then</span><br><span class="line">    hostnamectl set-hostname $HostName</span><br><span class="line">else</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<ul>
<li>1.shell基本概述</li>
<li>2.shell变量定义<code>variables</code></li>
<li>3.shell数值运算<code>expr bc</code></li>
<li>4.shell流程控制<code>if case</code></li>
<li>6.shell循环语句<code>for while</code></li>
<li>7.shell数组函数<code>array function</code></li>
<li>8.shell内置命令<code>break continue exit</code></li>
<li>9.shell轻量项目</li>
</ul>
<p><strong>2.Shell基本概述</strong></p>
<p><strong>1.什么是shell</strong></p>
<p>Shell是一个命令解释器，它在操作系统的最外层，负责直接与用户进行对话，将用户输入的命令翻译给操作系统，并将处理的结果输出至屏幕。</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220403225412236.png" alt="image-20220403225412236"></p>
<p>当然shell命令是存在交互式、和非交互式的两种方式。</p>
<p>那shell交互式是什么：其实是我们日常使用最多的一种模式、登录终端、执行命令、返回结果。再次输入命令、然后等待结果。最后结束工作退出Shell会话。当退出Shell会话后，当前的shell会话也就终止了。</p>
<p>那什么又是shell非交互式：在这种模式下，shell不与你进行交互，而是直接读取某个文件进行执行。那文件中都有什么，“其实就是一堆的命令”。当该文件丛头执行到尾，结束后，当前shell也就终止了。</p>
<p><strong>2.什么是shell脚本</strong></p>
<p>1）将系统命令堆积在一起，顺序执行（简称：系统命令堆积）</p>
<p>2）特定的格式 + 特定的语法 + 系统的命令 &#x3D; 文件</p>
<p><strong>3.shell脚本能做什么（shell其实就是基于标准化之上的-&gt;脚本工具)</strong></p>
<p>1.基础配置：系统初始化操作、系统更新、内核调整、网络、时区、SSH优化</p>
<p>2.安装程序：部署LNMP、LAMP、MySQL、Nginx、Redis等等</p>
<p>3.配置变更: Nginx Conf、PHP Conf、MySQL Conf、Redis Conf</p>
<p>4.业务部署: Shell配合git、jenkins实现自动化部署php、java代码，以及代码回滚</p>
<p>5.日常备份：使用Shell脚本对MySQL进行每晚的全备与增量备份</p>
<p>6.信息采集：Zabbix+Shell，硬件、系统、服务、网络、等等</p>
<p>7.日志分析：取值&gt;排序&gt;去重&gt;统计&gt;分析</p>
<p>8.服务扩容：扩容：控服务器集群cpu,如cpu负载持续80%+触发动作(脚本)，脚本：调用api开通云主机-&gt;初始化环境&gt;加入集群&gt;对外提供</p>
<p>9.服务缩容：监控服务器集群cpu使用率，-&gt;低于20%-&gt;检测当前有多少web节点-&gt;判断是否超过预设-&gt;缩减到对应的预设状态-&gt;变更负载的配置</p>
<p>注意Shell脚本主要的作用是简化操作步骤，提高效率，减少人为干预，减少系统故障</p>
<p><strong>4.学习shell脚本需要哪些预备知识，如何才能学好shell脚本</strong></p>
<p>1）熟练使用vim编辑器</p>
<p>2）熟练使用linux命令</p>
<p>3）熟练使用linux三剑客</p>
<p>注意：如果我们对命令使用不够熟练、对基本服务也不会手动搭建、那么一定学不会Shell</p>
<p>那么我们究竟如何才能学好Shell脚本：基础命令+基础服务+经常练习+思路！！！</p>
<p><strong>5.shell的基本规范</strong></p>
<p>1、脚本存放固定目录&#x2F;scripts</p>
<p>2、开头加 !&#x2F;bin&#x2F;bash作用：告诉脚本使用的是哪种命令解释器。如不指shell，默认以bash执行。<br>3、附带作者及版权信息</p>
<p>4、脚本扩展名为*.sh</p>
<p>5、脚本中尽量不用中文</p>
<p>6、成对的符号一次书写完成</p>
<p>7、循环格式一次性输入完成</p>
<p><strong>6.shell脚本的执行方式</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx ~]# vim /tmp/test</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash    <span class="comment">#解释器加与不加是存在区别</span></span></span><br><span class="line">echo &quot;Hello world&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.直接使用解释器器执行脚本，无需执行权限</span></span><br><span class="line">[root@bgx ~]# bash /tmp/test</span><br><span class="line">Hello world</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.以./运行的方式执行，需要拥有执行权限</span></span><br><span class="line">[root@bgx ~]# chmod 755 /tmp/test</span><br><span class="line">[root@bgx ~]# ./tmp/test</span><br><span class="line">Hello world</span><br></pre></td></tr></table></figure>

<p><strong>02.Shell脚本变量</strong></p>
<p><strong>1.Shell变量概述</strong></p>
<p><strong>1.什么是变量</strong></p>
<p>变量是shell传递数据的一种方法，简单理解：就是用一个固定的字符串去表示不固定的值，便于后续引用。</p>
<p><strong>2.变量命名规范</strong></p>
<p>变量定义时名称有要求：字母、数字、下划线几个组成，尽量字母开头，{变量名最好具备一定的含义}</p>
<p>ip&#x3D;10.0.0.100</p>
<p>ip1&#x3D;10.0.0.100</p>
<p>Hostname_Ip&#x3D;10.0.0.100</p>
<p>hostname_IP&#x3D;10.0.0.100</p>
<p>等号是赋值，需要注意：等号两边不能有空格，其次定义的变量不要与系统命令出现冲突。</p>
<p><strong>3.Shell变量定义的方式</strong></p>
<p>1.用户自定义变量：人为定义变量名称。</p>
<p>2.系统环境变量：保存的是和系统操作环境相关的数据。</p>
<p>3.位置参数变量：向脚本中进行参数传递，变量名不能自定义，变量作用是固定的。</p>
<p>4.预定义的变量：是Bash中已经定义好的变量，变量名不能自定义，变量作用也是固定的。</p>
<p><strong>4.Shell变量定义实践</strong></p>
<p>1.用户自定义变量示例，当前shell有效</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1）定义变量，变量名=变量值。不能出现”横岗<span class="string">&quot;命名</span></span></span><br><span class="line">[root@bgx shell]# var=&quot;hello shell&quot;	 #定义变量有空格必须使用双引号</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">2）引用变量，$变量名或<span class="variable">$&#123;变量名&#125;</span></span></span></span><br><span class="line">[root@bgx shell]# echo $var</span><br><span class="line">hello shell</span><br><span class="line">[root@bgx shell]# echo $var_log</span><br><span class="line"></span><br><span class="line">[root@bgx shell]# echo $&#123;var&#125;_log</span><br><span class="line">sello shell_log</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">3）查看变量，set显示所有变量，包括自定义变量和环境变量</span></span></span><br><span class="line">[root@bgx shell]# set/grep var1</span><br><span class="line">varl=&#x27;Hello Wolrd&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">4）取消变量，作用范围：仅在当前shell中有效</span></span></span><br><span class="line">[root@bgx shell]# unset var1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">5）注意事项，引用变量时注意事项，&quot;</span><span class="string">&quot;双引号属于弱引用，&#x27;&#x27;单引号属于强引用</span></span></span><br><span class="line">[root@bgx shell]# var2=Iphone</span><br><span class="line">[root@bgx shell]# echo &quot;$var2 is good&quot;</span><br><span class="line">Iphone is good</span><br><span class="line">[root@bgx shell]# echo &#x27;$var2 is good&#x27;</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="string">var2 is good</span></span></span><br></pre></td></tr></table></figure>

<p>2.系统环境变量示例，在当前shell和子shell有效</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1）定义环境变量：<span class="built_in">export</span>变量，将自定义变量转换成环境变量</span></span><br><span class="line">[root@bgx shell]# var2=hello</span><br><span class="line">[root@bgx shell]# echo $var2</span><br><span class="line">hello</span><br><span class="line">[root@bgx shell1# cat a.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">echo $var2</span><br><span class="line"><span class="meta prompt_">[root@bgxshel1]#</span><span class="language-bash">sh a.sh<span class="comment">#执行a.sh 时，会使用另一个bash去执行，就访问不$VAR1的值</span></span></span><br><span class="line"></span><br><span class="line">[root@bgx shell]# export var2=hello  #将变量转为环境变量</span><br><span class="line">[root@bgx shell]# sh a.sh	#再次执行脚本</span><br><span class="line">hello</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2）使用系统已定义好的环境变量</span></span><br><span class="line">[root@bgx shell]# cat env.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">echo &quot;用户的家目录：$HOME&quot;</span><br><span class="line">echo &quot;当前主机名是：$HOSTNAME&quot;</span><br><span class="line">echo &quot;当前所在目录：$PWD&quot;</span><br><span class="line"></span><br><span class="line">[root@bgx shell]# sh env.sh</span><br><span class="line">用户的家目录：/root</span><br><span class="line">当前主机名是：docker01</span><br><span class="line">当前所在目录：/shel1</span><br></pre></td></tr></table></figure>

<p>3.预先定义的变量参数示例，系统内置变量的使用方法。需要注意$*和$@的区别</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.脚本如下</span></span><br><span class="line">[root@bgx shell]# cat variable.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">echo &quot;#当前shel1脚本的文件名：$0&quot;</span><br><span class="line">echo &quot;#第1个shell脚本位置参数：$1&quot;</span><br><span class="line">echo &quot;#第2个shell脚本位置参数：$2&quot;</span><br><span class="line">echo &quot;#第3个shel1脚本位置参数：$3&quot;</span><br><span class="line">echo &quot;#所有传递的位置参数是：$*&quot;</span><br><span class="line">echo &quot;#所有传递的位置参数是：$@&quot;</span><br><span class="line">echo &quot;#总共传递的参数个数是：$#&quot;</span><br><span class="line">echo &quot;#当前程序运行的PID是：$$&quot;</span><br><span class="line">echo &quot;#上一个命令执行的返回结果：$?&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.执行结果如下</span></span><br><span class="line">[root@bgx shell]# sh variable.sh 11 22 33 44</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当前shell脚本的文件名：variable.sh</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第1个shell脚本位置参数：11</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第2个shell脚本位置参数：22</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第3个shell脚本位置参数：33</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">所有传递的位置参数是：11 22 33 44</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">所有传递的位置参数是：11 22 33 44</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">总共传递的参数个数是：4</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当前程序运行的PID是：18564</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">上一个命令执行的返回结果：0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4.补充：将命令执行的结果传递给变量。（命令替换） $(command)  &#96;&#96;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">根据系统时间，打印几年时间和明年时间</span></span><br><span class="line">[root@bgx shell]# echo &quot;This is $(date +%Y) year&quot;</span><br><span class="line">This is 2019 year</span><br><span class="line">[root@bgx shell]# echo &quot;This is $(($(date +%Y)+1)) year&quot;</span><br><span class="line">This is 2020 year</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">命令的嵌套使用，使用$($())</span></span><br><span class="line">[root@bgx ~]# find /root/ -name *.txt</span><br><span class="line">[root@bgx ~]# db=$(tar zcvf root.tar.gz $(find /root/ -name *.txt))</span><br><span class="line">[rootabgx ~]# echo $db	#查看db变量存储的值</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>2.Shell变量赋值</strong></p>
<p>除了自定义变量，以及系统内置变量，还可以使用read命令通过交互式方式传递变量</p>
<p>1.read示例语法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat read_1.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">read-p &quot;提示信息：&quot; var1</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">read</span>- t 5 -p <span class="string">&quot;提示信息：&quot;</span> var2</span></span><br><span class="line"></span><br><span class="line">echo &quot;你输入的变量是&quot; $var1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">执行</span></span><br><span class="line">[root@bgx shell]# sh read_1.sh</span><br><span class="line">提示信息：Thisis Test</span><br><span class="line">你输入的变量是This is Test</span><br></pre></td></tr></table></figure>

<p>2.read示例语法，简单备份场景</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat read_2.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">back_dir1=/var/backup</span><br><span class="line">read -p &quot;请输入你的备份目录：&quot; back_dir2</span><br><span class="line">echo $back_dirl</span><br><span class="line">echo $back_dir2</span><br></pre></td></tr></table></figure>



<p><strong>3.Shell变量替换</strong></p>
<table>
<thead>
<tr>
<th>变量</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>${变量#匹配规则</td>
<td>从头开始匹配，最短删除</td>
</tr>
<tr>
<td>${变量##匹配规则}</td>
<td>从头开始匹配，最长删除</td>
</tr>
<tr>
<td>${变量%匹配规则}</td>
<td>从尾开始匹配，最短删除</td>
</tr>
<tr>
<td>${变量%%匹配规则}</td>
<td>从尾开始匹配，最长删除</td>
</tr>
<tr>
<td>${变量&#x2F;旧字符串&#x2F;新字符串}</td>
<td>替换变量内的旧字符串为新字符串，只替换第一个</td>
</tr>
<tr>
<td>${变量&#x2F;&#x2F;旧字符串&#x2F;新字符串}</td>
<td>替换变量内的旧字符串为新字符串，全部替换</td>
</tr>
</tbody></table>
<p>1.从前往后删除变量内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx ~]<span class="comment"># url=wwwsina.com.cn	#定义变量</span></span><br><span class="line">[root@bgx ~]<span class="comment"># echo $&#123;url&#125;			#输出变量的值</span></span><br><span class="line">www.sina.com.cn</span><br><span class="line">[root@bgx ~]<span class="comment"># echo $&#123;url#*.&#125;		#从前往后，最短匹配</span></span><br><span class="line">sina.com.cn</span><br><span class="line">[root@bgx ~]<span class="comment"># echo $&#123;url##*.&#125;		#从前往后，最长匹配</span></span><br><span class="line">cn</span><br></pre></td></tr></table></figure>

<p>2.从后往前删除变量内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx~]<span class="comment"># url=www.sina.com.cn	#定义变量</span></span><br><span class="line">[root@bgx ~]<span class="comment"># echo $&#123;url&#125;			#输出变量结果</span></span><br><span class="line">www.sina.com.cn</span><br><span class="line">[root@bgx ~]<span class="comment"># echo $&#123;url%.*&#125;		#从后往前，最短匹配</span></span><br><span class="line">www.sina.com</span><br><span class="line">[root@bgx ~]<span class="comment"># echo $&#123;url%%.*&#125;		#从后往前，最长匹配 贪婪匹配</span></span><br><span class="line">www</span><br></pre></td></tr></table></figure>

<p>3.变量内容替换</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx ~]<span class="comment"># url=www.sina.com.cn</span></span><br><span class="line">[root@bgx ~]<span class="comment"># echo $&#123;url/sina/oldboyedu&#125;	#替换sina为oldboyedu</span></span><br><span class="line">www.oldboyedu.com.cn</span><br><span class="line">[root@bgx ~]<span class="comment"># echo $&#123;url/n/N&#125;				#替换第一个小n为大写N</span></span><br><span class="line">www.siNa.com.cn</span><br><span class="line">[root@bgx ~]<span class="comment"># echo $&#123;url//n/N&#125;				#替换全部小n为大写N</span></span><br><span class="line">www.siNa.com.cN</span><br></pre></td></tr></table></figure>

<p>4.场景实践，查看内存当前使用状态，如果使用率超过80%则报警发邮件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">[root@bgx]# </span><span class="language-bash"><span class="built_in">cat</span> memory_use.sh</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">Mem_Use=$(free -m|grep ^M|awk &#x27;&#123;print $3/$2*100&#125;&#x27;)</span><br><span class="line">if [ $&#123;Mem_Use%.*&#125; -ge 30 ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;Memory IS ERROR $&#123;Mem_Use%.*&#125;%&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;Memory IS OK $&#123;Mem_Use%.*&#125;%&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>





<p><strong>shell-day02</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">1.在每月第一天备份并压缩/etc目录的所有内容，存放到/root/bak目录，存放的形式2019_04_10_etc.tar.gz,脚本名称为fileback,存放在/root的家目录下。</span><br><span class="line"></span><br><span class="line">1.备份什么？			源 /etc</span><br><span class="line">2.备份到哪？			目标/root/bak</span><br><span class="line">3.使用什么方式？	   压缩 tar</span><br><span class="line">4.备份的周期？		每月第一天，如何每月第一天。crond</span><br><span class="line"></span><br><span class="line">[root@oldboyedu ~]# cat fileback</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line"></span><br><span class="line">DestPath=/root/bak</span><br><span class="line">Date=$(date +%Y_%m_%d)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.准备目标位置</span></span><br><span class="line">[ ! -d $DestPath ] &amp;&amp; mkdir -p $DestPath</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.备份到目标位置</span></span><br><span class="line">tar czf $DestPath/$&#123;Date&#125;_etc.tar.gz /etc</span><br><span class="line"></span><br><span class="line">[root@VM-4-3-centos ~]# crontab -l</span><br><span class="line">00 23 1 * * bash /root/fileback &amp;&gt;/dev/null</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4.场景实践，查看内存/当前使用状态，如果使用率超过80%则报警发邮件</span><br><span class="line">1.如何查看内存	free -m</span><br><span class="line">2.如何查看内存百分比 使用的/总的*100=使用百分比 free -m|awk &#x27;/^Mem/ &#123;print $3/$2*100&#125;&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">监控内存使用百分比，超过百分之80则报警</span></span><br><span class="line"></span><br><span class="line">free_use=$(free -m|awk &#x27;/^Mem/ &#123;print $3/$2*100&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">if [ $&#123;free_use%.*&#125; -gt 80];then</span><br><span class="line">        echo &quot;你的内存超过了百分之80，当前是$&#123;free_use%.*&#125;%&quot; </span><br><span class="line">else</span><br><span class="line">        echo &quot;你的内存正常使用，当前是$&#123;free_use%.*&#125;%&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5.场景实践，在/backup下创建10个.txt的文件，找到/backup目录下所有后缀名为.txt的文件</span><br><span class="line">1)批量修改txt为txt.bak					find</span><br><span class="line">2）把所有的.bak文件打包压缩为123.tar.gz		tar</span><br><span class="line">3）批量还原文件的名字，及把增加的.bak再删除	find</span><br><span class="line"></span><br><span class="line">[root@VM-4-3-centos ~]# vim rename.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.改名</span></span><br><span class="line">find /backup -iname &quot;*.txt&quot;|sed -r &#x27;s#(.*)#mv \1 \1.bak#g&#x27;|bash</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.打包</span></span><br><span class="line">tar czf /backup/123.tar.gz $(find /backup -iname &quot;*.bak&quot;)</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.还原</span></span><br><span class="line">find /backup -iname &quot;*.bak&quot;|sed -r &#x27;s#(.*).bak#mv \1.bak \1#g&#x27;|bash</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="4-Shell变量运算"><a href="#4-Shell变量运算" class="headerlink" title="4.Shell变量运算"></a>4.Shell变量运算</h4><p>1.整数运算，<code>expr、$()())、$[]</code>，不支持小数运算</p>
<table>
<thead>
<tr>
<th>操作符</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>num1+ num2</td>
<td>加</td>
</tr>
<tr>
<td>num1 - num2</td>
<td>减</td>
</tr>
<tr>
<td>num1 * num2</td>
<td>乘</td>
</tr>
<tr>
<td>num1 &#x2F; num2</td>
<td>除</td>
</tr>
<tr>
<td>num1 % num2</td>
<td>余</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#定义变量，使用expr、$(())、$[]、进行加减乘除。expr必须空格隔开。</span></span><br><span class="line">[root@bgx shell]<span class="comment"># num1=10</span></span><br><span class="line">[root@bgx shell]<span class="comment"># num2=20</span></span><br><span class="line">[root@bgx shell]<span class="comment"># expr $num1 + $num2</span></span><br><span class="line">[root@bgx shell]<span class="comment"># echo $(( $num1 + $num2 ))</span></span><br><span class="line">[root@bgx shell]<span class="comment"># echo $[ $num1 + $num2 ]</span></span><br></pre></td></tr></table></figure>

<p>2.小数运算bc，用的不是很多，了解即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]<span class="comment"># yum install bc -y</span></span><br><span class="line">[root@bgx shell]<span class="comment"># écho &quot;2*4&quot; |bc</span></span><br><span class="line">8</span><br><span class="line">[root@bgx shell]<span class="comment"># echo &quot;2^4&quot; |bc</span></span><br><span class="line">16</span><br><span class="line">[root@bgx shell]<span class="comment"># echo &quot;scale=2;6/4&quot; /bc	#取2位小数</span></span><br><span class="line">1.50</span><br><span class="line">[root@bgx shell]<span class="comment"># awk &#x27;BEGIN&#123;print 1/2&#125;&#x27;</span></span><br><span class="line">0.5</span><br></pre></td></tr></table></figure>

<p>3.使用Shell脚本打印，系统版本、内核版本平台、虚拟平台、静态主机名、eth0网卡IP地址、lo网卡IP地址、当前主机的外网IP地址curl icanhazip.com</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">System=$(hostnamectl |grep System|awk &#x27;&#123;print $3,$4,$5&#125;&#x27;)</span><br><span class="line">Kernel=$(hostnamectl|grep Kernel|awk -F: &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line">Vt=$(hostnamectl|grep Virtualization|awk &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line">Statichostname=$(hostnamectl|grep &quot;Static hostname&quot;|awk &#x27;&#123;print $3&#125;&#x27;)</span><br><span class="line">EthO=$(ifconfig etho|awk &#x27;NR==2&#123;print $2&#125;&#x27;)</span><br><span class="line">Lo=$(ifconfig lo|awk &#x27;NR==2&#123;print $2&#125;&#x27;)</span><br><span class="line">Network_T=$(curl -s icanhazip.com)</span><br><span class="line"></span><br><span class="line">echo &quot;当前系统版本是：$System&quot;</span><br><span class="line">echo &quot;当前系统内核是：$Kernel&quot;</span><br><span class="line">echo &quot;当前虚拟平台是：$Vt”</span><br><span class="line">echo &quot;当前静态主机名是：$Statichostname&quot;</span><br><span class="line">echo &quot;当前Eth0IP地址是：$Eth0&quot;</span><br><span class="line">echo &quot;当前外网地址是：$Network_T&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">2.需求描述：变量string=&quot;Bigdata process is Hadoop,Hadoop is open source project&quot;,</span><br><span class="line">执行脚本后，打印输出string变量，并给出用户以下选项：</span><br><span class="line">1）、打印string长度</span><br><span class="line">2）、删除字符串中所有的Hadoop</span><br><span class="line">3)、替换第一个Hadoop为Linux</span><br><span class="line">4)、替换全部Hadoop为Linux</span><br><span class="line">用户请输入数字1|2|3|4，可以执行对应项的功能，输入q|Q则退出交互模式</span><br><span class="line">[root@oldboyedu shell02]# cat variable-3.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">string=&quot;Bigdata process is Hadoop, Hadoop is open source project&quot;,</span><br><span class="line">echo $string</span><br><span class="line">cat &lt;&lt;EOF</span><br><span class="line">1）、打印string长度</span><br><span class="line">2）、删除字符串中所有的Hadoop</span><br><span class="line">3)、替换第一个Hadoop为Linux</span><br><span class="line">4）、替换全部Hadoop为Linux</span><br><span class="line">EOF</span><br><span class="line">read -p &quot;请输入数字1|2|3|4,或q|Q：&quot; var</span><br><span class="line">if [ $var -eq 1 ];then</span><br><span class="line">    echo当前string变量的长度是：$&#123;#string&#125;</span><br><span class="line">    #echo当前string变量的长度是：echo $&#123;string&#125;|wc-L</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ $var -eq 2 ];then</span><br><span class="line">    echo $&#123;string//Hadoop/&#125;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ $var -eq 3 ];then</span><br><span class="line">    echo $&#123;string/Hadoop/Linux&#125;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ $var -eq 4 ];then</span><br><span class="line">    echo $&#123;string//Hadoop/Linux&#125;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ $var == q ];then</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ $var == Q ];then</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1.什么是变量</span><br><span class="line">2.变量怎么定义</span><br><span class="line">    自定义规范，命名变量引用<span class="variable">$&#123;&#125;</span></span><br><span class="line">    系统定义</span><br><span class="line">    预定义变量  $$  <span class="variable">$#</span>  <span class="variable">$@</span>  $*  $?</span><br><span class="line">位置参数变量，执行脚本后面的参数，比如 /etc/init.d/network start</span><br><span class="line">3.变量替换15.001</span><br><span class="line"><span class="variable">$&#123;var//test/tt&#125;</span></span><br><span class="line"><span class="variable">$&#123;var/test/tt&#125;</span></span><br><span class="line"><span class="variable">$&#123;var%.*&#125;</span></span><br><span class="line"><span class="variable">$&#123;var%%.*&#125;</span></span><br><span class="line"><span class="variable">$&#123;var#*.&#125;</span></span><br><span class="line"><span class="variable">$&#123;var##*.&#125;</span></span><br></pre></td></tr></table></figure>



<h4 id="03-Shell流程控制"><a href="#03-Shell流程控制" class="headerlink" title="03.Shell流程控制"></a>03.Shell流程控制</h4><h5 id="1-流程控制语句if基本概述"><a href="#1-流程控制语句if基本概述" class="headerlink" title="1.流程控制语句if基本概述"></a>1.流程控制语句if基本概述</h5><p>1.单分支结构</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if [ 如果你有房 ];then</span><br><span class="line">    我就嫁给你</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例，<span class="built_in">echo</span> $?=0则执行<span class="keyword">then</span>后面的代码</span></span><br><span class="line">[root@bgx shell]# cat if-1.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">if which ls;then</span><br><span class="line">    echo &quot;ok&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>2.双分支结构</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">if [ 如果你有房 ];then</span><br><span class="line">        我就嫁给你</span><br><span class="line">    else</span><br><span class="line">        再见</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例</span></span><br><span class="line">[root@bgx shell]# cat if-2.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">if grep &quot;$1&quot; /etc/passwd;then</span><br><span class="line">        echo &quot;ok!&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;error!&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>3.多分支结构</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">if [ 如果你有房 ];then</span><br><span class="line">        我就嫁给你</span><br><span class="line">elif [ 你有车 ];then</span><br><span class="line">        我就嫁给你</span><br><span class="line">elif [ 你有钱 ];then</span><br><span class="line">        我就嫁给你</span><br><span class="line">    else</span><br><span class="line">        再见</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例</span></span><br><span class="line">[root@bgx shell]# cat if-4.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">read -p &quot;input a user:&quot; tu</span><br><span class="line">if grep $tu /etc/passwd;then</span><br><span class="line">        echo &quot;用户 $tu 存在该系统&quot;</span><br><span class="line">elif ls -d /home/$tu;then</span><br><span class="line">        echo &quot;用户 $tu 不存在该系统&quot;</span><br><span class="line">        echo &quot;但是 $tu 用户家目录存在&quot;</span><br><span class="line">else</span><br><span class="line">        echo &quot;用户 $tu 不存在该系统&quot;</span><br><span class="line">        echo &quot;$tu 用户也不存在家目录&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h5 id="2-流程控制语句if文件比较"><a href="#2-流程控制语句if文件比较" class="headerlink" title="2.流程控制语句if文件比较"></a>2.流程控制语句if文件比较</h5><p>if语句中的文件比较</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>-e</td>
<td>如果文件或目录存在则为真</td>
<td>[ -e file ]</td>
</tr>
<tr>
<td>-s</td>
<td>如果文件存在且至少有一个字符则为真</td>
<td>[ -s file ]</td>
</tr>
<tr>
<td>-d</td>
<td>如果文件存在且为目录则为真</td>
<td>[ -d file ]</td>
</tr>
<tr>
<td>-f</td>
<td>如果文件存在且为普通文件则为真</td>
<td>[ -f file ]</td>
</tr>
<tr>
<td>-r</td>
<td>如果文件存在且可读则为真</td>
<td>[ -r file ]</td>
</tr>
<tr>
<td>-w</td>
<td>如果文件存在且可写则为真</td>
<td>[ -w file ]</td>
</tr>
<tr>
<td>-x</td>
<td>如果文件存在且可执行则为真</td>
<td>[ -x file ]</td>
</tr>
</tbody></table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">常用测试</span></span><br><span class="line">[root@bgx shell]# [ -f /etc/hosts ] &amp;&amp; echo $?</span><br><span class="line">[root@bgx shell]# [ -f /etc/hostsl ] &amp;&amp; echo $?</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">判断文件是否存在，返回方式</span></span><br><span class="line">[root@bgx shell]# [ -f /etc/hosts] &amp;&amp; echo &quot;文件存在&quot; || echo &quot;文件不存在&quot;</span><br><span class="line">[root@bgx shell]# [ -f /etc/hosts1] &amp;&amp; echo &quot;文件存在&quot; || echo &quot;文件不存在&quot;</span><br><span class="line">[root@bgx shell]# [ -d /tmp ] &amp;&amp; echo &quot;目录存在&quot; || echo &quot;目录不存在&quot;</span><br><span class="line">[root@bgx shell]# [ -d /tmp1 ] &amp;&amp; echo &quot;目录存在&quot; || echo &quot;目录不存在&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用变量的方法进行判断</span></span><br><span class="line">[root@bgx shell]# dir=/etcl/;[ -d $dir ] &amp;&amp; tar zcf etc.tar.gz $dir || echo &quot;$dir目录不存在&quot;</span><br></pre></td></tr></table></figure>

<p>2.文件比较场景实践，备份数据库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-3-centos ~]# cat backupmysql.sh </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">DestPath=/backup/mysql</span><br><span class="line">M_User=root</span><br><span class="line">M_Pass=123.com</span><br><span class="line">[ -d $DestPath ] || mkdir -p $DestPath</span><br><span class="line"></span><br><span class="line">read -p &quot;请输入你要备份的数据库名称：&quot; db</span><br><span class="line">/usr/bin/mysqldump -u$M_User -p$M_Pass --single-transaction -R -B $db &gt; $DestPath/$&#123;db&#125;_$(date +%F).sql</span><br><span class="line">if [ $? -eq 0 ];then</span><br><span class="line">        echo &quot;------------------&quot;</span><br><span class="line">        echo &quot;$db 数据库备份成功&quot;</span><br><span class="line">        echo &quot;------------------&quot;</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.备份mysql，手动输入你需要备份的库名称</span></span><br><span class="line">[root@bgx shell]# cat if-backup.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">read -p &quot;输入需要备份的库名称：&quot; dumpdb</span><br><span class="line">[ -d /backup ] || mkdir /backup</span><br><span class="line">mysqldump -uroot -pBgx123.com -B $dumpdb &gt; /backup/$(date +%F)_db.sql</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.备份mysql，无需手动输入需要备份的库名</span></span><br><span class="line">[root@bgx shell]# cat if-backup-2.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">User=root</span><br><span class="line">Pass=Bgx123.com</span><br><span class="line">Data=bgxdb</span><br><span class="line">Back_dir=/backup</span><br><span class="line">Date=$(date +%F)</span><br><span class="line">Backup_Path=$Back_dir/$Date</span><br><span class="line"></span><br><span class="line">test -d $Backup_Path || mkdir -p $Backup_Path</span><br><span class="line">if [ $? -eq 0 ];then</span><br><span class="line">    echo&quot;=======备份开始=======&quot;</span><br><span class="line">    mysqldump -u$User -p$Pass -B$Data &gt;$Backup_Path/mysql_db.sql</span><br><span class="line">    if [ $? -eq 0];then</span><br><span class="line">    echo&quot;=======备份结束=======&quot;</span><br><span class="line">    fi</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p><strong>3.流程控制语句if整数比较</strong></p>
<p>数值比较 [ 整数1 操作符 整数2 ]</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>-eq</td>
<td>等于则条件为真</td>
<td>[ 1 -eq 10 ]</td>
</tr>
<tr>
<td>-ne</td>
<td>不等于则条件为真</td>
<td>[ 1 -ne 10 ]</td>
</tr>
<tr>
<td>-gt</td>
<td>大于则条件为真</td>
<td>[ 1 -gt 10 ]</td>
</tr>
<tr>
<td>-lt</td>
<td>小于则条件为真</td>
<td>[ 1 -It 10 ]</td>
</tr>
<tr>
<td>-ge</td>
<td>大于等于则条件为真</td>
<td>[ 1 -ge 10 ]</td>
</tr>
<tr>
<td>-le</td>
<td>小于等于则条件为真</td>
<td>[ 1 -le 10 ]</td>
</tr>
</tbody></table>
<p>1.语法示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">等于</span></span><br><span class="line">[root@bgx shell]# [ 1 -eq 1 ] &amp;&amp; echo $?</span><br><span class="line">[root@bgx shell]# [ 1 -eq 2 ] &amp;&amp; echo $?</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">大于等于</span></span><br><span class="line">[root@bgx shell]# [ 11 -ge 1 ] &amp;&amp; echo &quot;成立&quot; || echo &quot;不成立&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">小于</span></span><br><span class="line">[rbot@bgx shell]# [ 11 -lt 1 ] &amp;&amp; echo &quot;成立&quot; || echo &quot;不成立&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">大于</span></span><br><span class="line">[root@bgx shel1]# [ 11 -gt 1 ] &amp;&amp; echo &quot;成立&quot; || echo &quot;不成立&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">不等于</span></span><br><span class="line">[root@bgx shell]# [ 11 -ne 1 ] &amp;&amp; echo &quot;成立&quot; || echo &quot;不成立&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.场景实践，编写检测服务是否运行的脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat status.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">if [ $# -ge 1 ];then</span><br><span class="line">    systemctl status $1 &gt; /dev/null</span><br><span class="line">    if [ $? -eq 0 ]; then</span><br><span class="line">            echo &quot;$1 服务正在运行&quot;</span><br><span class="line">    else</span><br><span class="line">            echo &quot;$1 服务暂未运行&quot;</span><br><span class="line">fi</span><br><span class="line">else</span><br><span class="line">    echo &quot;执行脚本的格式&quot;</span><br><span class="line">    echo &quot;sh $0 服务名&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">编写一个脚本，检测服务是否运行的</span><br><span class="line">	1.如何判断我们服务是否是运行 systemctl status sshd</span><br><span class="line">	2.判断前者命令执行是否成功，成功则输出运行，失败则输出程序没有运行</span><br><span class="line">[root@VM-4-3-centos ~]# cat systemctl.sh </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line"></span><br><span class="line">if [ $# -ne 1 ];then</span><br><span class="line">        echo &quot;请输入一个服务名称,示例 sh $0 [sshd|httpd|nginx|....]&quot;</span><br><span class="line">        exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">systemctl status &quot;$1&quot; &amp;&gt; /dev/null</span><br><span class="line">rc=$?</span><br><span class="line">if [ $rc -eq 0 ];then</span><br><span class="line">        echo &quot;$1 服务正在运行&quot;</span><br><span class="line">elif [ $rc -eq 4 ];then</span><br><span class="line">        echo &quot;$1 没有这个服务&quot;</span><br><span class="line">else</span><br><span class="line">        echo &quot;$1 服务没有运行&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>



<p>3.场景实践，查看磁盘&#x2F;当前使用状态，如果使用率超过80%则报警发邮件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">[root@bgx]# </span><span class="language-bash"><span class="built_in">cat</span> disk_free.sh</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">Disk_Free=$(df -h|grep &quot;/$&quot;|awk &#x27;&#123;print $5&#125;&#x27;|awk -F &#x27;%&#x27; &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">if [ $Disk_Free -ge 30 ];then</span><br><span class="line">        echo &quot;Disk Is Use:$&#123;Disk_Free&#125;%&quot; &gt; /tmp/disk_use.txt</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----------------------------------------</span><br><span class="line">查看磁盘/当前使用状态，如果使用率超过80%则报警发邮件</span><br><span class="line">1.怎么查看磁盘   # df -h</span><br><span class="line">2.怎么提取使用率  df -h|grep &quot;/$&quot;|awk &#x27;&#123;print $(NF-1)&#125;&#x27; echo $&#123;disk/\%/&#125;</span><br><span class="line">3.判断，整数</span><br><span class="line"></span><br><span class="line">[root@VM-4-3-centos ~]# cat disk_use.sh </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line"></span><br><span class="line">disk_use=$(df -h|grep &quot;/$&quot;|awk &#x27;&#123;print $(NF-1)&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">if [ $&#123;disk_use/\%/&#125; -ge 80 ];then</span><br><span class="line">        echo &quot;你的磁盘使用率过高... $&#123;disk_use&#125;&quot;</span><br><span class="line">else</span><br><span class="line">        echo &quot;你的磁盘使用率正常... $&#123;disk_use&#125;&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4.场景实践，查看内存当前使用状态，如果使用率超过80%则报警发邮件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">[root@bgx]# </span><span class="language-bash"><span class="built_in">cat</span> memory_use.sh</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">Mem_Use=$(free -m|grep ^M|awk &#x27;&#123;print $3/$2*100&#125;&#x27;)</span><br><span class="line">if [ $&#123;Mem_Use%.*&#125; -ge 30 ]</span><br><span class="line">then</span><br><span class="line">    echo &quot;Memory IS ERROR $&#123;Mem_Use%.*&#125;%&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;Memory IS OK $&#123;Mem_Use%.*&#125;%&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>4.流程控制语句if字符比较</strong></p>
<p>字符串比较</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>示例</th>
<th>额外解释</th>
</tr>
</thead>
<tbody><tr>
<td>&#x3D;</td>
<td>等于则条件为真</td>
<td>[ “$a” &#x3D;&#x3D; “$b” ]</td>
<td></td>
</tr>
<tr>
<td>!&#x3D;</td>
<td>不相等则条件为真</td>
<td>[ “$a” !&#x3D; “$b” ]</td>
<td></td>
</tr>
<tr>
<td>-z</td>
<td>字符串的长度为零则为真</td>
<td>[ -z “$a” ]</td>
<td>内容空则为真</td>
</tr>
<tr>
<td>-n</td>
<td>字符串的长度不为空则为真</td>
<td>[ -n “$a” ]</td>
<td>有内容则为真</td>
</tr>
<tr>
<td>str1 &gt; str2</td>
<td>str1大于se2为真</td>
<td>[ str1 &gt; str2 ]</td>
<td></td>
</tr>
<tr>
<td>str1 &lt; str2</td>
<td>str1小于str2为真</td>
<td>[ str1 &lt; str2 ]</td>
<td></td>
</tr>
</tbody></table>
<p>1.字符串比对，必须加双引号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]<span class="comment"># [ &quot;$USER&quot; = &quot;root&quot; ];echo $?</span></span><br><span class="line">0</span><br><span class="line">[root@bgx shell]<span class="comment"># BBB=&quot;&quot;</span></span><br><span class="line">[root@bgx shell]<span class="comment"># echo $&#123;#BBB&#125;</span></span><br><span class="line">O</span><br><span class="line"><span class="comment">#字符长度为0</span></span><br><span class="line">[root@bgx shell]<span class="comment"># [ -z &quot;$AAA&quot;]</span></span><br><span class="line">[root@bgx shell]<span class="comment"># echo $?</span></span><br><span class="line">0</span><br><span class="line"><span class="comment">#字符长度不为0</span></span><br><span class="line">[root@bgx shel1]<span class="comment"># [ -n &quot;$AAA&quot; ]</span></span><br><span class="line">[root@bgx shel1]<span class="comment"># echo $?</span></span><br><span class="line">1</span><br><span class="line">[root@bgx shell]<span class="comment"># [ &quot;$USER&quot; = &quot;root&quot; ];echo $?</span></span><br><span class="line">6</span><br><span class="line">[root@bgx shell]<span class="comment"># [ &quot;$USER&quot; = &quot;bgx&quot; ];echo $?</span></span><br><span class="line">1</span><br><span class="line">[root@bgx shell]<span class="comment"># [ &quot;$USER&quot; != &quot;bgx&quot; ];echo $?</span></span><br><span class="line">0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.多整数比对条件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx]# [ 1 -lt 2 -a 5 -gt 10 ];echo $?</span><br><span class="line">1</span><br><span class="line">[root@bgx]# [ 1 -lt 2 -o 5 -gt 10 ];echo $?</span><br><span class="line">0</span><br><span class="line">#正则比对会使用到[[]]</span><br><span class="line">[root@bgx]# [[ 1 -lt 2 &amp;&amp; 5 -gt 10 ]];echo $?</span><br><span class="line">1</span><br><span class="line">[root@bgx]# [[ 1 -lt 2 || 5 -gt 10 ]];echo $?</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<p>3.示例，根据学生的成绩判断，学生的优劣</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat if-cj.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">read -p &quot;请输入你的成绩：&quot; cj</span><br><span class="line"></span><br><span class="line">if [[ ! &quot;$cj&quot; =~ ^[0-9]+$ ]];then</span><br><span class="line">    echo &quot;输入纯数字!&quot; &amp;&amp; exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ $cj -ge 0 ] &amp;&amp; [ $cj -le 59 ];then</span><br><span class="line">    echo &quot;补考&quot;</span><br><span class="line">elif[ $cj -ge 60 ] &amp;&amp; [ $cj -le 70 ];then</span><br><span class="line">    echo &quot;良好&quot;</span><br><span class="line">elif [ $cj -ge 71 ] &amp;&amp; [ $cj -le 85 ];then</span><br><span class="line">    echo &quot;好&quot;</span><br><span class="line">elif [ $cj -ge 86 ] &amp;&amp; [ $cj -le 100 ];then</span><br><span class="line">    echo &quot;优秀&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;成绩的有效范围是0-100之间&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>5.流程控制语句if正则比较</strong></p>
<p>1.正则比对示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">单括号无法使用正则语法</span></span><br><span class="line"><span class="meta prompt_">[root@bgx]# </span><span class="language-bash">[ <span class="string">&quot;<span class="variable">$USER</span>&quot;</span> =~ ^r ];<span class="built_in">echo</span> $?</span></span><br><span class="line">bash: [: =~: binary operator expected</span><br><span class="line">2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">双[]才可以使用正则匹配</span></span><br><span class="line"><span class="meta prompt_">[root@bgx]# </span><span class="language-bash">[[ <span class="string">&quot;<span class="variable">$USER</span>&quot;</span> =~ ^r ]];<span class="built_in">echo</span> $?</span></span><br><span class="line">0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例：判断变量是不是全数字</span></span><br><span class="line"><span class="meta prompt_">[root@bgx]# </span><span class="language-bash">num=123</span></span><br><span class="line"><span class="meta prompt_">[root@bgx]# </span><span class="language-bash">[[ <span class="string">&quot;<span class="variable">$num</span>&quot;</span> =~ ^[0-9]+$ ]];<span class="built_in">echo</span> $?</span></span><br><span class="line">0</span><br><span class="line"><span class="meta prompt_">[root@bgx]# </span><span class="language-bash">num=123a</span></span><br><span class="line"><span class="meta prompt_">[root@bgx]# </span><span class="language-bash">[[ <span class="string">&quot;<span class="variable">$num</span>&quot;</span> =~ ^[0-9]+$ ]];<span class="built_in">echo</span> $?</span></span><br><span class="line">1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.示例：判断用户输入的是否是数字</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat if-7.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">read -p &quot;请输入一个数值：&quot; num</span><br><span class="line">if [[ ! &quot;$num&quot; =~ ^[0-9]+$ ]];then</span><br><span class="line">    echo &quot;你输入的不是数字，程序退出！！！&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line">echo &quot;你输入的数字是 $num&quot;</span><br></pre></td></tr></table></figure>

<p>3.示例：批量创建用户脚本，输入创建用户的前缀，以及个数。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat if-8.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">read -p &quot;Please input number: &quot; num</span><br><span class="line">read -p &quot;Please input prefix: &quot; prefix</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">13.写一个创建用户的脚本，需要输入创建用户的前缀，比如oldboy，以及后缀。比如123。</span><br><span class="line">[root@oldboyedu shell03]# cat if-5.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line"></span><br><span class="line">read -p &quot;请输入用户的前缀：&quot; qz</span><br><span class="line">if [[ ! $qz =~ ^[a-Z]+$ ]];then</span><br><span class="line">    echo &quot;你输入的不是english....&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">read -p &quot;请输入创建用户的后缀：&quot; hz</span><br><span class="line">if [[ $hz =~ ^[0-9]+$ ]];then</span><br><span class="line">    user=$&#123;qz&#125;$&#123;hz&#125;</span><br><span class="line">    id $user &amp;&gt;/dev/null</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">        echo&quot;用户已经存在 $user&quot;</span><br><span class="line">    else</span><br><span class="line">        useradd $user</span><br><span class="line">        echo &quot;用户创建成功 $user&quot;</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">8.判断httpd服务是否正常启动  文件名必须是httpd_daemon.sh  $$</span><br><span class="line">1.手动怎么判断服务是正常</span><br><span class="line">  ps aux	ps aux|grep httpd|grep -v grep</span><br><span class="line">  netstat -lntp</span><br><span class="line">  lsof</span><br><span class="line">  systemctl</span><br><span class="line">  telnet</span><br><span class="line">  namp</span><br><span class="line">1.先判断服务是否是启动的  Active: active (running)  Active: inactive (dead)</span><br><span class="line">2.如果服务是启动在判断端口是否存在</span><br><span class="line">3.最后判断进程是否存在</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@oldboyedu shell03]# cat if-9.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.判断服务器是否启动</span></span><br><span class="line">ssh_status=$(systemctl status sshd|awk &#x27;/^.*Active/ &#123;print $2&#125;&#x27;)</span><br><span class="line">if [ &quot;$ssh_status&quot; == &quot;active&quot; ];then</span><br><span class="line">    sleep 1</span><br><span class="line">    echo &quot;sshd服务监测是 $&#123;ssh_status&#125;......&quot;</span><br><span class="line">else</span><br><span class="line">    sleep 1</span><br><span class="line">    echo &quot;sshd服务监测是 $&#123;ssh_status&#125;......&quot;</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.判断端口是否存在</span></span><br><span class="line">netstat -lntp|grep &quot;sshd&quot; &amp;&gt;/dev/null</span><br><span class="line">if [ $? -eg 0 ];then</span><br><span class="line">    sleep 1</span><br><span class="line">    echo &quot;sshd服务端口存活.....&quot;</span><br><span class="line">else</span><br><span class="line">    sleep 1</span><br><span class="line">    echo&quot;sshd服务端口不存在.....&quot;</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.判断进程是否存在</span></span><br><span class="line">ps axu|grep sshd|grep -v grep|grep -v &quot;pts&quot; &amp;&gt;/dev/null</span><br><span class="line">if [ $? -eq 0 ];then</span><br><span class="line">    sleep 1</span><br><span class="line">    echo &quot;sshd服务进程是存在...&quot;</span><br><span class="line">else</span><br><span class="line">    sleep 1</span><br><span class="line">    echo  &quot;sshd服务进程不存在....&quot;</span><br><span class="line">    ps axu|grep sshd|grep -v grep</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">9.根据不同的系统安装不同的yum源</span><br><span class="line">1.系统的版本如何判断</span><br><span class="line">[root@oldboyedu shell03]# cat if-10.sh</span><br><span class="line">tt=$(awk &#x27;&#123;print $(NF-1)&#125;&#x27; /etc/redhat-release)</span><br><span class="line">if [ $&#123;tt%%.*&#125; -eq &quot;6&quot; ];then</span><br><span class="line">    echo &quot;CentOS $tt 系统已经配置好yum仓库&quot;</span><br><span class="line">elif [ $&#123;tt%%.*&#125; -eq &quot;7&quot;];then</span><br><span class="line">    echo &quot;CentOS $tt 系统已经配置好yum仓库&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">10.安装不同版本的PHP，echo输出即可</span><br><span class="line">  1.先输出php的版本，然后在让用户进行选择  read  echo</span><br><span class="line">[root@oldboyedu shell03]# cat if-11.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">cat &lt;&lt;-EOF</span><br><span class="line">--------------------------</span><br><span class="line">| 1. Installed PHP 5.5</span><br><span class="line">| 2. Installed PHP 5.6</span><br><span class="line">| 3. Installed PHP 7.0</span><br><span class="line">| 4. Exit</span><br><span class="line">--------------------------</span><br><span class="line">EOF</span><br><span class="line">read -p &quot;请输入你要安装的php版本[1|2|3|4]：&quot; install</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">必须输入数字，还必须是1-4</span></span><br><span class="line">if [[ ! &quot;$install&quot; =~ ^[1-4]$ ]];then</span><br><span class="line">    echo“请输入[1|2|3|4]....“</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ $install -eq 1 ];then</span><br><span class="line">    sleep 2</span><br><span class="line">    echo &quot;Installed php5.5 Done......&quot;</span><br><span class="line"></span><br><span class="line">elif [ $install -eq 2 ];then</span><br><span class="line">    sleep 2</span><br><span class="line">    echo &quot;Installed php5.6 Done......&quot;</span><br><span class="line">    </span><br><span class="line">elif [ $install -eq 3 ];then</span><br><span class="line">    sleep 2</span><br><span class="line">    echo &quot;Installed php7.0 Done......&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">12.备份MySQL中的所有数据库，每个库一个.sql的文件，记得排除没用的</span><br><span class="line">  1.如何拿到所有的库名称</span><br><span class="line">  2.拿到后一个一个备份</span><br><span class="line">命令拼接</span><br><span class="line">[root@oldboyedu shell03]# mysql -uroot -p123.com -e &quot;show databases;&quot;|sed 1d|grep -Ev &quot;.*_schema|test|mysql&quot;|sed -r &#x27;s#(.*)# mysqldump -uroot -p123.com -B \1 &gt;/backup/\1.sql#g&#x27; |bash</span><br><span class="line">[root@oldboyedu shell03]# vim for-2.sh</span><br><span class="line">db=$(mysql -uroot -p123.com -e &quot;show databases;&quot;|sed 1d|grep -Ev &quot;.*_schema|test|mysql&quot;)</span><br><span class="line">for i in $db</span><br><span class="line">do</span><br><span class="line">    mysqldump -uroot -p123.com -B $i &gt; /backup/$&#123;i&#125;_$(date +%F).sql</span><br><span class="line">done</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="7-流程控制语句case基本概述"><a href="#7-流程控制语句case基本概述" class="headerlink" title="7.流程控制语句case基本概述"></a>7.流程控制语句case基本概述</h4><p>case用来实现对程序流程的选择、循环、等进行控制。语法如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">case 变量 in</span><br><span class="line">变量1）</span><br><span class="line">    命令序列1;</span><br><span class="line">变量2）</span><br><span class="line">    命令序列2;</span><br><span class="line">变量3）</span><br><span class="line">    命令序列3;</span><br><span class="line">*）</span><br><span class="line">    无匹配后命令序列</span><br><span class="line">esac</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>case演示示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat case.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">cat &lt;&lt;eof</span><br><span class="line">******************</span><br><span class="line">** 1. backup  	**</span><br><span class="line">** 2. copy		**</span><br><span class="line">** 3. quit		**</span><br><span class="line">******************</span><br><span class="line">eof</span><br><span class="line">read -p &quot;Input a choose:&quot; OP</span><br><span class="line">case $oP in</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">cat &lt;&lt;eof</span><br><span class="line">******************</span><br><span class="line">** 1. backup  	**</span><br><span class="line">** 2. copy		**</span><br><span class="line">** 3. quit		**</span><br><span class="line">******************</span><br><span class="line">eof</span><br><span class="line">        read -p &quot;请输入你想操作的选项[1|2|3]：&quot; re</span><br><span class="line">case $re in</span><br><span class="line">    1|backup|BACKUP|)</span><br><span class="line">            echo &quot;backup...&quot;</span><br><span class="line">            ;;</span><br><span class="line">    2)</span><br><span class="line">            echo &quot;Copy...&quot;</span><br><span class="line">            ;;</span><br><span class="line">    3)</span><br><span class="line">            echo &quot;quit&quot; &amp;&amp; exit</span><br><span class="line">            ;;</span><br><span class="line">    *)</span><br><span class="line">            echo &quot;你注意点...&quot;</span><br><span class="line">            echo &quot;USAGE: $0 &#123;1|2|3&#125;&quot;</span><br><span class="line">            exit</span><br><span class="line">esac</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">13.写一个rsync的启动和停止的脚本</span><br><span class="line">	1.如何启动的命令 rsync --daemon</span><br><span class="line">	ps aux|grep rsync|grep -v grep</span><br><span class="line">	2.如何停止kill,</span><br><span class="line">	pkill rsync</span><br><span class="line">	3.脚本名称rsync_daemon</span><br><span class="line">	</span><br><span class="line">[root@oldboyedu shell04]# cat daemon.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">source /etc/init.d/functions</span><br><span class="line">rs=$1</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.如果用户传递的第一个位置参数是start则执行如下<span class="keyword">if</span>语句</span></span><br><span class="line">if [ $rs == &quot;start&quot; ];then</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在启动rsync服务前，先判断是否存在pid文件（手动创建的pid文件）</span></span><br><span class="line">    if [ ! -f /var/run/rsync.pid ];then</span><br><span class="line">    #如果不存在pid，则手动创建并启动服务（加锁机制）</span><br><span class="line">    touch /var/run/rsync.pid</span><br><span class="line">    rsync --daemon</span><br><span class="line">    action &quot;Rsync Starting....&quot; /bin/true</span><br><span class="line">    else</span><br><span class="line">    action &quot;Rsync Service Running...&quot; /bin/false</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">elif [ $rs == &quot;stop&quot; ];then</span><br><span class="line">	if [ ! -f /var/run/rsync.pid ];then</span><br><span class="line">	action &quot;Rsync Service Stoppend....&quot; /bin/false</span><br><span class="line">    else</span><br><span class="line">    #如果停止服务，一定需要删除pid</span><br><span class="line">    rm -f /var/run/rsync.pid</span><br><span class="line">    pkill rsync</span><br><span class="line">    action &quot;Rsync Stopting.....&quot; /bin/true</span><br><span class="line">    fi</span><br><span class="line">    </span><br><span class="line">elif [ $rs == &quot;status&quot; ];then</span><br><span class="line">    if [ ! -f /var/run/rsync.pid ];then</span><br><span class="line">    echo &quot;Rsync Service Status InActive....&quot;</span><br><span class="line">    else</span><br><span class="line">    Rsync_Status=$(ps aux|grep rsync|grep -v grep|grep -v pts|awk &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line">    echo &quot;Rsync Service Status Active( &quot;$Rsync_Status&quot; )&quot;</span><br><span class="line">    fi</span><br><span class="line">else</span><br><span class="line">    echo &quot;USAGE: $0 &#123;start|stop|status&#125;&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@oldboyedu shell04]# vim rsync_daemon</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">source /etc/init.d/functions</span><br><span class="line">rs=$1</span><br><span class="line">case $rs in</span><br><span class="line">        start)</span><br><span class="line">            if [ ! -f /var/run/rsync.pid ];then</span><br><span class="line">                #如果不存在pid，则手动创建并启动服务（加锁机制）</span><br><span class="line">                touch /var/run/rsync.pid</span><br><span class="line">                rsync --daemon</span><br><span class="line">                action &quot;Rsync Starting....&quot; /bin/true</span><br><span class="line">            else</span><br><span class="line">                action &quot;Rsync Service Running...&quot; /bin/false</span><br><span class="line">            fi</span><br><span class="line">                ;;</span><br><span class="line">        stop)</span><br><span class="line">            if [ ! -f /var/run/rsync.pid ];then</span><br><span class="line">                action &quot;Rsync Service Stoppend....&quot; /bin/false</span><br><span class="line">            else</span><br><span class="line">                #如果停止服务，一定需要删除pid</span><br><span class="line">                rm -f /var/run/rsync.pid</span><br><span class="line">                pkill rsync</span><br><span class="line">                action &quot;Rsync Stopting.....&quot; /bin/true</span><br><span class="line">            fi</span><br><span class="line">                ;;</span><br><span class="line">        status)</span><br><span class="line">            if [ ! -f /var/run/rsync.pid ];then</span><br><span class="line">                echo &quot;Rsync Service Status InActive....&quot;</span><br><span class="line">            else</span><br><span class="line">                Rsync_Status=$(ps aux|grep rsync|grep -v grep|grep -v pts|awk &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line">                echo &quot;Rsync Service Status Active( &quot;$Rsync_Status&quot; )&quot;</span><br><span class="line">            fi</span><br><span class="line">                ;;</span><br><span class="line">        *)</span><br><span class="line">                echo &quot;USAGE: $0 &#123;start|stop|status&#125;&quot;</span><br><span class="line">                exit</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">15.case场景示例，编写一个nginx的启动和停止脚本。</span><br><span class="line">1.如何启动 /usr/sbin/nginx</span><br><span class="line">2.如何停止 /usr/sbin/nginx -s stop</span><br><span class="line">3.如何重载 /usr/sbin/nginx -s reload</span><br><span class="line"></span><br><span class="line">[root@oldboyedu shell04]# cat case-4.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">source /etc/init.d/functions</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">加锁</span></span><br><span class="line">Lock=/tmp/nginx.lock</span><br><span class="line">if [ -f $Lock ];then</span><br><span class="line">    echo &quot;此脚本正在运行，请稍后.....&quot;&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line">touch $Lock</span><br><span class="line"></span><br><span class="line">rc=$1</span><br><span class="line">case $rc in</span><br><span class="line">    start)</span><br><span class="line">        if [ -f /var/run/nginx.pid ];then</span><br><span class="line">            action &quot;nginx服务已经启动....&quot; /bin/false</span><br><span class="line">            #rm -f $Lock</span><br><span class="line">            #exit</span><br><span class="line">        else</span><br><span class="line">            /usr/sbin/nginx</span><br><span class="line">            action &quot;nginx服务启动成功...&quot; /bin/true</span><br><span class="line">        fi</span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        if [ -f /var/run/nginx.pid ];then</span><br><span class="line">            /usr/sbin/nginx -s stop</span><br><span class="line">            if [ $? -eq 0 ];then</span><br><span class="line">                action &quot;nginx关闭成功...&quot; /bin/true</span><br><span class="line">            else</span><br><span class="line">                action &quot;nginx关闭失败...&quot; /bin/false</span><br><span class="line">                #rm -f $Lock</span><br><span class="line">                #exit</span><br><span class="line">            fi</span><br><span class="line">        else</span><br><span class="line">            action &quot;nginx已经关闭...[error] open() /run/nginx.pid&quot;</span><br><span class="line">            #rm -f $Lock</span><br><span class="line">            #exit</span><br><span class="line">        fi</span><br><span class="line">        ;;</span><br><span class="line">    reload)</span><br><span class="line">        if [ -f /var/run/nginx.pid ];then</span><br><span class="line">            /usr/sbin/nginx -t &amp;&gt;/dev/null</span><br><span class="line">            if [ $? -eq 0 ];then</span><br><span class="line">                /usr/sbin/nginx -s reload</span><br><span class="line">                if [ $? -eq 0 ];then</span><br><span class="line">                    action &quot;nginx重载成功...&quot; /bin/true</span><br><span class="line">                else</span><br><span class="line">                    action &quot;nginx重载失败...&quot; /bin/false</span><br><span class="line">                fi</span><br><span class="line">            else</span><br><span class="line">                /usr/sbin/nginx -t &amp;&gt;err.txt</span><br><span class="line">                nginx_conf=$(awk -F &quot;[: ]&quot; &#x27;NR==1&#123;print $(NF-1)&#125;&#x27; err.txt)</span><br><span class="line">                nginx_line=$(awk -F &quot;[: ]&quot; &#x27;NR==1&#123;print $(NF)&#125;&#x27; err.txt)</span><br><span class="line">                read -p &quot;$nginx_conf 配置文件有错，在第 $nginx_line 行，是否要进入配置文件修改 [y|n]:&quot; re</span><br><span class="line">                case $re</span><br><span class="line">                       y|yes|YES)</span><br><span class="line">                              vim +$&#123;nginx_line&#125; $&#123;nginx_conf&#125;</span><br><span class="line">                              ;;</span><br><span class="line">                       n|no|NO)</span><br><span class="line">                              echo &quot;你可以选择手动修改，再见！&quot;</span><br><span class="line">                              ;;</span><br><span class="line">                       *)</span><br><span class="line">                              echo &quot;USAGE: $0 &#123;y|n&#125; &quot;</span><br><span class="line">                              exit</span><br><span class="line">                esac</span><br><span class="line">            fi</span><br><span class="line">            </span><br><span class="line">        else</span><br><span class="line">            action &quot;nginx没有启动，无法完成重载&quot; /bin/false</span><br><span class="line">        fi</span><br><span class="line">        ;;</span><br><span class="line">    status)</span><br><span class="line">        if [ -f /var/run/nginx.pid ];then</span><br><span class="line">            nginx_pid=$(cat /var/run/nginx.pid)</span><br><span class="line">            echo &quot;nginx ( $nginx_pid ) is running...&quot;</span><br><span class="line">        else</span><br><span class="line">            echo &quot;nginx is Not running....&quot;</span><br><span class="line">        fi</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">    echo &quot;USAGE: $0 [ start | stop | reload | status ] &quot;</span><br><span class="line">esac</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">解锁</span></span><br><span class="line">rm -f $Lock</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>2.case场景示例，实现系统管理工具箱</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Command action</span><br><span class="line">h 显示命令帮助</span><br><span class="line">f 显示磁盘分区</span><br><span class="line">d 显示磁盘挂载</span><br><span class="line">m 查看内存使用</span><br><span class="line">u 查看系统负载</span><br><span class="line">q 退出程序</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">caidan()&#123;</span><br><span class="line">cat &lt;&lt;-EOF</span><br><span class="line">=====================</span><br><span class="line">h 显示命令帮助</span><br><span class="line">f 显示磁盘分区</span><br><span class="line">d 显示磁盘挂载</span><br><span class="line">m 查看内存使用</span><br><span class="line">u 查看系统负载</span><br><span class="line">q 退出程序</span><br><span class="line">=====================</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">while true</span><br><span class="line">do</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-3-centos ~]# cat gz.sh </span><br><span class="line">cat &lt;&lt;-EOF</span><br><span class="line">        ==================</span><br><span class="line">        h 显示命令帮助</span><br><span class="line">        f 显示磁盘分区</span><br><span class="line">        d 显示磁盘挂载</span><br><span class="line">        m 查看内存使用</span><br><span class="line">        u 查看系统负载</span><br><span class="line">        q 退出程序</span><br><span class="line">        ==================</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">read -p &quot;请输入你需要做的操作 ：&quot; sys</span><br><span class="line"></span><br><span class="line">case $sys in</span><br><span class="line">        f)</span><br><span class="line">               df -h</span><br><span class="line">               ;;</span><br><span class="line">        d)     </span><br><span class="line">               mount -a |less</span><br><span class="line">               ;;</span><br><span class="line">        u)     </span><br><span class="line">               w</span><br><span class="line">               ;;</span><br><span class="line">        q)</span><br><span class="line">               exit</span><br><span class="line">               ;;</span><br><span class="line">        *)</span><br><span class="line">               echo &quot;USAGE: $0 [ h | f | d | m | u | q ]&quot;</span><br><span class="line">esac</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>3.case场景示例，实现简单的JumpServer</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat jumpserver.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">jumpServer</span></span><br><span class="line"></span><br><span class="line">lb01=172.16.1.5</span><br><span class="line">lb02=172.16.1.6</span><br><span class="line">web01=172.16.1.7</span><br><span class="line">web02=172.16.1.8</span><br><span class="line"></span><br><span class="line">meminfo()&#123;</span><br><span class="line">        cat &lt;&lt;-EOF</span><br><span class="line">        ---------------------------------</span><br><span class="line">        |      1) lb01-172.16.1.5		|</span><br><span class="line">        |      2) lb02-172.16.1.6		|</span><br><span class="line">        |      3) web01-172.16.1.7		|</span><br><span class="line">        |      4) web02-172.16.1.8		|</span><br><span class="line">        |      h) help					|</span><br><span class="line">        ---------------------------------</span><br><span class="line">        EOF</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        #调用函数打印菜单</span><br><span class="line">        meminfo</span><br><span class="line">        #控制不让输入ctrl+c,z</span><br><span class="line">        trap &quot;&quot; HUP INT TSTP</span><br><span class="line">        </span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">18.case场景示例，实现简单的JumpServer</span><br><span class="line">  1.执行脚本后，需要看到所有我能管理的主机</span><br><span class="line">  2.有一个选择菜单，提示输入连接某个主机</span><br><span class="line">  3.需要写一个死循环，保证程序连接后端服务，退出后还能接着选择主机。</span><br><span class="line">  4.不能让跳板机直接ctrl+c ctrl+z退出了，trap控制ctrl+c ctrl+z的信号</span><br><span class="line">  5.退出服务器的会话，再次登录，又可以正常操作服务器。将脚本加入到/etc/bashrc中，当用户一连接，自动就运行该脚本。</span><br><span class="line"></span><br><span class="line">[root@VM-4-3-centos ~]# cat case-jumpserver.sh </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line"></span><br><span class="line">meminfo()&#123;</span><br><span class="line">cat &lt;&lt;-EOF</span><br><span class="line">        ----------------------------------------</span><br><span class="line">        |      1) lb01-172.16.1.5              |</span><br><span class="line">        |      2) lb02-172.16.1.6              |</span><br><span class="line">        |      3) web01-172.16.1.7             |</span><br><span class="line">        |      4) web02-172.16.1.8             |</span><br><span class="line">        |      h) help                         |</span><br><span class="line">        ----------------------------------------</span><br><span class="line">EOF</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">调用函数打印菜单</span></span><br><span class="line">meminfo</span><br><span class="line">        trap &quot;&quot; HUP INT TSTP    #禁用Ctrl+C</span><br><span class="line">while true</span><br><span class="line">do</span><br><span class="line"></span><br><span class="line">read -p &quot;请输入你需要连接的主机序号[1|2|3|..]: &quot; connection</span><br><span class="line"></span><br><span class="line">case $connection in</span><br><span class="line">        1)</span><br><span class="line">                ssh root@47.107.119.122</span><br><span class="line">                ;;</span><br><span class="line">        2)</span><br><span class="line">                ssh root@101.33.247.22</span><br><span class="line">                ;;</span><br><span class="line">        3)</span><br><span class="line">                ssh root@42.192.225.146</span><br><span class="line">                ;;</span><br><span class="line">        h)</span><br><span class="line">                clear</span><br><span class="line">                meminfo</span><br><span class="line">                ;;</span><br><span class="line"></span><br><span class="line">        exec)</span><br><span class="line">                exit</span><br><span class="line">                ;;</span><br><span class="line">        *)</span><br><span class="line">                echo &quot;USAGE: $0 输入连接的主机编号即可 [ 1 | 2 | 3 | ]&quot;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">[root@bgx shell]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@47.107.119.122</span><br><span class="line">[root@VM-4-3-centos ~]# vim /etc/bashrc</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/etc/bashrc</span></span><br><span class="line">bash /root/case-jumpserver.sh    #设置连接直接启动脚本</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">System wide <span class="built_in">functions</span> and aliases</span></span><br></pre></td></tr></table></figure>





<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">19.case场景示例，实现多级菜单功能</span><br><span class="line">[root@VM-4-3-centos ~]# cat djcd-case.sh </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line"></span><br><span class="line">mem_option ()&#123;</span><br><span class="line">cat &lt;&lt;-EOF</span><br><span class="line">-------主菜单-------</span><br><span class="line">|    1) 安装nginx  |</span><br><span class="line">|    2) 安装php    |</span><br><span class="line">|    3) 退出       |</span><br><span class="line">--------------------</span><br><span class="line">EOF</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mem_install_nginx()&#123;</span><br><span class="line">cat &lt;&lt;-EOF</span><br><span class="line">------Installed Nginx----</span><br><span class="line">|    1) 安装nginx1.1    |</span><br><span class="line">|    2) 安装nginx1.2    |</span><br><span class="line">|    3) 安装nginx1.3    |</span><br><span class="line">|    4) 返回上一页      |</span><br><span class="line">-------------------------</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mem_install_php()&#123;</span><br><span class="line">cat &lt;&lt;-EOF</span><br><span class="line">-------------------------</span><br><span class="line">|    1) 安装php5.5      |</span><br><span class="line">|    2) 安装php5.6      |</span><br><span class="line">|    3) 安装php7.0      |</span><br><span class="line">|    4) 返回上一页      |</span><br><span class="line">-------------------------</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">--------------------------------------</span></span><br><span class="line"></span><br><span class="line">while true</span><br><span class="line">do</span><br><span class="line">mem_option</span><br><span class="line">	read -p &quot;请输入主菜单需要选择的选项，使用方法[1|2|3]: &quot; option</span><br><span class="line"></span><br><span class="line">	case $option in</span><br><span class="line">	    1)</span><br><span class="line">                    while true</span><br><span class="line">                    do</span><br><span class="line">			    clear</span><br><span class="line">			    mem_install_nginx</span><br><span class="line">			    read -p &quot;请输入你要安装Nginx的Version: &quot; nginx_install_option</span><br><span class="line">			    case $nginx_install_option in</span><br><span class="line">				    1)</span><br><span class="line">					    clear</span><br><span class="line">					    echo &quot;Installed Nginx Version 1.1 is Done.....&quot;</span><br><span class="line">					    sleep 1</span><br><span class="line">					    ;;</span><br><span class="line">				    2)</span><br><span class="line">					    echo &quot;Installed Nginx Version 1,2 is Done.....&quot;</span><br><span class="line">                                            sleep 1</span><br><span class="line">					    ;;</span><br><span class="line">				    3)</span><br><span class="line">					    echo &quot;Installed Nginx Version 1.3 is Done.....&quot;</span><br><span class="line">                                            sleep 1</span><br><span class="line">					    ;;</span><br><span class="line">				    4)</span><br><span class="line">                                            clear</span><br><span class="line">					    break</span><br><span class="line">					    ;;</span><br><span class="line">				    *)</span><br><span class="line">                                            clear</span><br><span class="line">					    ;;</span><br><span class="line">			    esac</span><br><span class="line">                    done</span><br><span class="line">		    ;;</span><br><span class="line">	    2)</span><br><span class="line">		    clear</span><br><span class="line">		    mem_install_php</span><br><span class="line">		    read -p &quot;请输入你要选择的php Version: &quot; php_install_option</span><br><span class="line">		    case $php_install_option in</span><br><span class="line">			    1)</span><br><span class="line">				    echo &quot;Installed php Version 5.5 is Done.....&quot;</span><br><span class="line">				    ;;</span><br><span class="line">			    2)</span><br><span class="line">				    echo &quot;Installed php Version 5.6 is Done.....&quot;</span><br><span class="line">				    ;;</span><br><span class="line">			    3)</span><br><span class="line">				    echo &quot;Installed php Version 5.7 is Done.....&quot;</span><br><span class="line">				    ;;</span><br><span class="line">			    4)</span><br><span class="line">				    clear</span><br><span class="line">				    ;;</span><br><span class="line">			    *)</span><br><span class="line">				    ;;</span><br><span class="line">		    esac</span><br><span class="line"></span><br><span class="line">		    ;;</span><br><span class="line">	    3)</span><br><span class="line">		    exit</span><br><span class="line">		    ;;</span><br><span class="line">	    *)</span><br><span class="line">		    echo &quot;USAGE: [ 1| 2 | 3 ]&quot;</span><br><span class="line">	esac</span><br><span class="line"></span><br><span class="line">done</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>04.Shell循环语句</strong></p>
<p><strong>1.循环语句for基本概述</strong></p>
<p>1.for循环基础语法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for 变量名 in [ 取值列表 ]</span><br><span class="line">do</span><br><span class="line">    循环体</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>2.for循环基本使用示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">取值列表有多种取值方式，可以直接读取<span class="keyword">in</span> 后面的值，默认以空格做分隔</span></span><br><span class="line">[root@bgx shell]# cat for-1.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">for var in file1 file2 file3</span><br><span class="line">do</span><br><span class="line">  echo the text is $var</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>2.for循环基本使用示例，列表中的复杂值，可以使用引号或转义字符”&#x2F;“来加以约束</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat for-2.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">for var in filel &quot;file2 file3&quot; file4 &quot;hello world&quot;</span><br><span class="line">do</span><br><span class="line">  echo the text is $var</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">转义符</span></span><br><span class="line">[root@bgx shell]# cat for-3.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">for var in file1 file\&#x27;2 I\&#x27;s</span><br><span class="line">do</span><br><span class="line">  echo the text is $var</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>3.for循环基本使用示例，从变量中取值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat for-5.sh  #以空格做分隔符</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">for i in `cat /etc/hosts`</span><br><span class="line">do</span><br><span class="line">  echo &quot;$i&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>4.for循环基本使用示例，自定义shell分隔符。默认情况以空格作为分隔符。通过IFS来自定义为分隔符</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">以冒号做分隔符					 IFS=:</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">以冒号、分号和双引号作为字段分隔符	  IFS=:;<span class="string">&quot;</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">以换行符做为字段分隔符			  IFS=$&#x27;\n&#x27;</span></span></span><br><span class="line"></span><br><span class="line">[root@bgx shell]# cat for-6.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">!/bin/bash</span></span></span><br><span class="line">IFS=$&#x27;\n&#x27;  #回车为分割符</span><br><span class="line">for i in `cat /etc/hosts`</span><br><span class="line">do</span><br><span class="line">  echo &quot;$i&quot;</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">[root@bgx shell]# cat for-7.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">!/bin/bash</span></span></span><br><span class="line">IFS=:  #冒号做分割符</span><br><span class="line">list=`head -1 /etc/passwd`</span><br><span class="line">for i in $list</span><br><span class="line">do</span><br><span class="line">  echo $i</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>4.for循环基本使用示例，C语言风格的for</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">语法格式</span></span><br><span class="line">for ((i=0;i&lt;10;i++))</span><br><span class="line">do</span><br><span class="line">  commmands</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">例1，单个变量，输出1到10之间的数字</span></span><br><span class="line">[root@bgx shell]# cat for-8.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">for (()) i=1;i&lt;=10;i++ ))</span><br><span class="line">do</span><br><span class="line">  echo num is $i</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">例2，多个变量，同时输出1-9的升序和降序</span></span><br><span class="line">[root@bgx shell]# sh for-9.sh</span><br><span class="line">num is 1 9</span><br><span class="line">num is 2 8</span><br><span class="line">num is 3 7</span><br><span class="line">num is 4 6</span><br><span class="line">num is 5 5</span><br><span class="line">num is 6 4</span><br><span class="line">num is 7 3</span><br><span class="line">num is 8 2</span><br><span class="line">num is 9 1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">解法1</span></span><br><span class="line">[root@bgx shell]# cat for-9.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">for (( a=1,b=9;a&lt;10;a++,b-- ))</span><br><span class="line">do</span><br><span class="line">  echo num is $a $b</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">解法2</span></span><br><span class="line">[root@bgx shell]# cat for-10.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">a=0</span><br><span class="line">b=10</span><br><span class="line">for i in &#123;1..9&#125;</span><br><span class="line">do</span><br><span class="line">    let a++;</span><br><span class="line">    let b--;</span><br><span class="line">  echo num is $a - $b</span><br><span class="line">done</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">21.for场景示例，通过读入文件中的用户，进行批量添加用户。</span><br><span class="line">[root@oldboyedu shell05]# echo tt&#123;1..10&#125;|xargs -n1 &gt; user.txt</span><br><span class="line">[root@oldboyedu shell05]# cat forl0.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line"></span><br><span class="line">for i in $(cat user.txt)</span><br><span class="line">do</span><br><span class="line">    useradd $i &amp;&gt;/dev/null</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">        echo $i 用户创建成功</span><br><span class="line">    else</span><br><span class="line">        echo $i 用户已存在</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">21.for场景示例，通过读入文件中的用户:密码，进行批量添加用户。</span><br><span class="line">user01:suibian</span><br><span class="line">user02:suibian2</span><br><span class="line">user03:suibian3</span><br><span class="line"></span><br><span class="line">[root@oldboyedu shell05]# cat forll.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line"></span><br><span class="line">for i in $(cat user.txt)</span><br><span class="line">do</span><br><span class="line">    #1.取出来的行，使用awk进行分隔，然后分别赋值给user和pass两个变量</span><br><span class="line">    user=$(echo $i|awk -F &quot;:&quot; &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">    pass=$(echo $i|awk -F &quot;:&quot; &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line">    </span><br><span class="line">    echo &quot;用户是 $user  密码是$pass&quot;</span><br><span class="line">    </span><br><span class="line">    #2.判断用户是否存在</span><br><span class="line">    id $user &amp;&gt;/dev/null</span><br><span class="line">    </span><br><span class="line">    #3.用户存在则提示已存在，否则添加用户，然后使用pass变量设定对应的密码</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">        echo &quot;$user 已存在&quot;</span><br><span class="line">    else</span><br><span class="line">        useradd $user</span><br><span class="line">        echo &quot;$pass&quot; | passwd --stdin $user &amp;&gt;/dev/null</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">23.for场景示例，批量创建用户脚本，需要用户输入创建的用户数量，以及需要用户输入创建的前缀。例如：前缀bgx，个数10，代表创建bgx1~bgx10，总共10个用户。</span><br><span class="line">    1.批量---&gt;循环</span><br><span class="line">    2.需要用户输入 ---&gt;read</span><br><span class="line"></span><br><span class="line">[root@oldboyedu shell05]# cat forl2.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line"></span><br><span class="line">read -p &quot;请输入你要创建的用户前缀：&quot; user_qz</span><br><span class="line">read -p &quot;请输入你要创建的用户数量：&quot; user_num</span><br><span class="line">echo &quot;你创建的用户是 $&#123;user_qz&#125;1 ~ $&#123;user_qz&#125;$&#123;user_num&#125;&quot;</span><br><span class="line">read -p &quot;你要创建的用户如下，你确定要创建吗？[ y|n ] &quot; readly</span><br><span class="line"></span><br><span class="line">case $readly in</span><br><span class="line">    y)</span><br><span class="line">        for i in $(seq $user_num)</span><br><span class="line">        do</span><br><span class="line">            user=$&#123;user_qz&#125;$&#123;i&#125;</span><br><span class="line">            id $user &amp;&gt;/dev/null</span><br><span class="line">            if [ $? -eq 0 ];then</span><br><span class="line">                echo &quot;useradd: user $user already exists&quot;</span><br><span class="line">            else</span><br><span class="line">                useradd $user</span><br><span class="line">                echo &quot;useradd: user $user add successfully.&quot;</span><br><span class="line">            fi</span><br><span class="line">        done</span><br><span class="line">        ;;</span><br><span class="line">    n)</span><br><span class="line">        echo &quot;你想好了再创建......&quot;</span><br><span class="line">        exit</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo &quot;请不要乱输入....&quot;</span><br><span class="line">        exit 1</span><br><span class="line">esac</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">24.for循环示例：批量创建用户脚本，需要用户输入创建的用户数量（必须是整数），同时还需要用户输入前缀（前缀不能为空）。例如：前缀bgx，个数10，代表创建bgx1~bgx10，总共10个用户。注意：此脚本仅root可执行，其他人无权限执行。</span><br><span class="line"></span><br><span class="line">[root@oldboyedu shell05]# cat for13.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">if [ ! $UID -eq 0 ] &amp;&amp; [ ! $USER == &quot;root&quot;];then</span><br><span class="line">    echo &quot;无权限执行..&quot;&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">read -p &quot;请输入你要创建的用户前缀：&quot; user_qz</span><br><span class="line">if [ -z $user_qz ];then</span><br><span class="line">    echo &quot;请输入有效的值.....&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">read -p &quot;请输入你要创建的用户数量：&quot; user_num</span><br><span class="line">if [[ ! $user_num =~ ^[0-9]+$ ]];then</span><br><span class="line">    echo &quot;请输入整数&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo &quot;你创建的用户是 $&#123;user_qz&#125;1 ..$&#123;user_qz&#125;$&#123;user_num&#125;&quot;</span><br><span class="line">read -p &quot;你要创建的用户如下，你确定要创建吗？[ y/n ] &quot; readly</span><br><span class="line"></span><br><span class="line">case $readly in</span><br><span class="line">    y|yes|YES)</span><br><span class="line">        for i in $(seq $user_num)</span><br><span class="line">        do</span><br><span class="line">            user=$&#123;user_qz&#125;$&#123;i&#125;</span><br><span class="line">            id $user &amp;&gt;/dev/null</span><br><span class="line">            if [ $? -eq 0 ];then</span><br><span class="line">                echo &quot;useradd: user $user already exists&quot;</span><br><span class="line">            else</span><br><span class="line">                useradd $user</span><br><span class="line">                echo &quot;useradd: user $user add successfully.&quot;</span><br><span class="line">            fi</span><br><span class="line">        done</span><br><span class="line">        ;;</span><br><span class="line">    n|no|NO)</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo &quot;你想好了再创建......&quot;</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">25.for场景示例，for循环示例：批量创建用户脚本，需要用户输入创建的用户数量（必须是整数），同时还需要用户输入前缀（前缀不能空）。例如：前缀bgx，个数10，代表创建bgx1~bgx10，总共10个用户。</span><br><span class="line">注意：此脚本仅root可执行，其他人无权限执行。</span><br><span class="line">注意：用户需要统一使用同一个密码</span><br><span class="line">[root@oldboyedu shell05]# cat for14.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">if [ ! $UID -eq 0 ] &amp;&amp; [ ! $USER == &quot;root&quot;];then</span><br><span class="line">    echo &quot;无权限执行..&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">read -p &quot;请输入你要创建的用户前缀：&quot; user_qz</span><br><span class="line">if [ -z $user_qz ];then</span><br><span class="line">    echo &quot;请输入有效的值.....&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">read -p &quot;请输入你要创建的用户数量：&quot; user_num</span><br><span class="line">if [[ ! $user_num =~ ^[0-9]+$ ]];then</span><br><span class="line">    echo &quot;请输入整数&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">read -p &quot;请输入你创建用户需要的统一密码：&quot; user_pass</span><br><span class="line">echo &quot;你创建的用户是 $&#123;user_qz&#125;1 ..$&#123;user_qz&#125;$&#123;user_num&#125;&quot;</span><br><span class="line">read -p &quot;你要创建的用户如下，你确定要创建吗？[ y/n ] &quot; readly</span><br><span class="line"></span><br><span class="line">case $readly in</span><br><span class="line">    y|yes|YES)</span><br><span class="line">        for i in $(seq $user_num)</span><br><span class="line">        do</span><br><span class="line">            user=$&#123;user_qz&#125;$&#123;i&#125;</span><br><span class="line">            id $user &amp;&gt;/dev/null</span><br><span class="line">            if [ $? -eq 0 ];then</span><br><span class="line">                echo &quot;useradd: user $user already exists&quot;</span><br><span class="line">            else</span><br><span class="line">                useradd $user</span><br><span class="line">                echo &quot;$user_pass&quot; | passwd --stdin $user &amp;&gt;/dev/null</span><br><span class="line">                echo &quot;useradd: user $user add successfully.&quot;</span><br><span class="line">            fi</span><br><span class="line">        done</span><br><span class="line">        ;;</span><br><span class="line">    n|no|NO)</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo &quot;你想好了再创建......&quot;</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">26.for场景示例，for循环示例：批量创建用户脚本，需要用户输入创建的用户数量（必须是整数），同时还需要用户输入前缀（前缀不能为空）。例如：前缀bax，个数10，代表创建bax1~bax10，总共10个用户。</span><br><span class="line">注意：此脚本仅root可执行，其他人无权限执行。</span><br><span class="line">注意：用户的密码使用随机密码，并保存到某一个指定的文件中。</span><br><span class="line">[root@oldboyedu shell05]# cat for15.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">if [ ! $UID -eq 0 ] &amp;&amp; [ ! $USER == &quot;root&quot;];then</span><br><span class="line">    echo &quot;无权限执行..&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">read -p &quot;请输入你要创建的用户前缀：&quot; user_qz</span><br><span class="line">if [ -z $user_qz ];then</span><br><span class="line">    echo &quot;请输入有效的值.....&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">read -p &quot;请输入你要创建的用户数量：&quot; user_num</span><br><span class="line">if [[ ! $user_num =~ ^[0-9]+$ ]];then</span><br><span class="line">    echo &quot;请输入整数&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">echo &quot;你创建的用户是 $&#123;user_qz&#125;1 ..$&#123;user_qz&#125;$&#123;user_num&#125;&quot;</span><br><span class="line">read -p &quot;你要创建的用户如下，你确定要创建吗？[ y/n ] &quot; readly</span><br><span class="line"></span><br><span class="line">case $readly in</span><br><span class="line">    y|yes|YES)</span><br><span class="line">        for i in $(seq $user_num)</span><br><span class="line">        do</span><br><span class="line">            user=$&#123;user_qz&#125;$&#123;i&#125;</span><br><span class="line">            id $user &amp;&gt;/dev/null</span><br><span class="line">            if [ $? -eq 0 ];then</span><br><span class="line">                echo &quot;useradd: user $user already exists&quot;</span><br><span class="line">            else</span><br><span class="line">                user_pass=$(echo $((RANDOM))|md5sum | cut -c 2-10)</span><br><span class="line">                useradd $user</span><br><span class="line">                echo &quot;$user_pass&quot; | passwd --stdin $user &amp;&gt;/dev/null</span><br><span class="line">                echo &quot;用户：$user 密码：$user_pass&quot; &gt;&gt; /tmp/user.log</span><br><span class="line">                echo &quot;useradd: user $user add successfully. cat /tmp/user.log&quot;</span><br><span class="line">            fi</span><br><span class="line">        done</span><br><span class="line">        ;;</span><br><span class="line">    n|no|NO)</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo &quot;你想好了再创建......&quot;</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">27.批量删除用户，有就删除，没有就提示没有该用户。</span><br><span class="line">[root@oldboyedu shell05]# cat for16.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">if [ ! $UID -eq 0 ] &amp;&amp; [ ! $USER == &quot;root&quot;];then</span><br><span class="line">    echo &quot;无权限执行..&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">read -p &quot;请输入你要删除的用户前缀：&quot; del_qz</span><br><span class="line">if [ -z $del_qz ];then</span><br><span class="line">    echo &quot;请输入有效的值.....&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">read -p &quot;请输入你要删除的用户数量：&quot; user_num</span><br><span class="line">if [[ ! $user_num =~ ^[0-9]+$ ]];then</span><br><span class="line">    echo &quot;请输入整数&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">echo &quot;你删除的用户是 $&#123;del_qz&#125;1 ..$&#123;del_qz&#125;$&#123;user_num&#125;&quot;</span><br><span class="line">read -p &quot;你要删除的用户如下，你确定吗？[ y/n ] &quot; readly</span><br><span class="line"></span><br><span class="line">case $readly in</span><br><span class="line">    y|yes|YES)</span><br><span class="line">        for i in $(seq $user_num)</span><br><span class="line">        do</span><br><span class="line">            user=$&#123;del_qz&#125;$&#123;i&#125;</span><br><span class="line">            id $user &amp;&gt;/dev/null</span><br><span class="line">            if [ $? -eq 0 ];then</span><br><span class="line">                    userdel -r $user</span><br><span class="line">                    echo &quot;$user 用户删除成功.....&quot;</span><br><span class="line">            else</span><br><span class="line">                    echo &quot;$user 删除用户不存在.....&quot;</span><br><span class="line">            fi</span><br><span class="line">        done</span><br><span class="line">        ;;</span><br><span class="line">    n|no|NO)</span><br><span class="line">        exit</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo &quot;你想好了再创建......&quot;</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>





<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">30.for场景示例，批量探测主机存活状态172.16.1.&#123;1..254&#125;</span><br><span class="line">    1.需要用循环，循环254次</span><br><span class="line">    2.探测主机使用ping命令</span><br><span class="line">    </span><br><span class="line">[root@oldboyedu shell05]# cat for17.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="keyword">for</span> (( <span class="number">1</span>=<span class="number">1</span>;i&lt;=<span class="number">254</span>;i++))</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">/tmp/ip.log</span></span><br><span class="line"></span><br><span class="line">for i in &#123;1..254&#125;</span><br><span class="line">do</span><br><span class="line">    &#123;</span><br><span class="line">    ip=172.16.1.$i</span><br><span class="line">    ping -c 1 -W 1 $ip &amp;&gt;/dev/null</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">        echo &quot;$ip is ok&quot;</span><br><span class="line">        echo &quot;$ip is ok&quot; &gt;&gt;/tmp/ip.log</span><br><span class="line">    else</span><br><span class="line">        echo &quot;$ip is down&quot;</span><br><span class="line">    fi</span><br><span class="line">    &#125;&amp;</span><br><span class="line">done</span><br><span class="line">    wait</span><br><span class="line">    echo &quot;Sao Miao IP is Done&quot;</span><br><span class="line">    echo &quot;Test SSH Port Starting......&quot;</span><br><span class="line">    </span><br><span class="line">IFS=$&#x27;\n&#x27;</span><br><span class="line">for i in $(cat /tmp/ip.log)</span><br><span class="line">do</span><br><span class="line">    port_ip=$(echo $i |awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">    nmap $port_ip |grep &quot;22&quot; &amp;»/dev/null</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">        echo &quot;$port_ip 22 is ok!!&quot;</span><br><span class="line">        echo &quot;$port_ip 22 is ok!!&quot; &gt;&gt; /tmp/port.log</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">number=$(wc -l student.txt|awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">for i in $(cat student.txt)</span><br><span class="line">do</span><br><span class="line">    stu_num=$((RANDOM % $number ))</span><br><span class="line">    echo $i</span><br><span class="line">    sleep 0.1</span><br><span class="line">done</span><br><span class="line">    name_stu=$(sed -n &quot;$&#123;stu_num&#125;p&quot; student.txt)</span><br><span class="line">    echo -e &quot;天选子：\033[32m $&#123;name_stu&#125;....\033[0m&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.统计文件的行数</span></span><br><span class="line">number=$(wc -l student.txt|awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.整个循环20次</span></span><br><span class="line">for i in &#123;1..20&#125;</span><br><span class="line">do</span><br><span class="line">    #3.通过random取随机数，但不超过文件的行数</span><br><span class="line">    stu_num=$((RANDOM % $number +1 ))</span><br><span class="line">    #4.循环一次打印一次随机的名</span><br><span class="line">    sed -n &quot;$&#123;stu_num&#125;p&quot; student.txt</span><br><span class="line">    #5.等待0.1s之后再循环下一次</span><br><span class="line">    sleep 0.1</span><br><span class="line">done</span><br><span class="line">    #6.将最后一次循环提取的人名赋值给name_stu</span><br><span class="line">    name_stu=$(sed -n &quot;$&#123;stu_num&#125;p&quot; student.txt)</span><br><span class="line">    #7.自定义输出人名，外加颜色，好看。</span><br><span class="line">    echo -e &quot;天选子：\033[32m $&#123;name_stu&#125;....\033[0m&quot;</span><br></pre></td></tr></table></figure>





<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">31.for场景示例，完成如下猜数字游戏</span><br><span class="line">    1）随机输出一个1-100的数字  echo $((RAND0M % 100 + 1 ))</span><br><span class="line">    2）要求用户输入的必须是数字（数字处加判断）</span><br><span class="line">    3）如果比随机数小则提示比随机数小了大则提示比随机数大了</span><br><span class="line">    4）正确则退出错误则继续死循环</span><br><span class="line">    5）最后统计总共猜了多少次（成功多少次，失败多少次）</span><br><span class="line">    </span><br><span class="line">[root@oldboyedu shell05]# cat for19.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line"></span><br><span class="line">sj=$(echo $((RANDOM % 100 + 1 )))</span><br><span class="line">echo $sj</span><br><span class="line"></span><br><span class="line">i=0</span><br><span class="line">while true</span><br><span class="line">do</span><br><span class="line">        read -p &quot;请输入一个你需要猜的数字：&quot; cc</span><br><span class="line">        if [[ ! $cc =~ ^[0-9]+$ ]];then</span><br><span class="line">                echo &quot;请输入整数&quot;</span><br><span class="line">                continue</span><br><span class="line">        fi</span><br><span class="line">        </span><br><span class="line">        #将用户的输入的数字与随机数进行比较</span><br><span class="line">        if [ $cc -gt $sj ];then</span><br><span class="line">                echo &quot;你猜的太大&quot;</span><br><span class="line">        elif [ $cc -lt $sj ];then</span><br><span class="line">                echo &quot;你猜的太小，继续加油&quot;</span><br><span class="line">        else</span><br><span class="line">                echo &quot;猜对了.....&quot;</span><br><span class="line">                break</span><br><span class="line">        fi</span><br><span class="line">        #进行数道自增</span><br><span class="line">        let i++</span><br><span class="line">done</span><br><span class="line">        echo &quot;你总共失败了多少次 $i&quot;</span><br><span class="line">        echo &quot;你总共猜了多少次 $(( $i + 1 ))&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">32.使用for循环实现数据库的分库分表备份</span><br><span class="line">    1.怎么备份数据库</span><br><span class="line">        mysqldump -uroot -p123.com --single-transaction -B world &gt; world_database.sql</span><br><span class="line">    2.怎么备份数据库的表</span><br><span class="line">        mysqldump -uroot -pl23.com --single-transaction world city &gt; world_city_tables.sql</span><br><span class="line">    3.备份到哪儿</span><br><span class="line">        /mysql_dump/oldboy/city_2019_04_16.sql</span><br><span class="line"></span><br><span class="line">[root@oldboyedu shell06]# cat mysql_dump.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">db_name=$(mysql -uroot -p123.com -e &quot;show databases;&quot;|sed 1d |grep -v &quot;.*_schema&quot;)</span><br><span class="line">DB_User=root</span><br><span class="line">DB_Pass=123.com</span><br><span class="line">Date=$(date +%F)</span><br><span class="line"></span><br><span class="line">for database_name in $db_name</span><br><span class="line">do</span><br><span class="line">        #1.准备每个库的目录</span><br><span class="line">        DB_Path=/mysql_dump/$database_name</span><br><span class="line">        if [ ! -d $DB_Path ];then</span><br><span class="line">                mkdir -p $DB_Path</span><br><span class="line">        fi</span><br><span class="line">        #2.备份数据库</span><br><span class="line">        mysqldump -u$DB_User -p$DB_Pass --single-transaction \</span><br><span class="line">        -B $database_name &gt; $DB_Path/$&#123;database_name&#125;_$&#123;Date&#125;.sql</span><br><span class="line">        echo -e &quot;\033[31m $database_name 数据库已经备份完成..... \033[0m&quot;</span><br><span class="line">        </span><br><span class="line">        #3.备份数据库的每一个表</span><br><span class="line">        tb_name=$(mysql -u$DB_User -p$DB_Pass -e &quot;use $&#123;database_name&#125;;show tables;&quot;|sed 1d)</span><br><span class="line">        </span><br><span class="line">        #4.批量的备份数据库的表</span><br><span class="line">        for table_name in $tb_name</span><br><span class="line">        do</span><br><span class="line">                #5.备份数据库的表数据</span><br><span class="line">                mysqldump -u$DB_User -p$DB_Pass --single-transaction \</span><br><span class="line">                $database_name $table_name &gt; $DB_Path/$&#123;database_name&#125;_$&#123;table_name&#125;_tables_$&#123;Date&#125;.sql</span><br><span class="line">                echo -e &quot;\033[32m 备份$database_name 的数据库中的 $table_name 数据表,备份成功\033[0m&quot;</span><br><span class="line">        done</span><br><span class="line">done</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置邮件</span></span><br><span class="line">yum install mailx -y</span><br><span class="line">vim /etc/mail.rc</span><br><span class="line">set from=Tareya@l63.com  #末尾添加</span><br><span class="line">set smtp=smtp.163.com</span><br><span class="line">set smtp-auth-user=Tareya@163.com</span><br><span class="line">set smtp-auth-password=Tareya4454</span><br><span class="line">set smtp-auth=login</span><br><span class="line">set ssl-verify=ignore</span><br><span class="line">set nss-config-dir=/etc/pki/nssdb/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql -uroot -p123.com -e &quot;show slave status\G&quot;|awk &#x27;/Slave_IO_Running/ &#123;print $2&#125;&#x27;</span><br><span class="line">mysql -uroot -p123.com -e &quot;show slave status\G&quot;|awk &#x27;/Slave_SQL_Running/ &#123;print $2&#125;&#x27;</span><br><span class="line">33.编写一个脚本，用于判断mysql数据库主从的脚本，需要邮件通知。</span><br><span class="line">1.判断io线程和sql线程是否都为yes，如果是则成功。</span><br><span class="line">2.如果io线程失败，则直接邮件通知，如果sql线程失败，则检查是什么错误状态码，根据状态码修复。</span><br><span class="line">3.无法修复，或任何错误代码太复杂建议，直接发邮件通知管理员。</span><br><span class="line"></span><br><span class="line">[root@web02 ~]# cat mysql_slave_check.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">IO_Status=$(mysql -uroot -p123.com -e &quot;show slave status\G&quot;|awk &#x27;/Slave_IO_Running/ &#123;print $2&#125;&#x27;)</span><br><span class="line">SQL_Status=$(mysql -uroot -p123.com -e &quot;show slave status\G&quot;|awk &#x27;/Slave_SQL_Running/ &#123;print $2&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">slave_sql_error_message()&#123;</span><br><span class="line">    mysql -uroot -p123.com -e &quot;show slave status\G&quot;|grep &quot;Last_SQL&quot; &gt; /tmp/sql_err.log</span><br><span class="line">    mail -s &quot;MySQL Master SLave SQL Error $(date +%F)&quot; 552408925@qq.com &lt; /tmp/sql_err.log</span><br><span class="line">    echo &quot;邮件通知成功......&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">slave_io_error_message()&#123;</span><br><span class="line">    mysql -uroot -p123.com -e &quot;show slave status\G&quot;|grep &quot;Last_IO&quot; &gt; /tmp/io_err.log</span><br><span class="line">    mail -s &quot;MySQL Master SLave IO Error $(date +%F)&quot; 552408925@qq.com &lt; /tmp/io_err.log</span><br><span class="line">    echo &quot;邮件通知成功......&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if [ &quot;$IO_Status&quot; == &quot;Yes&quot; ] &amp;&amp; [ &quot;$SQL_Status&quot; == &quot;Yes&quot; ];then</span><br><span class="line">    echo &quot;MySQL主从正常&quot;</span><br><span class="line">else</span><br><span class="line">    #1.判断I0异常</span><br><span class="line">    if [ ! $IO_Status == &quot;Yes&quot; ];then</span><br><span class="line">        slave_io_error_message</span><br><span class="line">        exit</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    #2，判断SOL片常</span><br><span class="line">    if [ ! $SQL_Status == &quot;Yes&quot; ];then</span><br><span class="line">        SQL_Err=$(mysql -uroot -p123.com -e &quot;show slave status\G&quot;|awk &#x27;/Last_SQL_Errno/ &#123;print $2&#125;&#x27;)</span><br><span class="line">    #3，精细化判断主从不问步的问题</span><br><span class="line">        case $SQL_Err in</span><br><span class="line">            1007)</span><br><span class="line">                echo&quot;主从的SQL出现问题,尝试使用set global sql_slave_skip_counter=l;跳过错误&quot;</span><br><span class="line">                sleep 2</span><br><span class="line">                mysql -uroot -p123.com -e &quot;stop slave;set global sql_slave_skip_counter=1;start slave;&quot;</span><br><span class="line">                SQL_Err_1=$(mysql -uroot -p123.com -e &quot;show slave status\G&quot;|awk &#x27;/Last_SQL_Errno/ &#123;print $2&#125;&#x27;)</span><br><span class="line">                if [ $SQL_Err_1 -eq 0 ];then</span><br><span class="line">                    echo &quot;尝试跳过了一次，恢复MysQL数据库成功&quot;</span><br><span class="line">                else</span><br><span class="line">                    slave_sql_error_message</span><br><span class="line">                fi</span><br><span class="line">                ;;</span><br><span class="line">            1032)</span><br><span class="line">                    slave_sql_error_message</span><br><span class="line">                ;;</span><br><span class="line">            *)</span><br><span class="line">                    slave_sql_error_message</span><br><span class="line">        esac</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">34.while循环基本使用示例，降序输出10到1的数字</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">a=1</span><br><span class="line">b=10</span><br><span class="line">while [ $a -le 10 ]</span><br><span class="line">do</span><br><span class="line">    sum=$(( $a + $b ))</span><br><span class="line">    echo $a + $b = $sum</span><br><span class="line">    let a++</span><br><span class="line">    let b--</span><br><span class="line">done</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>3.循环语句while基本概述</strong></p>
<p>while循环语句，只要条件成立就反复执行对应的命令操作，直到命令不成立或为假</p>
<p>1.while循环基础语法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当条件测试成立（条件测试为真），执行循环体</span></span><br><span class="line">while 条件测试</span><br><span class="line">do</span><br><span class="line">    循环体</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>2.while循环基本使用示例，降序输出10到1的数字</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat while-1.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">var=10</span><br><span class="line">while [ $var -gt 0 ]</span><br><span class="line">do</span><br><span class="line">    echo $var</span><br><span class="line">    var=$[$var-1]</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>3.while循环基本使用示例，输出如下图，两数相乘</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">自增</span></span><br><span class="line">[root@bgx shell]# cat while-2.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">num=9</span><br><span class="line">while [ $num -ge 1 ]</span><br><span class="line">do</span><br><span class="line">    sum=$(( $num * $num ))</span><br><span class="line">    echo &quot;$num * $num = $sum&quot;</span><br><span class="line">    num=$[$num-1]</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">自减</span></span><br><span class="line">[root@bgx shell]# cat while-3.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">num=1</span><br><span class="line">while [ $num -le 9 ]</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>4.循环语句while场景示例</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1.使用while读入文件方式，批量创建用户。  while默认按行取值</span><br><span class="line">while read line</span><br><span class="line">do</span><br><span class="line">    echo $line</span><br><span class="line">done&lt;user.txt</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">35.使用while读入文件方式，批量创建用户。  while默认按行取值</span><br><span class="line"></span><br><span class="line">[root@oldboyedu shell06]# cat while03.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">while read line</span><br><span class="line">do</span><br><span class="line">    #1.判断用户是否存在</span><br><span class="line">    id $line &amp;&gt;/dev/null</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">        echo &quot;User: $line already exists&quot;</span><br><span class="line">    else</span><br><span class="line">        useradd $line &amp;&gt;/dev/null</span><br><span class="line">        echo &quot;User: $line Create Ok&quot;</span><br><span class="line">    fi</span><br><span class="line">done&lt;user.txt</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>1.使用while读入文件方式，批量创建用户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat while-4.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">while read user</span><br><span class="line">do</span><br><span class="line">    id $user &amp;&gt;/dev/null</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">        echo &quot;useradd $user is already exists&quot;</span><br><span class="line">    else</span><br><span class="line">        useradd $user &amp;&gt;/dev/null</span><br><span class="line">        echo &quot;useradd $user is Created.&quot;</span><br><span class="line">fi</span><br><span class="line">done&lt;user.tt</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">36.使用while读入文件方式，批量创建用户以及密码[user:passwd]</span><br><span class="line">[root@oldboyedu shell06]# cat while04.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line"></span><br><span class="line">while read line</span><br><span class="line">do</span><br><span class="line">    user=$(echo $line |awk -F &#x27;:&#x27; &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">    pass=$(echo $line |awk -F &#x27;:&#x27; &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line">    id $user &amp;&gt;/dev/null</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">        echo &quot;用户已存在&quot;</span><br><span class="line">    else</span><br><span class="line">        useradd $user &amp;&amp; \</span><br><span class="line">        echo $pass |passwd --stdin $user &amp;»/dev/null</span><br><span class="line">        echo &quot;用户：$user is ok 密码：$pass&quot;</span><br><span class="line">    fi</span><br><span class="line">done&lt;user.txt</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>5.内置跳出循环语句指令</strong></p>
<p>在我们使用循环语句进行循环的过程中，有时候需要在未达到循环结束条件时强制跳出循环，那么Shell给我们提供了内置方法来实现该功能：exit、break、continue</p>
<p>1.exit，退出整个程序</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat for_exit.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">for i in &#123;1..3&#125;</span><br><span class="line">do</span><br><span class="line">    echo &quot;123&quot;</span><br><span class="line">    exit</span><br><span class="line">    echo &quot;456&quot;</span><br><span class="line">done</span><br><span class="line">echo &quot;Done.....&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">执行后的结果</span></span><br><span class="line">[root@Shell ~]# sh for_exit.sh</span><br><span class="line">123</span><br></pre></td></tr></table></figure>

<p>2.break，结束当前循环，或跳出本层循环</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat for_break.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">for i in &#123;1..3&#125;</span><br><span class="line">do</span><br><span class="line">    echo &quot;123&quot;</span><br><span class="line">    break</span><br><span class="line">    echo &quot;456&quot;</span><br><span class="line">done</span><br><span class="line">echo &quot;Done.....&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">执行后的结果</span></span><br><span class="line">[root@ansible-node30 ~]# sh for_break.sh</span><br><span class="line">123</span><br><span class="line">Done.....</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>3.continue 忽略本次循环剩余的代码，直接进行下一次循环</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat for_continue.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">for i in &#123;1..3&#125;</span><br><span class="line">do</span><br><span class="line">    echo &quot;123&quot;</span><br><span class="line">    continue</span><br><span class="line">    echo &quot;456&quot;</span><br><span class="line">done</span><br><span class="line">echo &quot;Done.....&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">执行后的结果</span></span><br><span class="line">[root@bgx shell]# sh for_continue.sh</span><br><span class="line">123</span><br><span class="line">123</span><br><span class="line">123</span><br><span class="line">Done....</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">continue</span>示例</span></span><br><span class="line">[root@bgx shell]# cat continue.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">for i in `seq 10`</span><br><span class="line">do</span><br><span class="line">    useradd te$i &amp;&gt;/dev/null</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">    echo &quot;Create User $i Success&quot;</span><br><span class="line">    else</span><br><span class="line">    echo &quot;Create User $i already exists&quot;</span><br><span class="line">    continue</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.exit，当脚本碰到exit时，直接退出，剩余不管有多少代码都不执行。</span><br><span class="line">2.break，结束当前循环，但会执行循环之后的所有的代码。</span><br><span class="line">3.continue 忽略本次循环剩余的所有代码，直接进行下一次循环，直到循环结束，然后继续循环之后的代码。</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h4 id="1-函数基本概述"><a href="#1-函数基本概述" class="headerlink" title="1.函数基本概述"></a><strong>1.函数基本概述</strong></h4><p><strong>1.什么是函数</strong></p>
<p>函数其实就是一堆命令的合集，用来完成特定功能的代码块，你可以对它进行自定义命名，并且可以在脚本中任意位置使用这个函数，要使用定义的函数，只需要填写函数名称就可以了。</p>
<p><strong>2.函数的作用</strong></p>
<p>1.使用函数可以让代码模块化，便于代码的复用，同时增加脚本的可读性。</p>
<p>2.函数和变量类似，必须先定义才可调用，如果定义不调用则不会被执行。</p>
<h4 id="2-函数基本使用"><a href="#2-函数基本使用" class="headerlink" title="2.函数基本使用"></a><strong>2.函数基本使用</strong></h4><p>1.如何定义Shell函数，可以通过如下两种方式进行定义。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方式一</span></span><br><span class="line">函数名() &#123;</span><br><span class="line">    command1</span><br><span class="line">    command2</span><br><span class="line">    ...</span><br><span class="line">    commandN</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方式二</span></span><br><span class="line">function 函数名 &#123;</span><br><span class="line">    command1</span><br><span class="line">    command2</span><br><span class="line">    ...</span><br><span class="line">    commandN</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.如何调用Shell函数，直接使用函数名调用即可。在函数内部也可以使用$1、$2..$n的方式传递参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1．命令行定义函数</span></span><br><span class="line">[root@bgx shell]# fun1() &#123; echo &quot;hello,Shell&quot;; &#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.命令行调用函数</span></span><br><span class="line">[root@bgx shell]# fun1</span><br><span class="line">hello,Shell</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.给函数传递参数</span></span><br><span class="line">[root@bgx shell]# fun2() &#123; echo &quot;hello, $1&quot;; &#125;</span><br><span class="line">[root@bgx shell]# fun2 Linux</span><br><span class="line">hello, Linux</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4.给函数传递多个参数&#123;$*，接收所有的参数传递&#125;</span></span><br><span class="line">[root@bgx shell]# fun3() &#123; echo &quot;hello,$*&quot;; &#125;</span><br><span class="line">[root@bgx shell]# fun3 zhangsan lisi wangwu</span><br><span class="line">hello, zhangsan lisi wangwu</span><br></pre></td></tr></table></figure>



<h4 id="3-函数参数传递-P720"><a href="#3-函数参数传递-P720" class="headerlink" title="3.函数参数传递 P720"></a>3.函数参数传递 P720</h4><p>如何向函数传递参数，其实函数传参和脚本传参类似，都是使用$1 $2 $3 $4 $5 $6..方式。</p>
<p>1.函数传参示例，使用变量方式传递固定值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat fun_1.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">fun_1()&#123;</span><br><span class="line">    echo &quot;$num&quot;</span><br><span class="line">&#125;</span><br><span class="line">num=10    #传递参数</span><br><span class="line">fun_1    #调用函数</span><br><span class="line"></span><br><span class="line">[root@bgx shell]# sh fun_1.sh    #执行脚本</span><br><span class="line">10</span><br></pre></td></tr></table></figure>

<p>2.函数传参示例，使用变量方式传递可变的值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat fun_2.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">fun_1()&#123;</span><br><span class="line">    echo &quot;$num&quot;</span><br><span class="line">&#125;</span><br><span class="line">num=$1    #将脚本的第一个位置参数传递给变量num</span><br><span class="line">fun_1    #调用函数</span><br><span class="line"></span><br><span class="line">[root@bgx shell]# sh fun_2.sh 10    #执行脚本</span><br><span class="line">10</span><br></pre></td></tr></table></figure>

<p>3.函数传参示例，传递多个位置参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat fun_3.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">fun_1()&#123;</span><br><span class="line">    echo &quot;$1&quot;  #接收执行函数时传递的第一个参数</span><br><span class="line">&#125;</span><br><span class="line">fun_1 $1  #接收脚本第一个位置参数，传入函数中算第一个参数</span><br><span class="line">fun_1 $2  #接收脚本第二个位置参数，传入函数中算第一个参数</span><br><span class="line">fun_1 $3  #接收脚本第三个位置参数，传入函数中算第一个参数</span><br><span class="line"></span><br><span class="line">[root@bgx shel1]# sh fun_3.sh 20 30 40  #执行脚本</span><br><span class="line">20</span><br><span class="line">30</span><br><span class="line">40</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4.函数传参示例，传递多个函数参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat fun_4.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">fun_1()&#123;</span><br><span class="line">    echo &quot;$1&quot; &quot;$2&quot; &quot;$3&quot;  #函数接收传递三个参数</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">rc=$(fun_1 10 20 30)  <span class="comment">#传递固定的值</span></span></span><br><span class="line"></span><br><span class="line">rc=$(fun_1 $1 $2 $3)  #传递可变的值</span><br><span class="line">echo &quot;传递参数的值为，$rc&quot;</span><br><span class="line"></span><br><span class="line">[root@bgx shell]# sh fun_4.sh 10 20 30 #执行脚本</span><br><span class="line">传递参数的值为，10 20 30</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>5.函数传参示例，将脚本的位置参数与函数的位置参数发生联动。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat fun_5.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">fun_1()&#123;</span><br><span class="line">    echo &quot;$num1&quot; &quot;$num2&quot; &quot;$num3&quot;</span><br><span class="line">&#125;</span><br><span class="line">num1=$1  #将脚本位置参数一的值传递给变量num1</span><br><span class="line">num2=$2  #将脚本位置参数二的值传递给变量num2</span><br><span class="line">num3=$3  #将脚本位置参数三的值传递给变量eum3</span><br><span class="line"></span><br><span class="line">rc=$(fun_1)  #将函数执行的结果保存至rc变量中，便于后续echo输出</span><br><span class="line">echo &quot;传递参数的值为，$rc&quot;</span><br><span class="line"></span><br><span class="line">[root@bgx shell]# sh fun_5.sh 10 20 30  #执行脚本</span><br><span class="line">传递参数的值为，10 20 30</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---------或者，使用如下方式进行联动</span></span><br><span class="line">[root@bgx shell]# cat fun_6.sh</span><br><span class="line">[root@bgx shell]# cat fun_6.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">fun_1()&#123;</span><br><span class="line">    echo &quot;$1&quot; &quot;$2&quot; &quot;$3&quot;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">rc=$(fun_1 $*)  <span class="comment">#接收所有脚本位置参数，传递至函数</span></span></span><br><span class="line">rc=$(fun_1 $1 $2 $3)  #接收三个脚本位置参数，传递至函数</span><br><span class="line">echo &quot;传递参数的值为，$rc&quot;</span><br><span class="line"></span><br><span class="line">[root@bgx shell]# sh fun_6.sh 10 20 30</span><br><span class="line">传递参数的值为，10 20 30</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>6.函数传参使用场景示例，写一个脚本，该脚本可以实现计算器的功能，可以进行+-*&#x2F;四种计算。</p>
<p>例如:<code>sh cal.sh 30 + 40</code> , <code>sh cal.sh 30 - 40</code> , <code>sh cal.sh 30 * 40</code> , <code>sh cal.sh 30 / 40</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 shell]# cat fun_cal.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">calsum()&#123;</span><br><span class="line">    case $2 in</span><br><span class="line">        +)</span><br><span class="line">            echo &quot;$(expr $1 + $3)&quot;</span><br><span class="line">            ;;</span><br><span class="line">        -)</span><br><span class="line">            echo &quot;$(expr $1 - $3)&quot;</span><br><span class="line">            ;;</span><br><span class="line">        \*)</span><br><span class="line">            echo &quot;$(expr $1 \* $3)&quot;</span><br><span class="line">            ;;</span><br><span class="line">        /)</span><br><span class="line">            echo &quot;$(expr $1 \ $3)&quot;</span><br><span class="line">            ;;</span><br><span class="line">    esac</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">调用函数并进行参数传递</span></span><br><span class="line">cale $1 $2 $3</span><br></pre></td></tr></table></figure>



<p>7.函数传参使用场景示例，需求描述：写一个脚本，实现nginx服务的启动、停止、重启</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat fun_ngx.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">source /etc/init.d/functions</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">定义函数，函数需要传递一个参数</span></span><br><span class="line">nginx_when() &#123;</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">        action &quot;Nginx $1 is ok!&quot; /bin/true</span><br><span class="line">    else</span><br><span class="line">        action &quot;Nginx $1 is er!&quot; /bin/false</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">接收脚本传入的第一个位置参数，然后进行匹配</span></span><br><span class="line">case $1 in</span><br><span class="line">    start)</span><br><span class="line">        nginx</span><br><span class="line">        nginx_when $1</span><br><span class="line">        ;;</span><br><span class="line">    stop)</span><br><span class="line">        nginx -s stop</span><br><span class="line">        nginx_when $1</span><br><span class="line">        ;;</span><br><span class="line">    reload)</span><br><span class="line">        nginx -s reload</span><br><span class="line">        nginx_when $1</span><br><span class="line">        ;;</span><br><span class="line">    *)</span><br><span class="line">        echo &quot;USAGE: $0 &#123; start|stop|reload &#125;&quot;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<h4 id="4-函数状态返回"><a href="#4-函数状态返回" class="headerlink" title="4.函数状态返回"></a>4.函数状态返回</h4><p>Shell的函数返回值，也算是退出的状态。在shell中只有echo、return两种方式。</p>
<p>1.使用return返回值：只能返回1-255的整数，函数使用return返回值，通常只是用来供其他地方调用获取状态，因此通常仅返回0或1；0表示成功，1表示失败。</p>
<p>2.使用echo返回值：使用echo可以返回任何字符串结果，通常用于返回数据，比如一个字符串值或者列表值。</p>
<p>1.shell函数echo、return返回值示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat fun_echo_return.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">fun_echo_return() &#123;</span><br><span class="line">    echo 100    #返回函数执行后的数据</span><br><span class="line">    return 1    #返回函数执行后的状态码（放置最后）</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">result=`fun echo return`</span><br><span class="line"></span><br><span class="line">echo &quot;函数的状态码是：$?&quot;</span><br><span class="line">echo &quot;函数的返回值是：$result&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.shell函数return返回值使用场景示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">return</span>示例一</span></span><br><span class="line">[root@bgx shell]# cat fun_return_1.sh</span><br><span class="line">file=/etc/passwd    #定义文件</span><br><span class="line">t_file()&#123;    #函数判断</span><br><span class="line">    if [ -f $file ];then</span><br><span class="line">        return 0</span><br><span class="line">    else</span><br><span class="line">        return 1</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">调用函数，并根据函数返回状态码进行输出</span></span><br><span class="line">t_file &amp;&amp; echo &quot;该文件存在 $file&quot; || echo &quot;该文件不存在 $file&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">return</span>示例二，&#123;了解即可&#125;</span></span><br><span class="line">[root@bgx shell]# cat fun_return_2.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">this_pid=$$</span><br><span class="line">is_nginx_running()&#123;</span><br><span class="line">    ps -ef |grep nginx | grep -v grep | grep -v $this_pid &amp;&gt;/dev/null</span><br><span class="line">    if [ $? -eq 0 ];then</span><br><span class="line">        return 0</span><br><span class="line">    else</span><br><span class="line">        return 1</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">调用函数，并根据函数返回状态码进行输出</span></span><br><span class="line">is_nginx_running &amp;&amp; echo &quot;Nginx is Running&quot; || echo &quot;Nginx is stoped&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>3.shell函数返回场景练习，例：猜数字游戏。</p>
<p>1.如果用户输入的数值大于0且小于10则返回0</p>
<p>2.如果用户输入的数值大于等于10且小于20则返回1</p>
<p>3.如果用户输入的数值大于等于20且小于30则返回2</p>
<p>4.输入其余数值则返回3</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx shell]# cat fun_return_3.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">checknum()&#123;</span><br><span class="line">    read -p &quot;请输入对应的数字:&quot; num</span><br><span class="line">    if [ $num -ge 0 -a $num -lt 10 ];then</span><br><span class="line">        return 0</span><br><span class="line">    elif [ $num -ge 10 -a $num -lt 20 ];then</span><br><span class="line">        return 1</span><br><span class="line">    elif [ $num -ge 20 -a $num -lt 30 ];then</span><br><span class="line">        return 2</span><br><span class="line">    else</span><br><span class="line">        return 3</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">调用函数，函数执行后会通过<span class="built_in">return</span>返回对应的状态码</span></span><br><span class="line">checknum</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">根据函数返回值进行判断</span></span><br><span class="line">if [ $? -eq 0 ];then</span><br><span class="line">    echo &quot;你输入的数字是，$num，大于0小于10&quot;</span><br><span class="line">elif [ $? -eq 1 ];then</span><br><span class="line">    echo &quot;你输入的数字是，$num，大于10小于20&quot;</span><br><span class="line">elif [ $? -eq 2 ];then</span><br><span class="line">    echo &quot;你输入的数字是，$num，大于20小于30&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="5-函数场景示例"><a href="#5-函数场景示例" class="headerlink" title="5.函数场景示例"></a>5.函数场景示例</h4><p>Shell中函数相关使用场景和案例</p>
<p>1.编写系统初始化脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">配置 YUM</span><br><span class="line">安装 Nginx</span><br><span class="line">q 键退出程序</span><br></pre></td></tr></table></figure>

<p>2.编写虚拟机管理脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">安装虚拟机</span><br><span class="line">关闭虚拟机</span><br><span class="line">打开虚拟机</span><br><span class="line">克隆虚拟机（可以指定克隆的数量）</span><br><span class="line">q键退出程序</span><br></pre></td></tr></table></figure>

<p>3.编写系统管理工具箱</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">查看内存的使用情况</span><br><span class="line">查看磁盘的使用情况</span><br><span class="line">查看系统的负载</span><br><span class="line">q 键退出程序</span><br></pre></td></tr></table></figure>



<h4 id="07-Shell数组应用"><a href="#07-Shell数组应用" class="headerlink" title="07.Shell数组应用"></a>07.Shell数组应用</h4><p><strong>1.数组基本概述</strong></p>
<p><strong>1.什么是数组</strong> 数组其实也算是变量 传统的变量只能存储一个值 但数组可以存储多个值。</p>
<p><strong>2.数组的分类</strong> shell数组分为普通数组和关联数组普通数组：只能使用整数作为数组索引 关联数组：可以使用字符串作为数组索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">books=(linux nginx shell)    普通数组    python(列表)</span><br><span class="line">-----------------------</span><br><span class="line">|linux |nginx | shell |</span><br><span class="line">-----------------------</span><br><span class="line">|  0   |   1  |   2   |    索引（下标）</span><br><span class="line">-----------------------</span><br><span class="line">PS：普通数组下标只能是整数</span><br><span class="line"></span><br><span class="line">info=([name]=bgx [age]=18 [skill]=linux)    关联数组python(字典)</span><br><span class="line">--------------------</span><br><span class="line">| bgx | 18 | linux |</span><br><span class="line">-------------------</span><br><span class="line">| name| age| skill |    索引（下标）</span><br><span class="line">--------------------</span><br><span class="line">PS：关联数组的下标可以是字符串</span><br></pre></td></tr></table></figure>

<img src="D:\文件管理\Typora\images\linux.assest\image-20220412212104512.png" alt="image-20220412212104512" style="zoom:50%;" />

<img src="D:\文件管理\Typora\images\linux.assest\image-20220412212138086.png" alt="image-20220412212138086" style="zoom:50%;" />

<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220412212200678.png" alt="image-20220412212200678"></p>
<h5 id="2-数组基本使用"><a href="#2-数组基本使用" class="headerlink" title="2.数组基本使用"></a>2.数组基本使用</h5><p><strong>1.普通数组仅能使用整数来作为索引</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方式一，针对每个索引进行赋值（数组名[索引]=变量值）</span></span><br><span class="line">[root@shell ~]# array1[0]=pear</span><br><span class="line">[root@shell ~]# array1[1]=apple</span><br><span class="line">[root@shell ~]# arrayl[2]=orange</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方式二，一次赋多个值（数组名=（多个变量值））</span></span><br><span class="line">[root@shell ~]# array2=(tom jack alice)</span><br><span class="line">[root@shell ~]# array3=(tom jack alice &quot;bash shell&quot;)</span><br><span class="line">[root@shell ~]# array4=(1 2 3 &quot;1inux shell&quot; [20]=docker)</span><br></pre></td></tr></table></figure>

<p>2.如何查看普通数组的赋值与访问数组的内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.查看普通数组</span></span><br><span class="line">[root@shell ~]# declare -a</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.如何访问数组中的元数</span></span><br><span class="line">[root@shell ~]# echo $&#123;array1[0]&#125;    #数组名加索引即可访问数组中的元素</span><br><span class="line">pear</span><br><span class="line">[root@shell ~]# echo $&#123;array1[@]&#125;    #访问数组中所有数据，相当于echo $&#123;array1[*]&#125;</span><br><span class="line">pear apple orange</span><br><span class="line">[root@shel1 ~]# echo $&#123;!array1[@]&#125;    #获取数组的索引，在数据遍历的时候有用</span><br><span class="line">0 1 2 3</span><br><span class="line">[root@shel1 ~]# echo $&#123;#array1[@]&#125;    #统计数组元数的个数</span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<p><strong>2.关联数组能使用字符串的方式作为索引</strong></p>
<p>1.关联数组的赋值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.必须先申明这是一个关联数组</span></span><br><span class="line">[root@shell ~]# declare -A info</span><br><span class="line">[root@shell ~]# declare -A info2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.方式一，关联数组的赋值（数组名[索引]=变量值）</span></span><br><span class="line">[root@shell ~]# info[index1]=pear</span><br><span class="line">[root@shell ~]# info[index2]=apple</span><br><span class="line">[root@shel1 ~]# info[index3]=orange</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.方式二，关联数组的赋值(数组名=([索引1]=变量值2 [索引2]=变量值2))</span></span><br><span class="line">[root@shell ~]# info2=([index1]=linux [index2]=nginx [index3]=docker [index4]=&#x27;bash shell&#x27;)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4.查看关联数组</span></span><br><span class="line">[root@shell ~]# declare -A</span><br><span class="line"></span><br><span class="line">2.如何访问关联数组中的数据。</span><br><span class="line">[root@shell ~]# echo $&#123;info2[index2]&#125;    #访问数组中的第二个元数</span><br><span class="line">nginx</span><br><span class="line">[root@shell ~]# echo $&#123;info2[@]&#125;    #访问数组中所有元数 等同于 echo $&#123;info2[*]&#125;</span><br><span class="line">bash shell linux nginx docker</span><br><span class="line">[root@shell ~]# echo $&#123;!tt_array2[@]&#125;    #访问数组中所有元数的索引</span><br><span class="line">index4 index1 index2 index3</span><br></pre></td></tr></table></figure>



<h4 id="3-数组遍历与循环"><a href="#3-数组遍历与循环" class="headerlink" title="3.数组遍历与循环"></a>3.数组遍历与循环</h4><p><del>1.通过数组元数的个数进行遍历(不推荐)</del> 2.通过数组元数的索引进行遍历(推荐) 注意: 将统计的对象作为数组的索引<br>仅针对关联数据</p>
<p>1.普通数组赋值与遍历示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx ~]# vim array_1.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.使用<span class="keyword">while</span>读入一个文件</span></span><br><span class="line">while read line</span><br><span class="line">do</span><br><span class="line">    #2.定义普通数组，将读入的每行数据，单个单个进行赋值</span><br><span class="line">    hosts[++i]=$line    #</span><br><span class="line">    #正常定义普通数组是hosts[1]=test，只不过我们将[]变成自增</span><br><span class="line">    #$line是读取的文件内容</span><br><span class="line">done &lt;/etc/hosts</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.使用<span class="keyword">for</span>循环遍历数组，遍历数组的索引</span></span><br><span class="line">for i in $&#123;!hosts[@]&#125;</span><br><span class="line">do</span><br><span class="line">    echo &quot;hosts数组对应的索引是：$i，对应的值是：$&#123;hosts[i]&#125;”</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>2.使用关联数组统计文件中的男女性别</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.准备对应的文件</span></span><br><span class="line">[root@shell ~]# cat sex.txt</span><br><span class="line">jack m</span><br><span class="line">alice f</span><br><span class="line">tom m</span><br><span class="line">f</span><br><span class="line">rose</span><br><span class="line">robin m</span><br><span class="line">bgx m</span><br><span class="line"></span><br><span class="line">[root@shell ~]# cat count_sex.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">declare -A sex</span><br><span class="line">[root@shell ~]# cat count_sex.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">declare -A sex</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.对数组进行赋值</span></span><br><span class="line">while read line</span><br><span class="line">do</span><br><span class="line">    #2.取出第二列的内容</span><br><span class="line">    type=$(echo $line|awk &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line">    #3.定义一个关联数组，让数组的值不断自增</span><br><span class="line">    let sex[$type]++</span><br><span class="line">done&lt; sex.txt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4.遍历数组</span></span><br><span class="line">for i in $&#123;!sex[@]&#125;</span><br><span class="line">do</span><br><span class="line">    echo &quot;$i $&#123;sex[$i]&#125;&quot;</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5.步骤拆分讲解</span></span><br><span class="line">[root@shell ~]# declare -A sex</span><br><span class="line">[root@shell ~]# sex=([m]=1 [f]=1)</span><br><span class="line">[root@shell ~]# let sex[m]++</span><br><span class="line">[root@shell ~]# let sex[f]++</span><br><span class="line">[root@shell ~]# echo $&#123;!sex[@]&#125;</span><br><span class="line">f m</span><br><span class="line">[root@shell ~]# echo $&#123;sex[@]&#125;</span><br><span class="line">3 3</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">declare -A array_pass</span><br><span class="line"></span><br><span class="line">while read line</span><br><span class="line">do</span><br><span class="line">        type=$(echo $line|awk -F &quot;:&quot; &#x27;&#123;print $NF&#125;&#x27;)</span><br><span class="line">        let array_pass[$type]++</span><br><span class="line">done&lt;/etc/passwd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.遍历数组</span></span><br><span class="line">for i in $&#123;!array_pass[@]&#125;</span><br><span class="line">do</span><br><span class="line">        echo &quot;索引名是：$i&quot; 该索引出现的次数是：&quot;$&#123;array_pass[$i]&#125;&quot;</span><br><span class="line">done</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.使用数组统计&#x2F;etc&#x2F;passwd的shell的数量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">[root@shell~]# </span><span class="language-bash"><span class="built_in">cat</span> array_passwd_count.sh</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">declare -A array_passwd</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.对数组进行赋值</span></span><br><span class="line">while read line</span><br><span class="line">do</span><br><span class="line">    type=$(echo $line|awk -F &#x27;:&#x27; &#x27;&#123;print $NF&#125;&#x27;)</span><br><span class="line">    let array_passwd[$type]++</span><br><span class="line">done &lt;/etc/passwd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.对数组进行遍历</span></span><br><span class="line">for i in $&#123;!array_passwd[@]&#125;</span><br><span class="line">do</span><br><span class="line">    echo 索引是:$i,索引的值是：$&#123;array_passwd[$i]&#125;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>4.统计Nginx日志IP访问次数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@shell ~]# cat array_nginx_count.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nginx <span class="built_in">log</span> top 10 IP conut</span></span><br><span class="line">declare -A array_nginx</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.给关联数组的索引进行赋值</span></span><br><span class="line">while read line</span><br><span class="line">do</span><br><span class="line">    type=$(echo $line|awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">    let array_nginx[$type]++</span><br><span class="line">done &lt;/var/log/nginx/access.log</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.遍历数组</span></span><br><span class="line">for i in $&#123;!array_nginx[@]&#125;</span><br><span class="line">do</span><br><span class="line">    echo &quot;IP是：$i 出现多少次$&#123;array_nginx[$i]&#125;&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>



<p>需要统计谁的次数，就将谁作为数组的索引，然后让索引进行自增即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">&#x27;&#123;ips[$1]++&#125; END &#123; for (i in ips) print ips[i],i&#125;&#x27;</span> log.xuliangwei.log|<span class="built_in">sort</span> -rn|<span class="built_in">head</span> -5</span><br></pre></td></tr></table></figure>



<p>5.统计tcp的状态信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@bgx logs]# cat ss.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.定义关联数组名称</span></span><br><span class="line">declare -A tcp_status</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.取出需要统计的内容</span></span><br><span class="line">ss_types=$(ss -an|awk &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.循环的读入内容，进行赋值</span></span><br><span class="line">for i in $ss_types</span><br><span class="line">do</span><br><span class="line">    let tcp_status[$i]++    #索引的值进行自增</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">34.遍历数组的索引</span><br><span class="line">for j in $&#123;!tcp_status[@]&#125;</span><br><span class="line">do</span><br><span class="line">    echo &quot;索引名是：$j&quot; 对应的次数：$&#123;tcp_status[$j]&#125;</span><br><span class="line">done</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">1.按照时间生成文件`2018-05-22.1og`将每天的磁盘使用状态写入到对应日期的文件</span><br><span class="line">[root@oldboyedu ~]<span class="comment"># df -h &gt; $(date +%F)_log</span></span><br><span class="line"></span><br><span class="line">2.统计Nginx日志中每个IP的访问量有多少，日志如下：</span><br><span class="line">192.168.56.1 - - [21/May/2018:20:44:06 -0400] <span class="string">&quot;GET /index.html HTTP/1.0&quot;</span> 404 169 <span class="string">&quot;-&quot;</span> <span class="string">&quot;ApacheBench/2.3&quot;</span> <span class="string">&quot;-&quot;</span>/code/index.html</span><br><span class="line">[root@bgx logs]<span class="comment"># awk &#x27;&#123;ips[$1]+=$11&#125; END &#123; for (i in ips) print i,ips[i]/1024&#125;&#x27; log.xuliangwei.log</span></span><br><span class="line">[root@bgx logs]<span class="comment"># awk &#x27;&#123;ips[$1]+=$11&#125; END &#123; for (i in ips) print i,ips[i]/1024/1024&#125;&#x27; log.xuliangwei.log |sort -k2 -nr|head -5</span></span><br><span class="line"></span><br><span class="line">3.写一个脚本计算一下Linux系统所有进程占用内存大小的和。</span><br><span class="line">[root@bgx ~]<span class="comment"># cat total_mem.sh</span></span><br><span class="line"><span class="comment">#!/usr/bin/bash</span></span><br><span class="line">NUM=$(ps aux|awk <span class="string">&#x27;&#123;print $6&#125;&#x27;</span>|grep -v <span class="string">&quot;RSS&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">sum</span>=0</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$NUM</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">sum</span>=$(( <span class="variable">$sum</span> + <span class="variable">$i</span> ))</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;总的值是：<span class="variable">$sum</span>&quot;</span> <span class="built_in">echo</span> <span class="string">&quot;以M为单位显示：<span class="subst">$(( $sum / 1024 )</span>) M”</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">4.在/backup下创建10个.txt的文件，找到/backup目录下所有后缀名为.txt的文件</span></span><br><span class="line"><span class="string">    1.批量修改txt为txt.bak</span></span><br><span class="line"><span class="string">    2.把所有的.bak文件打包压缩为123.tar.gz</span></span><br><span class="line"><span class="string">    3.批量还原文件的名字，及把增加的.bak再删除</span></span><br><span class="line"><span class="string">[root@oldboyedu shell08]# cat 04.sh</span></span><br><span class="line"><span class="string">#!/usr/bin/bash</span></span><br><span class="line"><span class="string">#1.修改名称</span></span><br><span class="line"><span class="string">Old_File=<span class="subst">$(find /backup -type f -name <span class="string">&quot;*.txt&quot;</span>)</span></span></span><br><span class="line"><span class="string">for i in <span class="variable">$Old_File</span></span></span><br><span class="line"><span class="string">do</span></span><br><span class="line"><span class="string">    mv <span class="variable">$i</span> <span class="variable">$&#123;i&#125;</span>.bak</span></span><br><span class="line"><span class="string">done</span></span><br><span class="line"><span class="string">    sleep 1</span></span><br><span class="line"><span class="string">    echo &quot;</span>改名成功.......<span class="string">&quot;</span></span><br><span class="line"><span class="string">#2.打包</span></span><br><span class="line"><span class="string">Bak_file=<span class="subst">$(find /backup -type f -name <span class="string">&quot;*.bak&quot;</span>)</span></span></span><br><span class="line"><span class="string">tar czf /backup/123.tar.gz <span class="variable">$Bak_file</span> &amp;&gt;/dev/null</span></span><br><span class="line"><span class="string">    sleep 1</span></span><br><span class="line"><span class="string">    echo &quot;</span>打包成功......<span class="string">&quot;</span></span><br><span class="line"><span class="string">#3.批量还原</span></span><br><span class="line"><span class="string">for i in <span class="variable">$Bak_file</span></span></span><br><span class="line"><span class="string">do</span></span><br><span class="line"><span class="string">    mv <span class="variable">$i</span> <span class="variable">$&#123;i%.*&#125;</span></span></span><br><span class="line"><span class="string">done</span></span><br><span class="line"><span class="string">    echo &quot;</span>还原成功......<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">5.同时把6到10行中的全部字母删除掉</span><br><span class="line">[root@oldboyedu shell08]<span class="comment"># sed -i &#x27;s#[a-Z]##g&#x27; 2.txt</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">7.写个shell，看看你的linux系统中是否有自定义用户（普通用户），若是有，一共有几个？</span><br><span class="line">[root@oldboyedu shell08]<span class="comment"># cat 07.sh</span></span><br><span class="line"><span class="comment">#!/usr/bin/bash</span></span><br><span class="line"></span><br><span class="line">i=0</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    User_Name=$(<span class="built_in">echo</span> <span class="variable">$line</span>|awk -F <span class="string">&quot;:&quot;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line">    User_Uid=$(<span class="built_in">echo</span> <span class="variable">$line</span>|awk -F <span class="string">&quot;:&quot;</span> <span class="string">&#x27;&#123;print $3&#125;&#x27;</span>)</span><br><span class="line">    User_Shell=$(<span class="built_in">echo</span> <span class="variable">$line</span>|awk -F <span class="string">&quot;:&quot;</span> <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$User_Uid</span> -ge 1000 -a <span class="variable">$User_Shell</span> == <span class="string">&quot;/bin/bash&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$User_Name</span>&quot;</span> <span class="variable">$User_Uid</span> <span class="variable">$User_Shell</span></span><br><span class="line">            <span class="built_in">let</span> i++</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span>&lt;/etc/passwd</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;总共有多个普通用户 <span class="variable">$i</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">8.写一个shell脚本来看看你使用最多的命令是哪些，列出你最常用的命令top10</span><br><span class="line">9.中企动力面试题</span><br><span class="line">用shel1处理以下内容</span><br><span class="line">1、按单词出现频率降序排序！</span><br><span class="line">2、按字母出现频率降序排序！</span><br><span class="line">the squid project provides a number of resources toassist <span class="built_in">users</span> design,implement and support squid installations. Please browsethe documentation and support sections <span class="keyword">for</span> more infomation</span><br><span class="line"></span><br><span class="line"><span class="comment">#方法一：sort排序--&gt;单词</span></span><br><span class="line">[root@oldboyedu shell08]<span class="comment"># echo &quot;the squid project provides a number of resources toassist users design,implement and support squid installations. Please browsethe documentation and support sections for more infomation&quot;|sed &#x27;s#[.,]##g&#x27;|xargs -n1|sort |unig -c |sort -nr</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#方法一：sort排序--&gt;字母</span></span><br><span class="line">[root@oldboyedu shell08]<span class="comment"># echo &quot;the squid project provides a number of resources toassist users design,implement and support squid installations. Please browsethe documentation and support sections for more infomation&quot;|sed &#x27;s#[.,]##g&#x27;|grep -o &#x27;[a-Z]&#x27;|sort |unig -c|sort -nr</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#方法二：awk排序--&gt;字母</span></span><br><span class="line">[root@oldboyedu shell08]<span class="comment"># echo &quot;the squid project provides a number of resources toassist users design,implement and support squid installations. Please browsethe documentation and support sections for more infomation&quot;|grep -o &#x27;[a-Z]&#x27;|awk &#x27;&#123;code[$1]++&#125; END &#123; for (i in code) print code[i],i&#125;&#x27;|sort -nr</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#方法二：awk排序--&gt;单词</span></span><br><span class="line">[root@oldboyedu shell08]<span class="comment"># echo &quot;the squid project provides a number of resources toassist users design,implement and support squid installations. Please browsethe documentation and support sections for more infomation&quot;|sed &#x27;s#[.,]##g&#x27;|xargs -n1|awk &#x27;&#123;code[$1]++&#125; END &#123; for (i in code) print code[i],i&#125;&#x27;|sort -nr</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#方法三：shell数组排序--&gt;字母</span></span><br><span class="line">[root@oldboyedu shell08]<span class="comment"># cat 09.sh</span></span><br><span class="line"><span class="comment">#!/usr/bin/bash</span></span><br><span class="line"><span class="built_in">declare</span> -A array_txt</span><br><span class="line"></span><br><span class="line">txt=<span class="string">&quot;the squid project provides a number of resources toassist users design,implement and support squid installations.Please browsethe documentation and support sections for more infomation&quot;</span></span><br><span class="line">txt=$(<span class="built_in">echo</span> <span class="variable">$txt</span> |sed<span class="string">&#x27;s#[.,]##g&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$txt</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">let</span> array_txt[<span class="variable">$i</span>]++</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.遍历数组</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="variable">$&#123;!array_txt[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> 次数是：<span class="string">&quot;<span class="variable">$&#123;array_txt[$j]&#125;</span>&quot;</span> <span class="string">&quot;索引<span class="variable">$j</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#方法三：shell数组排序--&gt;单词</span></span><br><span class="line">[root@oldboyedu shell08]<span class="comment"># cat 09.sh</span></span><br><span class="line"><span class="comment">#!/usr/bin/bash</span></span><br><span class="line"><span class="built_in">declare</span> -A array_txt</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">te</span></span> ()&#123;</span><br><span class="line">txt=<span class="string">&quot;the squid project provides a number of resources toassist users design,implement and support squid installations.Please browsethe documentation and support sections for more infomation&quot;</span></span><br><span class="line">txt=$(<span class="built_in">echo</span> <span class="variable">$txt</span> |grep -o <span class="string">&quot;[a-Z]&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$txt</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">let</span> array_txt[<span class="variable">$i</span>]++</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.遍历数组</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="variable">$&#123;!array_txt[@]&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> 次数是：<span class="string">&quot;<span class="variable">$&#123;array_txt[$j]&#125;</span>&quot;</span> <span class="string">&quot;索引<span class="variable">$j</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">te |<span class="built_in">sort</span> -t <span class="string">&quot;:&quot;</span> -k 2 -nr</span><br><span class="line"></span><br><span class="line">10.写一个脚本，实现判断10.0.0.0/24网络里，当前在线用户的IP有哪些</span><br><span class="line"><span class="comment">#!/usr/bin/bash</span></span><br><span class="line">&gt;ip.txt</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..254&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">    ip=10.0.0.<span class="variable">$i</span></span><br><span class="line">    ping -W1 -c1 <span class="variable">$ip</span> &amp;&gt;/dev/null</span><br><span class="line">    <span class="keyword">if</span> [ $? -eq 0 ];<span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$ip</span> is ok&quot;</span> &gt;&gt; ip.txt</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    &#125;&amp;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">    <span class="built_in">wait</span>  &amp;&amp; <span class="built_in">cat</span> ip.txt</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h5 id="08-Shell正则应用"><a href="#08-Shell正则应用" class="headerlink" title="08.Shell正则应用"></a>08.Shell正则应用</h5><p>1.什么是正则表达式以特定的符号表示一组数字或字母的，一种规则。可以简单理解这个规则为：古代时候打仗的旗语。</p>
<p>2.为什么要使用正则表达式再工作中，我们做inux运维工作，时刻面对着大量的日志，程序，命令的输出。迫切的需要过滤我们需要的一部分内容，甚至是一个字符串。比如现在有一个1000行的文件，我们仅需要其中包含”root”的行，怎么办?此时就需要使用到正则表达式的规则来筛选这些内容。</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220413203448761.png" alt="image-20220413203448761"></p>
<p><strong>3.正则表达式注意事项</strong>1.正则表达式应用非常广泛，存在于各种编程语言中。2.正则表达式和inux的通配符以及特<br>殊字符是有区别的。3.要想学好 <code>grep、sed、awk</code> 首先就需要对正则表达式有一定的了解。只有了解了规则，才能灵活的运用。</p>
<h6 id="1-正则表达式示例"><a href="#1-正则表达式示例" class="headerlink" title="1.正则表达式示例"></a>1.正则表达式示例</h6><p><strong>1.正则表达式规则</strong></p>
<table>
<thead>
<tr>
<th>正则表达式</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>\</td>
<td>转义符，将特殊字符进行转义，忽略其特殊意义</td>
</tr>
<tr>
<td>^</td>
<td>匹配行首，^则是匹配字符串的开始</td>
</tr>
<tr>
<td>$</td>
<td>匹配行尾，$则是匹配字符串的结尾</td>
</tr>
<tr>
<td>^$</td>
<td>表示空行</td>
</tr>
<tr>
<td>.</td>
<td>匹配除换行符\n之外的任意单个字符</td>
</tr>
<tr>
<td>[ ]</td>
<td>匹配包含在[字符]之中的任意一个字符</td>
</tr>
<tr>
<td>[^ ]</td>
<td>匹配[^]之外的任意一个字符</td>
</tr>
<tr>
<td>[ - ]</td>
<td>匹配[]中指定范围内的任意一个字符</td>
</tr>
<tr>
<td>?</td>
<td>匹配之前的项1次或者0次</td>
</tr>
<tr>
<td>+</td>
<td>匹配之前的项1次或者多次</td>
</tr>
<tr>
<td>*</td>
<td>匹配之前的项0次或者多次，.*</td>
</tr>
<tr>
<td>()</td>
<td>匹配表达式，创建一个用于匹配的子串</td>
</tr>
<tr>
<td>{ n }</td>
<td>匹配之前的项n次，n是可以为0的正整数</td>
</tr>
<tr>
<td>{n,}</td>
<td>之前的项至少需要匹配n次</td>
</tr>
<tr>
<td>{n,m}</td>
<td>指定之前的项至少匹配n次，最多匹配m次，n&lt;&#x3D;m</td>
</tr>
<tr>
<td>|</td>
<td>交替匹配|两边的任意一项ab(c|d)匹配abc或abd</td>
</tr>
<tr>
<td>特定字符</td>
<td></td>
</tr>
<tr>
<td>[[:space:]]</td>
<td>空格</td>
</tr>
<tr>
<td>[[:digit:]]</td>
<td>[0-9]</td>
</tr>
<tr>
<td>[[:lower:]]</td>
<td>[a-z]</td>
</tr>
<tr>
<td>[[:upper:]]</td>
<td>[A-Z]</td>
</tr>
<tr>
<td>[[:alpha:]]</td>
<td>[a-Z]</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1.使用grep取IP地址</span><br><span class="line">ifconfig eth0|grep <span class="string">&quot;inet &quot;</span>|egrep -0 <span class="string">&quot;[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;&quot;</span></span><br><span class="line">ifconfig eth0[grep <span class="string">&quot;inet &quot;</span>|egrep -0 <span class="string">&quot;[[:digit:]]&#123;1,3&#125;\.[[:digit:]]&#123;1,3&#125;\.[[:digit:]]&#123;1,3&#125;\.[[:digit:]]&#123;1,3&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">2.使用grep过滤nginx日志中的http1.0 和 http1.1 http2.1 http2.0</span><br><span class="line">[root@bgx logs]<span class="comment"># cat docs.xuliangwei.log |egrep -o &quot;HTTP/(1|2)\.(1|0)&quot; |sort |uniq -c</span></span><br><span class="line"></span><br><span class="line">3.使用grep排除配置文件中的空行也以<span class="comment">#号开头的行。</span></span><br><span class="line">[root@oldboyedu nginx]<span class="comment"># egrep -v &quot;(^$|^#|^.*#)&quot; /etc/nginx/nginx.conf</span></span><br><span class="line"></span><br><span class="line">4.使用grep筛选出zabbix配置文件中所有开启的配置内容</span><br><span class="line">[root@oldboyedu nginx]<span class="comment"># egrep -v &quot;(^$|^#|^.*#)&quot; /etc/zabbix/zabbix_agentd.conf</span></span><br><span class="line">[root@oldboyedu nginx]<span class="comment"># egrep &quot;^[a-Z]&quot; /etc/zabbix/zabbix_agentd.conf</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>2.正则表达式实战</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">I am xuliangwei teacher!</span><br><span class="line">I teach linux.</span><br><span class="line">test</span><br><span class="line"></span><br><span class="line">I 1ike badminton ball ,billiard ball and chinese chess!</span><br><span class="line">my blog is http://1iangweilinux.blog.51cto.com</span><br><span class="line">our site is http://www.xuliangwei.com</span><br><span class="line">my qq num is 572891887.</span><br><span class="line">not 572891888887.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@she11 ~]# grep &quot;^m&quot; test.txt</span><br><span class="line">my blog is http://liangweilinux.blog.51cto.com</span><br><span class="line">my qq num is 572891887.</span><br><span class="line"></span><br><span class="line">[root@shel1 ~]# grep &quot;m$&quot; test.txt</span><br><span class="line">my blog is http://liangweilinux.blog.51cto.com</span><br><span class="line">our site is http://www.xuliangwei.com</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">排除空行，并打印行号</span></span><br><span class="line">[root@student ~]# greg -vn &quot;^$&quot; xuliangwei.txt</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">匹配任意一个字符，不包括空行</span></span><br><span class="line">[root@student ~]# grep &quot;.&quot; xuliangwei.txt</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">.匹配所有</span></span><br><span class="line">[root@student ~]# grep &quot;.*&quot; xuliangwei.txt</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">匹配单个任意字符</span></span><br><span class="line">[root@nodel ~]# grep &quot;xuliangw.i&quot; xuliangwei.txt</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">以点结尾的</span></span><br><span class="line">[root@student ~]# grep &quot;\.$&quot; xuliangwei.txt</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">精确匹配到</span></span><br><span class="line">[root@student ~]# grep -o &quot;8*&quot; xuliangwei.txt</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">匹配有abc的行</span></span><br><span class="line">[root@student ~]# grep &quot;[abc]&quot; xuliangwei.txt</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">匹配数字所在的行”[^0-9]”</span></span><br><span class="line">[root@student ~]# grep &quot;[0-9]&quot; xuliangwei.txt</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">匹配所有小写字母[^a-z]</span></span><br><span class="line">[root@student ~]# grep &quot;[a-z]&quot; xuliangwei.txt</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重复0三次</span></span><br><span class="line">[root@student ~]# grep &quot;8\&#123;3\&#125;&quot; xuliangwei.txt</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重复3个000不用转义符</span></span><br><span class="line">[root@student ~]# grep -E &quot;8&#123;3&#125;&quot; xuliangwei.txt</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重复数字8，3-5次</span></span><br><span class="line">[root@student ~]# grep -E &quot;8&#123;3,5&#125;&quot; test.txt</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">至少1次或1次以上</span></span><br><span class="line">[root@student ~]# grep -E &quot;8&#123;1,&#125;&quot; xuliangwei.txt</span><br></pre></td></tr></table></figure>

<p><strong>3.sed文本处理</strong></p>
<p>sed是一个流编辑器，非交互式的编辑器，它一次处理一行内容.处理时，把当前处理的行存储在临时缓冲区中，称<br>为“模式空间”（pattern space）接着用sed 命令处理缓冲区中的内容，处理完成后，把缓冲区的内容送往屏幕。接着处理下一行，这样不断重复，直到文件末尾。文件内容并没有改变，除非你使用重定向存储输出。Sed要用来自<br>动编辑一个或多个文件；简化对文件的反复操作；编写转换程序等。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">sed</span><br><span class="line">sed的是一个流编辑器，读取文件一行，存放在缓存区，然后处理，最后输出。</span><br><span class="line">sed功能很强，支持增、删、改（替换）、查。</span><br><span class="line"></span><br><span class="line">sed选项参数</span><br><span class="line">-e 允许多项编辑</span><br><span class="line">-n 取消默认的输出</span><br><span class="line">-i 直接修改对应文件</span><br><span class="line">-r 支持扩展元字符</span><br><span class="line"></span><br><span class="line">sed命令参数</span><br><span class="line">a 在当前行后添加一行或多行</span><br><span class="line">c 在当前行进行替换修改</span><br><span class="line">d 在当前行进行删除操作</span><br><span class="line">i 在当前行之前插入文本</span><br><span class="line">p 打印匹配的行或指定行</span><br><span class="line">n 读入下一输入行，从下一条命令进行处理 ！对所选行以外的所有行应用命令</span><br><span class="line">h 把模式空间里的内容重定向到暂存缓冲区</span><br><span class="line">H 把模式空间里的内容追加到暂存缓冲区</span><br><span class="line">g 取出暂存缓冲区的内容，将其复制到模式空间，覆盖该处原有内容</span><br><span class="line">G 取出暂存缓冲区的内容，将其复制到模式空间，追加在原有内容后面</span><br><span class="line"></span><br><span class="line">1.sed的打印命令p</span><br><span class="line">    打印匹配halt的行</span><br><span class="line">    [rootaShell ~]<span class="comment"># sed -n &#x27;/halt/p&#x27; passwd</span></span><br><span class="line">    halt:x:7:0:halt:/sbin:/sbin/halt</span><br><span class="line">    打印第二行的内容</span><br><span class="line">    [root@Shell ~]<span class="comment"># sed -n &#x27;2p&#x27; passwd</span></span><br><span class="line">    bin:x:1:1:bin:/bin:/sbin/nologin</span><br><span class="line">    打印最后一行</span><br><span class="line">    [root@Shell ~]<span class="comment"># sed -n &#x27;$p&#x27; passwd</span></span><br><span class="line">    </span><br><span class="line">2.sed的追加方式</span><br><span class="line">给30行添加配置\n换行符</span><br><span class="line">[root@Shell ~]<span class="comment"># sed -i &#x27;30a listen 80;&#x27; passwd</span></span><br><span class="line">在37行添加一条记录, \t tab键（需要转义）</span><br><span class="line">[root@oldboyedu nginx]<span class="comment"># sed -ri &#x27;37a \\t Listen 8080;&#x27; nginx.conf</span></span><br><span class="line">在37行添加一条记录, \n 换行符（需要转义）</span><br><span class="line">[root@oldboyedu nginx]<span class="comment"># sed -ri &#x27;37a \\n Listen 8080;&#x27; nginx.conf</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.sed修改命令c</span><br><span class="line">//指定某行进行内容替换</span><br><span class="line">[rootaShel1 ~]<span class="comment"># sed -i &#x27;7c SELINUX=Disabled&#x27; /etc/selinux/config</span></span><br><span class="line">//正则匹配对应内容，然后进行替换</span><br><span class="line">[root@oldboyedu nginx]<span class="comment"># sed -i &#x27;/^ *server_name/c server_name oldboyedu.com&#x27; nginx.conf</span></span><br><span class="line"></span><br><span class="line">//非交互式修改指定的配置文件</span><br><span class="line">[root@Shell ~]<span class="comment"># sed -ri &#x27;/UseDNS/c UseDNS no&#x27; /etc/ssh/sshd_config</span></span><br><span class="line">[root@Shell ~]<span class="comment"># sed -ri &#x27;/GSSAPIAuthentication/c #GSSAPIAuthentication no&#x27;</span></span><br><span class="line">/etc/ssh/sshd_config</span><br><span class="line">[root@Shell ~]<span class="comment"># sed -ri &#x27;/^SELINUX=/c SELINUX=disabled&#x27; /etc/selinux/config</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4.sed的删除命令d</span><br><span class="line">指定删除第三行，但不会改变文件内容</span><br><span class="line">[root@shell ~]<span class="comment"># sed &#x27;3d&#x27; passwd</span></span><br><span class="line">[root@shell ~]<span class="comment"># sed &#x27;3&#123;d&#125;&#x27; passwd</span></span><br><span class="line">从第三行删除到最后一行</span><br><span class="line">[root@shell ~]<span class="comment"># sed &#x27;3,$d&#x27; passwd</span></span><br><span class="line"><span class="comment">#删除最后一行</span></span><br><span class="line">[root@shell ~]<span class="comment"># seq &#x27;$d&#x27; passwd</span></span><br><span class="line"><span class="comment">#删除所有的行</span></span><br><span class="line">[root@shell ~]<span class="comment"># sed &#x27;1,$d&#x27; passwd</span></span><br><span class="line"><span class="comment">#匹配正则进行该行删除</span></span><br><span class="line">[root@shell ~]<span class="comment"># sed /mail/d passwd</span></span><br><span class="line">[root@oldboyedu nginx]<span class="comment"># mysql -uroot -p123.com -e &quot;show databases;&quot;|sed 1d</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5.sed获取下一行命令n</span><br><span class="line">//匹配root的行，删除root行的下一列</span><br><span class="line">[root@Shell ~]<span class="comment"># sed &#x27;/root/&#123;n;d&#125;&#x27; passwd</span></span><br><span class="line">//替换匹配root行的下一列</span><br><span class="line">[root@Shell ~]<span class="comment"># sed &#x27;/root/&#123;n; s/bin/test/&#125;&#x27; passwd</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>sed命令格式</strong></p>
<p><code>sed [options] &#39;command&#39; file(s)</code></p>
<p>sed正则使用</p>
<blockquote>
<p>与grep一样，sed在文件中查找模式时也可以使用正则表达式（RE）和各种元字符。正则表达式是括在斜杠间的模式，用于查找和替换，以下是sed支持的元字符。使用基本元字符集 ^, $, ., *, [], [^], &lt;&gt;, (), {}使用扩展元字符集 ?, +, { }, |, ()使用扩展元字符的方式+sed</p>
</blockquote>
<p><strong>sed命令示例</strong></p>
<p><code>sed</code> 对指定行进行操作，包括打印、删除、修改、追加等。</p>
<p>sed选项参数</p>
<blockquote>
<p>-e 允许多项编辑</p>
<p>-n 取消默认的输出</p>
<p>-i 直接修改对应文件</p>
<p>-r 支持扩展元字符</p>
</blockquote>
<p><code>sed</code> 命令参数</p>
<blockquote>
<p>a 在当前行后添加一行或多行 </p>
<p>c 在当前行进行替换修改 </p>
<p>d 在当前行进行删除操作</p>
<p>i 在当前行之前插入文本 </p>
<p>p 打印匹配的行或指定行 </p>
<p>n 读入下一输入行，从下一条命令进行处理  ! 对所选行以外的所有行应用命令 </p>
<p>h 把模式空间里的内容重定向到暂存缓冲区 </p>
<p>H 把模式空间里的内容追加到暂存缓冲区 </p>
<p>g 取出暂存缓冲区的内容，将其复制到模式空间，覆盖该处原有内容 </p>
<p>G 取出暂存缓冲区的内容，将其复制到模式空间，追加在原有内容后面</p>
</blockquote>
<p>多重编辑选项 <code>e</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//先删除行，然后管道给后面的sed进行替换</span><br><span class="line">[rootashell ~]<span class="comment"># sed &#x27;1,9d&#x27; passwd |sed &#x27;s#root#alex#g&#x27;</span></span><br><span class="line">//使用-e进行多次编辑修改操作</span><br><span class="line">[rootashel1 ~]<span class="comment"># sed -e &#x27;1,9d&#x27; -e &#x27;s#root#alex#g&#x27; passwd</span></span><br></pre></td></tr></table></figure>

<p>打印命令 <code>p</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//打印匹配halt的行</span><br><span class="line">[root@shell ~]<span class="comment"># sed -n &#x27;/halt/p&#x27; passwd</span></span><br><span class="line">halt:x:7:0:halt:/sbin:/sbin/halt</span><br><span class="line">//打印第二行的内容</span><br><span class="line">[rootashell ~]<span class="comment"># sed -n &#x27;2p&#x27; passwd</span></span><br><span class="line">bin:x:1:1:bin:/bin:/sbin/nologin</span><br><span class="line">//打印最后一行</span><br><span class="line">[rootashel1 ~]<span class="comment"># sed -n &#x27;$p&#x27; passwd</span></span><br></pre></td></tr></table></figure>

<p>追加命令 <code>a</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//给30行添加配置 \t tab键（需要转义）\n 换行符</span><br><span class="line">[root@shell ~]<span class="comment"># sed -i &#x27;30a listen 80;&#x27; passwd</span></span><br></pre></td></tr></table></figure>

<p>修改命令 <code>c</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//指定某行进行内容替换</span><br><span class="line">[rootaShel1 ~]<span class="comment"># sed -i &#x27;7c SELINUX=Disabled&#x27; /etc/selinux/config</span></span><br><span class="line"></span><br><span class="line">//正则匹配对应内容，然后进行替换</span><br><span class="line">sed -i <span class="string">&#x27;/^SELINUX=/c SELINUX=Disabled&#x27;</span> /etc/selinux/config</span><br><span class="line">//非交互式修改指定的配置文件</span><br><span class="line">[root@Shell ~]<span class="comment"># sed -ri &#x27;/UseDNS/c UseDNS no&#x27; /etc/ssh/sshd_config</span></span><br><span class="line">[root@Shell ~]<span class="comment"># sed -ri &#x27;/GSSAPIAuthentication/c #GSSAPIAuthentication no&#x27;</span></span><br><span class="line">/etc/ssh/sshd_config</span><br><span class="line">[root@Shell ~]<span class="comment"># sed -ri &#x27;/^SELINUX=/c SELINUX=disabled&#x27; /etc/selinux/config</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>删除命令 <code>d</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//指定删除第三行，但不会改变文件内容</span><br><span class="line">[root@shell ~]<span class="comment"># sed &#x27;3d&#x27; passwd</span></span><br><span class="line">[root@shell ~]<span class="comment"># sed &#x27;3&#123;d&#125;&#x27; passwd</span></span><br><span class="line">//从第三行删除到最后一行</span><br><span class="line">[root@shell ~]<span class="comment"># sed &#x27;3,$d&#x27; passwd</span></span><br><span class="line">//删除最后一行</span><br><span class="line">[root@shell ~]<span class="comment"># seq &#x27;$d&#x27; passwd</span></span><br><span class="line">//删除所有的行</span><br><span class="line">[root@shell ~]<span class="comment"># sed &#x27;1,$d&#x27; passwd</span></span><br><span class="line"></span><br><span class="line">//匹配正则进行该行删除</span><br><span class="line">[root@shell ~]<span class="comment"># sed /mail/d passwd</span></span><br></pre></td></tr></table></figure>


<p>插入命令 <code>i</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//在文件的某一行上面添加内容</span><br><span class="line">[rootashell ~]<span class="comment"># sed -i &#x27;30i listen 80;&#x27; passwd</span></span><br></pre></td></tr></table></figure>

<p>写文件命令 <code>w</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//将匹配到的行写入到新文件中</span><br><span class="line">[root@shell ~]<span class="comment"># sed -n &#x27;/root/w newfile&#x27; passwd</span></span><br><span class="line"></span><br><span class="line">//将passwd文件的第二行写入到newfile中</span><br><span class="line">[root@shell ~]<span class="comment"># sed -n &#x27;2w newfile&#x27; passwd</span></span><br></pre></td></tr></table></figure>

<p>获取下一行命令 <code>n</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//匹配root的行，删除root行的下一列</span><br><span class="line">[root@she11 ~]<span class="comment"># sed &#x27;/root/&#123;n;d&#125;&#x27; passwd</span></span><br><span class="line"></span><br><span class="line">//替换匹配root行的下一列</span><br><span class="line">[root@shell ~]<span class="comment"># sed &#x27;/root/&#123;n; s/bin/test/&#125;&#x27; passwd</span></span><br></pre></td></tr></table></figure>

<p>暂存和取用命令 <code>h H g G</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//将第一行的写入到暂存区，替换最后一行的内容</span><br><span class="line">[root@shell ~]<span class="comment"># sed &#x27;1h;$g&#x27; /etc/hosts</span></span><br><span class="line"></span><br><span class="line">//将第一行的写入到暂存区，在最后一行调用暂存区的内容</span><br><span class="line">[root@shell ~]<span class="comment"># sed &#x27;1h;$G&#x27; /etc/hosts</span></span><br><span class="line"></span><br><span class="line">//将第一行的内容删除但保留至暂存区，在最后一行调用暂存区内容追加至于尾部</span><br><span class="line">[root@shell ~]<span class="comment"># sed -r &#x27;1&#123;h;d&#125;;$G&#x27; /etc/hosts</span></span><br><span class="line"></span><br><span class="line">//将第一行的内容写入至暂存区，从第二行开始进行重定向替换</span><br><span class="line">[root@shell ~]<span class="comment"># sed -r &#x27;1h;2,$g&#x27; /etc/hosts</span></span><br><span class="line"></span><br><span class="line">//将第一行重定向至暂存区，2-3行追加至暂存区，最后追加调用暂存区的内容</span><br><span class="line">[root@shell ~]<span class="comment"># sed -r &#x27;1h; 2,3H; $G&#x27; /etc/hosts</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>反向选择命令 <code>!</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//除了第三行，其他全部删除</span><br><span class="line">[root@shell ~]<span class="comment"># sed -r &#x27;3!d&#x27; /etc/hosts</span></span><br></pre></td></tr></table></figure>

<p><strong>sed匹配替换</strong></p>
<blockquote>
<p>s 替换命令标志</p>
<p>g 行内全局替换</p>
<p>i 忽略替换大小写</p>
</blockquote>
<p>替换命令 <code>s</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">//替换每行出现的第一个root</span><br><span class="line">[root@shell ~]<span class="comment"># sed &#x27;s/root/alice/&#x27; passwd</span></span><br><span class="line">//替换以root开头的行</span><br><span class="line">[root@shell ~]<span class="comment"># sed &#x27;s/^root/alice/&#x27; passwd</span></span><br><span class="line">//查找匹配到的行，在匹配的行后面添加内容</span><br><span class="line">[root@shell ~]<span class="comment"># sed -r &#x27;s/[0-9][0-9]$/&amp; .5/&#x27; passwd</span></span><br><span class="line"></span><br><span class="line">//匹配包含有root的行进行替换</span><br><span class="line">[root@shell ~]<span class="comment"># sed -r &#x27;s/root/alice/g&#x27; passwd</span></span><br><span class="line">//匹配包含有root的行进行替换，忽略大小写</span><br><span class="line"><span class="comment"># sed -r &#x27;s/root/alice/gi&#x27; /etc/passwd</span></span><br><span class="line"></span><br><span class="line">//后向引用</span><br><span class="line">[root@shell ~]<span class="comment"># sed -r &#x27;s#(Roo)#\1-alice#g&#x27; passwd</span></span><br><span class="line">[root@shell ~]<span class="comment"># ifconfig eth0|sed -n &#x27;2p&#x27;|sed -r &#x27;s#(^.*et) (.*) (net.*$)#\2#g&#x27;</span></span><br><span class="line"></span><br><span class="line">//示例</span><br><span class="line">[root@bgx ~]<span class="comment"># vim a.txt</span></span><br><span class="line">/etc/abc/456</span><br><span class="line">etc</span><br><span class="line">//删除文本中的内容，需加转义</span><br><span class="line">[root@shell ~]<span class="comment"># sed -r &#x27;\/etc\/abc\/456/d&#x27; a.txt</span></span><br><span class="line">//如果碰到/符号，建议使用<span class="comment">#符替换</span></span><br><span class="line">[root@shell ~]<span class="comment"># sed -r &#x27;s#/etc/abc/456#/dev/null#g&#x27; a.txt</span></span><br><span class="line">[root@shell ~]<span class="comment"># sed -r &#x27;s@/etc/abc/456@/dev/null@&#x27; a.txt</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sed替换操作：</span><br><span class="line">    基本的替换操作 -r可以不用对/进行转义。这样会更加的清晰。</span><br><span class="line">    最终的就是后向引用。</span><br><span class="line">    命令：</span><br><span class="line">        a    追加后面</span><br><span class="line">        i    追加前面</span><br><span class="line">        c    行替换，支持正则表达式</span><br><span class="line">        d    删除</span><br><span class="line">        p    打印</span><br><span class="line">        sg    替换组合(非常重要)</span><br><span class="line">    选项：</span><br><span class="line">        -n：取消默认的输出</span><br><span class="line">        -i：将修改后的内容保存到文件中</span><br><span class="line">        -r：扩展正则，可以对/不进行转义。</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="1-Awk基本介绍"><a href="#1-Awk基本介绍" class="headerlink" title="1.Awk基本介绍"></a>1.Awk基本介绍</h5><p><strong>1.什么是awk</strong></p>
<p>awk不仅仅是一个文本处理工具，同时也是一门编程语言，是linux上功能最强大的数据处理工具之一。</p>
<p><strong>2.awk语法格式</strong></p>
<p>awk [options] ‘commands’  filenames</p>
<p>awk [options] -f awk-script-file filenames</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220415095924390.png" alt="image-20220415095924390"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#命令 command</span></span><br><span class="line">行处理前    行处理    行处理后</span><br><span class="line">BEGIN&#123;&#125;    &#123;&#125;       END&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#BEGIN发生在读文件之前</span></span><br><span class="line">[root@Shell ~]<span class="comment"># awk &#x27;BEGIN&#123;print 1/2&#125;&#x27;</span></span><br><span class="line">0.5</span><br><span class="line"><span class="comment">#BEGIN在行处理前，修改字段分隔符</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk &#x27;BEGIN&#123;FS=&quot;:&quot;&#125; &#123;print $1&#125;&#x27; /etc/passwd</span></span><br><span class="line"><span class="comment">#BEGIN在行处理前，修改字段读入和输出分隔符</span></span><br><span class="line">[root@Shell ~]<span class="comment"># awk &#x27;BEGIN&#123;FS=&quot;:&quot;;OFS=&quot;---&quot;&#125; &#123;print $1,$2&#125;&#x27; /etc/passwd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk &#x27;BEGIN&#123;print 1/2&#125; &#123;print &quot;ok&quot;&#125; END &#123;print &quot;Game Over&quot;&#125;&#x27; /etc/host</span></span><br><span class="line">0.5</span><br><span class="line">ok</span><br><span class="line">ok</span><br><span class="line">ok</span><br><span class="line">Game Over</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>awk</code> 命令格式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例1,匹配 awk &#x27;pattern&#x27; filename</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk &#x27;/root/&#x27; /etc/passwd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例2,处理动作 awk &#x27;&#123;action&#125;&#x27; filename</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk -F: &#x27;&#123;print $1&#125;&#x27; /etc/passwd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例3,匹配+处理动作 awk &#x27;pattern&#123;action&#125;&#x27; filename</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk -F &#x27;:&#x27; &#x27;/root/ &#123;print $1,$3&#125;&#x27; /etc/passwd</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk&#x27;BEGIN&#123;FS=&quot;:&quot;&#125; /root/&#123;print $1,$3&#125;&#x27; /etc/passwd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例4,判断大于多少则输出什么内容command |awk &#x27;pattern &#123;action&#125;&#x27;</span></span><br><span class="line">[root@she11 ~]<span class="comment"># df |awk &#x27;/\/$/ &#123;if ($3&gt;50000) print $4&#125;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>Awk工作原理</strong></p>
<p><code># awk -F &#39;:&#39; &#39;&#123;print $1,$3&#125;&#39; /etc/passwd</code> </p>
<p>1.awk将文件中的每一行作为输入，awk会将每一行赋给内部变量 <code>$0</code> ,以换行符结束</p>
<p>2.awk开始进行字段分解，每个字段存储在已编号的变量中，从 <code>$1</code> 开始 [ 默认空格分割 ]</p>
<p>3.awk默认字段分隔符是由内部 <code>FS</code> 变量来确定可以使用 <code>-F</code> 修订</p>
<p>4.awk行处理时使用了 <code>print</code> 函数打印分割后的字段</p>
<p>5.awk在打印后的字段加上空格，因为 <code>$1,$3</code> 之间有一个逗号。逗号被映射至 <code>OFS</code> 内部变量中，称为输出字段分隔符， <code>OFS</code> 默认为空格.</p>
<p>6.awk输出之后，将从文件中获取另一行，并将其存储在 <code>$0</code> 中，覆盖原来的内容，然后将新的字符串分隔成字段<br>并进行处理。该过程将持续到所有行处理完毕。</p>
<p><strong>2.Awk分隔符</strong></p>
<p>在学习awk的过程中，我们先来快速的熟悉下awk分隔符的作用。请事先准备如下数据文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ bgx ~]# cat awk_file.txt</span><br><span class="line">ll 1990 50 51 61</span><br><span class="line">kk 1991 60 52 62</span><br><span class="line">hh 1992 70 53 63</span><br><span class="line">jj 1993 80 54 64</span><br><span class="line">mm 1994 90 55 65</span><br></pre></td></tr></table></figure>

<p>1.awk指定多个分隔符，awk默认以空白行作为分隔符</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.如何查看文件中的第一列</span></span><br><span class="line">[root@swt bgx]# awk &#x27;&#123;print $1&#125;&#x27; awk_file.txt</span><br><span class="line">ll</span><br><span class="line">kk</span><br><span class="line">hh</span><br><span class="line">jj</span><br><span class="line">mm</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.如果有的文件不是以空格为分隔符怎么办?比如/etc/passwd</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.如何指定多个分隔符，比如想获取第二列的内容？</span></span><br><span class="line">[root@ bgx ~]# cat awk_file.txt</span><br><span class="line">ll:1990 50 51 61</span><br><span class="line">kk:1991 60 52 62</span><br><span class="line">hh 1992 70 53 63</span><br><span class="line">jj 1993 80 54 64</span><br><span class="line">mm 1994 90 55 65</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">以冒号或空格为分隔符</span></span><br><span class="line">[root@swt bgx]# awk -F &#x27;[: ]&#x27; &#x27;&#123;print $2&#125;&#x27; awk_file.txt</span><br><span class="line">1990</span><br><span class="line">1991</span><br><span class="line">1992</span><br><span class="line">1993</span><br><span class="line">1994</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4.指定多个分隔符</span></span><br><span class="line">[root@swt bgx]# cat awk_file.txt</span><br><span class="line">ll::1990 50 51 61</span><br><span class="line">kk:1991 60 52 62</span><br><span class="line">hh 1992 70 53 63</span><br><span class="line">jj 1993 80 54 64</span><br><span class="line">mm 1994 90 55 65</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">[：]+连续的多个冒号当一个分隔符，连续的多个空格当一个分隔符，连续空格和冒号也当做一个字符来处理</span></span><br><span class="line">[root@swt bgx]# awk -F &#x27;[: ]+&#x27; &#x27;&#123;print $2&#125;&#x27; awk_file.txt</span><br><span class="line">1990</span><br><span class="line">1991</span><br><span class="line">1992</span><br><span class="line">1993</span><br><span class="line">1994</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">[：]+</span></span><br><span class="line">    1.连续的多个冒号当一个分隔符</span><br><span class="line">    2.连续的多个空格当一个分隔符</span><br><span class="line">    3.连续空格和冒号也当做一个分隔符</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&quot;[： \t]+&quot;</span><br><span class="line">    1.连续的多个冒号当一个分隔符</span><br><span class="line">    2.连续的多个空格当一个分隔符</span><br><span class="line">    3.连续空格和冒号也当做一个分隔符</span><br><span class="line">    4.连续空格和tab也当做一个分隔符</span><br><span class="line">    5.连续tab也当做一个分隔符</span><br><span class="line">    6.连续的冒号空格tab都算一个分隔符</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>3.Awk内部变量</strong></p>
<p>要想了解awk的一些内部变量需要先准备如下数据文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ bgx ~]# cat awk_file.txt</span><br><span class="line">ll 1990 50 51 61</span><br><span class="line">kk 1991 60 52 62</span><br><span class="line">hh 1992 70 53 63</span><br><span class="line">jj 1993 80 54 64</span><br><span class="line">mm 1994 90 55 65</span><br></pre></td></tr></table></figure>

<p>1.awk内置变量NF，保存每行的最后一列</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.通过print打印，NF和$NF，你发现了什么？</span></span><br><span class="line">[root@swt bgx]<span class="comment"># awk &#x27;&#123;print NF,$NF]&#x27; awk_file.txt</span></span><br><span class="line">5 61</span><br><span class="line">5 62</span><br><span class="line">5 63</span><br><span class="line">5 64</span><br><span class="line">5 65</span><br><span class="line"></span><br><span class="line"><span class="comment">#F：如果将第五行的55置为空，那么该如何在获取最后一列的数字？</span></span><br><span class="line">[root@swt bgx]<span class="comment"># awk &#x27;&#123;print $5&#125;&#x27; awk_file.txt</span></span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">    <span class="comment">#最后一列为空，为什么？</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Q.使用$NF为什么就能成功？（因为NF变量保存的是每一行的最后一列）</span></span><br><span class="line">[root@swt bgx]<span class="comment"># awk &#x27;&#123;print $NF&#125;&#x27; awk_file.txt</span></span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line"></span><br><span class="line"><span class="comment">#2.如果一个文件很长，靠数列数需要很长的时间，那如何快速打印倒数第二列？</span></span><br><span class="line">[root@swt bgx]<span class="comment"># awk &#x27;&#123;print $(NF-1)&#125;&#x27; awk_file.txt</span></span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">90</span><br><span class="line"></span><br><span class="line"><span class="comment">#3.FNR扩展了解</span></span><br><span class="line">[root@Shell ~]<span class="comment"># awk &#x27;&#123;print FNR,$0&#125;&#x27; awk_file.txt awk_filel.txt</span></span><br></pre></td></tr></table></figure>

<p>2.awk内置变量NR，表示记录行号</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.使用pring打印NR，会发现NR会记录每行文件的行号</span></span><br><span class="line">[root@swt bgx]# awk &#x27;&#123;print NR,$0&#125;&#x27; awk_file.txt</span><br><span class="line">1 ll 1990 50 51 61</span><br><span class="line">2 kk 1991 60 52 62</span><br><span class="line">3 hh 1992 70 53 63</span><br><span class="line">4 jj 1993 80 54 64</span><br><span class="line">5 mm 1994 90    65</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.那如果我们想打印第二行到第三行的内容怎么办？</span></span><br><span class="line">[root@swt bgx]# awk &#x27;NR&gt;1&amp;&amp;NR&lt;4 &#123;print NR,$0&#125;&#x27; awk_file.txt</span><br><span class="line">2 kk 1991 60 52 62</span><br><span class="line">3 hh 1992 70 53 63</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.那如果只想打印第三行，该怎么办？</span></span><br><span class="line">[root@swt bgx]# awk &#x27;NR==3 &#123;print NR,$0]&#x27; awk_file.txt</span><br><span class="line">3 hh 1992 70 53 63</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.那如果既想打印第三行，又想打印第一列？</span></span><br><span class="line">[root@swt bgx]# awk&#x27;NR==3 &#123;print NR,$1&#125;&#x27;awk_file.txt</span><br><span class="line">3 hh</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-4-centos shell]<span class="comment"># awk &#x27;NR==3 &#123;print NR,$0&#125;&#x27; awk_file.txt    #打印2-3行的内容</span></span><br><span class="line">[root@VM-20-4-centos shell]<span class="comment"># awk &#x27;NR&gt;1&amp;&amp;NR&lt;4 &#123;print NR,$0&#125;&#x27; awk_file.txt    #打印第三行的内容</span></span><br><span class="line">[root@VM-20-4-centos shell]<span class="comment"># awk &#x27;NR!=3&#123;print $0&#125;&#x27; awk_file.txt    #打印除了第三行</span></span><br><span class="line">[root@VM-20-4-centos shell]<span class="comment"># awk &#x27;NR&gt;1&amp;&amp;NR&lt;4 &#123;print NR,$1&#125;&#x27; awk_file.txt    #打印2-3行的第一列，以空格为分隔符</span></span><br></pre></td></tr></table></figure>



<p>3.awk内置变量，$0保存当前记录的内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@shell ~]<span class="comment"># awk &#x27;&#123;print $0&#125;&#x27; /etc/passwd</span></span><br></pre></td></tr></table></figure>

<p>5.awk内置变量，FS指定字段分割符 默认是空格</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#以冒号作为字段分隔符</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk -F: &#x27;/root/&#123;print $1,$3&#125;&#x27; /etc/passwd</span></span><br><span class="line">[root@Shell ~]<span class="comment"># awk &#x27;BEGIN&#123;FS=&quot;:&quot;&#125; &#123;print $1,$3&#125;&#x27; /etc/passwd</span></span><br><span class="line"><span class="comment">#以空格冒号tab作为字段分割</span></span><br><span class="line">[rootashell ~]<span class="comment"># awk -F&#x27;[ :\t]&#x27; &#x27;&#123;print $1,$2,$3&#125;&#x27; /etc/passwd</span></span><br></pre></td></tr></table></figure>

<p>6.awk内置变量，OFS指定输出字段分隔符</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#,逗号映射为OFS，初始情况下OFS变量是空格</span></span><br><span class="line">[rootashell ~]<span class="comment"># awk -F: &#x27;/root/&#123;print $1,$2,$3,$4&#125;&#x27; /etc/passwd</span></span><br><span class="line">[rootaShell ~]<span class="comment"># awk &#x27;BEGIN&#123;FS=&quot;:&quot;; OFS=&quot;+++&quot;&#125; /^root/&#123;print $1,$2&#125;&#x27; /etc/passwd</span></span><br></pre></td></tr></table></figure>

<p>9.print格式化输出函数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@shell ~]<span class="comment"># date|awk &#x27;&#123;print $2,&quot;5月份&quot;&quot;\n&quot;,$NF,&quot;今年&quot;&#125;&#x27;</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk -F: &#x27;&#123;print &quot;用户是:&quot; $1 &quot;\t 用户uid: &quot; $3 &quot;\t 用户gid:&quot; $4&#125;&#x27; /etc/passwd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#printf 函数</span></span><br><span class="line">[root@she11 ~]<span class="comment"># awk -F: &#x27;&#123;printf &quot;%-15s %-10s %-15s\n&quot;, $1, $2, $3&#125;&#x27; /etc/passwd</span></span><br><span class="line"><span class="comment">#%s 字符类型</span></span><br><span class="line"><span class="comment">#%d 数值类型</span></span><br><span class="line"><span class="comment">#占 15字符，- 表示左对齐，默认是右对齐</span></span><br><span class="line"><span class="comment">#printf 默认不会在行尾自动换行，加\n</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">内置变量</span><br><span class="line">NF		<span class="comment">#记录每行内容的最后一列，通常记录的是一个整数</span></span><br><span class="line">NR		<span class="comment">#记录行号</span></span><br><span class="line">FS		<span class="comment">#指定字段分隔符</span></span><br><span class="line">OFS		<span class="comment">#指定输出字段分隔符</span></span><br><span class="line"><span class="variable">$0</span>		<span class="comment">#代表每行的所有内容，</span></span><br><span class="line"><span class="variable">$1</span>,<span class="variable">$2</span>	<span class="comment">#指定字段分隔符后，每列的内容</span></span><br><span class="line"><span class="built_in">print</span>	<span class="comment">#输出内容</span></span><br><span class="line"><span class="built_in">printf</span>	<span class="comment">#格式化输出</span></span><br></pre></td></tr></table></figure>



<p><strong>Awk模式动作</strong></p>
<p>awk语句都由模式和动作组成。模式部分决定动作语句何时触发及触发事件。如果省略模式部分，动作将时刻保持执行状态。模式可以是条件语句或复合语句或正则表达式。</p>
<p>1.正则表达式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#匹配记录（整行）</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk &#x27;/^root/&#x27; /etc/passwd</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk &#x27;$0 ~ /^root/&#x27; /etc/passwd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#匹配字段：匹配操作符（~ !~）</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk &#x27;$1~/^root/&#x27; /etc/passwd</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk &#x27;$NF !~ /bash$/&#x27; /etc/passwd</span></span><br></pre></td></tr></table></figure>

<p>2.比较表达式</p>
<p>比较表达式采用对文本进行比较，只有当条件为真，才执行指定的动作。比较表达式使用关系运算符，用于比较数<br>字与字符串。</p>
<p>关系运算符</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">运算符		含义			示例</span><br><span class="line">&lt;         小于          x&lt;y</span><br><span class="line">&lt;=        小于或等于     x&lt;=y</span><br><span class="line">==        等于          x==y</span><br><span class="line">!=        不等于        x!=y</span><br><span class="line">&gt;=        大于等于       x&gt;=y</span><br><span class="line">&gt;         大于          x&gt;y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//uid为o的列出来</span><br><span class="line">[root@shell ~]<span class="comment"># awk -F &quot;:&quot; &#x27;$3==0&#x27; /etc/passwd</span></span><br><span class="line">//uid小于10的全部列出来</span><br><span class="line">[root@shell ~]<span class="comment"># awk -F: &#x27;$3 &lt; 10&#x27; /etc/passwd</span></span><br><span class="line">//用户登陆的shell等于/bin/bash</span><br><span class="line">[root@shell ~]<span class="comment"># awk -F: &#x27;$7 == &quot;/bin/bash&quot; &#x27; /etc/passwd</span></span><br><span class="line">//第一列为a1ice的列出来</span><br><span class="line">[rootashell ~]<span class="comment"># awk -F:&#x27;$1 == &quot;alice&quot; &#x27;/etc/passwd</span></span><br><span class="line">//为a1ice的用户列出来</span><br><span class="line">[root@shell ~]<span class="comment"># awk -F: &#x27;$1 ~ /alice/ &#x27; /etc/passwd</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk -F: &#x27;$1 !~ /alice/ &#x27; /etc/passwd</span></span><br><span class="line">//磁盘使用率大于多少则，则打印可用的值</span><br><span class="line">[root@shell ~]<span class="comment"># df |awk &#x27;/\/$/&#x27;|awk &#x27;$3&gt;1000000 &#123;print $4&#125;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3.条件表达式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@shell ~]<span class="comment"># awk -F: &#x27;$3&gt;300 &#123;print $0]&#125;&#x27; /etc/passwd</span></span><br><span class="line">[root@shel1 ~]<span class="comment"># awk -F: &#x27;&#123;if($3&gt;300) print $0&#125;&#x27; /etc/passwd</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk -F: &#x27;&#123;if($3&gt;5555)&#123;print $3&#125; else &#123;print $1&#125;&#125;&#x27; /etc/passwd</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>4.运算表达式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@shell ~]<span class="comment"># awk -F: &#x27;$3 * 10 &gt; 500000&#x27; /etc/passwd</span></span><br><span class="line">[root@Shell ~]<span class="comment"># awk -F: &#x27;BEGIN&#123;OFS=&quot;--&quot;&#125; &#123; if($3*10&gt;50000) &#123;print $1,$3&#125; &#125; END &#123;print &quot;打印ok&quot;&#125;&#x27; /etc/passwd</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk &#x27;/southem/&#123;print $5 + 10&#125;&#x27; datafile</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk &#x27;/southem/&#123;print $5 + 10.56&#125;&#x27; datafile</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk &#x27;/southem/&#123;print $8 - 10&#125;&#x27; datafile</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk &#x27;/southem/&#123;print $8 / 2 &#125;&#x27; datafile</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk &#x27;/southem/&#123;print $8 * 2 &#125;&#x27; datafile</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk &#x27;/southem/&#123;print $8 % 2 &#125;&#x27; datafile</span></span><br></pre></td></tr></table></figure>

<p>5.逻辑操作符和复合模式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&amp;&amp;逻辑与  ||逻辑或  !逻辑非</span><br><span class="line"></span><br><span class="line">//匹配用户名为root并且打印uid小于15的行</span><br><span class="line">[root@shell ~]<span class="comment"># awk -F: &#x27;$1~/root/ &amp;&amp; $3&lt;=15&#x27; /etc/passwd</span></span><br><span class="line">//匹配用户名为root或uid大于5000</span><br><span class="line">[root@shell ~]<span class="comment"># awk -F: &#x27;$1~/root/ || $3&gt;=5000&#x27; /etc/passwd</span></span><br></pre></td></tr></table></figure>

<p><code>awk</code> 示例1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># awk &#x27;/west/&#x27; datafile</span></span><br><span class="line"><span class="comment"># awk &#x27;/^north/&#x27; datafile</span></span><br><span class="line"><span class="comment"># awk &#x27;$3 ~ /^north/&#x27; datafile</span></span><br><span class="line"><span class="comment"># awk &#x27;/^(no|so)/&#x27; datafile</span></span><br><span class="line"><span class="comment"># awk &#x27;&#123;print $3,$2&#125;&#x27; datafile</span></span><br><span class="line"><span class="comment"># awk &#x27;&#123;print $3 $2&#125;&#x27; datafile</span></span><br><span class="line"><span class="comment"># awk &#x27;&#123;print $0&#125;&#x27; datafile</span></span><br><span class="line"><span class="comment"># awk &#x27;&#123;print &quot;Number of fields: &quot;NF&#125;&#x27; datafile</span></span><br><span class="line"><span class="comment"># awk &#x27;/northeast/&#123;print $3,$2&#125;&#x27; datafile</span></span><br><span class="line"><span class="comment"># awk &#x27;/^[ns]/&#123;print $1&#125;&#x27; datafile</span></span><br><span class="line"><span class="comment"># awk &#x27;$5 ~ /\. [7-9]+/&#x27; datafile</span></span><br><span class="line"><span class="comment"># awk &#x27;$2 !~ /E/&#123;print $1,$2&#125;&#x27; datafile</span></span><br><span class="line"><span class="comment"># awk &#x27;$3 ~ /^Joel/&#123;print $3 &quot;is a nice boy.&quot;&#125;&#x27; datafile</span></span><br><span class="line"><span class="comment"># awk &#x27;$8 ~ /[0-9][0-9]$/&#123;print $8&#125;&#x27; datafile</span></span><br><span class="line"><span class="comment"># awk &#x27;$4 ~ /Chin$/&#123;print &quot;The price is $&quot; $8 &quot;.&quot;&#125;&#x27; datafile</span></span><br><span class="line"><span class="comment"># awk &#x27;/Tj/&#123;print $0&#125;&#x27; datafile</span></span><br><span class="line"><span class="comment"># awk -F: &#x27;&#123;print &quot;Number of fields: &quot;NF&#125;&#x27; /etc/passwd</span></span><br><span class="line"><span class="comment"># awk -F&quot;[ :]&quot; &#x27;&#123;print NF&#125;&#x27; /etc/passwd</span></span><br></pre></td></tr></table></figure>

<p>awk示例2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@shell ~]<span class="comment"># cat b.txt</span></span><br><span class="line">bgx xuliangwei:is a:good boy!</span><br><span class="line"></span><br><span class="line">[rootashel1 ~]<span class="comment"># awk &#x27;&#123;print NF&#125;&#x27; b.txt</span></span><br><span class="line">4</span><br><span class="line">[rootashell ~]<span class="comment"># awk -F &#x27;:&#x27; &#x27;&#123;print NF&#125;&#x27; b.txt</span></span><br><span class="line">3</span><br><span class="line">[rootashel1 ~]<span class="comment"># awk -F &quot;[ :]&quot; &#x27;&#123;print NF&#125;&#x27; b.txt</span></span><br><span class="line">6</span><br></pre></td></tr></table></figure>



<p><strong>Awk条件判断</strong></p>
<blockquote>
<p>if语句格式:{ if(表达式) {语句;语句;… } }</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//打印当前管理员用户名称</span><br><span class="line">[root@shell ~]<span class="comment"># awk -F: &#x27;&#123; if($3==0)&#123;print $1 &quot;is adminisitrator&quot;&#125; &#125;&#x27; /etc/passwd</span></span><br><span class="line">//统计系统用户数量</span><br><span class="line">[root@Shell ~]<span class="comment"># awk -F: &#x27;&#123; if($3&gt;0 &amp;&amp; $3&lt;1000)&#123;i++&#125;&#125; END &#123;print i&#125;&#x27; /etc/passwd</span></span><br><span class="line">//统计普通用户数量</span><br><span class="line">[root@shell ~]<span class="comment"># awk -F: &#x27;&#123; if($3&gt;1000)&#123;i++&#125;&#125; END &#123;print i&#125;&#x27; /etc/passwd</span></span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@oldboyedu shell09]<span class="comment"># awk -F &quot;:&quot; &#x27;&#123; if($3&gt;0 &amp;&amp; $3&lt;1000)&#123; print &quot;系统用户有哪些:&quot; $1 &quot;\t UID是: &quot; $3 &#125; &#125;&#x27; /etc/passwd</span></span><br><span class="line">[root@oldboyedu shell09]<span class="comment"># awk -F &quot;:&quot; &#x27;&#123; if($3&gt;1000)&#123; print &quot;普通用户有哪些:&quot; $1 &quot;\t UID是: &quot; $3 &#125; &#125;&#x27; /etc/passwd</span></span><br><span class="line">[root@oldboyedu shell09]<span class="comment"># awk -F &quot;:&quot; &#x27;&#123; if($3&gt;0 &amp;&amp; $3&lt;1000) &#123;i++&#125; &#125; END &#123;print &quot;系统用户总数是:&quot; i&#125;&#x27; /etc/passwd</span></span><br><span class="line">系统用户总数是：24</span><br><span class="line">[root@oldboyedu shell09]<span class="comment"># awk -F &quot;:&quot; &#x27;&#123; if($3&gt;1000) &#123;i++&#125; &#125; END &#123;print &quot;普通用户总数是:&quot; i&#125;&#x27; /etc/passwd</span></span><br><span class="line">普通用户总数是：69</span><br></pre></td></tr></table></figure>



<blockquote>
<p>if…else 语句格式: {if(表达式) {语句;语句;… } else{语句;语句;…}}</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># awk -F: &#x27;&#123;if($3==0)&#123;print $1&#125; else &#123;print $7&#125;&#125;&#x27; /etc/passwd</span></span><br><span class="line"><span class="comment"># awk -F: &#x27;&#123;if($3==0) &#123;count++&#125; else&#123;i++&#125; &#125;&#x27; /etc/passwd</span></span><br><span class="line"><span class="comment"># awk -F：&#x27;&#123;if($3==0)&#123;count++&#125; else&#123;i++&#125;&#125; END&#123;print &quot; 管理员个数: &quot;count ; print &quot; 系统用户数: &quot;i&#125;&#x27; /etc/passwd</span></span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@oldboyedu shell09]<span class="comment"># awk -F &quot;:&quot; &#x27;&#123;if($3==0) &#123;i++&#125; else &#123;j++&#125; &#125; END &#123;print &quot;管理员的个数是:&quot; i,&quot;普通用户的个数是:&quot; j &#125;&#x27; /etc/passwd</span></span><br></pre></td></tr></table></figure>



<p>if…else if…else 语句格式:</p>
<blockquote>
<p>{if(表达式1) {语句;语句; … } else if(表达式2) {语句;语句; … } else {语句;语句; …} }</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shell ~]<span class="comment"># awk -F: &#x27;&#123; if($3==0)&#123;i++&#125; else if($3&gt;0 &amp;&amp; $3&lt;1000)&#123;j++&#125; else if($3&gt;1000) &#123;k++&#125;&#125; END &#123;print i;print j;print k&#125;&#x27; /etc/passwd</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk -F: &#x27;&#123; if($3==0)&#123;i++&#125; else if($3&gt;0 &amp;&amp; $3&lt;1000)&#123;j++&#125; else if($3&gt;1000) &#123;k++&#125;&#125; END &#123;print &quot;管理员个数&quot;i; print &quot;系统用户个数&quot; j; print &quot;系统用户个数&quot; &#125;&#x27; /etc/passwd</span></span><br><span class="line">管理员个数1</span><br><span class="line">系统用户个数29</span><br><span class="line">系统用户个数69</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-4-centos shell]<span class="comment"># awk -F &quot;:&quot; &#x27;&#123; if($3==0) &#123;i++&#125; else if($3&gt;0 &amp;&amp; $3&lt;1000) &#123;j++&#125; else &#123;k++&#125; &#125; END &#123;print &quot;管理个数是: &quot;i &quot;\n&quot; &quot;系统用户个数是:&quot;j &quot;\n&quot; &quot;其它用户个数是:&quot; k&#125;&#x27; /etc/passwd</span></span><br><span class="line">管理个数是: 1系统用户个数是:27其它用户个数是:1</span><br><span class="line"></span><br><span class="line"><span class="comment">#统计nginx状态码</span></span><br><span class="line">[root@bgx logs]<span class="comment"># awk &#x27;&#123;if($10&gt;=0 &amp;&amp; $10&lt;=199) &#123;i++&#125; else if ($10&gt;=200 &amp;&amp; $10&lt;=299) &#123;j++&#125; else if($10&gt;=300 &amp;&amp; $10&lt;=399) &#123;k++&#125; else if ($10&gt;=400 &amp;&amp; $10&lt;=499) &#123;l++&#125; else &#123;m++&#125; &#125; END &#123;print &quot;0-199:&quot; i, &quot;\n&quot; &quot;200-299:&quot; j, &quot;\n&quot; &quot;300-399:&quot; k, &quot;\n&quot; &quot;400-499:&quot; l, &quot;\n&quot; &quot;500+:&quot; m&#125;&#x27; log.xuliangwei.log</span></span><br><span class="line"></span><br><span class="line">[root@bgx logs]<span class="comment"># awk &#x27;&#123;if($10&gt;=0 &amp;&amp; $10&lt;=199) &#123;i++&#125; else if ($10&gt;=200 &amp;&amp; $10&lt;=299) &#123;j++&#125; else if($10&gt;=300 &amp;&amp; $10&lt;=399) &#123;k++&#125; else if ($10&gt;=400 &amp;&amp; $10&lt;=499) &#123;l++&#125; else &#123;m++&#125; &#125; END &#123;print &quot;0-199:&quot; i &quot;\n&quot; &quot;200-299:&quot; j &quot;\n&quot; &quot;300-399:&quot; k &quot;\n&quot; &quot;400-499:&quot; l &quot;\n&quot; &quot;500+:&quot; m &quot;\n&quot; &quot;total:&quot; i+j+k+l+m&#125;&#x27; log.xuliangwei.log</span></span><br></pre></td></tr></table></figure>



<p><strong>Awk循环语句</strong></p>
<p>while循环</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@shell ~]<span class="comment"># awk &#x27;BEGIN&#123; i=1; while(i&lt;=10)&#123;print i; i++&#125; &#125;&#x27;</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk -F: &#x27;&#123;i=1; while(i&lt;=NF)&#123;print $i; i++&#125;&#125;&#x27; /etc/passwd</span></span><br><span class="line">[rootashell ~]<span class="comment"># awk -F: &#x27;&#123;i=1; while(i&lt;=10) &#123;print $0; i++&#125;&#125;&#x27; /etc/passwd</span></span><br><span class="line">[root@shell ~]<span class="comment"># cat b.txt</span></span><br><span class="line">111 222</span><br><span class="line">333 444 555</span><br><span class="line">666 777 888 999</span><br><span class="line">[root@shell ~]<span class="comment"># awk &#x27;&#123;i=1; while(i&lt;=NF)&#123;print $i; i++&#125;&#125;&#x27; b.txt</span></span><br></pre></td></tr></table></figure>

<p>for循环</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#C 风格for</span></span><br><span class="line">[root@Shell ~]<span class="comment"># awk &#x27;BEGIN&#123;for(i=1;i&lt;=5;i++)&#123;print i&#125; &#125;&#x27;</span></span><br><span class="line"><span class="comment">#将每行打印10次</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk -F: &#x27;&#123; for(i=1;i&lt;=10;i++) &#123;print $0&#125; &#125;&#x27; passwd</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk -F: &#x27;&#123; for(i=1;i&lt;=10;i++) &#123;print $0&#125; &#125;&#x27; passwd</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk -F: &#x27;&#123; for(i=1;i&lt;=NF;i++) &#123;print $i&#125; &#125;&#x27; passwd</span></span><br></pre></td></tr></table></figure>

<p>awk数组概述</p>
<blockquote>
<p>将需要统计的某个字段作为数组的索引，然后对索引进行遍历</p>
</blockquote>
<p>1.统计 <code>/etc/passwd</code> 中各种类型 <code>shell</code> 的数量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># awk -F: &#x27;[shells[$NF]++&#125; END&#123; hor(i in shel1s)[print i,shel1s[i]&#125; &#125;&#x27; /etc/passwd</span></span><br></pre></td></tr></table></figure>

<p>2.网站访问状态统计&lt;当前时实状态ss&gt;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@shell ~]<span class="comment"># ss -an|awk &#x27;/:80/&#123;tcp[$2]++&#125; END &#123;for(i in tcp)&#123;print i,tcp[i]&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>3.统计当前访问的每个P的数量&lt;当前时实状态netstat,ss&gt;</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@shell ~]<span class="comment"># ss -an|awk -F &#x27;:&#x27; &#x27;/:80/&#123;ips[$(NF-1)]++&#125; END &#123;for(i in ips)&#123;print i,ips[i]&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>Awk数组案例</strong></p>
<p><code>Nginx</code> 日志分析，日志格式如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">log_format main <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line">                    </span><br><span class="line">52.55.21.59 - - [25/Jan/2018:14:55:36 +0800] <span class="string">&quot;GET /feed/ HTTP/1.1&quot;</span> 404 162</span><br><span class="line"><span class="string">&quot;https://www.google.com/&quot;</span> <span class="string">&quot;Opera/9.80 (Macintosh; Intel Mac OS X 10.6.8; U; de)</span></span><br><span class="line"><span class="string">Presto/2.9.168 Version/11.52&quot;</span> <span class="string">&quot;-&quot;</span></span><br></pre></td></tr></table></figure>

<p>1.统计2018年01月25日，当天的PV量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@shell ~]<span class="comment"># grep &quot;25/Jan/2018&quot; log.bjstack.log |wc -l</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk &quot;/25/Jan\/2018/&quot; log.bjstack.log |wc -l</span></span><br><span class="line">[root@shell ~]<span class="comment"># awk &#x27;/25/Jan\/2018/ &#123;ips[$1]++&#125; END &#123;for(i in ips) &#123;sum+=ips[i]&#125; &#123;print sum&#125;&#125;&#x27; log.bjstack.log</span></span><br><span class="line">//统计15-19点的pv量</span><br><span class="line">[root@shell ~]<span class="comment"># awk &#x27;$4&gt;=&quot;[25/Jan/2018:15:00:00&quot; &amp;&amp; $4&lt;=&quot;[25/Jan/2018:19:00:00 &#123;print $0&#125;&quot;&#x27; log.bjstack.log |wc -l</span></span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">1.统计2018年09月28日，当天的PV量</span><br><span class="line">[root@oldboyedu opt]<span class="comment"># awk &#x27;/28\/Sep\/2018/&#x27; log_1.txt |wc -l</span></span><br><span class="line">4149</span><br><span class="line">[root@oldboyedu opt]<span class="comment">#echo &quot;当前PV量是：&quot; $(awk &#x27;/28\/Sep\/2018/&#x27; log_1.txt |wc -l)</span></span><br><span class="line">当前PV量是：4149</span><br><span class="line">[root@oldboyedu opt]<span class="comment"># awk &#x27;/28\/Sep\/2018/ &#123;i++&#125; END &#123;print &quot;2018年09月28日的PV量&quot;, i&#125;&#x27; log_1.txt</span></span><br><span class="line">2018年09月28日的PV量4149</span><br><span class="line"></span><br><span class="line">2.统计2018年09月28日，15-19点的pv量</span><br><span class="line">[root@oldboyedu opt]<span class="comment"># awk -F &quot;:&quot; &#x27;/28\/Sep\/2018/ &#123; if ($2&gt;=15 &amp;&amp; $2&lt;=19 ) &#123;i++&#125; &#125; END &#123; print &quot;2018年09月28日,15-19点的pv量是: &quot; i&#125;&#x27; log_1.txt</span></span><br><span class="line">2018年09月28日，15-19点的pv量是：1232</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.统计2018年09月28日，当天访问最多的10个IP（TOP10）</span><br><span class="line">[root@oldboyedu opt]<span class="comment"># awk &#x27;/28\/Sep\/2018/ &#123;print $1&#125;&#x27; log_1.txt|sort|uniq -c|sort -nr|head -10</span></span><br><span class="line">[root@oldboyedu opt]<span class="comment"># awk &#x27;/28\/Sep/2018/ &#123;ips[$1]++&#125; END &#123; for (i in ips) &#123; print ips[i],i&#125;&#125;&#x27; log_1.txt |sort -nr|head -10</span></span><br><span class="line"></span><br><span class="line">4.统计2018年09月28日，统计15-19点访问次数最多的10个IP</span><br><span class="line">[root@oldboyedu opt]<span class="comment"># awk -F &quot;[: ]&quot; &#x27;/28\/Sep\/2018/ &#123;if ($5&gt;=15 &amp;&amp; $5&lt;19 ) ips[$1]++ &#125; END &#123; for(i in ips) &#123;print ips[i],i&#125; &#125;&#x27; log_1.txt |sort -nr|head -10</span></span><br><span class="line"></span><br><span class="line">5.统计2018年09月28日，访问大于100次的IP</span><br><span class="line">[root@oldboyedu opt]<span class="comment"># awk &#x27;/28\/Sep\/2018/ &#123;ips[$1]++&#125; END &#123; for (i in ips) if(ips[i]&gt;100) &#123; print ips[i],i&#125;&#125;&#x27; log_1.txt</span></span><br><span class="line"></span><br><span class="line">6.统计2018年09月28日，访问最多的10个页面（<span class="variable">$request</span> top 10）</span><br><span class="line">[root@oldboyedu opt]<span class="comment"># awk &#x27;&#123;ips[$7]++&#125; END &#123; for (i in ips) &#123;print ips[i],i&#125;&#125;&#x27; log_1.txt |sort -rn|head -10</span></span><br><span class="line"></span><br><span class="line">7.统计2018年09月28日，访问状态码为404及出现的次数（<span class="variable">$status</span>）</span><br><span class="line">[root@oldboyedu opt]<span class="comment"># awk &#x27;$10 ~ 404 &amp;&amp; /28\/Sep\/2018/ &#123;i++&#125; END &#123;print i&#125;&#x27; log_1.txt</span></span><br><span class="line"></span><br><span class="line">8.统计2018年09月28日，8：30-9：00访问状态码是404</span><br><span class="line">[root@oldboyedu opt]<span class="comment"># awk &#x27;$10 ~ 404 &amp;&amp; $4&gt;=&quot;[28/Sep/2018:08:30:00&quot; &amp;&amp; $4&lt;=&quot;[28/Sep/2018:09:00:00&quot; &#123;i++&#125; END &#123;print i&#125;&#x27; log_1.txt</span></span><br><span class="line"></span><br><span class="line">9.统计2018年09月28日，每个IP访问状态码数量（<span class="variable">$status</span>）</span><br><span class="line">[root@oldboyedu opt]<span class="comment"># awk &#x27;&#123;ip_code[$1 &quot; &quot; $10]++&#125; END &#123;for(i in ip_code)&#123;print ip_code[i],i&#125;&#125;&#x27; log_1.txt</span></span><br><span class="line"></span><br><span class="line">10.统计日志中所有URL访问内容总大小(<span class="variable">$body_bytes_sent</span>)</span><br><span class="line">    URL    大小</span><br><span class="line">[root@oldboyedu opt]<span class="comment"># awk &#x27;&#123; url[$7]+=$11&#125; END &#123; for (i in url) &#123; print i,url[i]/1024/1024 &quot;m&quot;&#125; &#125;&#x27; log_1.txt |sort -rn -k2|head -5</span></span><br><span class="line"></span><br><span class="line">-----------------------</span><br><span class="line">1.awk基本代码</span><br><span class="line">2.awk工作流程</span><br><span class="line">3.awk字段分隔符</span><br><span class="line">4.awk内置变量  NF NR <span class="variable">$0</span> <span class="variable">$1</span> <span class="variable">$2</span> <span class="variable">$n</span>... FS OFS <span class="built_in">print</span> <span class="built_in">printf</span></span><br><span class="line">5.awk匹配模式</span><br><span class="line">    正则方式</span><br><span class="line">    表达式  x&lt;y  x&gt;y  x&gt;=y</span><br><span class="line">    判断语句    &#123; <span class="keyword">if</span> () <span class="keyword">else</span> <span class="function"><span class="title">if</span></span> () &#123;&#125; <span class="keyword">else</span> &#123;&#125; &#125;</span><br><span class="line">    循环语句    &#123; <span class="function"><span class="title">while</span></span> () &#123;&#125; &#125;  &#123; <span class="function"><span class="title">for</span></span> () &#123;&#125; &#125;</span><br><span class="line">6.awk的数组</span><br><span class="line">    你需要统计谁，就将谁作为索引进行赋值，然后让索引进行自增。END 最后进行遍历循环打印。</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line">老男孩教育网络课程大纲 P751</span><br><span class="line">1：网络的重要性：</span><br><span class="line">所有的操作系统都有网络！</span><br><span class="line">运维生涯50%的生产故障都是网络！</span><br><span class="line"></span><br><span class="line">2：教室这么多的电脑如何上网的？</span><br><span class="line"></span><br><span class="line">网卡（mac地址）</span><br><span class="line">有线（双绞线传播电信号）双向，同时收发</span><br><span class="line">无线（无线电波）  发的时候，不能收</span><br><span class="line"></span><br><span class="line">交换（扩充网线插槽，让更多的人，在同一个局域网共享上网）</span><br><span class="line">傻瓜交换机（tplink/dlink/水星..。）</span><br><span class="line">程控交换机（配置管理，可控 思科、华为、华三、锐捷）</span><br><span class="line"></span><br><span class="line">路由（双网卡）</span><br><span class="line">内网卡…交换机  192.168.16.0/24(192.168.16.1~192.168.16.254)</span><br><span class="line">外网卡--运营商  122.71.64.2（铁通）</span><br><span class="line"></span><br><span class="line">查公网ip的方法：</span><br><span class="line">windows，打开浏览器，访问百度，搜IP即可</span><br><span class="line">linux: curl ifconfig.me</span><br><span class="line"></span><br><span class="line">扩展：高级路由器还有上网行为管理器和防火墙功能哦</span><br><span class="line">10Mbps==1.25MB 1.1M</span><br><span class="line">100Mbps == 12MB 300KB/s 50KB/S</span><br><span class="line"></span><br><span class="line">论坛：鸿鹄论坛（网络工程师）</span><br><span class="line">CCNA 入门</span><br><span class="line">CCNP 广度</span><br><span class="line">CCIE 深度</span><br><span class="line"></span><br><span class="line">HCIA</span><br><span class="line">HCIP</span><br><span class="line">HCIE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3：osi 7层模型</span><br><span class="line">分层的作用：复用</span><br><span class="line"></span><br><span class="line">手机生产厂商：组装</span><br><span class="line"></span><br><span class="line">网络工程师：</span><br><span class="line">物理层    1层，通信介质的信号到数字信号（二进制0101）</span><br><span class="line">数据链接层    2层局域网之间计算机通信  通过mac地址通信  arp协议</span><br><span class="line">网络层     3层IP地址，路由（通过网络访问全世界）</span><br><span class="line">公网的ip地址相当于门牌号（全世界网络互连）：</span><br><span class="line">私网的ip地址相当于房间号（局域网内部网络互连）</span><br><span class="line"></span><br><span class="line">传输层  4层 tcp/udp  tcp（可靠，速度慢） udp（不可靠，速度快） 端口（让不同的应用程序，同时使用网络）</span><br><span class="line"></span><br><span class="line">开发：</span><br><span class="line">会话层    5层  控制发包的数据，会话层控制传输层，建议三次握手</span><br><span class="line">表示层    6层  文件格式</span><br><span class="line">应用层    7层  应用程序使用</span><br><span class="line"></span><br><span class="line">对运维来说，重中之重的协议：tcp协议</span><br><span class="line"></span><br><span class="line">4：tcp/ip协议 5层</span><br><span class="line">物理层</span><br><span class="line">数据链接层</span><br><span class="line">网络层</span><br><span class="line">传输层</span><br><span class="line">应用层</span><br><span class="line"></span><br><span class="line">一个数据包：传输控制层面只占一部分，数据才占用大部分！</span><br><span class="line"></span><br><span class="line">5：数据封装，解封装，数据传输过程</span><br><span class="line"></span><br><span class="line">最重要的协议协议：</span><br><span class="line">6：tcp三次握手，四次挥手</span><br><span class="line"></span><br><span class="line">开始传输数据之前需要： tcp的三次握手</span><br><span class="line">手写一遍。</span><br><span class="line"></span><br><span class="line">数据传输结束的时候需要： tcp的四次挥手</span><br><span class="line"></span><br><span class="line">tcp的数据传输过程：</span><br><span class="line">SYN表示建立连接，</span><br><span class="line">FIN表示关闭连接，</span><br><span class="line">ACK表示响应，</span><br><span class="line">PSH表示有 DATA数据传输，</span><br><span class="line">URG表示紧急指针</span><br><span class="line">RST表示连接重置。</span><br><span class="line"></span><br><span class="line">dos denice of service</span><br><span class="line">ddos攻击，利用tcp的可靠性</span><br><span class="line"></span><br><span class="line">zabbix 监控tcp的11种状态,重点监控syn_recd</span><br><span class="line"></span><br><span class="line">7：ip地址划分</span><br><span class="line">仕么是二进制？</span><br><span class="line">10进制</span><br><span class="line">0-9</span><br><span class="line">10</span><br><span class="line"></span><br><span class="line">2进制</span><br><span class="line">0-1</span><br><span class="line">10进制的10=1010，1x2^3+0x2^2+1x2^1+0x2^0</span><br><span class="line"></span><br><span class="line">实际上是32位二进制数（01100100.00000100.00000101.00000110）100.4.5.6</span><br><span class="line">0.0.0.0~255.255.255.255</span><br><span class="line">256*256*256*256==65536*65536=60000*60000=43亿</span><br><span class="line"></span><br><span class="line">fe80:fe80:20c:29ff:fe6d:8ed3</span><br><span class="line"></span><br><span class="line">ipv4,ipv6  NAT  ip地址转换，划分一部地址作为私网地址，剩下就是公网</span><br><span class="line"></span><br><span class="line">a类 1.0.0.1~126.255.255.254</span><br><span class="line">第一组：1-126开头的地址是A类</span><br><span class="line">  0&lt;A类&lt;127    128</span><br><span class="line"></span><br><span class="line">127.0.0.1-127.255.255.255 本地回环地址</span><br><span class="line"></span><br><span class="line">b类 128.0.0.1～191.255.255.254</span><br><span class="line">  128&lt;=B类&lt;192    64</span><br><span class="line">  </span><br><span class="line">c类 192.0.0.1~223.255.255.254</span><br><span class="line"></span><br><span class="line">d类 组播 keepalived高可用，yrrp协议用的就是组播地址</span><br><span class="line">e类 科研</span><br><span class="line"></span><br><span class="line">私有ip地址范围：</span><br><span class="line">局域网地址：</span><br><span class="line">A 10.0.0.0~10.255.255.255</span><br><span class="line">65536*256==</span><br><span class="line"></span><br><span class="line">B 172.16.0.0~172.31.255.255</span><br><span class="line">65536*16</span><br><span class="line"></span><br><span class="line">C 192.168.0.0~192.168.255.255</span><br><span class="line">65536</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tcpdump -i eth0 tcp port 80 -c 10 -S</span><br><span class="line"></span><br><span class="line">tcpdump抓的包，wireshark分析</span><br><span class="line">找同学给我发送一个用tcpdump，ssh协议的三次握手包文件xxx.cap</span><br><span class="line"></span><br><span class="line">12：linux的网络命令</span><br><span class="line">[root@edu ~]# cat /etc/sysconfig/network-scripts/ifcfg-eth0</span><br><span class="line">TYPE=&quot;Ethernet&quot;</span><br><span class="line">PROXY_METHOD=&quot;none&quot;</span><br><span class="line">BROWSER_ONLY=&quot;no&quot;</span><br><span class="line">B00TPROTO=&quot;dhcp&quot;</span><br><span class="line">DEFROUTE=&quot;yes&quot;</span><br><span class="line">IPV4_FAILURE_FATAL=&quot;no&quot;</span><br><span class="line">IPV6INIT=&quot;yes&quot;</span><br><span class="line">IPV6_AUTOCONF=&quot;yes&quot;</span><br><span class="line">IPV6_DEFROUTE=&quot;yes&quot;</span><br><span class="line">IPV6_FAILURE_FATAL=&quot;no&quot;</span><br><span class="line">IPV6_ADDR_GEN_MODE=&quot;stable-privacy&quot;</span><br><span class="line">NAME=&quot;ethO&quot;</span><br><span class="line">UUID=&quot;fb32c09d-5a9f-40b9-852b-0f44ff2202ed&quot;</span><br><span class="line">DEVICE=&quot;ethO&quot;</span><br><span class="line">ONB00T=&quot;yes&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@edu ~]# cat /etc/sysconfig/network-scripts/ifcfg-eth0</span><br><span class="line">TYPE=&quot;Ethernet&quot;    #网络的类型</span><br><span class="line">BOOTPROTO=&quot;static&quot;    #获取ip的方式dhcp，手动</span><br><span class="line">NAME=&quot;eth0&quot;    #网卡名称</span><br><span class="line">DEVICE=&quot;eth0&quot;    #设备名称</span><br><span class="line">ONB00T=&quot;yes&quot;    #开机启动网络连接</span><br><span class="line">IPADDR=&quot;192.168.11.88&quot;    #ip地址</span><br><span class="line">NETMASK=&quot;255.255.255.0&quot;    #子网掩码</span><br><span class="line">GATEWAY=&quot;192.168.11.1&quot;    #网关</span><br><span class="line">DNS1=&quot;223.5.5.5&quot;    #dns1</span><br><span class="line">DNS2=&quot;223.6.6.6&quot;    #dns2</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>05-静态路由1</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220421114543429.png" alt="image-20220421114543429"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-4-centos ~]<span class="comment"># route add -net 172.16.0.0/24 gw 10.0.0.12    #添加临时静态路由（重启网络服务失效）</span></span><br><span class="line"></span><br><span class="line">[root@VM-20-4-centos ~]<span class="comment"># sysctl net.ipv4.ip_forward = 1    #开启临时路由内核转发（重启网络服务失效）</span></span><br><span class="line"></span><br><span class="line">[root@VM-20-4-centos ~]<span class="comment"># route add -net 10.0.0.0/24 gw 172.16.0.12</span></span><br><span class="line"></span><br><span class="line">[root@VM-20-4-centos ~]<span class="comment"># tcpdump -i eth0 icmp    #抓包</span></span><br></pre></td></tr></table></figure>

<p>06-静态路由2</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220421210401125.png" alt="image-20220421210401125"></p>
<p>07-静态路由3</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-4-centos ~]<span class="comment"># ip route    #查看路由表</span></span><br><span class="line">172.16.0.0/24 via 10.0.0.12 dev eth0</span><br><span class="line">172.16.1.0/24 via 10.0.0.12 dev eth0</span><br><span class="line">[root@VM-20-4-centos ~]<span class="comment"># vim /etc/sysconfig/network-scripts/route-eth0    #添加路由表永久生效</span></span><br><span class="line">172.16.0.0/24 via 10.0.0.12 dev eth0</span><br><span class="line">172.16.1.0/24 via 10.0.0.12 dev eth0</span><br><span class="line"></span><br><span class="line">[root@VM-20-4-centos ~]<span class="comment"># sysctl -a|grep &#x27;net.ipv4&#x27;|grep &#x27;forward&#x27;</span></span><br><span class="line">net.ipv4.ip_forward = 0</span><br><span class="line">[root@VM-20-4-centos ~]<span class="comment"># vim /etc/sysctl.conf    #开启路由内核转发永久生效</span></span><br><span class="line">net.ipv4.ip_forward=1    <span class="comment">#末尾添加</span></span><br><span class="line">[root@VM-20-4-centos ~]<span class="comment"># sysctl -p    #立即生效</span></span><br></pre></td></tr></table></figure>







<p>部署openvpn</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-4-centos ~]<span class="comment"># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span></span><br><span class="line">[root@VM-20-4-centos ~]<span class="comment"># yum install -y openvpn</span></span><br><span class="line">[root@VM-20-4-centos ~]<span class="comment"># wget https://github.com/OpenVPN/easy-rsa/releases/download/2.2.2/EasyRSA-2.2.2.tgz</span></span><br><span class="line">[root@VM-20-4-centos ~]<span class="comment"># tar xf EasyRSA-2.2.2.tgz</span></span><br><span class="line">[root@VM-20-4-centos ~]<span class="comment"># mkdir /etc/openvpn/easy-rsa</span></span><br><span class="line">[root@VM-20-4-centos ~]<span class="comment"># ls /etc/openvpn/</span></span><br><span class="line">[root@VM-20-4-centos ~]<span class="comment"># cp -ap EasyRSA-2.2.2/* /etc/openvpn/easy-rsa/</span></span><br><span class="line">[root@VM-20-4-centos ~]<span class="comment"># vim /etc/openvpn/easy-rsa/vars</span></span><br><span class="line"><span class="built_in">export</span> KEY_COUNTRY=<span class="string">&quot;CN&quot;</span></span><br><span class="line"><span class="built_in">export</span> KEY_PROVINCE=<span class="string">&quot;SH&quot;</span></span><br><span class="line"><span class="built_in">export</span> KEY_CITY=<span class="string">&quot;PUDONG&quot;</span></span><br><span class="line"><span class="built_in">export</span> KEY_ORG=<span class="string">&quot;oldboyedu linux&quot;</span></span><br><span class="line"><span class="built_in">export</span> KEY_EMAIL=<span class="string">&quot;123@qq.com&quot;</span></span><br><span class="line"><span class="built_in">export</span> KEY_OU=<span class="string">&quot;linux&quot;</span></span><br><span class="line"><span class="built_in">export</span> KEY_NAME=<span class="string">&quot;oldboy&quot;</span></span><br><span class="line"><span class="built_in">export</span> KEY_CN=<span class="string">&quot;oldboy&quot;</span></span><br><span class="line">[root@VM-20-4-centos ~]<span class="comment"># cd /etc/openvpn/easy-rsa/vars</span></span><br><span class="line">[root@VM-20-4-centos easy-rsa]<span class="comment"># source vars</span></span><br><span class="line">[root@VM-20-4-centos easy-rsa]<span class="comment"># ./clean-all</span></span><br><span class="line">[root@VM-20-4-centos easy-rsa]<span class="comment"># ./build-ca    #生成CA证书</span></span><br><span class="line">[root@VM-20-4-centos easy-rsa]<span class="comment"># ls keys/</span></span><br><span class="line">[root@VM-20-4-centos easy-rsa]<span class="comment"># ./build-key-server server    #生成服务端证书</span></span><br><span class="line">[root@VM-20-4-centos easy-rsa]<span class="comment"># ls keys/</span></span><br><span class="line">[root@VM-20-4-centos easy-rsa]<span class="comment"># ./build-dh    #生成交换文件</span></span><br><span class="line">[root@VM-20-4-centos easy-rsa]<span class="comment"># ls keys/</span></span><br><span class="line">[root@VM-20-4-centos easy-rsa]<span class="comment"># ./build-key oldboy    #生成客户端证书</span></span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-20-4-centos easy-rsa]<span class="comment"># vim /etc/openvpn/server.conf</span></span><br><span class="line"></span><br><span class="line">port 1194</span><br><span class="line"></span><br><span class="line">proto tcp</span><br><span class="line"></span><br><span class="line">dev tun</span><br><span class="line"></span><br><span class="line">ca /etc/openvpn/easy-rsa/keys/ca.crt</span><br><span class="line"></span><br><span class="line">cert /etc/openvpn/easy-rsa/keys/server.crt</span><br><span class="line"></span><br><span class="line">key /etc/openvpn/easy-rsa/keys/server.key <span class="comment"># This file should be kept secret</span></span><br><span class="line"></span><br><span class="line">dh /etc/openvpn/easy-rsa/keys/dh2048.pem</span><br><span class="line"></span><br><span class="line">server 10.8.0.0 255.255.255.0</span><br><span class="line"></span><br><span class="line"><span class="comment">#push &quot;route 172.16.0.0 255.255.255.0&quot;    #给客户端推送一条路由</span></span><br><span class="line"></span><br><span class="line">ifconfig-pool-persist ipp.txt</span><br><span class="line"></span><br><span class="line">keepalive 10 120    <span class="comment">#保持长连接</span></span><br><span class="line"></span><br><span class="line">comp-lzo    <span class="comment">#启用压缩</span></span><br><span class="line"></span><br><span class="line">persist-key</span><br><span class="line"></span><br><span class="line">persist-tun</span><br><span class="line"></span><br><span class="line">status openvpn-status.log    <span class="comment">#记录openvpn日志</span></span><br><span class="line"></span><br><span class="line">verb 3</span><br><span class="line"></span><br><span class="line">client-to-client    <span class="comment">#客户端点到点</span></span><br><span class="line"></span><br><span class="line">duplicate-cn</span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span> /var/log/openvpn.log</span><br><span class="line"></span><br><span class="line">[root@VM-20-4-centos easy-rsa]<span class="comment"># openvpn --config /etc/openvpn/server.conf &amp;    #加&amp; 后台运行</span></span><br><span class="line">[root@VM-20-4-centos ~]<span class="comment"># mkdir openvpn-client</span></span><br><span class="line">[root@VM-20-4-centos ~]<span class="comment"># cd openvpn-client</span></span><br><span class="line">[root@VM-20-4-centos openvpn-client]<span class="comment"># cp /etc/openvpn/easy-rsa/keys/ca.* .</span></span><br><span class="line">[root@VM-20-4-centos openvpn-client]<span class="comment"># cp /etc/openvpn/easy-rsa/keys/oldboy.* .</span></span><br><span class="line">[root@VM-20-4-centos openvpn-client]<span class="comment"># rm -fr oldboy.csr</span></span><br><span class="line">[root@VM-20-4-centos openvpn-client]<span class="comment"># vim oldboy.ovpn</span></span><br><span class="line">ns-cert-type server</span><br><span class="line"></span><br><span class="line">client</span><br><span class="line"></span><br><span class="line">dev tun</span><br><span class="line"></span><br><span class="line">proto tcp</span><br><span class="line"></span><br><span class="line">remote 10.0.0.12 1194</span><br><span class="line"></span><br><span class="line">resolv-retry infinite</span><br><span class="line"></span><br><span class="line">nobind</span><br><span class="line"></span><br><span class="line">persist-key</span><br><span class="line"></span><br><span class="line">persist-tun</span><br><span class="line"></span><br><span class="line">ca ca.crt</span><br><span class="line"></span><br><span class="line">cert oldboy.crt</span><br><span class="line"></span><br><span class="line">key oldboy.key</span><br><span class="line"></span><br><span class="line">ns-cert-type server</span><br><span class="line"></span><br><span class="line">comp-lzo</span><br><span class="line"></span><br><span class="line">verb 3</span><br><span class="line">[root@VM-20-4-centos openvpn-client]<span class="comment"># sz *    #文件拷贝到Windows</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Windows下载OpenVPN，把拷贝下来的文件剪切到OpenVPN/config目录下</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@VM-20-4-centos openvpn-client]<span class="comment"># vim /etc/openvpn/server.conf</span></span><br><span class="line">push <span class="string">&quot;route 172.16.0.0 255.255.255.0&quot;</span>    <span class="comment">#取消注释</span></span><br><span class="line">[root@VM-20-4-centos openvpn-client]<span class="comment"># netstat -lntup</span></span><br><span class="line">[root@VM-20-4-centos openvpn-client]<span class="comment"># kill 1709</span></span><br><span class="line">[root@VM-20-4-centos openvpn-client]<span class="comment"># openvpn --config /etc/openvpn/server.conf &amp;</span></span><br><span class="line">[root@VM-20-4-centos openvpn-client]<span class="comment"># tcpdump -i tun0 icmp -nn</span></span><br><span class="line"></span><br><span class="line">测试内网机器需添加一条静态路由</span><br><span class="line">[root@network03 ~]<span class="comment"># route add -net 10.8.0.0/24 gw 172.16.0.12</span></span><br><span class="line"></span><br><span class="line">添加静态路由比较鸡肋，使用NAT地址转换</span><br><span class="line">[root@VM-20-4-centos openvpn-client]<span class="comment"># iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth1 -j SNAT --to-source 172.16.0.12</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>简洁版</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">openvpn安装服务端：</span><br><span class="line">yum install openvpn -y</span><br><span class="line">wget https://github.com/OpenVPN/easy-rsa/releases/download/2.2.2/EasyRSA-2.2.2.tgz</span><br><span class="line">tar xf EasyRSA-2.2.2.tgz</span><br><span class="line"><span class="built_in">mkdir</span> /etc/openvpn/easy-rsa</span><br><span class="line"><span class="built_in">cp</span> -ap EasyRSA-2.2.2/* /etc/openvpn/easy-rsa/</span><br><span class="line"><span class="built_in">cd</span> /etc/openvpn/easy-rsa/</span><br><span class="line">vim vars</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> vars</span><br><span class="line">./clean-all</span><br><span class="line">./build-ca</span><br><span class="line">./build-key-server server</span><br><span class="line">./build-dh</span><br><span class="line">./build-key oldboy</span><br><span class="line"></span><br><span class="line">vim /etc/openvpn/server.conf</span><br><span class="line"></span><br><span class="line">openvpn --config /etc/openvpn/server.conf &amp;</span><br></pre></td></tr></table></figure>



<p><strong>csr、crt和key的关系</strong></p>
<p><strong>openssl生成证书server.key server.crt</strong></p>
<p>Key是私用秘钥，通常是RSA算法</p>
<p>Csr是证书请求件，用于申请证书。在制作csr文件时，必须使用自己的私钥来签署申，还可以设定一个密钥。</p>
<p>crt是CA认证后的证书文，签署人用自己的key给你签署凭证。</p>
<p><strong>key的生成</strong></p>
<p>openssl genrsa -out server.key 2048</p>
<p>这样是生成RSA密钥，openssl格式，2048位强度。server.key是密钥文件名。</p>
<p><strong>csr的生成</strong></p>
<p>openssl req -new -key server.key -out server.csr,需要依次输入国家,地区,组织,email。最重要的是有一个common name,可以写你的名字或者域名。如果为了https申请，这个必须和域名吻合，否则会引发浏览器警报。生成的csr文件讲给CA签名后形成服务端自己的证书。</p>
<p><strong>crt的生成</strong></p>
<p>openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt</p>
<p>生成的server.crt文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">15:使用iptables实现nat上网</span><br><span class="line">netwokr02 有外网,2个网卡</span><br><span class="line">network03 使用network02的内网ip做网关</span><br><span class="line"></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">network02添加NAT转换规则</span><br><span class="line">iptables -t nat -A POSTROUTING -s 172.16.0.0/24 -j MASQUERADE</span><br><span class="line"></span><br><span class="line">网络故障的排查思路：</span><br><span class="line">从小到大</span><br><span class="line"></span><br><span class="line">openvpn:</span><br><span class="line">vpn：虚拟网络隧道</span><br><span class="line"></span><br><span class="line">iptables和firewalld的区别</span><br><span class="line"></span><br><span class="line">内核Netfilter</span><br><span class="line"></span><br><span class="line">iptables 工具 cmd</span><br><span class="line">iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth1 -j SNAT --to-source 172.16.0.12</span><br><span class="line"></span><br><span class="line">iptables</span><br><span class="line">firewalld 工具 cmd,gui</span><br><span class="line"></span><br><span class="line">服务，启动的时候，加载firewalld规则，关闭的时候，保存firewalld规则</span><br><span class="line"></span><br><span class="line">iptables的五链</span><br><span class="line">PREROUTING</span><br><span class="line">INPUT</span><br><span class="line">FORWARD</span><br><span class="line">OUTPUT</span><br><span class="line"></span><br><span class="line">[root@VM-20-4-centos openvpn-client]# iptables -L -n</span><br><span class="line">[root@network02 openvpn-client]# iptables -P FORWARD DROP</span><br><span class="line">[root@network02 openvpn-client]# iptables -P FORWARD ACCEPT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">iptables的四表：</span><br><span class="line">filter    过滤</span><br><span class="line">NAT    地址转换</span><br><span class="line">mango    修改数据包的，ttl</span><br><span class="line">raw    追踪数据包</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">filter 表:</span><br><span class="line">INPUT</span><br><span class="line">FORWARD</span><br><span class="line">OUTPUT</span><br><span class="line"></span><br><span class="line">放开80端口和22端口，其他全拒绝</span><br><span class="line">iptables -A INPUT -p tcp --dport 22 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp --dport 80 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp --dport 1194 -j ACCEPT</span><br><span class="line">iptables -P INPUT DROP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NAT表转换</span><br><span class="line">PREROUTING</span><br><span class="line">INPUT</span><br><span class="line">OUTPUT</span><br><span class="line">POSTROUTING</span><br><span class="line"></span><br><span class="line">[root@network02 openvpn-client]# iptables -t nat -L -n</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220422162115280.png" alt="image-20220422162115280"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">16: 把linux变成路由器（iptables + dhcp服务）</span><br><span class="line"></span><br><span class="line">dhcp分配信息包括：</span><br><span class="line">ip地址</span><br><span class="line">子网掩码</span><br><span class="line">网关</span><br><span class="line">dns</span><br><span class="line"></span><br><span class="line">dhcp服务安装：</span><br><span class="line">yum install dhcp -y</span><br><span class="line"></span><br><span class="line">vim /etc/dhcp/dhcpd.conf</span><br><span class="line"></span><br><span class="line">subnet 192.168.0.0 netmask 255.255.255.0 &#123;    #192.168.0.0网络号，255.255.255.0子网掩码</span><br><span class="line">  range 192.168.0.26 192.168.0.200;    #ip地址分配范围</span><br><span class="line">  option domain-name-servers 180.76.76.76;    #指定给客户端分配的dns地址</span><br><span class="line">  option routers 192.168.0.12;    #指定给客户端分配的网关ip</span><br><span class="line">  option broadcast-address 192.168.0.255;    #指定广播地址</span><br><span class="line">  default-lease-time 600;    #dhcp默认租约时间</span><br><span class="line">  max-lease-time 7200;    #dhcp最长租约时间</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">systemctl start dhcpd</span><br><span class="line">systemctl enable dhcpd</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">17：实现多层端口映射</span><br><span class="line">増加规则</span><br><span class="line">iptables -t nat -A PREROUTING -d 10.0.0.12 -p tcp --dport 3022 -j DNAT --to-destination 172.16.0.13:22</span><br><span class="line">iptables -t nat -D PREROUTING -d 10.0.0.12 -p tcp --dport 3022 -j DNAT --to-destination 172.16.0.13:22</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">18:上网行为管理器panabit（unix)</span><br><span class="line">panabit 使用freebsd系统</span><br></pre></td></tr></table></figure>





<p><strong>openstack_zhizou P771</strong></p>
<p>安装系统界面，设置默认网卡为eth0</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220422230922209.png" alt="image-20220422230922209"></p>
<p>tab键 末尾添加 <code>net.ifnames=0 biosdevname=0</code> 然后回车</p>
<p>1.1 修改网卡配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@oldboy ~]# vi /etc/sysconfig/network-scripts/ifcfg-eth0</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">B00TPROTO=none    #取消dhcp</span><br><span class="line">NAME=eth0</span><br><span class="line">DEVICE=eth0</span><br><span class="line">ONB00T=yes    #设置开机启动</span><br><span class="line">IPADDR=10.0.0.11    #IP地址</span><br><span class="line">NETMASK=255.255.255.0    #子网掩码</span><br><span class="line">GATEWAY=10.0.0.254    #网关</span><br><span class="line">DNS1=223.5.5.5    #DNS</span><br><span class="line">[root@oldboy ~]# systemctl restart network</span><br></pre></td></tr></table></figure>

<p>1.2 防火墙的优化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@oldboy ~]<span class="comment"># systemctl stop firewalld</span></span><br><span class="line">[root@oldboy ~]<span class="comment"># systemctl disable firewalld</span></span><br></pre></td></tr></table></figure>

<p>1.3 Selinux的优化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@oldboy ~]<span class="comment"># setenforce 0</span></span><br><span class="line">[root@oldboy ~]<span class="comment"># getenforce</span></span><br><span class="line">Permissive</span><br><span class="line">[root@oldboy ~]<span class="comment"># vi /etc/selinux/config</span></span><br><span class="line">SELINUX=disabled</span><br></pre></td></tr></table></figure>

<p>1.4 ssh的优化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@oldboy ~]<span class="comment"># vi /etc/ssh/sshd_config</span></span><br><span class="line">GSSAPIAuthentication no    <span class="comment">#改成no</span></span><br><span class="line">UseDNS no    <span class="comment">#删除注释</span></span><br><span class="line">[root@oldboy ~]<span class="comment"># systemctl restart sshd</span></span><br></pre></td></tr></table></figure>

<p>1.5 hosts的优化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@oldboy ~]<span class="comment"># vi /etc/hosts</span></span><br><span class="line"><span class="comment">#增加2行</span></span><br><span class="line">10.0.0.11    controller</span><br><span class="line">10.0.0.31    computel</span><br></pre></td></tr></table></figure>

<p>1.7 yum源优化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用光盘搭建本地yum源</span></span><br><span class="line">[root@oldboy ~]<span class="comment"># umount /mnt</span></span><br><span class="line">[root@oldboy ~]<span class="comment"># cd /etc/yum.repos.d/</span></span><br><span class="line">[root@oldboy ~]<span class="comment"># mkdir test -p</span></span><br><span class="line">[root@oldboy ~]<span class="comment"># \mv *.repo test</span></span><br><span class="line">[root@oldboy ~]<span class="comment"># echo &#x27;[local]</span></span><br><span class="line">[root@oldboy ~]<span class="comment"># name=local</span></span><br><span class="line">[root@oldboy ~]<span class="comment"># baseurl=file:///mnt</span></span><br><span class="line">[root@oldboy ~]<span class="comment"># gpgcheck=0&#x27;&gt;local.repo</span></span><br><span class="line">[root@oldboy ~]<span class="comment"># mount /dev/cdrom/mnt</span></span><br><span class="line">[root@oldboy ~]<span class="comment"># yum makecache</span></span><br></pre></td></tr></table></figure>

<p>1.8 其他优化</p>
<p>#关闭邮件服务#</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop postfix.service</span><br><span class="line">systemctl <span class="built_in">disable</span> postfix.service</span><br></pre></td></tr></table></figure>

<p>#关闭网卡图形化设置模式#</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop NetworkManager.service </span><br><span class="line">systemctl <span class="built_in">disable</span> NetworkManager.service</span><br></pre></td></tr></table></figure>

<p>#下载tab补全命令#</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y bash-completion.noarch</span><br></pre></td></tr></table></figure>

<p>#下载常用命令#</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y net-tools vim lrzsz wget tree screen lsof tcpdump</span><br></pre></td></tr></table></figure>

<p>#至此；模板机优化完成；关机开始克隆#</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shutdown -h nowe</span><br></pre></td></tr></table></figure>



<h2 id="01-容器简介和虚拟化的区别"><a href="#01-容器简介和虚拟化的区别" class="headerlink" title="01-容器简介和虚拟化的区别"></a>01-容器简介和虚拟化的区别</h2><p><strong>docker课程大纲</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line">docker容器</span><br><span class="line">1：什么是容器？</span><br><span class="line">容器就是在隔离的环境运行的一个进程，如果进程停止，容器就会销毁。隔离的环境拥有自己的系统文件，ip地址，主机名等</span><br><span class="line"></span><br><span class="line">kvm虚拟机，linux,系统文件</span><br><span class="line"></span><br><span class="line">程序：代码，命令</span><br><span class="line">进程：正在运行的程序</span><br><span class="line"></span><br><span class="line">2：容器和虚拟化的区别</span><br><span class="line">linux容器技术，容器虚拟化和kvm虚拟化的区别</span><br><span class="line">kvm虚拟化：需要硬件的支持，需要模拟硬件，可以运行不同的操作系统，启动时间分钟级（开机启动流程）</span><br><span class="line"></span><br><span class="line">1inux开机启动流程：</span><br><span class="line">bios开机硬件自检</span><br><span class="line">根据bios设置的优先启动项boot  网卡 硬盘 u盘 光驱</span><br><span class="line">读取mbr引导 2T UEFI（gpt分区）  mbr硬盘分区信息，内核加载路径</span><br><span class="line">加载内核</span><br><span class="line">启动第一个进程init systemd</span><br><span class="line">系统初始化完成</span><br><span class="line">运行服务</span><br><span class="line">。。。</span><br><span class="line"></span><br><span class="line">容器启动流程：</span><br><span class="line">共用宿主机内核：</span><br><span class="line">第一个进程,服务nginx,httpd,mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">容器：共用宿主机内核，容器的第一个进程直接运行服务，损耗少，启动快，性能高</span><br><span class="line"></span><br><span class="line">容器虚拟化：不需要硬件的支持。不需要模拟硬件，共用宿主机的内核，启动时间秒级（没有开机启动流程）</span><br><span class="line"></span><br><span class="line">总结：</span><br><span class="line">（1）与宿主机使用同一个内核，性能损耗小；</span><br><span class="line">（2）不需要指令级模拟；</span><br><span class="line">（3）容器可以在CPU核心的本地运行指令，不需要任何专门的解释机制；</span><br><span class="line">（4）避免了准虚拟化和系统调用替换中的复杂性；</span><br><span class="line">（5）轻量级隔离，在隔离的同时还提供共享机制，以实现容器与宿主机的资源共享。</span><br><span class="line"></span><br><span class="line">3：容器技术的发展过程：</span><br><span class="line">1）：chroot技术，新建一个子系统（拥有自己完整的系统文件）</span><br><span class="line">参考资料：https://www.ibm.com/developerworks/cn/linux/l-cn-chroot/</span><br><span class="line">chang root</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">作业1：使用chroot监狱限制SSH用户访问指定目录和使用指定命令</span><br><span class="line">https://linux.cn/article-8313-1.html</span><br><span class="line">ls</span><br><span class="line"></span><br><span class="line">2)：linux容器（lxc) linux container(namespaces 命名空间 隔离环境 及cgroups 资源限制)</span><br><span class="line"></span><br><span class="line">cgroups 限制一个进程能够使用的资源。cpu，内存，硬盘io</span><br><span class="line">kvm虚拟机：资源限制（1c 1G 20G)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#需要使用epel源</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装epel源</span></span><br><span class="line">yum install epel-release -y</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">编译epel源配置文件</span></span><br><span class="line">vi /etc/yum.repos.d/epel.repo</span><br><span class="line">[epel]</span><br><span class="line">name=Extra Packages for Enterprise Linux 7 - $basearch</span><br><span class="line">baseurl=https://mirrors.tuna.tsinghua.edu.cn/epel/7/$basearch</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-7&amp;<span class="built_in">arch</span>=<span class="variable">$basearch</span></span></span><br><span class="line">failovermethod=priority</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7</span><br><span class="line"></span><br><span class="line">[epel-debuginfo]</span><br><span class="line">name=Extra Packages for Enterprise Linux 7 - $basearch - Debug</span><br><span class="line">baseurl=https://mirrors.tuna.tsinghua.edu.cn/epel/7/$basearch/debug</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-debug-7&amp;<span class="built_in">arch</span>=<span class="variable">$basearcl</span></span></span><br><span class="line">failovermethod=priority</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7</span><br><span class="line">gpgcheck=1</span><br><span class="line"></span><br><span class="line">[epel-source]</span><br><span class="line">name=Extra Packages for Enterprise Linux 7 - $basearch - Source</span><br><span class="line">baseurl=https://mirrors.tuna.tsinghua.edu.cn/epel/7/SRPMS</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-source-7&amp;<span class="built_in">arch</span>=<span class="variable">$basearc</span></span></span><br><span class="line">failovermethod=priority</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7</span><br><span class="line">gpgcheck=1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#安装lxc</span></span></span><br><span class="line">yum install lxc-* -y</span><br><span class="line">yum install libcgroup* -y</span><br><span class="line">yum install bridge-utils.x86_64 -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#桥接网卡</span></span></span><br><span class="line">[root@controller ~]# cat /etc/sysconfig/network-scripts/ifcfg-eth0</span><br><span class="line">echo &#x27;TYPE=Ethernet</span><br><span class="line">B00TPROTO=none</span><br><span class="line">NAME=eth0</span><br><span class="line">DEVICE=eth0</span><br><span class="line">ONBOOT=yes</span><br><span class="line">BRIDGE=virbr0&#x27; &gt;/etc/sysconfig/network-scripts/ifcfg-eth0</span><br><span class="line"></span><br><span class="line">[root@controller ~]# cat /etc/sysconfig/network-scripts/ifcfg-virbr0</span><br><span class="line">echo &#x27;TYPE=Bridge</span><br><span class="line">B00TPR0TO=static</span><br><span class="line">NAME=virbr0</span><br><span class="line">DEVICE=virbr0</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=10.0.0.11</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=10.0.0.254</span><br><span class="line">DNS1=180.76.76.76&#x27; &gt;/etc/sysconfig/network-scripts/ifcfg-virbr0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动cgroup</span></span><br><span class="line">systemctl start cgconfig.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动lxc</span></span><br><span class="line">systemctl start lxc.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#创建lxc容器</span></span></span><br><span class="line">方法1：</span><br><span class="line">lxc-create -t download -n centos6 -- --server mirrors.tuna.tsinghua.edu.cn/lxc-images -d centos -r 6 -a amd64</span><br><span class="line">方法2：</span><br><span class="line">lxc-create -t centos -n test</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">####为lxc容器设置root密码：</span></span></span><br><span class="line">[root@controller ~]# chroot /var/lib/lxc/test/rootfs passwd</span><br><span class="line">Changing password for user root.</span><br><span class="line">New password:</span><br><span class="line">BAD PASSWORD: it is too simplistic/systematic</span><br><span class="line">BAD PASSWORD: is too simple</span><br><span class="line">Retype new password:</span><br><span class="line">passwd: all authentication tokens updated successfully.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#为容器指定ip和网关</span></span></span><br><span class="line">vi /var/lib/lxc/centos7/config</span><br><span class="line">Lxc.network.name = etho</span><br><span class="line">lxc.network.ipv4 = 10.0.0.111/24</span><br><span class="line">lxc.network.ipv4.gateway = 10.0.0.254</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#启动容器</span></span></span><br><span class="line">lxc-start -n centos7</span><br><span class="line"></span><br><span class="line">3）：docker容器</span><br><span class="line">centos7.4  2G  10.0.0.11  docker01  host解析</span><br><span class="line">centos7.4  2G  10.0.0.12  docker02  host解析</span><br><span class="line"></span><br><span class="line">Docker是通过进程虚拟化技术（namespaces及cgroups</span><br><span class="line">cpu、内存、磁盘io等）来提供容器的资源隔离与安全保障等。由于Docker通过操作系统层的虚拟化实现隔离，所以Docker容器在运行时，不需要类似虚拟机（VM）额外的操作系统开销，提高资源利用率。</span><br><span class="line">namespace  资源隔离</span><br><span class="line">cgroups  进程的资源限制</span><br><span class="line">kvm  虚拟磁盘文件，资源隔离</span><br><span class="line">kvm  资源限制, --cpus --memory</span><br><span class="line"></span><br><span class="line">docker 初期把lxc二次开发,libcontainer</span><br><span class="line"></span><br><span class="line">top</span><br><span class="line">htop</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>清华源docker文档<br><code>https://mirror.tuna.tsinghua.edu.cn/help/docker-ce/</code></p>
<p>无网络安装docker</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">先在网络环境下安装docker</span><br><span class="line">[root@master ~]# find / -name &quot;*.rpm&quot;|xargs -i mv &#123;&#125; docker_rpm</span><br><span class="line">收集rpm打包</span><br><span class="line">[root@master ~]# tar zcf docker_rpm.tar.gz docker_rpm</span><br><span class="line">传输给另一台设备解压</span><br><span class="line">[root@master ~]# tar xf docker_rpm.tar.gz</span><br><span class="line">将所有相关rpm包安装</span><br><span class="line">[root@master ~]# rpm -Uvh *.rpm</span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br></pre></td><td class="code"><pre><span class="line">下载repo文件</span><br><span class="line">wget -O /etc/yum.repos.d/docker-ce.repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">把软件仓库地址替换为 TUNA:</span><br><span class="line">sed -i &#x27;s+download.docker.com+mirrors.tuna.tsinghua.edu.cn/docker-ce+&#x27; /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">最后安装:</span><br><span class="line">yum install docker-ce -y</span><br><span class="line"></span><br><span class="line">docker的主要目标是&quot;Build,Ship and Run any App,Angwhere&quot;,构建，运输，处处运行</span><br><span class="line">部署服务，环境问题</span><br><span class="line"></span><br><span class="line">一次构建，处处运行</span><br><span class="line"></span><br><span class="line">docker是一种软件的打包技术</span><br><span class="line"></span><br><span class="line">构建：做一个docker镜像</span><br><span class="line">运输：docker pull</span><br><span class="line">运行：启动一个容器</span><br><span class="line">每一个容器，他都有自己的系统文件rootfs.</span><br><span class="line"></span><br><span class="line">kvm解决了硬件和操作系统之间的依赖</span><br><span class="line">kvm独立的虚拟磁盘，xml配置文件</span><br><span class="line"></span><br><span class="line">docker解决了软件和操作系统环境之间的依赖，能够让独立服务或应用程序在不同的环境中，得到相同的运行结果。</span><br><span class="line">docker镜像有自己的文件系统。</span><br><span class="line"></span><br><span class="line">docker容器是一种轻量级、可移植、自包含的软件打包技术，使应用程序可以在几乎任何地方以相同的方式运行。开发人员在自己笔记本上创建并测试好的容器，无需任何修改就能够在生产系统的虚拟机、物理服务器或公有云主机上运行。</span><br><span class="line"></span><br><span class="line">4:docker的安装</span><br><span class="line">18.8.8.11：修改主机名和host解析</span><br><span class="line">rm -fr /etc/yum.repos.d/local.repo</span><br><span class="line">curl -o /etc/yum.repos.d/Cent0S-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line">下载repo文件</span><br><span class="line">wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">把软件仓库地址替换为 TUNA:</span><br><span class="line">sed -i &#x27;s#download.docker.com#mirrors.tuna.tsinghua.edu.cn/docker-ce#g&#x27; /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">最后安装:</span><br><span class="line">yum install docker-ce -y</span><br><span class="line"></span><br><span class="line">5：docker的主要组成部分</span><br><span class="line">docker是传统的es架构分为docker client和docker server,向mysql一样</span><br><span class="line"></span><br><span class="line">命令:docker version</span><br><span class="line">[root@controller ~]# docker version</span><br><span class="line">Client:</span><br><span class="line"> Version:   17.12.0-ce</span><br><span class="line"> API version:  1.35</span><br><span class="line"> Go version:  go1.9.2</span><br><span class="line"> Git commit:  c97c6d6</span><br><span class="line"> Built: Wed Dec 27 20:10:14 2017</span><br><span class="line"> OS/Arch:  Linux/amd64</span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line"> Engine:</span><br><span class="line">  Version:  17.12.0-ce</span><br><span class="line">  API version:  1.35 (minimum version 1.12)</span><br><span class="line">  Go version:  go1.9.2</span><br><span class="line">  Git commit:  c97c6d6</span><br><span class="line">  Built:  Wed Dec 27 20:12:46 2017</span><br><span class="line">  OS/Arch:  Linux/amd64</span><br><span class="line">  Experimental: false</span><br><span class="line"></span><br><span class="line">docker info（如果要做监控）</span><br><span class="line"></span><br><span class="line">docker主要组件有：镜像、容器、仓库，网络，存储</span><br><span class="line"></span><br><span class="line">启动容器必须需要一个镜像，仓库中只存储镜像</span><br><span class="line">容器---镜像---仓库</span><br><span class="line"></span><br><span class="line">docker初次体验：</span><br><span class="line">安装Nginx步骤：</span><br><span class="line">官网下载Nginx源码包wget</span><br><span class="line">tar</span><br><span class="line">创建Nginx用户</span><br><span class="line"></span><br><span class="line">编译安装</span><br><span class="line">./config....</span><br><span class="line">修改配置文件,</span><br><span class="line">启动</span><br><span class="line"></span><br><span class="line">6：启动第一个容器</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#配置docker镜像加速</span></span></span><br><span class="line">vi /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://registry.docker-cn.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">docker run -d -p 80:80 nginx</span><br><span class="line">run（创建并运行一个容器）</span><br><span class="line">-d 放在后台</span><br><span class="line">-p 端口映射</span><br><span class="line">nginx docker镜像的名字</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">7：docker的镜像管理</span><br><span class="line">搜索镜像</span><br><span class="line">    docker search</span><br><span class="line">选镜像的建议：</span><br><span class="line">1, 优先考虑官方</span><br><span class="line">2, stars数量多</span><br><span class="line"></span><br><span class="line">获取镜像</span><br><span class="line">    docker pull (push)</span><br><span class="line">    镜像加速器：阿里云加速器，daocloud加速器，中科大加速器，Docker中国官方镜像加速：</span><br><span class="line">    https://registry.docker-cn.com</span><br><span class="line">    </span><br><span class="line">官方pull  docker pull centos:6.8（没有指定版本，默认会下载最新版）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">查看镜像列表</span><br><span class="line">    docker images</span><br><span class="line">    docker image ls</span><br><span class="line">删除镜像</span><br><span class="line">    docker rmi 例子：docker image rm centos:latest</span><br><span class="line">导出镜像</span><br><span class="line">    dorker save 例子：docker image save centos &gt; docker-centos7.4.tar.gz</span><br><span class="line">导入镜像</span><br><span class="line">    docker load 例子：docker image load-i docker-centos7.4.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">8: docker的容器管理</span><br><span class="line"></span><br><span class="line">docker run -d -p 80:80 nginx:latest</span><br><span class="line">run（创建并运行一个容器）</span><br><span class="line">-d 放在后台</span><br><span class="line">-p 端口映射</span><br><span class="line">-v 源地址（宿主机）：目标地址（容器）</span><br><span class="line"></span><br><span class="line">nginx docker镜像的名字</span><br><span class="line"></span><br><span class="line">docker container ls    #查看运行状态的容器</span><br><span class="line">docker container ls -a    #查看全部状态的容器</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run -it --name centos6 centos:6.9 /bin/bash</span><br><span class="line">-it  分配交互式的终端</span><br><span class="line">--name  指定容器的名字</span><br><span class="line">/bin/sh覆盖容器的初始命令</span><br><span class="line"></span><br><span class="line">启动容器***</span><br><span class="line">    docker run image_name</span><br><span class="line">    docker run -it image_name CMD</span><br><span class="line">    docker run ==== docker create + docker start</span><br><span class="line">    </span><br><span class="line">停止容器</span><br><span class="line">    docker stop CONTAINER_ID</span><br><span class="line">杀死容器</span><br><span class="line">    docker kill container_name</span><br><span class="line">查看容器列表</span><br><span class="line">    docker ps  #输出运行的容器</span><br><span class="line">    docker ps -a    #输出全部容器</span><br><span class="line">    docker ps -a -q  #静默输出，只输出容器的id</span><br><span class="line">    docker ps -a -l  #最近启动的容器</span><br><span class="line">    docker ps -a -l --no-trunc   #显示详细</span><br><span class="line">    </span><br><span class="line">进入容器（目的，调试，排错）</span><br><span class="line">*** docker exec  （会分配一个新的终端tty）</span><br><span class="line">    docker exec [OPTIONS] CONTAINER COMMAND [ARG...]</span><br><span class="line">    </span><br><span class="line">    docker exec -it 容器id或容器名字 /bin/bash (/bin/sh）</span><br><span class="line">    </span><br><span class="line">    docker attach（使用同一个终端）</span><br><span class="line">        docker attach [OPTIONS] CONTAINER</span><br><span class="line">        </span><br><span class="line">    nsenter(安装yum install-y util-linux弃用)</span><br><span class="line">    </span><br><span class="line">    Ctrl+P 松手后 Ctrl+Q 退出容器</span><br><span class="line">    </span><br><span class="line">删除容器</span><br><span class="line">    docker rm</span><br><span class="line">批量删除容器</span><br><span class="line">    docker rm -f &#x27;docker ps -a -q</span><br><span class="line">    </span><br><span class="line">总结：docker容器内的第一个进程（初始命令）必须一直处于前台运行的状态（必须夯住），否则这个容器，就会处于退出状态</span><br><span class="line"></span><br><span class="line">docker run -d centos:6.9 tail -f /etc/hosts</span><br><span class="line"></span><br><span class="line">业务在容器中运行：夯住，启动服务</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">9: docker容器的网络访问（端口映射）</span><br><span class="line">docker0: 172.17.0.1  jumpserver: 172.17.0.2  nginx: 172.17.0.3</span><br><span class="line"></span><br><span class="line">指定映射（docker 会自动添加一条iptables规则来实现端口映射）</span><br><span class="line">    -p hostPort:containerPort    例：-p 80:80</span><br><span class="line">    -p ip:hostPort:containerPort  多个容器都想使用80端口    例：10.0.0.100:80:80</span><br><span class="line">    -p ip::containerPort(随机端口）    例：10.0.0.100::80</span><br><span class="line">    -p hostPort:containerPort:udp    例：80:80:udp</span><br><span class="line">    -p 81：80-p443:443 可以指定多个-p</span><br><span class="line">    </span><br><span class="line">随机映射</span><br><span class="line">    docker run -P （随机端口）</span><br><span class="line"></span><br><span class="line">通过iptables来实现的端口映射</span><br><span class="line">    iptables -t nat -A PREROUTING -d 10.0.0.11 -p tcp --dport 80 -j DNAT --to-destination 172.17.0.3:80</span><br><span class="line">    iptables -t nat -I PREROUTING -d 10.0.0.11 -p tcp --dport 80 -j DNAT --to-destination 172.17.0.3:80</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">10: docker的数据卷管理</span><br><span class="line">/usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">-v /opt/xiaoniao:/usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">持久化</span><br><span class="line">数据卷（文件或目录）</span><br><span class="line">    -v  卷名：/data</span><br><span class="line">    -v  src（宿主机的目录）:dst（容器的目录）</span><br><span class="line">数据巻容器</span><br><span class="line">    --volumes-from（跟某一个已经存在的容器挂载相同的卷）</span><br><span class="line">    </span><br><span class="line">基于nginx启动一个容器，监听80和81，访问80，出现nginx默认欢迎首页，访问81，出现小鸟。</span><br><span class="line">-p 80:80 -p 81:81 -v xxx: xxx -v xxx: xxxx</span><br><span class="line">基于nginx多端口的多站点。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# docker run -d -p 80:80 -v /opt/xiaoniao:/usr/share/nginx/html nginx:latest</span><br><span class="line">[root@localhost ~]# cd /opt/</span><br><span class="line">[root@localhost opt]# ls</span><br><span class="line">containerd  xiaoniao</span><br><span class="line">[root@localhost opt]# cd xiaoniao/</span><br><span class="line">[root@localhost xiaoniao]# vim index.html</span><br><span class="line">[root@localhost xiaoniao]# curl -I 192.168.160.111</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.23.0</span><br><span class="line">Date: Sat, 09 Jul 2022 12:55:51 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 28</span><br><span class="line">Last-Modified: Sat, 09 Jul 2022 12:55:36 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;62c97ac8-1c&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost xiaoniao]#  docker run -d -p 81:80 -v oldboy:/usr/share/nginx/html nginx:latest</span><br><span class="line">[root@localhost xiaoniao]# docker volume inspect oldboy</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreatedAt&quot;: &quot;2022-07-09T21:09:29+08:00&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Labels&quot;: null,</span><br><span class="line">        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/oldboy/_data&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;oldboy&quot;,</span><br><span class="line">        &quot;Options&quot;: null,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">[root@localhost xiaoniao]# cd /var/lib/docker/volumes/oldboy/_data</span><br><span class="line">[root@localhost _data]# ls</span><br><span class="line">50x.html  index.html</span><br><span class="line">[root@localhost _data]# ll -h</span><br><span class="line">总用量 8.0K</span><br><span class="line">-rw-r--r--. 1 root root 497 6月  21 22:25 50x.html</span><br><span class="line">-rw-r--r--. 1 root root 615 6月  21 22:25 index.html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost xiaoniao]# docker volume ls</span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line">local     oldboy</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>P804 08-小案例练习（docker nginx多端口多页面）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">方法一：</span><br><span class="line">[root@localhost ~]# docker run -it -p 80:80 -p 81:81 -v /opt/xiaoniao:/data nginx:latest /bin/bash</span><br><span class="line">root@85b6224bd483:~# cd /etc/nginx/conf.d</span><br><span class="line">root@85b6224bd483:/etc/nginx/conf.d# grep -Ev &#x27;^$|#&#x27; default.conf </span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">root@85b6224bd483:/etc/nginx/conf.d# </span><br><span class="line">echo &#x27;server &#123;</span><br><span class="line">    listen       81;</span><br><span class="line">    server_name  localhost;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /data;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&#x27; &gt;xiaoniao.conf</span><br><span class="line">root@85b6224bd483:/etc/nginx/conf.d# ls</span><br><span class="line">default.conf  xiaoniao.conf</span><br><span class="line">root@85b6224bd483:/etc/nginx/conf.d# nginx</span><br><span class="line"></span><br><span class="line">方法二：</span><br><span class="line">[root@localhost ~]# cd /opt/</span><br><span class="line">[root@localhost opt]# echo &#x27;server &#123;</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">    listen       81;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">    server_name  localhost;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">    location / &#123;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">        root   /data;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">        index  index.html index.htm;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">    &#125;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">&#125;<span class="string">&#x27; &gt;xiaoniao.conf</span></span></span><br><span class="line"></span><br><span class="line">[root@localhost opt]# docker run -d -p 80:80 -p 81:81 -v /opt/xiaoniao:/data -v /opt/xiaoniao.conf:/etc/nginx/conf.d/xiaoniao.conf nginx:latest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">方法三：</span><br><span class="line">[root@localhost ~]# docker run -it -p 80:80 -p 81:81 -v /opt/xiaoniao:/data nginx:latest /bin/bash</span><br><span class="line">移走原镜像源</span><br><span class="line">root@7a176e3fd16d:/# mv /etc/apt/sources.list /tmp/</span><br><span class="line">更换Debian 11阿里云镜像源</span><br><span class="line">root@7a176e3fd16d:/# echo &#x27;deb http://mirrors.aliyun.com/debian/ bullseye main non-free contrib</span><br><span class="line">deb-src http://mirrors.aliyun.com/debian/ bullseye main non-free contrib</span><br><span class="line">deb http://mirrors.aliyun.com/debian-security/ bullseye-security main</span><br><span class="line">deb-src http://mirrors.aliyun.com/debian-security/ bullseye-security main</span><br><span class="line">deb http://mirrors.aliyun.com/debian/ bullseye-updates main non-free contrib</span><br><span class="line">deb-src http://mirrors.aliyun.com/debian/ bullseye-updates main non-free contrib</span><br><span class="line">deb http://mirrors.aliyun.com/debian/ bullseye-backports main non-free contrib</span><br><span class="line">deb-src http://mirrors.aliyun.com/debian/ bullseye-backports main non-free contrib&#x27; &gt;/etc/apt/sources.list</span><br><span class="line">root@7a176e3fd16d:/# apt-get update</span><br><span class="line">root@7a176e3fd16d:/# apt-get install vim -y</span><br><span class="line">root@7a176e3fd16d:/# vim /etc/nginx/nginx.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">查看系统版本 代号bullseye</span></span></span><br><span class="line">root@7a176e3fd16d:/# cat /etc/os-release </span><br><span class="line">PRETTY_NAME=&quot;Debian GNU/Linux 11 (bullseye)&quot;</span><br><span class="line">NAME=&quot;Debian GNU/Linux&quot;</span><br><span class="line">VERSION_ID=&quot;11&quot;</span><br><span class="line">VERSION=&quot;11 (bullseye)&quot;</span><br><span class="line">VERSION_CODENAME=bullseye</span><br><span class="line">ID=debian</span><br><span class="line">HOME_URL=&quot;https://www.debian.org/&quot;</span><br><span class="line">SUPPORT_URL=&quot;https://www.debian.org/support&quot;</span><br><span class="line">BUG_REPORT_URL=&quot;https://bugs.debian.org/&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">查看系统版本号</span></span></span><br><span class="line">root@7a176e3fd16d:/# uname -r</span><br><span class="line">3.10.0-1160.el7.x86_64</span><br></pre></td></tr></table></figure>


<p>P805 09-手动制作docker镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">手动制作镜像：</span><br><span class="line">1）启动一个基础容器</span><br><span class="line">docker run -it centos:6.9 yum</span><br><span class="line">docker run -it alpine:3.9 apk</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# yum provides sshd</span><br><span class="line">openssh-server</span><br><span class="line"></span><br><span class="line">2）在容器中安装服务</span><br><span class="line">echo &#x27;192.168.15.84 mirrors.aliyun.com&#x27; &gt;&gt;/etc/hosts</span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo</span><br><span class="line">yum install openssh-server -y</span><br><span class="line">service sshd start</span><br><span class="line">echo &#x27;123456&#x27;|passwd --stdin root</span><br><span class="line">[root@localhost ~]# ssh root@172.17.0.2</span><br><span class="line"></span><br><span class="line">3）把已经安装好服务的容器，提交为镜像</span><br><span class="line">docker container commit 5617e5d6284b centos6.9_ssh:v1</span><br><span class="line"></span><br><span class="line">4）测试镜像的功能</span><br><span class="line">docker run -d -p 1022:22 centos6.9_ssh:v1 /usr/sbin/sshd -D</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">手动制作一个支持ssh+nginx的镜像：</span><br><span class="line">1）启动一个基础容器</span><br><span class="line">docker run -it -p 80:80 -p 1023:22 centos6.9_ssh:v1 /bin/bash</span><br><span class="line"></span><br><span class="line">2）在容器中安装服务</span><br><span class="line">echo &#x27;192.168.15.84 mirrors.aliyun.com&#x27; &gt;&gt;/etc/hosts</span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-6.10.repo</span><br><span class="line">curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-archive-6.repo</span><br><span class="line">yum install nginx -y</span><br><span class="line">service nginx start</span><br><span class="line">/usr/sbin/sshd -D</span><br><span class="line">docker commit ae244ec0f456 centos6.9_ssh_nginx:v1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">编写脚本同时启动两个服务</span></span><br><span class="line">docker run -it -p 80:80 -p 1022:22 centos6.9_ssh_nginx:v1 /bin/bash</span><br><span class="line">vi /init.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">service sshd restart</span><br><span class="line">nginx -g &#x27;daemon off;&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">停止nginx，执行脚本启动</span></span><br><span class="line">service nginx stop</span><br><span class="line">/bin/bash /init.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">新开窗口连接容器查看服务</span></span><br><span class="line">docker exec -it 269a327e044d /bin/bash</span><br><span class="line">ps -ef</span><br><span class="line">[root@269a327e044d /]# ps -ef</span><br><span class="line">UID         PID   PPID  C STIME TTY          TIME CMD</span><br><span class="line">root          1      0  0 02:06 pts/0    00:00:00 /bin/bash</span><br><span class="line">root         33      1  0 02:06 pts/0    00:00:00 /bin/bash /init.sh</span><br><span class="line">root         58      1  0 02:06 ?        00:00:00 /usr/sbin/sshd</span><br><span class="line">root         60     33  0 02:06 pts/0    00:00:00 nginx: master process nginx -g daemon off;</span><br><span class="line">nginx        61     60  0 02:06 pts/0    00:00:00 nginx: worker process</span><br><span class="line">root         62      0  0 02:08 pts/1    00:00:00 /bin/bash</span><br><span class="line">root         76     62  0 02:08 pts/1    00:00:00 ps -ef</span><br><span class="line"></span><br><span class="line">3）把已经安装好服务的容器，提交为镜像</span><br><span class="line">docker commit 269a327e044d centos6.9_ssh_nginx:v2</span><br><span class="line"></span><br><span class="line">4）测试镜像的功能</span><br><span class="line">docker run -d -p 1025:22 -p 82:80 centos6.9_ssh_nginx:v2 /bin/bash /init.sh</span><br><span class="line">docker ps -a -l</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">测试连接，并查看服务</span></span><br><span class="line">ssh root@10.0.0.11 -p 1025</span><br><span class="line">ps -ef</span><br></pre></td></tr></table></figure>

<p>P806 10-自定义容器镜像的密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 1025:22 -p 82:80 centos6.9_ssh_nginx:v2 /bin/bash /init.sh</span><br><span class="line">docker exec -it 9737f0df5 /bin/bash</span><br><span class="line">vi /init.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">echo &quot;$SSH_PWD&quot;|passwd --stdin root</span><br><span class="line">service sshd restart</span><br><span class="line">nginx -g &#x27;daemon off;&#x27;</span><br><span class="line"></span><br><span class="line">docker commit 9737f0df5d7f centos6.9_ssh_nginx:v3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run -d -p 1026:22 -p 86:80 -e &quot;SSH_PWD=1qaz@WSX&quot; centos6.9_ssh_nginx:v3 /bin/bash /init.sh</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# ssh root@192.168.160.111 -p 1026</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vi /init.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">if [ -z $SSH_PWD ];then</span><br><span class="line">    SSH_PWD=123456</span><br><span class="line">fi</span><br><span class="line">echo &quot;$SSH_PWD&quot;|passwd --stdin root</span><br><span class="line"></span><br><span class="line">service sshd restart</span><br><span class="line">nginx -g &#x27;daemon off;&#x27;</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">万能的夯住的方法，前面服务正常启动，最后使用tail -F夯住</span><br><span class="line">service sshd restart</span><br><span class="line">service nginx restart</span><br><span class="line">tail -F /var/log/nginx/access.log</span><br></pre></td></tr></table></figure>




<p>P807 01-使用dockerfile自动构建镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">编写dockerfile</span><br><span class="line">[root@localhost dockerfile]# vim dockerfile</span><br><span class="line">FROM centos:6.9</span><br><span class="line">RUN curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-6.10.repo</span><br><span class="line">RUN yum install openssh-server -y</span><br><span class="line">RUN service sshd restart</span><br><span class="line">RUN echo &#x27;123456&#x27;|passwd --stdin root</span><br><span class="line">CMD [&quot;/usr/sbin/sshd&quot;,&quot;-D&quot;]                              </span><br><span class="line">绝对路径</span><br><span class="line">[root@localhost dockerfile]# docker build -t centos6.9_ssh:v2 /opt/dockerfile/centos6.9_ssh/</span><br><span class="line">相对路径</span><br><span class="line">[root@localhost dockerfile]# docker build -t centos6.9_ssh:v2 .</span><br><span class="line">Successfully built 08529e001006</span><br><span class="line">Successfully tagged centos6.9_ssh:v2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">另一种写法</span><br><span class="line">[root@localhost dockerfile]# vim dockerfile</span><br><span class="line">FROM centos:6.9</span><br><span class="line">RUN curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-6.10.repo &amp;&amp; \</span><br><span class="line">yum install openssh-server -y &amp;&amp; \</span><br><span class="line">service sshd restart &amp;&amp; \</span><br><span class="line">echo &#x27;123456&#x27;|passwd --stdin root &amp;&amp; \</span><br><span class="line">CMD [&quot;/usr/sbin/sshd&quot;,&quot;-D&quot;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">构建多服务镜像</span><br><span class="line">[root@localhost dockerfile]# cp -a centos6.9_ssh centos6.9_ssh_nginx</span><br><span class="line">[root@localhost dockerfile]# cd centos6.9_ssh_nginx</span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# vim dockerfile</span><br><span class="line">FROM centos:6.9</span><br><span class="line">RUN curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-6.10.repo &amp;&amp; \</span><br><span class="line">curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-archive-6.repo &amp;&amp; \</span><br><span class="line">yum install openssh-server nginx -y</span><br><span class="line">RUN service sshd restart</span><br><span class="line">RUN echo &#x27;123456&#x27;|passwd --stdin root</span><br><span class="line">ADD init.sh /init.sh</span><br><span class="line">CMD [&quot;/bin/bash&quot;,&quot;/init.sh&quot;]</span><br><span class="line"></span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# vim init.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">service sshd restart</span><br><span class="line">nginx -g &#x27;daemon off;&#x27;</span><br><span class="line"></span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# docker build -t centos6.9_ssh_nginx:v4 .</span><br><span class="line">Successfully built 3ee8ce010380</span><br><span class="line">Successfully tagged centos6.9_ssh_nginx:v4</span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# docker run -d -p 2023:22 -p 81:80 centos6.9_ssh_nginx:v4</span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# ssh root@192.168.160.111 -p 2023</span><br><span class="line">[root@106b4772791b ~]# ps -ef|grep nginx</span><br></pre></td></tr></table></figure>



<p>P808 02-dockerfile指令精讲</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost centos6.9_ssh_nginx]# vim dockerfile</span><br><span class="line">FROM centos:6.9</span><br><span class="line">RUN curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-6.10.repo &amp;&amp; \</span><br><span class="line">curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-archive-6.repo &amp;&amp; \</span><br><span class="line">yum install openssh-server nginx -y</span><br><span class="line">RUN service sshd restart</span><br><span class="line">RUN echo &#x27;123456&#x27;|passwd --stdin root</span><br><span class="line">ADD init.sh /init.sh</span><br><span class="line">WORKDIR /usr/share/nginx/html  #添加工作目录</span><br><span class="line">CMD [&quot;/bin/bash&quot;,&quot;/init.sh&quot;]</span><br><span class="line"></span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# docker build -t centos6.9_ssh_nginx:v5 .</span><br><span class="line">Successfully built 9e543b1c3e00</span><br><span class="line">Successfully tagged centos6.9_ssh_nginx:v5</span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# docker run -it centos6.9_ssh_nginx:v5 /bin/bash</span><br><span class="line">[root@16ed6176ae18 html]# pwd  #进入后默认目录在/usr/share/nginx/html</span><br><span class="line">/usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">---------------------------------------</span><br><span class="line"></span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# vim dockerfile</span><br><span class="line">FROM centos:6.9</span><br><span class="line">RUN curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-6.10.repo &amp;&amp; \</span><br><span class="line">curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-archive-6.repo &amp;&amp; \</span><br><span class="line">yum install openssh-server nginx -y</span><br><span class="line">RUN service sshd restart</span><br><span class="line">RUN echo &#x27;123456&#x27;|passwd --stdin root</span><br><span class="line">ADD init.sh /init.sh</span><br><span class="line">WORKDIR /usr/share/nginx/html</span><br><span class="line">VOLUME /usr/share/nginx/html  #添加随机卷</span><br><span class="line">CMD [&quot;/bin/bash&quot;,&quot;/init.sh&quot;]</span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# docker build -t centos6.9_ssh_nginx:v6 .</span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# docker run -d centos6.9_ssh_nginx:v6</span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# docker volume ls</span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line">local     61230828d9510a7c0a2df7892d33ded4b1268a972138bd1976caef1832d65191</span><br><span class="line"></span><br><span class="line">--------------------------------------------</span><br><span class="line"></span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# vim dockerfile</span><br><span class="line">FROM centos:6.9</span><br><span class="line">RUN curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-6.10.repo &amp;&amp; \</span><br><span class="line">curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-archive-6.repo &amp;&amp; \</span><br><span class="line">yum install openssh-server nginx -y</span><br><span class="line">RUN service sshd restart</span><br><span class="line">RUN echo &#x27;123456&#x27;|passwd --stdin root</span><br><span class="line">ADD init.sh /init.sh</span><br><span class="line">WORKDIR /usr/share/nginx/html</span><br><span class="line">VOLUME /usr/share/nginx/html</span><br><span class="line">EXPOSE 22 80  #告诉进行哪些端口要做-P的随机端口映射</span><br><span class="line">CMD [&quot;/bin/bash&quot;,&quot;/init.sh&quot;]</span><br><span class="line"></span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# docker build -t centos6.9_ssh_nginx:v7 .</span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# docker ps -a -l</span><br><span class="line">CONTAINER ID   IMAGE                    COMMAND                CREATED          STATUS          PORTS                                                                              NAMES</span><br><span class="line">0e34dae1f426   centos6.9_ssh_nginx:v7   &quot;/bin/bash /init.sh&quot;   19 seconds ago   Up 18 seconds   0.0.0.0:49154-&gt;22/tcp, :::49154-&gt;22/tcp, 0.0.0.0:49153-&gt;80/tcp, :::49153-&gt;80/tcp   pedantic_blackburn</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# vim dockerfile</span><br><span class="line">FROM centos:6.9</span><br><span class="line">RUN curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-6.10.repo &amp;&amp; \</span><br><span class="line">curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-archive-6.repo &amp;&amp; \</span><br><span class="line">yum install openssh-server nginx -y</span><br><span class="line">RUN service sshd restart</span><br><span class="line">RUN echo &#x27;123456&#x27;|passwd --stdin root</span><br><span class="line">ADD init.sh /init.sh</span><br><span class="line">WORKDIR /usr/share/nginx/html</span><br><span class="line">VOLUME /usr/share/nginx/html</span><br><span class="line">EXPOSE 22 80</span><br><span class="line">ENTRYPOINT [&quot;/bin/bash&quot;,&quot;/init.sh&quot;]  #CMD更换成ENTRYPOINT（容器启动后执行的命令，无法被替换）</span><br><span class="line"></span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# docker build -t centos6.9_ssh_nginx:v8 .</span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# docker run -d -P centos6.9_ssh_nginx:v8 sleep 10</span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# docker ps -a -l</span><br><span class="line">CONTAINER ID   IMAGE                    COMMAND                  CREATED          STATUS          PORTS                                                                              NAMES</span><br><span class="line">90f8e1ad9e51   centos6.9_ssh_nginx:v8   &quot;/bin/bash /init.sh …&quot;   11 seconds ago   Up 10 seconds   0.0.0.0:49158-&gt;22/tcp, :::49158-&gt;22/tcp, 0.0.0.0:49157-&gt;80/tcp, :::49157-&gt;80/tcp   nifty_robinson</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">sleep10被当作的参数，并没有替换命令，无法使用/bin/bash命令进入容器</span></span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# docker ps -a -l --no-trunc</span><br><span class="line">CONTAINER ID                                                       IMAGE                    COMMAND                         CREATED          STATUS          PORTS                                                                              NAMES</span><br><span class="line">90f8e1ad9e51dbdc735427a42299aa8167c9afb4128ee6b2ced69eceba711729   centos6.9_ssh_nginx:v8   &quot;/bin/bash /init.sh sleep 10&quot;   52 seconds ago   Up 51 seconds   0.0.0.0:49158-&gt;22/tcp, :::49158-&gt;22/tcp, 0.0.0.0:49157-&gt;80/tcp, :::49157-&gt;80/tcp   nifty_robinson</span><br><span class="line"></span><br><span class="line">-----------------------------------------------------</span><br><span class="line"></span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# vim init.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">echo &quot;$SSH_PWD&quot;|passwd --stdin root  #添加</span><br><span class="line">service sshd restart</span><br><span class="line">nginx -g &#x27;daemon off;&#x27;</span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# docker build -t centos6.9_ssh_nginx:v9 .</span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# docker run -d -e &quot;SSH_PWD=1qaz@WSX&quot; -P centos6.9_ssh_nginx:v9</span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# docker ps -a -l</span><br><span class="line">CONTAINER ID   IMAGE                    COMMAND                CREATED         STATUS         PORTS                                                                              NAMES</span><br><span class="line">5ef41121e2e5   centos6.9_ssh_nginx:v9   &quot;/bin/bash /init.sh&quot;   3 minutes ago   Up 3 minutes   0.0.0.0:49162-&gt;22/tcp, :::49162-&gt;22/tcp, 0.0.0.0:49161-&gt;80/tcp, :::49161-&gt;80/tcp   agitated_nightingale</span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# ssh root@192.168.160.111 -p 49162</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# vim dockerfile</span><br><span class="line">FROM centos:6.9</span><br><span class="line">RUN curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-6.10.repo &amp;&amp; \</span><br><span class="line">curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-archive-6.repo &amp;&amp; \</span><br><span class="line">yum install openssh-server nginx -y</span><br><span class="line">RUN service sshd restart</span><br><span class="line">ENV SSH_PWD 123456  #添加环境变量，设定默认值</span><br><span class="line">ENV TEST 123456</span><br><span class="line">ADD init.sh /init.sh</span><br><span class="line">WORKDIR /usr/share/nginx/html</span><br><span class="line">VOLUME /usr/share/nginx/html</span><br><span class="line">EXPOSE 22 80</span><br><span class="line">ENTRYPOINT [&quot;/bin/bash&quot;,&quot;/init.sh&quot;]</span><br><span class="line"></span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# docker build -t centos6.9_ssh_nginx:v10 .</span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# docker run -d -P centos6.9_ssh_nginx:v10</span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# docker ps -a -l</span><br><span class="line">CONTAINER ID   IMAGE                     COMMAND                CREATED          STATUS          PORTS                                                                              NAMES</span><br><span class="line">c27f433fafea   centos6.9_ssh_nginx:v10   &quot;/bin/bash /init.sh&quot;   41 seconds ago   Up 41 seconds   0.0.0.0:49164-&gt;22/tcp, :::49164-&gt;22/tcp, 0.0.0.0:49163-&gt;80/tcp, :::49163-&gt;80/tcp   quizzical_fermi</span><br><span class="line">[root@localhost centos6.9_ssh_nginx]# ssh root@192.168.160.111 -p49164</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line">手动制作的镜像，传输时间长</span><br><span class="line">镜像初始命令</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">12:dockerfile自动构建docker镜像</span><br><span class="line">类似ansible剧本，大小几kb</span><br><span class="line">手动做镜像：大小几百M+</span><br><span class="line"></span><br><span class="line">dockerfile支持自定义容器的初始命令</span><br><span class="line"></span><br><span class="line">dockerfile主要组成部分：</span><br><span class="line">  基础镜像信息  FROM centos:6.9</span><br><span class="line">  制作镜像操作指令  RUN yum install openssh-server -y</span><br><span class="line">  容器启动时执行指令  CMD [&quot;/bin/bash&quot;]</span><br><span class="line">dockerfile常用指令：</span><br><span class="line">  FROM 这个镜像的妈妈是谁？（指定基础镜像）</span><br><span class="line">  MAINTAINER 告诉别人，谁负责养它?（指定维护者信息，可以没有）</span><br><span class="line"></span><br><span class="line">  LABLE  描述，标签</span><br><span class="line">  RUN  你想让它干啥（在命令前面加上RUN即可）</span><br><span class="line">  ADD  给它点创业资金（会自动解压tar）  制作docker基础的系统镜像</span><br><span class="line">  WORKDIR  我是cd,今天刚化了妆（设置当前工作目录）</span><br><span class="line">  VOLUME  给它一个存放行李的地方（设置卷，挂载主机目录）</span><br><span class="line">  EXPOSE  它要打开的门是啥（指定对外的端口）（-P随机端口）</span><br><span class="line">  CMD  奔跑吧，兄弟！（指定容器启动后的要干的事情）（容易被替换）</span><br><span class="line"></span><br><span class="line">dockerfile其他指令：</span><br><span class="line">  COPY  复制文件（不会解压）rootfs.tar.gz</span><br><span class="line">  ENV  环境变量</span><br><span class="line">  ENTRYPOTNT  容器启动后执行的命令（无法被替换，启容器的时候指定的命令，会被当成参数）</span><br><span class="line"></span><br><span class="line">参考其他的dockerfile</span><br><span class="line">官方dockerfile或者时速云镜像广场</span><br><span class="line"></span><br><span class="line">13：docker镜像的分层（kvm 链接克隆，写时复制的特性）</span><br><span class="line">镜像分层的好处：复用，节省磁盘空间，相同的内容只需加载一份到内存。</span><br><span class="line">修改dockerfile之后,再次构建速度快</span><br><span class="line"></span><br><span class="line">14：.容器间的互联（--link是单方向的！！！）</span><br><span class="line">    docker run -d -p 80:80 nginx</span><br><span class="line">    docker run -it --link quirky_brown:web01 qstack/centos-ssh /bin/bash</span><br><span class="line">    ping web01</span><br><span class="line">    </span><br><span class="line">lb ---&gt; nginx 172.17.0.4 --&gt; db01  172.17.0.3</span><br><span class="line">                         --&gt; nfs01 172.17.0.2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# for n in `ls *.tar.gz`;doo docker load -i $n ;done</span><br><span class="line"></span><br><span class="line">使用docker运行zabbix-server</span><br><span class="line">docker run --name mysql-server -t \</span><br><span class="line">      -e MYSQL_DATABASE=&quot;zabbix&quot; \</span><br><span class="line">      -e MYSQL_USER=&quot;zabbix&quot; \</span><br><span class="line">      -e MYSQL_PASSWORD=&quot;zabbix_pwd&quot; \</span><br><span class="line">      -e MYSQL_ROOT_PASSWORD=&quot;root_pwd&quot; \</span><br><span class="line">      -d mysql:5.7 \</span><br><span class="line">      --character-set-server=utf8 --collation-server=utf8_bin</span><br><span class="line">      </span><br><span class="line">docker run --name zabbix-java-gateway -t \</span><br><span class="line">      -d zabbix/zabbix-java-gateway:latest</span><br><span class="line">      </span><br><span class="line">docker run --name zabbix-server-mysql -t \</span><br><span class="line">      -e DB_SERVER_HOST=&quot;mysql-server&quot;\</span><br><span class="line">      -e MYSQL_DATABASE=&quot;zabbix&quot; \</span><br><span class="line">      -e MYSQL_USER=&quot;zabbix&quot; \</span><br><span class="line">      -e MYSQL_PASSWORD=&quot;zabbix_pwd&quot; \</span><br><span class="line">      -e MYSQL_ROOT_PASSWORD=&quot;root_pwd&quot; \</span><br><span class="line">      -e ZBX_JAVAGATEWAY=&quot;zabbix-java-gateway&quot; \</span><br><span class="line">      --link mysql-server:mysql \</span><br><span class="line">      --link zabbix-java-gateway:zabbix-java-gateway \</span><br><span class="line">      -p 10051:10051 \</span><br><span class="line">      -d zabbix/zabbix-server-mysql:latest</span><br><span class="line">      </span><br><span class="line">docker run --name zabbix-web-nginx-mysql -t \</span><br><span class="line">      -e DB_SERVER_HOST=&quot;mysql-server&quot; \</span><br><span class="line">      -e MYSQL_DATABASE=&quot;zabbix&quot; \</span><br><span class="line">      -e MYSQL_USER=&quot;zabbix&quot; \</span><br><span class="line">      -e MYSQL_PASSWORD=&quot;zabbix_pwd&quot; \</span><br><span class="line">      -e MYSQL_ROOT_PASSWORD=&quot;root_pwd&quot; \</span><br><span class="line">      --link mysql-server:mysql \</span><br><span class="line">      --link zabbix-server-mysql:zabbix-server \</span><br><span class="line">      -p 80:80 \</span><br><span class="line">      -d zabbix/zabbix-web-nginx-mysql:latest</span><br><span class="line">      </span><br><span class="line">监控报警：微信报警，alpine</span><br><span class="line">yum 安装zabbix好使</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">16:docker registry（私有仓库）</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#普通的registry</span></span></span><br><span class="line">docker run -d -p 5000:5000 --restart=always --name registry -v /opt/myregistry:/var/lib/registry registry</span><br><span class="line"></span><br><span class="line">上传镜像到私有仓库：</span><br><span class="line">a:给镜像打标签</span><br><span class="line">docker tag centos6-sshd:v3 10.0.0.11:5000/centos6-sshd:v3</span><br><span class="line">b：上传镜像</span><br><span class="line">docker push 10.0.0.11:5000/centos6-sshd:v3</span><br><span class="line"></span><br><span class="line">docker run -d 10.0.0.11:5000/centos6-sshd:v3</span><br><span class="line">如果遇到报错：</span><br><span class="line">The push refers to repository [10.0.0.11:5000/centos6.9_ssh]</span><br><span class="line">Get https://10.0.0.11:5000/v2/: http: server gave HTTP response to HTTPS client</span><br><span class="line"></span><br><span class="line">解决方法：</span><br><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;insecure-registries&quot;: [&quot;10.0.0.11:5000&quot;]</span><br><span class="line">&#125;</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line">上传镜像到私有仓库</span><br><span class="line">[root@oldboy ~]# docker push 10.0.0.11:5000/zabbix/zabbix-server-mysql:latest</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#带basic认证的registry</span></span></span><br><span class="line">yum install httpd-tools -y</span><br><span class="line">mkdir /opt/registry-var/auth/ -p</span><br><span class="line">htpasswd -Bbn oldboy 123456 &gt;&gt; /opt/registry-var/auth/htpasswd</span><br><span class="line"></span><br><span class="line">docker run -d -p 5000:5000 -v /opt/registry-var/auth/:/auth/ -v /opt/myregistry:/var/lib/registry -e &quot;REGISTRY_AUTH=htpasswd&quot; -e &quot;REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm&quot; -e &quot;REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd&quot; registry</span><br><span class="line"></span><br><span class="line">[root@oldboy ~]# docker login 10.0.0.11:5000</span><br><span class="line">[root@oldboy ~]# docker login -u oldboy -p123456 10.0.0.11:5000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">自动构建镜像的步骤：</span><br><span class="line">1：手动构建一遍</span><br><span class="line">echo &#x27;192.168.15.84 mirrors.aliyun.com&#x27; &gt;&gt;/etc/hosts</span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo</span><br><span class="line">http://mirrors.aliyun.com/repo/Centos-6.repo</span><br><span class="line">curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo</span><br><span class="line">yum install openssh-server -y</span><br><span class="line">service sshd restart</span><br><span class="line">echo &#x27;123456&#x27;|passwd --stdin root</span><br><span class="line">yum install nginx -y</span><br><span class="line">vi /init.sh</span><br><span class="line"></span><br><span class="line">2: 编写dockerfile</span><br><span class="line">FROM centos:6.9</span><br><span class="line">RUN yum install openssh-server -y</span><br><span class="line">CMD [&quot;/bin/bash&quot;]</span><br><span class="line"></span><br><span class="line">3：构建镜像</span><br><span class="line">docker build -t centos6.9 ssh:v2 .</span><br><span class="line"></span><br><span class="line">4：测试</span><br><span class="line">docker run -d -p 2022:22 centos6.9_ssh:v2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">写一个dockerfile，制作一个kodexplorer网盘docker镜像。nginx+php-fpm (httpd + php)</span><br><span class="line">1：手动构建一遍</span><br><span class="line">echo &#x27;192.168.15.84 mirrors.aliyun.com&#x27; &gt;&gt;/etc/hosts</span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo</span><br><span class="line">yum install php php-gd php-mbstring unzip -y</span><br><span class="line">cd /var/www/html/</span><br><span class="line">curl -o kodexplorer4.40.zip http://192.168.15.84/linux-soft/kodexplorer4.40.zip</span><br><span class="line">unzip kodexplorer4.40.zip</span><br><span class="line">chown -R apache:apache .</span><br><span class="line"></span><br><span class="line">2：编写dockerfile</span><br><span class="line">FROM centos:6.9</span><br><span class="line">RUN echo &#x27;192.168.15.84 mirrors.aliyun.com&#x27; &gt;&gt;/etc/hosts &amp;&amp; \</span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo &amp;&amp; \</span><br><span class="line">yum install php php-gd php-mbstring unzip -y</span><br><span class="line">WORKDIR cd /var/www/html/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">RUN curl -o kodexplorer4.40.zip http://192.168.15.84/linux-soft/kodexplorer4.40.zip</span></span><br><span class="line">ADD kodexplorer4.40.zip .</span><br><span class="line">RUN unzip kodexplorer4.40.zip</span><br><span class="line">RUN chown -R apache:apache .</span><br><span class="line">ADD init.sh /init.sh</span><br><span class="line">EXPOSE 80</span><br><span class="line">ADD test.sh /test.sh</span><br><span class="line">HEALTHCHECK --interval=10s --timeout=3s --retries=3 CMD /bin/bash</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">CMD [<span class="string">&quot;/bin/bash&quot;</span>,<span class="string">&quot;/init.sh&quot;</span>]</span></span><br><span class="line">ENTRYPOINT [&quot;/bin/bash&quot;,&quot;/init.sh&quot;]</span><br><span class="line"></span><br><span class="line">vim init.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">service restart httpd</span><br><span class="line">tail -F /var/log/httpd/access_log</span><br><span class="line"></span><br><span class="line">vi test.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">rest=`curl -I 127.0.0.1 2&gt;/dev/null|grep -c &#x27;Apache&#x27;`</span><br><span class="line">if [ $rest -eq 1 ];then</span><br><span class="line">    echo 0</span><br><span class="line">    exit 0</span><br><span class="line">else</span><br><span class="line">    echo 1</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">docker build -t kod:v2 .</span><br><span class="line">docker run -d -P kod:v2</span><br><span class="line"></span><br><span class="line">docker ps -a -l|awk &#x27;/unhealthy/&#123;print $NF&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>P811 05-docker容器间的互访</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">使用docker运行zabbix-server</span><br><span class="line">docker run --name mysql-server -t \</span><br><span class="line">      -e MYSQL_DATABASE=&quot;zabbix&quot; \</span><br><span class="line">      -e MYSQL_USER=&quot;zabbix&quot; \</span><br><span class="line">      -e MYSQL_PASSWORD=&quot;zabbix_pwd&quot; \</span><br><span class="line">      -e MYSQL_ROOT_PASSWORD=&quot;root_pwd&quot; \</span><br><span class="line">      -d mysql:5.7 \</span><br><span class="line">      --character-set-server=utf8 --collation-server=utf8_bin</span><br><span class="line">      </span><br><span class="line">docker run --name zabbix-java-gateway -t \</span><br><span class="line">      -d zabbix/zabbix-java-gateway:latest</span><br><span class="line">      </span><br><span class="line">docker run --name zabbix-server-mysql -t \</span><br><span class="line">      -e DB_SERVER_HOST=&quot;mysql-server&quot;\</span><br><span class="line">      -e MYSQL_DATABASE=&quot;zabbix&quot; \</span><br><span class="line">      -e MYSQL_USER=&quot;zabbix&quot; \</span><br><span class="line">      -e MYSQL_PASSWORD=&quot;zabbix_pwd&quot; \</span><br><span class="line">      -e MYSQL_ROOT_PASSWORD=&quot;root_pwd&quot; \</span><br><span class="line">      -e ZBX_JAVAGATEWAY=&quot;zabbix-java-gateway&quot; \</span><br><span class="line">      --link mysql-server:mysql \</span><br><span class="line">      --link zabbix-java-gateway:zabbix-java-gateway \</span><br><span class="line">      -p 10051:10051 \</span><br><span class="line">      -d zabbix/zabbix-server-mysql:latest</span><br><span class="line">      </span><br><span class="line">docker run --name zabbix-web-nginx-mysql -t \</span><br><span class="line">      -e DB_SERVER_HOST=&quot;mysql-server&quot; \</span><br><span class="line">      -e MYSQL_DATABASE=&quot;zabbix&quot; \</span><br><span class="line">      -e MYSQL_USER=&quot;zabbix&quot; \</span><br><span class="line">      -e MYSQL_PASSWORD=&quot;zabbix_pwd&quot; \</span><br><span class="line">      -e MYSQL_ROOT_PASSWORD=&quot;root_pwd&quot; \</span><br><span class="line">      --link mysql-server:mysql \</span><br><span class="line">      --link zabbix-server-mysql:zabbix-server \</span><br><span class="line">      -p 80:8080 \  #与视频不同，修改为8080</span><br><span class="line">      -d zabbix/zabbix-web-nginx-mysql:latest</span><br></pre></td></tr></table></figure>


<p>P809 03-使用dockerfile构建php项目</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">写一个dockerfile,制作一个kodexplorer网盘docker镜像。nginx+php-fpm（httpd+php)</span><br><span class="line">1：手动构建一遍</span><br><span class="line">[root@localhost ~]# docker run -it -p 80:80 centos:6.9</span><br><span class="line">[root@3641db23c136 /]# curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-6.10.repo</span><br><span class="line">[root@3641db23c136 /]# yum install php -y</span><br><span class="line">[root@3641db23c136 /]# service httpd start</span><br><span class="line">[root@3641db23c136 /]# cd /var/www/html/</span><br><span class="line">[root@3641db23c136 html]# curl -o kodbox.1.32.zip  https://static.kodcloud.com/update/download/kodbox.1.32.zip</span><br><span class="line">[root@3641db23c136 html]# yum install unzip -y</span><br><span class="line">[root@3641db23c136 html]# unzip kodbox.1.32.zip</span><br><span class="line">[root@3641db23c136 html]# chown -R apache:apache .</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MB_STRING 扩展 建议开启，GD 扩展 建议开启</span></span><br><span class="line">[root@3641db23c136 html]# yum install php-gd php-mbstring -y</span><br><span class="line">[root@3641db23c136 html]# service httpd restart</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">服务器列目录 建议关闭</span></span><br><span class="line">[root@3641db23c136 html]# vi /etc/httpd/conf/httpd.conf </span><br><span class="line">331     Options -Indexes FollowSymLinks  #修改</span><br><span class="line"></span><br><span class="line">2：编写dockerfile</span><br><span class="line">[root@localhost ~]# cd /opt/dockerfile/</span><br><span class="line">[root@localhost dockerfile]# mkdir kod</span><br><span class="line">[root@localhost dockerfile]# cd kod</span><br><span class="line">[root@localhost dockerfile]# vim dockerfile</span><br><span class="line">FROM centos:6.9</span><br><span class="line">RUN curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-6.10.repo &amp;&amp; \</span><br><span class="line">yum install php php-gd php-mbstring unzip -y</span><br><span class="line">WORKDIR /var/www/html/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">curl -o kodbox.1.32.zip  https://static.kodcloud.com/update/download/kodbox.1.32.zip</span></span><br><span class="line">ADD kodbox.1.32.zip .</span><br><span class="line">RUN unzip kodbox.1.32.zip</span><br><span class="line">RUN chown -R apache:apache .</span><br><span class="line">ADD init.sh /init.sh</span><br><span class="line">CMD [&quot;/bin/bash&quot;,&quot;/init.sh&quot;]</span><br><span class="line"></span><br><span class="line">[root@localhost dockerfile]# curl -o kodbox.1.32.zip  https://static.kodcloud.com/update/download/kodbox.1.32.zip</span><br><span class="line">[root@localhost kod]# vim init.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">service httpd restart</span><br><span class="line">tail -F /var/log/httpd/access_log</span><br><span class="line">[root@localhost kod]# docker build -t kod:v1 .</span><br><span class="line">Successfully built 335f17c210a5</span><br><span class="line">Successfully tagged kod:v1</span><br><span class="line">[root@localhost kod]# docker run -d -p 88:80 kod:v1</span><br><span class="line">[root@localhost kod]# docker ps -a -l</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                CREATED              STATUS              PORTS                               NAMES</span><br><span class="line">28c23dbcf693   kod:v1    &quot;/bin/bash /init.sh&quot;   About a minute ago   Up About a minute   0.0.0.0:88-&gt;80/tcp, :::88-&gt;80/tcp   modest_spence</span><br><span class="line"></span><br><span class="line">[root@localhost kod]# docker logs 28c23dbcf693</span><br><span class="line">Stopping httpd: [  OK  ]</span><br><span class="line">httpd: Could not reliably determine the server&#x27;s fully qualified domain name, using 172.17.0.11 for ServerName &#x27;</span><br><span class="line">Starting httpd: [  OK  ]</span><br><span class="line"></span><br><span class="line">---------------------------------------------------</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">优化添加容器健康检查脚本和随机端口映射</span></span><br><span class="line">[root@localhost dockerfile]# vim dockerfile</span><br><span class="line">FROM centos:6.9</span><br><span class="line">RUN curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-6.10.repo &amp;&amp; \</span><br><span class="line">yum install php php-gd php-mbstring unzip -y</span><br><span class="line">WORKDIR /var/www/html/</span><br><span class="line">ADD kodbox.1.32.zip .</span><br><span class="line">RUN unzip kodbox.1.32.zip</span><br><span class="line">RUN chown -R apache:apache .</span><br><span class="line">ADD init.sh /init.sh</span><br><span class="line">EXPOSE 80</span><br><span class="line">ADD test.sh /test.sh</span><br><span class="line">HEALTHCHECK --interval=10s --timeout=3s --retries=3 CMD /bin/bash /test.sh</span><br><span class="line">ENTRYPOINT [&quot;/bin/bash&quot;,&quot;/init.sh&quot;]</span><br><span class="line"></span><br><span class="line">[root@localhost kod]# vim test.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">rest=`curl -I 127.0.0.1 2&gt;/dev/null|grep -c &#x27;Apache&#x27;`</span><br><span class="line">if [ $rest -eq 1 ];then</span><br><span class="line">    echo 0</span><br><span class="line">    exit 0</span><br><span class="line">else</span><br><span class="line">    echo 1</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">[root@localhost kod]# docker build -t kod:v2 .</span><br><span class="line">[root@localhost kod]# docker run -d -P kod:v2</span><br><span class="line">[root@localhost kod]# docker ps -a -l</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                CREATED          STATUS                    PORTS                                     NAMES</span><br><span class="line">7b70e07c963a   kod:v2    &quot;/bin/bash /init.sh&quot;   32 seconds ago   Up 31 seconds (healthy)   0.0.0.0:49165-&gt;80/tcp, :::49165-&gt;80/tcp   naughty_brattain</span><br><span class="line"></span><br><span class="line">-----------------------------</span><br><span class="line"></span><br><span class="line">[root@localhost kod]# docker exec -it 7b70e07c963a /bin/bash</span><br><span class="line">[root@7b70e07c963a html]# vi /test.sh </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">rest=`curl -I 127.0.0.1 2&gt;/dev/null|grep -c &#x27;Apache&#x27;`</span><br><span class="line">if [ ! $rest -eq 1 ];then</span><br><span class="line">    echo 0</span><br><span class="line">    exit 0</span><br><span class="line">else</span><br><span class="line">    echo 1</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">[root@localhost kod]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                CREATED          STATUS                     PORTS                                     NAMES</span><br><span class="line">7b70e07c963a   kod:v2    &quot;/bin/bash /init.sh&quot;   4 minutes ago    Up 4 minutes (unhealthy)   0.0.0.0:49165-&gt;80/tcp, :::49165-&gt;80/tcp   naughty_brattain</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">健康检查状态unhealthy，打印出容器名字</span></span><br><span class="line">[root@localhost kod]# docker ps -a -l|awk &#x27;/unhealthy/&#123;print $NF&#125;&#x27;</span><br><span class="line">naughty_brattain</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>P810 04-docker镜像的分层</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看镜像做了什么</span></span><br><span class="line">[root@localhost ~]# docker image history centos6.9_ssh:v2</span><br><span class="line">IMAGE          CREATED        CREATED BY                                      SIZE      COMMENT</span><br><span class="line">08529e001006   27 hours ago   /bin/sh -c #(nop)  CMD [&quot;/usr/sbin/sshd&quot; &quot;-D…   0B        </span><br><span class="line">ac11955b7e58   27 hours ago   /bin/sh -c echo &#x27;123456&#x27;|passwd --stdin root    537B      </span><br><span class="line">ed9a606b2213   27 hours ago   /bin/sh -c service sshd restart                 4.91kB    </span><br><span class="line">39c6f52ae0cf   27 hours ago   /bin/sh -c yum install openssh-server -y        154MB     </span><br><span class="line">4f62dfa8e3ab   27 hours ago   /bin/sh -c curl -o /etc/yum.repos.d/CentOS-B…   23kB      </span><br><span class="line">2199b8eb8390   3 years ago    /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0B        </span><br><span class="line">&lt;missing&gt;      3 years ago    /bin/sh -c #(nop)  LABEL name=CentOS Base Im…   0B        </span><br><span class="line">&lt;missing&gt;      3 years ago    /bin/sh -c #(nop) ADD file:0e6d175401c5b4260…   195MB </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导出镜像</span></span><br><span class="line">[root@localhost ~]# docker save centos6.9_ssh:v2 &gt;docker_centos6.9_ssh.tar.gz</span><br><span class="line">[root@localhost ~]# ll -h</span><br><span class="line">总用量 341M</span><br><span class="line">-rw-------. 1 root root 1.3K 3月   7 12:08 anaconda-ks.cfg</span><br><span class="line">-rw-r--r--. 1 root root 341M 7月  11 15:30 docker_centos6.9_ssh.tar.gz</span><br></pre></td></tr></table></figure>


<p>P811 05-docker容器间的互访</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run -d -P centos6.9_ssh:v2 /usr/sbin/sshd -D</span><br><span class="line">[root@localhost ~]# docker run -d -P centos6.9_ssh:v2 /usr/sbin/sshd -D</span><br><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE              COMMAND               CREATED          STATUS          PORTS     NAMES</span><br><span class="line">686d80ec7fab   centos6.9_ssh:v2   &quot;/usr/sbin/sshd -D&quot;   1 second ago     Up 1 second               clever_kepler</span><br><span class="line">9608b816cf41   centos6.9_ssh:v2   &quot;/usr/sbin/sshd -D&quot;   12 seconds ago   Up 10 seconds             thirsty_gagarin</span><br><span class="line">[root@localhost ~]# docker exec -it 9608b816cf41 /bin/bash</span><br><span class="line">[root@9608b816cf41 /]# ping 172.17.0.3</span><br><span class="line">PING 172.17.0.3 (172.17.0.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.17.0.3: icmp_seq=1 ttl=64 time=0.484 ms</span><br><span class="line"></span><br><span class="line">[root@9608b816cf41 /]# yum install openssh-clients</span><br><span class="line">[root@9608b816cf41 /]# ssh root@172.17.0.3</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE              COMMAND               CREATED         STATUS         PORTS     NAMES</span><br><span class="line">9608b816cf41   centos6.9_ssh:v2   &quot;/usr/sbin/sshd -D&quot;   7 minutes ago   Up 7 minutes             thirsty_gagarin</span><br><span class="line">[root@localhost ~]# docker run -it --link thirsty_gagarin:web centos6.9_ssh:v2 /bin/bash</span><br><span class="line">[root@82483204302e /]# ping web</span><br><span class="line">PING web (172.17.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from web (172.17.0.2): icmp_seq=1 ttl=64 time=0.136 ms</span><br><span class="line"></span><br><span class="line">[root@82483204302e /]# cat /etc/hosts</span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.17.0.2	web 9608b816cf41 thirsty_gagarin</span><br><span class="line">172.17.0.4	82483204302e</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>P812 06-docker的私有仓库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker pull registry</span><br><span class="line">[root@localhost ~]# docker run -d -p 5000:5000 --restart=always --name registry -v /opt/myregistry:/var/lib/registry registry</span><br><span class="line">[root@localhost ~]# docker tag zabbix/zabbix-server-mysql:latest 192.168.160.111:5000/zabbix/zabbix-server-mysql:latest</span><br><span class="line">[root@localhost ~]# docker images</span><br><span class="line">192.168.160.111:5000/zabbix/zabbix-server-mysql   latest    04ab4aac31bb   5 days ago     70.5MB</span><br><span class="line">[root@localhost ~]# docker push 192.168.160.111:5000/zabbix/zabbix-server-mysql:latest</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">报错</span></span><br><span class="line">The push refers to repository [192.168.160.111:5000/zabbix/zabbix-server-mysql]</span><br><span class="line">Get &quot;https://192.168.160.111:5000/v2/&quot;: http: server gave HTTP response to HTTPS client</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解决方法（将私有仓库加入到白名单）：</span></span><br><span class="line">[root@localhost ~]# vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;insecure-registries&quot;: [&quot;192.168.160.111:5000&quot;]</span><br><span class="line">&#125;</span><br><span class="line">[root@localhost ~]# systemctl restart docker</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上传镜像</span></span><br><span class="line">[root@localhost ~]# docker push 192.168.160.111:5000/zabbix/zabbix-server-mysql:latest</span><br><span class="line">The push refers to repository [192.168.160.111:5000/zabbix/zabbix-server-mysql]</span><br><span class="line">02e2782842ad: Pushed </span><br><span class="line">5f70bf18a086: Pushed </span><br><span class="line">7bdf074e3b19: Pushed </span><br><span class="line">5ade94994331: Pushed </span><br><span class="line">10f43a6f7315: Pushed </span><br><span class="line">348a46c05702: Pushed </span><br><span class="line">32cf9c6fded8: Pushed </span><br><span class="line">090fe86db4c1: Pushed </span><br><span class="line">24302eb7d908: Pushed </span><br><span class="line">latest: digest: sha256:9688901d54d48b903a88e5595a0ab902d6b6bd5384ce8cca9d071eaf6fa2acd7 size: 2203</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">另一台设备从私有仓库pull镜像报错，也需要设置白名单</span></span><br><span class="line">[root@localhost ~]# docker run -d 192.168.160.111:5000/zabbix/zabbix-server-mysql:latest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost ~]# yum install httpd-tools -y</span><br><span class="line">[root@localhost ~]# mkdir /opt/registry-var/auth/ -p</span><br><span class="line">[root@localhost ~]# htpasswd -Bbn oldboy 123456 &gt;&gt; /opt/registry-var/auth/htpasswd</span><br><span class="line">[root@localhost ~]# docker run -d -p 5000:5000 -v /opt/registry-var/auth/:/auth/ -v /opt/myregistry:/var/lib/registry -e &quot;REGISTRY_AUTH=htpasswd&quot; -e &quot;REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm&quot; -e &quot;REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd&quot; registry</span><br><span class="line">3d00f89d918856a64b306bec799f07c1fb5d10af0a2d6bbff0f9589282af3426</span><br><span class="line">[root@localhost ~]# cat /opt/registry-var/auth/htpasswd </span><br><span class="line">oldboy:$2y$05$h2bSXTYpV53tfdqhkCYwUOyA1Qz6bSqBZONu1oMYM/AQrcYZhetlW</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#给私有仓库设置认证，带basic认证的registry</span></span></span><br><span class="line">[root@localhost ~]# docker push 192.168.160.111:5000/zabbix/zabbix-server-mysql</span><br><span class="line">Using default tag: latest</span><br><span class="line">The push refers to repository [192.168.160.111:5000/zabbix/zabbix-server-mysql]</span><br><span class="line">02e2782842ad: Preparing </span><br><span class="line">5f70bf18a086: Preparing </span><br><span class="line">7bdf074e3b19: Preparing </span><br><span class="line">5ade94994331: Preparing </span><br><span class="line">10f43a6f7315: Preparing </span><br><span class="line">348a46c05702: Preparing </span><br><span class="line">32cf9c6fded8: Preparing </span><br><span class="line">090fe86db4c1: Preparing </span><br><span class="line">24302eb7d908: Preparing </span><br><span class="line">no basic auth credentials  # 报错 没有认证</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">登陆私有仓库认证</span></span><br><span class="line">[root@localhost ~]# docker login 192.168.160.111:5000</span><br><span class="line">Username: oldboy</span><br><span class="line">Password: 123456</span><br><span class="line">WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">登陆后可以上传镜像，提示镜像已经存在</span></span><br><span class="line">[root@localhost ~]# docker push 192.168.160.111:5000/zabbix/zabbix-server-mysql</span><br><span class="line">Using default tag: latest</span><br><span class="line">The push refers to repository [192.168.160.111:5000/zabbix/zabbix-server-mysql]</span><br><span class="line">02e2782842ad: Layer already exists </span><br><span class="line">5f70bf18a086: Layer already exists </span><br><span class="line">7bdf074e3b19: Layer already exists </span><br><span class="line">5ade94994331: Layer already exists </span><br><span class="line">10f43a6f7315: Layer already exists </span><br><span class="line">348a46c05702: Layer already exists </span><br><span class="line">32cf9c6fded8: Layer already exists </span><br><span class="line">090fe86db4c1: Layer already exists </span><br><span class="line">24302eb7d908: Layer already exists </span><br><span class="line">latest: digest: sha256:9688901d54d48b903a88e5595a0ab902d6b6bd5384ce8cca9d071eaf6fa2acd7 size: 2203</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">密码存储位置</span></span><br><span class="line">[root@localhost ~]# cat /root/.docker/config.json</span><br><span class="line">&#123;</span><br><span class="line">	&quot;auths&quot;: &#123;</span><br><span class="line">		&quot;192.168.160.111:5000&quot;: &#123;</span><br><span class="line">			&quot;auth&quot;: &quot;b2xkYm95OjEyMzQ1Ng==&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">命令行式登陆，非交互式</span></span><br><span class="line">[root@localhost ~]# docker login -u oldboy -p123456 192.168.160.111:5000</span><br><span class="line">WARNING! Using --password via the CLI is insecure. Use --password-stdin.</span><br><span class="line">WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">另一台设备pull镜像也需要登陆认证</span></span><br><span class="line">[root@localhost ~]# docker pull 192.168.160.111:5000/zabbix/zabbix-server-mysql</span><br><span class="line"></span><br><span class="line">查看镜像列表</span><br><span class="line">使用浏览器访问：</span><br><span class="line">http://192.168.160.111:5000/v2/_catalog  # 使用了认证需要登录</span><br><span class="line"></span><br><span class="line">查看镜像的版本</span><br><span class="line">下面以zabbix/zabbix-server-mysql为例</span><br><span class="line">http://192.168.160.111:5000/v2/zabbix/zabbix-server-mysql/tags/list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">删除私有仓库中的镜像</span><br><span class="line">[root@localhost ~]# docker exec -it 3d00f89d9188 /bin/sh</span><br><span class="line">查看系统版本</span><br><span class="line">/ # cat /etc/os-release </span><br><span class="line">NAME=&quot;Alpine Linux&quot;</span><br><span class="line">ID=alpine</span><br><span class="line">VERSION_ID=3.16.0</span><br><span class="line">PRETTY_NAME=&quot;Alpine Linux v3.16&quot;</span><br><span class="line">HOME_URL=&quot;https://alpinelinux.org/&quot;</span><br><span class="line">BUG_REPORT_URL=&quot;https://gitlab.alpinelinux.org/alpine/aports/-/issues&quot;</span><br><span class="line"></span><br><span class="line">/ # ls /var/lib/registry/docker/registry/v2/repositories/zabbix/</span><br><span class="line">zabbix-server-mysql</span><br><span class="line">/ # du -smh /var/lib/registry/docker/registry/v2</span><br><span class="line">78.2M	/var/lib/registry/docker/registry/v2</span><br><span class="line">/ # du -smh /var/lib/registry/docker/registry/v2/*</span><br><span class="line">78.1M	/var/lib/registry/docker/registry/v2/blobs</span><br><span class="line">116.0K	/var/lib/registry/docker/registry/v2/repositories</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除镜像索引信息</span></span><br><span class="line">/ # rm -fr /var/lib/registry/docker/registry/v2/repositories/zabbix/zabbix-server-mysql</span><br><span class="line"></span><br><span class="line">/ # du -smh /var/lib/registry/docker/registry/v2/*</span><br><span class="line">78.1M	/var/lib/registry/docker/registry/v2/blobs</span><br><span class="line">44.0K	/var/lib/registry/docker/registry/v2/repositories</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">垃圾回收</span></span><br><span class="line">/ # registry garbage-collect /etc/docker/registry/config.yml</span><br><span class="line"></span><br><span class="line">/ # du -smh /var/lib/registry/docker/registry/v2/*</span><br><span class="line">54.1M	/var/lib/registry/docker/registry/v2/blobs</span><br><span class="line">44.0K	/var/lib/registry/docker/registry/v2/repositories</span><br></pre></td></tr></table></figure>



<blockquote>
<p>查看镜像列表<br>使用浏览器访问：<br><code>http://192.168.160.111:5000/v2/_catalog</code>  # 使用了认证需要登录</p>
</blockquote>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220711175622072.png" alt="image-20220711175622072"></p>
<blockquote>
<p>查看镜像的版本<br><code>http://192.168.160.111:5000/v2/zabbix/zabbix-server-mysql/tags/list</code></p>
</blockquote>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220711175510769.png" alt="image-20220711175510769"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">容器的命令：</span><br><span class="line">临时退出容器，ctrl+p,ctrl+q</span><br><span class="line">回到临时退出的容器，attach</span><br><span class="line">cp    在容器和宿主机机互复制文件</span><br><span class="line">kill</span><br><span class="line">ls</span><br><span class="line">rm</span><br><span class="line">start</span><br><span class="line">stop</span><br><span class="line">restart</span><br><span class="line">commit</span><br><span class="line">exec</span><br><span class="line">run</span><br><span class="line">inspect</span><br><span class="line">logs</span><br><span class="line"></span><br><span class="line">仓库：</span><br><span class="line">上传镜像：</span><br><span class="line">1）打标签</span><br><span class="line">2) push推送镜像</span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">容器就是在隔离的环境运行的一个进程?</span><br><span class="line"></span><br><span class="line">容器相对于虚拟机的优势?</span><br><span class="line">轻量级，损耗少，性能高，启动快。</span><br><span class="line"></span><br><span class="line">镜像的常用命令：</span><br><span class="line">docker image save</span><br><span class="line">docker image rm == docker rmi</span><br><span class="line">docker image load</span><br><span class="line">docker image ls == docker images</span><br><span class="line">docker image pull</span><br><span class="line">docker search</span><br><span class="line"></span><br><span class="line">容器常用的命令：</span><br><span class="line">docker run</span><br><span class="line">docker stop</span><br><span class="line">docker rm</span><br><span class="line">docker ps</span><br><span class="line">docker exec</span><br><span class="line">docker kill</span><br><span class="line">docker attach ==离开终端ctrl+p,ctrl+q</span><br><span class="line">docker commit</span><br><span class="line"></span><br><span class="line">docker run -d -p 10.0.0.11:8080:8080 -p 10.0.0.100:53:53:udp oldboy:v1 /bin/bash /init.sh</span><br></pre></td></tr></table></figure>


<p>P813 01-重启docker容器不退出</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">方法一：--restart=always</span><br><span class="line">[root@localhost ~]# docker run -d --restart=always nginx:latest</span><br><span class="line"></span><br><span class="line">方法二，修改配置文件使全部容器生效，不推荐。缺点：无法重启容器，导致脱离dockers的控制</span><br><span class="line">[root@localhost ~]# vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://registry.docker-cn.com&quot;],</span><br><span class="line">  &quot;insecure-registries&quot;: [&quot;192.168.160.111:5000&quot;],</span><br><span class="line">  &quot;live-restore&quot;: true  # 添加</span><br><span class="line">&#125;</span><br><span class="line">[root@localhost ~]# systemctl restart docker</span><br></pre></td></tr></table></figure>


<p>P814 02-docker容器的4种网络类型</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--network none 不分配网络</span></span><br><span class="line">[root@localhost ~]# docker run -it --network none centos6.9_ssh:v1</span><br><span class="line">[root@eea2853ebcb6 /]# ps -ef</span><br><span class="line">UID         PID   PPID  C STIME TTY          TIME CMD</span><br><span class="line">root          1      0  0 12:43 pts/0    00:00:00 /bin/bash</span><br><span class="line">root         15      1  0 12:48 pts/0    00:00:00 ps -ef</span><br><span class="line">[root@eea2853ebcb6 /]# ifconfig</span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)</span><br><span class="line"></span><br><span class="line">[root@eea2853ebcb6 /]# netstat -lntup</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name  </span><br><span class="line"></span><br><span class="line">[root@localhost ~]# docker ps -a -l</span><br><span class="line">CONTAINER ID   IMAGE              COMMAND       CREATED         STATUS         PORTS     NAMES</span><br><span class="line">eea2853ebcb6   centos6.9_ssh:v1   &quot;/bin/bash&quot;   5 minutes ago   Up 5 minutes             fervent_carson</span><br><span class="line">[root@localhost ~]# docker inspect eea2853ebcb6</span><br><span class="line">...</span><br><span class="line">            &quot;Networks&quot;: &#123;</span><br><span class="line">                &quot;none&quot;: &#123;</span><br><span class="line">                    &quot;IPAMConfig&quot;: null,</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">-----------------------------------------</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--network host 与宿主机共享网络，同时共享主机名，同时共享端口占用宿主机端口</span></span><br><span class="line">[root@localhost ~]# docker run -it --network host centos6.9_ssh:v1</span><br><span class="line">[root@localhost /]# cat /etc/hosts</span><br><span class="line">[root@localhost ~]# docker ps -a -l</span><br><span class="line">CONTAINER ID   IMAGE              COMMAND       CREATED         STATUS         PORTS     NAMES</span><br><span class="line">c2cd3eee9d7b   centos6.9_ssh:v1   &quot;/bin/bash&quot;   4 minutes ago   Up 4 minutes             gallant_borg</span><br><span class="line">[root@localhost ~]# docker inspect c2cd3eee9d7b</span><br><span class="line">...</span><br><span class="line">            &quot;Networks&quot;: &#123;</span><br><span class="line">                &quot;host&quot;: &#123;</span><br><span class="line">                    &quot;IPAMConfig&quot;: null,</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">-------------------------------------------</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--network container:3c8024500796 与容器共享网络，共享主机名、hosts解析、hostname</span></span><br><span class="line">[root@localhost ~]# docker run -d -P nginx:latest</span><br><span class="line">b885557413191f333311eb190447a8059e2cf5b620ac40368b32b7198e9b2ba9</span><br><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS                                     NAMES</span><br><span class="line">b88555741319   nginx:latest   &quot;/docker-entrypoint.…&quot;   13 seconds ago   Up 12 seconds   0.0.0.0:49153-&gt;80/tcp, :::49153-&gt;80/tcp   jovial_sanderson</span><br><span class="line">[root@localhost ~]# docker run -it --network container:b88555741319 centos6.9_ssh:v1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">共享主机名</span></span><br><span class="line">[root@b88555741319 /]# </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看容器的<span class="built_in">id</span></span></span><br><span class="line">[root@localhost ~]# docker ps -a -l</span><br><span class="line">CONTAINER ID   IMAGE              COMMAND       CREATED          STATUS          PORTS     NAMES</span><br><span class="line">d8754567b083   centos6.9_ssh:v1   &quot;/bin/bash&quot;   35 seconds ago   Up 34 seconds             nostalgic_herschel</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">共享网络配置</span></span><br><span class="line">[root@b88555741319 /]# ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:42:AC:11:00:02  </span><br><span class="line">          inet addr:172.17.0.2  Bcast:172.17.255.255  Mask:255.255.0.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:8 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:656 (656.0 b)  TX bytes:0 (0.0 b)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)</span><br><span class="line">          </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">共享hosts文件</span></span><br><span class="line">[root@b88555741319 /]# cat /etc/hosts</span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.17.0.2	b88555741319</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">共享端口</span></span><br><span class="line">[root@b88555741319 /]# netstat -lntup</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name   </span><br><span class="line">tcp        0      0 0.0.0.0:80                  0.0.0.0:*                   LISTEN      -                   </span><br><span class="line">tcp        0      0 :::80                       :::*                        LISTEN      -                   </span><br><span class="line"></span><br><span class="line">root@localhost ~]# docker ps -a -l</span><br><span class="line">CONTAINER ID   IMAGE              COMMAND       CREATED         STATUS         PORTS     NAMES</span><br><span class="line">d8754567b083   centos6.9_ssh:v1   &quot;/bin/bash&quot;   3 minutes ago   Up 3 minutes             nostalgic_herschel</span><br><span class="line">[root@localhost ~]# docker inspect d8754567b083</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">container记录了共享网络的容器<span class="built_in">id</span></span></span><br><span class="line">[root@localhost ~]# docker inspect d8754567b083|grep -i &#x27;network&#x27;</span><br><span class="line">            &quot;NetworkMode&quot;: &quot;container:b885557413191f333311eb190447a8059e2cf5b620ac40368b32b7198e9b2ba9&quot;,</span><br><span class="line">        &quot;NetworkSettings&quot;: &#123;</span><br><span class="line">            &quot;Networks&quot;: &#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>P815 03-docker跨主机容器间的通讯macvlan</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/hosts</span><br><span class="line">192.168.160.111 docker01</span><br><span class="line">192.168.160.112 docker02</span><br><span class="line">[root@localhost ~]# hostnamectl set-hostname docker01</span><br><span class="line">[root@localhost ~]# hostnamectl set-hostname docker02</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# docker network ls</span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">e9974c4ce604   bridge    bridge    local</span><br><span class="line">84ac06139b07   host      host      local</span><br><span class="line">13d8f750c9ff   none      null      local</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">docker01创建macvlan网络</span></span><br><span class="line">[root@docker01 ~]# docker network create --driver macvlan --subnet 192.168.160.0/24 --gateway 192.168.160.254 -o parent=eth0 macvlan_1</span><br><span class="line">[root@docker01 ~]# docker network ls</span><br><span class="line">NETWORK ID     NAME        DRIVER    SCOPE</span><br><span class="line">e9974c4ce604   bridge      bridge    local</span><br><span class="line">84ac06139b07   host        host      local</span><br><span class="line">e7cd29f30d90   macvlan_1   macvlan   local</span><br><span class="line">13d8f750c9ff   none        null      local</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">docker02创建macvlan网络</span></span><br><span class="line">[root@docker02 ~]# docker network create --driver macvlan --subnet 192.168.160.0/24 --gateway 192.168.160.254 -o parent=eth0 macvlan_1</span><br><span class="line">[root@docker02 ~]# docker network ls</span><br><span class="line">NETWORK ID     NAME        DRIVER    SCOPE</span><br><span class="line">e4f678f3824d   bridge      bridge    local</span><br><span class="line">84ac06139b07   host        host      local</span><br><span class="line">76697b4e65db   macvlan_1   macvlan   local</span><br><span class="line">13d8f750c9ff   none        null      local</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建使用macvlan网络的容器</span></span><br><span class="line">[root@docker01 ~]# docker run -it --network macvlan_1 --ip=192.168.160.101 centos6.9_ssh:v2 /bin/bash</span><br><span class="line">[root@docker02 ~]# docker run -it --network macvlan_1 --ip=192.168.160.102 centos6.9_ssh:v2 /bin/bash</span><br><span class="line">[root@488b97333284 /]# ping 192.168.160.101</span><br><span class="line">PING 192.168.160.101 (192.168.160.101) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.160.101: icmp_seq=1 ttl=64 time=0.504 ms</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装抓包软件tcpdump</span></span><br><span class="line">[root@488b97333284 /]# yum install tcpdump -y</span><br><span class="line">[root@cd7567fea478 /]# ping 192.168.160.102</span><br><span class="line">PING 192.168.160.102 (192.168.160.102) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.160.102: icmp_seq=1 ttl=64 time=0.750 ms</span><br><span class="line">[root@488b97333284 /]# tcpdump icmp</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class="line">listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes</span><br><span class="line">15:46:46.555254 IP 192.168.160.101 &gt; 488b97333284: ICMP echo request, id 3840, seq 1, length 64</span><br><span class="line">15:46:46.555461 IP 488b97333284 &gt; 192.168.160.101: ICMP echo reply, id 3840, seq 1, length 64</span><br><span class="line">15:46:47.556803 IP 192.168.160.101 &gt; 488b97333284: ICMP echo request, id 3840, seq 2, length 64</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>P816 04-docker跨主机容器间的通讯overlay上</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">修改配置文件</span><br><span class="line">[root@docker01 ~]# vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://registry.docker-cn.com&quot;],</span><br><span class="line">  &quot;insecure-registries&quot;: [&quot;192.168.160.111:5000&quot;],</span><br><span class="line">  &quot;hosts&quot;:[&quot;tcp://0.0.0.0:2376&quot;,&quot;unix:///var/run/docker.sock&quot;],  # 添加</span><br><span class="line">  &quot;cluster-store&quot;:&quot;consul://192.168.160.111:8500&quot;,  # 添加 指定配置文件在192.168.160.111:8500上</span><br><span class="line">  &quot;cluster-advertise&quot;:&quot;192.168.160.111:2376&quot;  # 添加</span><br><span class="line">&#125;</span><br><span class="line">重启后报错</span><br><span class="line">[root@docker01 ~]# systemctl restart docker</span><br><span class="line">Job for docker.service failed because the control process exited with error code. See &quot;systemctl status docker.service&quot; and &quot;journalctl -xe&quot; for details.</span><br><span class="line"></span><br><span class="line">修改配置文件</span><br><span class="line">[root@docker01 ~]# vim /usr/lib/systemd/system/docker.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删减 -H fd://</span></span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改为↓</span></span><br><span class="line">ExecStart=/usr/bin/dockerd --containerd=/run/containerd/containerd.sock</span><br><span class="line"></span><br><span class="line">重启容器</span><br><span class="line">[root@docker01 ~]# systemctl daemon-reload</span><br><span class="line">[root@docker01 ~]# systemctl restart docker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker02修改配置</span><br><span class="line">[root@docker02 ~]# vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;insecure-registries&quot;: [&quot;192.168.160.111:5000&quot;],</span><br><span class="line">  &quot;hosts&quot;:[&quot;tcp://0.0.0.0:2376&quot;,&quot;unix:///var/run/docker.sock&quot;],    # 添加</span><br><span class="line">  &quot;cluster-store&quot;:&quot;consul://192.168.160.111:8500&quot;,  # 添加  指定配置文件在192.168.160.111:8500上</span><br><span class="line">  &quot;cluster-advertise&quot;:&quot;192.168.160.112:2376&quot;  # 添加</span><br><span class="line">&#125;</span><br><span class="line">修改配置文件</span><br><span class="line">[root@docker02 ~]# vim /usr/lib/systemd/system/docker.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删减 -H fd://</span></span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改为↓</span></span><br><span class="line">ExecStart=/usr/bin/dockerd --containerd=/run/containerd/containerd.sock</span><br><span class="line"></span><br><span class="line">重启容器</span><br><span class="line">[root@docker02 ~]# systemctl daemon-reload</span><br><span class="line">[root@docker02 ~]# systemctl restart docker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">拉取镜像</span><br><span class="line">[root@docker01 ~]# docker pull progrium/consul</span><br><span class="line">启动镜像</span><br><span class="line">[root@docker01 ~]# docker run -d -p 8500:8500 --restart=always -h consul --name consul progrium/consul -server -bootstrap</span><br><span class="line">[root@docker01 ~]# netstat -lntup</span><br><span class="line">tcp6       0      0 :::2376                 :::*                    LISTEN      8644/dockerd  </span><br><span class="line">浏览器访问192.168.160.111:8500 管理界面</span><br><span class="line"></span><br><span class="line">创建overlay网络（指定一个不存在的网段，不能在已有的网段创建，会产生冲突）</span><br><span class="line">[root@docker01 ~]# docker network create -d overlay --subnet 172.16.1.0/24 --gateway 172.16.1.254 ol1</span><br><span class="line">[root@docker01 ~]# docker network ls</span><br><span class="line">NETWORK ID     NAME        DRIVER    SCOPE</span><br><span class="line">e966dd5f8414   ol1         overlay   global</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker02 监听2376端口，被远程自动创建了</span></span><br><span class="line">[root@docker02 ~]# docker network ls</span><br><span class="line">NETWORK ID     NAME        DRIVER    SCOPE</span><br><span class="line">e966dd5f8414   ol1         overlay   global</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker02 -H 远程操作查看 docker01 上的镜像</span></span><br><span class="line">[root@docker02 ~]# docker -H 192.168.160.111:2376 images</span><br><span class="line">或</span><br><span class="line">[root@docker02 ~]# docker -H 192.168.160.111:2376 image ls</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-h参数指定容器主机名</span></span><br><span class="line">[root@docker01 ~]# docker run -it --network ol1 --name oldboy01 -h oldboy01 centos6.9_ssh:v1</span><br><span class="line">[root@oldboy01 /]# ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">10: eth0@if11: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1450 qdisc noqueue state UP </span><br><span class="line">    link/ether 02:42:ac:10:01:01 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.16.1.1/24 brd 172.16.1.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">13: eth1@if14: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP </span><br><span class="line">    link/ether 02:42:ac:12:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.18.0.2/16 brd 172.18.255.255 scope global eth1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker02 创建oldboy01提示在ol1网络上已经存在了</span></span><br><span class="line">[root@docker02 ~]# docker run -it --network ol1 --name oldboy01 -h oldboy01 centos6.9_ssh:v2 /bin/bash</span><br><span class="line">docker: Error response from daemon: endpoint with name oldboy01 already exists in network ol1.</span><br><span class="line">[root@docker02 ~]# docker run -it --network ol1 --name oldboy02 centos6.9_ssh:v2 /bin/bash</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker01 上的容器oldboy01 ping通 docker02 上的容器oldboy02</span></span><br><span class="line">[root@oldboy01 /]# ping oldboy02</span><br><span class="line">PING oldboy02 (172.16.1.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from oldboy02.ol1 (172.16.1.2): icmp_seq=1 ttl=64 time=0.537 ms</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">overlay修改了DNS，使用特殊地址实现DNS解析，由于8500提供</span></span><br><span class="line">[root@oldboy01 /]# cat /etc/resolv.conf </span><br><span class="line">nameserver 127.0.0.11</span><br><span class="line">options ndots:0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>浏览器访问192.168.160.111:8500</p>
</blockquote>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220712134918147.png" alt="image-20220712134918147"></p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220712135254388.png" alt="image-20220712135254388"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动</span></span><br><span class="line">docker-compose up</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">后台启动</span></span><br><span class="line">docker-compose up -d</span><br><span class="line"></span><br><span class="line">18：重启docker服务，容器全部退出的解决办法</span><br><span class="line">方法一：docker run --restart=always</span><br><span class="line"></span><br><span class="line">方法二：&quot;live-restore&quot;: true</span><br><span class="line">docker server配置文件/etc/docker/daemon.json参考</span><br><span class="line">&#123;</span><br><span class="line"> &quot;registry-mirrors&quot;: [&quot;http://b7a9017d.m.daocloud.io&quot;],</span><br><span class="line"> &quot;insecure-registries&quot;:[&quot;10.0.0.11:5000&quot;],</span><br><span class="line"> &quot;live-restore&quot;: true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">19：Docker Machine远程给其他宿主机安装docker服务</span><br><span class="line">Docker Machine 二进制  10.0.0.11</span><br><span class="line">10.0.0.12 免密码登陆 从docker的官网下载二进制的包，去安装docker</span><br><span class="line">10.0.0.13 免密码登陆</span><br><span class="line"></span><br><span class="line">ansible:</span><br><span class="line">shell</span><br><span class="line"></span><br><span class="line">20:Docker网络类型</span><br><span class="line">None: 不为容器配置任何网络功能，--net=none</span><br><span class="line">Container: 与另一个运行中的容器共享Network Namespace, --net=container:containerID(K8S)</span><br><span class="line">Host: 与宿主机共享Network Namespace, --net=host</span><br><span class="line">Bridge: Docker设计的NAT网络模型</span><br><span class="line"></span><br><span class="line">21: Docker跨主机容器之间的通信macvlan</span><br><span class="line"></span><br><span class="line">默认一个物理网卡，只有一个物理地址，虚拟多个mac地址</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#创建macvlan网络</span></span></span><br><span class="line">docker network create --driver macvlan --subnet 10.0.0.0/24 --gateway 10.0.0.254 -o parent=eth0 macvlan_1</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置eth0的网卡为混杂模式(乌班图,centos不需要设置)</span></span><br><span class="line">ip link set eth1 promisc on</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#创建使用macvlan网络的容器</span></span></span><br><span class="line">docker run -it --network macvlan_1 --ip=10.0.0.200 busybox</span><br><span class="line"></span><br><span class="line">作业1: 用PIPEWORK为docker容器配置独立IP</span><br><span class="line">作业2：docker跨主机容器间的通信flannel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">22: Dcoker跨主机容器通信之overlay</span><br><span class="line">http://www.cnblogs.com/CloudMan6/p/7270551.html</span><br><span class="line">1)准备工作</span><br><span class="line">docker01上：</span><br><span class="line">docker run -d -p 8500:8500 --restart=always -h consul --name consul progrium/consul -server -bootstrap</span><br><span class="line">设置容器的主机名</span><br><span class="line"></span><br><span class="line">consul: kv类型的存储数据库 (key:value)</span><br><span class="line">docker01、02上：</span><br><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;hosts&quot;:[&quot;tcp://0.0.0.0:2376&quot;,&quot;unix:///var/run/docker.sock&quot;],</span><br><span class="line">  &quot;cluster-store&quot;:&quot;consul://10.0.0.13:8500&quot;,</span><br><span class="line">  &quot;cluster-advertise&quot;:&quot;10.0.0.11:2376&quot;</span><br><span class="line">&#125;</span><br><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">vim /usr/lib/systemd/system/docker.service</span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd://--containerd=/run/containerd/containerd.sock</span><br><span class="line">↓</span><br><span class="line">ExecStart=/usr/bin/dockerd --containerd=/run/containerd/containerd.sock</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line">2)创建overlay网络</span><br><span class="line">docker network create -d overlay --subnet 172.16.1.0/24 --gateway 172.16.1.254 ol1</span><br><span class="line"></span><br><span class="line">3）启动容器测试</span><br><span class="line">docker run -it --network ol1 --name oldboy01 busybox /bin/bash</span><br><span class="line">每个容器有两块网卡，eth0实现容器间的通讯，eth1实现容器访问外网</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">17：docker-compose(单机版的容器编排工具）</span><br><span class="line">ansible剧本</span><br><span class="line"></span><br><span class="line">yum install -y python2-pip（需要epel源）</span><br><span class="line">pip install docker-compose(默认pypi源在国外）</span><br><span class="line"></span><br><span class="line">临时使用</span><br><span class="line">pip install -i https://pypi.tuna.tsinghua.edu.cn/simple docker-compose</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#pip 加速</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#详细指令</span></span></span><br><span class="line">http://www.jianshu.com/p/2217cfed29d7</span><br><span class="line"></span><br><span class="line">cd my_wordpress/</span><br><span class="line">vi docker-compose.yml</span><br><span class="line">version: &#x27;3&#x27;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  db:</span><br><span class="line">    image: mysql:5.7</span><br><span class="line">    volumes:</span><br><span class="line">      - db_data:/var/lasb/mysql</span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">      MYSQL_ROOT_PASSWORD: somewordpress</span><br><span class="line">      MYSQL_DATABASE: wordpress</span><br><span class="line">      MYSQL_USER: wordpress</span><br><span class="line">      MYSQL_PASSWORD: wordpress</span><br><span class="line"></span><br><span class="line">  wordpress:</span><br><span class="line">    depends_on:</span><br><span class="line">       - db</span><br><span class="line">    image: wordpress:latest</span><br><span class="line">    volumes:</span><br><span class="line">      - web_data:/var/www/html</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;80:80&quot;</span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">      WORDPRESS_DB_HOST: db:3306</span><br><span class="line">      WORDPRESS_DB_USER: wordpress</span><br><span class="line">      WORDPRESS_DB_PASSWORD: wordpress</span><br><span class="line">volumes:</span><br><span class="line">    db_data:</span><br><span class="line">    web_data:</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动</span></span><br><span class="line">docker-compose up</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">后台启动</span></span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>P818 06-docker单机编排docker-compose之wordpress</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# python -V</span><br><span class="line">Python 2.7.5</span><br><span class="line">[root@docker01 ~]# curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">[root@docker01 ~]# cat /etc/yum.repos.d/epel.repo</span><br><span class="line">[root@docker01 ~]# yum install python2-pip -y  # 需要epel源</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">临时使用镜像加速 https://mirrors.tuna.tsinghua.edu.cn/help/pypi/（报错）</span></span><br><span class="line">[root@docker01 ~]# pip install -i https://pypi.tuna.tsinghua.edu.cn/simple docker-compose</span><br><span class="line">或者</span><br><span class="line">[root@docker01 ~]# pip install docker-compose  # 默认pypi源在国外</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">报错</span></span><br><span class="line">Command &quot;python setup.py egg_info&quot; failed with error code 1 in /tmp/pip-build-lhvsnjze/cryptography/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">报错</span></span><br><span class="line">  Could not find a version that satisfies the requirement docker-compose (from versions: )</span><br><span class="line">No matching distribution found for docker-compose</span><br><span class="line">You are using pip version 8.1.2, however version 22.1.2 is available.</span><br><span class="line">You should consider upgrading via the &#x27;pip install --upgrade pip&#x27; command.</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# yum install -y python3-pip </span><br><span class="line">[root@docker01 ~]# pip3 install docker-compose  # 报错</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">报错解决方法： 升级pip版本后,需要reboot重启虚拟机</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将pip版本升级到最新,就不会出现Command <span class="string">&quot;python setup.py egg_info&quot;</span> failed with error code 1的情况了</span></span><br><span class="line">[root@docker01 ~]# pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple pip -U</span><br><span class="line">[root@docker01 ~]# reboot</span><br><span class="line">[root@docker01 ~]# pip --version</span><br><span class="line">pip 21.3.1 from /usr/local/lib/python3.6/site-packages/pip (python 3.6)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">临时使用镜像加速 https://mirrors.tuna.tsinghua.edu.cn/help/pypi/</span></span><br><span class="line">[root@docker01 ~]# pip install -i https://pypi.tuna.tsinghua.edu.cn/simple docker-compose</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">升级pip:</span></span><br><span class="line">1.sudo wget https://bootstrap.pypa.io/pip/2.7/get-pip.py</span><br><span class="line">2.sudo python get-pip.py</span><br><span class="line">3.pip -V</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# cd /opt/</span><br><span class="line">[root@docker01 opt]# mkdir wordpress</span><br><span class="line">[root@docker01 opt]# vim  docker-compose.yaml</span><br><span class="line">version: &#x27;3&#x27;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  db:</span><br><span class="line">    image: mysql:5.7</span><br><span class="line">    volumes:</span><br><span class="line">      - db_data:/var/lasb/mysql</span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">      MYSQL_ROOT_PASSWORD: somewordpress</span><br><span class="line">      MYSQL_DATABASE: wordpress</span><br><span class="line">      MYSQL_USER: wordpress</span><br><span class="line">      MYSQL_PASSWORD: wordpress</span><br><span class="line"></span><br><span class="line">  wordpress:</span><br><span class="line">    depends_on:</span><br><span class="line">       - db</span><br><span class="line">    image: wordpress:latest</span><br><span class="line">    volumes:</span><br><span class="line">      - web_data:/var/www/html</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;80:80&quot;</span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">      WORDPRESS_DB_HOST: db:3306</span><br><span class="line">      WORDPRESS_DB_USER: wordpress</span><br><span class="line">      WORDPRESS_DB_PASSWORD: wordpress</span><br><span class="line">volumes:</span><br><span class="line">    db_data:</span><br><span class="line">    web_data:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置docker镜像加速</span><br><span class="line">[root@docker01 wordpress]# vim /etc/docker/daemon.json</span><br><span class="line">&quot;registry-mirrors&quot;:[&quot;https://rsbud4vc.mirror.aliyuncs.com&quot;,&quot;https://registry.docker-cn.com&quot;,&quot;https://docker.mirrors.ustc.edu.cn&quot;,&quot;https://dockerhub.azk8s.cn&quot;,&quot;http://hub-mirror.c.163.com&quot;,&quot;http://qtid6917.mirror.aliyuncs.com&quot;,&quot;https://rncxm540.mirror.aliyuncs.com&quot;,&quot;https://e9yneuy4.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125; </span><br><span class="line">[root@docker01 wordpress]# systemctl daemon-reload &amp;&amp; systemctl restart docker</span><br><span class="line">[root@docker01 wordpress]# docker pull mysql:5.7</span><br><span class="line">[root@docker01 wordpress]# docker pull wordpress</span><br><span class="line">[root@docker01 wordpress]# docker-compose up</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-d 后台启动</span></span><br><span class="line">[root@docker01 wordpress]# docker-compose up -d</span><br><span class="line"></span><br><span class="line">浏览器访问192.168.160.111</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">scale修改已启动容器数量为2</span></span><br><span class="line">[root@docker01 wordpress]# docker-compose scale wordpress=2</span><br><span class="line">[root@docker01 wordpress]# docker-compose down</span><br><span class="line"></span><br><span class="line">[root@docker01 wordpress]# vim docker-compose.yaml </span><br><span class="line">    ports:</span><br><span class="line">      - &quot;80&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定启动3个容器</span></span><br><span class="line">[root@docker01 wordpress]# docker-compose up --scale wordpress=3</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# netstat -lntup</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name         </span><br><span class="line">tcp        0      0 0.0.0.0:49156           0.0.0.0:*               LISTEN      7546/docker-proxy   </span><br><span class="line">tcp        0      0 0.0.0.0:49157           0.0.0.0:*               LISTEN      7564/docker-proxy   </span><br><span class="line">tcp        0      0 0.0.0.0:49158           0.0.0.0:*               LISTEN      7581/docker-proxy </span><br><span class="line"></span><br><span class="line">浏览器访问192.168.160.111:49156</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker02 安装nginx配置负载均衡</span></span><br><span class="line">[root@docker02 ~]# wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">[root@docker02 ~]# yum install nginx -y</span><br><span class="line">[root@docker02 ~]# grep -Ev &#x27;^$|#&#x27; /etc/nginx/nginx.conf.default &gt;/etc/nginx/nginx.conf</span><br><span class="line">[root@docker02 ~]# vim /etc/nginx/nginx.conf</span><br><span class="line">worker_processes  1;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    sendfile        on;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line">    upstream wordpress &#123;</span><br><span class="line">        server 192.168.160.111:49156;</span><br><span class="line">        server 192.168.160.111:49157;</span><br><span class="line">        server 192.168.160.111:49158;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        location / &#123;</span><br><span class="line">          proxy_pass http://wordpress;</span><br><span class="line">          proxy_set_header Host $host;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@docker02 ~]# systemctl restart nginx.service</span><br><span class="line"></span><br><span class="line">浏览器访问192.168.160.112</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# docker volume ls</span><br><span class="line">local     wordpress_db_data</span><br><span class="line">local     wordpress_web_data</span><br><span class="line"></span><br><span class="line">[root@docker01 ~]# cd /var/lib/docker/volumes/wordpress_web_data/_data</span><br><span class="line">[root@docker01 _data]# vim info.php </span><br><span class="line">&lt;?php phpinfo(); ?&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">浏览器访问192.168.160.112/info.php，查找Hostname:Port或172.19.0.3:80，刷新浏览器可以确认负载均衡成功</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@docker01 _data]# docker network ls</span><br><span class="line">NETWORK ID     NAME                DRIVER    SCOPE</span><br><span class="line">04590b9a1efc   wordpress_default   bridge    local</span><br><span class="line"></span><br><span class="line">[root@docker01 _data]# docker network inspect 04590b9a1efc</span><br><span class="line">...</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.19.0.3/16&quot;,</span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>浏览器访问192.168.160.112</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220712174334815.png" alt="image-20220712174334815"></p>
</blockquote>
<blockquote>
<p>浏览器访问192.168.160.112&#x2F;info.php，查找Hostname:Port或172.19.0.3:80，刷新浏览器可以确认负载均衡成功</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220712175154873.png" alt="image-20220712175154873"></p>
</blockquote>
<p>P819 07-docker单机编排docker-compose之zabbix</p>
<blockquote>
<p>阿里云docker镜像加速地址：<a target="_blank" rel="noopener" href="https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors">https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors</a></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">[root@docker02 ~]# wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">[root@docker02 ~]# yum install python2-pip -y  # 需要epel源</span><br><span class="line">[root@docker02 ~]# pip install -i https://pypi.tuna.tsinghua.edu.cn/simple docker-compose</span><br><span class="line">报错：</span><br><span class="line">You are using pip version 8.1.2, however version 22.1.2 is available.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">升级pip:</span></span><br><span class="line">[root@docker02 ~]# yum install -y python3-pip</span><br><span class="line">[root@docker02 ~]# pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple pip -U</span><br><span class="line">[root@docker02 ~]# reboot</span><br><span class="line">[root@docker02 ~]# pip --version</span><br><span class="line">pip 21.3.1 from /usr/local/lib/python3.6/site-packages/pip (python 3.6)</span><br><span class="line">[root@docker02 ~]# pip install -i https://pypi.tuna.tsinghua.edu.cn/simple docker-compose</span><br><span class="line">[root@docker02 ~]# docker-compose version</span><br><span class="line">docker-compose version 1.29.2, build unknown</span><br><span class="line">docker-py version: 5.0.3</span><br><span class="line">CPython version: 3.6.8</span><br><span class="line">OpenSSL version: OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">[root@docker02 ~]# cd /opt/</span><br><span class="line">[root@docker02 opt]# mkdir zabbix</span><br><span class="line">[root@docker02 opt]# cd zabbix/</span><br><span class="line">[root@docker02 zabbix]# docker pull mysql:5.7 &amp;&amp; docker pull zabbix/zabbix-java-gateway:latest &amp;&amp; docker pull zabbix/zabbix-server-mysql:latest &amp;&amp; docker pull zabbix/zabbix-web-nginx-mysql:latest</span><br><span class="line">[root@docker02 zabbix]# vim docker-compose.yaml</span><br><span class="line">version: &#x27;3&#x27;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  mysql-server:</span><br><span class="line">    image: mysql:5.7</span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">      MYSQL_DATABASE: zabbix</span><br><span class="line">      MYSQL_USER: zabbix</span><br><span class="line">      MYSQL_PASSWORD: zabbix_pwd</span><br><span class="line">      MYSQL_ROOT_PASSWORD: root_pwd</span><br><span class="line">    command: --character-set-server=utf8 --collation-server=utf8_bin</span><br><span class="line"></span><br><span class="line">  zabbix-java-gateway:</span><br><span class="line">    image: zabbix/zabbix-java-gateway:latest</span><br><span class="line">    restart: always</span><br><span class="line"></span><br><span class="line">  zabbix-server:</span><br><span class="line">    image: zabbix/zabbix-server-mysql:latest</span><br><span class="line">    depends_on:</span><br><span class="line">      - mysql-server</span><br><span class="line">      - zabbix-java-gateway</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;10051:10051&quot;</span><br><span class="line">    environment:</span><br><span class="line">      MYSQL_DATABASE: zabbix</span><br><span class="line">      MYSQL_USER: zabbix</span><br><span class="line">      MYSQL_PASSWORD: zabbix_pwd</span><br><span class="line">      MYSQL_ROOT_PASSWORD: root_pwd</span><br><span class="line">      DB_SERVER_HOST: mysql-server</span><br><span class="line">      ZBX_JAVAGATEWAY: zabbix-java-gateway</span><br><span class="line"></span><br><span class="line">  zabbix-web-nginx-mysql:</span><br><span class="line">    image: zabbix/zabbix-web-nginx-mysql:latest</span><br><span class="line">    depends_on:</span><br><span class="line">      - mysql-server</span><br><span class="line">      - zabbix-server</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;80:8080&quot;  # 与视频不同，需要修改为8080</span><br><span class="line">    environment:</span><br><span class="line">      MYSQL_DATABASE: zabbix</span><br><span class="line">      MYSQL_USER: zabbix</span><br><span class="line">      MYSQL_PASSWORD: zabbix_pwd</span><br><span class="line">      MYSQL_RO0T_PASSWORD: root_pwd</span><br><span class="line">      DB_SERVER_HOST: mysql-server</span><br><span class="line"></span><br><span class="line">[root@docker02 zabbix]# docker-compose up</span><br><span class="line"></span><br><span class="line">浏览器访问192.168.160.112</span><br></pre></td></tr></table></figure>

<blockquote>
<p>浏览器访问192.168.160.112，zabbix 用户:Admin 密码:zabbix</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220713015659741.png" alt="image-20220713015659741"></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@docker02 zabbix]# cat docker-compose.yaml</span><br><span class="line">version: &#x27;3&#x27;</span><br><span class="line"></span><br><span class="line">  zabbix-server:</span><br><span class="line">    image: zabbix/zabbix-server-mysql:latest</span><br><span class="line">    depends_on:</span><br><span class="line">      - mysql-server</span><br><span class="line">      - zabbix-java-gateway</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;10051:10051&quot;</span><br><span class="line">  environment:</span><br><span class="line">    MYSQL DATABASE: zabbix</span><br><span class="line">    MYSQL USER: zabbix</span><br><span class="line">    MYSQL_PASSWORD: zabbix_pwd</span><br><span class="line">    MYSQL_ROOT_PASSWORD: root_pwd</span><br><span class="line">    DB_SERVER_HOST: mysql-server</span><br><span class="line">    ZBX_JAVAGATEWAY: zabbix-java-gateway</span><br><span class="line">    </span><br><span class="line">  zabbix-web-nginx-mysql:</span><br><span class="line">    image: zabbix/zabbix-web-nginx-mysql:latest</span><br><span class="line">    depends_on:</span><br><span class="line">      - mysql-server</span><br><span class="line">      - zabbix-server</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;80:80&quot;</span><br><span class="line">    environment:</span><br><span class="line">      MYSQL DATABASE: zabbix</span><br><span class="line">      MYSQL USER: zabbix</span><br><span class="line">      MYSQL_PASSWORD: zabbix_pwd</span><br><span class="line">      MYSQL_RO0T_PASSWORD: root_pwd</span><br><span class="line">      DB_SERVER_HOST: mysql-server</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>P820 01-企业级私有仓库harbor的搭建和使用</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/goharbor/harbor/blob/release-1.7.0/docs/installation_guide.md">https://github.com/goharbor/harbor/blob/release-1.7.0/docs/installation_guide.md</a><br><a target="_blank" rel="noopener" href="https://github.com/goharbor/harbor/releases">https://github.com/goharbor/harbor/releases</a><br><a target="_blank" rel="noopener" href="https://github.com/goharbor/harbor/releases/tag/v1.5.1">https://github.com/goharbor/harbor/releases/tag/v1.5.1</a></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">harbor:第三方  registry 组件</span><br><span class="line"></span><br><span class="line">registry: 官方</span><br><span class="line">http://10.0.0.11:5000/v2/_catalog</span><br><span class="line">http://10.0.0.11:5000/v2/nginx/tags/list</span><br><span class="line">删除镜像</span><br><span class="line"></span><br><span class="line">权限控制</span><br><span class="line">安装harbor步骤：</span><br><span class="line"></span><br><span class="line">1)上传harbor-offline-installer-v1.5.1.tgz到/opt目录,并解压</span><br><span class="line">[root@docker02 ~]# cd /opt/</span><br><span class="line">[root@docker02 opt]# tar xf harbor-offline-installer-v1.5.1.tar </span><br><span class="line">[root@docker02 opt]# cd harbor/</span><br><span class="line"></span><br><span class="line">2）修改harbor.cfg配置</span><br><span class="line">[root@docker02 harbor]# vim harbor.cfg</span><br><span class="line">hostname = 192.168.160.112  #修改</span><br><span class="line">harbor_admin_password = 1qaz@WSX  #修改</span><br><span class="line"></span><br><span class="line">3）执行安装脚本</span><br><span class="line">[root@docker02 harbor]# ./install.sh</span><br><span class="line"></span><br><span class="line">访问浏览器192.168.160.112</span><br><span class="line">登录Harbor，新建项目 oldboy，访问级别 公开</span><br><span class="line"></span><br><span class="line">上传镜像到harbor</span><br><span class="line">1）修改/etc/docker/daemon.json</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http协议需要添加白名单</span></span><br><span class="line">[root@docker01 ~]# vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://registry.docker-cn.com&quot;],</span><br><span class="line">  &quot;insecure-registries&quot;: [&quot;192.168.160.111:5000&quot;,&quot;192.168.160.112&quot;],  #添加</span><br><span class="line">  &quot;hosts&quot;:[&quot;tcp://0.0.0.0:2376&quot;,&quot;unix:///var/run/docker.sock&quot;]</span><br><span class="line">&#125;</span><br><span class="line">[root@docker01 ~]# systemctl restart docker</span><br><span class="line"></span><br><span class="line">2）打标签</span><br><span class="line">[root@docker01 ~]# docker tag alpine:latest 192.168.160.112/oldboy/alpine:latest</span><br><span class="line"></span><br><span class="line">3）登录私有仓库</span><br><span class="line">[root@docker01 ~]# docker login 192.168.160.112</span><br><span class="line">Username: admin</span><br><span class="line">Password: 1qaz@WSX</span><br><span class="line"></span><br><span class="line">4）上传镜像</span><br><span class="line">[root@docker01 ~]# docker push 192.168.160.112/oldboy/alpine:latest</span><br><span class="line"></span><br><span class="line">测试</span><br><span class="line">[root@docker01 ~]# docker rmi 192.168.160.112/oldboy/alpine:latest</span><br><span class="line">[root@docker01 ~]# docker rmi alpine:latest</span><br><span class="line">[root@docker01 ~]# docker pull 192.168.160.112/oldboy/alpine:latest</span><br></pre></td></tr></table></figure>

<blockquote>
<p>浏览器访问192.168.160.112</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220712233359215.png" alt="image-20220712233359215"></p>
</blockquote>
<blockquote>
<p>上传镜像后docker push 192.168.160.112&#x2F;oldboy&#x2F;alpine:latest</p>
<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220712233838903.png" alt="image-20220712233838903"></p>
</blockquote>
<p>P821 02-将harbor仓库升级为https</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@docker02 harbor]# vim harbor.cfg</span><br><span class="line">ui_url_protocol = https  #修改</span><br><span class="line">ssl_cert = /data/cert/server.crt  # SSL路径</span><br><span class="line">ssl_cert_key = /data/cert/server.key  # SSL路径</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">需要下载证书</span></span><br><span class="line">[root@docker02 harbor]# cd /opt/</span><br><span class="line">[root@docker02 opt]# mkdir cert</span><br><span class="line">[root@docker02 opt]# mv blog.qstack.com.cn.zip cret/</span><br><span class="line">[root@docker02 opt]# cd cert/</span><br><span class="line">[root@docker02 cert]# unzip blog.qstack.com.cn.zip</span><br><span class="line">[root@docker02 cert]# mkdir -p /data/cert</span><br><span class="line">[root@docker02 cert]# cp Nginx/1_blog.qstack.com.cn_bundle.crt /data/cert/server.crt</span><br><span class="line">[root@docker02 cert]# cp Nginx/2_blog.qstack.com.cn.key /data/cert/server.key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改完配置需要将Harbor重新安装，改为后需要删除白名单</span></span><br><span class="line">[root@docker02 cert]# cd /opt/harbor</span><br><span class="line">[root@docker02 harbor]# ./install.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">报错无法登录，实际上是域名没改，以下操作多余</span></span><br><span class="line">[root@docker02 harbor]# docker-compose down</span><br><span class="line">[root@docker02 harbor]# cd /data/</span><br><span class="line">[root@docker02 data]# rm -fr config database job_logs psc redis registry secretkey ca_download</span><br><span class="line">[root@docker02 harbor]# docker-compose up -d</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">实际是修改域名</span></span><br><span class="line">[root@docker02 harbor]# vim harbor.cfg </span><br><span class="line">hostname = blog.qstack.com.cn</span><br><span class="line">[root@docker02 harbor]# docker-compose down</span><br><span class="line">[root@docker02 harbor]# ./install.sh</span><br><span class="line">[root@docker02 harbor]# docker-compose up -d</span><br><span class="line"></span><br><span class="line">登录</span><br><span class="line">[root@docker01 ~]# docker login blog.qstack.com.cn</span><br><span class="line">Username: admin</span><br><span class="line">Password: 1qaz@WSX</span><br><span class="line"></span><br><span class="line">打标签</span><br><span class="line">[root@docker01 ~]# docker tag 192.168.160.112/oldboy/alpine:latest blog.qstack.com.cn/oldboy/alpine:latest</span><br><span class="line"></span><br><span class="line">上传镜像</span><br><span class="line">[root@docker01 ~]# docker push blog.qstack.com.cn/oldboy/alpine:latest</span><br><span class="line"></span><br><span class="line">下载镜像</span><br><span class="line">[root@docker01 ~]# docker pull blog.qstack.com.cn/oldboy/alpine:latest</span><br></pre></td></tr></table></figure>

<p>03-k8s的安装上</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">kubernetes docker管理平台</span><br><span class="line"></span><br><span class="line">概念</span><br><span class="line"></span><br><span class="line">一切皆资源</span><br><span class="line"></span><br><span class="line">安装k8s：</span><br><span class="line">1)源码编译安装，golang编译环境</span><br><span class="line">2)二进制安装文档全程手动，ansible版 saltstack版</span><br><span class="line">3)kubeadm 网络要求    1.0 ~ 1.14</span><br><span class="line">4)minikube 开发者学习</span><br><span class="line">5)yum 安装 1.5.2</span><br><span class="line"></span><br><span class="line">Service discovery and load balancing  服务自动发现和负载均衡</span><br><span class="line"></span><br><span class="line">Self-healing  自愈</span><br><span class="line"></span><br><span class="line">Automated rollouts and rollbacks  一键升级和回滚</span><br><span class="line"></span><br><span class="line">Horizontal scaling  水平扩展（弹性伸缩）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">容器管理平台</span><br><span class="line">docker swarm</span><br><span class="line">messos marathon</span><br><span class="line">kubernetes    google 90%</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line">1：修改IP地址、主机名和host解析</span><br><span class="line">10.0.0.11  k8s-master</span><br><span class="line">10.0.0.12  k8s-node-1</span><br><span class="line">10.0.0.13  k8s-node-2</span><br><span class="line"></span><br><span class="line">vim /etc/hosts</span><br><span class="line">10.0.0.11 k8s-master</span><br><span class="line">10.0.0.12 k8s-node1</span><br><span class="line">10.0.0.13 k8s-node2</span><br><span class="line"></span><br><span class="line">scp -rp /etc/hosts 10.0.0.12:/etc/hosts</span><br><span class="line">scp -rp /etc/hosts 10.0.0.13:/etc/hosts</span><br><span class="line"></span><br><span class="line">cat /etc/hosts</span><br><span class="line">hostnamectl set-hostname k8s-master</span><br><span class="line"></span><br><span class="line">cat /etc/hosts</span><br><span class="line">hostnamectl set-hostname k8s-node1</span><br><span class="line"></span><br><span class="line">cat /etc/hosts</span><br><span class="line">hostnamectl set-hostname k8s-node2</span><br><span class="line"></span><br><span class="line">2：所有节点安装docker-1.12.6-68</span><br><span class="line">https://vault.centos.org/7.4.1708/extras/x86_64/Packages/</span><br><span class="line"></span><br><span class="line">wget https://vault.centos.org/7.4.1708/extras/x86_64/Packages/docker-common-1.12.6-71.git3e8e77d.el7.centos.x86_64.rpm</span><br><span class="line">wget https://vault.centos.org/7.4.1708/extras/x86_64/Packages/docker-client-1.12.6-71.git3e8e77d.el7.centos.x86_64.rpm</span><br><span class="line">wget https://vault.centos.org/7.4.1708/extras/x86_64/Packages/docker-1.12.6-71.git3e8e77d.el7.centos.x86_64.rpm</span><br><span class="line"></span><br><span class="line">yum localinstall docker-common-1.12.6-71.git3e8e77d.el7.centos.x86_64.rpm -y</span><br><span class="line">yum localinstall docker-client-1.12.6-71.git3e8e77d.el7.centos.x86_64.rpm -y</span><br><span class="line">yum localinstall docker-1.12.6-71.git3e8e77d.el7.centos.x86_64.rpm -y</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]# docker version</span><br><span class="line">Client:</span><br><span class="line"> Version:         1.12.6</span><br><span class="line"> API version:     1.24</span><br><span class="line"> Package version: docker-1.12.6-71.git3e8e77d.el7.centos.x86_64</span><br><span class="line"> Go version:      go1.8.3</span><br><span class="line"> Git commit:      3e8e77d/1.12.6</span><br><span class="line"> Built:           Mon Jan 29 20:16:25 2018</span><br><span class="line"> OS/Arch:         linux/amd64</span><br><span class="line">Cannot connect to the Docker daemon. Is the docker daemon running on this host?</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3：master节点安装etcd</span><br><span class="line">yum install etcd -y</span><br><span class="line"></span><br><span class="line">vim /etc/etcd/etcd.conf</span><br><span class="line">6行：ETCD_LISTEN_CLIENT_URLS=&quot;http://0.0.0.0:2379&quot;</span><br><span class="line">21行：ETCD_ADVERTISE_CLIENT_URLS=&quot;http://10.0.0.11:2379&quot;</span><br><span class="line"></span><br><span class="line">systemctl start etcd.service</span><br><span class="line">systemctl enable etcd.service</span><br><span class="line"></span><br><span class="line">etcdctl set testdir/testkey0 0</span><br><span class="line">etcdctl get testdir/testkey0</span><br><span class="line"></span><br><span class="line">etcdctl -C http://10.0.0.11:2379 cluster-health</span><br><span class="line"></span><br><span class="line">4: master节点安装kubernetes</span><br><span class="line">yum install kubernetes-master.x86_64 -y</span><br><span class="line"></span><br><span class="line">vim /etc/kubernetes/apiserver</span><br><span class="line">8行: KUBE_API_ADDRESS=&quot;--insecure-bind-address=0.0.0.0&quot;</span><br><span class="line">11行：KUBE_API_PORT=&quot;--port=8080&quot;</span><br><span class="line">14行: KUBELET_PORT=&quot;--kubelet-port=10250&quot;</span><br><span class="line">17行: KUBE_ETCD_SERVERS=&quot;--etcd-servers=http://10.0.0.11:2379&quot;</span><br><span class="line">23行: KUBE_ADMISSION_CONTROL=&quot;--admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ResourceQuota&quot;</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]# vim /etc/kubernetes/config</span><br><span class="line">22行: KUBE_MASTER=&quot;--master=http://10.0.0.11:8080&quot;</span><br><span class="line"></span><br><span class="line">systemctl enable kube-apiserver.service</span><br><span class="line">systemctl restart kube-apiserver.service</span><br><span class="line">systemctl enable kube-controller-manager.service</span><br><span class="line">systemctl restart kube-controller-manager.service</span><br><span class="line">systemctl enable kube-scheduler.service</span><br><span class="line">systemctl restart kube-scheduler.service</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]# kubectl get componentstatus</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">scheduler            Healthy   ok    </span><br><span class="line"></span><br><span class="line">5：node节点安装kubernetes</span><br><span class="line">yum install kubernetes-node.x86_64 -y</span><br><span class="line"></span><br><span class="line">[root@k8s-node1 ~]# vim /etc/kubernetes/config </span><br><span class="line">22行: KUBE_MASTER=&quot;--master=http://10.0.0.11:8080&quot;</span><br><span class="line"></span><br><span class="line">[root@k8s-node1 ~]# vim /etc/kubernetes/kubelet </span><br><span class="line">5行: KUBELET_ADDRESS=&quot;--address=10.0.0.12&quot;</span><br><span class="line">8行: KUBELET_PORT=&quot;--port=10250&quot;</span><br><span class="line">11行: KUBELET_HOSTNAME=&quot;--hostname-override=10.0.0.12&quot;</span><br><span class="line">14行: KUBELET_API_SERVER=&quot;--api-servers=http://10.0.0.11:8080&quot;</span><br><span class="line"></span><br><span class="line">systemctl enable kubelet.service</span><br><span class="line">systemctl start kubelet.service</span><br><span class="line">systemctl enable kube-proxy.service</span><br><span class="line">systemctl start kube-proxy.service</span><br><span class="line"></span><br><span class="line">[root@k8s-node2 ~]# vim /etc/kubernetes/config </span><br><span class="line">22行: KUBE_MASTER=&quot;--master=http://10.0.0.11:8080&quot;</span><br><span class="line"></span><br><span class="line">[root@k8s-node2 ~]# vim /etc/kubernetes/kubelet </span><br><span class="line">5行: KUBELET_ADDRESS=&quot;--address=0.0.0.0&quot;</span><br><span class="line">8行: KUBELET_PORT=&quot;--port=10250&quot;</span><br><span class="line">11行: KUBELET_HOSTNAME=&quot;--hostname-override=10.0.0.13&quot;</span><br><span class="line">14行: KUBELET_API_SERVER=&quot;--api-servers=http://10.0.0.11:8080&quot;</span><br><span class="line"></span><br><span class="line">systemctl enable kubelet.service</span><br><span class="line">systemctl start kubelet.service</span><br><span class="line">systemctl enable kube-proxy.service</span><br><span class="line">systemctl start kube-proxy.service</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]# kubectl get nodes</span><br><span class="line">NAME        STATUS    AGE</span><br><span class="line">10.0.0.12   Ready     1m</span><br><span class="line">10.0.0.13   Ready     1m</span><br><span class="line"></span><br><span class="line">6：所有节点配置flannel网络</span><br><span class="line">yum install flannel -y</span><br><span class="line"></span><br><span class="line">sed -i &#x27;s#http://127.0.0.1:2379#http://10.0.0.11:2379#g&#x27; /etc/sysconfig/flanneld</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]# etcdctl mk /atomic.io/network/config &#x27;&#123; &quot;Network&quot;: &quot;172.16.0.0/16&quot; &#125;&#x27;</span><br><span class="line">&#123; &quot;Network&quot;: &quot;172.16.0.0/16&quot; &#125;</span><br><span class="line">[root@k8s-master ~]# etcdctl get /atomic.io/network/config</span><br><span class="line">&#123; &quot;Network&quot;: &quot;172.16.0.0/16&quot; &#125;</span><br><span class="line">[root@k8s-master ~]# etcdctl rm /atomic.io/network/config  #删除</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">master节点：</span><br><span class="line">systemctl enable flanneld.service</span><br><span class="line">systemctl start flanneld.service</span><br><span class="line">service docker restart</span><br><span class="line">systemctl restart kube-apiserver.service</span><br><span class="line">systemctl restart kube-controller-manager.service</span><br><span class="line">systemctl restart kube-scheduler.service</span><br><span class="line"></span><br><span class="line">node节点：</span><br><span class="line">systemctl enable flanneld.service</span><br><span class="line">systemctl start flanneld.service</span><br><span class="line">service docker restart</span><br><span class="line">systemctl restart kubelet.service</span><br><span class="line">systemctl restart kube-proxy.service</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]# docker pull busybox</span><br><span class="line">[root@k8s-node1 ~]# docker pull busybox</span><br><span class="line">[root@k8s-node2 ~]# docker pull busybox</span><br><span class="line">[root@k8s-node1 ~]# docker run -it docker.io/busybox:latest</span><br><span class="line">[root@k8s-node2 ~]# docker run -it docker.io/busybox:latest</span><br><span class="line">[root@k8s-master ~]# docker run -it docker.io/busybox:latest</span><br><span class="line">/ # ifconfig  #查看ip</span><br><span class="line">/ # ping -c2 172.16.86.2  #ping通node1</span><br><span class="line">/ # ping -c2 172.16.9.2  #ping通node2</span><br><span class="line">/ # hostname -i</span><br><span class="line">172.16.8.2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">7：配置master为镜像仓库</span><br><span class="line">#master节点</span><br><span class="line">[root@k8s-master ~]# vim /etc/sysconfig/docker</span><br><span class="line">OPTIONS=&#x27;--selinux-enabled --log-driver=journald --signature-verification=false --registry-mirror=https://registry.docker-cn.com --insecure-registry=10.0.0.11:5000&#x27;</span><br><span class="line">[root@k8s-master ~]# systemctl restart docker</span><br><span class="line">[root@k8s-node1 ~]# vim /etc/sysconfig/docker</span><br><span class="line">OPTIONS=&#x27;--selinux-enabled --log-driver=journald --signature-verification=false --registry-mirror=https://registry.docker-cn.com --insecure-registry=10.0.0.11:5000&#x27;</span><br><span class="line">[root@k8s-node1 ~]# systemctl restart docker</span><br><span class="line">[root@k8s-node2 ~]# vim /etc/sysconfig/docker</span><br><span class="line">OPTIONS=&#x27;--selinux-enabled --log-driver=journald --signature-verification=false --registry-mirror=https://registry.docker-cn.com --insecure-registry=10.0.0.11:5000&#x27;</span><br><span class="line">[root@k8s-node2 ~]# systemctl restart docker</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]# docker run -d -p 5000:5000 --restart=always --name registry -v /opt/myregistry:/var/lib/registry registry</span><br><span class="line"></span><br><span class="line">#node节点</span><br><span class="line">vim /etc/sysconfig/docker</span><br><span class="line">OPTIONS=&#x27;--selinux-enabled --log-driver=journald --signature-verification=false --insecure-registry=10.0.0.11:5000&#x27;</span><br><span class="line"></span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://vault.centos.org/7.4.1708/extras/x86_64/Packages/">https://vault.centos.org/7.4.1708/extras/x86_64/Packages/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># vim k8s_pod.yaml</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># cat k8s_pod.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  labels:</span><br><span class="line">    app: web</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: nginx</span><br><span class="line">      image: 10.0.0.11:5000/nginx:1.13</span><br><span class="line">      ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl create -f k8s_pod.yaml </span></span><br><span class="line">pod <span class="string">&quot;nginx&quot;</span> created</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get pods</span></span><br><span class="line">NAME      READY     STATUS              RESTARTS   AGE</span><br><span class="line">nginx     0/1       ContainerCreating   0          55s</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl describe pod nginx</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s-node2 ~]<span class="comment"># vim /etc/kubernetes/kubelet </span></span><br><span class="line">KUBELET_POD_INFRA_CONTAINER=<span class="string">&quot;--pod-infra-container-image=10.0.0.11:5000/rhel7/pod-infrastructure:latest&quot;</span></span><br><span class="line">[root@k8s-node2 ~]<span class="comment"># docker pull docker.io/tianyebj/pod-infrastructure </span></span><br><span class="line">[root@k8s-node2 ~]<span class="comment"># docker tag docker.io/tianyebj/pod-infrastructure 10.0.0.11:5000/rhel7/pod-infrastructure:latest</span></span><br><span class="line">[root@k8s-node2 ~]<span class="comment"># docker push 10.0.0.11:5000/rhel7/pod-infrastructure:latest</span></span><br><span class="line">[root@k8s-node2 ~]<span class="comment"># systemctl restart kubelet.service</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># docker pull nginx</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># docker tag docker.io/nginx:1.13 10.0.0.11:5000/nginx:1.13</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># docker push 10.0.0.11:5000/nginx:1.13</span></span><br><span class="line">1.13</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl describe pod nginx</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get pods</span></span><br><span class="line">NAME      READY     STATUS    RESTARTS   AGE</span><br><span class="line">nginx     1/1       Running   0          39m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get componentstatus</span></span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>&#125;   </span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME        STATUS    AGE</span><br><span class="line">10.0.0.12   Ready     1d</span><br><span class="line">10.0.0.13   Ready     1d</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get pods</span></span><br><span class="line">NAME      READY     STATUS    RESTARTS   AGE</span><br><span class="line">nginx     1/1       Running   0          45m</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># vim k8s_pod.yaml</span></span><br><span class="line">  name: oldboy</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl create -f k8s_pod.yaml </span></span><br><span class="line">pod <span class="string">&quot;oldboy&quot;</span> created</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line">NAME      READY     STATUS              RESTARTS   AGE       IP           NODE</span><br><span class="line">nginx     1/1       Running             0          51m       172.16.4.2   10.0.0.13</span><br><span class="line">oldboy    0/1       ContainerCreating   0          4s        &lt;none&gt;       10.0.0.12</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl describe pod oldboy</span></span><br><span class="line"></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># vim /etc/kubernetes/kubelet</span></span><br><span class="line">KUBELET_POD_INFRA_CONTAINER=<span class="string">&quot;--pod-infra-container-image=10.0.0.11:5000/rhel7/pod-infrastructure:latest&quot;</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># systemctl restart kubelet.service</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># systemctl enable docker</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># systemctl start docker</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line">NAME      READY     STATUS    RESTARTS   AGE       IP            NODE</span><br><span class="line">nginx     1/1       Running   0          57m       172.16.4.2    10.0.0.13</span><br><span class="line">oldboy    1/1       Running   0          6m        172.16.82.2   10.0.0.12</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">创建一个pod资源，为什么会启动两个容器?</span><br><span class="line">pod的ip地址  172.16.4.2</span><br><span class="line">8ef599fc701f  172.16.4.2  pod容器</span><br><span class="line">a59449e2e6f3  容器共用ip  nginx容器</span><br><span class="line"></span><br><span class="line">10w个pod资源</span><br><span class="line"></span><br><span class="line">20w个容器</span><br><span class="line">ef599fc701f  172.16.4.2  pod容器</span><br><span class="line"></span><br><span class="line">a59449e2e6f3  容器共用ip  nginx容器</span><br><span class="line">a59449e2e6f3  容器共用ip  php容器</span><br><span class="line">a59449e2e6f3  容器共用ip  mysql容器</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]# curl -I 172.16.4.2</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.13.12</span><br><span class="line">Date: Mon, 02 May 2022 03:45:27 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 612</span><br><span class="line">Last-Modified: Mon, 09 Apr 2018 16:01:09 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;5acb8e45-264&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s-node2 ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE                                            COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">a59449e2e6f3        10.0.0.11:5000/nginx:1.13                        &quot;nginx -g &#x27;daemon off&quot;   29 minutes ago      Up 29 minutes                           k8s_nginx.91390390_nginx_default_e76c20a0-c9c1-11ec-8bb6-000c29369d51_23d724a8</span><br><span class="line">8ef599fc701f        10.0.0.11:5000/rhel7/pod-infrastructure:latest   &quot;/pod&quot;                   40 minutes ago      Up 40 minutes                           k8s_POD.e5ea03c1_nginx_default_e76c20a0-c9c1-11ec-8bb6-000c29369d51_32fb00f6</span><br><span class="line"></span><br><span class="line">[root@k8s-node2 ~]# docker inspect 8ef599fc701f|grep -i network</span><br><span class="line">[root@k8s-node2 ~]# docker inspect a59449e2e6f3|grep -i network</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>一个pod创建两个容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># docker tag docker.io/busybox:latest 10.0.0.11:5000/busybox:latest</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># docker push 10.0.0.11:5000/busybox:latest</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># vim k8s_pod.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: oldboy</span><br><span class="line">  labels:</span><br><span class="line">    app: web</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: nginx</span><br><span class="line">      image: 10.0.0.11:5000/nginx:1.13</span><br><span class="line">      ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">    - name: busybox</span><br><span class="line">      image: 10.0.0.11:5000/busybox:latest</span><br><span class="line">      <span class="built_in">command</span>: [<span class="string">&quot;sleep&quot;</span>,<span class="string">&quot;3600&quot;</span>]</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get pods</span></span><br><span class="line">NAME      READY     STATUS    RESTARTS   AGE</span><br><span class="line">nginx     1/1       Running   0          1h</span><br><span class="line">oldboy    1/1       Running   0          24m</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl delete pod oldboy</span></span><br><span class="line">pod <span class="string">&quot;oldboy&quot;</span> deleted</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl create -f k8s_pod.yaml </span></span><br><span class="line">pod <span class="string">&quot;oldboy&quot;</span> created</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line">NAME      READY     STATUS    RESTARTS   AGE       IP            NODE</span><br><span class="line">nginx     1/1       Running   0          1h        172.16.4.2    10.0.0.13</span><br><span class="line">oldboy    2/2       Running   0          37s       172.16.82.2   10.0.0.12</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl delete pod --all  #批量删除pod</span></span><br></pre></td></tr></table></figure>





<table>
<thead>
<tr>
<th>Pod基本操作</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>创建</td>
<td>kubectl create -f xxx.yaml</td>
</tr>
<tr>
<td>查询</td>
<td>kubectl get pod yourPodName</td>
</tr>
<tr>
<td>查询</td>
<td>kubectl describe pod yourPodName</td>
</tr>
<tr>
<td>删除</td>
<td>kubectl delete pod yourPodName</td>
</tr>
<tr>
<td>更新</td>
<td>kubectl replace &#x2F;path&#x2F;to&#x2F;yourNewYaml.yaml</td>
</tr>
</tbody></table>
<p>02-rc副本控制器使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># vim nginx-rc.yaml</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># cat nginx-rc.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ReplicationController</span><br><span class="line">metadata:</span><br><span class="line">  name: myweb</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    app: myweb</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: myweb</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: myweb</span><br><span class="line">        image: 10.0.0.11:5000/nginx:1.13</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl create -f nginx-rc.yaml </span></span><br><span class="line">replicationcontroller <span class="string">&quot;myweb&quot;</span> created</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get replicationcontroller</span></span><br><span class="line">NAME      DESIRED   CURRENT   READY     AGE</span><br><span class="line">myweb     2         2         2         27s</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get rc    #简写成rc也可以查询</span></span><br><span class="line">NAME      DESIRED   CURRENT   READY     AGE</span><br><span class="line">myweb     2         2         2         48s</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get pods</span></span><br><span class="line">NAME          READY     STATUS    RESTARTS   AGE</span><br><span class="line">myweb-4b41m   1/1       Running   0          1m</span><br><span class="line">myweb-shrl7   1/1       Running   0          1m</span><br><span class="line">nginx         1/1       Running   0          4h</span><br><span class="line">oldboy        2/2       Running   2          2h</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl delete pod myweb-4b41m    #删除一个pod后立马恢复，rc实现高可用</span></span><br><span class="line">pod <span class="string">&quot;myweb-4b41m&quot;</span> deleted</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get pods</span></span><br><span class="line">NAME          READY     STATUS    RESTARTS   AGE</span><br><span class="line">myweb-9qb67   1/1       Running   0          3s</span><br><span class="line">myweb-shrl7   1/1       Running   0          2m</span><br><span class="line">nginx         1/1       Running   0          4h</span><br><span class="line">oldboy        2/2       Running   2          2h</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl edit rc myweb    #在线编辑k8s资源配置文件</span></span><br><span class="line">spec:</span><br><span class="line">  replicas: 5</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get pods</span></span><br><span class="line">NAME          READY     STATUS    RESTARTS   AGE</span><br><span class="line">myweb-09s0m   1/1       Running   0          1m</span><br><span class="line">myweb-9qb67   1/1       Running   0          5m</span><br><span class="line">myweb-9tp76   1/1       Running   0          1m</span><br><span class="line">myweb-qkm2z   1/1       Running   0          1m</span><br><span class="line">myweb-shrl7   1/1       Running   0          8m</span><br><span class="line">nginx         1/1       Running   0          4h</span><br><span class="line">oldboy        2/2       Running   2          2h</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>03-用rc实现滚动升级和一键回滚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">扩容Pod的副本数目到10</span><br><span class="line">kubectl scale relicationcontroller yourRcName --replicas=10</span><br><span class="line">缩容Pod的副本数目到1</span><br><span class="line">kubectl scale relicationcontroller yourRcName --replicas=1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># docker tag docker.io/nginx:1.15 10.0.0.11:5000/nginx:1.15</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># docker push 10.0.0.11:5000/nginx:1.15</span></span><br><span class="line"></span><br><span class="line">滚动升级</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl rolling-update myweb -f nginx-rc1.15.yaml --update-period=5s</span></span><br><span class="line">回滚</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl rolling-update mywebv2 -f nginx-rc.yaml --update-period=1s</span></span><br><span class="line"></span><br><span class="line">对比两个文件之间的差别</span><br><span class="line">[root@k8s-master ~]<span class="comment"># vimdiff nginx-rc.yaml nginx-rc1.15.yaml </span></span><br></pre></td></tr></table></figure>

<p><img src="D:\文件管理\Typora\images\linux.assest\image-20220502155013798.png" alt="image-20220502155013798"></p>
<p>03-rc-buchong</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">rm</span> -f `docker ps -a -q`    <span class="comment">#批量删除容器</span></span><br><span class="line">docker rmi 10.0.0.11:5000/nginx:1.13    <span class="comment">#删除容器镜像</span></span><br></pre></td></tr></table></figure>





<p>04-service创建和访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line">NAME          READY     STATUS    RESTARTS   AGE       IP            NODE</span><br><span class="line">myweb-6fpw2   1/1       Running   0          1h        172.16.82.3   10.0.0.12</span><br><span class="line">myweb-h1zp6   1/1       Running   0          1h        172.16.4.3    10.0.0.13</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl describe pod myweb-6fpw2</span></span><br><span class="line">Labels:		app=myweb</span><br><span class="line">[root@k8s-master ~]<span class="comment"># vim nginx-svc.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: myweb</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - port: 80</span><br><span class="line">      nodePort: 30000</span><br><span class="line">      targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: myweb</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl create -f nginx-svc.yaml </span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get service</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get svc</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># vim nginx-svc.yaml</span></span><br><span class="line"><span class="comment">#      targetPort: 80</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl apply -f nginx-svc.yaml    #存在就配置，不存在就创建</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get svc</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl delete svc myweb</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl apply -f nginx-svc.yaml</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get svc</span></span><br><span class="line">NAME         CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes   10.254.0.1       &lt;none&gt;        443/TCP        1d</span><br><span class="line">myweb        10.254.141.141   &lt;nodes&gt;       80:32141/TCP   13m</span><br><span class="line"></span><br><span class="line">浏览器访问http://10.0.0.12:32141/</span><br></pre></td></tr></table></figure>



<p>05-k8s小结</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">修改service的端口范围,默认30000起</span><br><span class="line">[root@k8s-master ~]<span class="comment"># vim /etc/kubernetes/apiserver</span></span><br><span class="line">KUBE_API_ARGS=<span class="string">&quot;--service-node-port-range=3000-50000&quot;</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># systemctl restart kube-apiserver.service</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl describe svc myweb</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">service默认是负载均衡，访问10.0.0.12:32141，以下修改文件测试</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get svc</span></span><br><span class="line">NAME         CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes   10.254.0.1       &lt;none&gt;        443/TCP        2d</span><br><span class="line">myweb        10.254.141.141   &lt;nodes&gt;       80:32141/TCP   1d</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl exec -it myweb-6fpw2 /bin/bash    #k8s进入容器</span></span><br><span class="line">root@myweb-6fpw2:/<span class="comment"># cd /usr/share/nginx/html/</span></span><br><span class="line">root@myweb-6fpw2:/usr/share/nginx/html<span class="comment"># ls</span></span><br><span class="line">50x.html  index.html</span><br><span class="line">[root@myweb-6fpw2:/usr/share/nginx/html<span class="comment"># echo &#x27;myweb-6fpw2&#x27; &gt;index.html</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl explain service    #查看ymal帮助文档</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl explain service.spec    #查看帮助文档下一级</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># vim nginx-svc.yaml    #手动固定VIP地址</span></span><br><span class="line">spec:</span><br><span class="line">  clusterIP: 10.254.100.100</span><br><span class="line">  </span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl describe node 10.0.0.12    #查看节点配置信息</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">有一个应用，想在k8s里面跑起来，希望k8s提供高可用，还能被外界访问?</span><br><span class="line"></span><br><span class="line">rc ＋ svc</span><br><span class="line"></span><br><span class="line">kubectl exec -it podname /bin/bash(/bin/sh) 进入到pod</span><br><span class="line"></span><br><span class="line">ymal:</span><br><span class="line">kubectl explain pod, svc, rc</span><br><span class="line"></span><br><span class="line">rc的滚动升级，一键回滚</span><br><span class="line"></span><br><span class="line">pod最小的资源单位</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>06-deployment相对于rc的优势</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get all    #查看全部</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># vim nginx-deploy.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deployment</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: 10.0.0.11:5000/nginx:1.13</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        resources:</span><br><span class="line">        limits:</span><br><span class="line">          cpu: 100m</span><br><span class="line">        requests:</span><br><span class="line">          cpu: 100m</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl create -f nginx-deploy.yaml    #创建deployment</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get all</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get all -o wide</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl edit svc myweb    #修改service标签为nginx</span></span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">    </span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># curl -I 172.16.4.2    #查看当前版本为1.13</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.13.12</span><br><span class="line"></span><br><span class="line"><span class="comment">#deployment修改配置文件后，滚动升级为1.15，rc需要重启pod才能生效</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl edit deployment nginx-deployment</span></span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: 10.0.0.11:5000/nginx:1.15</span><br><span class="line"></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># curl -I 172.16.4.2    #查看当前版本为1.15</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.15.12</span><br><span class="line"></span><br><span class="line"><span class="comment">#rs不能手动创建，但可以查看配置文件</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl edit rs nginx-deployment-2764750812</span></span><br><span class="line"><span class="comment">#查看deployment历史版本</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl rollout history deployment nginx-deployment</span></span><br><span class="line"><span class="comment">#deployment回滚旧版本</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl rollout undo deployment nginx-deployment --to-revision=1</span></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># curl -I 172.16.4.2    #回滚后查看当前版本为1.13</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.13.12</span><br><span class="line"></span><br><span class="line"><span class="comment">#deployment除了yaml文件创建，还可以命令行创建，加上--record会把命令记录到CHANGE-CAUSE日志</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl run oldboy --image=10.0.0.11:5000/nginx:1.13 --replicas=3 --record</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl rollout history deployment oldboy</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get all -o wide</span></span><br><span class="line"><span class="comment">#给oldboy容器设置镜像，这种方式能把命令记录到CHANGE-CAUSE日志</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl set image deployment oldboy oldboy=10.0.0.11:5000:nginx:1.15</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl rollout history deployment oldboy</span></span><br><span class="line">deployments <span class="string">&quot;oldboy&quot;</span></span><br><span class="line">REVISION	CHANGE-CAUSE</span><br><span class="line">1		kubectl run oldboy --image=10.0.0.11:5000/nginx:1.13 --replicas=3 --record</span><br><span class="line">2		kubectl <span class="built_in">set</span> image deployment oldboy oldboy=10.0.0.11:5000:nginx:1.15</span><br><span class="line"></span><br><span class="line"><span class="comment">#命令创建svc，暴露端口</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl expose deployment oldboy --port=80 --type=NodePort</span></span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#设置支持命令行补全kubectl</span></span><br><span class="line">1.安装bash-completion工具</span><br><span class="line">[root@k8s-master ~]<span class="comment"># yum install bash-completion -y</span></span><br><span class="line">2.执行bash_completion</span><br><span class="line">[root@k8s-master ~]<span class="comment"># source /usr/share/bash-completion/bash_completion</span></span><br><span class="line">3.加载kubectl completion</span><br><span class="line"><span class="comment">#在bash中设置当前shell的自动补全，要先安装bash-completion包。</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># source &lt;(kubectl completion bash)</span></span><br><span class="line"><span class="comment">#在您的 bash shell中永久的添加自动补全</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc</span></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">deployment对比rc</span><br><span class="line">rc：edit修改rc的配置，只有启动新pod的时候才生效</span><br><span class="line">rc滚动升级之后，pod的标签也升级了，导致svc关联不上</span><br><span class="line"></span><br><span class="line">rc执行滚动升级需要配置文件（需要依赖yaml文件）</span><br><span class="line">kubectl rolling-update myweb -f nginx-rc1.15.yaml --update-period=1s</span><br><span class="line"></span><br><span class="line">rs有rc的95%功能，rs由deployment自动创建</span><br><span class="line">1.13</span><br><span class="line">1.15</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>07-k8s的volume持久化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">volume 持久化</span><br><span class="line"></span><br><span class="line">pv 持久化存储        对接来源</span><br><span class="line">pvc 持久化存储，分配  只负责用</span><br></pre></td></tr></table></figure>



<p>08-heapster监控的安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">HPA: pod的水平自动扩展（弹性伸缩max,min）</span><br><span class="line"></span><br><span class="line">微服务，开发架构，拆业务</span><br><span class="line"></span><br><span class="line">京东商城  一套lnmp    mysql</span><br><span class="line">事务 数据的一致性</span><br><span class="line"></span><br><span class="line">www.jd.com 首页</span><br><span class="line">www.jd.com/miaosha/index.html</span><br><span class="line">www.jd.com/paimai/index.html</span><br><span class="line">www.jd.com/chaoshi/index.html</span><br><span class="line"></span><br><span class="line">www.jd.com 首页  5张表</span><br><span class="line">login.jd.com  登录  用户表  token令牌</span><br><span class="line">miaosha.jd.com/index.html</span><br><span class="line">paimaijd.com/index.html</span><br><span class="line">chaoshi.jd.com/index.html</span><br><span class="line">消息队列，事务的一致性功能  部署，高可用。持久化。备份。监控</span><br><span class="line"></span><br><span class="line">买东西</span><br><span class="line">商品，价格，商品id，商品型号  item.jd.com</span><br><span class="line">						  car.jd.com</span><br><span class="line"></span><br><span class="line">51cto.com  微信登录</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">实现HPA：</span><br><span class="line">1)搭建k8s监控</span><br><span class="line">heapster</span><br><span class="line">创建一个目录，上传5个yaml文件</span><br><span class="line">2）上传三个docker镜像到私有仓库</span><br><span class="line">for n in `ls *.tar.gz`;do docker load -i $n ;done</span><br><span class="line">docker tag docker.io/kubernetes/heapster_grafana:v2.6.0 10.0.0.11:5000/heapster_grafana:v2.6.0</span><br><span class="line">docker tag docker.io/kubernetes/heapster_influxdb:v0.5 10.0.0.11:5000/heapster influxdb:v0.5</span><br><span class="line">docker tag docker.io/kubernetes/heapster:canary 10.0.0.11:5000/heapster:canary</span><br><span class="line">docker push 10.0.0.11:5000/heapster_grafana:v2.6.0</span><br><span class="line">docker push 10.0.0.11:5000/heapster_influxdb:v0.5</span><br><span class="line">docker push 10.0.0.11:5000/heapster:canary</span><br><span class="line"></span><br><span class="line">3) 创建资源</span><br><span class="line">kubectl create -f .</span><br><span class="line"></span><br><span class="line">4) 验证</span><br><span class="line">kubectl get all --namespace=kube-system</span><br><span class="line"></span><br><span class="line">b) 搭建dashboard</span><br><span class="line">1) 上传dashboard镜像到私有仓库</span><br><span class="line"></span><br><span class="line">2) 根据yaml创建k8s资源</span><br><span class="line">[root@k8s-master ~]# kubectl create -f dashboard.yaml</span><br><span class="line">[root@k8s-master ~]# kubectl create -f dashboard-svc.yaml</span><br><span class="line">[root@k8s-master ~]# kubectl get all --namespace=kube-system</span><br><span class="line"></span><br><span class="line">3) 访问dashboard</span><br><span class="line">http://10.0.0.11:8080/ui/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2)创建HPA,pod最小数量1，pod最大数量8,cpu使用率百分比做为触发条件</span><br><span class="line">[root@k8s-master ~]# kubectl create -f nginx-deploy-hpa.yaml</span><br><span class="line">[root@k8s-master ~]# kubectl autoscale deployment nginx-deployment --max=8 --min=1 --cpu-percent=5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">namespache:资源隔离</span><br><span class="line"></span><br><span class="line">wordpress业务 mysql</span><br><span class="line">discuz业务    mysql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  ports:</span><br><span class="line">    - port: 80</span><br><span class="line">      targetPort: 9090</span><br><span class="line"></span><br><span class="line">http://10.0.0.11:8080/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># docker pull docker.io/kubernetes/heapster_influxdb:v0.5</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># docker pull docker.io/kubernetes/heapster_grafana:v2.6.0</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># docker pull docker.io/kubernetes/heapster:canary</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># docker pull influxdb</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># docker search grafana    #查询镜像</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># docker pull grafana</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># docker pull heapster</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master heapster-influxdb]<span class="comment"># vim influxdb-grafana-controller.yaml </span></span><br><span class="line">[root@k8s-master heapster-influxdb]<span class="comment"># cat influxdb-grafana-controller.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ReplicationController</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    name: influxGrafana</span><br><span class="line">  name: influxdb-grafana</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    name: influxGrafana</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: influxGrafana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: influxdb</span><br><span class="line">        image: 10.0.0.11:5000/heapster_influxdb:v0.5</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /data</span><br><span class="line">          name: influxdb-storage</span><br><span class="line">      - name: grafana</span><br><span class="line">        image: 10.0.0.11:5000/heapster_grafana:v2.6.0</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">          - name: INFLUXDB_SERVICE_URL</span><br><span class="line">            value: http://monitoring-influxdb:8086</span><br><span class="line">            <span class="comment"># The following env variables are required to make Grafana accessible via</span></span><br><span class="line">            <span class="comment"># the kubernetes api-server proxy. On production clusters, we recommend</span></span><br><span class="line">            <span class="comment"># removing these env variables, setup auth for grafana, and expose the grafana</span></span><br><span class="line">            <span class="comment"># service using a LoadBalancer or a public IP.</span></span><br><span class="line">          - name: GF_AUTH_BASIC_ENABLED</span><br><span class="line">            value: <span class="string">&quot;false&quot;</span></span><br><span class="line">          - name: GF_AUTH_ANONYMOUS_ENABLED</span><br><span class="line">            value: <span class="string">&quot;true&quot;</span></span><br><span class="line">          - name: GF_AUTH_ANONYMOUS_ORG_ROLE</span><br><span class="line">            value: Admin</span><br><span class="line">          - name: GF_SERVER_RO0T_URL</span><br><span class="line">            value: /api/v1/proxy/namespaces/kube-system/services/monitoring-grafana/</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /var</span><br><span class="line">          name: grafana-storage</span><br><span class="line">      volumes:</span><br><span class="line">      - name: influxdb-storage</span><br><span class="line">        emptyDir: &#123;&#125;      </span><br><span class="line">      - name: grafana-storage</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line"></span><br><span class="line">[root@k8s-master heapster-influxdb]<span class="comment"># vim heapster-controller.yaml</span></span><br><span class="line">[root@k8s-master heapster-influxdb]<span class="comment"># cat heapster-controller.yaml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ReplicationController</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: heapster</span><br><span class="line">    name: heapster</span><br><span class="line">    version: v6</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: heapster</span><br><span class="line">    version: v6</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: heapster</span><br><span class="line">        version: v6</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: heapster</span><br><span class="line">        image: 10.0.0.11:5000/heapster:canary</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - /heapster</span><br><span class="line">        - --<span class="built_in">source</span>=kubernetes:http://10.0.0.11:8080?inClusterConfig=<span class="literal">false</span></span><br><span class="line">        - --sink=influxdb:http://monitoring-influxdb:8086</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># docker tag docker.io/kubernetes/heapster_grafana:v2.6.0 10.0.0.11:5000/heapster_grafana:v2.6.0</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># docker tag docker.io/kubernetes/heapster_influxdb:v0.5 10.0.0.11:5000/heapster_influxdb:v0.5</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># docker tag docker.io/kubernetes/heapster:canary 10.0.0.11:5000/heapster:canary</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># docker push 10.0.0.11:5000/heapster_grafana:v2.6.0</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># docker push 10.0.0.11:5000/heapster_influxdb:v0.5</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># docker push 10.0.0.11:5000/heapster:canary</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master heapster-influxdb]<span class="comment"># kubectl create -f .</span></span><br><span class="line">[root@k8s-master heapster-influxdb]<span class="comment"># kubectl get all --namespace=kube-system</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># docker tag index.tenxcloud.com/google_containers/kubernetes-dashboard-amd64:v1.4.1 10.0.0.11:5000/kubernetes-dashboard-amd64:v1.4.1</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># docker push 10.0.0.11:5000/kubernetes-dashboard-amd64:v1.4.1</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># vim dashboard.yaml</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># vim dashboard-svc.yaml</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl create -f dashboard.yaml</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl create -f dashboard-svc.yaml</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get all --namespace=kube-system</span></span><br><span class="line"></span><br><span class="line">访问http://10.0.0.11:8080/ui</span><br><span class="line">访问http://10.0.0.11:8080/api/v1/proxy/namespaces/kube-system/services/kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">vim nginx-deploy-hpa.yaml</span><br><span class="line">[root@k8s-master heapster-influxdb]<span class="comment"># kubectl create -f nginx-deploy-hpa.yaml</span></span><br><span class="line">kubectl delete deployment --all</span><br><span class="line">kubectl create -f nginx-deploy-hpa.yaml</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl autoscale deployment nginx-deployment --max=8 --min=1 --cpu-percent=5</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># while true;do curl 172.16.82.2;done    #压力测试nginx</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master heapster-influxdb]<span class="comment"># kubectl get all --all-namespaces</span></span><br><span class="line">    <span class="comment">#显示所有资源</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl edit svc --namespace=kube-system kubernetes-dashboard </span></span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line"></span><br><span class="line">访问http://10.0.0.12:35651</span><br></pre></td></tr></table></figure>



<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">编辑skydns-rc.yaml文件</span></span><br><span class="line"><span class="comment"># Copyright 2016 The Kubernetes Authors.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TODO-At some point, we need to rename all skydns-*.yaml.* files to kubedns-*.yaml.*</span></span><br><span class="line"><span class="comment"># _MACHINE_GENERATED_WARNING_</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deploymentp</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-dns</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line">    <span class="attr">kubernetes.io/cluster-service:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">spec:</span></span><br><span class="line">    <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">    <span class="comment"># replicas: not specified here:</span></span><br><span class="line">    <span class="comment"># 1. In order to make Addon Manager do not reconcile this replicas parameter.</span></span><br><span class="line">    <span class="comment"># 2.Default is 1.</span></span><br><span class="line">    <span class="comment"># 3.Will be tuned in real time if DNS horizontal auto-scaling is turned on.</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">rollingUpdate:</span></span><br><span class="line">        <span class="attr">maxSurge:</span> <span class="number">10</span><span class="string">%</span></span><br><span class="line">        <span class="attr">maxUnavailable:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">selector:</span></span><br><span class="line">      <span class="attr">matchLabels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">metadata:</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">scheduler.alpha.kubernetes.io/critical-pod:</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">          scheduler.alpha.kubernetes.io/tolerations:  &#x27;[&#123;&quot;</span><span class="string">key&quot;:&quot;CriticalAddonsOnly&quot;,&quot;operator&quot;:&quot;Exists&quot;&#125;]&#x27;</span></span><br><span class="line">      <span class="attr">spec:</span></span><br><span class="line">        <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">name:kubednsw</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">myhub.fdccloud.com/library/kubedns-amd64:1.9</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="comment"># <span class="doctag">TODO:</span> Set memory limits when we&#x27;ve profiled the container for large</span></span><br><span class="line">            <span class="comment"># clusters, then set request = limit to keep this container in</span></span><br><span class="line">            <span class="comment"># guaranteed class. Currently, this container falls into the</span></span><br><span class="line">            <span class="comment"># &quot;burstable&quot; category so the kubelet doesn&#x27;t backoff from restarting it.</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">170Mi</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="string">cpu</span> <span class="string">100m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">70Mi</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/healthz-kubedns</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/readiness</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="comment"># we poll on pod startup for the Kubernetes service and</span></span><br><span class="line">            <span class="comment"># only setup the /readiness HTTP server once that&#x27;s available.</span></span><br><span class="line">            <span class="attr">initialDelaySenconds:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--domain=cluster.local.</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--dns-port=10053</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--config-map=kube-dns</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--kube-master-url=http://10.0.0.11:8080</span>  <span class="comment">#需修改</span></span><br><span class="line">          <span class="comment"># This should be set to v=2 only after the new image (cut from 1.5) has</span></span><br><span class="line">          <span class="comment"># been released,otherwise we will flood the logs.</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--V=0</span></span><br><span class="line">          <span class="comment">#_PILLAR_FEDERATIONS_DOMAIN_MAP_</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROMETHEUS_PORT</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;10055&quot;</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">10053</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">dns-local</span></span><br><span class="line">            <span class="attr">protocol:</span> <span class="string">UDP</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">10053</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">dns-tcp-local</span></span><br><span class="line">            <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">10055</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">metrics</span></span><br><span class="line">            <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dnsmasq</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">myhub.fdccloud.com/library/kube-dnsmasq-amd64:1.4</span></span><br><span class="line">            <span class="attr">livenessProbe:</span></span><br><span class="line">              <span class="attr">httpGet:</span></span><br><span class="line">                <span class="attr">path:</span> <span class="string">/healthz-dnsmasg</span></span><br><span class="line">                <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">                <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">              <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">              <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">              <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">              <span class="attr">failureThreshold:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--cache-size=1000</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--no-resolv</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--server=127.0.0.1#10053</span></span><br><span class="line">            <span class="comment">#- --log-facility=-</span></span><br><span class="line">            <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">53</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">dns</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">UDP</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">53</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">dns-tcp</span></span><br><span class="line">              <span class="string">protocol:TCP</span></span><br><span class="line">            <span class="comment"># see: https://github.com/kubernetes/kubernetes/issues/29055 for details</span></span><br><span class="line">            <span class="attr">resources:</span></span><br><span class="line">              <span class="attr">requests:</span></span><br><span class="line">                <span class="attr">cpu:</span> <span class="string">150m</span></span><br><span class="line">                <span class="attr">memory:</span> <span class="string">10Mi</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dnsmasq-metrics+</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">myhub.fdccloud.com/library/dnsmasq-metrics-amd64:1.0</span></span><br><span class="line">            <span class="attr">livenessProbe:</span></span><br><span class="line">              <span class="attr">httpGet:</span></span><br><span class="line">                <span class="string">path:/metrics</span></span><br><span class="line">                <span class="string">port:10054</span></span><br><span class="line">                <span class="attr">scheme:</span> <span class="string">HTTP&amp;</span></span><br><span class="line">              <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">              <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">              <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">              <span class="attr">failureThreshold:</span> <span class="number">5</span></span><br><span class="line">            <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--V=2</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--logtostderr</span></span><br><span class="line">            <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">10054</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">metrics</span></span><br><span class="line">                <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">            <span class="attr">resources:</span></span><br><span class="line">              <span class="attr">requests:</span></span><br><span class="line">                <span class="attr">memory:</span> <span class="string">10Mi</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">healthz</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">myhub.fdccloud.com/library/exechealthz-amd64:1.2</span></span><br><span class="line">            <span class="attr">resources:</span></span><br><span class="line">              <span class="attr">limits:</span></span><br><span class="line">                <span class="attr">memory:</span> <span class="string">50Mi</span></span><br><span class="line">              <span class="attr">requests:</span></span><br><span class="line">                <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">                <span class="comment"># Note that this container shouldn&#x27;t really need 50Mi of memory.The</span></span><br><span class="line">                <span class="comment"># limits are set higher than expected pending investigation on #29688.</span></span><br><span class="line">                <span class="comment"># The extra memory was stolen from the kubedns container to keep the</span></span><br><span class="line">                <span class="comment"># net memory requested by the pod constant.</span></span><br><span class="line">                <span class="attr">memory:</span> <span class="string">50Mi</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">--cmd=nslookup</span> <span class="string">kubernetes.default.svc.cluster.local</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="string">&gt;/dev/null</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">--url=/healthz-dnsmasq</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">--cmd=nslookup</span> <span class="string">kubernetes.default.svc.cluster.local</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:10053</span> <span class="string">&gt;/dev/null</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">--url=/healthz-kubedns</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">--port=8080</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">--quiet</span></span><br><span class="line">              <span class="attr">ports:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">                <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">            <span class="attr">dnsPolicy:</span> <span class="string">Default</span> <span class="comment"># Don&#x27;t use cluster DNS.</span></span><br></pre></td></tr></table></figure>





<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">编辑skydns-svc.yaml文件</span></span><br><span class="line"><span class="comment"># Copyright 2016 The Kubernetes Authors.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#+</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TODO - At some point, we need to rename all skydns-*.yaml.* files to kubedns-*.yaml.*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Warning: This is a file generated from the base underscore template file: skydns-svc.yaml.base</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-dns</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line">    <span class="attr">kubernetes.io/cluster-service:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">kubernetes.io/name:</span> <span class="string">&quot;KubeDNS&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">  <span class="attr">k8s-app:</span> <span class="string">kube-dns</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.254</span><span class="number">.230</span><span class="number">.254</span>  <span class="comment">#需修改</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dns</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">53</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">UDP</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dns-tcp</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">53</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f skydns-rc.yaml</span><br><span class="line">kubectl create -f skydns-svc.yaml</span><br><span class="line">kubectl describe pod --namespace=oldboy oldboy</span><br><span class="line"></span><br><span class="line">[root@k8s-node1 ~]# vim /etc/kubernetes/kubelet</span><br><span class="line">KUBELET_ARGS=&quot;--cluster_dns=10.254.230.254 --cluster_domain=cluster.local&quot;</span><br><span class="line">[root@k8s-node1 ~]# systemctl restart kubelet.service</span><br></pre></td></tr></table></figure>



<p>03-在k8s中运行自己的kod项目</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># vim kod-deploy.yaml</span></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kod</span><br><span class="line">  namespace: kod</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: kod</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kod</span><br><span class="line">        image: docker.io/t29617342/kod:v2</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /var/www/html</span><br><span class="line">          name: kod</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">      volumes:</span><br><span class="line">      - name: kod</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl create ns kod    #创建命名空间</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl create -f kod-deploy.yaml</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># vim kod-svc.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kod</span><br><span class="line">  namespace: kod</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - port: 80</span><br><span class="line">      targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: kod</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl create -f kod-svc.yaml</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get all --namespace=kod -o wide</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl apply -f kod-svc.yaml    #更新yaml</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl replace -f kod-svc.yaml    #更新yaml</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># netstat -lntup    #常用查看端口</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl scale deployment kod --replicas=3 --namespace=kod    #调整副本数为3</span></span><br><span class="line">[root@k8s-master ~]<span class="comment"># vim kod-deploy.yaml    #修改卷的持久化</span></span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kod</span><br><span class="line">        image: docker.io/t29617342/kod:v2</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /var/www/html    <span class="comment">#挂载到哪个目录下面</span></span><br><span class="line">          name: kod    <span class="comment">#声明卷的名字</span></span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">      volumes:</span><br><span class="line">      - name: kod    <span class="comment">#设置volumes，指定名字kod，声明自动创建</span></span><br><span class="line">        emptyDir: &#123;&#125;    <span class="comment">#本地存储</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl apply -f kod-deploy.yaml</span></span><br><span class="line"></span><br><span class="line">[root@k8s-node1 ~]<span class="comment"># docker volume ls</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl describe pod --namespace=kod kod-657026764-6ck1q</span></span><br></pre></td></tr></table></figure>



<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kod处理session的方式</span></span><br><span class="line"><span class="string">pod</span></span><br><span class="line"><span class="string">pod</span></span><br><span class="line"><span class="string">pod</span></span><br><span class="line"></span><br><span class="line"><span class="string">pod</span> <span class="string">/var/www/html</span> <span class="string">持久化</span></span><br><span class="line"></span><br><span class="line"><span class="string">安装pv和pvc</span></span><br><span class="line"><span class="string">pv：提供存储空间</span>  <span class="string">pV打标签</span></span><br><span class="line"><span class="string">pvc：使用pv</span>  <span class="string">label标签选择器</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">1</span><span class="string">：安装nfs服务端</span></span><br><span class="line">[<span class="string">root@k8s-master</span> <span class="string">~</span>]<span class="comment"># yum install nfs-utils.x86_64 -y  #安装nfs</span></span><br><span class="line"><span class="string">配置启动</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span><span class="string">：所有node安装客户端</span></span><br><span class="line">[<span class="string">root@k8s-node1</span> <span class="string">~</span>]<span class="comment"># yum install nfs-utils.x86_64 -y</span></span><br><span class="line">[<span class="string">root@k8s-node2</span> <span class="string">~</span>]<span class="comment"># yum install nfs-utils.x86_64 -y</span></span><br><span class="line"><span class="string">检查</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@k8s-master</span> <span class="string">~</span>]<span class="comment"># vim /etc/exports</span></span><br><span class="line"><span class="string">/data/kod</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24(rw,async,no_root_squash,no_all_squash)</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@k8s-master</span> <span class="string">~</span>]<span class="comment"># systemctl restart rpcbind</span></span><br><span class="line">[<span class="string">root@k8s-master</span> <span class="string">~</span>]<span class="comment"># systemctl restart nfs</span></span><br><span class="line">[<span class="string">root@k8s-master</span> <span class="string">~</span>]<span class="comment"># showmount -e 10.0.0.11</span></span><br><span class="line"><span class="attr">Export list for 10.0.0.11:</span></span><br><span class="line"><span class="string">/data/kod</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span><span class="string">：创建pv和pvc</span></span><br><span class="line">[<span class="string">root@k8s-master</span> <span class="string">~</span>]<span class="comment"># vim kod_pv.yaml</span></span><br><span class="line">[<span class="string">root@k8s-master</span> <span class="string">~</span>]<span class="comment"># cat kod_pv.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kod</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nfs001</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&quot;/data/kod&quot;</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.11</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@k8s-master</span> <span class="string">~</span>]<span class="comment"># vim kod_pvc.yaml </span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@k8s-master</span> <span class="string">~</span>]<span class="comment"># kubectl get pv</span></span><br><span class="line">[<span class="string">root@k8s-master</span> <span class="string">~</span>]<span class="comment"># kubectl get pvc</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@k8s-master</span> <span class="string">~</span>]<span class="comment"># vim kod-deploy.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kod</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">kod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kod</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/t29617342/kod:v2</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/www/html</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">kod-1</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kod-1</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">kod</span></span><br><span class="line">          </span><br><span class="line"></span><br></pre></td></tr></table></figure>







<h1 id="KVM"><a href="#KVM" class="headerlink" title="KVM"></a>KVM</h1><p>01-虚拟化的介绍和应用场景  P841</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">宿主机：内存4G+  纯净的系统Cent0S-7</span><br><span class="line"></span><br><span class="line">1：什么是虚拟化？</span><br><span class="line">虚拟化，通过模拟计算机的硬件，来实现在同一台计算机上同时运行多个不同的操作系统的技术。</span><br><span class="line"></span><br><span class="line">2：为什么要用虚拟化？</span><br><span class="line">阿里云  kvm开源</span><br><span class="line">AWS  kvm</span><br><span class="line">azure</span><br><span class="line">vmware ESXI商业软件</span><br><span class="line"></span><br><span class="line">没有虚拟化之前：</span><br><span class="line">计算机的硕件配置越来越高</span><br><span class="line"></span><br><span class="line">512G 内存，4路 8核16线程，12* PCI-E 1T的SSD;</span><br><span class="line">ntp服务，安装多个mysql，安装多个tomcat，安装....</span><br><span class="line"></span><br><span class="line">linux开源的，很多软件都有依赖包openssl  nginx</span><br><span class="line"></span><br><span class="line">充分利用资源，软件运行环境的隔离，只有虚拟化才行实现。</span><br><span class="line"></span><br><span class="line">场景1：同一台物理机运行多个php版本 php5.3(openssl,gd) php5.5 php7.2</span><br><span class="line"></span><br><span class="line">场景2：机房的迁移，解决了硬件和系统的依赖</span><br><span class="line"></span><br><span class="line">场景3：openstack环境，软件发布方式</span><br><span class="line"></span><br><span class="line">场景4：开发环境和测试环境，使用虚拟化</span><br><span class="line">只靠一台物理服务器，30台虚拟机</span><br><span class="line"></span><br><span class="line">产品 -- 开发 -- 运维 -- 测试</span><br><span class="line">so结尾，1inux 库文件</span><br><span class="line"></span><br><span class="line">场景5：业务的快速部署</span><br><span class="line">从头安装系统，安装服务，配置</span><br><span class="line">克隆虚拟机，改ip，</span><br><span class="line"></span><br><span class="line">虚拟化：提高了资源的利用率，各个服务的安全性隔离，解决了系统和硬件之间的依赖</span><br><span class="line"></span><br><span class="line">3：kvm虚拟化管理软件的安装</span><br><span class="line">yum install libvirt virt-install qemu-kvm -y</span><br><span class="line"></span><br><span class="line">KVM: Kernel-based Virtual Machine</span><br><span class="line"></span><br><span class="line">1ibvirt  作用：虚拟机的管理软件</span><br><span class="line">libvirt: kvm,xen,qemu,lxc....</span><br><span class="line"></span><br><span class="line">virt  virt-install virt-clone  作用：虚拟机的安装工具和克隆工具</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">云计算是一种按量付费的模式，底层通过虚拟化技术来实现。</span><br><span class="line"></span><br><span class="line">服务器硬件配置：</span><br><span class="line">web dell R720 2c4g</span><br><span class="line"></span><br><span class="line">4颗 10核20线程，6T内存，16块，sas 300G，600G；sata 4T  raid10</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;192.168.15.84 mirrors.aliyun.com&#x27; &gt;&gt;/etc/hosts</span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><span class="line">10.0.0.11 宿主机</span><br><span class="line"></span><br><span class="line">建议虚拟机内存不要低于1024M，否则安装系统特别慢！</span><br><span class="line">virt-install --virt-type kvm --os-type=linux --os-variant rhel7 --name centos7 --memory 1024 --vcpus 1 --disk /opt/centos2.raw,format=raw,size=10 --cdrom /opt/CentOS-7-x86_64-DVD-1708.iso --network network=default --graphics vnc,listen=0.0.0.0 --noautoconsole</span><br><span class="line"></span><br><span class="line">vnc: 10.0.0.11:5900</span><br><span class="line">--virt-type kvm    虚拟化的类型（qemu）</span><br><span class="line">--os-type=linux    系统类型</span><br><span class="line">-os-variant rhel7  系统版本</span><br><span class="line">--name centos7     虚拟机的名字</span><br><span class="line">--memory 1024      虚拟机的内存</span><br><span class="line">--vcpus 1          虚拟cpu的核数</span><br><span class="line">--disk /opt/centos2.raw,format=raw,size=10</span><br><span class="line">--cdrom /opt/CentOS-7-x86_64-DVD-1708.iso</span><br><span class="line">--network network=default  使用默认NAT的网络</span><br><span class="line">--graphics vnc,listen=0.0.0.0</span><br><span class="line">--noautoconsole</span><br><span class="line"></span><br><span class="line">raw：10G  不支持做快照，性能好</span><br><span class="line">qcow2:    支持快照</span><br><span class="line"></span><br><span class="line">5：kvm虚拟机的virsh日常管理和配置</span><br><span class="line">列表list (--all)</span><br><span class="line">开机start</span><br><span class="line">关机shutdown</span><br><span class="line">拔电源关机destroy</span><br><span class="line"></span><br><span class="line">导出配置dümpxml  例子：virsh dumpxml centos7 &gt;centos7-off.xml</span><br><span class="line">删除undefine  推荐：先destroy,在undefine</span><br><span class="line">导入配置define</span><br><span class="line">修改配置edit（自带语法检查）</span><br><span class="line"></span><br><span class="line">重命名domrename（低版本不支持）</span><br><span class="line">挂起<span class="built_in">suspend</span></span><br><span class="line">恢复resume</span><br><span class="line">查询vnc端口号vncdisplay</span><br><span class="line"></span><br><span class="line">6: kvm虚拟机开机启动和console 控制台 登录</span><br><span class="line">kum运行业务程序</span><br><span class="line"></span><br><span class="line">导入配置文件会自动放到系统线下的 /etc/libvirt/</span><br><span class="line"></span><br><span class="line">virsh dumpxml centos7 &gt;centos7.xml</span><br><span class="line"></span><br><span class="line">开机启动autostart,前提：systemctl <span class="built_in">enable</span> libvirtd;</span><br><span class="line">取消开机启动autostart --<span class="built_in">disable</span></span><br><span class="line">virsh autostart shop-web01</span><br><span class="line"></span><br><span class="line">centos7的kvm虚拟机：</span><br><span class="line">grubby --update-kernel=ALL --args=<span class="string">&quot;console=ttyS0,115200n8&quot;</span></span><br><span class="line"></span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line">作业1：实现centos6的kvm虚拟机，console命令行登录?</span><br><span class="line">安装一台centos6的kvm虚拟机</span><br><span class="line">console命令行登录</span><br><span class="line">virsh console shop-web01  <span class="comment">#console命令行登录</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">作业2:centos6实现没有swap分区，启动进系统</span><br><span class="line"></span><br><span class="line">7：kvm虚拟机虚拟磁盘格式转换和快照管理</span><br><span class="line">kvm：raw和qcow2格式</span><br><span class="line"></span><br><span class="line">virt-install --virt-type kvm --os-type=linux --os-variant rhel7 --name centos7 --memory 1024 --vcpus 1 --disk /opt/centos2.raw,format=raw,size=10 --cdrom /opt/Cent0S-7-x86 64-DVD-1708.iso --network network=default --graphics vnc,listen=0.0.0.0 --noautoconsole</span><br><span class="line"></span><br><span class="line">virt-install --virt-type kvm --os-type=linux --os-variant rhel7 --name centos7 --memory 1024 --vcpus 1 --disk /data/oldboy.qcow2,format=qcow2,size=10 --cdrom /data/Cent0S-7.2-x86_64-DVD-1511.iso --network network=default --graphics vnc,listen=0.0.0.0 --noautoconsole</span><br><span class="line"></span><br><span class="line">raw:  裸格式，占用空间比较大，不支持快照功能，性能较好，不方便传输    总50G 占用2G</span><br><span class="line">qcow2: cow  （copy on write）占用空间小，支持快照，性能比raw差一点，方便传输总  50G 占用2G</span><br><span class="line">qcow</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># qemu-img info /opt/centos2.raw  #查看硬盘参数</span></span><br><span class="line">[root@localhost ~]<span class="comment"># qemu-img create -f qcow2 /data/centos2.qcow2 10G  #创建一块qcow2硬盘</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ll -h /opt/  #查看两种格式大小，raw总多少占多少，qcow2写入多少占多少</span></span><br><span class="line">总用量 7.4G</span><br><span class="line">-rw-r--r--. 1 root root 193K 5月   6 19:50 centos2.qcow2</span><br><span class="line">-rw-------. 1 qemu qemu  10G 5月   6 19:51 centos2.raw</span><br><span class="line">[root@localhost ~]<span class="comment"># qemu-img resize /opt/centos2.qcow2 +20G  #扩容硬盘+20G</span></span><br><span class="line">[root@localhost ~]<span class="comment"># qemu-img convert -f raw -O qcow2 /opt/centos2.raw /opt/centos2.qcow2</span></span><br><span class="line"> <span class="comment">#将raw格式转为qcow2格式</span></span><br><span class="line">[root@localhost ~]<span class="comment"># virsh destroy centos7  #关机centos7</span></span><br><span class="line">[root@localhost ~]<span class="comment"># virsh edit centos7  #编辑修改raw为qcow2</span></span><br><span class="line">      &lt;driver name=<span class="string">&#x27;qemu&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;qcow2&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">source</span> file=<span class="string">&#x27;/opt/centos2.qcow2&#x27;</span>/&gt;</span><br><span class="line">[root@localhost ~]<span class="comment"># virsh start centos7  #开机centos7</span></span><br><span class="line"></span><br><span class="line">qemu-img info test.qcow2</span><br><span class="line">创建一块qcow2格式的虚拟硬盘：qemu-img create-f qcow2 test.qcow2 2G</span><br><span class="line"></span><br><span class="line">raw转qcow2: qemu-img convert -f raw    -0 qcow2    oldboy.raw    oldboy.qcow2</span><br><span class="line">                     convert [-f <span class="built_in">fmt</span>]    [-0 output_fmt]    filename    output_filename</span><br><span class="line"></span><br><span class="line">virsh edit web01:</span><br><span class="line">&lt;disk <span class="built_in">type</span>=<span class="string">&#x27;file&#x27;</span> device=<span class="string">&#x27;disk&#x27;</span>&gt;</span><br><span class="line">  &lt;driver name=<span class="string">&#x27;qemu&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;qcow2&#x27;</span>/&gt;</span><br><span class="line">  &lt;<span class="built_in">source</span> file=<span class="string">&#x27;/opt/centos2.qcow2&#x27;</span>/&gt;</span><br><span class="line">  &lt;target dev=<span class="string">&#x27;vda&#x27;</span> bus=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span><br><span class="line">  &lt;address <span class="built_in">type</span>=<span class="string">&#x27;pci&#x27;</span> domain=<span class="string">&#x27;0x0000&#x27;</span> bus=<span class="string">&#x27;0x00&#x27;</span> slot=<span class="string">&#x27;0x06&#x27;</span> <span class="keyword">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span><br><span class="line">&lt;/disk&gt;</span><br><span class="line"></span><br><span class="line">virsh destroy web01</span><br><span class="line">virsh start web01</span><br><span class="line"></span><br><span class="line">创建快照virsh snapshot-create centos7</span><br><span class="line">创建快照virsh snapshot-create-as centos7 --name yuanshi</span><br><span class="line">查看快照virsh snapshot-list centos7</span><br><span class="line"></span><br><span class="line">还原快照virsh snapshot-revert centos7 --snapshotname 1516574134</span><br><span class="line">删除快照virsh snapshot-delete centos7 --snapshotname 1516636570</span><br><span class="line"></span><br><span class="line">raw不支持做快照，qcow2支持快照，并且快照就保存在qcow2的磁盘文件中</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># virsh snapshot-create centos7  #创建centos7虚拟机的快照</span></span><br><span class="line">[root@localhost ~]<span class="comment"># virsh snapshot-create-as --name install_service centos7  #创建centos7虚拟机的快照，自定义名称install_service</span></span><br><span class="line">[root@localhost ~]<span class="comment"># virsh snapshot-list centos7  #查看快照centos7虚拟机快照列表</span></span><br><span class="line">[root@localhost ~]<span class="comment"># virsh snapshot-revert centos7 --snapshotname install_service  #还原快照install_service</span></span><br><span class="line">[root@localhost ~]<span class="comment"># virsh snapshot-delete centos7 --snapshotname install_service  #删除快照install_service</span></span><br><span class="line">[root@localhost ~]<span class="comment"># virsh snapshot-delete centos7 --current  #删除当前最新的快照</span></span><br><span class="line">[root@localhost ~]<span class="comment"># qemu-img convert -c -f qcow2 -O qcow2 /opt/centos2.qcow2 /opt/new.qcow2  #删除快照不会回收磁盘空间，需要压缩磁盘空间</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># virt-clone -o centos7 -n centos7.2 --auto-clone  #克隆centos7为centos7.2, --auto-clone 磁盘路径同一级目录（完整克隆）</span></span><br><span class="line"></span><br><span class="line">8：kvm虚拟机克隆</span><br><span class="line">完整克隆：基础磁盘文件完整拷贝一份</span><br><span class="line">链接克隆：依赖基础磁盘文件，把变化的内容保存在一个新的qcow2文件中</span><br><span class="line"></span><br><span class="line">virt-clone --auto-clone -o web01 -n web02(完整克隆)</span><br><span class="line"></span><br><span class="line"><span class="comment">#手动克隆</span></span><br><span class="line">[root@localhost opt]<span class="comment"># cp centos2.qcow2 centos3.qcow2</span></span><br><span class="line">[root@localhost opt]<span class="comment"># virsh dumpxml centos2 &gt;centos3.xml</span></span><br><span class="line">[root@localhost opt]<span class="comment"># vim centos3.xml </span></span><br><span class="line">  &lt;name&gt;centos3&lt;/name&gt;  <span class="comment">#修改name</span></span><br><span class="line">  &lt;uuid&gt;c2ea7004-e7c1-47eb-adab-ea07ce8b658e&lt;/uuid&gt;  <span class="comment">#删除uuid</span></span><br><span class="line">      &lt;<span class="built_in">source</span> file=<span class="string">&#x27;/opt/centos3.qcow2&#x27;</span>/&gt;  <span class="comment">#修改磁盘文件路径</span></span><br><span class="line">      &lt;mac address=<span class="string">&#x27;52:54:00:e1:3b:ab&#x27;</span>/&gt;  <span class="comment">#删除mac地址</span></span><br><span class="line">[root@localhost opt]<span class="comment"># virsh start centos3</span></span><br><span class="line"></span><br><span class="line">[root@localhost opt]<span class="comment"># qemu-img create -f qcow2 -b centos3.qcow2 centos4.qcow2  #链接centos3.qcow2克隆centos4.qcow2（链接克隆）</span></span><br><span class="line">[root@localhost opt]<span class="comment"># qemu-img info centos4.qcow2  #查看链接克隆文件，有一项backing file</span></span><br><span class="line">backing file: centos3.qcow2</span><br><span class="line">[root@localhost opt]<span class="comment"># cp centos3.xml centos4.xml</span></span><br><span class="line">[root@localhost opt]<span class="comment"># vim centos4.xml </span></span><br><span class="line">  &lt;name&gt;centos4&lt;/name&gt;</span><br><span class="line">      &lt;<span class="built_in">source</span> file=<span class="string">&#x27;/opt/centos4.qcow2&#x27;</span>/&gt;</span><br><span class="line">[root@localhost opt]<span class="comment"># virsh define centos4.xml  #导入导入配置centos4.xml</span></span><br><span class="line">[root@localhost opt]<span class="comment"># virsh start centos4</span></span><br><span class="line">[root@localhost opt]<span class="comment"># virsh list --all</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a：生成虚拟机磁盘文件</span><br><span class="line">qemu-img create -f qcow2 -b 49-web03.qcow2 49-web04.qcow2</span><br><span class="line"></span><br><span class="line">b：生成虚拟机的配置文件</span><br><span class="line">  &lt;name&gt;49-web03&lt;/name&gt;</span><br><span class="line">  &lt;uuid&gt;8e505e25-5175-46ab-a9f6-feaa096daaa4&lt;/uuid&gt;</span><br><span class="line">  &lt;<span class="built_in">source</span> file=<span class="string">&#x27;/opt/49-web03.qcow2&#x27;</span>/&gt;</span><br><span class="line">  &lt;mac address=<span class="string">&#x27;52:54:00:4e:5b:89&#x27;</span>/&gt;</span><br><span class="line">  </span><br><span class="line">  virsh define shop-web04.xml</span><br><span class="line">c：导入虚拟机并进行启动测试</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kvm链接克隆</span><br><span class="line">a.基于源磁盘文件，创建链接磁盘文件</span><br><span class="line">qemu-img create -f qcow2 -b 49-web03.qcow2 49-web04.qcow2</span><br><span class="line"></span><br><span class="line">后置备</span><br><span class="line"></span><br><span class="line">b：生成虚拟机的配置文件</span><br><span class="line">c：导入虚拟机并进行启动测试</span><br><span class="line">virt-install --virt-type Kvm --os-type=linux --os-variant rhel7 --name web04 --memory 1024 --vcpus 1 --disk /opt/web04.qcow2 --boot hd --network bridge=br0 --graphics vnc,listen=0.0.0.0 --noautoconsole</span><br><span class="line"></span><br><span class="line">9：kvm虚拟机的桥接网络</span><br><span class="line">默认的虚拟机网络是NAT模式，网段192.168.122.0/24</span><br><span class="line"></span><br><span class="line">默认NAT模式</span><br><span class="line">virt-install --virt-type kvm --os-type=linux --os-variant rhel7 --name web04 --memory 1024 --vcpus 1 --disk /opt/web04.qcow2 --boot hd --network network=default --graphics vnc,listen=0.0.0.0 --noautoconsole</span><br><span class="line"></span><br><span class="line">桥接模式</span><br><span class="line">virt-install --virt-type kvm --os-type=linux --os-variant rhel7 --name web04 --memory 1024 --vcpus 1 --disk /data/web04.qcow2 --boot hd --network bridge=br0 --graphics vnc,listen=0.0.0.0 --noautoconsole</span><br><span class="line"></span><br><span class="line">[root@localhost opt]<span class="comment"># virsh iface-bridge ens33 br0</span></span><br><span class="line">[root@localhost opt]<span class="comment"># qemu-img create  -f qcow2 -b centos3.qcow2 centos5.qcow2</span></span><br><span class="line">[root@localhost opt]<span class="comment"># virt-install --virt-type kvm --os-type=linux --os-variant rhel7 --name centos5 --memory 1024 --vcpus 1 --disk /opt/centos5.qcow2 --boot hd --network bridge=br0 --graphics vnc,listen=0.0.0.0 --noautoconsole</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#对比NAT和桥接配置文件差别</span></span><br><span class="line">[root@localhost opt]<span class="comment"># virsh dumpxml centos4 &gt;centos4.xml</span></span><br><span class="line">[root@localhost opt]<span class="comment"># virsh dumpxml centos5 &gt;centos5.xml</span></span><br><span class="line">[root@localhost opt]<span class="comment"># vimdiff centos4.xml centos5.xml </span></span><br><span class="line">[root@localhost opt]<span class="comment"># vim centos4.xml</span></span><br><span class="line">    &lt;interface <span class="built_in">type</span>=<span class="string">&#x27;network&#x27;</span>&gt;</span><br><span class="line">      &lt;mac address=<span class="string">&#x27;52:54:00:f9:c3:c6&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">source</span> network=<span class="string">&#x27;default&#x27;</span> bridge=<span class="string">&#x27;virbr0&#x27;</span>/&gt;</span><br><span class="line">[root@localhost opt]<span class="comment"># vim centos5.xml</span></span><br><span class="line">     &lt;interface <span class="built_in">type</span>=<span class="string">&#x27;bridge&#x27;</span>&gt;</span><br><span class="line">        &lt;mac address=<span class="string">&#x27;52:54:00:a6:62:d4&#x27;</span>/&gt;</span><br><span class="line">        &lt;<span class="built_in">source</span> bridge=<span class="string">&#x27;br0&#x27;</span>/&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改centos4为桥接网络</span></span><br><span class="line">[root@localhost opt]<span class="comment"># virsh edit centos4</span></span><br><span class="line">    &lt;interface <span class="built_in">type</span>=<span class="string">&#x27;bridge&#x27;</span>&gt;</span><br><span class="line">      &lt;mac address=<span class="string">&#x27;52:54:00:f9:c3:c6&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">source</span> bridge=<span class="string">&#x27;br0&#x27;</span>/&gt;</span><br><span class="line">[root@localhost opt]<span class="comment"># virsh destroy centos4  #重启虚拟机</span></span><br><span class="line">[root@localhost opt]<span class="comment"># virsh start centos4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1：创建桥接网卡</span><br><span class="line">virsh iface-bridge eth0 br0</span><br><span class="line"></span><br><span class="line">取消桥接网卡</span><br><span class="line">virsh iface-unbridge br0</span><br><span class="line"></span><br><span class="line">2:virsh edit centos7</span><br><span class="line">  &lt;interface <span class="built_in">type</span>=<span class="string">&#x27;bridge&#x27;</span>&gt;</span><br><span class="line">    &lt;mac address=<span class="string">&#x27;52:54:00:55:aa:fa&#x27;</span>/&gt;</span><br><span class="line">    &lt;<span class="built_in">source</span> bridge=<span class="string">&#x27;br0&#x27;</span>/&gt;</span><br><span class="line">在宿主机上，重启虚拟机生效</span><br><span class="line"></span><br><span class="line">3：测试虚拟机网络</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">10：热添加技术</span><br><span class="line">kvm虚拟机在线热添加硬盘</span><br><span class="line">临时生效</span><br><span class="line">virsh attach-disk web04 /opt/oldboy.qcow2 vdb --subdriver qcow2</span><br><span class="line">永久生效</span><br><span class="line">virsh attach-disk web04 /opt/oldboy.qcow2 vdb --subdriver qcow2 --config</span><br><span class="line"></span><br><span class="line">作业3：扩容kvm虚拟机的根分区</span><br><span class="line"></span><br><span class="line">kvm虚拟机在线热添加网卡</span><br><span class="line">kvm虚拟机在线热添加内存</span><br><span class="line">kvm虚拟机在线热添加cpu</span><br><span class="line"></span><br><span class="line">qemu-img create -f qcow2 add01.qcow2 5G</span><br><span class="line">virsh attach-disk centos7 /data/centos7-add01.qcow2 vdb --subdriver=qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment">#热添加硬盘</span></span><br><span class="line">[root@localhost opt]<span class="comment"># qemu-img create -f qcow2 centos4-add01.qcow2 20G</span></span><br><span class="line">[root@localhost opt]<span class="comment"># virsh attach-disk centos4 /opt/centos4-add01.qcow2 vdb --subdriver qcow2  #临时生效（立即）</span></span><br><span class="line">[root@localhost opt]<span class="comment"># virsh attach-disk centos4 /opt/centos4-add01.qcow2 vdb --subdriver qcow2 --config  #永久生效</span></span><br><span class="line"><span class="comment">#centos4虚拟机下</span></span><br><span class="line">[root@localhost ~]<span class="comment"># mkfs.xfs /dev/vdb  #格式化vdb</span></span><br><span class="line">[root@localhost ~]<span class="comment"># mount /dev/vdb /mnt  #挂载vdb</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#扩容</span></span><br><span class="line"><span class="comment">#centos4虚拟机下</span></span><br><span class="line">[root@localhost ~]<span class="comment"># umount /dev/vdb /mnt  #卸载硬盘</span></span><br><span class="line"><span class="comment">#宿主机下</span></span><br><span class="line">[root@localhost opt]<span class="comment"># virsh detach-disk centos4 vdb  #剥离硬盘</span></span><br><span class="line">[root@localhost opt]<span class="comment"># qemu-img resize centos4-add01.qcow2 50G  #扩容至50G</span></span><br><span class="line">[root@localhost opt]<span class="comment"># virsh attach-disk centos4 /opt/centos4-add01.qcow2 vdb --subdriver qcow2  #临时生效（立即）</span></span><br><span class="line"><span class="comment">#centos4虚拟机下</span></span><br><span class="line">[root@localhost ~]<span class="comment"># fdisk -l</span></span><br><span class="line">[root@localhost ~]<span class="comment"># mount /dev/vdb /mnt  #挂载vdb</span></span><br><span class="line">[root@localhost ~]<span class="comment"># xfs_growfs /dev/vdb  #更新容量(ext4使用resize2fs，xfs使用xfs_growfs)</span></span><br><span class="line">[root@localhost ~]<span class="comment"># df -h</span></span><br><span class="line">[root@localhost ~]<span class="comment"># df -Th  #查看硬盘文件格式</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>curl <a target="_blank" rel="noopener" href="http://download.lsythink.online/dl/scripts/init_os.sh">http://download.lsythink.online/dl/scripts/init_os.sh</a> | bash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">yum -y install vim</span><br><span class="line">   41  yum localinstall docker-common-1.12.6-71.git3e8e77d.el7.centos.x86_64.rpm -y</span><br><span class="line">   42  yum localinstall docker-client-1.12.6-71.git3e8e77d.el7.centos.x86_64.rpm -y</span><br><span class="line">   43  yum localinstall docker-1.12.6-71.git3e8e77d.el7.centos.x86_64.rpm -y</span><br><span class="line">   44  yum install -y vim</span><br><span class="line">   45  yum localinstall docker-common-1.12.6-71.git3e8e77d.el7.centos.x86_64.rpm -y</span><br><span class="line">   47  yum install -y wget</span><br><span class="line">   54  yum localinstall docker-common-1.12.6-71.git3e8e77d.el7.centos.x86_64.rpm -y</span><br><span class="line">   55  yum localinstall docker-client-1.12.6-71.git3e8e77d.el7.centos.x86_64.rpm -y</span><br><span class="line">   56  yum localinstall docker-1.12.6-71.git3e8e77d.el7.centos.x86_64.rpm -y</span><br><span class="line">  286  yum -y install curl</span><br><span class="line">  316  yum install bash-completion -y</span><br><span class="line">  511  yum install lrzsz</span><br><span class="line">  636  yum install nfs-utils.x86_64 -y</span><br><span class="line">  738  yum install kvm kmod-kvm qemu kvm-qemu-img virt-viewer</span><br><span class="line">  744  yum install qemu-kvm libvirt libguestfs-tools virt-insstal</span><br><span class="line">  758  yum install qemu-kvm* virt-* libvirt* -y</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>01-kvm的桥接网络原理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# sysctl -a|grep &#x27;ipv4&#x27;|grep &#x27;forward&#x27;  #查看内核转发参数</span><br><span class="line">[root@localhost opt]# iptables -t nat -L -n  #查看iptables表转发规则</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">根分区扩容：</span><br><span class="line">1）在宿主机上关闭虚拟机并调整虚拟机磁盘大小</span><br><span class="line">qemu-img resize oldboy.qcow2 +10G</span><br><span class="line"></span><br><span class="line">2）虚拟机中fdisk重新分区</span><br><span class="line">fdisk /dev/vda</span><br><span class="line"></span><br><span class="line">3)重启之后，执行xfs_growfs /dev/vda1,</span><br><span class="line">如果虚拟机磁盘文件系统是ext4: resize2fs /dev/vda1</span><br><span class="line"></span><br><span class="line">kvm虚拟机在线热添加网卡</span><br><span class="line">virsh attach-interface web04 --type bridge --source br0 --model virtio</span><br><span class="line">virsh detach-interface web04 --type bridge --mac 52:54:00:35:d3:71</span><br><span class="line"></span><br><span class="line">kvm虚拟机在线热添加内存</span><br><span class="line">virt-install --virt-type kvm --os-type=linux --os-variant rhel7 --name web04 --memory 512,maxmemory=2048 --vcpus 1 --disk /data/web04.qcow2 --boot hd --network bridge=br0 --graphics vnc,listen=0.0.0.0 --noautoconsole</span><br><span class="line"></span><br><span class="line">临时热添加内存</span><br><span class="line">setmem web04 1024M --live</span><br><span class="line">永久增大内存</span><br><span class="line">setmem web04 1024M --config</span><br><span class="line"></span><br><span class="line">kvm虚拟机在线热添加cpu</span><br><span class="line">virt-install --virt-type kvm --os-type=linux --os-variant rhel7 --name web04 --memory 512,maxmemory=2048 --vcpus 1,maxvcpus=10 --disk /data/web04.qcow2 --boot hd --network bridge=br0 --graphics</span><br><span class="line">vnc,listen=0.0.0.0 --noautoconsole</span><br><span class="line">热添加cpu核数</span><br><span class="line">setvcpus web04 4 --live</span><br><span class="line">永久添加cpu核数</span><br><span class="line">setvcpus web04 4 --config</span><br></pre></td></tr></table></figure>



<p>03-kvm的热添加内存、网卡和cpu</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# virsh attach-interface centos5 bridge br0  #附加网卡</span><br><span class="line">[root@localhost ~]# virsh attach-interface centos5 bridge br0 --config  #--config永久生效</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# virsh detach-interface centos5 bridge --mac 52:54:00:f0:c0:0b  #分离网卡</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# virsh attach-interface centos5 bridge br0 --model virtio  #让附加网卡为eth</span><br><span class="line"></span><br><span class="line">[root@localhost opt]# qemu-img create -f qcow2 -b centos5.qcow2 centos6.qcow2  #复制文件</span><br><span class="line"></span><br><span class="line">[root@localhost opt]# virt-install --help|grep mem  #查询内存帮助</span><br><span class="line"></span><br><span class="line">[root@localhost opt]# virt-install --virt-type kvm --os-type=linux --os-variant rhel7 --name centos6 --memory 512,maxmemory=2048 --vcpus 1 --disk /opt/centos6.qcow2 --boot hd --network bridge=br0 --graphics vnc,listen=0.0.0.0 --noautoconsole</span><br><span class="line"></span><br><span class="line">[root@localhost opt]# virsh setmem centos6 1024M  #设置内存为1024M</span><br><span class="line"></span><br><span class="line">[root@localhost opt]# virsh edit centos5  #想修改不支持调整内存的，需要将配置文件总内存调大</span><br><span class="line">  &lt;memory unit=&#x27;KiB&#x27;&gt;1048576&lt;/memory&gt;</span><br><span class="line"></span><br><span class="line">[root@localhost opt]# virsh setmem centos6 1024M --config  #设置内存为1024M，永久生效</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# free -m  #查看内存 </span><br><span class="line"></span><br><span class="line">[root@localhost opt]# qemu-img create -f qcow2 -b centos5.qcow2 centos9.qcow2</span><br><span class="line"></span><br><span class="line">[root@localhost opt]# virt-install --virt-type kvm --os-type=linux --os-variant rhel7 --name centos9 --memory 512,maxmemory=2048 --vcpus 1,maxvcpus=2 --disk /opt/centos9.qcow2 --boot hd --network bridge=br0 --graphics vnc,listen=0.0.0.0 --noautoconsole  #创建可修改cpu配置，虚拟机</span><br><span class="line"></span><br><span class="line">[root@localhost opt]# virsh setvcpus --help  #查看帮助</span><br><span class="line"></span><br><span class="line">[root@localhost opt]# virsh setvcpus centos9 2   #修改设置cpu为2</span><br><span class="line"></span><br><span class="line">[root@centos9 ~]# lscpu|head -5  #查看cpu信息前五行</span><br><span class="line"></span><br><span class="line">[root@localhost opt]# virsh edit centos9  #想修改不支持调整内存的，需要将配置文件总内存调大</span><br><span class="line">  &lt;vcpu placement=&#x27;static&#x27; current=&#x27;1&#x27;&gt;2&lt;/vcpu&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>







<p>04-kvm虚拟机的热迁移</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@kvm01 ~]# vim /etc//hosts</span><br><span class="line">10.0.0.11 kvm01</span><br><span class="line">10.0.0.12 kvm02</span><br><span class="line">10.0.0.31 nfs01</span><br><span class="line"></span><br><span class="line">[root@kvm01 ~]# scp -rp /etc/hosts 10.0.0.12:/etc/hosts</span><br><span class="line">[root@kvm01 ~]# scp -rp /etc/hosts 10.0.0.31:/etc/hosts</span><br><span class="line"></span><br><span class="line">[root@kvm01 ~]# hostnamectl set-hostname kvm01</span><br><span class="line">[root@kvm02 ~]# hostnamectl set-hostname kvm02</span><br><span class="line">[root@nfs01 ~]# hostnamectl set-hostname nfs01</span><br><span class="line"></span><br><span class="line">[root@kvm01 ~]# echo &#x27;192.168.15.84 mirrors.aliyun.com&#x27; &gt;&gt;/etc/hosts</span><br><span class="line">[root@kvm02 ~]# echo &#x27;192.168.15.84 mirrors.aliyun.com&#x27; &gt;&gt;/etc/hosts</span><br><span class="line">[root@nfs01 ~]# echo &#x27;192.168.15.84 mirrors.aliyun.com&#x27; &gt;&gt;/etc/hosts</span><br><span class="line"></span><br><span class="line">[root@kvm01 ~]# yum install libvirt virt-install qemu-kvm nfs-utils -y</span><br><span class="line">[root@kvm02 ~]# yum install libvirt virt-install qemu-kvm nfs-utils -y</span><br><span class="line">[root@nfs01 ~]# yum install nfs-utils -y</span><br><span class="line"></span><br><span class="line">[root@kvm01 ~]# systemctl start libvirtd.service</span><br><span class="line">[root@kvm01 ~]# virsh iface-bridge eth0 br0  #创建桥接网卡</span><br><span class="line"></span><br><span class="line">[root@kvm02 ~]# systemctl start libvirtd.service</span><br><span class="line">[root@kvm02 ~]# virsh iface-bridge eth0 br0</span><br><span class="line"></span><br><span class="line">[root@nfs01 ~]# vim /etc/exports</span><br><span class="line">/data 10.0.0.0/24(rw,async,no_root_squash,no_all_squash)</span><br><span class="line">[root@nfs01 ~]# mkdir /data</span><br><span class="line">[root@nfs01 ~]# systemctl restart rpcbind</span><br><span class="line">[root@nfs01 ~]# systemctl restart nfs</span><br><span class="line"></span><br><span class="line">[root@kvm01 ~]# showmount -e 10.0.0.31  #确认是否配置正确</span><br><span class="line">[root@kvm02 ~]# showmount -e 10.0.0.31  #确认是否配置正确</span><br><span class="line"></span><br><span class="line">[root@kvm01 ~]# mount -t nfs 10.0.0.31:/data /opt  #挂载nfs</span><br><span class="line">[root@kvm02 ~]# mount -t nfs 10.0.0.31:/data /opt</span><br><span class="line">[root@kvm01 ~]# df -h  #确认挂载是否成功</span><br><span class="line">[root@kvm02 ~]# df -h  #确认挂载是否成功</span><br><span class="line"></span><br><span class="line">[root@nfs01 ~]# wget http://192.168.15.84/centos.qcow2  #下载kvm镜像文件</span><br><span class="line"></span><br><span class="line">[root@kvm02 ~]# virt-install --virt-type kvm --os-type=linux --os-variant rhel7 --name oldboy --memory 512,maxmemory=2048 --vcpus 1,maxvcpus=2 --disk /opt/centos.qcow2 --boot hd --network bridge=br0 --graphics vnc,listen=0.0.0.0 --noautoconsole  #启动虚拟机</span><br><span class="line">[root@kvm02 ~]# virsh migrate --live --verbose oldboy qemu+ssh://10.0.0.11/system --unsafe  #执行热迁移</span><br></pre></td></tr></table></figure>





<p>05-kvm管理平台openstack</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">openstack：kvm的管理平台</span><br><span class="line">5000虚拟机</span><br><span class="line">500宿主机</span><br><span class="line"></span><br><span class="line">新创建10台虚拟机？资源尽量均衡，ip地址</span><br><span class="line">宿主机，剩余的资源，cpu，内存，网卡，磁盘容量  数据库</span><br><span class="line">       多少台虚拟机，每个虚拟机的具体配置，2c4g，密码多少，ip地址  数据库</span><br><span class="line">       </span><br><span class="line">资产表 excel表格</span><br><span class="line"></span><br><span class="line">openstack：kvm的管理平台</span><br><span class="line">controller，配置要求，4G内存，开启虚拟化，挂载centos7.4光盘</span><br><span class="line">node节点，kvm宿主机</span><br><span class="line"></span><br><span class="line">1)：上传openstack_rpm.tar.gz到/opt下，并解压</span><br><span class="line"></span><br><span class="line">2)： 上传cirros-0.3.4-x86_64-disk.img,local_settings,openstack-mitaka-autoinstall.sh到/root目录下</span><br><span class="line"></span><br><span class="line">3）执行安装脚本</span><br><span class="line"></span><br><span class="line">4) http://10.0.0.11/dashboard</span><br><span class="line">default</span><br><span class="line">admin</span><br><span class="line">ADMIN_PASS</span><br><span class="line"></span><br><span class="line">compute,配置要求，1G内存，cpu开启虚拟化，挂载centos7.4光盘</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">今日内容：</span><br><span class="line">  python基础：</span><br><span class="line">   1.编程与编程语言</span><br><span class="line">    - 什么是语言？</span><br><span class="line">        语言就是人与人之间交流的介质。</span><br><span class="line">        </span><br><span class="line">    - 什么是编程语言？</span><br><span class="line">        编程语言就是人与计算机沟通的介质。</span><br><span class="line">        </span><br><span class="line">    - 什么是编程？</span><br><span class="line">        编程指的是程序员将自己想让计算机干的事情写在一堆文件里面，这一堆文件就是程序。</span><br><span class="line">        例如：linux,nginx</span><br><span class="line">        </span><br><span class="line">    - 编程的目的？</span><br><span class="line">        程序员为了让计算机执行自己的想让计算机干的事情，从而解放人力。</span><br><span class="line"></span><br><span class="line">2.编程语言分类</span><br><span class="line">    - 机器语言</span><br><span class="line">    0101011010101  --&gt; A</span><br><span class="line">    </span><br><span class="line">    优点：</span><br><span class="line">        执行效率最高。</span><br><span class="line"></span><br><span class="line">    缺点：</span><br><span class="line">        开发效率非常低。</span><br><span class="line"></span><br><span class="line">    - 汇编语言</span><br><span class="line">        - x---&gt; 10110101 ----&gt; A</span><br><span class="line">        - ab --&gt; 11111010 ----&gt; B</span><br><span class="line">        </span><br><span class="line">        优点：</span><br><span class="line">            执行效率稍高，开发效率比机器语言稍高。</span><br><span class="line">            </span><br><span class="line">        缺点：</span><br><span class="line">            开发效率低。</span><br><span class="line">            </span><br><span class="line">    - 高级语言</span><br><span class="line">        指的是更接近与人类的语言称之为高级语言。</span><br><span class="line">        是人类所能认识的字符，程序把自己想计算机干的事情，</span><br><span class="line">        写成一堆字符，把文件交给操作系统，让它去帮我们控制计算机。</span><br><span class="line">        </span><br><span class="line">        - 编译型语言</span><br><span class="line">            一次编译，多次使用，类似一个有道云翻译。</span><br><span class="line">            优点：</span><br><span class="line">                执行效率高。</span><br><span class="line">            缺点：</span><br><span class="line">                无法跨平台。</span><br><span class="line"></span><br><span class="line">        - 解释型语言</span><br><span class="line">            类似与同声传译，一边编译一边翻译。</span><br><span class="line">            优点：</span><br><span class="line">                跨平台高。</span><br><span class="line">            缺点：</span><br><span class="line">                执行效率低。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.python介绍、安装</span><br><span class="line">4.执行python的两种方式</span><br><span class="line">5.python开发环境</span><br><span class="line">6.变量</span><br><span class="line">7.定义变量的三种特征</span><br><span class="line">8.python的垃圾回收机制</span><br><span class="line">9.数据类型</span><br><span class="line">10.程序与用户交互</span><br><span class="line">11.格式化输出</span><br><span class="line">12.基本运算符</span><br><span class="line">13.流程控制</span><br><span class="line"></span><br></pre></td></tr></table></figure>







<p>redis-day01</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br></pre></td><td class="code"><pre><span class="line">一.redis简介</span><br><span class="line"></span><br><span class="line">1.什么是redis?</span><br><span class="line">非关系型数据库，存储的是key:value</span><br><span class="line"></span><br><span class="line">2.为什么要学redis?</span><br><span class="line">    1）功能全面</span><br><span class="line">    2）企业使用率高</span><br><span class="line"></span><br><span class="line">3.redis的作用? key:value(NoSQL)</span><br><span class="line">    1) 缓存(redis,memcache)</span><br><span class="line">    2) 消息队列（kafka,zero-mq,rabbit-mq,rocket-mq）</span><br><span class="line">    3) 会话保持</span><br><span class="line"></span><br><span class="line">4.对比结论</span><br><span class="line">1.Memcached: 多核的缓存服务，更加适合于多用户并发访问次数（访问次数较少的应用场景）。</span><br><span class="line">2.Redis: 单核缓存服务，在单节点情况下，更加适合少量用户，多次访问的应用场景。</span><br><span class="line">redis一般在企业中，是单机多实例架构</span><br><span class="line"></span><br><span class="line">二.redis安装部署</span><br><span class="line">先决条件：</span><br><span class="line">[root@redis redis]<span class="comment"># yum install -y gcc gcc-c++</span></span><br><span class="line">1.下载redis源码包</span><br><span class="line">[root@redis ~]<span class="comment"># wget http://download.redis.io/releases/redis-3.2.12.tar.gz</span></span><br><span class="line">2.解压redis源码包</span><br><span class="line">[root@redis ~]<span class="comment"># tar xf redis-3.2.12.tar.gz</span></span><br><span class="line">3.移动redis目录</span><br><span class="line">[root@redis ~]<span class="comment"># mv redis-3.2.12 /usr/local/</span></span><br><span class="line">4.做软连接</span><br><span class="line">[root@redis ~]<span class="comment"># ln -s /usr/local/redis-3.2.12 /usr/local/redis</span></span><br><span class="line">5.进入redis目录</span><br><span class="line">[root@redis ~]<span class="comment"># cd /usr/local/redis</span></span><br><span class="line">6.编译安装</span><br><span class="line">[root@redis redis]<span class="comment"># make</span></span><br><span class="line">7.添加环境变量</span><br><span class="line">[root@redis redis]<span class="comment"># vim /etc/profile.d/redis.sh</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/usr/local/redis/src:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line">8.加载环境变量</span><br><span class="line">[root@redis redis]<span class="comment"># source /etc/profile</span></span><br><span class="line">9.启动redis</span><br><span class="line">[root@redis redis]<span class="comment"># redis-server &amp;</span></span><br><span class="line">10.连接redis</span><br><span class="line">[root@redis redis]<span class="comment"># redis-cli</span></span><br><span class="line"></span><br><span class="line">默认读取配置文件：</span><br><span class="line">[root@redis redis]<span class="comment"># ll /usr/local/redis/redis.conf </span></span><br><span class="line">-rw-rw-r--. 1 root root 46695 6月  13 2018 /usr/local/redis/redis.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">三.配置redis</span><br><span class="line">1.创建redis工作目录</span><br><span class="line">[root@db01 redis]<span class="comment"># mkdir -p /etc/redis/6379</span></span><br><span class="line"></span><br><span class="line">2.创建redis配置文件</span><br><span class="line">[root@db01 redis]<span class="comment"># vim /etc/redis/6379/redis.conf</span></span><br><span class="line">daemonize <span class="built_in">yes</span>   //守护进程模式启动</span><br><span class="line">port 6379       //端口</span><br><span class="line">logfile /etc/redis/6379/redis.log   //日志文件位置</span><br><span class="line"><span class="built_in">dir</span> /etc/redis/6379     //持久化数据文件存储位置</span><br><span class="line">dbfilename dump.rdb     //RDB持久化数据文件名称</span><br><span class="line">3.指定配置文件启动redis</span><br><span class="line">[root@db01 redis]<span class="comment"># redis-server /etc/redis/6379/redis.conf</span></span><br><span class="line">4.允许远程连接操作，关闭保护模式</span><br><span class="line">[root@redis redis]<span class="comment"># vim /etc/redis/6379/redis.conf</span></span><br><span class="line">protected-mode no</span><br><span class="line"><span class="comment">#重启redis</span></span><br><span class="line">[root@redis redis]<span class="comment"># redis-cli</span></span><br><span class="line">127.0.0.1:6379&gt; shutdown</span><br><span class="line">not connected&gt; quit</span><br><span class="line">[root@redis redis]<span class="comment"># redis-server /etc/redis/6379/redis.conf</span></span><br><span class="line">5.基本操作</span><br><span class="line">[root@redis redis]<span class="comment"># redis-cli</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> foo bar  <span class="comment">#创建key</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys *  <span class="comment">#查看key</span></span><br><span class="line">1) <span class="string">&quot;foo&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; get foo  <span class="comment">#查看key的值</span></span><br><span class="line"><span class="string">&quot;bar&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; del foo  <span class="comment">#删除key</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; keys *  <span class="comment">#查看key已经被删除</span></span><br><span class="line">(empty list or <span class="built_in">set</span>)</span><br><span class="line">6.设置redis密码</span><br><span class="line">[root@redis redis]<span class="comment"># vim /etc/redis/6379/redis.conf</span></span><br><span class="line">requirepass zls</span><br><span class="line">[root@redis redis]<span class="comment"># redis-server /etc/redis/6379/redis.conf</span></span><br><span class="line">7.连接redis</span><br><span class="line">[root@localhost ~]<span class="comment"># redis-cli -h 10.0.0.11  #远程连接</span></span><br><span class="line">10.0.0.11:6379&gt; keys *  <span class="comment">#未登录无法查看</span></span><br><span class="line">(error) NOAUTH Authentication required.</span><br><span class="line">10.0.0.11:6379&gt; AUTH zls  <span class="comment">#使用密码登录</span></span><br><span class="line">OK</span><br><span class="line">10.0.0.11:6379&gt; keys *  <span class="comment">#认证后可查看</span></span><br><span class="line">(empty list or <span class="built_in">set</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#另一种密码登录方式，不建议这么操作，明文</span></span><br><span class="line">[root@redis redis]<span class="comment"># redis-cli -a zls</span></span><br><span class="line"></span><br><span class="line">8.配置文件操作</span><br><span class="line">[root@redis ~]<span class="comment"># redis-cli</span></span><br><span class="line">127.0.0.1:6379&gt; AUTH zls</span><br><span class="line">127.0.0.1:6379&gt; CONFIG GET *</span><br><span class="line">127.0.0.1:6379&gt; CONFIG GET requirepass</span><br><span class="line">1) <span class="string">&quot;requirepass&quot;</span></span><br><span class="line">2) <span class="string">&quot;zls&quot;</span></span><br><span class="line">9.临时修改密码</span><br><span class="line">127.0.0.1:6379&gt; CONFIG SET requirepass 123  <span class="comment">#修改密码</span></span><br><span class="line">[root@redis ~]<span class="comment"># redis-cli -a zls</span></span><br><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">(error) NOAUTH Authentication required.</span><br><span class="line">127.0.0.1:6379&gt; AUTH 123</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">(empty list or <span class="built_in">set</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">三.redis的持久化</span><br><span class="line">1.什么是持久化？</span><br><span class="line">    将内存中的数据，写入磁盘保存下来。</span><br><span class="line">    </span><br><span class="line">2.redis持久化的模式有哪些？</span><br><span class="line">    1) RDB</span><br><span class="line">    可以在指定的时间间隔内生成数据集的时间点快照（point-in-time snapshot）。</span><br><span class="line">    开启RDB持久化：</span><br><span class="line">    <span class="comment">#rdb持久化数据文件名</span></span><br><span class="line">    dbfilename dump.rdb</span><br><span class="line">    <span class="comment">#900秒（15分钟）内有1个更改</span></span><br><span class="line">    save 900 1</span><br><span class="line">    <span class="comment">#300秒（5分钟）内有10个更改</span></span><br><span class="line">    save 300 10</span><br><span class="line">    <span class="comment">#60秒（1分钟）内有10000个更改</span></span><br><span class="line">    save 60 10000</span><br><span class="line"></span><br><span class="line">[root@redis ~]<span class="comment"># vim /etc/redis/6379/redis.conf</span></span><br><span class="line"><span class="comment">#900秒（15分钟）内有1个更改    </span></span><br><span class="line">save 900 1</span><br><span class="line"><span class="comment">#300秒（5分钟）内有10个更改    </span></span><br><span class="line">save 300 10</span><br><span class="line"><span class="comment">#60秒（1分钟）内有10000个更改    </span></span><br><span class="line">save 60 10000</span><br><span class="line">[root@redis ~]<span class="comment"># redis-cli -a 123</span></span><br><span class="line">127.0.0.1:6379&gt; shutdown</span><br><span class="line">not connected&gt; quit</span><br><span class="line">[root@redis ~]<span class="comment"># redis-server /etc/redis/6379/redis.conf</span></span><br><span class="line">[root@redis ~]<span class="comment"># redis-cli -a zls</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> bgx ugly</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">RDB持久化的优点：</span><br><span class="line">    a）RDB是一种表示某个即时点的Redis数据的紧凑文件。RDB文件适合用于备份。例如，你可能想要每小时归档最近24小时的RDB文件，每天保存近30天的RDB快照。这允许你很容易的恢复不同版本的数据集以容灾。</span><br><span class="line">    b）RDB非常适合于灾难恢复，作为一个紧凑的单一文件，可以被传输到远程的数据中心。</span><br><span class="line">    c）RDB最大化了Redis的性能，因为Redis父进程持久化时唯一需要做的是启动（fork）一个子进程，由子进程完成所有剩余工作。父进程实例不需要执行像磁盘I0这样的操作。</span><br><span class="line">    d）RDB在重启保存了大数据集的实例时比AOF要快。</span><br><span class="line">    </span><br><span class="line">RDB持久化缺点</span><br><span class="line">    a）当你需要在Redis停止工作(例如停电)时最小化数据丢失，RDB可能不太好。你可以配置不同的保存点(save point)来保存RDB文件(例如，至少5分钟和对数据集100次写之后，但是你可以有多个保存点)。然而，你通常每隔5分钟或更久创建一个RDB快照，所以一旦Redis因为任何原因没有正确关闭而停止工作，你就得做好最近几分钟数据丢失的准备了。</span><br><span class="line">    b）RDB需要经常调用fork()子进程来持久化到磁盘。如果数据集很大的话，fork()比较耗时，结果就是，当数据集非常大并且CPU性能不够强大的话，Redis会停止服务客户端几毫秒甚至一秒。AOF也需要fork()，但是你可以调整多久频率重写日志而不会有损(trade-off)持久性(durability)。</span><br><span class="line">    </span><br><span class="line">RDB持久化高级配置</span><br><span class="line"><span class="comment">#编辑配置文件</span></span><br><span class="line">[root@db01 redis]<span class="comment"># vim /etc/redis/6379/redis.conf</span></span><br><span class="line"><span class="comment">#后台备份进程出错时,主进程停不停止写入? 主进程不停止容易造成数据不一致</span></span><br><span class="line">stop-writes-on-bgsave-error <span class="built_in">yes</span></span><br><span class="line"><span class="comment">#导出的rdb文件是否压缩 如果rdb的大小很大的话建议这么做</span></span><br><span class="line">rdbcompression <span class="built_in">yes</span> </span><br><span class="line"><span class="comment">#导入rbd恢复时数据时,要不要检验rdb的完整性 验证版本是不是一致</span></span><br><span class="line">rdbchecksum <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">2) AOF</span><br><span class="line">AOF（append only file）只追加文件，记录服务器执行的所有写操作命令，并在服务器启动时，通过重新执行这些命令来还原数据集。 AOF 文件中的命令全部以 Redis 协议的格式来保存，新命令会被追加到文件的末尾。</span><br><span class="line"></span><br><span class="line">配置：</span><br><span class="line"><span class="comment">#是否打开AOF日志功能</span></span><br><span class="line">appendonly <span class="built_in">yes</span>/no</span><br><span class="line"> </span><br><span class="line"><span class="comment">#每一条命令都立即同步到AOF</span></span><br><span class="line">appendfsync always</span><br><span class="line"></span><br><span class="line">[root@redis ~]<span class="comment"># redis-cli -a zls</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> bgx ugly</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; shutdown</span><br><span class="line">not connected&gt; quit</span><br><span class="line">[root@redis ~]<span class="comment"># vim /etc/redis/6379/redis.conf </span></span><br><span class="line">appendonly <span class="built_in">yes</span></span><br><span class="line">appendfsync always</span><br><span class="line">[root@redis ~]<span class="comment"># redis-server /etc/redis/6379/redis.conf</span></span><br><span class="line">[root@redis ~]<span class="comment"># redis-cli -a zls</span></span><br><span class="line">127.0.0.1:6379&gt; SET bgx ugly</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) <span class="string">&quot;bgx&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; quit</span><br><span class="line">[root@redis ~]<span class="comment"># cd /etc/redis/6379/</span></span><br><span class="line">[root@redis 6379]<span class="comment"># ll</span></span><br><span class="line">-rw-r--r--. 1 root root    55 5月  12 15:09 appendonly.aof</span><br><span class="line"></span><br><span class="line">AOF持久化高级配置</span><br><span class="line"><span class="comment">#编辑配置文件</span></span><br><span class="line">[root@db01 redis]<span class="comment"># vim /etc/redis/6379/redis.conf</span></span><br><span class="line"><span class="comment">#正在导出rdb快照的过程中,要不要停止同步aof</span></span><br><span class="line">no-appendfsync-on-rewrite <span class="built_in">yes</span>/no</span><br><span class="line"><span class="comment">#aof文件大小比起上次重写时的大小,增长率100%时重写,缺点:业务开始的时候，会重复重写多次</span></span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line"><span class="comment">#aof文件,至少超过64M时,重写</span></span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#模拟消息队列</span></span><br><span class="line">[root@redis ~]<span class="comment"># redis-cli</span></span><br><span class="line">127.0.0.1:6379&gt; AUTH zls</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; lpush list zls</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; lpush list bgx</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; lpush list lidao</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; lpush list oldboy</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; lpush list hedao</span><br><span class="line">(<span class="built_in">integer</span>) 5</span><br><span class="line">127.0.0.1:6379&gt; lpush list alex</span><br><span class="line">(<span class="built_in">integer</span>) 6</span><br><span class="line">127.0.0.1:6379&gt; llen list</span><br><span class="line">(<span class="built_in">integer</span>) 6</span><br><span class="line">127.0.0.1:6379&gt; lpop list</span><br><span class="line"><span class="string">&quot;alex&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; rpush list wang5</span><br><span class="line"><span class="string">&quot;wang5&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lpush teacher zls</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; lpush teacher bgx</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; lpush teacher alex</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; lpop teacher</span><br><span class="line"><span class="string">&quot;alex&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lpop teacher</span><br><span class="line"><span class="string">&quot;bgx&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lpop teacher</span><br><span class="line"><span class="string">&quot;zls&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#从头开始，将索引为1的元素值，设置为新值 e，若索引越界，则返回错误信息</span></span><br><span class="line">127.0.0.1:6379&gt; lset teacher 1 <span class="built_in">test</span></span><br><span class="line">OK</span><br><span class="line"><span class="comment">#将 teacher 中的尾部元素移到其头部</span></span><br><span class="line">127.0.0.1:6379&gt; rpoplpush teacher teacher</span><br><span class="line"><span class="string">&quot;oldboy&quot;</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; LRANGE list 0 10</span><br><span class="line">1) <span class="string">&quot;hedao&quot;</span></span><br><span class="line">2) <span class="string">&quot;oldboy&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; LPUSH wechat <span class="string">&quot;monday,bgx is a dsb&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; LPUSH wechat <span class="string">&quot;2,bgx is a ldsb&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; LPUSH wechat <span class="string">&quot;3,bgx is a sb&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; LRANGE wechat 0 -1</span><br><span class="line">1) <span class="string">&quot;3,bgx is a sb&quot;</span></span><br><span class="line">2) <span class="string">&quot;2,bgx is a ldsb&quot;</span></span><br><span class="line">3) <span class="string">&quot;monday,bgx is a dsb&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">五.redis主从复制</span><br><span class="line">127.0.0.1:6379&gt; slaveof 10.0.0.51 6379</span><br><span class="line">ok</span><br><span class="line">127.0.0.1:6379&gt; SLAVEOF no one  <span class="comment">#提升为主库</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; info replication</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">protected-mode no</span><br><span class="line"></span><br><span class="line">daemonize yes</span><br><span class="line">port 6379</span><br><span class="line">logfile /etc/redis/6379/redis.log</span><br><span class="line">dir /etc/redis/6379</span><br><span class="line">dbfilename dump.rdb</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@redis ~]# wget http://download.redis.io/releases/redis-3.2.12.tar.gz</span><br><span class="line">[root@redis ~]# tar xf redis-3.2.12.tar.gz</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>配置多实例</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">#创建多实例目录</span><br><span class="line">[root@redis ~]# mkdir -p /etc/redis/&#123;6379,6380,6381&#125;</span><br><span class="line"></span><br><span class="line">#redis 6379 配置文件</span><br><span class="line">[root@redis ~]# vim /etc/redis/6379/redis.conf </span><br><span class="line">port 6379</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /etc/redis/6379/redis.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile /etc/redis/6379/redis.log</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir /etc/redis/6379</span><br><span class="line">protected-mode no</span><br><span class="line"></span><br><span class="line">#redis 6380 配置文件</span><br><span class="line">[root@redis ~]# vim /etc/redis/6380/redis.conf </span><br><span class="line">port 6380</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /etc/redis/6380/redis.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile /etc/redis/6380/redis.log</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir /etc/redis/6380</span><br><span class="line">protected-mode no</span><br><span class="line"></span><br><span class="line">#redis 6381 配置文件</span><br><span class="line">[root@redis ~]# vim /etc/redis/6381/redis.conf</span><br><span class="line">port 6381</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /etc/redis/6381/redis.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile /etc/redis/6381/redis.log</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir /etc/redis/6381</span><br><span class="line">protected-mode no</span><br><span class="line"></span><br><span class="line">#启动redis多实例</span><br><span class="line">[root@redis ~]# redis-server /etc/redis/6379/redis.conf </span><br><span class="line">[root@redis ~]# redis-server /etc/redis/6380/redis.conf</span><br><span class="line">[root@redis ~]# redis-server /etc/redis/6381/redis.conf</span><br><span class="line">[root@redis ~]# netstat -lntup</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@redis ~]# redis-cli -p 6380</span><br><span class="line">127.0.0.1:6380&gt; info replication</span><br><span class="line">role:master</span><br><span class="line">127.0.0.1:6380&gt; SLAVEOF 127.0.0.1 6379  #开启主从</span><br><span class="line">127.0.0.1:6380&gt; info replication</span><br><span class="line">role:slave</span><br><span class="line"></span><br><span class="line">[root@redis ~]# redis-cli -p 6381</span><br><span class="line">127.0.0.1:6381&gt; SLAVEOF 127.0.0.1 6379  #开启主从</span><br><span class="line"></span><br><span class="line">[root@redis ~]# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; INFO replication  #查看从库</span><br><span class="line"># Replication</span><br><span class="line">role:master    #角色为master</span><br><span class="line">connected_slaves:2    #两台从库</span><br><span class="line">slave0:ip=127.0.0.1,port=6380,state=online,offset=1,lag=1</span><br><span class="line">slave1:ip=127.0.0.1,port=6381,state=online,offset=1,lag=0</span><br><span class="line">master_repl_offset:1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:2</span><br><span class="line">repl_backlog_histlen:0</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>sentinel配置</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">六.redis高可用sentinel</span><br><span class="line">[root@redis ~]# mkdir /etc/redis/26380</span><br><span class="line">[root@redis ~]# cd /etc/redis/26380</span><br><span class="line">[root@redis 26380]# vim sentinel.conf</span><br><span class="line">port 26380</span><br><span class="line">dir &quot;/etc/redis/26380&quot;</span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 1</span><br><span class="line">sentinel down-after-milliseconds mymaster 5000</span><br><span class="line"></span><br><span class="line">启动</span><br><span class="line">root@redis 26380]# redis-sentinel /etc/redis/26380/sentinel.conf &amp;</span><br><span class="line">[root@redis 26380]# netstat -lntup</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp        0      0 0.0.0.0:26380           0.0.0.0:*               LISTEN      7443/redis-sentinel </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sentinel管理命令（不常用）</span><br><span class="line">#连接sentinel管理端口</span><br><span class="line">[root@db01 26380]# redis-cli -p 26380</span><br><span class="line">#检测状态，返回PONG</span><br><span class="line">127.0.0.1:26380&gt; PING</span><br><span class="line">PONG</span><br><span class="line">#列出所有被监视的主服务器</span><br><span class="line">127.0.0.1:26380&gt; SENTINEL masters</span><br><span class="line">#列出所有被监视的从服务器</span><br><span class="line">127.0.0.1:26380&gt; SENTINEL slaves mymaster</span><br><span class="line">#返回给定名字的主服务器的IP地址和端口号</span><br><span class="line">127.0.0.1:26380&gt; SENTINEL get-master-addr-by-name mymaster</span><br><span class="line">1) &quot;127.0.0.1&quot;</span><br><span class="line">2) &quot;6380&quot;</span><br><span class="line">#重置所有名字和给定模式</span><br><span class="line">127.0.0.1:26380&gt; SENTINEL reset mymaster</span><br><span class="line">#当主服务器失效时，在不询问其他Sentinel意见的情况下，强制开始一次自动故障迁移。</span><br><span class="line">127.0.0.1:26380&gt; SENTINEL failover mymaster</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line">七.redis-cluster</span><br><span class="line">[root@redis 26380]# yum install ruby rubygems -y</span><br><span class="line">[root@redis 26380]# gem sources -l  #查看gem源</span><br><span class="line">*** CURRENT SOURCES ***</span><br><span class="line"></span><br><span class="line">https://rubygems.org/</span><br><span class="line">[root@redis 26380]# gem sources -a http://mirrors.aliyun.com/rubygems/  #添加阿里云的gem源</span><br><span class="line">[root@redis 26380]# gem sources  --remove https://rubygems.org/  #删除国外gem源</span><br><span class="line">[root@redis 26380]# gem install redis -v 3.3.3  #使用gem安装redis的ruby插件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#配置多实例</span><br><span class="line">[root@redis 26380]# mkdir -p /data/700&#123;0..5&#125;</span><br><span class="line">[root@redis 26380]# vim /data/7000/redis.conf</span><br><span class="line">port 7000</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /data/7000/redis.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile &quot;/data/7000/redis.log&quot;</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir /data/7000</span><br><span class="line">protected-mode no</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">appendonly yes</span><br><span class="line">[root@redis 26380]# vim /data/7001/redis.conf</span><br><span class="line">port 7001</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /data/7001/redis.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile &quot;/data/7001/redis.log&quot;</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir /data/7001</span><br><span class="line">protected-mode no</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">appendonly yes</span><br><span class="line">[root@redis 26380]# vim /data/7002/redis.conf</span><br><span class="line">port 7002</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /data/7002/redis.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile &quot;/data/7002/redis.log&quot;</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir /data/7002</span><br><span class="line">protected-mode no</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">appendonly yes</span><br><span class="line">[root@redis 26380]# vim /data/7003/redis.conf</span><br><span class="line">port 7003</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /data/7003/redis.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile &quot;/data/7003/redis.log&quot;</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir /data/7003</span><br><span class="line">protected-mode no</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">appendonly yes</span><br><span class="line">[root@redis 26380]# vim /data/7004/redis.conf</span><br><span class="line">port 7004</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /data/7004/redis.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile &quot;/data/7004/redis.log&quot;</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir /data/7004</span><br><span class="line">protected-mode no</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">appendonly yes</span><br><span class="line">[root@redis 26380]# vim /data/7005/redis.conf</span><br><span class="line">port 7005</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /data/7005/redis.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile &quot;/data/7005/redis.log&quot;</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir /data/7005</span><br><span class="line">protected-mode no</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">appendonly yes</span><br><span class="line"></span><br><span class="line">#启动节点</span><br><span class="line">[root@db01 ~]# redis-server /data/7000/redis.conf </span><br><span class="line">[root@db01 ~]# redis-server /data/7001/redis.conf </span><br><span class="line">[root@db01 ~]# redis-server /data/7002/redis.conf </span><br><span class="line">[root@db01 ~]# redis-server /data/7003/redis.conf </span><br><span class="line">[root@db01 ~]# redis-server /data/7004/redis.conf </span><br><span class="line">[root@db01 ~]# redis-server /data/7005/redis.conf</span><br><span class="line"></span><br><span class="line">加入集群</span><br><span class="line">redis-trib.rb create --replicas 1 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005</span><br><span class="line"></span><br><span class="line">yes</span><br><span class="line"></span><br><span class="line">#查看集群主节点状态</span><br><span class="line">[root@db01 ~]# redis-cli -p 7000 cluster nodes |grep master</span><br><span class="line">c74da3c4b8250425fa3626fd486364371188b1ee 127.0.0.1:7002 master - 0 1554633602486 3 connected 10923-16383</span><br><span class="line">80d141fdf0af0a90c98ab911812e810ac073940f 127.0.0.1:7001 master - 0 1554633602990 2 connected 5461-10922</span><br><span class="line">c1838701432c77418850dcab8fbc6edd8c15c697 127.0.0.1:7000 master - 0 1554633603493 1 connected 0-5460</span><br><span class="line"> </span><br><span class="line">#查看集群从节点状态</span><br><span class="line">[root@db01 ~]# redis-cli -p 7004 cluster nodes |grep slave</span><br><span class="line">15bb1efcbddf404ed079651b34cc4d8a56e769e8 127.0.0.1:7003 slave c1838701432c77418850dcab8fbc6edd8c15c697 0 1554633682768 4 connected</span><br><span class="line">49de58635d02ee66ce950e44bf06d055faf44131 127.0.0.1:7005 slave c74da3c4b8250425fa3626fd486364371188b1ee 0 1554633683273 6 connected</span><br><span class="line">797516c376ab94eb8211414efd5cf5e4074945d7 127.0.0.1:7004 myself,slave 80d141fdf0af0a90c98ab911812e810ac073940f 0 0 5 connected</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@redis 26380]# mkdir -p /data/700&#123;6,7&#125;</span><br><span class="line">[root@redis 26380]# vim /data/7006/redis.conf</span><br><span class="line">port 7006</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /data/7006/redis.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile &quot;/data/7006/redis.log&quot;</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir /data/7006</span><br><span class="line">protected-mode no</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">appendonly yes</span><br><span class="line">[root@redis 26380]# vim /data/7007/redis.conf</span><br><span class="line">port 7006</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /data/7006/redis.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile &quot;/data/7006/redis.log&quot;</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir /data/7006</span><br><span class="line">protected-mode no</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">appendonly yes</span><br><span class="line"></span><br><span class="line">[root@redis 26380]# redis-server /data/7006/redis.conf</span><br><span class="line">[root@redis 26380]# redis-server /data/7007/redis.conf</span><br><span class="line">#在主节点上执行，将db02上的redis添加到7000端口所在主节点</span><br><span class="line">[root@redis 26380]# redis-trib.rb add-node 127.0.0.1:7006 127.0.0.1:7000</span><br><span class="line">[root@redis 26380]# redis-cli -p 7000 cluster nodes |grep master</span><br><span class="line">4cdf96f102fa49e523df133cafc222f1cdbaa222 127.0.0.1:7001 master - 0 1652375576734 2 connected 5461-10922</span><br><span class="line">67ecfda8855b1538c3cae4e1b471b2f34a50438a 127.0.0.1:7002 master - 0 1652375576230 3 connected 10923-16383</span><br><span class="line">0b2f356c497c268cfcd8c21ac6fe083ce5e64819 127.0.0.1:7000 myself,master - 0 0 1 connected 0-5460</span><br><span class="line">cc818d8c3d09870133064c6b404529c1ce47c8c4 127.0.0.1:7006 master - 0 1652375577740 0 connected</span><br><span class="line">18a38d7bca21c6a15602031e46a592c5d5bf379f 127.0.0.1:7007 master - 0 1652375575725 7 connected</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#重新分片</span><br><span class="line">[root@redis 26380]# redis-trib.rb reshard 127.0.0.1:7000</span><br><span class="line">4096</span><br><span class="line">all</span><br><span class="line">yes</span><br><span class="line"></span><br><span class="line">[root@redis 26380]# redis-cli -p 7000 cluster nodes |grep master</span><br><span class="line">#添加从节点</span><br><span class="line">[root@db01 ~]# redis-trib.rb add-node --slave --master-id cc818d8c3d09870133064c6b404529c1ce47c8c4 127.0.0.1:7007 127.0.0.1:7000</span><br></pre></td></tr></table></figure>



<p><strong>删除节点</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#重新分片</span><br><span class="line">[root@db01 ~]# redis-trib.rb reshard 127.0.0.1:7000</span><br><span class="line">[root@redis 26380]# redis-cli -p 7000 cluster nodes |grep master</span><br><span class="line">[root@redis 26380]# redis-cli -p 7000 cluster nodes |grep slave</span><br><span class="line">#删除节点</span><br><span class="line">[root@redis 26380]# redis-trib.rb del-node 127.0.0.1:7006 cc818d8c3d09870133064c6b404529c1ce47c8c4</span><br><span class="line">[root@redis 26380]# redis-trib.rb del-node 127.0.0.1:7007 18a38d7bca21c6a15602031e46a592c5d5bf379f</span><br><span class="line">[root@redis 26380]# redis-cli -p 7000 cluster nodes |grep master</span><br><span class="line">[root@redis 26380]# redis-cli -p 7000 cluster nodes |grep slave</span><br></pre></td></tr></table></figure>



<p>录制14</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">八.redis-API</span><br><span class="line">安装python环境 </span><br><span class="line">[root@redis ~]# yum install -y zlib-devel openssl-devel</span><br><span class="line">#下载Python3.6.4安装包</span><br><span class="line">[root@db03 ~]# wget https://www.python.org/ftp/python/3.6.4/Python-3.6.4.tgz</span><br><span class="line">[root@db03 ~]# tar xf Python-3.6.4.tgz</span><br><span class="line">[root@db03 ~]# cd Python-3.6.4/</span><br><span class="line">#生成Python环境安装文件</span><br><span class="line">[root@db01 Python-3.6.4]# ./configure --prefix=/usr/local/python3.6.4 --with-ssl --enable-optimizations</span><br><span class="line">#编译&amp;&amp;安装</span><br><span class="line">[root@db03 ~]# make &amp;&amp; make install</span><br><span class="line">[root@db01 Python-3.6.4]# /usr/local/python3.6.4/bin/pip3 install redis</span><br><span class="line"></span><br><span class="line">#单台</span><br><span class="line">[root@db01 Python-3.6.4]# /usr/local/python3.6.4/bin/python3</span><br><span class="line">import redis</span><br><span class="line">r = redis.StrictRedis(host=&#x27;localhost&#x27;, port=6380, db=0)</span><br><span class="line">r.set(&#x27;lidao&#x27;,&#x27;dsb&#x27;)</span><br><span class="line">r.get(&#x27;lidao&#x27;)</span><br><span class="line"></span><br><span class="line">#集群-sentinel</span><br><span class="line">#导入Redis Sentinel模块</span><br><span class="line">&gt;&gt;&gt; from redis.sentinel import Sentinel</span><br><span class="line">#设置连接信息变量</span><br><span class="line">&gt;&gt;&gt; s = Sentinel([(&#x27;localhost&#x27;, 26380)], socket_timeout=0.1)</span><br><span class="line">&gt;&gt;&gt; s.discover_master(&#x27;mymaster&#x27;)</span><br><span class="line">&gt;&gt;&gt; s.discover_slaves(&#x27;mymaster&#x27;)</span><br><span class="line"></span><br><span class="line">#配置读写分离，写节点</span><br><span class="line">&gt;&gt;&gt; master = s.master_for(&#x27;mymaster&#x27;, socket_timeout=0.1,password=&quot;zls&quot;)  </span><br><span class="line">#配置读写分离，读节点</span><br><span class="line">&gt;&gt;&gt; slave = s.slave_for(&#x27;mymaster&#x27;, socket_timeout=0.1,password=&quot;zls&quot;)  </span><br><span class="line">#读写分离测试key     </span><br><span class="line">&gt;&gt;&gt; master.set(&#x27;zls&#x27;, &#x27;handsome&#x27;)  </span><br><span class="line">&gt;&gt;&gt; slave.get(&#x27;zls&#x27;)  </span><br><span class="line">&#x27;handsome&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#安装Python连接Redis Cluster驱动</span><br><span class="line">[root@db01 ~]# /usr/local/python3.6.4/bin/pip3 install redis-py-cluster</span><br><span class="line"></span><br><span class="line">#启动Redis Cluster集群</span><br><span class="line">[root@db01 ~]# redis-server /data/7000/redis.conf</span><br><span class="line">[root@db01 ~]# redis-server /data/7001/redis.conf</span><br><span class="line">[root@db01 ~]# redis-server /data/7002/redis.conf</span><br><span class="line">[root@db01 ~]# redis-server /data/7003/redis.conf</span><br><span class="line">[root@db01 ~]# redis-server /data/7004/redis.conf</span><br><span class="line">[root@db01 ~]# redis-server /data/7005/redis.conf</span><br><span class="line"></span><br><span class="line">[root@db01 Python-3.6.4]# /usr/local/python3.6.4/bin/python3</span><br><span class="line">#导入Redis Cluster模块</span><br><span class="line">&gt;&gt;&gt; from rediscluster import StrictRedisCluster</span><br><span class="line">#设置登录redis集群变量</span><br><span class="line">&gt;&gt;&gt; startup_nodes = [&#123;&quot;host&quot;: &quot;127.0.0.1&quot;, &quot;port&quot;: &quot;7000&quot;&#125;]</span><br><span class="line">#设置连接变量</span><br><span class="line">&gt;&gt;&gt; rc = StrictRedisCluster(startup_nodes=startup_nodes, decode_responses=True)</span><br><span class="line">#测试设置key</span><br><span class="line">&gt;&gt;&gt; rc.set(&quot;foo&quot;, &quot;bar&quot;)</span><br><span class="line">True</span><br><span class="line">#查询key</span><br><span class="line">&gt;&gt;&gt; print(rc.get(&quot;foo&quot;))</span><br><span class="line">bar</span><br><span class="line">&gt;&gt;&gt; rc.get(&quot;foo&quot;)</span><br><span class="line">&#x27;bar&#x27;</span><br></pre></td></tr></table></figure>





<p>ingresss  7层负载均衡</p>
<p>k8s的监控 prometheus</p>
<p>k8s的日志  EFK</p>
<p>k8s的包管理器 helm</p>
<p>k8s的网络插件 flannel，calico</p>
<p>k8s的存储，clusterFS，ceph</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://mo-li001.github.io">壹拾陆</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://mo-li001.github.io/posts/64202.html">https://mo-li001.github.io/posts/64202.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mo-li001.github.io" target="_blank">壹拾陆</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><div class="post_share"><div class="social-share" data-image="https://tuchuangs.com/imgs/2022/09/18/074f3836d4f471b8.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/90f47a19.html"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">自动化装机</div></div></a></div><div class="next-post pull-right"><a href="/posts/8fb4d8df.html"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">zabbix</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/9f353bc9.html" title="Devops"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Devops</div></div></a></div><div><a href="/posts/f5f9fa9b.html" title="Docker"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Docker</div></div></a></div><div><a href="/posts/34d20e28.html" title="ELK"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">ELK</div></div></a></div><div><a href="/posts/8005.html" title="ELK快速部署"><img class="cover" src="https://tuchuangs.com/imgs/2022/09/18/074f3836d4f471b8.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">ELK快速部署</div></div></a></div><div><a href="/posts/9bdc030a.html" title="HAproxy"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">HAproxy</div></div></a></div><div><a href="/posts/a71433d.html" title="Ansible"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Ansible</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202209182232723.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">壹拾陆</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">68</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mo-li001/"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">个人笔记</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8B%B1%E6%96%87%E5%8D%95%E8%AF%8D%E8%A1%A8"><span class="toc-text">英文单词表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%B1%87%E6%80%BB%E8%A1%A8"><span class="toc-text">命令汇总表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day09-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E7%AC%94%E8%AE%B0"><span class="toc-text">day09-操作系统目录结构笔记</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day13-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9F%A5%E8%AF%86"><span class="toc-text">day13-操作系统知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day14-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9F%A5%E8%AF%86%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7"><span class="toc-text">day14-操作系统知识文件属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day16-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9F%A5%E8%AF%86%E6%AD%A3%E5%88%99%E7%AC%A6%E5%90%88"><span class="toc-text">day16-操作系统知识正则符合</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day17-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9F%A5%E8%AF%86%E6%AD%A3%E5%88%99%E7%AC%A6%E5%90%88"><span class="toc-text">day17-操作系统知识正则符合</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day22-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%AF%87-P260"><span class="toc-text">day22-操作系统定时任务篇 P260</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day23-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86%E8%AF%B4%E6%98%8E-P275"><span class="toc-text">day23-操作系统磁盘管理说明 P275</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day25-rsync"><span class="toc-text">day25-rsync</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day26-rsync-2"><span class="toc-text">day26-rsync-2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day27-nfs"><span class="toc-text">day27-nfs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day30-http"><span class="toc-text">day30-http</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day31-nginx-P359"><span class="toc-text">day31-nginx P359</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day32-nginxmodule"><span class="toc-text">day32-nginxmodule</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day31-lnmp-P388"><span class="toc-text">day31-lnmp P388</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day34-lnmp-%E6%8B%86%E5%88%86-P398"><span class="toc-text">day34-lnmp-拆分 P398</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day35-nginx%E4%BB%A3%E7%90%86-P404"><span class="toc-text">day35-nginx代理 P404</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day36-nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">day36-nginx负载均衡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day37-nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">day37-nginx负载均衡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day37-nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-4"><span class="toc-text">day37-nginx负载均衡-4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day-38-nginx%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB"><span class="toc-text">day-38-nginx动静分离</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day-38-nginx-https"><span class="toc-text">day-38-nginx-https</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day40-keepalived%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-text">day40-keepalived高可用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day42-nginx%E4%BC%98%E5%8C%96"><span class="toc-text">day42-nginx优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day43-zabbix-day01"><span class="toc-text">day43-zabbix-day01</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day48-firewalld"><span class="toc-text">day48-firewalld</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#day49-Ansible-Day01"><span class="toc-text">day49-Ansible-Day01</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Mysql"><span class="toc-text">Mysql</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MySQL-day01-06MySQL%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4%E8%AE%B2%E8%A7%A3%E5%8F%8A%E6%80%BB%E7%BB%93-P551"><span class="toc-text">MySQL-day01-06MySQL源码安装步骤讲解及总结  P551</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85MySQL-5-6-40"><span class="toc-text">源码安装MySQL-5.6.40</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MySQL-day01-07MySQL%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85"><span class="toc-text">MySQL-day01-07MySQL二进制安装</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MySQL-day02-01%E8%AF%AF%E5%88%A0%E9%99%A4root%E7%94%A8%E6%88%B7%E4%BD%9C%E4%B8%9A%E8%AE%B2%E8%A7%A3"><span class="toc-text">MySQL-day02-01误删除root用户作业讲解</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MySQL-day03-10MySQL%E5%A4%9A%E5%AE%9E%E4%BE%8B%E9%83%A8%E7%BD%B2%E5%8F%8A%E5%B0%8F%E6%8A%80%E5%B7%A7%E8%AE%B2%E8%A7%A3"><span class="toc-text">MySQL-day03-10MySQL多实例部署及小技巧讲解</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MySQL-day04-01%E4%B8%8A%E5%91%A8%E8%AF%BE%E7%A8%8B%E5%9B%9E%E9%A1%BE"><span class="toc-text">MySQL-day04-01上周课程回顾</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%80%81%E7%94%B7%E5%AD%A9%E6%95%99%E8%82%B2%E4%B8%8A%E6%B5%B7linux%E8%84%B1%E4%BA%A73%E6%9C%9FMySQL-day04-04SQL%E8%AF%AD%E5%8F%A5DDL-%E5%BA%93%E6%93%8D%E4%BD%9C%E8%AE%B2%E8%A7%A3"><span class="toc-text">老男孩教育上海linux脱产3期MySQL-day04-04SQL语句DDL-库操作讲解</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%80%81%E7%94%B7%E5%AD%A9%E6%95%99%E8%82%B2%E4%B8%8A%E6%B5%B7Linux3%E6%9C%9FMySQL-day07-04%E8%A1%A8%E7%A9%BA%E9%97%B4%E8%A1%A8%E7%BB%93%E6%9E%84%E6%8D%9F%E5%9D%8F%E4%BC%81%E4%B8%9A%E6%A1%88%E4%BE%8B%E8%AE%B2%E8%A7%A3"><span class="toc-text">老男孩教育上海Linux3期MySQL-day07-04表空间表结构损坏企业案例讲解</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%80%81%E7%94%B7%E5%AD%A9%E6%95%99%E8%82%B2%E4%B8%8A%E6%B5%B7Linux3%E6%9C%9FMySQL-day13-08MySQL%E9%AB%98%E5%8F%AF%E7%94%A8MHA%E6%9E%B6%E6%9E%84%E8%AE%B2%E8%A7%A3"><span class="toc-text">老男孩教育上海Linux3期MySQL-day13-08MySQL高可用MHA架构讲解</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%80%81%E7%94%B7%E5%AD%A9%E6%95%99%E8%82%B2%E4%B8%8A%E6%B5%B7Linux3%E6%9C%9FMySQL-day13-09MySQL%E9%AB%98%E5%8F%AF%E7%94%A8MHA%E5%B7%A5%E5%85%B7%E5%8C%85%E8%AE%B2%E8%A7%A3"><span class="toc-text">老男孩教育上海Linux3期MySQL-day13-09MySQL高可用MHA工具包讲解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Shelll%E8%AF%BE%E7%A8%8B%E5%A4%A7%E7%BA%B2"><span class="toc-text">1.Shelll课程大纲</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-Shell%E5%8F%98%E9%87%8F%E8%BF%90%E7%AE%97"><span class="toc-text">4.Shell变量运算</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#03-Shell%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6"><span class="toc-text">03.Shell流程控制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5if%E5%9F%BA%E6%9C%AC%E6%A6%82%E8%BF%B0"><span class="toc-text">1.流程控制语句if基本概述</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5if%E6%96%87%E4%BB%B6%E6%AF%94%E8%BE%83"><span class="toc-text">2.流程控制语句if文件比较</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5case%E5%9F%BA%E6%9C%AC%E6%A6%82%E8%BF%B0"><span class="toc-text">7.流程控制语句case基本概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%87%BD%E6%95%B0%E5%9F%BA%E6%9C%AC%E6%A6%82%E8%BF%B0"><span class="toc-text">1.函数基本概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%87%BD%E6%95%B0%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-text">2.函数基本使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%87%BD%E6%95%B0%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92-P720"><span class="toc-text">3.函数参数传递 P720</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%87%BD%E6%95%B0%E7%8A%B6%E6%80%81%E8%BF%94%E5%9B%9E"><span class="toc-text">4.函数状态返回</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%87%BD%E6%95%B0%E5%9C%BA%E6%99%AF%E7%A4%BA%E4%BE%8B"><span class="toc-text">5.函数场景示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#07-Shell%E6%95%B0%E7%BB%84%E5%BA%94%E7%94%A8"><span class="toc-text">07.Shell数组应用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%95%B0%E7%BB%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-text">2.数组基本使用</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%95%B0%E7%BB%84%E9%81%8D%E5%8E%86%E4%B8%8E%E5%BE%AA%E7%8E%AF"><span class="toc-text">3.数组遍历与循环</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#08-Shell%E6%AD%A3%E5%88%99%E5%BA%94%E7%94%A8"><span class="toc-text">08.Shell正则应用</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%A4%BA%E4%BE%8B"><span class="toc-text">1.正则表达式示例</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-Awk%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D"><span class="toc-text">1.Awk基本介绍</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#01-%E5%AE%B9%E5%99%A8%E7%AE%80%E4%BB%8B%E5%92%8C%E8%99%9A%E6%8B%9F%E5%8C%96%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">01-容器简介和虚拟化的区别</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#KVM"><span class="toc-text">KVM</span></a></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/90f47a19.html" title="自动化装机">自动化装机</a><time datetime="2023-02-02T12:41:14.000Z" title="发表于 2023-02-02 20:41:14">2023-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/64202.html" title="linux">linux</a><time datetime="2023-02-02T12:41:14.000Z" title="发表于 2023-02-02 20:41:14">2023-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/8fb4d8df.html" title="zabbix">zabbix</a><time datetime="2023-02-02T01:43:57.000Z" title="发表于 2023-02-02 09:43:57">2023-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/8d6735b8.html" title="超经典SQL练习题，做完这些你的ＳＱＬ就过关了">超经典SQL练习题，做完这些你的ＳＱＬ就过关了</a><time datetime="2023-02-02T01:43:57.000Z" title="发表于 2023-02-02 09:43:57">2023-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/39d18a59.html" title="Mermaid绘图">Mermaid绘图</a><time datetime="2023-01-11T12:41:14.000Z" title="发表于 2023-01-11 20:41:14">2023-01-11</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 壹拾陆</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>