<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Ansible | 壹拾陆</title><meta name="keywords" content="Linux"><meta name="author" content="壹拾陆"><meta name="copyright" content="壹拾陆"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="AnsibleAnsible大纲： Ansible被红帽收购  什么是Ansible Ansible特性\优点…. Ansible基础架构（控制端\被控端\inventory\ad-hoc\playbook\连接协议….） Ansible安装 Ansible配置 Ansible inventory Ansible Ad-hoc    shell命令 Ansible playbook    shel">
<meta property="og:type" content="article">
<meta property="og:title" content="Ansible">
<meta property="og:url" content="https://mo-li001.github.io/posts/a71433d.html">
<meta property="og:site_name" content="壹拾陆">
<meta property="og:description" content="AnsibleAnsible大纲： Ansible被红帽收购  什么是Ansible Ansible特性\优点…. Ansible基础架构（控制端\被控端\inventory\ad-hoc\playbook\连接协议….） Ansible安装 Ansible配置 Ansible inventory Ansible Ad-hoc    shell命令 Ansible playbook    shel">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-08-31T12:41:14.000Z">
<meta property="article:modified_time" content="2022-10-23T15:32:55.000Z">
<meta property="article:author" content="壹拾陆">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://mo-li001.github.io/posts/a71433d"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Ansible',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-23 23:32:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202209182232723.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">68</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">壹拾陆</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Ansible</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-31T12:41:14.000Z" title="发表于 2022-08-31 20:41:14">2022-08-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-10-23T15:32:55.000Z" title="更新于 2022-10-23 23:32:55">2022-10-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Ansible"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Ansible"><a href="#Ansible" class="headerlink" title="Ansible"></a><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1tG411W7gF?p=3&vd_source=629395ac7befa1625191c3f496068941">Ansible</a></h1><p>Ansible大纲：</p>
<p>Ansible被红帽收购</p>
<ol>
<li>什么是Ansible</li>
<li>Ansible特性\优点….</li>
<li>Ansible基础架构（控制端\被控端\inventory\ad-hoc\playbook\连接协议….）</li>
<li>Ansible安装</li>
<li>Ansible配置</li>
<li>Ansible inventory</li>
<li>Ansible Ad-hoc    shell命令</li>
<li>Ansible playbook    shell脚本    YAML</li>
<li>变量 variables<br>变量优先级<br>………</li>
<li>判断语句</li>
<li>循环语句</li>
<li>异常处理</li>
<li>tag标签</li>
<li>handlers触发器</li>
<li>include包含</li>
<li>ansible jinjia模板<br>keeplaived<br>nginx_proxy</li>
<li>ansible role角色<br>编排工具—&gt;清晰目录规划—&gt;严格按照目录规划来</li>
<li>ansible galaxy</li>
<li>ansible tower</li>
<li>ansible部署集群架构</li>
</ol>
<h2 id="1-Ansible基础概述"><a href="#1-Ansible基础概述" class="headerlink" title="1.Ansible基础概述"></a>1.Ansible基础概述</h2><p>1.什么是Ansible<br>Ansible是一个IT自动化的配置管理工具，自动化主要体现在Ansible集成了丰富模块，丰富的功能的组件，可以通过一个命令行完成一系列的操作。进而能减少我们重复性的工作和维护成本，以提高工作的效率。</p>
<blockquote>
<p>假设我们要在10台linux服务器上安装一个nginx服务，手动如何做的？</p>
<p>第一步、ssh登陆NUM(1..n)服务器</p>
<p>第二步、输入对应服务器密码</p>
<p>第三步、安装yum install nginx</p>
<p>第四步、启动systemctl start nginx</p>
<p>第五步、退出登录</p>
<p>循环操作n&#x3D;10次</p>
</blockquote>
<p>2.Ansible可以完成哪些功能呢</p>
<p>1）批量执行远程命令，可以对N多台主机同时进行命令的执行。</p>
<p>2）批量配置软件服务，可以进行自动化的方式配置和管理服务。</p>
<p>3）实现软件开发功能，jumpserver底层使用ansible来实现的自动化管理。</p>
<p>4）编排高级的IT任务，Ansible的Playbook是一门编程语言，可以用来描绘一套IT架构。</p>
<p>3.Ansible特点</p>
<p>1.容易学习，无代理模式，不像saltstack既要学客户端与服务端，还需要学习客户端与服务端中间通讯协议</p>
<p>2.操作灵活，体现在Ansible有较多的模块，提供了丰富的功能、playbook则提供类似于编程语言的复杂功能</p>
<p>3.简单易用，体现在Ansible一个命令可以完成很多事情。</p>
<p>4.安全可靠，因为Ansible使用了SSH协议进行通讯，既稳定也安全。</p>
<p>5.移植性高，可以将写好的playbook拷贝至任意机器进行执行</p>
<p>4.Ansible的架构中的控制节点、被控制节点、inventroy、ad-hoc、playbook、连接协议这些是什么?</p>
<p><img src="D:\文件管理\Typora\images\Ansible.assest\image-20220714142526794.png" alt="image-20220714142526794"></p>
<h2 id="3-Ansible安装配置"><a href="#3-Ansible安装配置" class="headerlink" title="3.Ansible安装配置"></a>3.Ansible安装配置</h2><p>1.Ansible安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装ansible</span></span><br><span class="line">[root@master ~]# yum install ansible -y</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看ansible版本</span></span><br><span class="line">[root@master ~]# ansible --version</span><br><span class="line">ansible 2.9.27</span><br><span class="line">  config file = /etc/ansible/ansible.cfg</span><br><span class="line">  configured module search path = [u&#x27;/root/.ansible/plugins/modules&#x27;, u&#x27;/usr/share/ansible/plugins/modules&#x27;]</span><br><span class="line">  ansible python module location = /usr/lib/python2.7/site-packages/ansible</span><br><span class="line">  executable location = /usr/bin/ansible</span><br><span class="line">  python version = 2.7.5 (default, Oct 14 2020, 14:45:30) [GCC 4.8.5 20150623 (Red Hat 4.8.5-44)]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible &lt;host-pattern&gt; [options]</span></span><br><span class="line">--version    #ansible版本信息</span><br><span class="line">-v    #显示详细信息</span><br><span class="line">-i    #主机情单文件略径，默认是在/etc/ansible/hosts</span><br><span class="line">-m    #使用的模块名称，默认使用command模块</span><br><span class="line">-a    #使用的模块参数，模块的具体动作</span><br><span class="line">-k    #提示输入ssh密码，而不使用基于ssh的密钥认证</span><br><span class="line">-C    #模拟执行测试，但不会真的执行</span><br><span class="line">-T    #执行命令的超时</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>ansible配置文件存在优先级的问题<br>   ANSIBLE_CONFIG<br>   ansible.cfg    项目目录<br>   .ansible.cfg    当前用户的家目录<br>   &#x2F;etc&#x2F;ansible&#x2F;ansible.cfg</p>
</blockquote>
<p>2.Ansible的配置文件可以存放在任何位置，但配置文件有读取顺序，先Ansible配置做一个基本了解。</p>
<p>ansible的配置文件有查找顺序：</p>
<p>​	1)最先查找$ANSIBLE_CONFIG变量</p>
<p>​	2)其次查找当前目录下ansible.cfg</p>
<p>​	3)然后查找用户家目录下的.ansible.cfg</p>
<p>​	4)最后查找etc&#x2F;ansible&#x2F;ansible.cfg(默认)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/ansible/ansible.cfg </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">inventory      = /etc/ansible/hosts    <span class="comment">#主机列表配置文件</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">library        = /usr/share/my_modules/    <span class="comment">#库文件存放目录</span></span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">remote_tmp     = ~/.ansible/tmp    <span class="comment">#临时py文件存放在远程主机目录</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">local_tmp      = ~/.ansible/tmp    <span class="comment">#本机的临时执行目录</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">forks          = 5    <span class="comment">#默认并发数</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">sudo_user      = root    <span class="comment">#默认sudo用户</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ask_sudo_pass = True    <span class="comment">#每次执行是否询问sudo的ssh密码</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ask_pass      = True    <span class="comment">#每次执行是否询问ssh密码</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">remote_port    = 22    <span class="comment">#远程主机端口</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">host_key_checking = False    <span class="comment">#跳过检查主机指纹</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">log_path = /var/log/ansible.log    <span class="comment">#ansible日志</span></span></span><br><span class="line"></span><br><span class="line">[privilege_escalation]    #如果是普通用户则需要配置提权</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">become=True</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">become_method=sudo</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">become_user=root</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">become_ask_pass=False</span></span><br></pre></td></tr></table></figure>



<h2 id="4-Ansible-Inventory"><a href="#4-Ansible-Inventory" class="headerlink" title="4.Ansible Inventory"></a>4.Ansible Inventory</h2><p>Inventory文件中填写需要被管理主机与主机组信息（逻辑上定义)。默认Inventory文件在&#x2F;etc&#x2F;ansible&#x2F;hosts。当然也可以自定义，然后使用 -i 指定Inventory文件位置。下面通过几个场景演示，如何配置Inventory文件</p>
<p>1.场景一、基于密码连接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/ansible/hosts</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方式一、主机+端口+密码</span></span><br><span class="line">[webservers]</span><br><span class="line">10.0.0.31 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=&#x27;123456&#x27;</span><br><span class="line">10.0.0.41 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=&#x27;123456&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方式二、主机+端口+密码</span></span><br><span class="line">[webservers]</span><br><span class="line">web[1:2].oldboy.com ansible_ssh_pass=&#x27;123456&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方式三、主机+端口+密码</span></span><br><span class="line">[webservers]</span><br><span class="line">web[1:2].oldbay.com</span><br><span class="line">[webservers:vars]</span><br><span class="line">ansible_ssh_pass=&#x27;123456&#x27;</span><br></pre></td></tr></table></figure>

<p>练习</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方式一、主机+端口+密码</span></span><br><span class="line">[root@master ~]# mkdir project1</span><br><span class="line">[root@master ~]# cd project1/</span><br><span class="line">[root@master project1]# vim hosts  #文件名称不固定，可以是自定义oldboy</span><br><span class="line">[oldboy]</span><br><span class="line">192.168.160.4 ansible_ssh_user=root ansible_ssh_pass=&#x27;yyr12580&#x27;</span><br><span class="line">192.168.160.5 ansible_ssh_user=root ansible_ssh_pass=&#x27;yyr12580&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认找/etc/ansible/hosts文件，需要-i指定找当前目录的hosts，-m执行什么模块，ping模块</span></span><br><span class="line">[root@master project1]# ansible oldboy -m ping -i hosts</span><br><span class="line">192.168.160.4 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.160.5 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>2.场景二、基于密钥连接，需要先创建公钥和私钥，并下发公钥至被控端</p>
<p>[root@master ~]# ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub <a href="mailto:&#114;&#x6f;&#x6f;&#116;&#64;&#49;&#x37;&#x32;&#x2e;&#x31;&#54;&#46;&#49;&#46;&#x37;">&#114;&#x6f;&#x6f;&#116;&#64;&#49;&#x37;&#x32;&#x2e;&#x31;&#54;&#46;&#49;&#46;&#x37;</a></p>
<p>[root@master ~]# ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub <a href="mailto:&#x72;&#111;&#x6f;&#x74;&#64;&#49;&#55;&#50;&#x2e;&#x31;&#x36;&#x2e;&#x31;&#x2e;&#56;">&#x72;&#111;&#x6f;&#x74;&#64;&#49;&#55;&#50;&#x2e;&#x31;&#x36;&#x2e;&#x31;&#x2e;&#56;</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方式一、主机+端口+密钥</span></span><br><span class="line">[root@manager ~]# cat hosts</span><br><span class="line">[webservers]</span><br><span class="line">172.16.1.7</span><br><span class="line">172.16.1.8</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方式二、别名+主机+端口+密钥</span></span><br><span class="line">[root@manager ~]# cat hosts</span><br><span class="line">[webservers]</span><br><span class="line">web01 ansible_ssh_host=172.16.1.7 ansible_ssh_port=22</span><br><span class="line">web02 ansible_ssh_host=172.16.1.8</span><br></pre></td></tr></table></figure>

<p>练习</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">方式一、主机+端口+密钥</span></span><br><span class="line">[root@master project1]# ssh-keygen</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.ansible管理机下发公钥</span></span><br><span class="line">[root@master ~]# sshpass -p yyr12580 ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.160.4</span><br><span class="line">[root@master ~]# ssh &#x27;root@192.168.160.4&#x27;</span><br><span class="line">[root@master ~]# sshpass -p yyr12580 ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.160.5</span><br><span class="line">[root@master ~]# ssh &#x27;root@192.168.160.5&#x27;</span><br><span class="line">[root@master project1]# vim hosts </span><br><span class="line">[oldboy]</span><br><span class="line">192.168.160.4</span><br><span class="line">192.168.160.5</span><br><span class="line">[root@master project1]# ansible oldboy -m ping -i hosts</span><br><span class="line">192.168.160.4 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.160.5 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.场景三、主机组使用方式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[lbservers] #定义lbservers组</span><br><span class="line">172.16.1.5</span><br><span class="line">172.16.1.6</span><br><span class="line"></span><br><span class="line">[webservers] #定义webserver组</span><br><span class="line">172.16.1.7</span><br><span class="line">172.16.1.8</span><br><span class="line"></span><br><span class="line">[servers:children] #定义servers组包括两个子组[lbservers,webserver]</span><br><span class="line">lbservers</span><br><span class="line">webserver</span><br></pre></td></tr></table></figure>

<p>4.列出每个主机组下面的主机情况</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@manager ~]# ansible lbservers -m ping -i ./hosts --list-hosts</span><br><span class="line">  hosts (1):</span><br><span class="line">    web01</span><br><span class="line">[root@manager ~]# ansible webservers -m ping -i ./hosts --list-hosts</span><br><span class="line">  hosts (1):</span><br><span class="line">    web02</span><br><span class="line">[root@manager ~]# ansible servers -m ping -i ./hosts --list-hosts</span><br><span class="line">  hosts (2):</span><br><span class="line">  web01</span><br><span class="line">  web02</span><br><span class="line">[root@manager ~]# ansible all -m ping -i ./hosts --list-hosts</span><br><span class="line">  hosts (3):</span><br><span class="line">    web01</span><br><span class="line">    web02</span><br><span class="line">    web03</span><br></pre></td></tr></table></figure>

<p>练习</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@master project1]# ansible oldboy -i hosts --list-hosts</span><br><span class="line">  hosts (2):</span><br><span class="line">    192.168.160.4</span><br><span class="line">    192.168.160.5</span><br><span class="line">[root@master project1]# ansible oldboy -m ping -i ./hosts</span><br><span class="line">192.168.160.5 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.160.4 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>生产案例1、如果控制端和被控制端第一次通讯，需要确认指纹信息，如果机器特别多少的情况下怎么办？</p>
<p>将 Ansible 配置文件中的 host_key_checking  &#x3D; False 参数注释打开即可。但要注意ansible.cfg的读取顺序。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">打开注释host_key_checking = False</span></span><br><span class="line">[root@master project1]# vim /etc/ansible/ansible.cfg</span><br><span class="line">host_key_checking = False</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">确保读取是/etc/ansible/ansible.cfg配置文件</span></span><br><span class="line">[root@master project1]# ansible --version</span><br><span class="line">ansible 2.9.27</span><br><span class="line">  config file = /etc/ansible/ansible.cfg</span><br></pre></td></tr></table></figure>



<h1 id="02-Ansible-Ad-Hoc"><a href="#02-Ansible-Ad-Hoc" class="headerlink" title="02 Ansible Ad-Hoc"></a>02 Ansible Ad-Hoc</h1><p>1.什么是ad-hoc<br>ad-hoc简而言之就是“临时命令”，执行完即结束，并不会保存</p>
<p>2.ad-hoc模式的使用场景，<br>比如在多台机器上查看某个进程是否启动，或拷贝指定文件到本地，等等</p>
<p>3.ad-hoc模式的命令使用，ansible ‘oldboy’ -m command -a ‘df-h’，含义如下图</p>
<table>
<thead>
<tr>
<th>命令格式</th>
<th>ansible</th>
<th>‘oldboy’</th>
<th>-m</th>
<th>command</th>
<th>-a</th>
<th>‘df -h’</th>
</tr>
</thead>
<tbody><tr>
<td>格式说明</td>
<td>命令</td>
<td>主机名称</td>
<td>指定模块</td>
<td>模块名称</td>
<td>模块动作</td>
<td>具体命令</td>
</tr>
</tbody></table>
<p>练习</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@master project1]# ansible oldboy -m command -a &quot;df -h&quot; -i hosts</span><br><span class="line">192.168.160.5 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">文件系统                 容量  已用  可用 已用% 挂载点</span><br><span class="line">devtmpfs                 898M     0  898M    0% /dev</span><br><span class="line">tmpfs                    910M     0  910M    0% /dev/shm</span><br><span class="line">tmpfs                    910M   82M  829M    9% /run</span><br><span class="line">tmpfs                    910M     0  910M    0% /sys/fs/cgroup</span><br><span class="line">/dev/mapper/centos-root   17G  5.1G   12G   30% /</span><br><span class="line">/dev/sda1               1014M  151M  864M   15% /boot</span><br><span class="line">tmpfs                    182M     0  182M    0% /run/user/0</span><br><span class="line">192.168.160.4 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">文件系统                 容量  已用  可用 已用% 挂载点</span><br><span class="line">devtmpfs                 898M     0  898M    0% /dev</span><br><span class="line">tmpfs                    910M     0  910M    0% /dev/shm</span><br><span class="line">tmpfs                    910M   44M  866M    5% /run</span><br><span class="line">tmpfs                    910M     0  910M    0% /sys/fs/cgroup</span><br><span class="line">/dev/mapper/centos-root   17G  5.5G   12G   32% /</span><br><span class="line">/dev/sda1               1014M  151M  864M   15% /boot</span><br><span class="line">tmpfs                    182M     0  182M    0% /run/user/0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-f指定并发数，同时返回多少台设备信息</span></span><br><span class="line">[root@master project1]# ansible oldboy -m command -a &quot;sleep 2&quot; -i hosts -f 10</span><br><span class="line">[root@master project1]# ansible oldboy -m command -a &quot;sleep 2&quot; -i hosts -f 1</span><br></pre></td></tr></table></figure>



<p>4.使用ad-hoc执行一次远程命令，注意观察返回结果的颜色<br>绿色：代表被管理端主机没有被修改<br>黄色：代表被管理端主机发现变更<br>红色：代表出现了故障，注意查看提示</p>
<blockquote>
<p><strong>常用模块</strong></p>
<p>命令    command（默认）  shell模块</p>
<p>安装    yum</p>
<p>配置    copy</p>
<p>启动    service  systemd</p>
<p>任务    cron</p>
<p>挂载    mount</p>
<p>防火墙    firewall  selinux</p>
<p>创建目录文件    file</p>
<p>下载文件    get_url</p>
<p>脚本模块    scripts</p>
</blockquote>
<p>5.ad-hoc模式的常用模块有如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">command    #执行shell命令（不支持管道等特殊字符）</span><br><span class="line">shell    #执行shell命令</span><br><span class="line">scripts    #执行shell脚本</span><br><span class="line">yum_repository    #配置yum仓库</span><br><span class="line">yum    #安装软件</span><br><span class="line">copy    #变更配置文件</span><br><span class="line">file    #建立目录或文件</span><br><span class="line">service    #启动与停止服务</span><br><span class="line">mount    #挂载设备</span><br><span class="line">cron    #定时任务</span><br><span class="line">firewalld    #防火墙</span><br><span class="line">get_url    #下载软件</span><br></pre></td></tr></table></figure>

<p>6.使用过程中需要先了解ansible-doc帮助手册</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]# ansible-doc -l    #查看所有模块说明</span><br><span class="line">[root@m01 ~]# ansible-doc copy    #表示指定模块方法</span><br><span class="line">[root@m01 ~]# ansible-doc -s copy    #表示指定模块参数</span><br></pre></td></tr></table></figure>



<h2 id="1-执行命令模块"><a href="#1-执行命令模块" class="headerlink" title="1.执行命令模块"></a>1.执行命令模块</h2><p>1.command 命令模块，不支持重定向或管道</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">默认模块，执行命令</span></span><br><span class="line">[root@m01 ~]# ansible oldboy -a &quot;hostname&quot;</span><br></pre></td></tr></table></figure>

<p>2.shell模块，如果需要一些管道操作，则使用shell</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]# ansible oldboy -m shell -a &quot;ifconfig|grep eth0&quot; -f 50</span><br></pre></td></tr></table></figure>

<p>3.script脚本模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">编写脚本</span></span><br><span class="line">[root@m01 ~]# mkdir -p /server/scripts</span><br><span class="line">[root@m01 ~]# cat /server/scripts/yum.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/bash</span></span><br><span class="line">yum install -y iftop</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在本地运行模块，等同于在远程执行，不需要将脚本文件进行推送目标主机执行</span></span><br><span class="line">[root@m01 ~]# ansible oldboy -m script -a &quot;/server/scripts/yum.sh&quot;</span><br></pre></td></tr></table></figure>



<h2 id="2-软件管理模块"><a href="#2-软件管理模块" class="headerlink" title="2.软件管理模块"></a>2.软件管理模块</h2><p>ansible软件管理模块，需要使用到yum</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>选项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>httpd、nginx、…</td>
<td>指定安装软件包名或软件包URL</td>
</tr>
<tr>
<td>state</td>
<td>present(Defaults)、absent、latest</td>
<td>指定yum对应的方法</td>
</tr>
<tr>
<td>enablerepo</td>
<td>epel、base、…</td>
<td>允许从哪些仓库获取软件</td>
</tr>
<tr>
<td>disablerepo</td>
<td>epel、base、…</td>
<td>禁止从哪些仓库获取软件</td>
</tr>
<tr>
<td>exclude</td>
<td>kernel、…</td>
<td>排除某些软件包</td>
</tr>
<tr>
<td>download_only</td>
<td>yes、no</td>
<td>仅下载软件包，不安装</td>
</tr>
</tbody></table>
<p>Exampless</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例一、安装当前最新的Apache软件，如果存在则不安装</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m yum -a <span class="string">&quot;name=httpd state=present&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例二、安装当前最新的Apache软件，通过epel仓库安装</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m yum -a <span class="string">&quot;name=httpd state=present enablerepo=epel&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例三、通过公网URL安装rpm软件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m yum -a <span class="string">&quot;name=https://xx.rpm state=present&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例四、安装最新版本的Apache软件，如果存在则更新Apache</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m yum -a <span class="string">&quot;name=httpd state=latest&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例五、更新所有的软件包，但排除和kernel相关的</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m yum -a <span class="string">&quot;name=* state=latest exclude=kernel&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例六、删除Apache软件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m yum -a <span class="string">&quot;name=httpd state=absent&quot;</span></span></span><br></pre></td></tr></table></figure>



<p>练习</p>
<p>1.yum模块（安装present  卸载absent  升级latest  排除exclude  指定仓库enablerepo）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例一、安装当前最新的Apache软件，如果存在则更新</span></span><br><span class="line">[root@master project1]# pwd</span><br><span class="line">/root/project1</span><br><span class="line">[root@master project1]# ansible oldboy -m yum -a &quot;name=httpd state=latest&quot; -i hosts</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看被控端执行状态</span></span><br><span class="line">root@node1 ~]# ps aux|grep yum</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例二、安装当前最新的Apache软件，通过epel仓库安装</span></span><br><span class="line">[root@master project1]# ansible oldboy -m yum -a &quot;name=httpd state=latest enablerepo=epel&quot; -i hosts</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例三、通过公网URL安装rpm软件</span></span><br><span class="line">[root@master project1]# ansible oldboy -m yum -a &quot;name=https://mirrors.aliyun.com/zabbix/zabbix/4.2/rhel/7/x86_64/zabbix-get-4.2.3-2.el7.x86_64.rpm state=latest&quot; -i hosts</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看被控端安装成功</span></span><br><span class="line">[root@node1 ~]# rpm -qa zabbix-get</span><br><span class="line">zabbix-get-4.2.3-2.el7.x86_64</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例五、更新所有的软件包，但排除和kernel相关的</span></span><br><span class="line">[root@master project1]# ansible oldboy -m yum -a &quot;name=* state=latest exclude=kernel*&quot; -i hosts</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例六、删除Apache软件</span></span><br><span class="line">[root@master project1]# ansible oldboy -m yum -a &quot;name=httpd state=absent&quot; -i hosts</span><br><span class="line">[root@node1 ~]# rpm -qa httpd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">正常安装Apache软件</span></span><br><span class="line">[root@master project1]# ansible oldboy -m yum -a &quot;name=httpd state=present&quot; -i hosts</span><br><span class="line">[root@node1 ~]# rpm -qa httpd</span><br><span class="line">httpd-2.4.6-97.el7.centos.5.x86_64</span><br></pre></td></tr></table></figure>



<p>练习</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">-------copy    常用src、dest、owner、group、mode、backup、content</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例一、将本地的httpd.conf文件Listen端口修改为9999,然后推送到远端服务。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拷贝被控端的配置文件到控制端</span></span><br><span class="line">[root@node1 ~]# scp /etc/httpd/conf/httpd.conf root@192.168.160.3:/root/project1/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改配置文件</span></span><br><span class="line">[root@master project1]# vim httpd.conf </span><br><span class="line">Listen 9999</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置文件推送到被控端</span></span><br><span class="line">[root@master project1]# ansible oldboy -m copy -a &quot;src=./httpd.conf dest=/etc/httpd/conf/httpd.conf owner=root group=root mode=644&quot; -i hosts</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改配置文件</span></span><br><span class="line">[root@master project1]# vim httpd.conf </span><br><span class="line">Listen 6666</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例二、将本地的httpd.conf文件Listen端口修改为9090，然后推送到远端，检查远端是否存在上一次的备份文件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">backup=<span class="built_in">yes</span> 将发送修改的文件备份</span></span><br><span class="line">[root@master project1]# ansible oldboy -m copy -a &quot;src=./httpd.conf dest=/etc/httpd/conf/httpd.conf owner=root group=root mode=644 backup=yes&quot; -i hosts</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看被控端备份文件</span></span><br><span class="line">[root@node2 conf]# ll /etc/httpd/conf/</span><br><span class="line">总用量 40</span><br><span class="line">-rw-r--r--. 1 root root 11755 7月  14 22:59 httpd.conf</span><br><span class="line">-rw-r--r--. 1 root root 11755 7月  14 22:57 httpd.conf.35069.2022-07-14@22:59:49~</span><br><span class="line">[root@node2 conf]# vimdiff httpd.conf httpd.conf.35069.2022-07-14\@22\:59\:49~</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例三、往远程的主机文件中写入内容</span></span><br><span class="line">[root@master project1]# ansible oldboy -m copy -a &quot;content=HttpServer... dest=/var/www/html/index.html&quot; -i hosts</span><br><span class="line">[root@node2 conf]# cat /var/www/html/index.html </span><br><span class="line">HttpServer...[root@node2 conf]# </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改配置文件</span></span><br><span class="line">[root@master project1]# vim httpd.conf </span><br><span class="line">Listen 9988</span><br><span class="line">[root@master project1]# ansible oldboy -m copy -a &quot;src=./httpd.conf dest=/etc/httpd/conf/httpd.conf owner=root group=root mode=644 backup=yes&quot; -i hosts</span><br><span class="line">[root@node2 conf]# systemctl restart httpd</span><br><span class="line">浏览器访问http://192.168.160.5:9988/</span><br><span class="line"></span><br><span class="line">-------get_url</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例一、下载互联网的软件至本地</span></span><br><span class="line">url ==&gt; http https ftp</span><br><span class="line">[root@master project1]# ansible oldboy -m get_url -a &quot;url=http://download.lsythink.online/dl/mysql/install_mysql.sh dest=/var/www/html/&quot; -i hosts</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例二、下载互联网文件并进行md5校验(了解)</span></span><br><span class="line">[root@node2 html]# md5sum install_mysql.sh </span><br><span class="line">428686555272c3931823e49dc29be4fe  install_mysql.sh</span><br><span class="line">[root@master project1]# ansible oldboy -m get_url -a &quot;url=http://download.lsythink.online/dl/mysql/install_mysql.sh dest=/var/www/html/ checksum=md5:428686555272c3931823e49dc29be4fe&quot; -i hosts</span><br><span class="line"></span><br><span class="line">-------file  创建目录  授权</span><br><span class="line">state  touch  directory</span><br><span class="line">recurse</span><br><span class="line">owner  group  mode</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例一、创建文件，并设定属主、属组、权限。</span></span><br><span class="line">[root@master project1]# ansible oldboy -m file -a &quot;path=/var/www/html/tt.html state=touch owner=apache group=apache mode=664&quot; -i hosts</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例二、创建目录，并设定属主、属组、权限。</span></span><br><span class="line">[root@master project1]# ansible oldboy -m file -a &quot;path=/var/www/html/dd state=directory owner=apache group=apache mode=664&quot; -i hosts</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改权限</span></span><br><span class="line">[root@master project1]# ansible oldboy -m file -a &quot;path=/var/www/html/dd state=directory owner=apache group=apache mode=755&quot; -i hosts</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例三、递归授权目录的方式。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">没有递归</span></span><br><span class="line">[root@master project1]# ansible oldboy -m file -a &quot;path=/var/www/html/ owner=apache group=apache mode=755&quot; -i hosts</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">递归</span></span><br><span class="line">[root@master project1]# ansible oldboy -m file -a &quot;path=/var/www/html/ owner=apache group=apache recurse=yes&quot; -i hosts</span><br></pre></td></tr></table></figure>



<p>2.file文件创建模块</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>选项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>path</td>
<td></td>
<td>指定远程服务器的路径</td>
</tr>
<tr>
<td>recurse</td>
<td></td>
<td>递归方式(可以是递归授权)</td>
</tr>
<tr>
<td>state</td>
<td>touch、 directory、 link、 absent</td>
<td>文件复制到远程的状态</td>
</tr>
<tr>
<td>owner</td>
<td>root(Defaults)</td>
<td>文件复制到远程并设定属组</td>
</tr>
<tr>
<td>group</td>
<td>root(Defaults)</td>
<td>备份被修改前的配置文件</td>
</tr>
<tr>
<td>mode</td>
<td>file&#x3D;644, directory&#x3D;755</td>
<td>文件复制到远程并设定权限</td>
</tr>
</tbody></table>
<p>Exampless</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例一、创建文件，并设定属主、属组、权限。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m file -a <span class="string">&quot;path=/tmp/foo.conf state=touch mode=666&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例二、创建目录，并设定属主、属组、权限。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m file -a <span class="string">&quot;path=/tmp/foo state=directory mode=777&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例三、递归授权目录的方式。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m file -a <span class="string">&quot;path=/tmp/foo state=directory owner=oldboy group=oldboy mode=777 recurse=yes&quot;</span></span></span><br></pre></td></tr></table></figure>



<p>3.get_url文件下载模块</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>选项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>url</td>
<td>HTTP, HTTPS…</td>
<td>资源文件在互联网上的具体位置</td>
</tr>
<tr>
<td>dest</td>
<td></td>
<td>文件下载位置的绝对路径</td>
</tr>
<tr>
<td>mode</td>
<td></td>
<td>文件下载后的权限</td>
</tr>
<tr>
<td>checksum</td>
<td>md5、sha256</td>
<td>对下载的资源进行校验</td>
</tr>
<tr>
<td>timeout</td>
<td>10(Default)</td>
<td>URL请求超时时间</td>
</tr>
</tbody></table>
<p>Exampless</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例一、下载互联网的软件至本地</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m get_url -a <span class="string">&quot;url=https://mirrors.aliyun.com/xx.rpm dest=/tmp&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例二、下载互联网文件并进行md5校验</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ansible webservers -m get_url -a <span class="string">&quot;url=http,https dest=/opt checksum=md5:76eb3af80ffd&quot;</span></span></span><br></pre></td></tr></table></figure>



<h2 id="4-服务管理模块"><a href="#4-服务管理模块" class="headerlink" title="4.服务管理模块"></a>4.服务管理模块</h2><p>ansible管理服务的启动与停止，使用service</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>选项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>httpd、 nginx、 …</td>
<td>定义要启动服务的名称</td>
</tr>
<tr>
<td>state</td>
<td>started、 stopped、 restarted、 reloaded</td>
<td>指定服务状态</td>
</tr>
<tr>
<td>enabled</td>
<td>yes、 no</td>
<td>允许服务开机自启或禁止服务开机自启</td>
</tr>
</tbody></table>
<p>Examples</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例一、启动Httpd服务</span></span><br><span class="line">[root@ansible ~]# ansible webservers -m service -a &quot;name=httpd state=started&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例二、重裁ttpd服务</span></span><br><span class="line">[root@ansible ~]# ansible webservers -m service -a &quot;name=httpd state=reloaded&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例三、重启Httpd服务</span></span><br><span class="line">[root@ansible ~]# ansible webservers -m service -a &quot;name=httpd state=restarted&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例四、停止Httpd服务</span></span><br><span class="line">[root@ansible ~]# ansible webservers -m service -a &quot;name=httpd state=stopped&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例五、启动Httpd服务，并如入开机自启</span></span><br><span class="line">[root@ansible ~]# ansible webservers -m service -a &quot;name=httpd state=started enabled=yes&quot;</span><br></pre></td></tr></table></figure>



<p>练习</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例一、启动Httpd服务</span></span><br><span class="line">[root@master project1]# ansible oldboy -m service -a &quot;name=httpd state=started&quot; -i hosts</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例二、重裁ttpd服务</span></span><br><span class="line">[root@ansible ~]# ansible oldboy -m service -a &quot;name=httpd state=reloaded&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例三、重启Httpd服务</span></span><br><span class="line">[root@master project1]# ansible oldboy -m service -a &quot;name=httpd state=restarted&quot; -i hosts</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">enable</span>=<span class="built_in">yes</span> 加入开机自启</span></span><br><span class="line">[root@master project1]# ansible oldboy -m service -a &quot;name=httpd state=restarted enabled=yes&quot; -i hosts</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看</span></span><br><span class="line">[root@node2 html]# systemctl is-enabled httpd</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">enabled=no 关闭开机自启</span></span><br><span class="line">[root@master project1]# ansible oldboy -m service -a &quot;name=httpd state=restarted enabled=no&quot; -i hosts</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看</span></span><br><span class="line">[root@node2 html]# systemctl is-enabled httpd</span><br><span class="line">disabled</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例四、停止Httpd服务</span></span><br><span class="line">[root@ansible ~]# ansible oldboy -m service -a &quot;name=httpd state=stopped&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例五、启动Httpd服务，并如入开机自启</span></span><br><span class="line">[root@ansible ~]# ansible oldboy -m service -a &quot;name=httpd state=started enabled=yes&quot;</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-------------</span><br><span class="line">  yum  安装</span><br><span class="line">  copy  配置</span><br><span class="line">  file  创建目录，或授权</span><br><span class="line">  get_url  下载文件</span><br><span class="line">  service  启动服务  重载服务</span><br><span class="line">------------- </span><br></pre></td></tr></table></figure>





<h2 id="5-用户管理模块"><a href="#5-用户管理模块" class="headerlink" title="5.用户管理模块"></a>5.用户管理模块</h2><p>ansible管理用户和组，使用user、group</p>
<p>1.group组模块</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>选项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td></td>
<td>指定创建的组名</td>
</tr>
<tr>
<td>gid</td>
<td></td>
<td>为组设置可选gid</td>
</tr>
<tr>
<td>state</td>
<td>present(Default)、 absent</td>
<td>是否将组创建在远程主机上</td>
</tr>
<tr>
<td>system</td>
<td>yes、 no(Default)</td>
<td>是否创建系统组</td>
</tr>
</tbody></table>
<p>Examples</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例一、创建news基本组，指定uid为9999</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m group -a <span class="string">&quot;name=news gid=9999 state=present&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例二、创建http系统组，指定uid为8888</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m group -a <span class="string">&quot;name=http gid=8888 system=true state=present&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例三、删除<span class="built_in">test</span>基本组</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m group -a <span class="string">&quot;name=news state=absent&quot;</span></span></span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看ansible有哪些模块</span></span><br><span class="line">[root@master project1]# ansible-doc -l</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看官方文档</span></span><br><span class="line">[root@master project1]# ansible-doc user</span><br></pre></td></tr></table></figure>



<p>练习</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">---------------------</span><br><span class="line">group</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例一、创建news基本组，指定uid为9999</span></span><br><span class="line">[root@master project1]# ansible oldboy -m group -a &quot;name=news gid=9999&quot; -i hosts</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">被控端查看</span></span><br><span class="line">[root@node2 html]# tail -1 /etc/group</span><br><span class="line">news:x:9999:</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例二、创建http系统组，指定uid为8888</span></span><br><span class="line">[root@master project1]# ansible oldboy -m group -a &quot;name=http gid=8888 system=yes state=present&quot; -i hosts</span><br><span class="line">yes  true  真</span><br><span class="line">no  false  假</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">被控端查看</span></span><br><span class="line">[root@node2 html]# tail -5 /etc/group</span><br><span class="line">mysql:x:1000:</span><br><span class="line">mockbuil:x:1001:</span><br><span class="line">apache:x:48:</span><br><span class="line">news:x:9999:</span><br><span class="line">http:x:8888:</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例三、删除news基本组</span></span><br><span class="line">[root@master project1]# ansible oldboy -m group -a &quot;name=news state=absent&quot; -i hosts</span><br></pre></td></tr></table></figure>



<p>8.user模块</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>选项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td></td>
<td>创建或删除的用户名</td>
</tr>
<tr>
<td>uid</td>
<td></td>
<td>为用户设置可选uid</td>
</tr>
<tr>
<td>group</td>
<td></td>
<td>为用户设置主要的组</td>
</tr>
<tr>
<td>groups</td>
<td></td>
<td>为用户设置附加的组</td>
</tr>
<tr>
<td>shell</td>
<td>present(Default)、 absent</td>
<td>为用户设置登陆时的shell</td>
</tr>
<tr>
<td>create_home</td>
<td>yes(Default)、 no</td>
<td>为用户创建主目录</td>
</tr>
<tr>
<td>state</td>
<td>present(Default)、 absent</td>
<td>用户是否应该存在</td>
</tr>
<tr>
<td>remove</td>
<td>yes、 no(Default)</td>
<td>删除与用户关联的目录，只有当state&#x3D;absent时生效</td>
</tr>
<tr>
<td>generate_ssh_key</td>
<td>yes、 no(Default)</td>
<td>为相关用户生成ssh密钥。不会覆盖现有的ssh密钥</td>
</tr>
<tr>
<td>ssh_key_bits</td>
<td>2048</td>
<td>创建用户ssh密钥中位数</td>
</tr>
<tr>
<td>ssh_key_file</td>
<td>.ssh&#x2F;id_rsa(Default)</td>
<td>可以实现ssh密钥改名，或变更存放ssh密钥位置</td>
</tr>
</tbody></table>
<p>Examples</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例一、创建joh用户，uid是1040，主要的组是adm</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m user -a <span class="string">&quot;name=joh uid=1040 group=adm&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例二、创建joh用户，登录shell是/sbin/nologin，追加bin、sys两个组</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m user -a <span class="string">&quot;name=joh shell=/sbin/nologin groups=bin,sys&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例三、创建jsm用户，为其添加123作为登录密码，并且创建家目录</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible localhost -m debug -a <span class="string">&quot;msg=&#123;&#123; &#x27;123&#x27; | password_hash(&#x27;sha512&#x27;, &#x27;salt&#x27;) &#125;&#125;&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">6$salt<span class="variable">$jkH</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m user -a <span class="string">&#x27;name=jsm password=&#x27;</span>$6$salt<span class="variable">$jkH</span><span class="string">&#x27; create_home=yes&#x27;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例四、移除joh用户</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m user -a <span class="string">&quot;name=joh remove=yes state=absent&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例五、创建http用户，并为该用户创建2048字节的私钥，存放在~/http/.ssh/idrsa</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m user -a <span class="string">&quot;name=http uid=8888 group=8888 generate_ssh_key=yes ssh_key_bits=2048 ssh_key_file=.ssh/id_rsa&quot;</span></span></span><br></pre></td></tr></table></figure>



<p>练习</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">---------------------</span><br><span class="line">user</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例一、创建joh用户，uid是1040，主要的组是adm</span></span><br><span class="line">[root@master project1]# ansible oldboy -m user -a &quot;name=joh uid=1040 group=adm&quot; -i hosts</span><br><span class="line">[root@node2 html]# id joh</span><br><span class="line">uid=1040(joh) gid=4(adm) 组=4(adm)</span><br><span class="line">[root@node2 html]# ll /home/</span><br><span class="line">总用量 0</span><br><span class="line">drwx------. 2 joh      adm      62 7月  15 22:07 joh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例二、创建joh用户，登录shell是/sbin/nologin，追加bin、sys两个组</span></span><br><span class="line">[root@master project1]# ansible oldboy -m user -a &quot;name=joh shell=/sbin/nologin groups=bin,sys&quot; -i hosts</span><br><span class="line">[root@node2 html]# id joh</span><br><span class="line">uid=1040(joh) gid=4(adm) 组=4(adm),1(bin),3(sys)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例三、创建jsm用户，为其添加123作为登录密码，并且创建家目录</span></span><br><span class="line">[root@master project1]# ansible localhost -m debug -a &quot;msg=&#123;&#123; &#x27;123&#x27; | password_hash(&#x27;sha512&#x27;, &#x27;salt&#x27;) &#125;&#125;&quot;</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">6$salt<span class="variable">$jkHSO0tOjmLW0S1NFlw5veSIDRAVsiQQMTrkOKy4xdCCLPNIsHhZkIRlzfzIvKyXeGdOfCBoW1wJZPLyQ9Qx</span>/1</span></span><br><span class="line"></span><br><span class="line">[root@master project1]# ansible oldboy -m user -a &#x27;name=jsm password=$6$salt$jkHSO0tOjmLW0S1NFlw5veSIDRAVsiQQMTrkOKy4xdCCLPNIsHhZkIRlzfzIvKyXeGdOfCBoW1wJZPLyQ9Qx/1 create_home=yes&#x27; -i hosts</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看</span></span><br><span class="line">[root@node2 html]# tail -1 /etc/shadow</span><br><span class="line">jsm:$6$salt$jkHSO0tOjmLW0S1NFlw5veSIDRAVsiQQMTrkOKy4xdCCLPNIsHhZkIRlzfzIvKyXeGdOfCBoW1wJZPLyQ9Qx/1:19188:0:99999:7:::</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例四、移除joh用户</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">state=absent 删除用户，remove=<span class="built_in">yes</span> 删除家目录</span></span><br><span class="line">[root@master project1]# ansible oldboy -m user -a &#x27;name=joh state=absent remove=yes&#x27; -i hosts</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例五、创建http用户，并为该用户创建2048字节的私钥，存放在~/http/.ssh/idrsa</span></span><br><span class="line">[root@master project1]# ansible oldboy -m user -a &#x27;name=http generate_ssh_key=yes ssh_key_bits=2048 ssh_key_file=.ssh/id_rsa&#x27; -i hosts</span><br><span class="line">[root@node2 html]# ll /home/http/.ssh/</span><br><span class="line">总用量 8</span><br><span class="line">-rw-------. 1 http users 1679 7月  15 22:26 id_rsa</span><br><span class="line">-rw-r--r--. 1 http users  408 7月  15 22:26 id_rsa.pub</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改apache的启动用户</span></span><br><span class="line">[root@node2 html]# ps aux|grep apache</span><br><span class="line">[root@master project1]# vim httpd.conf </span><br><span class="line">User http</span><br><span class="line">Group http</span><br><span class="line">[root@master project1]# ansible oldboy -m copy -a &quot;src=./httpd.conf dest=/etc/httpd/conf/httpd.conf owner=root group=root mode=644 backup=yes&quot; -i hosts</span><br><span class="line">[root@master project1]# ansible oldboy -m service -a &quot;name=httpd state=restarted&quot; -i hosts</span><br><span class="line">[root@node2 html]# ps aux|grep httpd</span><br><span class="line"></span><br><span class="line">-----</span><br><span class="line">  1.yum</span><br><span class="line">  2.copy</span><br><span class="line">  3.group user file</span><br><span class="line">  4.service</span><br></pre></td></tr></table></figure>



<p>9.cron模块</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>选项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td></td>
<td>定时任务基本描述</td>
</tr>
<tr>
<td>job</td>
<td></td>
<td>定时任务要执行的命令</td>
</tr>
<tr>
<td>minute</td>
<td>(Default *)、 0-59</td>
<td>分</td>
</tr>
<tr>
<td>hour</td>
<td>(Default *)、 0-23</td>
<td>时</td>
</tr>
<tr>
<td>day</td>
<td>(Default *)、 1-31</td>
<td>日</td>
</tr>
<tr>
<td>month</td>
<td>(Default *)、 1-12</td>
<td>月</td>
</tr>
<tr>
<td>weekday</td>
<td>(Default *)、 0-6</td>
<td>周</td>
</tr>
</tbody></table>
<p>Examples</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例一、添加定时任务。每分钟执行一次<span class="built_in">ls</span>  * * * * * <span class="built_in">ls</span> &gt;/dev/null</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m cron -a <span class="string">&quot;name=&#x27;cron01&#x27;job=&#x27;ls &gt;/dev/null&#x27;&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例二、添加定时任务，每天的凌晨2点和凌晨5点执行一次<span class="built_in">ls</span>。 <span class="string">&quot;0 5,2 * * ls &gt;/dev/null</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">ansible webserver -m cron -a &quot;</span>name=<span class="string">&#x27;cron02&#x27;</span> minute=0 hour=2,5 job=<span class="string">&#x27;ls &gt;/dev/null&#x27;</span><span class="string">&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">示例三、关闭定时任务，使定时任务失效</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">ansible webservers -m cron -a &quot;</span>name=<span class="string">&#x27;cron02&#x27;</span> minute=0 hour=2,5 job=<span class="string">&#x27;ls /dev/null&#x27;</span> disabled=<span class="built_in">yes</span><span class="string">&quot;</span></span></span><br></pre></td></tr></table></figure>



<p>练习</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例一、添加定时任务。每分钟执行一次<span class="built_in">ls</span>  * * * * * <span class="built_in">ls</span> &gt;/dev/null</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">不写默认是每分钟</span></span><br><span class="line">[root@master project1]# ansible oldboy -m cron -a &quot;name=job1 job=&#x27;ls &gt;/dev/null&#x27;&quot; -i hosts</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">；被控端查看</span></span><br><span class="line">[root@node2 ~]# crontab -l</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Ansible: job1</span></span><br><span class="line">* * * * * ls &gt;/dev/null</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例二、添加定时任务，每天的凌晨2点和凌晨5点执行一次<span class="built_in">ls</span>。 <span class="string">&quot;0 5,2 * * ls &gt;/dev/null</span></span></span><br><span class="line">[root@master project1]# ansible oldboy -m cron -a &quot;name=job2 minute=0 hour=5,2 job=&#x27;ls &gt;/dev/null&#x27;&quot; -i hosts</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">被控端查看</span></span></span><br><span class="line">[root@node2 ~]# crontab -l</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">Ansible: job1</span></span></span><br><span class="line">* * * * * ls &gt;/dev/null</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">Ansible: job2</span></span></span><br><span class="line">0 5,2 * * * ls &gt;/dev/null</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">示例三、关闭定时任务，使定时任务失效</span></span></span><br><span class="line">[root@master project1]# ansible oldboy -m cron -a &quot;name=job2 minute=0 hour=5,2 job=&#x27;ls &gt;/dev/null&#x27; disabled=yes&quot; -i hosts</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">被控端查看</span></span></span><br><span class="line">[root@node2 ~]# crontab -l</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">Ansible: job1</span></span></span><br><span class="line">* * * * * ls &gt;/dev/null</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">Ansible: job2</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">0 5,2 * * * ls &gt;/dev/null</span></span></span><br></pre></td></tr></table></figure>



<h2 id="7-磁盘挂载模块"><a href="#7-磁盘挂载模块" class="headerlink" title="7.磁盘挂载模块"></a>7.磁盘挂载模块</h2><p>ansible管理设备挂载，使用mount</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>选项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>src</td>
<td></td>
<td>本地或远程设备的路径</td>
</tr>
<tr>
<td>path</td>
<td></td>
<td>设备挂载至本地的路径</td>
</tr>
<tr>
<td>fstype</td>
<td>xfs、nfs…</td>
<td>文件系统类型</td>
</tr>
<tr>
<td>opts</td>
<td>defaults、ro…</td>
<td>挂载的参数</td>
</tr>
<tr>
<td>state</td>
<td><del>present</del>、mounted、<del>unmounted</del>、absent</td>
<td>挂载的状态</td>
</tr>
</tbody></table>
<p>Examples</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">环境准备：将172.16.1.61作为nfs服务端，172.16.1.7、172.16.1.8作为nfs客户端挂载</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible localhost -m yum a <span class="string">&#x27;name=nfs-utils state=present&#x27;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible localhost -m file -a <span class="string">&#x27;path=/ops state=directory&#x27;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible localhost -m copy -a <span class="string">&#x27;content=&quot;/ops 172.16.1.0/24(rw,sync,)&quot; dest=/etc/exports&#x27;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible localhost -m service -a <span class="string">&quot;name=nfs state=restarted&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例一、挂载nfs存储至本地的/opt目录，并实现开机自动挂载</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m mount -a <span class="string">&quot;src=172.16.1.61:/ops path=/opt fstype=nfs opts=defaults state=mounted&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例二、临时卸裁nfs的挂裁，但不会清理/etc/fstab</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m mount -a <span class="string">&quot;src=172.16.1.61:/ops path=/opt fstype=nfs opts=defaults state=unimounted&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例三、永久卸载nfs的挂载，会清理/etc/fstab</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m mount -a <span class="string">&quot;src=172.16.1.61:/ops path=/opt fstype=nfs opts=defaults state=absent&quot;</span></span></span><br></pre></td></tr></table></figure>



<p>练习</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">mount</span><br><span class="line">present 将挂载信息写入/etc/fstab    unmounted  卸载临时，不会清理/etc/fstab    临时挂载</span><br><span class="line">mounted 先挂载，再将挂载信息写入/etc/fstab   absent  卸载临时，也会清理/etc/fstab    永久+临时挂载</span><br><span class="line"></span><br><span class="line">[root@master project1]# vim /etc/exports</span><br><span class="line">/data 192.168.160.0/24(rw,sync,all_squash)</span><br><span class="line">[root@master project1]# systemctl restart nfs-server</span><br><span class="line">[root@master project1]# chown -R nfsnoboy.nfsnoldboy /data/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">临时挂载</span></span><br><span class="line">[root@master project1]# ansible oldboy -m mount -a &quot;src=192.168.160.3:/data path=/opt fstype=nfs opts=defaluts state=present&quot; -i hosts</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看被控端</span></span><br><span class="line">[root@node2 opt]# cat /etc/fstab</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">临时卸载</span></span><br><span class="line">[root@master project1]# ansible oldboy -m mount -a &quot;src=192.168.160.3:/data path=/opt fstype=nfs opts=defaluts state=unmounted&quot; -i hosts</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看被控端</span></span><br><span class="line">[root@node2 ~]# cat /etc/fstab</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">192.168.160.3:/data /opt nfs defaluts 0 0</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例一、挂载nfs存储至本地的/opt目录，并实现开机自动挂载</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">永久挂载</span></span><br><span class="line">[root@master project1]# ansible oldboy -m mount -a &quot;src=192.168.160.3:/data path=/opt fstype=nfs opts=defaults state=mounted&quot; -i hosts</span><br><span class="line">[root@node2 ~]# df -h</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例二、临时卸裁nfs的挂裁，但不会清理/etc/fstab</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m mount -a <span class="string">&quot;src=172.16.1.61:/ops path=/opt fstype=nfs opts=defaults state=absent&quot;</span></span></span><br></pre></td></tr></table></figure>



<h2 id="8-防火墙管理模块"><a href="#8-防火墙管理模块" class="headerlink" title="8.防火墙管理模块"></a>8.防火墙管理模块</h2><p>ansible管理防火墙、分别使用Selinux 和 Firewalld</p>
<p>1.Selinux防火墙</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>选项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>state</td>
<td>enforcing、permissive、disabled</td>
<td>Selinux模式</td>
</tr>
</tbody></table>
<p>Examples</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m selinux -a <span class="string">&quot;state=disabled&quot;</span></span></span><br></pre></td></tr></table></figure>



<p>练习</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">selinux</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭selinux</span></span><br><span class="line">[root@master project1]# ansible oldboy -m selinux -a &quot;state=disabled&quot; -i hosts</span><br></pre></td></tr></table></figure>



<p>2.firewalld防火墙</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>选项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>service</td>
<td>http、https…</td>
<td>添加或删除firewalld中的服务名称</td>
</tr>
<tr>
<td>port</td>
<td>80、443…</td>
<td>添加或删除firewalld中的端口范围</td>
</tr>
<tr>
<td>masquerade</td>
<td>yes、no</td>
<td>启用或禁止防火墙的地址伪装</td>
</tr>
<tr>
<td>immediate</td>
<td>yes、no(Default)</td>
<td>防火墙规则当前是否立即生效</td>
</tr>
<tr>
<td>permanent</td>
<td>yes、no</td>
<td>防火墙规则当前是否重启后也生效</td>
</tr>
<tr>
<td>state</td>
<td>enabled、disabled</td>
<td>启用或禁用当前配置的规则</td>
</tr>
<tr>
<td>rich_rule</td>
<td></td>
<td>在防火墙中添加或删除富规则</td>
</tr>
<tr>
<td>source</td>
<td></td>
<td>添加或删除防火墙 源IP网络</td>
</tr>
<tr>
<td>zone</td>
<td>public(Default)、home…</td>
<td>指定防火墙区域</td>
</tr>
</tbody></table>
<p>Examples</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m service -a <span class="string">&quot;name=firewalLd state=started&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m firewalld -a <span class="string">&quot;service=http immediate=yes permanent=yes state=enabled&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ansible webservers -m firewalld -a <span class="string">&quot;port=8080-8090/tcp immediate=yes permanent=yes state=enabled&quot;</span></span></span><br></pre></td></tr></table></figure>



<p>练习</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">firewalld</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例一、永久放行https的流量，只有重启才会生效</span></span><br><span class="line">- firewalld:</span><br><span class="line">    service: https</span><br><span class="line">    permanent: yes</span><br><span class="line">    state: enabled</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- firewalld:</span><br><span class="line">    port: 8081/tcp</span><br><span class="line">    permanent: yes</span><br><span class="line">    state: disabled</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例三、放行8080-8090的所有tcp端口流量，临时和永久都生效。</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动firewalld</span></span><br><span class="line">[root@master project1]# ansible 192.168.160.4 -m service -a &quot;name=firewalld state=started&quot; -i hosts</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例二、永久放行8081端口的流量，只有重启才会生效</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">firewalld永久放行https</span></span><br><span class="line">[root@master project1]# ansible 192.168.160.4 -m firewalld -a &quot;zone=public service=https permanent=yes state=enabled&quot; -i hosts</span><br><span class="line">[root@node1 ~]# firewall-cmd --list-all</span><br><span class="line">  services: dhcpv6-client ssh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重载服务firewalld</span></span><br><span class="line">[root@node1 ~]# firewall-cmd --reload</span><br><span class="line">success</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看</span></span><br><span class="line">[root@node1 ~]# firewall-cmd --list-all</span><br><span class="line">  services: dhcpv6-client https ssh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例二、永久放行8081端口的流量，只有重启才会生效</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">firewalld永久放行端口8080/tcp</span></span><br><span class="line">[root@master project1]# ansible 192.168.160.4 -m firewalld -a &quot;zone=public port=8080/tcp permanent=yes state=enabled&quot; -i hosts</span><br><span class="line">[root@node1 ~]# firewall-cmd --list-all</span><br><span class="line">  ports: </span><br><span class="line">[root@node1 ~]# firewall-cmd --reload</span><br><span class="line">success</span><br><span class="line">[root@node1 ~]# firewall-cmd --list-all</span><br><span class="line">  ports: 8080/tcp</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例三、放行8080-8090的所有tcp端口流量，临时和永久都生效。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">immediate=<span class="built_in">yes</span> 临时生效，permanent=<span class="built_in">yes</span> 永久生效</span></span><br><span class="line">[root@master project1]# ansible 192.168.160.4 -m firewalld -a &quot;zone=public port=8080-8090/tcp permanent=yes immediate=yes state=enabled&quot; -i hosts</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看临时生效</span></span><br><span class="line">[root@node1 ~]# firewall-cmd --list-all</span><br><span class="line">  ports: 8080/tcp 8080-8090/tcp</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看永久生效</span></span><br><span class="line">[root@node1 ~]# firewall-cmd --reload</span><br><span class="line">success</span><br><span class="line">[root@node1 ~]# firewall-cmd --list-all</span><br><span class="line">  ports: 8080/tcp 8080-8090/tcp</span><br></pre></td></tr></table></figure>



<h2 id="9-常用模块练习"><a href="#9-常用模块练习" class="headerlink" title="9.常用模块练习"></a>9.常用模块练习</h2><ol>
<li>安装http服务    yum</li>
<li>编写简单网页测试内容    copy    (Name-OldboyEdu.com)</li>
<li>启动服务并加入开机自启    service</li>
<li>放行对应的端口    firewalld</li>
</ol>
<h1 id="03-Ansible-Playbook"><a href="#03-Ansible-Playbook" class="headerlink" title="03.Ansible Playbook"></a>03.Ansible Playbook</h1><h2 id="1-Ansible-Playbook基本概述"><a href="#1-Ansible-Playbook基本概述" class="headerlink" title="1.Ansible Playbook基本概述"></a>1.Ansible Playbook基本概述</h2><p><strong>1.什么是playbook，playbook翻译过来就是“剧本”，那playbook组成如下</strong></p>
<p>playbook: 定义一个文本文件,以yml为后缀结尾（翻译：我有一个剧本）</p>
<p>play: 定义的是主机的角色（翻译：找哪个大腕明星）</p>
<p>task：定义的是具体执行的任务（翻译：大腕每一集拍什么）</p>
<p>总结：playbook是由一个或多个play组成，一个play可以包含多个task任务。</p>
<p>可以理解为：使用不同的模块来共同完成一件事情。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">playbook</span><br><span class="line">  playbook  剧本</span><br><span class="line">  play  (找谁)</span><br><span class="line">  task  (干什么)</span><br><span class="line">找一个人干多件事情  playbook  1个play  多个task</span><br><span class="line">找多个人干多件事情  playbook  多个play  多个task</span><br><span class="line">找多个人干一件事情  playbook  多个play  1个task</span><br></pre></td></tr></table></figure>

<p><img src="D:\文件管理\Typora\images\Ansible.assest\image-20220716140417354.png" alt="image-20220716140417354"></p>
<h2 id="2-Ansible-playbook与AD-Hoc的关系"><a href="#2-Ansible-playbook与AD-Hoc的关系" class="headerlink" title="2.Ansible playbook与AD-Hoc的关系"></a>2.Ansible playbook与AD-Hoc的关系</h2><ol>
<li><p>playbook是对AD-Hoc的一种编排方式。</p>
</li>
<li><p>playbook可以持久运行，而Ad-Hoc只能临时运行。</p>
</li>
<li><p>playbook适合复杂的任务，而Ad-Hoc适合做快速简单的任务。</p>
</li>
<li><p>playbook能控制任务执行的先后顺序。</p>
</li>
</ol>
<h2 id="3-Ansible-Playbook书写格式"><a href="#3-Ansible-Playbook书写格式" class="headerlink" title="3.Ansible Playbook书写格式"></a>3.Ansible Playbook书写格式</h2><p>playbook是由yml语法书写，结构清晰，可读性强，所以必须掌握yml基础语法</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>缩进</td>
<td>YAML使用固定的缩进风格表示层级结构，每个缩进由两个空格组成，不能使用tabs</td>
</tr>
<tr>
<td>冒号</td>
<td>以冒号结尾的除外，其他所有冒号后面所有必须有空格。</td>
</tr>
<tr>
<td>短横线</td>
<td>表示列表项，使用一个短横杠加一个空格。多个项使用同样的缩进级别作为同一列表。</td>
</tr>
</tbody></table>
<p>1.下面我们一起来编写一个playbook文件，playbook起步<br>host: 对哪些主机进行操作<br>remote_user: 我要使用什么用户执行<br>tasks: 具体执行什么任务</p>
<p>练习</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">案例二、使用ansible安装并配置httpd服务</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">先卸载httpd</span></span><br><span class="line">[root@master project1]# ansible oldboy -m yum -a &quot;name=httpd state=absent&quot; -i hosts</span><br><span class="line"></span><br><span class="line">[root@master project1]# vim http.yaml</span><br><span class="line">- hosts: oldboy</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">    - name: Installed Httpd Server</span><br><span class="line">      yum: name=httpd state=present</span><br><span class="line"></span><br><span class="line">    - name: Configure Httpd Server</span><br><span class="line">      copy: src=./tt.j2 dest=/var/www/html/tt.html owner=http group=http mode=644</span><br><span class="line"></span><br><span class="line">    - name: Service Httpd Server</span><br><span class="line">      service: name=httpd state=started enabled=yes</span><br><span class="line"></span><br><span class="line">    - name: Service Firewalld Server</span><br><span class="line">      service: name=firewalld state=started</span><br><span class="line"></span><br><span class="line">    - name: Configure Firewalld Server</span><br><span class="line">      firewalld: zone=public service=http permanent=yes immediate=yes state=enabled</span><br><span class="line"></span><br><span class="line">[root@master project1]# echo &quot;OldboyEdu.com&quot; &gt; tt.j2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查playbook是否正确</span></span><br><span class="line">[root@master project1]# ansible-playbook --syntax http.yaml -i hosts</span><br><span class="line"></span><br><span class="line">playbook: http.yaml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">模拟演练playbook</span></span><br><span class="line">[root@master project1]# ansible-playbook -C http.yaml -i hosts</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行playbook</span></span><br><span class="line">[root@master project1]# ansible-playbook http.yaml -i hosts</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改httpd端口</span></span><br><span class="line">[root@master project1]# vim httpd.conf </span><br><span class="line">Listen 9988</span><br><span class="line">[root@master project1]# mv httpd.conf httpd.conf.j2</span><br><span class="line">[root@master project1]# vim http.yaml</span><br><span class="line">- hosts: oldboy</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">    - name: Installed Httpd Server</span><br><span class="line">      yum: name=httpd state=present</span><br><span class="line"></span><br><span class="line">    - name: Configure Httpd Server</span><br><span class="line">      copy: src=./httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf backup=yes</span><br><span class="line"></span><br><span class="line">    - name: Configure Httpd WebSite</span><br><span class="line">      copy: src=./tt.j2 dest=/var/www/html/tt.html owner=http group=http mode=644</span><br><span class="line"></span><br><span class="line">    - name: Service Httpd Server</span><br><span class="line">      service: name=httpd state=started enable=yes</span><br><span class="line"></span><br><span class="line">    - name: Service Firewalld Server</span><br><span class="line">      service: name=firewalld state=started</span><br><span class="line"></span><br><span class="line">    - name: Configure Firewalld Server</span><br><span class="line">      firewalld: zone=public service=http permanent=yes immediate=yes state=enabled</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行playbook</span></span><br><span class="line">[root@master project1]# ansible-playbook http.yaml -i hosts</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改防火墙放行端口</span></span><br><span class="line">[root@master project1]# vim http.yaml</span><br><span class="line">- hosts: oldboy</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">    - name: Installed Httpd Server</span><br><span class="line">      yum: name=httpd state=present</span><br><span class="line"></span><br><span class="line">    - name: Configure Httpd Server</span><br><span class="line">      copy: src=./httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf backup=yes</span><br><span class="line"></span><br><span class="line">    - name: Configure Httpd WebSite</span><br><span class="line">      copy: src=./tt.j2 dest=/var/www/html/tt.html owner=http group=http mode=644</span><br><span class="line"></span><br><span class="line">    - name: Service Httpd Server</span><br><span class="line">      service: name=httpd state=started enable=yes</span><br><span class="line"></span><br><span class="line">    - name: Service Firewalld Server</span><br><span class="line">      service: name=firewalld state=started</span><br><span class="line"></span><br><span class="line">    - name: Configure Firewalld Server</span><br><span class="line">      firewalld: zone=public service=9988/tcp permanent=yes immediate=yes state=enabled</span><br><span class="line">      </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行playbook</span></span><br><span class="line">[root@master project1]# ansible-playbook http.yaml -i hosts</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">浏览器访问http://192.168.160.4:9988/tt.html</span></span><br></pre></td></tr></table></figure>



<p>练习</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">案例一、使用ansible安装并配置nfs服务</span><br><span class="line">  服务端：192.168.160.4</span><br><span class="line">    1.安装nfs</span><br><span class="line">    2.配置nfs</span><br><span class="line">    3.根据配置创建目录，创建用户，授权</span><br><span class="line">    4.启动并加入开机自启</span><br><span class="line"></span><br><span class="line">  客户端：192.168.160.5</span><br><span class="line">    1.准备一个空目录</span><br><span class="line">    2.挂载192.168.160.4上共享的目录即可.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master project1]# vim nfs.yaml</span><br><span class="line">[root@master project1]# cat nfs.yaml </span><br><span class="line">- hosts: 192.168.160.4</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">    - name: Install Nfs Server</span><br><span class="line">      yum: name=nfs-utils state=present</span><br><span class="line"></span><br><span class="line">    - name: Configure NFS Server</span><br><span class="line">      copy: src=./exports.j2 dest=/etc/exports backup=yes</span><br><span class="line"></span><br><span class="line">    - name: Create NFS Group</span><br><span class="line">      group: name=www gid=666</span><br><span class="line"></span><br><span class="line">    - name: Create NFS User</span><br><span class="line">      user: name=www uid=666 group=666 shell=/sbin/nologin create_home=no</span><br><span class="line"></span><br><span class="line">    - name: Create NFS Data</span><br><span class="line">      file: path=/data state=directory owner=www group=www recurse=yes</span><br><span class="line"></span><br><span class="line">    - name: Service NFS Server</span><br><span class="line">      service: name=nfs state=started enabled=yes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- hosts: 192.168.160.5</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">    - name: Client Create NFS Data</span><br><span class="line">      file: path=/nfs_tt state=directory</span><br><span class="line"></span><br><span class="line">    - name: Client Mount NFS Server</span><br><span class="line">      mount:</span><br><span class="line">        src: 192.168.160.4:/data</span><br><span class="line">        path: /nfs_tt</span><br><span class="line">        fstype: nfs</span><br><span class="line">        opts: defaults</span><br><span class="line">        state: mounted</span><br><span class="line"></span><br><span class="line">[root@master project1]# vim exports.j2</span><br><span class="line">[root@master project1]# cat exports.j2 </span><br><span class="line">/data 192.168.160.0/24(rw,sync,all_squash,anonuid=666,anongid=666)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查语法</span></span><br><span class="line">[root@master project1]# ansible-playbook --syntax nfs.yaml -i hosts</span><br><span class="line">[root@master project1]# ansible-playbook nfs.yaml -i hosts</span><br><span class="line">[root@node2 ~]# df -h</span><br><span class="line">[root@node2 ~]# ll -d /nfs_tt/</span><br><span class="line">drwxr-xr-x. 2 666 666 6 7月  16 15:57 /nfs_tt/</span><br></pre></td></tr></table></figure>



<p>练习</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">案例三、ansible安装并配置httpd服务，根据不同的主机配置不同的网站。（多个play使用方式，但不是生产推荐（了解即可），生产推荐使用循环方式）</span><br><span class="line"></span><br><span class="line">清空原来http软件</span><br><span class="line">oldboy:</span><br><span class="line">  1.安装http</span><br><span class="line">  2.配置http</span><br><span class="line">    用户  --&gt;存在？  ttt  gid uid 7788</span><br><span class="line">    端口  --&gt;7788</span><br><span class="line">  3.启动http</span><br><span class="line">  4.防火墙  --&gt;放行7788</span><br><span class="line">  </span><br><span class="line">192.168.160.4：  web-4...</span><br><span class="line">192.168.160.5：  web-5...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">清空原来http软件</span></span><br><span class="line">[root@master project1]# ansible oldboy -m yum -a &quot;name=httpd state=absent&quot; -i hosts</span><br><span class="line">[root@master project1]# cat http_2.yaml </span><br><span class="line">- hosts: oldboy</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installd Httpd Server</span><br><span class="line">      yum: name=httpd state=present</span><br><span class="line"></span><br><span class="line">    - name: Configure Httpd Server</span><br><span class="line">      copy: src=./httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf backup=yes</span><br><span class="line"></span><br><span class="line">    - name: Create Httpd Group</span><br><span class="line">      group: name=ttt gid=7788 state=present</span><br><span class="line"></span><br><span class="line">    - name: Create Httpd User</span><br><span class="line">      user: name=ttt uid=7788 group=7788 shell=/sbin/nologin create_home=no</span><br><span class="line"></span><br><span class="line">    - name: Service Httpd Server</span><br><span class="line">      service: name=httpd state=started enabled=yes</span><br><span class="line"></span><br><span class="line">    - name: Service Firewalld Server</span><br><span class="line">      service: name=firewalld state=started</span><br><span class="line"></span><br><span class="line">    - name: Configure Firewalld Server</span><br><span class="line">      firewalld:</span><br><span class="line">        zone: public</span><br><span class="line">        port: 7788/tcp</span><br><span class="line">        permanent: yes</span><br><span class="line">        immediate: yes</span><br><span class="line">        state: enabled</span><br><span class="line"></span><br><span class="line">- hosts: 192.168.160.4</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Configure Web Site</span><br><span class="line">      copy: content=&#x27;web-4...&#x27; dest=/var/www/html/index.html</span><br><span class="line"></span><br><span class="line">- hosts: 192.168.160.5</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Configure Web Site</span><br><span class="line">      copy: content=&#x27;web-5...&#x27; dest=/var/www/html/index.html</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查语法</span></span><br><span class="line">[root@master project1]# ansible-playbook --syntax http_2.yaml -i hosts</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行</span></span><br><span class="line">[root@master project1]# ansible-playbook http_2.yaml -i hosts</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改配置</span></span><br><span class="line">[root@master project1]# vim httpd.conf.j2 </span><br><span class="line">Listen 7788</span><br><span class="line">User ttt</span><br><span class="line">Group ttt</span><br></pre></td></tr></table></figure>



<p>P16 AnsiblePlaybook搭建Kodcloud</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">作业：</span><br><span class="line">使用AnsiblePlaybook方式构建LAMP架构，具体操作步骤如下：</span><br><span class="line">1.使用yum安装httpd、php、php-mysql、mariadb、firewalld等</span><br><span class="line">2.启动httpd、firewalld、mariadb等服务</span><br><span class="line">3.添加防火墙规则，放行http的流量，井永久生效</span><br><span class="line">4.使用get_url下载http://fj.xuliangwei.com/public/index.php文件</span><br><span class="line">5.扩展：可道云代码下载解压到指定目录</span><br><span class="line">效果：执行完playbook后，访问网站，就跳出网站安装向导</span><br><span class="line"></span><br><span class="line">apache+php  模块  重启apache</span><br><span class="line">nginx+php  代理  fastcgi协议</span><br><span class="line">版本冲突</span><br><span class="line"></span><br><span class="line">1.卸载php71w,如果是全新的环境,就不用.</span><br><span class="line">yum list installed |grep php71w|awk &#x27;&#123;print $1&#125;&#x27;|xargs|sed -r &#x27;s#(.*)#yum remove -y \1#g&#x27;|bash</span><br><span class="line"></span><br><span class="line">[root@node2 ~]# yum remove httpd</span><br><span class="line">[root@node2 ~]# ll /var/www/html/</span><br><span class="line">[root@node2 ~]# rm -rf /var/www/html/*</span><br><span class="line"></span><br><span class="line">[root@master project1]# vim lamp.yaml</span><br><span class="line">- hosts: 192.168.160.5  #play</span><br><span class="line">  tasks: </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.使用yum安装 httpd、php、firewalld等</span></span><br><span class="line">    - name: Install Httpd PHP firewalld</span><br><span class="line">      yum: name=httpd,php,php-pdo,php-mbstring,php-gd,firewalld state=present</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.启动httpd、firewalld服务</span></span><br><span class="line">    - name: Service Httpd Server</span><br><span class="line">      service: name=httpd state=started</span><br><span class="line"></span><br><span class="line">    - name: Service Firewalld Server</span><br><span class="line">      service: name=firewalld state=started</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.添加防火墙规则，放行http的流量</span></span><br><span class="line">    - name: Configure Firewalld</span><br><span class="line">      firewalld: port=80/tcp immediate=yes state=enabled</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4.使用get_url下载http://download.lsythink.online/dl/mysql/install_mysql.sh文件</span></span><br><span class="line">    - name: Get Url index.php</span><br><span class="line">      get_url:</span><br><span class="line">        url: http://download.lsythink.online/dl/mysql/install_mysql.sh</span><br><span class="line">        dest: /var/www/html/tt.php</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5.扩展：可道云代码下载解压到指定目录</span></span><br><span class="line">    - name: Copy Kod Cloud Code</span><br><span class="line">      unarchive: src=./kodexplorer4.40.zip dest=/var/www/html/ mode=0777</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">6.变更权限为Httpd进程的运行用户,apache</span></span><br><span class="line">    - name: Chown Directory</span><br><span class="line">      file: path=/var/www/html owner=apache group=apache recurse=yes</span><br><span class="line"></span><br><span class="line">[root@master project1]# wget https://static.kodcloud.com/update/download/kodexplorer4.40.zip</span><br><span class="line">[root@master project1]# ansible-playbook lamp.yaml -i hosts</span><br><span class="line">[root@node2 ~]# systemctl restart httpd</span><br></pre></td></tr></table></figure>



<p>P17 01 老男孩教育4期-Ansible变量基本介绍</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">playbook---&gt;</span><span class="language-bash">变量</span></span><br><span class="line">1.为什么要使用变量</span><br><span class="line">  简化playbook项目的一个维护.使用一个固定的字符串--&gt;表示一个不固定的值...</span><br><span class="line">  </span><br><span class="line">2.ansible怎么定义变量</span><br><span class="line">  1.通过playbook文件中的play进行定义，通过vars来进行定义变量</span><br><span class="line">    注意：和shell定义变量的方式不一样，shell: version=1.12  yml语法: version: 1.12</span><br><span class="line">  定义变量：</span><br><span class="line">    vars:</span><br><span class="line">      - v1: value</span><br><span class="line">      - v2: value</span><br><span class="line">      - v3: value</span><br><span class="line">  使用变量:</span><br><span class="line">    &#123;&#123; v1 &#125;&#125;</span><br><span class="line">    固定写法&#123;&#123;&#125;&#125; 中间直接填写变量名称即可</span><br><span class="line">  </span><br><span class="line">  2.通过inventory主机清单进行变量定义</span><br><span class="line">  3.通过执行playbook时使用-e参数指定变量</span><br><span class="line">    </span><br><span class="line">3.ầnsible怎么使用变量</span><br><span class="line">4.ansible变量优先级</span><br><span class="line">5.ansible facts变量</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>练习</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">[root@master project1]# vim vars_1.yml</span><br><span class="line">[root@master project1]# cat vars_1.yml </span><br><span class="line">- hosts: oldboy</span><br><span class="line">  vars:</span><br><span class="line">    - web_packages: httpd</span><br><span class="line">    - ftp_packages: vsftpd</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installed RPM Paackages</span><br><span class="line">      yum: name=&#123;&#123; web_packages &#125;&#125; state=present</span><br><span class="line"></span><br><span class="line">   - name: Installed RPM Paackages</span><br><span class="line">     yum: name=&#123;&#123; ftp_packages &#125;&#125; state=present</span><br><span class="line">     </span><br><span class="line">[root@master project1]# ansible-playbook vars_1.yml -i hosts</span><br><span class="line"></span><br><span class="line">------------------------------------</span><br><span class="line">[root@master project1]# vim vars_1.yml</span><br><span class="line">[root@master project1]# cat vars_1.yml </span><br><span class="line">- hosts: oldboy</span><br><span class="line">  vars:</span><br><span class="line">    - web_packages: httpd</span><br><span class="line">    - ftp_packages: vsftpd</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installed &#123;&#123; web_packages &#125;&#125; Paackages</span><br><span class="line">      yum: name=&#123;&#123; web_packages &#125;&#125; state=present</span><br><span class="line"></span><br><span class="line">    - name: Installed &#123;&#123; ftp_packages &#125;&#125; Paackages</span><br><span class="line">      yum: name=&#123;&#123; ftp_packages &#125;&#125; state=present</span><br><span class="line">[root@master project1]# ansible-playbook vars_1.yml -i hosts</span><br><span class="line"></span><br><span class="line">------------------------------------</span><br><span class="line">1.在playbook文件中的play使用变量</span><br><span class="line">[root@master project1]# vim vars_1.yml </span><br><span class="line">[root@master project1]# cat vars_1.yml </span><br><span class="line">- hosts: oldboy</span><br><span class="line">  vars:</span><br><span class="line">    - web_packages: httpd-2.4.6</span><br><span class="line">    - ftp_packages: vsftpd-3.0.2</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installed &#123;&#123; web_packages &#125;&#125; &#123;&#123; ftp_packages &#125;&#125;</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - &quot;&#123;&#123; web_packages &#125;&#125;&quot;</span><br><span class="line">          - &quot;&#123;&#123; ftp_packages &#125;&#125;&quot;</span><br><span class="line">        state: present</span><br><span class="line">[root@master project1]# ansible-playbook vars_1.yml -i hosts</span><br><span class="line"></span><br><span class="line">2.通过定义一个变量文件，然后使用playbook进行调用</span><br><span class="line">[root@master project1]# vim vars_public.yml</span><br><span class="line">[root@master project1]# cat vars_public.yml </span><br><span class="line">web_packages: httpd-2.4.6</span><br><span class="line">ftp_packages: vsftpd-3.0.2</span><br><span class="line"></span><br><span class="line">[root@master project1]# vim vars_1.yml </span><br><span class="line">[root@master project1]# cat vars_1.yml </span><br><span class="line">- hosts: oldboy</span><br><span class="line">  vars_files: ./vars_public.yml</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installed &#123;&#123; web_packages &#125;&#125; &#123;&#123; ftp_packages &#125;&#125;</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - &quot;&#123;&#123; web_packages &#125;&#125;&quot;</span><br><span class="line">          - &quot;&#123;&#123; ftp_packages &#125;&#125;&quot;</span><br><span class="line">        state: present</span><br><span class="line">[root@master project1]# ansible-playbook vars_1.yml -i hosts</span><br><span class="line"></span><br><span class="line">[root@master project1]# vim vars_2.yml</span><br><span class="line">[root@master project1]# cat vars_2.yml </span><br><span class="line">- hosts: oldboy</span><br><span class="line">  vars_files:</span><br><span class="line">    - ./vars_public.yml</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installed &#123;&#123; web_packages &#125;&#125; &#123;&#123; ftp_packages &#125;&#125;</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - &quot;&#123;&#123; web_packages &#125;&#125;&quot;</span><br><span class="line">          - &quot;&#123;&#123; ftp_packages &#125;&#125;&quot;</span><br><span class="line">        state: present</span><br><span class="line">[root@master project1]# ansible-playbook vars_2.yml -i hosts</span><br><span class="line"></span><br><span class="line">2.通过inventory主机清单进行变量定义</span><br><span class="line">[root@master project1]# vim hosts </span><br><span class="line">[root@master project1]# cat hosts </span><br><span class="line">[oldboy]</span><br><span class="line">192.168.160.4</span><br><span class="line">192.168.160.5</span><br><span class="line"></span><br><span class="line">[oldboy:vars]</span><br><span class="line">file_name=group_vars</span><br><span class="line"></span><br><span class="line">[root@master project1]# vim vars_3.yml</span><br><span class="line">[root@master project1]# cat vars_3.yml </span><br><span class="line">- hosts: oldboy</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Create File</span><br><span class="line">      file: path=/tmp/&#123;&#123; file_name &#125;&#125; state=touch</span><br><span class="line">[root@master project1]# ansible-playbook vars_3.yml -i hosts</span><br><span class="line"></span><br><span class="line">4.官方建议的方式是在ansible项目目录中创建额外的两个变量目录，分别是host_vars和group_vars</span><br><span class="line">在项目目录下创建两个变量的目录，host_vars group_vars</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-------------------group_vars------------------</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1）在当前的项目目录中创建两个变量的目录</span></span><br><span class="line">[root@ansible project1]# mkdir host_vars</span><br><span class="line">[root@ansible project1]# mkdir group_vars</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2）在group_vars目录中创建一个文件，文件名与inventory清单中的组名称要保持完全一致。</span></span><br><span class="line">[root@ansible project1]# cat group_vars/webservers</span><br><span class="line">web_packages: wget</span><br><span class="line">ftp_packages: tree</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3）编写playbook,只需在playbook文件中使用变量即可。</span></span><br><span class="line">[root@ansible project1]# cat f4.yml</span><br><span class="line">- hosts: webservers</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Rpm Packages &quot;&#123;&#123; web_packages &#125;&#125;&quot; &quot;&#123;&#123; ftp_packages &#125;&#125;&quot;</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - &quot;&#123;&#123; web_packages &#125;&#125;&quot;</span><br><span class="line">          - &quot;&#123;&#123; ftp_packages &#125;&#125;&quot;</span><br><span class="line">        state: present</span><br><span class="line">        </span><br><span class="line">注意：默认情况下，group_vars目录中文件名与hosts清单中的组名保持一致.</span><br><span class="line">  比如在group_vars目录中创建了oldboy组的变量，其他组是无法使用oldboy组的变量</span><br><span class="line">  系统提供了一个特殊组，all，只需要在group_vars目录下建立一个all文件，编写好变量，所有组都可使用.</span><br></pre></td></tr></table></figure>



<p>练习</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@master project1]# mkdir host_vars</span><br><span class="line">[root@master project1]# mkdir group_vars</span><br><span class="line">[root@master project1]# vim group_vars/oldboy</span><br><span class="line">[root@master project1]# cat group_vars/oldboy </span><br><span class="line">web_packages: wget</span><br><span class="line">ftp_packages: tree</span><br><span class="line">[root@master project1]# cat vars_4.yml </span><br><span class="line">- hosts: oldboy</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Rpm Packages &quot;&#123;&#123; web_packages &#125;&#125;&quot; &quot;&#123;&#123; ftp_packages &#125;&#125;&quot;</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - &quot;&#123;&#123; web_packages &#125;&#125;&quot;</span><br><span class="line">          - &quot;&#123;&#123; ftp_packages &#125;&#125;&quot;</span><br><span class="line">        state: present</span><br><span class="line">[root@master project1]# ansible-playbook vars_4.yml -i hosts</span><br><span class="line"></span><br><span class="line">-----------------------------------------------</span><br><span class="line">[root@master project1]# cp vars_4.yml vars_5.yml</span><br><span class="line">[root@master project1]# vim hosts</span><br><span class="line">[root@master project1]# cat hosts</span><br><span class="line">[oldboy]</span><br><span class="line">192.168.160.4</span><br><span class="line"></span><br><span class="line">[db]</span><br><span class="line">192.168.160.5</span><br><span class="line">[root@master project1]# vim vars_5.yml </span><br><span class="line">[root@master project1]# cat vars_5.yml </span><br><span class="line">- hosts: db</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Rpm Packages &quot;&#123;&#123; web_packages &#125;&#125;&quot; &quot;&#123;&#123; ftp_packages &#125;&#125;&quot;</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - &quot;&#123;&#123; web_packages &#125;&#125;&quot;</span><br><span class="line">          - &quot;&#123;&#123; ftp_packages &#125;&#125;&quot;</span><br><span class="line">        state: present</span><br><span class="line">[root@master project1]# cd group_vars/</span><br><span class="line">[root@master group_vars]# cp oldboy db</span><br><span class="line">[root@master group_vars]# cd ..</span><br><span class="line">[root@master project1]# ansible-playbook -i hosts vars_5.yml</span><br><span class="line"></span><br><span class="line">-------------------------------------------</span><br><span class="line">注意：默认情况下，group_vars目录中文件名与hosts清单中的组名保持一致.</span><br><span class="line">比如在group_vars目录中创建了oldboy组的变量，其他组是无法使用oldboy组的变量</span><br><span class="line">系统提供了一个特殊组，all，只需要在group_vars目录下建立一个all文件，编写好变量，所有组都可使用.</span><br><span class="line">[root@master group_vars]# rm -f db </span><br><span class="line">[root@master group_vars]# cp oldboy all</span><br><span class="line">[root@master group_vars]# rm -f oldboy</span><br><span class="line">[root@master group_vars]# cd ..</span><br><span class="line">[root@master project1]# ansible-playbook -i hosts vars_4.yml</span><br><span class="line">[root@master project1]# ll group_vars/</span><br><span class="line">-rw-r--r--. 1 root root 38 7月  18 14:17 all</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">------------------hosts_vars--------------------</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1）在host_vars目录中创建一个文件，文件名与inventory清单中的主机名称要保持完全一致，如果是ip地址，则创建相同ip地址的文件即可。</span></span><br><span class="line">[root@ansible project1]# cat hosts</span><br><span class="line">[oldboy]</span><br><span class="line">172.16.1.7</span><br><span class="line">172.16.1.8</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2) 在host_vars目录中创建文件，给172.16.1.7主机定义变量</span></span><br><span class="line">[root@ansible project1]# cat host_vars/172.16.1.7</span><br><span class="line">web_packages: zlib-static</span><br><span class="line">ftp_packages: zmap</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3）准备一个playbook文件调用host主机变量</span></span><br><span class="line">[root@ansible projectl]# cat f4.yml</span><br><span class="line">- hosts: 172.16.1.7</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Rpm Packages &quot;&#123;&#123; web_packages &#125;&#125;&quot; &quot;&#123;&#123; ftp_packages &#125;&#125;&quot;</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - &quot;&#123;&#123; web_packages &#125;&#125;&quot;</span><br><span class="line">          - &quot;&#123;&#123; ftp_packages &#125;&#125;&quot;</span><br><span class="line">        state: present</span><br><span class="line"></span><br><span class="line">- hosts: 172.16.1.8</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Rpm Packages &quot;&#123;&#123; web_packages &#125;&#125;&quot; &quot;&#123;&#123; ftp_packages &#125;&#125;&quot;</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - &quot;&#123;&#123; web_packages &#125;&#125;&quot;</span><br><span class="line">          - &quot;&#123;&#123; ftp_packages &#125;&#125;&quot;</span><br><span class="line">        state: present</span><br><span class="line"></span><br><span class="line">host_vars 特殊的变量目录，针对单个主机进行变量.</span><br><span class="line">group_vars 特殊的变量目录，针对inventory主机清单中的组进行变量定义.对A组定义的变量B组无法调用</span><br><span class="line">gro	up_vars/all 特殊的变量文件，可以针对所有的主机组定义变量.</span><br></pre></td></tr></table></figure>



<p>练习</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@master project1]# vim host_vars/192.168.160.4</span><br><span class="line">web_packages: zlib-static</span><br><span class="line">ftp_packages: zmap</span><br><span class="line">[root@master project1]# vim hosts</span><br><span class="line">[oldboy]</span><br><span class="line">192.168.160.4</span><br><span class="line">192.168.160.5</span><br><span class="line">[root@master project1]# vim vars_6.yml </span><br><span class="line">- hosts: 192.168.160.4</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Rpm Packages &quot;&#123;&#123; web_packages &#125;&#125;&quot; &quot;&#123;&#123; ftp_packages &#125;&#125;&quot;</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - &quot;&#123;&#123; web_packages &#125;&#125;&quot;</span><br><span class="line">          - &quot;&#123;&#123; ftp_packages &#125;&#125;&quot;</span><br><span class="line">        state: present</span><br><span class="line"></span><br><span class="line">- hosts: 192.168.160.5</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Rpm Packages &quot;&#123;&#123; web_packages &#125;&#125;&quot; &quot;&#123;&#123; ftp_packages &#125;&#125;&quot;</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - &quot;&#123;&#123; web_packages &#125;&#125;&quot;</span><br><span class="line">          - &quot;&#123;&#123; ftp_packages &#125;&#125;&quot;</span><br><span class="line">        state: present</span><br><span class="line">[root@master project1]# ansible-playbook -i hosts vars_6.yml</span><br></pre></td></tr></table></figure>



<p>P20 04 老男孩教育4期-Ansible定义变量-extra-vars</p>
<p>练习</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@master project1]# cat hosts</span><br><span class="line">[oldboy]</span><br><span class="line">192.168.160.4</span><br><span class="line"></span><br><span class="line">[db]</span><br><span class="line">192.168.160.5</span><br><span class="line"></span><br><span class="line">[root@master project1]# cat vars_7.yml </span><br><span class="line">- hosts: oldboy,db</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Rpm Packages &quot;&#123;&#123; web_packages &#125;&#125;&quot; &quot;&#123;&#123; ftp_packages &#125;&#125;&quot;</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - &quot;&#123;&#123; web_packages &#125;&#125;&quot;</span><br><span class="line">          - &quot;&#123;&#123; ftp_packages &#125;&#125;&quot;</span><br><span class="line">        state: present</span><br><span class="line">[root@master project1]# ansible-playbook -i hosts vars_7.yml</span><br><span class="line"></span><br><span class="line">-------------------------------------</span><br><span class="line">[root@master project1]# cat vars_7.yml </span><br><span class="line">- hosts: &quot;&#123;&#123; hosts &#125;&#125;&quot;  #注意：这是一个变量名称</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Rpm Packages &quot;&#123;&#123; web_packages &#125;&#125;&quot; &quot;&#123;&#123; ftp_packages &#125;&#125;&quot;</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - &quot;&#123;&#123; web_packages &#125;&#125;&quot;</span><br><span class="line">          - &quot;&#123;&#123; ftp_packages &#125;&#125;&quot;</span><br><span class="line">        state: present</span><br><span class="line">[root@master project1]# ansible-playbook -i hosts vars_7.yml -e &quot;hosts=oldboy&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-e 外置传参</span></span><br><span class="line">[root@master project1]# ansible-playbook -i hosts vars_7.yml -e &quot;hosts=db&quot;</span><br><span class="line">[root@master project1]# ansible-playbook -i hosts vars_7.yml -e &quot;hosts=db&quot; -e &quot;web_packages=lrzsz&quot;</span><br></pre></td></tr></table></figure>



<p>P21 05 老男孩教育4期-Ansible变量优先级</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">4.ansible变量优先级</span><br><span class="line">6.定义相同的变量不同的值，来测试变量的优先级。操作步骤如下</span><br><span class="line">1)在plabook中定义vars变量</span><br><span class="line">2)在playbook中定义vars_files变量</span><br><span class="line">3)在host_vars中定义变量</span><br><span class="line">4)在group_vars中定义变量</span><br><span class="line">5）通过执行命令传递变量</span><br><span class="line"></span><br><span class="line">[root@master project1]# cat vars_8.yml </span><br><span class="line">- hosts: oldboy</span><br><span class="line">  vars:</span><br><span class="line">    file_name: play_vars</span><br><span class="line">  vars_files: ./var_public.yml</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">    - name: Create Variables &#123;&#123; file_name &#125;&#125;</span><br><span class="line">      file: path=/tmp/&#123;&#123; file_name &#125;&#125; state=touch</span><br><span class="line">      </span><br><span class="line">[root@master project1]# cat vars_public.yml </span><br><span class="line">web_packages: httpd</span><br><span class="line">ftp_packages: vsftpd</span><br><span class="line">file_name: play_vars_public_files</span><br><span class="line"></span><br><span class="line">[root@master project1]# cat host_vars/192.168.160.4 </span><br><span class="line">web_packages: zlib-static</span><br><span class="line">ftp_packages: zmap</span><br><span class="line">file_name: hosts_vars-7</span><br><span class="line"></span><br><span class="line">[root@master project1]# cat group_vars/oldboy </span><br><span class="line">file_name: group_vars-oldboy</span><br><span class="line"></span><br><span class="line">[root@master project1]# cat group_vars/all </span><br><span class="line">web_packages: wget</span><br><span class="line">ftp_packages: tree</span><br><span class="line">file_name: group_vars-all</span><br><span class="line"></span><br><span class="line">[root@master project1]# ansible-playbook vars_8.yml -i hosts -e &quot;file_name=wz_file&quot;</span><br><span class="line"></span><br><span class="line">变量的优先级</span><br><span class="line">外置传参---&gt;playbook(vars_files---&gt;vars)---&gt;inventory(host_vars--&gt;group_vars/group_name---&gt;group_vars-all)</span><br></pre></td></tr></table></figure>



<p>P22 06 老男孩教育4期-Ansible变量注册register</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">5.ansible 变量注册 register debug</span><br><span class="line">[root@master project1]# vim vars_9.yml</span><br><span class="line">- hosts: oldboy</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installed Httpd Server</span><br><span class="line">      yum: name=httpd state=present</span><br><span class="line"></span><br><span class="line">    - name: Service Httpd Server</span><br><span class="line">      service: name=httpd state=started</span><br><span class="line"></span><br><span class="line">    - name: Check Httpd Server</span><br><span class="line">      shell: ps aux|grep httpd  #1.使用shell执行命令</span><br><span class="line">      register: check_httpd  #2.将执行命令的结果存储至check_httpd变量中</span><br><span class="line"></span><br><span class="line">    - name: OutPut Variables</span><br><span class="line">      debug:  #通过debug模块，msg方法 输出变量所有的内容 如果希望输出部分内容，变量.方法</span><br><span class="line">        msg: &quot;&#123;&#123; check_httpd.stdout_lines &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">[root@master project1]# ansible-playbook -i hosts vars_9.yml</span><br></pre></td></tr></table></figure>



<p>P23 07 老男孩教育4期-AnsibleFacts变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">6.ansible facts变量</span><br><span class="line">  用来采集被控端的状态指标，比如：IP地址 主机名称 cpu信息 内存 等等</span><br><span class="line">  默认情况的facts变量名都已经预先定义好了，只需要采集被控端的信息，然后传递至facts变量即可.</span><br><span class="line">[root@master project1]# ansible 192.168.160.4 -m setup -i hosts</span><br><span class="line">[root@master project1]# ansible 192.168.160.4 -m setup -i hosts&gt;facts.txt</span><br><span class="line">[root@master project1]# vim vars_10.yml</span><br><span class="line">- hosts: oldboy</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Output variables ansible facts</span><br><span class="line">      debug:</span><br><span class="line">        msg: IP address &quot;&#123;&#123; ansible_fqdn &#125;&#125;&quot; is &quot;&#123;&#123; ansible_default_ipv4.address &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">[root@master project1]# ansible-playbook -i hosts vars_10.yml</span><br></pre></td></tr></table></figure>

<p>2.facts开启后会影响AnsSble主机的性能，如果没有采集被控端主机需求可选择关闭</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]# cat facts.yml</span><br><span class="line">- hosts: web</span><br><span class="line">  gather_facts:no  #关闭信息采集</span><br><span class="line">  tasks:</span><br></pre></td></tr></table></figure>



<p>P24 08 老男孩教育4期-AnsibleFacts安装Zabbix-Agent</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@master project1]# vim vars_11.yml</span><br><span class="line">- hosts: oldboy</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">    - name: Configure Zabbix Agent</span><br><span class="line">      template: src=./zabbix_agentd.conf.j2 dest=/etc/zabbix_agentd.conf</span><br><span class="line">        #copy: 将文件原样拷贝</span><br><span class="line">        #template: 会将拷贝的文件进行变量的解析，然后再分发</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# scp /etc/zabbix_agentd.conf root@192.168.160.3:/root/project1/zabbix_agentd.conf.j2</span><br><span class="line">[root@master project1]# vim zabbix_agentd.conf.j2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Hostname=</span></span><br><span class="line"></span><br><span class="line">Hostname=&#123;&#123; ansible_fqdn &#125;&#125;  #修改为变量</span><br></pre></td></tr></table></figure>



<p>P25 09 老男孩教育4期-AnsibleFacts安装Memcached</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">4.使用facts变量根据不同的内存生成不同Memcached配置文件</span><br><span class="line">1）准备两台物理内存不一样的主机</span><br><span class="line">172.16.1.7 1G  memcached 500MB</span><br><span class="line">172.16.1.8 2G  memcached 1Gb</span><br><span class="line"></span><br><span class="line">-------------------在写任何新的服务之前，请先手动测试一遍，提取安装的命令\配置文件路径\启动命令</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">手动测试安装</span></span><br><span class="line">[root@master project1]# yum install memcached -y</span><br><span class="line">[root@master project1]# vim /etc/sysconfig/memcached </span><br><span class="line">PORT=&quot;11211&quot;</span><br><span class="line">USER=&quot;memcached&quot;</span><br><span class="line">MAXCONN=&quot;1024&quot;</span><br><span class="line">CACHESIZE=&quot;64&quot;</span><br><span class="line">OPTIONS=&quot;&quot;</span><br><span class="line">[root@master project1]# systemctl start memcached</span><br><span class="line"></span><br><span class="line">2）如何提取被控端的总内存大小</span><br><span class="line">[root@master project1]# ansible 192.168.160.4 -m setup -a &quot;filter=ansible_memtotal_mb&quot; -i hosts</span><br><span class="line">192.168.160.4 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;ansible_memtotal_mb&quot;: 1819, </span><br><span class="line">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master project1]# vim vars_12.yml</span><br><span class="line">[root@master project1]# cat vars_12.yml </span><br><span class="line">- hosts: oldboy</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installed Memcached Server</span><br><span class="line">      yum: name=memcached state=present</span><br><span class="line"></span><br><span class="line">    - name: Configure Memcached Server</span><br><span class="line">      template: src=./memcached.j2 dest=/etc/sysconfig/memcached</span><br><span class="line"></span><br><span class="line">    - name: Service Memcached Server</span><br><span class="line">      service: name=memcached state=started enabled=yes</span><br><span class="line"></span><br><span class="line">    - name: Check Memcached Server</span><br><span class="line">      shell: ps aux|grep memcached</span><br><span class="line">      register: check_mem</span><br><span class="line"></span><br><span class="line">    - name: Debug Memcached Variables</span><br><span class="line">      debug:</span><br><span class="line">        msg: &quot;&#123;&#123; check_mem.stdout_lines &#125;&#125;&quot;</span><br><span class="line">[root@master project1]# cp /etc/sysconfig/memcached ./memcached.j2</span><br><span class="line">PORT=&quot;11211&quot;</span><br><span class="line">USER=&quot;memcached&quot;</span><br><span class="line">MAXCONN=&quot;1024&quot;</span><br><span class="line">CACHESIZE=&quot;&#123;&#123; ansible_memtotal_mb //2 &#125;&#125;&quot;</span><br><span class="line">OPTIONS=&quot;&quot;</span><br><span class="line"></span><br><span class="line">[root@master project1]# ansible-playbook -i hosts vars_12.yml</span><br></pre></td></tr></table></figure>



<p>P26 10 老男孩教育4期-AnsibleFacts批量修改主机名称</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[root@master project1]# vim vars_13.yml</span><br><span class="line">- hosts: oldboy</span><br><span class="line">  tasks:</span><br><span class="line">    - name: SHell</span><br><span class="line">      shell: echo $RANDOM|md5sum |cut -c 5-12</span><br><span class="line">      register: get_random</span><br><span class="line"></span><br><span class="line">    - name: debug</span><br><span class="line">      debug:</span><br><span class="line">        msg: &quot;&#123;&#123; get_random.stdout_lines &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">    #- name: Hostname</span><br><span class="line">    #  hostname: name=&#123;&#123; get_random.stdout_lines[0] &#125;&#125;</span><br><span class="line">      </span><br><span class="line">    - name: Hostname</span><br><span class="line">      hostname: name=&#123;&#123; get_random.stdout &#125;&#125;</span><br><span class="line">      </span><br><span class="line">[root@node1 ~]# hostnamectl</span><br><span class="line">   Static hostname: 5130d53a</span><br><span class="line">[root@node2 ~]# hostnamectl</span><br><span class="line">   Static hostname: bc924449</span><br><span class="line">   </span><br><span class="line">--------------------------------------------   </span><br><span class="line">[root@master project1]# vim vars_14.yml</span><br><span class="line">- hosts: oldboy</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">    - name: Get Facts</span><br><span class="line">      debug:</span><br><span class="line">        msg: &quot;&#123;&#123; ansible_default_ipv4.address &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">    - name: Hostname</span><br><span class="line">      hostname: name=web_&#123;&#123; ansible_default_ipv4.address &#125;&#125;</span><br><span class="line">      </span><br><span class="line">[root@node1 ~]# hostname</span><br><span class="line">web_192.168.160.4</span><br><span class="line">[root@node2 ~]# hostname</span><br><span class="line">web_192.168.160.5</span><br><span class="line"></span><br><span class="line">---------------------------------------------</span><br><span class="line">[root@master project1]# vim vars_14.yml</span><br><span class="line">- hosts: oldboy</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">    - name: SHell</span><br><span class="line">      shell: echo $RANDOM|md5sum |cut -c 5-12</span><br><span class="line">      register: get_random</span><br><span class="line"></span><br><span class="line">    - name: Get Facts</span><br><span class="line">      debug:</span><br><span class="line">        msg: &quot;&#123;&#123; ansible_date_time.epoch &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">    - name: Hostname</span><br><span class="line">      hostname: name=&#123;&#123; get_random.stdout &#125;&#125;_&#123;&#123; ansible_date_time.epoch &#125;&#125;</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# hostname</span><br><span class="line">720b1d62_1658234720</span><br><span class="line">[root@node2 ~]# hostname</span><br><span class="line">56cb5e01_1658234718</span><br></pre></td></tr></table></figure>



<p>P27 00 老男孩教育4期-作业实现Kodcloud</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">nginx+php</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.卸载php低版本</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.安装nginx1.12  ---&gt; epel</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.安装php5.4  ---&gt; base</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4.创建组和用户www</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5.配置nginx --&gt;nginx.conf  指定运行的用户身份www</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">6.配置nginx.conf.d/kod.conf 虚拟主机</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">7.根据虚拟主机的配置创建存放代码的目录</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">8.拷贝kod云的代码.解压</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">9.授权目录的权限</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">7.配置php-fpm 管理php的用户身份</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">8.配置php程序，php.ini 调整可道云上传的大小</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">9.测试nginx和php的配置文件是否正确，正确则启动</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master project1]# vim nginx_php.yml</span><br><span class="line">[root@master project1]# cat nginx_php.yml </span><br><span class="line">---</span><br><span class="line">- hosts: oldboy</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.卸载php低版本</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.安装nginx1.12 php5.4</span></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installed Nginx</span><br><span class="line">      yum: name=nginx,php,php-pdo,php-gd,php-mbstring state=present</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4.创建组和用户www</span></span><br><span class="line">    - name: Create Group www</span><br><span class="line">      group: name=www gid=666 state=present</span><br><span class="line"></span><br><span class="line">    - name: Create User www</span><br><span class="line">      user: name=www uid=666 group=666 shell=/sbin/nologin create_home=no state=present</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5.配置nginx --&gt;nginx.conf  指定运行的用户身份www</span></span><br><span class="line">    - name: Configure Nginx Server</span><br><span class="line">      copy: src=./nginx.conf.j2 dest=/etc/nginx/nginx.conf backup=yes</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">6.配置nginx.conf.d/kod.conf 虚拟主机</span></span><br><span class="line">    - name: Configure Virtual Server</span><br><span class="line">      copy: src=./kod.conf.j2 dest=/etc/nginx/conf.d/kod.conf backup=yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">7.根据虚拟主机的配置创建存放代码的目录</span></span><br><span class="line">    - name: Create Kod Data Directory</span><br><span class="line">      file: path=/ansible_code state=directory</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">8.拷贝kod云的代码.解压</span></span><br><span class="line">    - name: Unzip Kod Data Directory</span><br><span class="line">      unarchive: src=./backup/kodexplorer4.40.zip</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">9.授权目录的权限</span></span><br><span class="line">    - name: Chown Kod Data www</span><br><span class="line">      file: path=/ansible_code owner=www group=www recurse=yes mode=0777</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">7.配置php-fpm 管理php的用户身份</span></span><br><span class="line">    - name: Configure PHP-FPM Server</span><br><span class="line">      copy: src=./php_www.conf.j2 dest=/etc/php-fpm.d/www.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">8.配置php程序，php.ini 调整可道云上传的大小</span></span><br><span class="line">    - name: Configure PHP Server</span><br><span class="line">      copy: src=./php.ini.j2 dest=/etc/php.ini</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">9.测试nginx和php的配置文件是否正确，正确则启动</span></span><br><span class="line">    - name: Service Nginx Server</span><br><span class="line">      service: name=nginx state=started enabled=yes</span><br><span class="line"></span><br><span class="line">    - name: Service PHP-FPM Server</span><br><span class="line">      service: name=php-fpm state=started enabled=yes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master project1]# vim kod.conf.j2</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name kod.oldboy.com;</span><br><span class="line">    root /ansible_code;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        index index.php index.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@node2 nginx]# scp /etc/nginx/nginx.conf root@192.168.160.3:/root/project1/nginx.conf.j2</span><br><span class="line">[root@node2 ~]# scp /etc/php.ini root@192.168.160.3:/root/project1/php.ini.j2</span><br><span class="line">[root@node2 ~]# scp /etc/php-fpm.d/www.conf root@192.168.160.3:/root/project1/php_www.conf.j2</span><br><span class="line">[root@master project1]# ansible-playbook nginx_php.yml --limit=&quot;192.168.160.4&quot; -i hosts</span><br><span class="line"></span><br><span class="line">--------------------------------</span><br><span class="line">[root@master project1]# cat nginx.conf.j2 </span><br><span class="line">user www;</span><br><span class="line">worker_processes 1;</span><br><span class="line">error_log /var/log/nginx/error.log warn;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    #include /etc/nginx/mime.types;</span><br><span class="line">    #default_type application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 4096;</span><br><span class="line">    gzip on;</span><br><span class="line"></span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        listen       [::]:80;</span><br><span class="line">        server_name  _;</span><br><span class="line">        root         /usr/share/nginx/html;</span><br><span class="line"></span><br><span class="line">        # Load configuration files for the default server block.</span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line"></span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">        location = /404.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--------------------------------</span><br><span class="line">[root@master project1]# cat kod.conf.j2</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name kod.oldboy.com;</span><br><span class="line">    root /ansible_code;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        index index.php index.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>改为用变量替代</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">[root@master project1]# vim group_vars/all </span><br><span class="line">[root@master project1]# cat group_vars/all </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">nginx php variables</span></span><br><span class="line">web_user: www</span><br><span class="line">nginx_conf: /etc/nginx/nginx.conf</span><br><span class="line">nginx_virt: /etc/nginx/conf.d</span><br><span class="line">nginx_code: /ansible_code</span><br><span class="line">php_fpm_conf: /etc/php-fpm.d/www.conf</span><br><span class="line">php_ini_conf: /etc/php.ini</span><br><span class="line"></span><br><span class="line">[root@master project1]# vim nginx_php.yml </span><br><span class="line">[root@master project1]# cat nginx_php.yml</span><br><span class="line">---</span><br><span class="line">- hosts: oldboy</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.卸载php低版本</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.安装nginx1.12 php5.4</span></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installed Nginx</span><br><span class="line">      yum: name=nginx,php,php-pdo,php-gd,php-mbstring,php-fpm state=present</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4.创建组和用户www</span></span><br><span class="line">    - name: Create Group &#123;&#123; web_user &#125;&#125;</span><br><span class="line">      group: name=&#123;&#123; web_user &#125;&#125; gid=666 state=present</span><br><span class="line"></span><br><span class="line">    - name: Create User &#123;&#123; web_user &#125;&#125;</span><br><span class="line">      user: name=&#123;&#123; web_user &#125;&#125; uid=666 group=666 shell=/sbin/nologin create_home=no state=present</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5.配置nginx --&gt;nginx.conf  指定运行的用户身份www</span></span><br><span class="line">    - name: Configure Nginx &#123;&#123; nginx_conf &#125;&#125;</span><br><span class="line">      copy: src=./nginx.conf.j2 dest=&#123;&#123; nginx_conf &#125;&#125; backup=yes</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">6.配置nginx.conf.d/kod.conf 虚拟主机</span></span><br><span class="line">    - name: Configure Virtual &#123;&#123; nginx_virt &#125;&#125;</span><br><span class="line">      copy: src=./kod.conf.j2 dest=&#123;&#123; nginx_virt &#125;&#125;/kod.conf backup=yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">7.根据虚拟主机的配置创建存放代码的目录</span></span><br><span class="line">    - name: Create Kod &#123;&#123; nginx_code &#125;&#125; Directory</span><br><span class="line">      file: path=&#123;&#123; nginx_code &#125;&#125; state=directory</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">8.拷贝kod云的代码.解压</span></span><br><span class="line">    - name: Unzip Kod &#123;&#123; nginx_code &#125;&#125; Directory</span><br><span class="line">      unarchive: src=./backup/kodexplorer4.40.zip dest=&#123;&#123; nginx_code &#125;&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">9.授权目录的权限</span></span><br><span class="line">    - name: Chown Kod Data www</span><br><span class="line">      file: path=&#123;&#123; nginx_code &#125;&#125; owner=&#123;&#123; web_user &#125;&#125; group=&#123;&#123; web_user &#125;&#125; recurse=yes mode=0777</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">7.配置php-fpm 管理php的用户身份</span></span><br><span class="line">    - name: Configure PHP-FPM &#123;&#123; php_fpm_conf &#125;&#125;</span><br><span class="line">      copy: src=./php_www.conf.j2 dest=&#123;&#123; php_fpm_conf &#125;&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">8.配置php程序，php.ini 调整可道云上传的大小</span></span><br><span class="line">    - name: Configure PHP Server &#123;&#123; php_ini_conf &#125;&#125;</span><br><span class="line">      copy: src=./php.ini.j2 dest=&#123;&#123; php_ini_conf &#125;&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">9.测试nginx和php的配置文件是否正确，正确则启动</span></span><br><span class="line">    - name: Service Nginx Server</span><br><span class="line">      service: name=nginx state=started enabled=yes</span><br><span class="line"></span><br><span class="line">    - name: Service PHP-FPM Server</span><br><span class="line">      service: name=php-fpm state=started enabled=yes</span><br><span class="line"></span><br><span class="line">[root@master project1]# vim nginx.conf.j2</span><br><span class="line">user &#123;&#123; web_user &#125;&#125;;</span><br><span class="line">worker_processes &#123;&#123; ansible_processor_vcpus &#125;&#125;;</span><br><span class="line">    worker_connections &#123;&#123; ansible_processor_vcpus * 10240 &#125;&#125;;</span><br><span class="line">    include &#123;&#123; nginx_virt &#125;&#125;/*.conf;</span><br><span class="line"></span><br><span class="line">[root@master project1]# vim php.ini.j2</span><br><span class="line">upload_max_filesize = &#123;&#123; php_ini_max_upload &#125;&#125;</span><br><span class="line"></span><br><span class="line">[root@master project1]# vim group_vars/all </span><br><span class="line">[root@master project1]# cat group_vars/all </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">nginx php variables</span></span><br><span class="line">web_user: www</span><br><span class="line">nginx_conf: /etc/nginx/nginx.conf</span><br><span class="line">nginx_virt: /etc/nginx/conf.d</span><br><span class="line">nginx_code: /ansible_code</span><br><span class="line">php_fpm_conf: /etc/php-fpm.d/www.conf</span><br><span class="line">php_ini_conf: /etc/php.ini</span><br><span class="line">php_ini_max_upload: 200M</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master project1]# cat nginx_php.yml </span><br><span class="line">---</span><br><span class="line">- hosts: oldboy</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.卸载php低版本</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.安装nginx1.12 php5.4</span></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installed Nginx</span><br><span class="line">      yum: name=nginx,php,php-pdo,php-gd,php-mbstring,php-fpm state=present</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4.创建组和用户www</span></span><br><span class="line">    - name: Create Group &#123;&#123; web_user &#125;&#125;</span><br><span class="line">      group: name=&#123;&#123; web_user &#125;&#125; gid=666 state=present</span><br><span class="line"></span><br><span class="line">    - name: Create User &#123;&#123; web_user &#125;&#125;</span><br><span class="line">      user: name=&#123;&#123; web_user &#125;&#125; uid=666 group=666 shell=/sbin/nologin create_home=no state=present</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5.配置nginx --&gt;nginx.conf  指定运行的用户身份www</span></span><br><span class="line">    - name: Configure Nginx &#123;&#123; nginx_conf &#125;&#125;</span><br><span class="line">      template: src=./nginx.conf.j2 dest=&#123;&#123; nginx_conf &#125;&#125; backup=yes</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#6.配置nginx.conf.d/kod.conf 虚拟主机</span></span></span><br><span class="line">    - name: Configure Virtual &#123;&#123; nginx_virt &#125;&#125;</span><br><span class="line">      template: src=./kod.conf.j2 dest=&#123;&#123; nginx_virt &#125;&#125;/kod.conf backup=yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#7.根据虚拟主机的配置创建存放代码的目录</span></span></span><br><span class="line">    - name: Create Kod &#123;&#123; nginx_code &#125;&#125; Directory</span><br><span class="line">      file: path=&#123;&#123; nginx_code &#125;&#125; state=directory</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#8.拷贝kod云的代码.解压</span></span></span><br><span class="line">    - name: Unzip Kod &#123;&#123; nginx_code &#125;&#125; Directory</span><br><span class="line">      unarchive: src=./backup/kodexplorer4.40.zip dest=&#123;&#123; nginx_code &#125;&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#9.授权目录的权限</span></span></span><br><span class="line">    - name: Chown Kod Data www</span><br><span class="line">      file: path=&#123;&#123; nginx_code &#125;&#125; owner=&#123;&#123; web_user &#125;&#125; group=&#123;&#123; web_user &#125;&#125; recurse=yes mode=0777</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#7.配置php-fpm 管理php的用户身份</span></span></span><br><span class="line">    - name: Configure PHP-FPM &#123;&#123; php_fpm_conf &#125;&#125;</span><br><span class="line">      template: src=./php_www.conf.j2 dest=&#123;&#123; php_fpm_conf &#125;&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#8.配置php程序，php.ini 调整可道云上传的大小</span></span></span><br><span class="line">    - name: Configure PHP Server &#123;&#123; php_ini_conf &#125;&#125;</span><br><span class="line">      template: src=./php.ini.j2 dest=&#123;&#123; php_ini_conf &#125;&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">9.测试nginx和php的配置文件是否正确，正确则启动</span></span><br><span class="line">    - name: Service Nginx Server</span><br><span class="line">      service: name=nginx state=started enabled=yes</span><br><span class="line"></span><br><span class="line">    - name: Service PHP-FPM Server</span><br><span class="line">      service: name=php-fpm state=started enabled=yes</span><br><span class="line"></span><br><span class="line">[root@master project1]# ansible-playbook -i hosts nginx_php.yml</span><br></pre></td></tr></table></figure>



<p>P28 01 老男孩教育4期-Ansible判断语句when</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">问题：lamp.yml 如何实现变更配置端口8080,执行playbook后，所有被控端主机马上变更. handlers：</span><br><span class="line">问题：测试希望仅执行某个特定的tasks任务时，怎么办？</span><br><span class="line">问题：检测nginx语法，正常则启动或重启，不正常则忽略.</span><br><span class="line"></span><br><span class="line">playbook Tasks任务控制：</span><br><span class="line">1.条件判断 when</span><br><span class="line">2.循环语句</span><br><span class="line">3.handlers 触发器</span><br><span class="line">4.tags标签 根据指定的标签执行 调试</span><br><span class="line">5.include包含</span><br><span class="line">6.错误忽略ignore_errors</span><br><span class="line">7.错误处理</span><br><span class="line">  changed_when</span><br></pre></td></tr></table></figure>



<p>练习</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">[root@master project1]# mkdir /opt/project1</span><br><span class="line">[root@master project1]# mv $(find ./ -type f -maxdepth 1) /opt/project1/</span><br><span class="line">[root@master project1]# mv /opt/project1/ ./docs1</span><br><span class="line">[root@master project1]# cp docs1/hosts ./</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">playbook Tasks任务控制：</span><br><span class="line">1.条件判断 when</span><br><span class="line"></span><br><span class="line">实践案例一、根据不同操作系统，安装相同的软件包</span><br><span class="line">[root@master project1]# cat tasks_1.yml </span><br><span class="line">- hosts: oldboy</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">    - name: Installed &#123;&#123; ansible_distribution &#125;&#125; Httpd Server</span><br><span class="line">      yum: name=httpd state=present</span><br><span class="line">      when: ( ansible_distribution == &quot;CentOS&quot; )</span><br><span class="line"></span><br><span class="line">    - name: Installed &#123;&#123; ansible_distribution &#125;&#125; Httpd2 Server</span><br><span class="line">      yum: name=httpd2 state=present</span><br><span class="line">      when: ( ansible_distribution == &quot;Ubuntu&quot; )</span><br><span class="line"></span><br><span class="line">[root@master project1]# ansible-playbook -i hosts tasks_1.yml </span><br><span class="line"></span><br><span class="line">------------------------------------</span><br><span class="line">实践案例二、为所有的web主机名添加nginx仓库，其余的都跳过添加</span><br><span class="line">[root@56cb5e01_1658234718 ~]# hostnamectl set-hostname web02</span><br><span class="line">[root@56cb5e01_1658234718 ~]# bash</span><br><span class="line">[root@web02 ~]# hostnamectl</span><br><span class="line">   Static hostname: web02</span><br><span class="line"></span><br><span class="line">[root@master project1]# vim hosts</span><br><span class="line">[webserver]</span><br><span class="line">192.168.160.4</span><br><span class="line">192.168.160.5</span><br><span class="line"></span><br><span class="line">[lbserver]</span><br><span class="line">192.168.160.6</span><br><span class="line">192.168.160.7</span><br><span class="line">[root@master project1]# ansible all -m ping -i hosts</span><br><span class="line"></span><br><span class="line">[root@master project1]# cat tasks_2.yml</span><br><span class="line">- hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Create YUM Repo</span><br><span class="line">      yum_repository:</span><br><span class="line">        name: ansible_nginx</span><br><span class="line">        description: ansible_test</span><br><span class="line">        baseurl: https://mirrors.oldboy.com</span><br><span class="line">        gpgcheck: no</span><br><span class="line">        enabled: yes</span><br><span class="line">      when: ( ansible_fqdn is match(&quot;web*&quot;) )</span><br><span class="line"></span><br><span class="line">[root@master project1]# ansible-playbook -i hosts tasks_2.yml </span><br><span class="line">[root@web01 ~]# cat /etc/yum.repos.d/ansible_nginx.repo </span><br><span class="line">[ansible_nginx]</span><br><span class="line">baseurl = https://mirrors.oldboy.com</span><br><span class="line">enabled = 1</span><br><span class="line">gpgcheck = 0</span><br><span class="line">name = ansible_test</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">主机名称是web*或主机名称是lb*的则添加这个nginx源</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">让web和lb都安装这个操作，使用or</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">另还有( ansible_fqdn is not match(<span class="string">&quot;lb*&quot;</span>) )，不是lb的都添加这个源</span></span><br><span class="line">[root@master project1]# cat tasks_2.yml </span><br><span class="line">- hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Create YUM Repo</span><br><span class="line">      yum_repository:</span><br><span class="line">        name: ansible_nginx</span><br><span class="line">        description: ansible_test</span><br><span class="line">        baseurl: https://mirrors.oldboy.com</span><br><span class="line">        gpgcheck: no</span><br><span class="line">        enabled: no</span><br><span class="line">      when: ( ansible_fqdn is match(&quot;web*&quot;) ) or</span><br><span class="line">            ( ansible_fqdn is match(&quot;lb*&quot;) )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-------------------------------------------------</span><br><span class="line">实践案例三、根据命令执行的结果进行判断</span><br><span class="line">[root@master project1]# vim tasks_3.yml</span><br><span class="line">[root@master project1]# cat tasks_3.yml </span><br><span class="line">- hosts: all</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">    #检查httpd服务是否是活动的</span><br><span class="line">    - name: Check Httpd Server</span><br><span class="line">      command: systemctl is-active httpd</span><br><span class="line">      ignore_errors: yes</span><br><span class="line">      register: check_httpd</span><br><span class="line"></span><br><span class="line">      #如果check_httpd变量中的rc执行命令结果等于0,则执行重启httpd,否则跳过</span><br><span class="line">    - name: Httpd Restart</span><br><span class="line">      service: name=httpd state=restarted</span><br><span class="line">      when: check_httpd.rc == 0</span><br><span class="line">[root@web01 ~]# systemctl is-active httpd</span><br><span class="line">active</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">2.循环语句 with_items</span><br><span class="line">实践案例一、使用循环启动多个服务</span><br><span class="line">[root@master project1]# vim tasks_4.yml</span><br><span class="line">[root@master project1]# cat tasks_4.yml </span><br><span class="line">- hosts: webserver</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">    - name: Service Nginx Server</span><br><span class="line">      service: name=&#123;&#123; item &#125;&#125; state=restarted</span><br><span class="line">      with_items:</span><br><span class="line">        - nginx</span><br><span class="line">        - php-fpm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">实践案例二、定义变量方式循环安装软件包</span><br><span class="line">[root@master project1]# vim tasks_5.yml</span><br><span class="line">- hosts: webserver</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installed Httpd Mariadb Package</span><br><span class="line">      yum: name=&#123;&#123; pack &#125;&#125; state=latest</span><br><span class="line">      vars:</span><br><span class="line">        pack:</span><br><span class="line">          - httpd</span><br><span class="line">          - mariadb-server</span><br><span class="line"></span><br><span class="line">实践案例三、使用变量字典循环方式批量创建用户</span><br><span class="line">[root@master project1]# vim tasks_6.yml</span><br><span class="line">- hosts: webserver</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Create User</span><br><span class="line">      user: name=&#123;&#123; item.name &#125;&#125; groups=&#123;&#123; item.groups &#125;&#125; state=present</span><br><span class="line">      with_items:</span><br><span class="line">        - &#123; name: &#x27;www&#x27;, groups: &#x27;bin&#x27;&#125;</span><br><span class="line">        - &#123; name: &#x27;test&#x27;, groups: &#x27;root&#x27;&#125;</span><br><span class="line"></span><br><span class="line">实践案例三、使用变量字典循环方式批量拷贝文件</span><br><span class="line">[root@master project1]# vim tasks_7.yml</span><br><span class="line">[root@master project1]# cat tasks_7.yml </span><br><span class="line">- hosts: webserver</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">    - name: Configure Rsyncd Server</span><br><span class="line">      copy: src=&#123;&#123; item.src &#125;&#125; dest=&#123;&#123; item.dest &#125;&#125; mode=&#123;&#123; item.mode &#125;&#125;</span><br><span class="line">      with_items:</span><br><span class="line">        - &#123; src: &#x27;./rsyncd.conf.j2&#x27;, dest: &#x27;/tmp/rsyncd.conf&#x27;, mode: &#x27;0644&#x27; &#125;</span><br><span class="line">        - &#123; src: &#x27;./rsyncd.pass.j2&#x27;, dest: &#x27;/tmp/rsyncd.pass&#x27;, mode: &#x27;0600&#x27; &#125;</span><br><span class="line"></span><br><span class="line">    #高级写法！！</span><br><span class="line">    - name: Configure PHP-FPM &#123;&#123; php_fpm_conf &#125;&#125;</span><br><span class="line">      template: src=&#123;&#123; item.src &#125;&#125; dest=&#123;&#123; item.dest &#125;&#125;</span><br><span class="line">      with_items:</span><br><span class="line">        - &#123; src: &#x27;./docs1/php_www.conf.j2&#x27;, dest: &#x27;&#123;&#123; php_fpm_conf &#125;&#125;&#x27; &#125;</span><br><span class="line">        - &#123; src: &#x27;./docs1/php.ini.j2&#x27;, dest: &#x27;&#123;&#123; php_ini_conf &#125;&#125;&#x27; &#125;</span><br><span class="line"></span><br><span class="line">[root@master project1]# ansible-playbook -i hosts tasks_7.yml</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">3.handlers 触发器  notify监控 ---&gt;通知 ---&gt; Handlers触发</span><br><span class="line">1.安装apache服务playbook</span><br><span class="line">[root@m01 ~]# cat webserver.yml</span><br><span class="line">- hosts: web</span><br><span class="line">  remote_user: root</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.定义变量，在配置文件中调用</span></span><br><span class="line">  vars:</span><br><span class="line">    http_port: 8881</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.安装httpd服务</span></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Httpd Server</span><br><span class="line">      yum: name=httpd state=present</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.使用template模板，引用上面vars定义的变量至配置文件中</span></span><br><span class="line">    - name: Configure Httpd Server</span><br><span class="line">      template: src=./httpd.conf dest=/etc/httpd/conf/httpd.conf</span><br><span class="line">      notify:  #调用名称为Restart Httpd Server的handlers(可以写多个)</span><br><span class="line">        - Restart Httpd Server</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4.启动Httpd服务</span></span><br><span class="line">    - name: Start Httpd Server</span><br><span class="line">      service: name=httpd state=started enabled=yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">5.如果配置文件发生变化会调用该handlers下面的对应名称的task</span></span><br><span class="line">  handlers:</span><br><span class="line">    - name: Restart Httpd Server</span><br><span class="line">      service: name=httpd state=restarted</span><br><span class="line"></span><br><span class="line">3.handlers注意事项</span><br><span class="line">1.无论多少个task通知了相同的handlers,handlers仅会在所有tasks结束后运行一次。</span><br><span class="line">2.只有task发生改变了才会通知handlers,没有改变则不会触发handlers</span><br><span class="line">3.不能使用handlers替代tasks、因为handlers是一个特殊的tasks。</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">4.tags标签 根据指定的标签执行 调试</span><br><span class="line">1.对一个tasks指定一个tags标签</span><br><span class="line">2.对一个tasks指定多个tags标签</span><br><span class="line">3.多个tasks任务指定一个tags标签</span><br><span class="line"></span><br><span class="line">nginx</span><br><span class="line">installd</span><br><span class="line">  - tags: 1</span><br><span class="line">configure</span><br><span class="line">  - tags: 1</span><br><span class="line">service</span><br><span class="line">  - tags: 1</span><br><span class="line">  </span><br><span class="line">apaache</span><br><span class="line">installd</span><br><span class="line">  - tags: 4</span><br><span class="line">configure</span><br><span class="line">  - tags: 4</span><br><span class="line">service</span><br><span class="line">  - tags: 4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">指定执行某个tags标签</span><br><span class="line">[root@master docs1]# ansible-playbook -i hosts nginx_php.yml -t &quot;test_user&quot;</span><br><span class="line">忽略执行某个tags标签</span><br><span class="line">[root@master docs1]# ansible-playbook -i hosts nginx_php.yml --skip-tags &quot;test_user&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master project1]# vim tasks_8.yml</span><br><span class="line">[root@master project1]# cat tasks_8.yml </span><br><span class="line">- hosts: webserver</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Install Nfs Server</span><br><span class="line">      yum: name=nfs-utils state=present</span><br><span class="line">      tags: install_nfs</span><br><span class="line"></span><br><span class="line">    - name: Service Nfs Server</span><br><span class="line">      service: name=nfs-server state=started enabled=yes</span><br><span class="line">      tags: start_nfs-server</span><br><span class="line"></span><br><span class="line">指定执行&quot;install_nfs&quot; tags标签</span><br><span class="line">[root@master project1]# ansible-playbook -i hosts tasks_8.yml -t &quot;install_nfs&quot;</span><br><span class="line">忽略执行 &quot;install_nfs&quot; tags标签</span><br><span class="line">[root@master project1]# ansible-playbook -i hosts tasks_8.yml --skip-tags &quot;install_nfs&quot;</span><br></pre></td></tr></table></figure>



<p>P32 05 老男孩教育4期-Ansible包含Include</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">5.include包含</span><br><span class="line">1)编写restart_httpd.yml文件</span><br><span class="line">[root@ansible project1]# cat restart_httpd.yml  #注意这是一个tasks所有没有play的任何信息</span><br><span class="line">- name: Restart Httpd Server</span><br><span class="line">  service: name=httpd state=restarted</span><br><span class="line"></span><br><span class="line">2) A Project的playbook如下</span><br><span class="line">[root@ansible project1]# cat a_project.yml</span><br><span class="line">- hosts: webserver</span><br><span class="line">  tasks:</span><br><span class="line">    - name: A Project command</span><br><span class="line">      command: echo &quot;A&quot;</span><br><span class="line">      </span><br><span class="line">    - name: Restart httpd</span><br><span class="line">      include: restart_httpd.yml</span><br><span class="line">      </span><br><span class="line">3)B Project的playbook如下</span><br><span class="line">[root@ansible project1]# cat b_project.yml</span><br><span class="line">- hosts: webserver</span><br><span class="line">  tasks:</span><br><span class="line">    - name: B Project command</span><br><span class="line">      command: echo &quot;B&quot;</span><br><span class="line">      </span><br><span class="line">    - name: Restart httpd</span><br><span class="line">      include_tasks: restart_httpd.yml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">导入一个完整的playbook文件 （play task）</span><br><span class="line">[root@master project1]# vim tasks_total.yml</span><br><span class="line">[root@master project1]# cat tasks_total.yml </span><br><span class="line">- import_playbook: ./tasks_1.yml</span><br><span class="line">- import_playbook: ./tasks_2.yml</span><br><span class="line">[root@master project1]# ansible-playbook -i hosts tasks_total.yml</span><br><span class="line">-----------------------------------import_playbook include include_tasks</span><br></pre></td></tr></table></figure>



<p>P33 06 老男孩教育4期-Ansible忽略错误ignore_errors</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">6.错误忽略ignore_errors</span><br><span class="line">[root@master project1]# cat tasks_9.yml </span><br><span class="line">- hosts: webserver</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Command</span><br><span class="line">      command: /bin/false</span><br><span class="line">      ignore_errors: yes</span><br><span class="line"></span><br><span class="line">    - name: Create File</span><br><span class="line">      file: path=/tmp/tttt state=touch</span><br><span class="line">[root@master project1]# ansible-playbook -i hosts tasks_9.yml</span><br></pre></td></tr></table></figure>



<p>P34 07 老男孩教育4期-Ansible错误处理changed_when</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">7.错误处理changed_when</span><br><span class="line">--------------------------------------------</span><br><span class="line">1.强制调用handlers</span><br><span class="line">[root@master project1]# cat tasks_10.yml </span><br><span class="line">- hosts: webserver</span><br><span class="line">  force_handlers: yes #强制调用handlers</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Touch File</span><br><span class="line">      file: path=/tmp/bgx_handlers state=touch</span><br><span class="line">      notify: Restart Httpd Server</span><br><span class="line"></span><br><span class="line">    - name: Installed Packages</span><br><span class="line">      yum: name=sb state=latest</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">    - name: Restart Httpd Server</span><br><span class="line">      service: name=httpd state=restarted</span><br><span class="line"></span><br><span class="line">------------------------------------------------</span><br><span class="line">2.关闭changed的状态（确定该tasks不会对被控端做任何的修改和变更.） changed_when: false</span><br><span class="line">[root@master project1]# cat tasks_11.yml </span><br><span class="line">- hosts: webserver</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installed Httpd Server</span><br><span class="line">      yum: name=httpd state=present</span><br><span class="line"></span><br><span class="line">    - name: Service Httpd Server</span><br><span class="line">      service: name=httpd state=started</span><br><span class="line"></span><br><span class="line">    - name: Check Httpd Server</span><br><span class="line">      shell: ps aux|grep httpd</span><br><span class="line">      register: check_httpd</span><br><span class="line">      changed_when: false</span><br><span class="line"></span><br><span class="line">    - name: OutPut Variables</span><br><span class="line">      debug:</span><br><span class="line">        msg: &quot;&#123;&#123; check_httpd.stdout_lines &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------</span><br><span class="line">案例三、使用changed_when检查tasks任务返回的结果</span><br><span class="line">[root@web01 ~]# scp /etc/nginx/nginx.conf root@192.168.160.3:/root/project1</span><br><span class="line">[root@master project1]# mv nginx.conf nginx.conf.j2</span><br><span class="line">[root@master project1]# which nginx</span><br><span class="line">/usr/sbin/nginx</span><br><span class="line">[root@master project1]# vim tasks_12.yml </span><br><span class="line">- hosts: webserver</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">    - name: Installed Nginx Server</span><br><span class="line">      yum: name=nginx state=present</span><br><span class="line"></span><br><span class="line">    - name: Configure Nginx Server</span><br><span class="line">      copy: src=./nginx.conf.j2 dest=/etc/nginx/nginx.conf</span><br><span class="line">      notify: Restart Nginx Server</span><br><span class="line"></span><br><span class="line">    - name: Check Nginx Configure Status</span><br><span class="line">      command: /usr/sbin/nginx -t</span><br><span class="line">      register: check_nginx</span><br><span class="line">      changed_when: </span><br><span class="line">        - ( check_nginx.stdout.find(&#x27;successful&#x27;))</span><br><span class="line">        - false</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">- name: debug</span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">  debug:</span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">    msg: <span class="string">&quot;&#123;&#123; check_nginx &#125;&#125;&quot;</span></span></span><br><span class="line"></span><br><span class="line">    - name: Service Nginx Server</span><br><span class="line">      service: name=nginx state=started</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">    - name: Restart Nginx Server</span><br><span class="line">      service: name=nginx state=restarted</span><br><span class="line">[root@master project1]# ansible-playbook -i hosts tasks_12.yml</span><br></pre></td></tr></table></figure>



<h1 id="1-Ansible-Jinja2模板概述"><a href="#1-Ansible-Jinja2模板概述" class="headerlink" title="1.Ansible Jinja2模板概述"></a>1.Ansible Jinja2模板概述</h1><p><strong>1.什么是jinja2</strong></p>
<p>Jinja2是Python的全功能模板引擎</p>
<p><strong>2.jinja2模板与Ansible有什么关系</strong></p>
<p>Ansible通常会使用Jinja2模板来修改被管理主机的配置文件。例如给10台远程主机都装上httpd服务，但是要求每个服务器的端口不一样，如何解决？</p>
<p><strong>3.Ansible如何使用jinja2模板</strong></p>
<p>使用ansible的jinja2模板，也就是template模块。该模块和copy模块一样，都是将文件复制到远端主机上去，但是区别在于template模块可以获取要复制的文件中变量的值，而copy则是原封不动的把文件内容复制过去。比如：针对不同的主机定义不同的变量，template会在将配置文件分发出去前读取变量到jinja2模板，然后分发到不同的被管理主机上。</p>
<p><strong>Ansible使用jinja注意事项</strong></p>
<p>Ansible允许jinja2模板中使用条件判断和循环，但是jinja判断循环语法不允许在playbook中使用。</p>
<p>注意：不是每个管理员都需要这个特性，但是有些时候jinja2模板能大大提高效率。</p>
<h1 id="2-Ansible-Jinja2基本使用"><a href="#2-Ansible-Jinja2基本使用" class="headerlink" title="2.Ansible Jinja2基本使用"></a>2.Ansible Jinja2基本使用</h1><p><strong>1.jinja模板基本语法</strong></p>
<p>1）要想在配置文件中使用jinj2，playbook中的tasks 必须使用template 模块</p>
<p>2）模板配置文件里面使用变量，比如<code>&#123;&#123; PORT &#125;&#125;</code> 或使用 <code>&#123;&#123; facts 变量 &#125;&#125;</code></p>
<p><strong>2.jinja模板逻辑关系</strong></p>
 作为循环表达式
 作为条件判断
<p> 表示注释</p>
<p>P35 01 老男孩教育4期-Ansible Jinja基本介绍</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">jinja2  了解项</span><br><span class="line">1.jinja2</span><br><span class="line">2.ansible与jinja关系</span><br><span class="line">3.jinja2循环 判断语句</span><br><span class="line"></span><br><span class="line">&#123;% if EXPR %&#125;...&#123;% elif EXPR %&#125;...&#123;% endif%&#125; 作为条件判断</span><br><span class="line">--------------------------------------判断语句</span><br><span class="line">&#123;% if ansible_fqdn == &quot;web01&quot; %&#125;</span><br><span class="line">    echo &quot;123&quot;</span><br><span class="line">&#123;% elif ansible_fqdn == &quot;web02&quot; %&#125;</span><br><span class="line">    echo &quot;456&quot;</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">    echo &quot;789&quot;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% for i in EXPR %&#125;...&#123;% endfor%&#125; 作为循环表达式</span><br><span class="line">&#123;% for i in range(1,10) %&#125;</span><br><span class="line">    server 172.16.1.&#123;&#123;i&#125;&#125;;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">&#123;# COMMENT #&#125; 表示注释</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4.jinja2渲染nginx_proxy配置文件  keepalived配置文件</span><br><span class="line"></span><br><span class="line">实例</span><br><span class="line">[root@master project1]# vim jinja_1.yml</span><br><span class="line">[root@master project1]# cat jinja_1.yml </span><br><span class="line">- hosts: webserver</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Copy Template File /etc/motd</span><br><span class="line">      template: src=./motd.j2 dest=/etc/motd</span><br><span class="line"></span><br><span class="line">[root@master project1]# vim motd.j2</span><br><span class="line">[root@master project1]# cat motd.j2</span><br><span class="line"></span><br><span class="line">Welcome to Alibaba Cloud Elastic Compute Service !</span><br><span class="line"></span><br><span class="line">This System Hostname &#123;&#123; ansible_hostname &#125;&#125;</span><br><span class="line">This System total Memory is: &#123;&#123; ansible_memtotal_mb &#125;&#125; MB</span><br><span class="line">This System free Memory is: &#123;&#123; ansible_memfree_mb &#125;&#125; MB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master project1]# ansible-playbook -i hosts jinja_1.yml</span><br><span class="line">[root@master project1]# ansible webserver -m shell -a &quot;cat /etc/motd&quot; -i hosts</span><br><span class="line">192.168.160.4 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">Welcome to Alibaba Cloud Elastic Compute Service !</span><br><span class="line"></span><br><span class="line">This System Hostname web01</span><br><span class="line">This System total Memory is: 1819 MB</span><br><span class="line">This System free Memory is: 288 MB</span><br></pre></td></tr></table></figure>



<p>P36 02 老男孩教育4期-AnsibleJinja渲染NginxProxy配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">4.jinja2渲染nginx_proxy配置文件  keepalived配置文件</span><br><span class="line">[root@master project1]# vim jinja_2.yml </span><br><span class="line">[root@master project1]# cat jinja_2.yml </span><br><span class="line">- hosts: lbserver</span><br><span class="line">  vars:</span><br><span class="line">    - http_port: 80</span><br><span class="line">    - server_name: kod.oldboy.com</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Installed Nginx Server</span><br><span class="line">      yum: name=nginx state=present</span><br><span class="line"></span><br><span class="line">    - name: Configure Nginx Virt</span><br><span class="line">      template: src=./kod_proxy.conf.j2 dest=/etc/nginx/conf.d/proxy_kod.oldboy.com.conf</span><br><span class="line">      notify: Restart Nginx Server</span><br><span class="line"></span><br><span class="line">    - name: Started Nginx Server</span><br><span class="line">      service: name=nginx state=started enabled=yes</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">    - name: Restart Nginx Server</span><br><span class="line">      service: name=nginx state=restarted</span><br><span class="line"></span><br><span class="line">[root@master project1]# vim ./kod_proxy.conf.j2</span><br><span class="line">upstream &#123;&#123; server_name &#125;&#125; &#123;</span><br><span class="line">&#123;% for i in range(1,10) %&#125;</span><br><span class="line">    server 192.168.160.&#123;&#123;i&#125;&#125;:&#123;&#123; http_port &#125;&#125; weight=2;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen &#123;&#123; http_port &#125;&#125;;</span><br><span class="line">        server_name &#123;&#123; server_name &#125;&#125;;</span><br><span class="line">        location / &#123;</span><br><span class="line">                proxy_pass http://&#123;&#123; server_name &#125;&#125;;</span><br><span class="line">                #include proxy_params;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>P37 03 老男孩教育4期-AnsibleJinja渲染Keepalived配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">-------------------------------------keepalived</span><br><span class="line">1) Inventory中的host_vars根据不同主机设定不同的变量。</span><br><span class="line">[root@master project1]# cat host_vars/192.168.160.4</span><br><span class="line">state: MASTER</span><br><span class="line">prioroty: 150</span><br><span class="line">[root@master project1]# cat host_vars/192.168.160.5</span><br><span class="line">state: BACKUP</span><br><span class="line">prioroty: 100</span><br><span class="line"></span><br><span class="line">2) 准备keeplaived配置文件</span><br><span class="line">[root@master project1]# vim keepalived.conf.j2</span><br><span class="line">[root@master project1]# cat keepalived.conf.j2 </span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id &#123;&#123; ansible_fqdn &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state &#123;&#123; state &#125;&#125;</span><br><span class="line">    priority &#123;&#123; prioroty &#125;&#125;</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 50</span><br><span class="line">    priority 150</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">&#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.3</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">3) 使用playbook分发配置文件</span><br><span class="line">[root@master project1]# cat jinja_3.yml </span><br><span class="line">- hosts: lbserver</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">    - name: Copy Keepalived</span><br><span class="line">      template: src=./keepalived.conf.j2 dest=/tmp/keepalived.conf</span><br><span class="line"></span><br><span class="line">[root@master project1]# ansible-playbook -i hosts jinja_3.yml</span><br><span class="line">[root@master project1]# ansible -i hosts lbserver -m shell -a &quot;cat /tmp/keepalived.conf&quot;</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">2) 在Playbook中是when判断主机名称，然后分发不同的配置文件。</span><br><span class="line">[root@master project1]# cp keepalived.conf.j2  keepalived-master.conf</span><br><span class="line">[root@master project1]# cp keepalived.conf.j2  keepalived-slave.conf</span><br><span class="line">[root@master project1]# cat keepalived-master.conf </span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id &#123;&#123; ansible_fqdn &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    priority 150</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 50</span><br><span class="line">    priority 150</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">&#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.3</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@master project1]# cat keepalived-slave.conf </span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id &#123;&#123; ansible_fqdn &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    priority 100</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 50</span><br><span class="line">    priority 150</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">&#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.3</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@master project1]# cp jinja_3.yml jinja_4.yml</span><br><span class="line">[root@master project1]# cat jinja_4.yml </span><br><span class="line">- hosts: lbserver</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">    - name: Copy Keepalived Master</span><br><span class="line">      template: src=./keepalived-master.conf dest=/tmp/keepalived.conf</span><br><span class="line">      when: ( ansible_fqdn == &quot;lb01&quot; )</span><br><span class="line"></span><br><span class="line">    - name: Copy Keepalived Slave</span><br><span class="line">      template: src=./keepalived-slave.conf dest=/tmp/keepalived.conf</span><br><span class="line">      when: ( ansible_fqdn == &quot;lb02&quot; )</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3）使用jinja2的方式渲染出不同的配置文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">-------------------------------jinja实现</span><br><span class="line">[root@master project1]# cat keepalived.conf.j2 </span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id &#123;&#123; ansible_fqdn &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">&#123;% if ansible_fqdn == &quot;lb01&quot; %&#125;</span><br><span class="line">    state MASTER</span><br><span class="line">    priority 150</span><br><span class="line">&#123;% elif ansible_fqdn == &quot;lb02&quot; %&#125;</span><br><span class="line">    state BACKUP</span><br><span class="line">    priority 100</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##-----------------相同点</span></span></span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 50</span><br><span class="line">    priority 150</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">&#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.3</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@master project1]# ansible-playbook -i hosts jinja_3.yml</span><br></pre></td></tr></table></figure>



<p>P38 04 老男孩教育4期-AnsibleRoles基本介绍</p>
<h2 id="2-Ansible-Roles目录结构"><a href="#2-Ansible-Roles目录结构" class="headerlink" title="2.Ansible Roles目录结构"></a>2.Ansible Roles目录结构</h2><p>roles官方目录结构，必须按如下定义。在每个目录中必须有main.yml文件，这些属于强制要求。不解释！</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master project1]#  cd /etc/ansible/roles</span><br><span class="line">[root@master roles]# mkdir &#123;nfs,rsync,web&#125;/&#123;vars,tasks,templates,handlers,files,meta&#125; -p</span><br><span class="line">[root@master roles]# tree</span><br><span class="line">.</span><br><span class="line">├── nfs    #角色名称</span><br><span class="line">│   ├── files    #存放文件</span><br><span class="line">│   ├── handlers    #触发任务</span><br><span class="line">│   ├── tasks    #具体任务</span><br><span class="line">│   ├── templates    #模板文件</span><br><span class="line">│   ├── vars    #定义变量</span><br><span class="line">│   └── meta    #依赖关系</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">roles</span><br><span class="line">Roles基于一个已知的文件结构 tasks handlers templates .....</span><br><span class="line"></span><br><span class="line">Roles小技巧：</span><br><span class="line">1.创建roles目录结构,手动或使用ansible-galaxy init test roles</span><br><span class="line">2.编写roles的功能，也就是tasks。</span><br><span class="line">3.最后playbook引用roles编写好的tasks。</span><br><span class="line"></span><br><span class="line">[root@master ~]# mkdir project2</span><br><span class="line">[root@master ~]# cd project2/</span><br><span class="line">[root@master project2]# ansible-galaxy init test  #初始化一个目录</span><br><span class="line">[root@master project2]# tree test</span><br><span class="line">[root@master project2]# rm -rf test/</span><br><span class="line">[root@master project2]# mkdir memcached/&#123;tasks,handlers,templates,vars,files&#125; -pv</span><br><span class="line"></span><br><span class="line">[root@master project1]# find ./ -type f -name &quot;memcached*&quot;</span><br><span class="line">./docs1/memcached.j2</span><br><span class="line">[root@master project1]# cp ./docs1/memcached.j2 /root/project2/memcached/templates/</span><br><span class="line">[root@master project1]# cat /root/project2/memcached/templates/memcached.j2</span><br><span class="line">PORT=&quot;11211&quot;</span><br><span class="line">USER=&quot;memcached&quot;</span><br><span class="line">MAXCONN=&quot;1024&quot;</span><br><span class="line">CACHESIZE=&quot;&#123;&#123; ansible_memtotal_mb //2 &#125;&#125;&quot;</span><br><span class="line">OPTIONS=&quot;&quot;</span><br><span class="line">[root@master project2]# vim memcached/tasks/main.yml</span><br><span class="line">[root@master project2]# cat memcached/tasks/main.yml</span><br><span class="line">- name: Installed Memcached Server</span><br><span class="line">  yum: name=memcached state=present</span><br><span class="line"></span><br><span class="line">- name: Configure Memcached Server</span><br><span class="line">  template: src=memcached.j2 dest=/etc/sysconfig/memcached</span><br><span class="line">  notify: Restart Memcached Server</span><br><span class="line"></span><br><span class="line">- name: Started Memcached Server</span><br><span class="line">  service: name=memcached state=started enabled=yes</span><br><span class="line">  </span><br><span class="line">[root@master project2]# vim memcached/handlers/main.yml</span><br><span class="line">[root@master project2]# cat memcached/handlers/main.yml</span><br><span class="line">- name: Restart Memcached Server</span><br><span class="line">  service: name=memcached state=restarted</span><br><span class="line"></span><br><span class="line">[root@master project2]# tree memcached/</span><br><span class="line">memcached/</span><br><span class="line">├── files</span><br><span class="line">├── handlers</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── tasks</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── templates</span><br><span class="line">│   └── memcached.j2</span><br><span class="line">└── vars</span><br><span class="line"></span><br><span class="line">[root@master project2]# vim site.yml</span><br><span class="line">[root@master project2]# cat site.yml </span><br><span class="line">- hosts: webserver</span><br><span class="line">  roles:</span><br><span class="line">    - memcached</span><br><span class="line">[root@master project2]# cp /root/project1/hosts ./</span><br><span class="line">[root@master project2]# ansible-playbook -i hosts site.yml</span><br><span class="line"></span><br><span class="line">---------------------------------------------</span><br><span class="line">[root@master project2]# cd memcached/tasks/</span><br><span class="line">[root@master tasks]# vim install.yml</span><br><span class="line">- name: Installed Memcached Server</span><br><span class="line">  yum: name=memcached state=present</span><br><span class="line"></span><br><span class="line">[root@master tasks]# vim config.yml</span><br><span class="line">- name: Configure Memcached Server</span><br><span class="line">  template: src=memcached.j2 dest=/etc/sysconfig/memcached</span><br><span class="line">  notify: Restart Memcached Server</span><br><span class="line"></span><br><span class="line">[root@master tasks]# vim start.yml</span><br><span class="line">- name: Started Memcached Server</span><br><span class="line">  service: name=memcached state=started enabled=yes</span><br><span class="line">  </span><br><span class="line">[root@master tasks]# vim main.yml </span><br><span class="line">- include_tasks: install.yml</span><br><span class="line">- include_tasks: config.yml</span><br><span class="line">- include_tasks: start.yml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">- name: Installed Memcached Server</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> yum: name=memcached state=present</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#- name: Configure Memcached Server</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> template: src=memcached.j2 dest=/etc/sysconfig/memcached</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> notify: Restart Memcached Server</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#- name: Started Memcached Server</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> service: name=memcached state=started enabled=<span class="built_in">yes</span></span></span><br><span class="line"></span><br><span class="line">[root@master project2]# tree memcached/</span><br><span class="line">memcached/</span><br><span class="line">├── files</span><br><span class="line">├── handlers</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── tasks</span><br><span class="line">│   ├── config.yml</span><br><span class="line">│   ├── install.yml</span><br><span class="line">│   ├── main.yml</span><br><span class="line">│   └── start.yml</span><br><span class="line">├── templates</span><br><span class="line">│   └── memcached.j2</span><br><span class="line">└── vars</span><br><span class="line"></span><br><span class="line">[root@master project2]# ansible-playbook -i hosts site.yml</span><br></pre></td></tr></table></figure>



<p>P39 05 老男孩教育4期-AnsibleRoles编写Nginx+PHP</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">[root@master project2]# mkdir &#123;nginx,php-fpm&#125;/&#123;tasks,handlers,templates&#125; -pv</span><br><span class="line">[root@master project2]# ll</span><br><span class="line">-rw-r--r--. 1 root root 52 7月  22 09:40 hosts</span><br><span class="line">drwxr-xr-x. 5 root root 52 7月  22 10:01 nginx</span><br><span class="line">drwxr-xr-x. 5 root root 52 7月  22 10:01 php-fpm</span><br><span class="line">[root@master project2]# vim nginx/tasks/main.yml</span><br><span class="line">- name: Installed Nginx Server</span><br><span class="line">  yum: name=nginx state=present</span><br><span class="line"></span><br><span class="line">- name: Configure Nginx Server</span><br><span class="line">  template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf</span><br><span class="line">  notify: Restart Nginx Server</span><br><span class="line"></span><br><span class="line">- name: Started Nginx Server</span><br><span class="line">  service: name=nginx state=started enabled=yes</span><br><span class="line">[root@master project2]# vim nginx/handlers/main.yml</span><br><span class="line">- name: Restart Nginx Server</span><br><span class="line">  service: name=nginx state=restarted</span><br><span class="line"></span><br><span class="line">[root@master project2]# vim nginx/templates/nginx.conf.j2</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[root@master project2]# vim site.yml </span><br><span class="line">[root@master project2]# cat site.yml </span><br><span class="line">- hosts: webserver</span><br><span class="line">  roles:</span><br><span class="line">    - memcached</span><br><span class="line">    - nginx</span><br><span class="line">[root@master project2]# ansible-playbook -i hosts site.yml</span><br><span class="line"></span><br><span class="line">[root@master project2]# vim site.yml </span><br><span class="line">- hosts: webserver</span><br><span class="line">  roles:</span><br><span class="line">    - memcached</span><br><span class="line">    - role: nginx</span><br><span class="line">      tags: nginx</span><br><span class="line">[root@master project2]# ansible-playbook -i hosts site.yml -t nginx</span><br><span class="line">[root@master project2]# vim site.yml </span><br><span class="line">- hosts: webserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: memcached</span><br><span class="line">    - role: nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master project2]# vim php-fpm/tasks/main.yml</span><br><span class="line">- name: Installed PHP-FPM Server</span><br><span class="line">  yum: name=&#123;&#123; packages &#125;&#125; state=present</span><br><span class="line">  vars:</span><br><span class="line">    packages:</span><br><span class="line">      - php</span><br><span class="line">      - php-cli</span><br><span class="line">      - php-fpm</span><br><span class="line">      - php-pdo</span><br><span class="line">      - php-gd</span><br><span class="line">      - php-mbstring</span><br><span class="line"></span><br><span class="line">- name: Configure PHP-FPM Server</span><br><span class="line">  template: src=&#123;&#123; items.src &#125;&#125; dest=&#123;&#123; items.dest &#125;&#125;</span><br><span class="line">  with_items:</span><br><span class="line">    - &#123; src: &#x27;php.ini.j2&#x27;,dest: &#x27;/etc/php.ini&#x27; &#125;</span><br><span class="line">    - &#123; src: &#x27;php_www.conf.j2&#x27;,dest: &#x27;/etc/php-fpm.d/www.conf&#x27; &#125;</span><br><span class="line">    </span><br><span class="line">[root@master docs1]# cp php.ini.j2 /root/project2/php-fpm/templates/</span><br><span class="line">[root@master docs1]# cp php_www.conf.j2 /root/project2/php-fpm/templates/</span><br><span class="line">[root@master project2]# vim php-fpm/tasks/main.yml</span><br><span class="line">- name: Installed PHP-FPM Server</span><br><span class="line">  yum: name=&#123;&#123; packages &#125;&#125; state=present</span><br><span class="line">  vars:</span><br><span class="line">    packages:</span><br><span class="line">      - php</span><br><span class="line">      - php-cli</span><br><span class="line">      - php-fpm</span><br><span class="line">      - php-pdo</span><br><span class="line">      - php-gd</span><br><span class="line">      - php-mbstring</span><br><span class="line"></span><br><span class="line">- name: Configure PHP-FPM Server</span><br><span class="line">  template: src=php.ini.j2 dest=/etc/php.ini</span><br><span class="line">  with_items:</span><br><span class="line">    - &#123; src: &#x27;php.ini.j2&#x27;,dest: &#x27;/etc/php.ini&#x27; &#125;</span><br><span class="line">    - &#123; src: &#x27;php_www.conf.j2&#x27;,dest: &#x27;/etc/php-fpm.d/www.conf&#x27; &#125;</span><br><span class="line">  notify: Restart PHP-FPM Server</span><br><span class="line"></span><br><span class="line">- name: Started PHP-FPM Server</span><br><span class="line">  service: name=php-fpm state=started enabled=yes</span><br><span class="line"></span><br><span class="line">[root@master project2]# cat php-fpm/handlers/main.yml</span><br><span class="line">- name: Restart PHP-FPM Server</span><br><span class="line">  service: name=php-fpm state=restarted</span><br><span class="line"></span><br><span class="line">[root@master project2]# vim site.yml </span><br><span class="line">- hosts: webserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: memcached</span><br><span class="line">    - role: nginx</span><br><span class="line">    - role: php-fpm</span><br><span class="line"></span><br><span class="line">[root@master project2]# mkdir group_vars</span><br><span class="line">[root@master project2]# vim group_vars/all</span><br><span class="line">web_user: www</span><br><span class="line">php_ini_max_upload: 200M</span><br><span class="line">[root@master project2]# ansible-playbook -i hosts site.yml</span><br><span class="line"></span><br><span class="line">作业：</span><br><span class="line">  1.使用roles编写nginx负载均衡的配置文件(jinja) + keepalived高可用(jinja2）</span><br><span class="line">  2.使用roles编写nginx+php实现kod正常运行</span><br><span class="line">  3.解析kod.oldboy.com 10.0.0.3 能正常打开可道云</span><br><span class="line">  4.测试keeplaived高可用</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@master project2]# vim nginx/templates/nginx.conf.j2</span><br><span class="line">user www;</span><br><span class="line">worker_processes 1;</span><br><span class="line">error_log /var/log/nginx/error.log warn;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 40960;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    #include /etc/nginx/mime.types;</span><br><span class="line">    #default_type application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 4096;</span><br><span class="line">    gzip on;</span><br><span class="line"></span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        listen       [::]:80;</span><br><span class="line">        server_name  _;</span><br><span class="line">        root         /usr/share/nginx/html;</span><br><span class="line"></span><br><span class="line">        # Load configuration files for the default server block.</span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line"></span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">        location = /404.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>P40 06 老男孩教育4期-AnsibleGalaxy</p>
<h2 id="5-Ansible-Galaxy"><a href="#5-Ansible-Galaxy" class="headerlink" title="5.Ansible Galaxy"></a>5.Ansible Galaxy</h2><p>Galaxy是一个免费网站，类似于github网站，网站上基本都是共享的roles角色。从Galaxy 下载roles角色是快速启动自动化项目方式之一。<a target="_blank" rel="noopener" href="https://galaxy.ansible.com/">galaxy官网</a></p>
<p>Ansible提供了ansible-galaxy命令行工具，可以使用init(初始化)、search(查找)、install(安装)、remove(移除)等操作。</p>
<p>1.如何使用ansible-galaxy搜索一个项目。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载目录</span></span><br><span class="line">/root/.ansible/roles</span><br></pre></td></tr></table></figure>





<p>P41 01 老男孩教育4期-Ansible项目实战-项目介绍与基础环境</p>
<p>1.基础环境：</p>
<ol>
<li><p>关闭防火墙 Firewalld Selinux</p>
</li>
<li><p>添加base epel仓库</p>
</li>
<li><p>特定主机需要添加特定的仓库源  nginx php mysql zabbix elk …..</p>
</li>
</ol>
<p>4）安装基础软件包  rsync nfs-utils net-tools lrzsz wget unzip vim tree…..</p>
<p>5）创建统一用户www，uid为666 gid为666</p>
<p>6）内核升级\内核参数调整\文件描述符调整</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cd /opt/</span><br><span class="line">[root@master opt]# mkdir roles</span><br><span class="line">[root@master opt]# cd roles/</span><br><span class="line">[root@master roles]# vim hosts</span><br><span class="line">[lbserver]</span><br><span class="line">192.168.160.4</span><br><span class="line"></span><br><span class="line">[webserver]</span><br><span class="line">192.168.160.5</span><br><span class="line"></span><br><span class="line">[nfsserver]</span><br><span class="line">192.168.160.6</span><br><span class="line"></span><br><span class="line">[dbserver]</span><br><span class="line">192.168.160.7</span><br><span class="line"></span><br><span class="line">[root@master roles]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.160.6</span><br><span class="line">[root@master roles]# ansible all -i hosts -m ping</span><br><span class="line">[root@master roles]# cp /etc/ansible/ansible.cfg ./</span><br><span class="line">[root@master roles]# mkdir host_vars</span><br><span class="line">[root@master roles]# mkdir group_vars</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一个项目必须有的文件</span></span><br><span class="line">[root@master roles]# ll</span><br><span class="line">总用量 24</span><br><span class="line">-rw-r--r--. 1 root root 19984 7月  22 14:15 ansible.cfg</span><br><span class="line">drwxr-xr-x. 2 root root     6 7月  22 14:17 group_vars</span><br><span class="line">-rw-r--r--. 1 root root   105 7月  22 14:15 hosts</span><br><span class="line">drwxr-xr-x. 2 root root     6 7月  22 14:17 host_vars</span><br><span class="line">[root@master roles]# mkdir base/&#123;tasks,handlers,templates,vars,files&#125; -p</span><br><span class="line">[root@master roles]# vim group_vars/all</span><br><span class="line">web_user: www</span><br><span class="line">web_user_id: 666</span><br><span class="line">[root@master roles]# vim base/tasks/main.yml</span><br><span class="line">[root@master roles]# cat base/tasks/main.yml </span><br><span class="line">- name: Disabled Firewalld Server</span><br><span class="line">  service: name=firewalld state=stopped enabled=no</span><br><span class="line"></span><br><span class="line">- name: Disabled Selinux Server</span><br><span class="line">  selinux: state=disabled</span><br><span class="line"></span><br><span class="line">- name: Create Web &#123;&#123; web_user &#125;&#125; &#123;&#123; web_user_id &#125;&#125; Group</span><br><span class="line">  group: name=&#123;&#123; web_user &#125;&#125; gid=&#123;&#123; web_user_id &#125;&#125;</span><br><span class="line"></span><br><span class="line">- name: Create Web &#123;&#123; web_user &#125;&#125; &#123;&#123; web_user_id &#125;&#125; User</span><br><span class="line">  user: name=&#123;&#123; web_user &#125;&#125; uid=&#123;&#123; web_user_id &#125;&#125; group=&#123;&#123; web_user &#125;&#125;</span><br><span class="line"></span><br><span class="line">- name: Add Base Yum Repository</span><br><span class="line">  yum_repository:</span><br><span class="line">    name: base</span><br><span class="line">    description: Base Aliyun Repository</span><br><span class="line">    baseurl: http://mirrors.aliyun.com/centos/$releaserver/os/$basearch/</span><br><span class="line">    gpgcheck: yes</span><br><span class="line">    gpgkey: http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7</span><br><span class="line"></span><br><span class="line">- name: Add Epel Yum Repository</span><br><span class="line">  yum_repository:</span><br><span class="line">    name: epel</span><br><span class="line">    description: Epel Aliyun Repository</span><br><span class="line">    baseurl: http://mirrors.aliyun.com/centos/epel/7/$basearch</span><br><span class="line">    gpgcheck: no</span><br><span class="line"></span><br><span class="line">- name: Add Nginx Yum Repository</span><br><span class="line">  yum_repository:</span><br><span class="line">    name: nginx</span><br><span class="line">    description: Nginx Repository</span><br><span class="line">    baseurl: http://nginx.org/packages/centos/7/$basearch/</span><br><span class="line">    gpgcheck: no</span><br><span class="line">  when: ( ansible_hostname is match(&#x27;web*&#x27;)) or</span><br><span class="line">        ( ansible_hostname is match(&#x27;lb*&#x27;))</span><br><span class="line"></span><br><span class="line">- name: Add PHP Yum Repository</span><br><span class="line">  yum_repository:</span><br><span class="line">    name: php71w</span><br><span class="line">    description: php Repository</span><br><span class="line">    baseurl: http://us-east.repo.webtatic.com/yum/el7/x86_64/</span><br><span class="line">    gpgcheck: no</span><br><span class="line">  when: ( ansible_hostname is match(&#x27;web*&#x27;))</span><br><span class="line"></span><br><span class="line">- name: Installed Packages All</span><br><span class="line">  yum: name=&#123;&#123; packages &#125;&#125; state=present</span><br><span class="line">  vars:</span><br><span class="line">    packages:</span><br><span class="line">      - rsync</span><br><span class="line">      - nfs-utils</span><br><span class="line">      - net-tools</span><br><span class="line">      - wget</span><br><span class="line">      - tree</span><br><span class="line">      - lrzsz</span><br><span class="line">      - vim</span><br><span class="line">      - unzip</span><br><span class="line">      - httpd-tools</span><br><span class="line">      - bash-completion</span><br><span class="line">      - iftop</span><br><span class="line">      - iotop</span><br><span class="line">      - glances</span><br><span class="line"></span><br><span class="line">[root@master roles]# ulimit -n</span><br><span class="line">1024</span><br><span class="line">[root@master roles]# ansible localhost -m pam_limits -a &quot;domain=* limit_type=soft limit_item=nofile value=100000&quot;</span><br><span class="line">[root@master roles]# cat /etc/security/limits.conf</span><br><span class="line">*	soft	nofile	100000</span><br><span class="line">[root@master roles]# ansible localhost -m pam_limits -a &quot;domain=* limit_type=hard limit_item=nofile value=100000&quot;</span><br><span class="line">[root@master roles]# cat /etc/security/limits.conf</span><br><span class="line">*	soft	nofile	100000</span><br><span class="line">*	hard	nofile	100000</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">断开SSH重连</span></span><br><span class="line">[root@master ~]# ulimit -n</span><br><span class="line">100000</span><br><span class="line"></span><br><span class="line">[root@master roles]# vim base/tasks/main.yml </span><br><span class="line">[root@master roles]# cat base/tasks/main.yml</span><br><span class="line">- name: Disabled Firewalld Server</span><br><span class="line">  service: name=firewalld state=stopped enabled=no</span><br><span class="line"></span><br><span class="line">- name: Disabled Selinux Server</span><br><span class="line">  selinux: state=disabled</span><br><span class="line"></span><br><span class="line">- name: Create Web &#123;&#123; web_user &#125;&#125; &#123;&#123; web_user_id &#125;&#125; Group</span><br><span class="line">  group: name=&#123;&#123; web_user &#125;&#125; gid=&#123;&#123; web_user_id &#125;&#125;</span><br><span class="line"></span><br><span class="line">- name: Create Web &#123;&#123; web_user &#125;&#125; &#123;&#123; web_user_id &#125;&#125; User</span><br><span class="line">  user: name=&#123;&#123; web_user &#125;&#125; uid=&#123;&#123; web_user_id &#125;&#125; group=&#123;&#123; web_user &#125;&#125;</span><br><span class="line"></span><br><span class="line">- name: Add Base Yum Repository</span><br><span class="line">  yum_repository:</span><br><span class="line">    name: base</span><br><span class="line">    description: Base Aliyun Repository</span><br><span class="line">    baseurl: http://mirrors.aliyun.com/centos/$releaserver/os/$basearch/</span><br><span class="line">    gpgcheck: yes</span><br><span class="line">    gpgkey: http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-7</span><br><span class="line"></span><br><span class="line">- name: Add Epel Yum Repository</span><br><span class="line">  yum_repository:</span><br><span class="line">    name: epel</span><br><span class="line">    description: Epel Aliyun Repository</span><br><span class="line">    baseurl: http://mirrors.aliyun.com/centos/epel/7/$basearch</span><br><span class="line">    gpgcheck: no</span><br><span class="line"></span><br><span class="line">- name: Add Nginx Yum Repository</span><br><span class="line">  yum_repository:</span><br><span class="line">    name: nginx</span><br><span class="line">    description: Nginx Repository</span><br><span class="line">    baseurl: http://nginx.org/packages/centos/7/$basearch/</span><br><span class="line">    gpgcheck: no</span><br><span class="line">  when: ( ansible_hostname is match(&#x27;web*&#x27;)) or</span><br><span class="line">        ( ansible_hostname is match(&#x27;lb*&#x27;))</span><br><span class="line"></span><br><span class="line">- name: Add PHP Yum Repository</span><br><span class="line">  yum_repository:</span><br><span class="line">    name: php71w</span><br><span class="line">    description: php Repository</span><br><span class="line">    baseurl: http://us-east.repo.webtatic.com/yum/el7/x86_64/</span><br><span class="line">    gpgcheck: no</span><br><span class="line">  when: ( ansible_hostname is match(&#x27;web*&#x27;))</span><br><span class="line"></span><br><span class="line">- name: Installed Packages All</span><br><span class="line">  yum: name=&#123;&#123; packages &#125;&#125; state=present</span><br><span class="line">  vars:</span><br><span class="line">    packages:</span><br><span class="line">      - rsync</span><br><span class="line">      - nfs-utils</span><br><span class="line">      - net-tools</span><br><span class="line">      - wget</span><br><span class="line">      - tree</span><br><span class="line">      - lrzsz</span><br><span class="line">      - vim</span><br><span class="line">      - unzip</span><br><span class="line">      - httpd-tools</span><br><span class="line">      - bash-completion</span><br><span class="line">      - iftop</span><br><span class="line">      - iotop</span><br><span class="line">      - glances</span><br><span class="line"></span><br><span class="line">- name: Change Limit /etc/security/limit.conf</span><br><span class="line">  pam_limits:</span><br><span class="line">    domain: &quot;*&quot;</span><br><span class="line">    limit_type: &quot;&#123;&#123; item.limit_type &#125;&#125;&quot;</span><br><span class="line">    limit_item: &quot;&#123;&#123; item.limit_item &#125;&#125;&quot;</span><br><span class="line">    value: &quot;&#123;&#123; item.value &#125;&#125;&quot;</span><br><span class="line">  with_items:</span><br><span class="line">    - &#123; limit_type: &#x27;soft&#x27;, limit_item: &#x27;nofile&#x27;,value: &#x27;100000&#x27; &#125;</span><br><span class="line">    - &#123; limit_type: &#x27;soft&#x27;, limit_item: &#x27;nofile&#x27;,value: &#x27;100000&#x27; &#125;</span><br><span class="line"></span><br><span class="line">[root@master roles]# vim site.yml</span><br><span class="line">[root@master roles]# cat site.yml </span><br><span class="line">- hosts: all</span><br><span class="line">  roles:</span><br><span class="line">    - role: base</span><br><span class="line"></span><br><span class="line">[root@master roles]# ansible-playbook -i hosts site.yml </span><br></pre></td></tr></table></figure>


<p>P42 02 老男孩教育4期-Ansible项目实战-编写Nginx服务模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Nginx基础模块</span></span><br><span class="line">[root@master roles]# mkdir nginx/&#123;tasks,handlers,templates&#125; -p</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">基础任务</span></span><br><span class="line">[root@master roles]# vim nginx/tasks/main.yml</span><br><span class="line">- name: Installed Nginx Server</span><br><span class="line">  yum: name=nginx state=present</span><br><span class="line"></span><br><span class="line">- name: Configure Nginx Server</span><br><span class="line">  template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf</span><br><span class="line">  notify: Restart Nginx Server</span><br><span class="line"></span><br><span class="line">- name: Started Nginx Server</span><br><span class="line">  service: name=nginx state=started</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">触发器</span></span><br><span class="line">[root@master roles]# vim nginx/handlers/main.yml</span><br><span class="line">- name: Restart Nginx Server</span><br><span class="line">  service: name=nginx state=restarted</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nginx的模板配置文件</span></span><br><span class="line">[root@master roles]# vim nginx/templates/nginx.conf.j2</span><br><span class="line">user &#123;&#123; web_user &#125;&#125;;</span><br><span class="line">worker_processes &#123;&#123; ansible_processor_cores &#125;&#125;;</span><br><span class="line">error_log /var/log/nginx/error.log warn;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections &#123;&#123; ansible_processor_cores * 2048 &#125;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    #include /etc/nginx/mime.types;</span><br><span class="line">    #default_type application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 4096;</span><br><span class="line">    gzip on;</span><br><span class="line"></span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        listen       [::]:80;</span><br><span class="line">        server_name  _;</span><br><span class="line">        root         /usr/share/nginx/html;</span><br><span class="line"></span><br><span class="line">        # Load configuration files for the default server block.</span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line"></span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">        location = /404.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@master roles]# vim site.yml </span><br><span class="line">- hosts: all</span><br><span class="line">  roles:</span><br><span class="line">    - role: base</span><br><span class="line"></span><br><span class="line">- hosts: webserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: nginx</span><br><span class="line">      tags: nginx</span><br><span class="line">      </span><br><span class="line">[root@master roles]# ansible-playbook -i hosts site.yml -t nginx</span><br></pre></td></tr></table></figure>



<p>P43 03 老男孩教育4期-Ansible项目实战-编写NFS服务模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">NFS基础模块</span></span><br><span class="line">[root@master roles]# mkdir nfs/&#123;tasks,handlers,templates&#125; -p</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">基础任务</span></span><br><span class="line">[root@master roles]# vim nfs/tasks/main.yml </span><br><span class="line">- name: Install NFS Server</span><br><span class="line">  yum: name=nfs-utils state=present</span><br><span class="line"></span><br><span class="line">- name: Configure NFS Server</span><br><span class="line">  template: src=exports.j2 dest=/etc/exports</span><br><span class="line">  notify: Restart NFS Server</span><br><span class="line"></span><br><span class="line">- name: Create NFS Server Share Directory</span><br><span class="line">  file: path=&#123;&#123; nfs_dir &#125;&#125; state=directory owner=&#123;&#123; web_user &#125;&#125; group=&#123;&#123; web_user &#125;&#125;</span><br><span class="line"></span><br><span class="line">- name: Started NFS Server</span><br><span class="line">  service: name=nfs state=started enabled=yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">触发器</span></span><br><span class="line">[root@master roles]# vim nfs/handlers/main.yml</span><br><span class="line">- name: Restart NFS Server</span><br><span class="line">  service: name=nfs state=restarted</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">模板配置文件</span></span><br><span class="line">[root@master roles]# vim nfs/templates/exports.j2</span><br><span class="line">&#123;&#123; nfs_dir&#125;&#125; &#123;&#123; nfs_share_ip &#125;&#125;(rw,sync,all_squash,anonuid=&#123;&#123; web_user_id &#125;&#125;,anongid=&#123;&#123; web_user_id &#125;&#125;)</span><br><span class="line"></span><br><span class="line">[root@master roles]# vim group_vars/all </span><br><span class="line">web_user: www</span><br><span class="line">web_user_id: 666</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">nfs</span></span><br><span class="line">nfs_dir: /data</span><br><span class="line">nfs_share_ip: 192.168.160.0/24</span><br><span class="line"></span><br><span class="line">[root@master roles]# cat site.yml </span><br><span class="line">- hosts: all</span><br><span class="line">  roles:</span><br><span class="line">    - role: base</span><br><span class="line"></span><br><span class="line">- hosts: webserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: nginx</span><br><span class="line"></span><br><span class="line">- hosts: nfsserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: nfs</span><br><span class="line">      tags: nfs</span><br></pre></td></tr></table></figure>



<p>P44 04 老男孩教育4期-Ansible项目实战-编写Redis服务模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Redis基础模块</span></span><br><span class="line">[root@master roles]# mkdir redis/&#123;tasks,handlers,templates&#125; -p</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">基础任务</span></span><br><span class="line">[root@master roles]# vim redis/tasks/main.yml</span><br><span class="line">- name: Install Redis Server</span><br><span class="line">  yum: name=redis state=present</span><br><span class="line"></span><br><span class="line">- name: Configure Redis Server</span><br><span class="line">  template: src=redis.conf.j2 dest=/etc/redis.conf</span><br><span class="line">  notify: Restart Redis Server</span><br><span class="line"></span><br><span class="line">- name: Started Redis Server</span><br><span class="line">  service: name=redis state=started enabled=yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">触发器</span></span><br><span class="line">[root@master roles]# vim redis/handlers/main.yml</span><br><span class="line">- name: Restart Redis Server</span><br><span class="line">  service: name=redis state=restarted</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">redis模板配置文件(注意修改<span class="built_in">bind</span>,其他略)</span></span><br><span class="line">[root@db01 ~]# grep &quot;^[a-Z]&quot; /etc/redis.conf</span><br><span class="line">bind 127.0.0.1 &#123;&#123; ansible_eth0.ipv4.address &#125;&#125;</span><br><span class="line">[root@db01 ~]# scp /etc/redis.conf root@192.168.160.3:/opt/roles/redis/templates/redis.conf.j2</span><br><span class="line">[root@master roles]# vim redis/templates/redis.conf.j2</span><br><span class="line">bind 127.0.0.1 &#123;&#123; ansible_eth0.ipv4.address &#125;&#125;</span><br><span class="line"></span><br><span class="line">[root@master roles]# vim site.yml </span><br><span class="line">- hosts: all</span><br><span class="line">  roles:</span><br><span class="line">    - role: base</span><br><span class="line"></span><br><span class="line">- hosts: webserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: nginx</span><br><span class="line"></span><br><span class="line">- hosts: nfsserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: nfs</span><br><span class="line"></span><br><span class="line">- hosts: dbserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: redis</span><br><span class="line">      tags: redis</span><br><span class="line">      </span><br><span class="line">[root@master roles]# ansible-playbook -i hosts site.yml -t redis</span><br></pre></td></tr></table></figure>



<p>P45 05 老男孩教育4期-Ansible项目实战-编写MySQL服务模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">--------------------------</span><br><span class="line">MySQL基础模块</span><br><span class="line">--------------------------</span><br><span class="line">[root@master roles]# mkdir mysql/&#123;tasks,handlers,templates&#125; -p</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">模板配置文件</span></span><br><span class="line">[root@master roles]# vim mysql/templates/my.cnf.j2</span><br><span class="line">[mysqld]</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">symbolic-links=0</span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line">log-error=/var/log/mariadb/mariadb.log</span><br><span class="line">pid-file=/var/run/mariadb/mariadb.pid</span><br><span class="line"></span><br><span class="line">!includedir /etc/my.cnf.d</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">port=3306</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line">[root@master roles]# vim group_vars/all </span><br><span class="line">web_user: www</span><br><span class="line">web_user_id: 666</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">nfs</span></span><br><span class="line">nfs_dir: /data</span><br><span class="line">nfs_share_ip: 192.168.160.0/24</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">db</span></span><br><span class="line">web_db_user: oldboy</span><br><span class="line">web_db_pass: Bgx123.com</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">基础任务</span></span><br><span class="line">[root@master roles]# vim mysql/tasks/main.yml</span><br><span class="line">[root@master roles]# cat mysql/tasks/main.yml </span><br><span class="line">- name: Install Mriadb Server</span><br><span class="line">  yum: name=&#123;&#123; packages &#125;&#125; state=present</span><br><span class="line">  vars:</span><br><span class="line">    packages:</span><br><span class="line">      - mariadb</span><br><span class="line">      - mariadb-server</span><br><span class="line">      - MySQL-python</span><br><span class="line"></span><br><span class="line">- name: Configure Mariadb Server</span><br><span class="line">  template: src=my.cnf.j2 dest=/etc/my.cnf backup=yes</span><br><span class="line">  notify: Restart Mariadb Server</span><br><span class="line"></span><br><span class="line">- name: Started Mariadb Server</span><br><span class="line">  service: name=mariadb state=started enabled=yes</span><br><span class="line"></span><br><span class="line">- name: Create Application Database</span><br><span class="line">  mysql_db: name=&#123;&#123; item &#125;&#125; state=present</span><br><span class="line">  with_items:</span><br><span class="line">    - wordpress</span><br><span class="line">    - zh</span><br><span class="line">    - phpmyadmin</span><br><span class="line">    - zabbix</span><br><span class="line">    - jpress</span><br><span class="line"></span><br><span class="line">- name: Create Web Remote Application DB User</span><br><span class="line">  mysql_user:</span><br><span class="line">    name: &quot;&#123;&#123; web_db_user &#125;&#125;&quot;</span><br><span class="line">    password: &quot;&#123;&#123; web_db_pass &#125;&#125;&quot;</span><br><span class="line">    priv: &#x27;*.*:ALL&#x27;</span><br><span class="line">    host: &#x27;%&#x27;</span><br><span class="line">    state: present</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">触发器</span></span><br><span class="line">[root@master roles]# vim mysql/handlers/main.yml</span><br><span class="line">- name: Restart Mariadb Server</span><br><span class="line">  service: name=mariadb state=restarted</span><br><span class="line"></span><br><span class="line">[root@master roles]# vim site.yml</span><br><span class="line">- hosts: all</span><br><span class="line">  roles:</span><br><span class="line">    - role: base</span><br><span class="line"></span><br><span class="line">- hosts: webserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: nginx</span><br><span class="line"></span><br><span class="line">- hosts: nfsserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: nfs</span><br><span class="line"></span><br><span class="line">- hosts: dbserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: redis</span><br><span class="line">    - role: mysql</span><br><span class="line">  tags: db</span><br><span class="line"></span><br><span class="line">[root@master roles]# ansible-playbook -i hosts site.yml -t db</span><br></pre></td></tr></table></figure>



<p>P46 06 老男孩教育4期-Ansible项目实战-编写Keepalived服务模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">----------------------------</span><br><span class="line">Keepalived基础模块</span><br><span class="line">----------------------------</span><br><span class="line">[root@master roles]# mkdir keepalived/&#123;tasks,handlers,templates&#125; -p</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">基础任务</span></span><br><span class="line">[root@master roles]# vim keepalived/tasks/main.yml </span><br><span class="line">- name: Install keepalived Server</span><br><span class="line">  yum: name=keepalived state=present</span><br><span class="line"></span><br><span class="line">- name: Configure Keepalived Server</span><br><span class="line">  template: src=keepalived.conf.j2 dest=/etc/keepalived/keepalived.conf</span><br><span class="line">  notify: Restart keepalived Server</span><br><span class="line"></span><br><span class="line">- name: Start Keepalived Server</span><br><span class="line">  service: name=keepalived state=started enabled=yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">触发器</span></span><br><span class="line">[root@master roles]# vim keepalived/handlers/main.yml</span><br><span class="line">- name: Restart keepalived Server</span><br><span class="line">  service: name=keepalived state=restarted</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">模板配置文件</span></span><br><span class="line">[root@master roles]# vim keepalived/templates/keepalived.conf.j2</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id &#123;&#123; ansible_hostname &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">&#123;% if ansible_hostname == &quot;lb01&quot; %&#125;</span><br><span class="line">    state MASTER</span><br><span class="line">    priority 150</span><br><span class="line">&#123;% elif ansible_hostname == &quot;lb02&quot; %&#125;</span><br><span class="line">    state BACKUP</span><br><span class="line">    priority 100</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##-----------------相同点</span></span></span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 50</span><br><span class="line">    priority 150</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">&#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.0.0.3</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@master roles]# vim site.yml </span><br><span class="line">- hosts: all</span><br><span class="line">  roles:</span><br><span class="line">    - role: base</span><br><span class="line"></span><br><span class="line">- hosts: webserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: nginx</span><br><span class="line"></span><br><span class="line">- hosts: nfsserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: nfs</span><br><span class="line"></span><br><span class="line">- hosts: dbserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: redis</span><br><span class="line">    - role: mysql</span><br><span class="line"></span><br><span class="line">- hosts: lbserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: nginx</span><br><span class="line">    - role: keepalived</span><br><span class="line">  tags: lb</span><br><span class="line"></span><br><span class="line">[root@master roles]# ansible-playbook -i hosts site.yml -t lb</span><br></pre></td></tr></table></figure>



<p>P47 07 老男孩教育4期-Ansible项目实战-编写php-fpm服务模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">-------------------------</span><br><span class="line">PHP模块</span><br><span class="line">-------------------------</span><br><span class="line">[root@master roles]# mkdir php-fpm/&#123;tasks,handlers,templates&#125; -p</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">php-fpm基础任务</span></span><br><span class="line">[root@master roles]# vim php-fpm/tasks/main.yml</span><br><span class="line">- name: Remove PHP-FPM Server</span><br><span class="line">  yum: name=&quot;php-*-5*&quot; state=absent</span><br><span class="line"></span><br><span class="line">- name: Installed PHP-FPM Server</span><br><span class="line">  yum: name=&#123;&#123; packages &#125;&#125; state=present</span><br><span class="line">  vars:</span><br><span class="line">    packages:</span><br><span class="line">      - php71w</span><br><span class="line">      - php71w-cli</span><br><span class="line">      - php71w-devel</span><br><span class="line">      - php71w-embedded</span><br><span class="line">      - php71w-gd</span><br><span class="line">      - php71w-mcrypt</span><br><span class="line">      - php71w-mbstring</span><br><span class="line">      - php71w-pdo</span><br><span class="line">      - php71w-xml</span><br><span class="line">      - php71w-fpm</span><br><span class="line">      - php71w-mysqlnd</span><br><span class="line">      - php71w-opcache</span><br><span class="line">      - php71w-pecl-memcached</span><br><span class="line">      - php71w-pecl-redis</span><br><span class="line">      - php71w-pecl-mongodb</span><br><span class="line"></span><br><span class="line">- name: Configure PHP-FPM Server</span><br><span class="line">  template: src=www.conf.j2 dest=/etc/php-fpm.d/www.conf</span><br><span class="line">  notify: Restart PHP-FPM Server</span><br><span class="line"></span><br><span class="line">- name: Configure PHP.INI Server</span><br><span class="line">  template: src=php.ini.j2 dest=/etc/php.ini</span><br><span class="line">  notify: Restart PHP-FPM Server</span><br><span class="line"></span><br><span class="line">- name: Start PHP-FPM Server</span><br><span class="line">  service: name=php-fpm state=started enabled=yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">触发器</span></span><br><span class="line">[root@master roles]# vim php-fpm/handlers/main.yml</span><br><span class="line">- name: Restart PHP-FPM Server</span><br><span class="line">  service: name=php-fpm state=restarted</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拷贝模板php-fpm配置文件</span></span><br><span class="line">[root@web01 ~]# scp /etc/php-fpm.d/www.conf root@192.168.160.3:/opt/roles/php-fpm/templates/www.conf.j2</span><br><span class="line">[root@web01 ~]# scp /etc/php.ini root@192.168.160.3:/opt/roles/php-fpm/templates/php.ini.j2</span><br><span class="line">[root@master roles]# vim php-fpm/templates/www.conf.j2</span><br><span class="line">[www]</span><br><span class="line">listen = 127.0.0.1:9000</span><br><span class="line">listen.allowed_clients = 127.0.0.1</span><br><span class="line">user = &#123;&#123; web_user &#125;&#125;</span><br><span class="line">group = &#123;&#123; web_user &#125;&#125;</span><br><span class="line">pm = dynamic</span><br><span class="line">pm.max_children = 50</span><br><span class="line">pm.start_servers = 20</span><br><span class="line">pm.min_spare_servers = 5</span><br><span class="line">pm.max_spare_servers = 35</span><br><span class="line">slowlog = /var/log/php-fpm/www-slow.log</span><br><span class="line">php_admin_value[error_log] = /var/log/php-fpm/www-error.log</span><br><span class="line">php_admin_flag[log_errors] = on</span><br><span class="line">php_value[session.save_handler] = files</span><br><span class="line">php_value[session.save_path] = /var/lib/php/session</span><br><span class="line"></span><br><span class="line">[root@master roles]# vim php-fpm/templates/php.ini.j2</span><br><span class="line">session.save_handler = redis</span><br><span class="line">session.save_path = &quot;tcp://&#123;&#123; redis_server_ip &#125;&#125;:&#123;&#123; redis_server_port &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">[root@master roles]# vim group_vars/all </span><br><span class="line">web_user: www</span><br><span class="line">web_user_id: 666</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">nfs</span></span><br><span class="line">nfs_dir: /data</span><br><span class="line">nfs_share_ip: 192.168.160.0/24</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">db</span></span><br><span class="line">web_db_user: oldboy</span><br><span class="line">web_db_pass: Bgx123.com</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">redis</span></span><br><span class="line">redis_server_ip: 192.168.160.7</span><br><span class="line">redis_server_port: 6379</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master roles]# vim site.yml </span><br><span class="line">- hosts: all</span><br><span class="line">  roles:</span><br><span class="line">    - role: base</span><br><span class="line"></span><br><span class="line">- hosts: webserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: nginx</span><br><span class="line">    - role: php-fpm</span><br><span class="line">  tags: web</span><br><span class="line"></span><br><span class="line">- hosts: nfsserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: nfs</span><br><span class="line">      tags: nfs</span><br><span class="line"></span><br><span class="line">- hosts: dbserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: redis</span><br><span class="line">    - role: mysql</span><br><span class="line"></span><br><span class="line">- hosts: lbserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: nginx</span><br><span class="line">    - role: keepalived</span><br><span class="line"></span><br><span class="line">[root@master roles]# ansible-playbook -i hosts site.yml -t web</span><br></pre></td></tr></table></figure>



<p>P48 08 老男孩教育4期-Ansible项目实战-业务引入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line">-------------------------------------------------</span><br><span class="line">wordpress引入  (nginx+php)  nginx_proxy  code代码</span><br><span class="line">-------------------------------------------------</span><br><span class="line">[root@master roles]# mkdir wordpress/&#123;tasks,handlers,templates,files,meta&#125; -p</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">前置依赖环境</span></span><br><span class="line">[root@master roles]# vim wordpress/meta/main.yml</span><br><span class="line">dependencies:</span><br><span class="line">- role: nginx</span><br><span class="line">- role: php-fpm</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">基本任务</span></span><br><span class="line">[root@master roles]# cat wordpress/tasks/main.yml</span><br><span class="line">- name: Wordpress Virt Server</span><br><span class="line">  template: src=blog.oldboy.conf.j2 dest=/etc/nginx/conf.d/blog.oldboy.com.conf</span><br><span class="line">  notify: Restart Nginx Server</span><br><span class="line"></span><br><span class="line">- name: Create Wordpress Data Directory</span><br><span class="line">  file: path=&#123;&#123; wordpress_root_path &#125;&#125; state=directory owner=&#123;&#123; web_user &#125;&#125; group=&#123;&#123; web_user &#125;&#125;</span><br><span class="line"></span><br><span class="line">- name: unzip Wordpress Code</span><br><span class="line">  unarchive: src=wordpress-6.0.1-zh_CN.zip dest=&#123;&#123; wordpress_root_path &#125;&#125; owner=&#123;&#123; web_user &#125;&#125; group=&#123;&#123; web_user &#125;&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">模板配置文件</span></span><br><span class="line">[root@master roles]# vim wordpress/templates/blog.oldboy.conf.j2</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name &#123;&#123; wordpress_server_name &#125;&#125;;</span><br><span class="line">    root &#123;&#123; wordpress_root_path &#125;&#125;;</span><br><span class="line">    client_max_body_size 100m;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        index index.php;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">        fastcgi_param HTTPS on;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">触发器</span></span><br><span class="line">[root@master roles]# vim wordpress/handlers/main.yml</span><br><span class="line">- name: Restart Nginx Server</span><br><span class="line">  service: name=nginx state=restarted</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">变量</span></span><br><span class="line">[root@master roles]# vim group_vars/all </span><br><span class="line">web_user: www</span><br><span class="line">web_user_id: 666</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">wordpress</span></span><br><span class="line">wordpress_server_name: blog.oldboy.com</span><br><span class="line">wordpress_root_path: /code/wordpress</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">nfs</span></span><br><span class="line">nfs_dir: /data</span><br><span class="line">nfs_share_ip: 192.168.160.0/24</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">db</span></span><br><span class="line">web_db_user: oldboy</span><br><span class="line">web_db_pass: Bgx123.com</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">redis</span></span><br><span class="line">redis_server_ip: 192.168.160.7</span><br><span class="line">redis_server_port: 6379</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master roles]# cat site.yml </span><br><span class="line">- hosts: all</span><br><span class="line">  roles:</span><br><span class="line">    - role: base</span><br><span class="line"></span><br><span class="line">- hosts: webserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: wordpress</span><br><span class="line">  tags: wordpress</span><br><span class="line"></span><br><span class="line">- hosts: nfsserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: nfs</span><br><span class="line">      tags: nfs</span><br><span class="line"></span><br><span class="line">- hosts: dbserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: redis</span><br><span class="line">    - role: mysql</span><br><span class="line"></span><br><span class="line">- hosts: lbserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: nginx</span><br><span class="line">    - role: keepalived</span><br><span class="line"></span><br><span class="line">[root@master roles]# ansible-playbook -i hosts site.yml -t wordpress</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-------------------------------------------------</span><br><span class="line">wordpress引入  nginx_proxy</span><br><span class="line">-------------------------------------------------</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">基础模块</span></span><br><span class="line">[root@master roles]# mkdir wordpress_proxy/&#123;tasks,handlers,templates,files,meta&#125; -p</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">前置环境条件</span></span><br><span class="line">[root@master roles]# vim wordpress_proxy/meta/main.yml </span><br><span class="line">dependencies:</span><br><span class="line">- role: nginx</span><br><span class="line">- role: keepalived</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">模板配置文件</span></span><br><span class="line">[root@master roles]# vim wordpress_proxy/templates/proxy_blog.oldboy.com.conf.j2</span><br><span class="line">upstream &#123;&#123; wordpress_server_name &#125;&#125; &#123;</span><br><span class="line">    &#123;% for i in groups[&#x27;webserver&#x27;] %&#125;</span><br><span class="line">        server &#123;&#123;i&#125;&#125;:80;</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name &#123;&#123; wordpress_server_name &#125;&#125;;</span><br><span class="line">        return 302 https://$server_name$request_uri;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen 443 ssl;</span><br><span class="line">        server_name &#123;&#123; wordpress_server_name &#125;&#125;;</span><br><span class="line">        ssl_certificate ssl_key/server.crt;</span><br><span class="line">        ssl_certificate_key ssl_key/server.key;</span><br><span class="line">        </span><br><span class="line">        location / &#123;</span><br><span class="line">                proxy_pass http://&#123;&#123; wordpress_server_name &#125;&#125;;</span><br><span class="line">                proxy_http_version 1.1;</span><br><span class="line">                proxy_set_header Host $http_host;</span><br><span class="line">                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">                proxy_next_upstream error timeout http_500 http_502 http_503 http_504;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">基本任务</span></span><br><span class="line">[root@master roles]# vim wordpress_proxy/tasks/main.yml </span><br><span class="line">- name: Create SSl Directory</span><br><span class="line">  file: path=/etc/nginx/ssl_key state=directory</span><br><span class="line"></span><br><span class="line">- name: Copy SSL public Pri Key</span><br><span class="line">  copy: src=&#123;&#123; item &#125;&#125; dest=/etc/nginx/ssl_key</span><br><span class="line">  with_items:</span><br><span class="line">    - server.crt</span><br><span class="line">    - server.key </span><br><span class="line"></span><br><span class="line">- name: Wordpress Proxy Virt</span><br><span class="line">  template: src=proxy_blog.oldboy.com.conf.j2 dest=/etc/nginx/conf.d/proxy_blog.oldboy.com.conf</span><br><span class="line">  notify: Restart Nginx Server</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">触发器</span></span><br><span class="line">[root@master roles]# vim wordpress_proxy/handlers/main.yml</span><br><span class="line">- name: Restart Nginx Server</span><br><span class="line">  service: name=nginx state=restarted</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ssl证书</span></span><br><span class="line">[root@lb01 ~]# scp * root@192.168.160.5:/opt/roles/wordpress_proxy/files/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master roles]# vim site.yml </span><br><span class="line">- hosts: all</span><br><span class="line">  roles:</span><br><span class="line">    - role: base</span><br><span class="line"></span><br><span class="line">- hosts: lbserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: wordpress_proxy</span><br><span class="line">  tags: wordpress</span><br><span class="line"></span><br><span class="line">- hosts: webserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: wordpress</span><br><span class="line">  tags: wordpress</span><br><span class="line"></span><br><span class="line">- hosts: nfsserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: nfs</span><br><span class="line">      tags: nfs</span><br><span class="line"></span><br><span class="line">- hosts: dbserver</span><br><span class="line">  roles:</span><br><span class="line">    - role: redis</span><br><span class="line">    - role: mysql</span><br><span class="line"></span><br><span class="line">[root@master roles]# ansible-playbook -i hosts site.yml -t wordpress</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://mo-li001.github.io">壹拾陆</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://mo-li001.github.io/posts/a71433d.html">https://mo-li001.github.io/posts/a71433d.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mo-li001.github.io" target="_blank">壹拾陆</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/9bdc030a.html"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">HAproxy</div></div></a></div><div class="next-post pull-right"><a href="/posts/4ef7cd67.html"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Jenkinsfile</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/9f353bc9.html" title="Devops"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Devops</div></div></a></div><div><a href="/posts/f5f9fa9b.html" title="Docker"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Docker</div></div></a></div><div><a href="/posts/34d20e28.html" title="ELK"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">ELK</div></div></a></div><div><a href="/posts/8005.html" title="ELK快速部署"><img class="cover" src="https://tuchuangs.com/imgs/2022/09/18/074f3836d4f471b8.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">ELK快速部署</div></div></a></div><div><a href="/posts/9bdc030a.html" title="HAproxy"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">HAproxy</div></div></a></div><div><a href="/posts/4ef7cd67.html" title="Jenkinsfile"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">Jenkinsfile</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://images-1258700836.cos.ap-guangzhou.myqcloud.com/images/202209182232723.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">壹拾陆</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">68</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mo-li001/"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">个人笔记</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Ansible"><span class="toc-text">Ansible</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Ansible%E5%9F%BA%E7%A1%80%E6%A6%82%E8%BF%B0"><span class="toc-text">1.Ansible基础概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Ansible%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="toc-text">3.Ansible安装配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Ansible-Inventory"><span class="toc-text">4.Ansible Inventory</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#02-Ansible-Ad-Hoc"><span class="toc-text">02 Ansible Ad-Hoc</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%9D%97"><span class="toc-text">1.执行命令模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E8%BD%AF%E4%BB%B6%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-text">2.软件管理模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-text">4.服务管理模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-text">5.用户管理模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E7%A3%81%E7%9B%98%E6%8C%82%E8%BD%BD%E6%A8%A1%E5%9D%97"><span class="toc-text">7.磁盘挂载模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E9%98%B2%E7%81%AB%E5%A2%99%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-text">8.防火墙管理模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97%E7%BB%83%E4%B9%A0"><span class="toc-text">9.常用模块练习</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#03-Ansible-Playbook"><span class="toc-text">03.Ansible Playbook</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Ansible-Playbook%E5%9F%BA%E6%9C%AC%E6%A6%82%E8%BF%B0"><span class="toc-text">1.Ansible Playbook基本概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Ansible-playbook%E4%B8%8EAD-Hoc%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-text">2.Ansible playbook与AD-Hoc的关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Ansible-Playbook%E4%B9%A6%E5%86%99%E6%A0%BC%E5%BC%8F"><span class="toc-text">3.Ansible Playbook书写格式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Ansible-Jinja2%E6%A8%A1%E6%9D%BF%E6%A6%82%E8%BF%B0"><span class="toc-text">1.Ansible Jinja2模板概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Ansible-Jinja2%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-text">2.Ansible Jinja2基本使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Ansible-Roles%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-text">2.Ansible Roles目录结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Ansible-Galaxy"><span class="toc-text">5.Ansible Galaxy</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/90f47a19.html" title="自动化装机">自动化装机</a><time datetime="2023-02-02T12:41:14.000Z" title="发表于 2023-02-02 20:41:14">2023-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/64202.html" title="linux">linux</a><time datetime="2023-02-02T12:41:14.000Z" title="发表于 2023-02-02 20:41:14">2023-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/8fb4d8df.html" title="zabbix">zabbix</a><time datetime="2023-02-02T01:43:57.000Z" title="发表于 2023-02-02 09:43:57">2023-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/8d6735b8.html" title="超经典SQL练习题，做完这些你的ＳＱＬ就过关了">超经典SQL练习题，做完这些你的ＳＱＬ就过关了</a><time datetime="2023-02-02T01:43:57.000Z" title="发表于 2023-02-02 09:43:57">2023-02-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/39d18a59.html" title="Mermaid绘图">Mermaid绘图</a><time datetime="2023-01-11T12:41:14.000Z" title="发表于 2023-01-11 20:41:14">2023-01-11</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 壹拾陆</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>